# è¯¾ç¨‹ P44ï¼š049 - è¿›ç¨‹æ³¨å…¥ï¼šåˆ©ç”¨å•ä¸ªæ¼æ´çªç ´æ‰€æœ‰ macOS å®‰å…¨å±‚ ğŸğŸ”“

![](img/35e64788b82224d5b25845810aa16e2e_0.png)

![](img/35e64788b82224d5b25845810aa16e2e_2.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹  macOS å®‰å…¨æ¨¡å‹çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¹¶æ·±å…¥æ¢è®¨ä¸€ä¸ªå…³é”®çš„è¿›ç¨‹æ³¨å…¥æ¼æ´ã€‚è¿™ä¸ªæ¼æ´å…è®¸æ”»å‡»è€…çªç ´æ²™ç®±é™åˆ¶ï¼Œå¹¶æœ€ç»ˆç»•è¿‡ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤ã€‚æˆ‘ä»¬å°†ä»åŸºç¡€çš„å®‰å…¨æ¨¡å‹è®²èµ·ï¼Œé€æ­¥åˆ†ææ¼æ´çš„åŸç†ã€åˆ©ç”¨æ–¹æ³•ä»¥åŠè‹¹æœçš„ä¿®å¤æªæ–½ã€‚

## æ¦‚è¿°ï¼šmacOS å®‰å…¨æ¨¡å‹çš„æ¼”å˜

![](img/35e64788b82224d5b25845810aa16e2e_4.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†è¯¾ç¨‹çš„æ•´ä½“ç›®æ ‡ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹ macOS å®‰å…¨æ¨¡å‹çš„å†å²æ¼”å˜ã€‚

![](img/35e64788b82224d5b25845810aa16e2e_6.png)

![](img/35e64788b82224d5b25845810aa16e2e_8.png)

ä¼ ç»Ÿçš„ Unix/Linux å®‰å…¨æ¨¡å‹ä»¥ç”¨æˆ·ä¸ºå®‰å…¨è¾¹ç•Œï¼Œè€Œéè¿›ç¨‹ã€‚æ–‡ä»¶çš„æ‰€æœ‰è€…ã€ç»„å’Œå…¶ä»–ç”¨æˆ·é€šè¿‡ä¹ä¸ªæ ‡å¿—ä½ï¼ˆå¦‚è¯»ã€å†™ã€æ‰§è¡Œï¼‰æ¥ç¡®å®šæƒé™ã€‚é€šå¸¸ï¼Œä¸€ä¸ªè¿›ç¨‹éœ€è¦ä»¥ç›¸åŒç”¨æˆ·èº«ä»½è¿è¡Œæ‰èƒ½é™„åŠ åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ã€‚**æ ¹ç”¨æˆ·**ï¼ˆrootï¼‰æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼Œå®ƒæ‹¥æœ‰ç³»ç»Ÿçš„å®Œå…¨æ§åˆ¶æƒã€‚

![](img/35e64788b82224d5b25845810aa16e2e_10.png)

ç„¶è€Œï¼Œè‡ª 2015 å¹´ El Capitan ç³»ç»Ÿå¼•å…¥**ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤**ï¼ˆSystem Integrity Protection, SIPï¼‰åï¼Œæƒ…å†µå‘ç”Ÿäº†å˜åŒ–ã€‚SIP ä¹Ÿè¢«ç§°ä¸ºâ€œæ— æ ¹â€ï¼ˆrootlessï¼‰ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨æ ¹ç”¨æˆ·å’Œå†…æ ¸ä¹‹é—´å¼•å…¥ä¸€ä¸ªå®‰å…¨å±‚ï¼Œå¹¶ä¿æŠ¤ç³»ç»Ÿæ–‡ä»¶ä¸è¢«ä¿®æ”¹ï¼Œå³ä½¿æ˜¯æ ¹ç”¨æˆ·ä¹Ÿä¸è¡Œã€‚è¿™æ„å‘³ç€ä»…è·å¾— root æƒé™å·²ä¸è¶³ä»¥å®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

![](img/35e64788b82224d5b25845810aa16e2e_12.png)

SIP çš„å·¥ä½œæ–¹å¼æ˜¯ï¼Œåº”ç”¨ç¨‹åºåœ¨æ‰§è¡Œå±é™©æ“ä½œï¼ˆå¦‚ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶æˆ–è°ƒè¯•å…¶ä»–è¿›ç¨‹ï¼‰æ—¶ï¼Œéœ€è¦åœ¨ä»£ç ç­¾åä¸­åµŒå…¥ç‰¹å®šçš„**æƒåˆ©**ï¼ˆentitlementï¼‰ã€‚è‹¹æœè¿˜å¼•å…¥äº†**æ–‡ä»¶ç³»ç»Ÿé™åˆ¶**ï¼ˆFile System Restrictionsï¼‰ï¼Œä¿æŠ¤å¦‚é‚®ä»¶ã€ä¿¡æ¯æ•°æ®åº“ç­‰æ•æ„Ÿç”¨æˆ·æ•°æ®ï¼Œå³ä½¿ root ç”¨æˆ·ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®ï¼Œåªæœ‰æ‹¥æœ‰ç›¸åº”æƒåˆ©çš„åº”ç”¨ï¼ˆå¦‚é‚®ä»¶åº”ç”¨ï¼‰æ‰èƒ½è®¿é—®ã€‚

![](img/35e64788b82224d5b25845810aa16e2e_14.png)

å› æ­¤ï¼Œ**è¿›ç¨‹æœ¬èº«æˆä¸ºäº†æ–°çš„å®‰å…¨è¾¹ç•Œ**ã€‚è¿™å‚¬ç”Ÿäº†ä¸€ç±»æ–°çš„æ¼æ´â€”â€”**è¿›ç¨‹æ³¨å…¥**ï¼Œå³ä¸€ä¸ªè¿›ç¨‹è®©å¦ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œå…¶æŒ‡å®šä»£ç çš„èƒ½åŠ›ã€‚

![](img/35e64788b82224d5b25845810aa16e2e_16.png)

![](img/35e64788b82224d5b25845810aa16e2e_18.png)

## æ¼æ´å‘ç°ï¼šä¸å®‰å…¨çš„åºåˆ—åŒ–å¯¹è±¡ ğŸ”

![](img/35e64788b82224d5b25845810aa16e2e_20.png)

![](img/35e64788b82224d5b25845810aa16e2e_21.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬äº†è§£äº† SIP å¦‚ä½•å»ºç«‹è¿›ç¨‹è¾¹ç•Œï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹æ”»å‡»è€…å¦‚ä½•æ‰¾åˆ°çªç ´å£ã€‚

![](img/35e64788b82224d5b25845810aa16e2e_23.png)

è¯¥æ¼æ´å­˜åœ¨äº macOS çš„**å®‰å…¨å¯æ¢å¤çŠ¶æ€**ï¼ˆSecure Restorable Stateï¼‰åŠŸèƒ½ä¸­ã€‚å½“ç”¨æˆ·å‹¾é€‰â€œé‡æ–°æ‰“å¼€çª—å£â€é€‰é¡¹æˆ–åº”ç”¨å´©æºƒåæ¢å¤æœªä¿å­˜æ–‡æ¡£æ—¶ï¼Œç³»ç»Ÿä¼šä½¿ç”¨æ­¤åŠŸèƒ½ã€‚åº”ç”¨çŠ¶æ€å­˜å‚¨åœ¨ `~/Library/Saved Application State/` ç›®å½•ä¸‹ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªåŠ å¯†çš„æ•°æ®æ–‡ä»¶ã€‚

è¯¥æ–‡ä»¶ä½¿ç”¨è‹¹æœçš„ **NSKeyedArchiver** åºåˆ—åŒ–æ ¼å¼è¿›è¡Œç¼–ç ã€‚è‹¹æœåœ¨ macOS 10.8 ä¸­å¼•å…¥äº†å®‰å…¨çš„ **NSSecureCoding** åè®®æ¥é˜²æ­¢ä¸å®‰å…¨çš„ååºåˆ—åŒ–æ¼æ´ã€‚ç„¶è€Œï¼Œåœ¨å®‰å…¨çŠ¶æ€æ¢å¤ä¸­ï¼Œç³»ç»Ÿä½¿ç”¨äº†**ä¸å®‰å…¨çš„ã€éå®‰å…¨ç¼–ç çš„åºåˆ—åŒ–å™¨**ã€‚

ä¸å®‰å…¨çš„ååºåˆ—åŒ–æ¼æ´ä¹‹æ‰€ä»¥å±é™©ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨æ£€æŸ¥ååºåˆ—åŒ–å‡ºçš„å¯¹è±¡ç±»å‹**ä¹‹å‰**ï¼Œå°±å·²ç»åˆ›å»ºäº†è¯¥å¯¹è±¡ã€‚å¦‚æœè¯¥å¯¹è±¡çš„æ„é€ å‡½æ•°æˆ–ææ„å‡½æ•°ä¸­åŒ…å«æ¶æ„ä»£ç ï¼Œå°±ä¼šè¢«æ‰§è¡Œã€‚

![](img/35e64788b82224d5b25845810aa16e2e_25.png)

æ”»å‡»è€…å¯ä»¥ï¼š
1.  ä¸ºå…¶ä»–åº”ç”¨åˆ›å»ºåŒ…å«æ¶æ„åºåˆ—åŒ–å¯¹è±¡çš„çŠ¶æ€æ–‡ä»¶ã€‚
2.  å°†è¯¥æ–‡ä»¶å†™å…¥ç›®æ ‡åº”ç”¨çš„ç›®å½•ã€‚
3.  è¯·æ±‚ç³»ç»Ÿå¯åŠ¨ç›®æ ‡åº”ç”¨ã€‚
4.  ç›®æ ‡åº”ç”¨åœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ååºåˆ—åŒ–è¯¥æ¶æ„å¯¹è±¡ï¼Œä»è€Œæ‰§è¡Œæ”»å‡»è€…ä»£ç ã€‚

![](img/35e64788b82224d5b25845810aa16e2e_27.png)

## æ¼æ´åˆ©ç”¨é“¾çš„æ„å»º â›“ï¸

![](img/35e64788b82224d5b25845810aa16e2e_29.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬çŸ¥é“äº†æ¼æ´çš„æ ¹æºï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•æ„é€ æœ‰æ•ˆçš„æ”»å‡»è½½è·ã€‚

![](img/35e64788b82224d5b25845810aa16e2e_31.png)

ç”±äºæ²¡æœ‰ç°æˆçš„é’ˆå¯¹ Objective-C NSKeyedArchiver çš„åˆ©ç”¨é“¾ï¼Œéœ€è¦ä»å¤´æ„å»ºã€‚ä»¥ä¸‹æ˜¯æ„å»ºè¿‡ç¨‹çš„æ ¸å¿ƒæ­¥éª¤ï¼š

ä»¥ä¸‹æ˜¯åˆ©ç”¨é“¾ä¸­å…³é”®çš„å‡ ä¸ªç±»ï¼š

1.  **NSRuleEditor**ï¼š è¯¥ç±»å¯ä»¥ä»å­˜æ¡£ä¸­è·å–ä¸€ä¸ªå¯¹è±¡å’Œä¸€ä¸ªé”®è·¯å¾„ï¼ˆkey pathï¼‰ï¼Œå¹¶åˆ›å»ºä¸¤è€…ä¹‹é—´çš„ç»‘å®šã€‚é”®è·¯å¾„å¯ä»¥æŒ‡å‘ä»»ä½•**é›¶å‚æ•°æ–¹æ³•**ï¼Œä»è€Œå…è®¸è°ƒç”¨ç›®æ ‡å¯¹è±¡ä¸Šçš„æ­¤ç±»æ–¹æ³•ã€‚
    *   `[targetObject performSelector: @selector(someZeroArgMethod)]`

![](img/35e64788b82224d5b25845810aa16e2e_33.png)

2.  **NSCustomImageRep**ï¼š è¯¥ç±»å¯ä»¥ä»å­˜æ¡£ä¸­è·å–ä¸€ä¸ªå¯¹è±¡å’Œä¸€ä¸ªé€‰æ‹©å™¨ï¼ˆselectorï¼Œå³æ–¹æ³•æŒ‡é’ˆï¼‰ã€‚å½“è°ƒç”¨å…¶ `draw` æ–¹æ³•æ—¶ï¼Œä¼šåœ¨å­˜å‚¨çš„å¯¹è±¡ä¸Šè°ƒç”¨è¯¥é€‰æ‹©å™¨ã€‚
    *   ç»“åˆä¸Šä¸€æ­¥ï¼Œå¯ä»¥è°ƒç”¨ä»»æ„é›¶å‚æ•°æ–¹æ³•ï¼Œä½†æ— æ³•æ§åˆ¶å‚æ•°ã€‚

3.  **æ¡¥æ¥æŠ€å·§**ï¼š é€šè¿‡ä¸€ç³»åˆ—æŠ€å·§ï¼Œå¯ä»¥è°ƒç”¨éé›¶å‚æ•°çš„æ–¹æ³•ï¼Œå¹¶åˆ›å»ºé€šå¸¸ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡ã€‚è¿™æœ€ç»ˆå…è®¸åœ¨ç›®æ ‡è¿›ç¨‹ä¸­**æ‰§è¡Œ AppleScript**ã€‚

![](img/35e64788b82224d5b25845810aa16e2e_35.png)

ç„¶è€Œï¼Œå¯¹äºå®Œå…¨çš„åŸç”Ÿä»£ç æ‰§è¡Œï¼Œè¿˜éœ€è¦ç»•è¿‡**å¼ºåŒ–è¿è¡Œæ—¶**ï¼ˆHardened Runtimeï¼‰çš„é™åˆ¶ã€‚å¼ºåŒ–è¿è¡Œæ—¶ç¦æ­¢åˆ›å»ºå¯å†™ä¸”å¯æ‰§è¡Œçš„å†…å­˜é¡µã€åŠ è½½æœªç­¾åçš„åŠ¨æ€åº“ç­‰ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯ï¼š
1.  åŠ è½½è‹¹æœç­¾åçš„ **Python æ¡†æ¶**ã€‚
2.  é€šè¿‡ Python çš„ `ctypes` æ¨¡å—è°ƒç”¨ C å‡½æ•°ã€‚
3.  ä½†éœ€è¦ä¸€ç§æ–¹å¼ä» Objective-C ç¯å¢ƒè°ƒç”¨ Pythonã€‚è¿™é‡Œä½¿ç”¨äº† **AppleScript-Objective-C æ¡¥æ¥**ã€‚
4.  é€šè¿‡æ¡¥æ¥ï¼Œå¯ä»¥åˆ›å»º Objective-C å¯¹è±¡å¹¶è°ƒç”¨æ–¹æ³•ï¼Œè¿›è€Œå¯åŠ¨ Python çš„äº¤äº’å¼ç¯å¢ƒï¼ˆREPLï¼‰ï¼Œä»è€Œé€šè¿‡æ ‡å‡†è¾“å…¥å‘å…¶ä¼ é€’ Python ä»£ç ã€‚

æœ€ç»ˆåˆ©ç”¨é“¾æ€»ç»“ä¸ºï¼š**æ¶æ„åºåˆ—åŒ–å¯¹è±¡ -> è§¦å‘ NSRuleEditor å’Œ NSCustomImageRep -> æ‰§è¡Œ AppleScript -> é€šè¿‡æ¡¥æ¥è°ƒç”¨ Python -> ä½¿ç”¨ ctypes å®ç°åŸç”Ÿä»£ç æ‰§è¡Œèƒ½åŠ›**ã€‚

## æ¼æ´çš„ä¸‰ç§åº”ç”¨æ–¹å¼ ğŸ¯

![](img/35e64788b82224d5b25845810aa16e2e_37.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬æ„å»ºäº†å¼ºå¤§çš„åˆ©ç”¨é“¾ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ¼æ´åœ¨å®é™…æ”»å‡»ä¸­çš„ä¸‰ç§åº”ç”¨åœºæ™¯ã€‚

![](img/35e64788b82224d5b25845810aa16e2e_39.png)

![](img/35e64788b82224d5b25845810aa16e2e_41.png)

![](img/35e64788b82224d5b25845810aa16e2e_42.png)

![](img/35e64788b82224d5b25845810aa16e2e_44.png)

### 1. æ²™ç®±é€ƒé€¸

![](img/35e64788b82224d5b25845810aa16e2e_45.png)

![](img/35e64788b82224d5b25845810aa16e2e_47.png)

macOS æ²™ç®±åº”ç”¨æ— æ³•ç›´æ¥åˆ—å‡ºç£ç›˜æ–‡ä»¶ã€‚å½“å®ƒä»¬ä½¿ç”¨â€œæ‰“å¼€â€é¢æ¿æ—¶ï¼Œè¯¥é¢æ¿å®é™…ä¸Šæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼ˆ`Open and Save Panel Service`ï¼‰ï¼Œå®ƒä¸åº”ç”¨**å…±äº«ç›¸åŒçš„ä¿å­˜çŠ¶æ€ç›®å½•**ã€‚

æ”»å‡»æ­¥éª¤ï¼š
*   æ²™ç®±åº”ç”¨å°†æ¶æ„çŠ¶æ€æ–‡ä»¶å†™å…¥è‡ªå·±çš„çŠ¶æ€ç›®å½•ï¼ˆè¯¥ç›®å½•ä¸æ‰“å¼€é¢æ¿å…±äº«ï¼‰ã€‚
*   åº”ç”¨è§¦å‘æ‰“å¼€æ–‡ä»¶é¢æ¿ã€‚
*   æ¶æ„çŠ¶æ€æ–‡ä»¶åœ¨æƒé™æ›´é«˜çš„é¢æ¿æœåŠ¡è¿›ç¨‹ä¸­è¢«ååºåˆ—åŒ–å¹¶æ‰§è¡Œä»£ç ï¼Œä»è€Œ**é€ƒç¦»æ²™ç®±**ã€‚
> **æ³¨**ï¼š æ­¤åˆ©ç”¨æ–¹å¼å·²åœ¨ macOS 11.3 ä¸­è¢«ä¿®å¤ï¼Œä¿®å¤æ–¹æ³•æ˜¯è®©æ‰“å¼€é¢æ¿ä¸å†ä¸åº”ç”¨å…±äº«çŠ¶æ€ç›®å½•ã€‚

![](img/35e64788b82224d5b25845810aa16e2e_49.png)

### 2. æƒé™æå‡ä¸ SIP æ–‡ä»¶ç³»ç»Ÿé™åˆ¶ç»•è¿‡

![](img/35e64788b82224d5b25845810aa16e2e_51.png)

ä¸ºäº†è·å¾—æ›´é«˜æƒé™ï¼Œåˆ©ç”¨äº†å¦ä¸€ä¸ªæŠ€å·§ã€‚`macOS Updater` åº”ç”¨æ‹¥æœ‰ `com.apple.rootless.install` æƒåˆ©ï¼Œè¯¥æƒåˆ©å…è®¸è®¿é—®ä»»ä½•å— SIP ä¿æŠ¤çš„æ–‡ä»¶è¿›è¡Œè¯»å†™ã€‚

æ”»å‡»æ­¥éª¤ï¼š
*   åˆ©ç”¨è¿›ç¨‹æ³¨å…¥æ¼æ´ï¼Œåœ¨ `macOS Updater` è¿›ç¨‹ä¸­æ‰§è¡Œä»£ç ã€‚
*   å€ŸåŠ©å…¶é«˜æƒé™ï¼Œå¯ä»¥ï¼š
    *   è¯»å–å—ä¿æŠ¤çš„é‚®ä»¶ã€ä¿¡æ¯æ•°æ®åº“ã€Safari å†å²è®°å½•ã€‚
    *   åœ¨æ— éœ€ç”¨æˆ·åŒæ„çš„æƒ…å†µä¸‹è®¿é—®æ‘„åƒå¤´æˆ–éº¦å…‹é£ã€‚
    *   å°†è‡ªèº«å†™å…¥å—ä¿æŠ¤çš„ç³»ç»Ÿä½ç½®å®ç°æŒä¹…åŒ–ã€‚
    *   ä¿®æ”¹å·²æ‰¹å‡†çš„å†…æ ¸æ‰©å±•åˆ—è¡¨ï¼ŒåŠ è½½æ¶æ„å†…æ ¸æ‰©å±•ï¼ˆéœ€ç­¾åï¼‰ï¼Œæœ€ç»ˆè·å¾—å†…æ ¸çº§ä»£ç æ‰§è¡Œã€‚

### 3. æ¼”ç¤ºä¸å½±å“

é€šè¿‡ä¸€ä¸ªè§†é¢‘æ¼”ç¤ºäº†å®Œæ•´çš„æ”»å‡»é“¾ï¼šä»æ²™ç®±åº”ç”¨å¼€å§‹ï¼Œé€æ­¥å®ç°æ²™ç®±é€ƒé€¸ã€æƒé™æå‡ï¼Œæœ€ç»ˆè·å¾— root shell å¹¶è¯æ˜å¯ä»¥ç»•è¿‡ SIP å‘å—ä¿æŠ¤ç›®å½•ï¼ˆå¦‚ `/Library/SystemPolicyConfiguration/`ï¼‰å†™å…¥æ–‡ä»¶ã€‚

## ä¿®å¤ä¸æ€»ç»“ ğŸ“

ä¸Šä¸€èŠ‚æˆ‘ä»¬çœ‹åˆ°äº†æ¼æ´çš„å·¨å¤§å¨åŠ›ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹è‹¹æœå¦‚ä½•ä¿®å¤ä»¥åŠæˆ‘ä»¬ä»ä¸­å­¦åˆ°äº†ä»€ä¹ˆã€‚

è‹¹æœé€šè¿‡å¼•å…¥ä¸€ä¸ªæ–°çš„ API æ–¹æ³•æ¥ä¿®å¤æ­¤æ¼æ´ã€‚ç¬¬ä¸‰æ–¹å¼€å‘è€…ç°åœ¨å¯ä»¥åœ¨å…¶åº”ç”¨çš„ `Info.plist` ä¸­å£°æ˜ï¼Œå…¶ä¿å­˜çŠ¶æ€**ä»…æ”¯æŒå®‰å…¨ç¼–ç å¯¹è±¡**ï¼ˆ`NSSecureCoding`ï¼‰ã€‚è‹¹æœå·²åœ¨å…¶æ‰€æœ‰ç³»ç»Ÿåº”ç”¨ä¸­å¯ç”¨äº†æ­¤åŠŸèƒ½ã€‚

è¯¥æ¼æ´åœ¨ macOS Montereyï¼ˆ12.0ï¼‰ä¸­é¦–æ¬¡è¢«ä¿®å¤ï¼Œéšåä¹Ÿå‘åç§»æ¤åˆ°äº† macOS Big Surï¼ˆ11.3 ä¿®å¤æ²™ç®±é€ƒé€¸éƒ¨åˆ†ï¼‰å’Œ macOS Catalinaã€‚è¿™æ˜¾ç¤ºäº†è‹¹æœå¯¹æ­¤æ¼æ´ä¸¥é‡æ€§çš„é‡è§†ã€‚

**æœ¬èŠ‚è¯¾æ€»ç»“**ï¼š
æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº† macOS ä»ä¼ ç»Ÿ Unix æ¨¡å‹åˆ° SIP å’Œè¿›ç¨‹è¾¹ç•Œçš„ç°ä»£å®‰å…¨æ¨¡å‹çš„æ¼”å˜ã€‚æˆ‘ä»¬æ·±å…¥åˆ†æäº†ä¸€ä¸ªå…³é”®çš„ä¸å®‰å…¨ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2022-26706ï¼‰ï¼Œå®ƒä½äºå®‰å…¨çŠ¶æ€æ¢å¤åŠŸèƒ½ä¸­ã€‚é€šè¿‡æ„å»ºå¤æ‚çš„åˆ©ç”¨é“¾ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è¿›è¡Œè¿›ç¨‹æ³¨å…¥ï¼Œè¿›è€Œå®ç°æ²™ç®±é€ƒé€¸ã€æƒé™æå‡ï¼Œå¹¶æœ€ç»ˆç»•è¿‡ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤çš„æ–‡ä»¶ç³»ç»Ÿé™åˆ¶ã€‚è¿™ä¸ªæ¡ˆä¾‹çªå‡ºè¡¨æ˜ï¼Œåœ¨å·²å»ºç«‹çš„å¤æ‚ç³»ç»Ÿä¸­åˆ†å±‚æ·»åŠ å®‰å…¨æœºåˆ¶æ˜¯ä¸€é¡¹æŒ‘æˆ˜ï¼Œæ–°æ—§ä»£ç ä¹‹é—´çš„äº¤äº’å¯èƒ½å¼•å…¥æ„æƒ³ä¸åˆ°çš„çªç ´å£ã€‚

**æ ¸å¿ƒæ¦‚å¿µä¸ä»£ç è¡¨ç¤º**ï¼š
*   **ä¼ ç»Ÿ Unix æƒé™**ï¼š `-rwxr-xr--` ï¼ˆ9ä½æ ‡å¿—ï¼‰
*   **è¿›ç¨‹æ³¨å…¥**ï¼š `Process_A -> [Code Execution] -> Process_B`
*   **ä¸å®‰å…¨ååºåˆ—åŒ–**ï¼š
    ```pseudo
    // å±é™©æ¨¡å¼ï¼šå…ˆåˆ›å»ºå¯¹è±¡ï¼Œåæ£€æŸ¥
    id obj = [unarchiver decodeObjectForKey: @"key"]; // å¯¹è±¡å·²åˆ›å»ºï¼Œæ¶æ„ä»£ç å¯èƒ½å·²æ‰§è¡Œ
    if (![obj isKindOfClass: [AllowedClass class]]) { // æ£€æŸ¥æ»å
        return nil;
    }
    ```
*   **å®‰å…¨ååºåˆ—åŒ–**ï¼š
    ```pseudo
    // å®‰å…¨æ¨¡å¼ï¼šå…ˆæ£€æŸ¥ï¼Œååˆ›å»º
    if (![unarchiver containsValueForKey: @"key"]) {
        return nil;
    }
    // ä½¿ç”¨å®‰å…¨è§£ç æ–¹æ³•ï¼ŒæŒ‡å®šæœŸæœ›çš„ç±»
    id obj = [unarchiver decodeObjectOfClass: [AllowedClass class] forKey: @"key"];
    ```

![](img/35e64788b82224d5b25845810aa16e2e_53.png)

![](img/35e64788b82224d5b25845810aa16e2e_55.png)

---
**å‚è€ƒèµ„æ–™**ï¼š
*   Apple Developer Documentation: Adopting NSSecureCoding
*   Apple Security Updates
*   CVE-2022-26706 è¯¦ç»†æŠ€æœ¯æŠ¥å‘Šï¼ˆç”±æ¼”è®²è€…æ‰€åœ¨å…¬å¸å‘å¸ƒï¼‰