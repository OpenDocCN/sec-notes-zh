![](img/b59f528944b19a11061890a6f4cc4921_1.png)

![](img/b59f528944b19a11061890a6f4cc4921_2.png)

# P57：第57天：SSRF服务端请求伪造 & Gopher伪协议 & 无回显利用 & 黑白盒挖掘 & 业务功能点 🎯

![](img/b59f528944b19a11061890a6f4cc4921_4.png)

![](img/b59f528944b19a11061890a6f4cc4921_6.png)

![](img/b59f528944b19a11061890a6f4cc4921_8.png)

在本节课中，我们将要学习一种新的安全漏洞——SSRF（服务端请求伪造）。我们将从基本概念入手，理解其与CSRF的区别，然后学习其原理、利用方式、绕过技巧，并探讨如何在黑盒与白盒测试中挖掘此类漏洞。

![](img/b59f528944b19a11061890a6f4cc4921_10.png)

![](img/b59f528944b19a11061890a6f4cc4921_12.png)

## 概述

![](img/b59f528944b19a11061890a6f4cc4921_14.png)

![](img/b59f528944b19a11061890a6f4cc4921_15.png)

SSRF，全称Server-Side Request Forgery，即服务端请求伪造。它是一种攻击者能够构造请求，由服务器端发起对内部或外部系统进行非预期访问的安全漏洞。与CSRF（客户端请求伪造）攻击受害者浏览器不同，SSRF攻击的是服务器本身。

![](img/b59f528944b19a11061890a6f4cc4921_17.png)

![](img/b59f528944b19a11061890a6f4cc4921_19.png)

上一节我们介绍了CSRF，本节中我们来看看SSRF。

## 什么是SSRF？🤔

SSRF是指攻击者通过构造恶意请求，诱使服务器向指定目标发起请求的安全漏洞。其核心在于服务器提供了从其他服务器或应用获取数据的功能，但未对请求的目标地址进行充分的过滤和限制。

![](img/b59f528944b19a11061890a6f4cc4921_21.png)

一个典型的例子是“按图搜索”功能。用户输入一个图片URL，服务器会去访问这个URL以获取图片进行分析。如果攻击者输入的URL是 `http://127.0.0.1`（本地回环地址），那么服务器就会向自己发起请求。

![](img/b59f528944b19a11061890a6f4cc4921_23.png)

**代码示例：一个简单的SSRF漏洞Demo**
```php
<?php
if(isset($_POST['url'])){
    $url = $_POST['url'];
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    $result = curl_exec($ch);
    curl_close($ch);
    echo $result;
}
?>
```
上述代码直接接收用户输入的`url`参数并请求，未做任何过滤，是SSRF的典型场景。

## SSRF与CSRF的区别

![](img/b59f528944b19a11061890a6f4cc4921_25.png)

![](img/b59f528944b19a11061890a6f4cc4921_27.png)

理解两者的区别有助于加深对SSRF的认识：
*   **CSRF（客户端请求伪造）**：攻击目标是**已登录特定网站的用户（客户端）**。攻击者诱使用户的浏览器在不知情的情况下发送恶意请求（如转账、改密）。
*   **SSRF（服务端请求伪造）**：攻击目标是**服务器**。攻击者诱使服务器应用程序自身向内部或外部网络发起非预期的请求。

![](img/b59f528944b19a11061890a6f4cc4921_29.png)

![](img/b59f528944b19a11061890a6f4cc4921_31.png)

简单来说，CSRF是利用用户的身份和权限，SSRF是利用服务器的网络访问能力。

![](img/b59f528944b19a11061890a6f4cc4921_33.png)

![](img/b59f528944b19a11061890a6f4cc4921_35.png)

![](img/b59f528944b19a11061890a6f4cc4921_37.png)

![](img/b59f528944b19a11061890a6f4cc4921_39.png)

## SSRF的漏洞挖掘点 🔍

![](img/b59f528944b19a11061890a6f4cc4921_41.png)

![](img/b59f528944b19a11061890a6f4cc4921_43.png)

![](img/b59f528944b19a11061890a6f4cc4921_45.png)

![](img/b59f528944b19a11061890a6f4cc4921_47.png)

![](img/b59f528944b19a11061890a6f4cc4921_49.png)

![](img/b59f528944b19a11061890a6f4cc4921_51.png)

![](img/b59f528944b19a11061890a6f4cc4921_53.png)

SSRF漏洞通常出现在服务器需要对外发起请求的功能点上。以下是常见的易产生SSRF的功能场景：

![](img/b59f528944b19a11061890a6f4cc4921_55.png)

![](img/b59f528944b19a11061890a6f4cc4921_57.png)

![](img/b59f528944b19a11061890a6f4cc4921_59.png)

![](img/b59f528944b19a11061890a6f4cc4921_61.png)

![](img/b59f528944b19a11061890a6f4cc4921_63.png)

![](img/b59f528944b19a11061890a6f4cc4921_65.png)

![](img/b59f528944b19a11061890a6f4cc4921_67.png)

以下是SSRF漏洞常见的业务功能点：

![](img/b59f528944b19a11061890a6f4cc4921_69.png)

![](img/b59f528944b19a11061890a6f4cc4921_70.png)

![](img/b59f528944b19a11061890a6f4cc4921_72.png)

![](img/b59f528944b19a11061890a6f4cc4921_74.png)

1.  **分享功能**：通过URL地址分享网页内容。
2.  **转码服务**：将网页内容转换为特定格式（如PDF）。
3.  **在线翻译**：翻译指定URL的网页内容。
4.  **图片加载与下载**：例如，通过URL加载远程图片。
5.  **图片/文章收藏功能**：收藏远程的图片或文章链接。
6.  **未公开的API**：需要传入URL参数的功能。
7.  **数据库内置功能**：例如，`Oracle`的`UTL_HTTP`包。
8.  **邮件系统**：加载远程邮件图片。
9.  **编码处理**：对URL进行编码、解码。
10. **文件处理**：如`ffmpeg`、`ImageMagick`处理远程文件。
11. **信息采集**：爬虫类功能。
12. **参数处理**：从URL参数中获取内容。

![](img/b59f528944b19a11061890a6f4cc4921_76.png)

![](img/b59f528944b19a11061890a6f4cc4921_78.png)

![](img/b59f528944b19a11061890a6f4cc4921_80.png)

![](img/b59f528944b19a11061890a6f4cc4921_82.png)

![](img/b59f528944b19a11061890a6f4cc4921_84.png)

从代码审计（白盒）角度看，需要关注那些能够发起网络请求的函数。例如在PHP中：
*   `file_get_contents()`
*   `fsockopen()`
*   `curl_exec()`

![](img/b59f528944b19a11061890a6f4cc4921_86.png)

![](img/b59f528944b19a11061890a6f4cc4921_88.png)

![](img/b59f528944b19a11061890a6f4cc4921_90.png)

![](img/b59f528944b19a11061890a6f4cc4921_92.png)

![](img/b59f528944b19a11061890a6f4cc4921_94.png)

## SSRF的利用方式与价值 💎

![](img/b59f528944b19a11061890a6f4cc4921_96.png)

![](img/b59f528944b19a11061890a6f4cc4921_98.png)

![](img/b59f528944b19a11061890a6f4cc4921_100.png)

SSRF漏洞的利用价值主要体现在以下几个方面：

![](img/b59f528944b19a11061890a6f4cc4921_102.png)

![](img/b59f528944b19a11061890a6f4cc4921_104.png)

![](img/b59f528944b19a11061890a6f4cc4921_106.png)

![](img/b59f528944b19a11061890a6f4cc4921_108.png)

![](img/b59f528944b19a11061890a6f4cc4921_110.png)

![](img/b59f528944b19a11061890a6f4cc4921_112.png)

![](img/b59f528944b19a11061890a6f4cc4921_114.png)

![](img/b59f528944b19a11061890a6f4cc4921_115.png)

以下是SSRF的主要利用方向：

![](img/b59f528944b19a11061890a6f4cc4921_116.png)

![](img/b59f528944b19a11061890a6f4cc4921_118.png)

![](img/b59f528944b19a11061890a6f4cc4921_120.png)

1.  **端口扫描**：通过判断请求不同端口的响应时间或返回内容，探测目标服务器内部开放的服务端口。例如：`http://127.0.0.1:22`、`http://127.0.0.1:3306`。
2.  **内网资产探测**：利用服务器作为跳板，探测其所在内网的其他主机和服务。例如：`http://192.168.1.1/`、`http://10.0.0.1/`。
3.  **攻击内网应用**：如果内网存在漏洞应用（如未授权Redis、弱口令Web应用），可通过SSRF构造请求进行攻击。
4.  **读取本地文件**：利用`file://`协议读取服务器上的敏感文件。例如：`file:///etc/passwd`。

![](img/b59f528944b19a11061890a6f4cc4921_122.png)

![](img/b59f528944b19a11061890a6f4cc4921_124.png)

## 协议利用与绕过技巧 🛠️

![](img/b59f528944b19a11061890a6f4cc4921_126.png)

![](img/b59f528944b19a11061890a6f4cc4921_128.png)

![](img/b59f528944b19a11061890a6f4cc4921_130.png)

![](img/b59f528944b19a11061890a6f4cc4921_132.png)

![](img/b59f528944b19a11061890a6f4cc4921_133.png)

![](img/b59f528944b19a11061890a6f4cc4921_134.png)

![](img/b59f528944b19a11061890a6f4cc4921_136.png)

SSRF的利用深度很大程度上取决于服务器支持的协议和存在的过滤规则。

![](img/b59f528944b19a11061890a6f4cc4921_138.png)

![](img/b59f528944b19a11061890a6f4cc4921_140.png)

![](img/b59f528944b19a11061890a6f4cc4921_142.png)

![](img/b59f528944b19a11061890a6f4cc4921_144.png)

### 常用协议

![](img/b59f528944b19a11061890a6f4cc4921_146.png)

![](img/b59f528944b19a11061890a6f4cc4921_148.png)

![](img/b59f528944b19a11061890a6f4cc4921_150.png)

*   **`http://` / `https://`**：最常用，用于Web请求、端口扫描、内网探测。
*   **`file://`**：用于读取服务器本地文件。例如：`file:///d:/flag.txt`。
*   **`dict://`**：可用于探测端口信息，例如`dict://127.0.0.1:3306`可能返回MySQL版本信息。
*   **`gopher://`**：一个非常强大的协议，支持构造多种数据包（如HTTP、Redis、MySQL），用于攻击内网非Web服务。这是SSRF的高阶利用方式。

![](img/b59f528944b19a11061890a6f4cc4921_152.png)

![](img/b59f528944b19a11061890a6f4cc4921_154.png)

![](img/b59f528944b19a11061890a6f4cc4921_156.png)

![](img/b59f528944b19a11061890a6f4cc4921_158.png)

![](img/b59f528944b19a11061890a6f4cc4921_160.png)

### 常见绕过技巧

![](img/b59f528944b19a11061890a6f4cc4921_162.png)

![](img/b59f528944b19a11061890a6f4cc4921_164.png)

![](img/b59f528944b19a11061890a6f4cc4921_166.png)

当存在对`127.0.0.1`、`localhost`等关键词的过滤时，可以尝试以下绕过方法：

![](img/b59f528944b19a11061890a6f4cc4921_168.png)

![](img/b59f528944b19a11061890a6f4cc4921_170.png)

以下是几种常见的SSRF过滤绕过方法：

![](img/b59f528944b19a11061890a6f4cc4921_172.png)

![](img/b59f528944b19a11061890a6f4cc4921_174.png)

![](img/b59f528944b19a11061890a6f4cc4921_176.png)

1.  **进制转换**：将IP地址转换为其他进制。
    *   十进制：`http://2130706433/` -> `127.0.0.1`
    *   八进制：`http://0177.0.0.1/` -> `127.0.0.1`
    *   十六进制：`http://0x7f.0x0.0x0.0x1/` -> `127.0.0.1`
2.  **域名解析**：将自己的域名A记录指向`127.0.0.1`，然后使用域名访问。例如：`http://ssrftest.example.com/`。
3.  **短地址/重定向**：利用URL缩短服务或在自己控制的服务器上设置302重定向，最终跳转到目标地址。
4.  **利用URL解析特性**：
    *   添加端口：`http://127.0.0.1:80@www.example.com/` (某些解析库会以`@`前的信息为准)。
    *   利用`#`、`?`等符号干扰过滤规则。
5.  **利用IPv6或特殊地址**：`[::]`、`0.0.0.0`在某些情况下可代表本地。

![](img/b59f528944b19a11061890a6f4cc4921_178.png)

![](img/b59f528944b19a11061890a6f4cc4921_180.png)

## 高阶利用：Gopher协议攻击内网服务 🚀

![](img/b59f528944b19a11061890a6f4cc4921_182.png)

![](img/b59f528944b19a11061890a6f4cc4921_184.png)

![](img/b59f528944b19a11061890a6f4cc4921_186.png)

Gopher协议可以封装多种协议的数据流，是攻击内网非Web服务（如Redis、MySQL、Memcached）的利器。

![](img/b59f528944b19a11061890a6f4cc4921_188.png)

![](img/b59f528944b19a11061890a6f4cc4921_190.png)

![](img/b59f528944b19a11061890a6f4cc4921_192.png)

![](img/b59f528944b19a11061890a6f4cc4921_194.png)

**利用工具**：`Gopherus`
这是一个专门为SSRF生成Gopher payload的工具，支持攻击Redis、MySQL、PostgreSQL、FastCGI等。

![](img/b59f528944b19a11061890a6f4cc4921_196.png)

![](img/b59f528944b19a11061890a6f4cc4921_198.png)

**攻击示例（MySQL）**：
假设内网存在一个无密码的MySQL服务（`127.0.0.1:3306`），我们可以通过SSRF利用Gopher协议写入Webshell。

![](img/b59f528944b19a11061890a6f4cc4921_200.png)

1.  使用Gopherus生成Payload：
    ```bash
    python2 gopherus.py --exploit mysql
    ```
2.  输入用户名`root`，选择写入文件功能，指定Web路径和一句话木马内容。
3.  工具会生成一个类似 `gopher://127.0.0.1:3306/_生成的Payload字符串` 的URL。
4.  将此URL进行URL编码后，提交给存在SSRF漏洞的点。
5.  服务器会向本地的3306端口发送该Payload，执行写入文件操作。

![](img/b59f528944b19a11061890a6f4cc4921_202.png)

## 无回显SSRF的利用思路 🤫

![](img/b59f528944b19a11061890a6f4cc4921_204.png)

![](img/b59f528944b19a11061890a6f4cc4921_206.png)

![](img/b59f528944b19a11061890a6f4cc4921_208.png)

![](img/b59f528944b19a11061890a6f4cc4921_210.png)

![](img/b59f528944b19a11061890a6f4cc4921_212.png)

![](img/b59f528944b19a11061890a6f4cc4921_214.png)

![](img/b59f528944b19a11061890a6f4cc4921_216.png)

在实际场景中，很多SSRF漏洞没有直接的回显（Blind SSRF）。此时，我们需要通过其他方式判断请求是否成功。

![](img/b59f528944b19a11061890a6f4cc4921_218.png)

![](img/b59f528944b19a11061890a6f4cc4921_220.png)

以下是处理无回显SSRF的两种核心思路：

![](img/b59f528944b19a11061890a6f4cc4921_222.png)

1.  **主动外带（Out-of-Band, OOB）**：让服务器向我们控制的监听服务器发起请求。
    *   **DNS外带**：让服务器访问一个特殊的域名，如 `http://<unique-id>.your-dns-server.com`，我们在DNS日志中查看是否有解析记录。
    *   **HTTP外带**：让服务器访问我们搭建的HTTP服务，查看访问日志。
2.  **延时判断**：通过请求响应的时间差来判断端口或服务是否存在。例如，访问一个开放的端口可能立即返回，访问一个关闭的端口可能会超时。
3.  **间接验证**：如果漏洞点可能导致服务器执行特定操作（如写入文件），可以尝试访问写入的文件是否存在来验证。

![](img/b59f528944b19a11061890a6f4cc4921_224.png)

![](img/b59f528944b19a11061890a6f4cc4921_226.png)

![](img/b59f528944b19a11061890a6f4cc4921_228.png)

![](img/b59f528944b19a11061890a6f4cc4921_230.png)

![](img/b59f528944b19a11061890a6f4cc4921_232.png)

![](img/b59f528944b19a11061890a6f4cc4921_234.png)

![](img/b59f528944b19a11061890a6f4cc4921_236.png)

## 黑盒实战挖掘思路 🕵️

![](img/b59f528944b19a11061890a6f4cc4921_238.png)

![](img/b59f528944b19a11061890a6f4cc4921_240.png)

![](img/b59f528944b19a11061890a6f4cc4921_242.png)

在没有源码的情况下，挖掘SSRF需要关注业务逻辑：

![](img/b59f528944b19a11061890a6f4cc4921_244.png)

![](img/b59f528944b19a11061890a6f4cc4921_246.png)

![](img/b59f528944b19a11061890a6f4cc4921_248.png)

![](img/b59f528944b19a11061890a6f4cc4921_250.png)

![](img/b59f528944b19a11061890a6f4cc4921_252.png)

![](img/b59f528944b19a11061890a6f4cc4921_254.png)

![](img/b59f528944b19a11061890a6f4cc4921_256.png)

1.  **功能点测试**：重点测试前面提到的“分享”、“转码”、“翻译”、“图片处理”、“导出”等功能。观察这些功能是否涉及加载远程URL。
2.  **参数名猜测**：关注参数名如 `url`、`link`、`src`、`source`、`target`、`path`、`display`、`redirect` 等。
3.  **利用OOB探测**：在疑似点提交DNS外带地址（如Burp Collaborator生成的地址），观察是否有回调。
4.  **PDF导出/处理类漏洞**：这是一个高级且有效的攻击面。在编辑或导出PDF时，如果服务器会解析PDF中的内容（如JavaScript、Iframe），可能触发对内部地址的请求。可以尝试在PDF中嵌入 `<iframe src=”http://burpcollaborator.net“>` 等标签进行测试。

![](img/b59f528944b19a11061890a6f4cc4921_258.png)

![](img/b59f528944b19a11061890a6f4cc4921_260.png)

## 防御建议 🛡️

![](img/b59f528944b19a11061890a6f4cc4921_262.png)

![](img/b59f528944b19a11061890a6f4cc4921_264.png)

1.  **统一出口**：限制服务器外发流量，所有请求通过统一的代理或网关出口，并实施白名单策略。
2.  **目标过滤**：对用户输入的URL进行严格校验，使用白名单机制，只允许访问特定的域名或IP段。坚决禁止访问内网地址和回环地址。
3.  **协议限制**：只允许使用安全的协议，如`HTTP`和`HTTPS`，禁用`file://`、`gopher://`、`dict://`等危险协议。
4.  **身份验证**：如果服务器需要访问内部敏感资源，应确保对这些资源的访问需要额外的身份验证。
5.  **错误信息**：避免将详细的错误信息（如连接失败原因、内部IP）返回给用户。

![](img/b59f528944b19a11061890a6f4cc4921_266.png)

![](img/b59f528944b19a11061890a6f4cc4921_268.png)

![](img/b59f528944b19a11061890a6f4cc4921_270.png)

![](img/b59f528944b19a11061890a6f4cc4921_272.png)

![](img/b59f528944b19a11061890a6f4cc4921_273.png)

## 总结

![](img/b59f528944b19a11061890a6f4cc4921_275.png)

![](img/b59f528944b19a11061890a6f4cc4921_277.png)

![](img/b59f528944b19a11061890a6f4cc4921_279.png)

本节课中我们一起学习了SSRF服务端请求伪造漏洞。我们从概念入手，明确了其与CSRF的区别，理解了漏洞产生的原理。我们探讨了SSRF常见的出现场景、利用价值，并深入学习了包括`http`、`file`、`gopher`在内的多种协议利用方式及绕过过滤的技巧。针对无回显场景，我们掌握了OOB外带等验证思路。最后，我们从黑盒与白盒两个角度分析了漏洞挖掘方法，并给出了相应的防御建议。

![](img/b59f528944b19a11061890a6f4cc4921_281.png)

![](img/b59f528944b19a11061890a6f4cc4921_283.png)

SSRF是一个能够“由外打内”的严重漏洞，深入理解其原理和利用方式，对于安全测试和防御都至关重要。