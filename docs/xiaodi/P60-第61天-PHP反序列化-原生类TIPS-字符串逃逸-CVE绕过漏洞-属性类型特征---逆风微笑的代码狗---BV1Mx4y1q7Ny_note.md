![](img/4877fe6b504dcf6abe3752ac36d22108_1.png)

# PHPååºåˆ—åŒ–æ¼æ´è¯¦è§£ï¼ˆç¬¬60è¯¾ï¼‰ğŸ”

![](img/4877fe6b504dcf6abe3752ac36d22108_3.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_5.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_7.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†è¦å­¦ä¹ PHPååºåˆ—åŒ–æ¼æ´ä¸­çš„ä¸‰ä¸ªæ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼šå±æ€§ç±»å‹ç‰¹å¾ã€CVE-2016-7124ï¼ˆ__wakeupç»•è¿‡ï¼‰æ¼æ´ã€å­—ç¬¦ä¸²é€ƒé€¸æ¼æ´ä»¥åŠåŸç”Ÿç±»çš„åˆ©ç”¨ã€‚è¿™äº›çŸ¥è¯†ç‚¹åœ¨CTFæ¯”èµ›å’Œé¢è¯•ä¸­ç»å¸¸å‡ºç°ï¼Œæ˜¯ç†è§£PHPååºåˆ—åŒ–é«˜çº§åˆ©ç”¨çš„å…³é”®ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_9.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_11.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_13.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_15.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_17.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_19.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_21.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_23.png)

## ä¸€ã€å±æ€§ç±»å‹ç‰¹å¾ ğŸ“

![](img/4877fe6b504dcf6abe3752ac36d22108_25.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_27.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†ååºåˆ—åŒ–çš„åŸºç¡€æ¦‚å¿µï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹PHPå¯¹è±¡å±æ€§ç±»å‹åœ¨åºåˆ—åŒ–æ•°æ®ä¸­çš„ç‰¹å¾ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_29.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_31.png)

åœ¨PHPé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œç±»çš„å±æ€§æœ‰ä¸‰ç§å¯è§æ€§ç±»å‹ï¼š`public`ï¼ˆå…¬æœ‰ï¼‰ã€`protected`ï¼ˆå—ä¿æŠ¤ï¼‰å’Œ`private`ï¼ˆç§æœ‰ï¼‰ã€‚è¿™äº›ç±»å‹åœ¨åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­æœ‰ä¸åŒçš„è¡¨ç¤ºæ–¹å¼ï¼Œäº†è§£è¿™ä¸€ç‚¹æœ‰åŠ©äºæˆ‘ä»¬åˆ†ææµé‡ç‰¹å¾å’Œæ„é€ payloadã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_33.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_35.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_37.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_39.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_41.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_43.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_45.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_47.png)

**æ ¸å¿ƒå…¬å¼ï¼š**
*   `public`å±æ€§ï¼šæ­£å¸¸æ˜¾ç¤ºå±æ€§åï¼Œå¦‚ `s:3:"age";i:20;`
*   `protected`å±æ€§ï¼šæ˜¾ç¤ºä¸º `\x00*\x00å±æ€§å`ï¼Œå¦‚ `s:6:"\x00*\x00six";s:4:"mail";`
*   `private`å±æ€§ï¼šæ˜¾ç¤ºä¸º `\x00ç±»å\x00å±æ€§å`ï¼Œå¦‚ `s:9:"\x00test\x00age";i:20;`

![](img/4877fe6b504dcf6abe3752ac36d22108_49.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_51.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_53.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_55.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_57.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_59.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_61.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_63.png)

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºäº†ä¸åŒå±æ€§ç±»å‹çš„åºåˆ—åŒ–ç»“æœå·®å¼‚ï¼š

![](img/4877fe6b504dcf6abe3752ac36d22108_65.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_67.png)

```php
class test {
    public $name = 'xiaodi';
    private $age = 20;
    protected $six = 'mail';
}
$s = new test();
echo serialize($s);
// è¾“å‡ºç±»ä¼¼ï¼šO:4:"test":3:{s:4:"name";s:6:"xiaodi";s:9:"\x00test\x00age";i:20;s:6:"\x00*\x00six";s:4:"mail";}
```

![](img/4877fe6b504dcf6abe3752ac36d22108_69.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_71.png)

**å…³é”®ç‚¹ï¼š**
åºåˆ—åŒ–æ—¶ï¼ŒPHPé€šè¿‡æ·»åŠ  `\x00`ï¼ˆç©ºå­—ç¬¦ï¼‰å’Œç±»åæˆ– `*` æ¥åŒºåˆ†å±æ€§çš„å¯è§æ€§ï¼Œä»¥ç¡®ä¿ååºåˆ—åŒ–æ—¶èƒ½æ­£ç¡®è¿˜åŸå±æ€§ç±»å‹ã€‚è¿™ä¸æ˜¯é”™è¯¯ï¼Œè€Œæ˜¯å…¶å†…éƒ¨æœºåˆ¶ã€‚

## äºŒã€CVE-2016-7124ï¼š__wakeupç»•è¿‡æ¼æ´ ğŸš«

![](img/4877fe6b504dcf6abe3752ac36d22108_73.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_75.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_77.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_79.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_81.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_83.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_85.png)

æœ¬èŠ‚æˆ‘ä»¬å°†æ¢è®¨ä¸€ä¸ªå†å²æ‚ ä¹…çš„PHPååºåˆ—åŒ–æ¼æ´CVE-2016-7124ï¼Œå®ƒå…è®¸æ”»å‡»è€…åœ¨ç‰¹å®šæ¡ä»¶ä¸‹ç»•è¿‡ `__wakeup` é­”æœ¯æ–¹æ³•çš„æ‰§è¡Œã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_87.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_89.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_91.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_93.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_95.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_97.png)

`__wakeup()` é­”æœ¯æ–¹æ³•åœ¨å¯¹è±¡è¢« `unserialize()` ååºåˆ—åŒ–æ—¶**è‡ªåŠ¨è°ƒç”¨**ã€‚ä½†è¯¥æ¼æ´æŒ‡å‡ºï¼š**å½“åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­è¡¨ç¤ºå¯¹è±¡å±æ€§æ•°é‡çš„å€¼å¤§äºå®é™…å±æ€§æ•°é‡æ—¶ï¼Œä¼šè·³è¿‡ `__wakeup()` æ–¹æ³•çš„æ‰§è¡Œ**ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_99.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_101.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_103.png)

**å½±å“ç‰ˆæœ¬ï¼š** PHP 5.6.x < 5.6.25ï¼Œ PHP 7.x < 7.0.10ã€‚

### æ¼æ´åŸç†ä¸æ¼”ç¤º

ä»¥ä¸‹ä»£ç å±•ç¤ºäº†æ­£å¸¸çš„ `__wakeup()` è°ƒç”¨ï¼š

```php
class test {
    public function __wakeup() {
        echo "__wakeupè¢«è°ƒç”¨ï¼";
    }
}
$s = new test();
$data = serialize($s);
// æ­£å¸¸åºåˆ—åŒ–æ•°æ®ï¼šO:4:"test":0:{}
unserialize($data); // è¾“å‡º "__wakeupè¢«è°ƒç”¨ï¼"
```

![](img/4877fe6b504dcf6abe3752ac36d22108_105.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_106.png)

è¦ç»•è¿‡ `__wakeup`ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹åºåˆ—åŒ–æ•°æ®ä¸­è¡¨ç¤ºå±æ€§æ•°é‡çš„éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œå°† `O:4:"test":0:{}` ä¸­çš„å±æ€§æ•°é‡ `0` æ”¹ä¸ºä¸€ä¸ªæ›´å¤§çš„æ•°ï¼Œå¦‚ `2`ï¼š`O:4:"test":2:{}`ã€‚åœ¨æŸäº›CTFé¢˜ç›®ä¸­ï¼Œè¿™å¯ä»¥ç”¨äºç»•è¿‡å…³é”®çš„å®‰å…¨æ£€æŸ¥ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_108.png)

### å®æˆ˜æ¡ˆä¾‹ï¼šæå®¢å¤§æŒ‘æˆ˜2019

![](img/4877fe6b504dcf6abe3752ac36d22108_110.png)

é¢˜ç›®æºç ä¸­æœ‰ä¸€ä¸ªç±»ï¼Œå…¶ `__wakeup()` æ–¹æ³•ä¼šå°† `username` é‡ç½®ä¸º `guest`ï¼Œè€Œè·å–flagçš„æ¡ä»¶æ˜¯ `username === 'admin'`ã€‚é€šè¿‡åˆ©ç”¨CVE-2016-7124æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥ç»•è¿‡ `__wakeup()`ï¼Œä½¿ `username` ä¿æŒä¸ºæˆ‘ä»¬åºåˆ—åŒ–æ—¶è®¾ç½®çš„ `admin`ï¼Œä»è€Œè·å–flagã€‚

**è§£é¢˜æ­¥éª¤ï¼š**
1.  æ­£å¸¸åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œè®¾ç½® `username='admin'`, `password=100`ã€‚
2.  å°†åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­å¯¹è±¡å±æ€§æ•°é‡çš„å€¼ï¼ˆä¾‹å¦‚`2`ï¼‰ä¿®æ”¹ä¸ºå¤§äº2çš„æ•°ï¼ˆå¦‚`3`æˆ–`4`ï¼‰ã€‚
3.  æäº¤ä¿®æ”¹åçš„åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œç»•è¿‡ `__wakeup()` ä¸­çš„é‡ç½®æ“ä½œï¼Œæ»¡è¶³æ¡ä»¶è·å¾—flagã€‚

## ä¸‰ã€å­—ç¬¦ä¸²é€ƒé€¸æ¼æ´ï¼ˆå¢å‡å­—ç¬¦ï¼‰ğŸ”€

![](img/4877fe6b504dcf6abe3752ac36d22108_112.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_114.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_116.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_118.png)

å­—ç¬¦ä¸²é€ƒé€¸æ˜¯ååºåˆ—åŒ–ä¸­ä¸€ä¸ªç²¾å·§çš„åˆ©ç”¨æŠ€å·§ï¼Œå…¶æœ¬è´¨æ˜¯**åˆ©ç”¨è¿‡æ»¤å‡½æ•°å¯¹åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­ç‰¹å®šå­—ç¬¦çš„â€œå¢åŠ â€æˆ–â€œå‡å°‘â€æ“ä½œï¼Œæ”¹å˜åŸå­—ç¬¦ä¸²çš„ç»“æ„ï¼Œä»è€Œâ€œé€ƒé€¸â€å‡ºæ–°çš„ã€è¢«è§£æçš„å¯¹è±¡å±æ€§**ã€‚è¿™é€šå¸¸å‡ºç°åœ¨å…ˆåºåˆ—åŒ–ï¼Œåè¿‡æ»¤ï¼Œå†ååºåˆ—åŒ–çš„åœºæ™¯ä¸­ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_120.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_122.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_124.png)

### 1. å­—ç¬¦â€œå¢åŠ â€åœºæ™¯

å‡è®¾è¿‡æ»¤å‡½æ•°å°† `admin` æ›¿æ¢ä¸º `hacker`ï¼ˆ5ä½å˜6ä½ï¼Œå¢åŠ 1ä½ï¼‰ã€‚

**æ”»å‡»æ€è·¯ï¼š** æˆ‘ä»¬é€šè¿‡è¾“å…¥å¤§é‡ `admin`ï¼Œä½¿å¾—è¿‡æ»¤åå¢åŠ çš„å­—ç¬¦æ€»é•¿åº¦ï¼Œæ°å¥½â€œåƒæ‰â€åé¢åŸæœ¬å±äºå€¼çš„ä¸€éƒ¨åˆ†ã€‚è¢«â€œåƒæ‰â€çš„éƒ¨åˆ†ä¹‹åçš„å†…å®¹ï¼Œä¼šè¢«å½“åšæ–°çš„åºåˆ—åŒ–é”®å€¼å¯¹è§£æã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_126.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_128.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_130.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_132.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_134.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_136.png)

**æ„é€ å…¬å¼ï¼š**
å‡è®¾æˆ‘ä»¬æƒ³è®©åé¢éšè—çš„ `";s:5:"isVIP";i:1;}` è¢«æˆåŠŸè§£æã€‚
1.  è®¡ç®—éœ€è¦â€œåƒæ‰â€çš„å­—ç¬¦é•¿åº¦ `L`ï¼ˆå³éšè—payloadçš„é•¿åº¦ï¼‰ã€‚
2.  å› ä¸ºæ¯æ›¿æ¢ä¸€ä¸ª `admin` å¢åŠ 1ä½ï¼Œæ‰€ä»¥éœ€è¦è¾“å…¥ `L` ä¸ª `admin`ã€‚
3.  æœ€ç»ˆæ„é€ ï¼š`username='adminadminadmin...'(å…±Lä¸ª) + éšè—payload`ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_138.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_140.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_142.png)

è¿‡æ»¤åï¼Œå¢åŠ çš„ `L` ä¸ªå­—ç¬¦å°† `éšè—payload` ä¹‹å‰çš„å­—ç¬¦ä¸²éƒ¨åˆ†æ•´ä½“åæ¨ï¼Œä½¿å…¶æ°å¥½æˆä¸ºå®Œæ•´çš„é”®å€¼å¯¹ï¼Œè€Œ `éšè—payload` åˆ™è¢«æˆåŠŸè§£æä¸ºæ–°å±æ€§ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_144.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_146.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_148.png)

### 2. å­—ç¬¦â€œå‡å°‘â€åœºæ™¯

![](img/4877fe6b504dcf6abe3752ac36d22108_150.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_152.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_154.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_156.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_158.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_160.png)

å‡è®¾è¿‡æ»¤å‡½æ•°å°† `hacker` æ›¿æ¢ä¸º `admin`ï¼ˆ6ä½å˜5ä½ï¼Œå‡å°‘1ä½ï¼‰ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_162.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_164.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_166.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_168.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_170.png)

**æ”»å‡»æ€è·¯ï¼š** ä¸å¢åŠ ç›¸åï¼Œæˆ‘ä»¬éœ€è¦è®©è¿‡æ»¤åå‡å°‘çš„å­—ç¬¦ï¼Œä½¿å¾—åç»­å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†â€œå‰ç§»â€ï¼Œæˆä¸ºå‰ä¸€ä¸ªé”®å€¼å¯¹çš„å€¼çš„ä¸€éƒ¨åˆ†ï¼Œä»è€Œè®©æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„ååŠéƒ¨åˆ†è¢«ç‹¬ç«‹è§£æã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_172.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_174.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_176.png)

**æ„é€ å…¬å¼ï¼š**
å‡è®¾æˆ‘ä»¬æƒ³é€ƒé€¸çš„payloadæ˜¯ `";s:8:"password";s:6:"123456";s:5:"isVIP";i:1;}`ã€‚
1.  è®¡ç®—payloadé•¿åº¦ `L`ã€‚
2.  å› ä¸ºæ¯æ›¿æ¢ä¸€ä¸ª `hacker` å‡å°‘1ä½ï¼Œæ‰€ä»¥éœ€è¦åœ¨å‰é¢å¯æ§çš„ä½ç½®ï¼ˆå¦‚æŸä¸ªå±æ€§å€¼é‡Œï¼‰å¡«å…… `L` ä¸ª `hacker`ã€‚
3.  è¿‡æ»¤åï¼Œå‡å°‘çš„ `L` ä½ä½¿å¾—åç»­å†…å®¹å‰ç§»ï¼Œæ°å¥½è®©æˆ‘ä»¬çš„é€ƒé€¸payloadè¢«ç‹¬ç«‹è§£æå‡ºæ¥ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_178.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_180.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_182.png)

### å®æˆ˜æŠ€å·§
*   **å…³é”®ï¼š** ç²¾ç¡®è®¡ç®—é•¿åº¦ã€‚éœ€è¦æ ¹æ®è¿‡æ»¤è§„åˆ™ï¼ˆå¢åŠ /å‡å°‘ä½æ•°ï¼‰å’Œé€ƒé€¸payloadçš„é•¿åº¦ï¼Œåæ¨éœ€è¦è¾“å…¥çš„åŸå­—ç¬¦æ•°é‡ã€‚
*   **è§‚å¯Ÿï¼š** æ³¨æ„åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­çš„é•¿åº¦æ ‡è¯†ï¼ˆå¦‚ `s:5:"value"`ï¼‰ï¼Œå¿…é¡»ä¸å®é™…å­—ç¬¦ä¸²é•¿åº¦åŒ¹é…ï¼Œå¦åˆ™ååºåˆ—åŒ–ä¼šå¤±è´¥ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_184.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_186.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_188.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_190.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_192.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_194.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_196.png)

## å››ã€åŸç”Ÿç±»ï¼ˆNative Classï¼‰åˆ©ç”¨ ğŸ› ï¸

![](img/4877fe6b504dcf6abe3752ac36d22108_198.png)

å½“ç›®æ ‡ä»£ç æœ¬èº«æ²¡æœ‰å®šä¹‰æˆ–è§¦å‘ä»»ä½•é­”æœ¯æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨PHPå†…ç½®çš„**åŸç”Ÿç±»**è¿›è¡Œæ”»å‡»ã€‚è¿™äº›åŸç”Ÿç±»æœ¬èº«å¯èƒ½åŒ…å«æœ‰ç”¨çš„æ–¹æ³•æˆ–ä¼šåœ¨ç‰¹å®šæ“ä½œï¼ˆå¦‚è¢« `echo`ã€è°ƒç”¨ä¸å­˜åœ¨æ–¹æ³•ï¼‰æ—¶è§¦å‘æŸäº›è¡Œä¸ºã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_200.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_202.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_204.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_206.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_208.png)

### åˆ©ç”¨åœºæ™¯ä¸æ­¥éª¤
1.  **ç¡®å®šè§¦å‘ç‚¹ï¼š** åˆ†æä»£ç ä¼šå¦‚ä½•æ“ä½œååºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡ï¼ˆå¦‚ `echo $obj` ä¼šè§¦å‘ `__toString`ï¼Œè°ƒç”¨ `$obj->xxx()` ä¼šè§¦å‘ `__call`ï¼‰ã€‚
2.  **å¯»æ‰¾åˆé€‚åŸç”Ÿç±»ï¼š** ä½¿ç”¨è„šæœ¬éå†åœ¨å½“å‰PHPç¯å¢ƒä¸‹æ‰€æœ‰åŒ…å«é­”æœ¯æ–¹æ³•ï¼ˆå¦‚ `__toString`, `__call`, `__get` ç­‰ï¼‰çš„åŸç”Ÿç±»ã€‚
    ```php
    // ç¤ºä¾‹ï¼šæŸ¥æ‰¾æ‰€æœ‰åŒ…å« __toString çš„åŸç”Ÿç±»
    $classes = get_declared_classes();
    foreach ($classes as $class) {
        if (method_exists($class, '__toString')) {
            echo $class . "\n";
        }
    }
    ```
3.  **ç ”ç©¶ç±»åŠŸèƒ½ï¼š** æŸ¥é˜…PHPå®˜æ–¹æ‰‹å†Œï¼Œäº†è§£æ‰¾åˆ°çš„åŸç”Ÿç±»çš„åŠŸèƒ½ã€‚å¸¸è§æœ‰ç”¨çš„åŸç”Ÿç±»æœ‰ï¼š
    *   `Exception` / `Error`ï¼š`__toString` æ–¹æ³•ä¼šæ‰“å°æ ˆè·Ÿè¸ªä¿¡æ¯ï¼Œå¯åŒ…å«æ–‡ä»¶è·¯å¾„æˆ–æ„é€ XSSã€‚
    *   `SoapClient`ï¼š`__call` æ–¹æ³•å¯ç”¨äºå‘èµ·SSRFï¼ˆæœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼‰è¯·æ±‚ã€‚
    *   `SplFileObject`ï¼šå¯ç”¨äºè¯»å–æ–‡ä»¶ã€‚
4.  **æ„é€ åˆ©ç”¨é“¾ï¼š** å®ä¾‹åŒ–é€‰å®šçš„åŸç”Ÿç±»ï¼Œå¹¶è®¾ç½®å…¶å±æ€§ï¼Œä½¿å…¶åœ¨è§¦å‘æ—¶æ‰§è¡Œæˆ‘ä»¬æœŸæœ›çš„æ“ä½œï¼ˆå¦‚è¯»å–æ–‡ä»¶ã€å‘èµ·ç½‘ç»œè¯·æ±‚ï¼‰ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_210.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_212.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_214.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_216.png)

### å®æˆ˜æ¡ˆä¾‹ï¼šCTFShow Web259

![](img/4877fe6b504dcf6abe3752ac36d22108_218.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_220.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_222.png)

é¢˜ç›®ååºåˆ—åŒ–åè°ƒç”¨äº†ä¸å­˜åœ¨çš„æ–¹æ³• `getFlag()`ï¼Œè¿™ä¼šè§¦å‘ `__call` é­”æœ¯æ–¹æ³•ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_224.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_226.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_228.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_230.png)

**è§£é¢˜æ­¥éª¤ï¼š**
1.  æ‰«æå‘ç° `SoapClient` ç±»å…·æœ‰ `__call` æ–¹æ³•ã€‚
2.  `SoapClient` åœ¨è°ƒç”¨ä¸å¯ç”¨æ–¹æ³•æ—¶ï¼Œä¼šå°è¯•å‘é€SOAPè¯·æ±‚ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ„é€ ä¸€ä¸ªè®¿é—®æœ¬åœ° `flag.php` çš„SSRFè¯·æ±‚ã€‚
3.  åœ¨è¯·æ±‚å¤´ä¸­è®¾ç½® `X-Forwarded-For: 127.0.0.1` ä»¥æ»¡è¶³é¢˜ç›®IPé™åˆ¶ï¼Œå¹¶åœ¨Cookieä¸­è®¾ç½® `token=ctfshow` ä»¥æ»¡è¶³tokenæ¡ä»¶ã€‚
4.  åºåˆ—åŒ–æ„é€ å¥½çš„ `SoapClient` å¯¹è±¡å¹¶æäº¤ï¼ŒæœåŠ¡å™¨ä¼šä»£è¡¨æˆ‘ä»¬è®¿é—® `flag.php`ï¼Œä»è€Œå°†flagå†™å…¥æ–‡ä»¶ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_232.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_234.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_236.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_238.png)

**å…³é”®ç‚¹ï¼š** åŸç”Ÿç±»çš„åˆ©ç”¨é«˜åº¦ä¾èµ–äºPHPç¯å¢ƒå¼€å¯çš„æ‰©å±•ï¼ˆå¦‚ `soap` æ‰©å±•ï¼‰ï¼Œå› ä¸ºå¹¶éæ‰€æœ‰åŸç”Ÿç±»é»˜è®¤å¯ç”¨ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_240.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_242.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_244.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_246.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_248.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_250.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_252.png)

## æ€»ç»“ ğŸ“š

![](img/4877fe6b504dcf6abe3752ac36d22108_254.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_256.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_258.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_260.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_262.png)

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†PHPååºåˆ—åŒ–çš„å››ä¸ªé«˜çº§ä¸»é¢˜ï¼š
1.  **å±æ€§ç±»å‹ç‰¹å¾**ï¼šç†è§£äº†`public`ã€`protected`ã€`private`å±æ€§åœ¨åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­çš„ä¸åŒè¡¨ç¤ºï¼Œæœ‰åŠ©äºåˆ†ææµé‡å’Œæ„é€ payloadã€‚
2.  **CVE-2016-7124æ¼æ´**ï¼šæŒæ¡äº†é€šè¿‡ä¿®æ”¹å¯¹è±¡å±æ€§æ•°é‡ç»•è¿‡ `__wakeup()` é­”æœ¯æ–¹æ³•çš„æ–¹æ³•ï¼Œå°½ç®¡è¯¥æ¼æ´å½±å“ç‰ˆæœ¬è¾ƒè€ï¼Œä½†åœ¨CTFä¸­ä»æœ‰å‡ºç°ã€‚
3.  **å­—ç¬¦ä¸²é€ƒé€¸æ¼æ´**ï¼šæ·±å…¥ç†è§£äº†åˆ©ç”¨è¿‡æ»¤å‡½æ•°å¯¹å­—ç¬¦çš„â€œå¢â€æˆ–â€œå‡â€ï¼Œé€šè¿‡ç²¾å¯†çš„é•¿åº¦è®¡ç®—æ¥æ”¹å˜åºåˆ—åŒ–å­—ç¬¦ä¸²ç»“æ„ï¼Œå®ç°å±æ€§æ³¨å…¥çš„åˆ©ç”¨æŠ€å·§ã€‚è¿™æ˜¯æœ¬ç« çš„éš¾ç‚¹å’Œé‡ç‚¹ã€‚
4.  **åŸç”Ÿç±»åˆ©ç”¨**ï¼šå­¦ä¹ äº†åœ¨æ— è‡ªå®šä¹‰é­”æœ¯æ–¹æ³•å¯ç”¨æ—¶ï¼Œå¦‚ä½•å¯»æ‰¾å¹¶åˆ©ç”¨PHPå†…ç½®åŸç”Ÿç±»çš„é­”æœ¯æ–¹æ³•æˆ–åŠŸèƒ½ï¼ˆå¦‚ `SoapClient` å‘èµ·SSRFï¼Œ`Exception` æ³„éœ²ä¿¡æ¯ï¼‰æ¥è¾¾åˆ°æ”»å‡»ç›®çš„ã€‚

![](img/4877fe6b504dcf6abe3752ac36d22108_264.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_266.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_268.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_270.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_272.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_274.png)

![](img/4877fe6b504dcf6abe3752ac36d22108_276.png)

è¿™äº›çŸ¥è¯†ç‚¹æ„æˆäº†PHPååºåˆ—åŒ–å¤æ‚åˆ©ç”¨çš„åŸºç¡€ï¼Œéœ€è¦ç»“åˆå®è·µåå¤ç»ƒä¹ å’Œæ€è€ƒï¼Œå°¤å…¶æ˜¯å­—ç¬¦ä¸²é€ƒé€¸çš„é•¿åº¦è®¡ç®—é€»è¾‘ã€‚