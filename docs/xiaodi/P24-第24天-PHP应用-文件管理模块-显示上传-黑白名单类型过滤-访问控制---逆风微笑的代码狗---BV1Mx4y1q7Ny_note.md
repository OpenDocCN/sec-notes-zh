# ğŸ“ è¯¾ç¨‹24ï¼šPHPåº”ç”¨å¼€å‘ - æ–‡ä»¶ç®¡ç†æ¨¡å—ï¼ˆæ˜¾ç¤ºä¸ä¸Šä¼ ï¼‰åŠå®‰å…¨è¿‡æ»¤

![](img/d46d35f9da3b449d82f2d2e69503e40e_1.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_3.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_5.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_7.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ PHPæ–‡ä»¶ç®¡ç†æ¨¡å—çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬æ–‡ä»¶åˆ—è¡¨çš„æ˜¾ç¤ºå’Œæ–‡ä»¶ä¸Šä¼ çš„å®ç°ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¼šæ¢è®¨å¦‚ä½•é€šè¿‡é»‘åå•ã€ç™½åå•å’ŒMIMEç±»å‹è¿‡æ»¤æ¥å¢å¼ºä¸Šä¼ åŠŸèƒ½çš„å®‰å…¨æ€§ï¼Œå¹¶åˆ†æè¿™äº›åŠŸèƒ½å¯èƒ½å¼•å‘çš„å®‰å…¨æ¼æ´åŠå…¶é˜²å¾¡æªæ–½ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_9.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_11.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_13.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_15.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_17.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_19.png)

---

![](img/d46d35f9da3b449d82f2d2e69503e40e_21.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_23.png)

## ğŸ” ä¸ŠèŠ‚å›é¡¾ä¸æœ¬èŠ‚æ¦‚è¿°

![](img/d46d35f9da3b449d82f2d2e69503e40e_25.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_27.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_29.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_31.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_33.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_35.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†ä½¿ç”¨Tokenæœºåˆ¶é˜²æ­¢æš´åŠ›ç ´è§£ç­‰å®‰å…¨é—®é¢˜çš„åŸç†ã€‚æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥PHPçš„æ–‡ä»¶æ“ä½œï¼Œå­¦ä¹ å¦‚ä½•æ„å»ºä¸€ä¸ªåŸºç¡€çš„æ–‡ä»¶ç®¡ç†å™¨ï¼Œå¹¶å®ç°å®‰å…¨çš„ä¸Šä¼ è¿‡æ»¤ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_37.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_38.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_40.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_41.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_42.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_44.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_46.png)

æ–‡ä»¶ç®¡ç†æ¨¡å—é€šå¸¸åŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š**æ–‡ä»¶ä¸Šä¼ **ã€**æ–‡ä»¶ä¸‹è½½**ã€**æ–‡ä»¶åˆ é™¤**ã€**æ–‡ä»¶ç¼–è¾‘**å’Œ**æ–‡ä»¶åŒ…å«**ã€‚ä»Šå¤©æˆ‘ä»¬å°†é‡ç‚¹è®²è§£**æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º**å’Œ**æ–‡ä»¶ä¸Šä¼ **è¿™ä¸¤ä¸ªéƒ¨åˆ†ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_48.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_50.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_52.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_54.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_56.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_57.png)

---

![](img/d46d35f9da3b449d82f2d2e69503e40e_59.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_61.png)

## ğŸ“‚ æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å®ç°

![](img/d46d35f9da3b449d82f2d2e69503e40e_63.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_65.png)

æ–‡ä»¶ä¸Šä¼ æ˜¯Webåº”ç”¨ä¸­çš„å¸¸è§åŠŸèƒ½ã€‚åœ¨PHPä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å…¨å±€å˜é‡ `$_FILES` æ¥å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_67.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_69.png)

### æ ¸å¿ƒä»£ç ï¼šæ¥æ”¶ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯

![](img/d46d35f9da3b449d82f2d2e69503e40e_71.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_73.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_75.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_77.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_78.png)

ä»¥ä¸‹æ˜¯æ¥æ”¶ä¸Šä¼ æ–‡ä»¶åŸºæœ¬ä¿¡æ¯ï¼ˆå¦‚æ–‡ä»¶åã€ç±»å‹ã€å¤§å°ã€ä¸´æ—¶è·¯å¾„ï¼‰çš„ä»£ç ï¼š

![](img/d46d35f9da3b449d82f2d2e69503e40e_80.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_82.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_84.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_86.png)

```php
// æ¥æ”¶ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯
$name = $_FILES['file']['name'];     // åŸå§‹æ–‡ä»¶å
$type = $_FILES['file']['type'];     // æ–‡ä»¶MIMEç±»å‹
$size = $_FILES['file']['size'];     // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
$tmp_name = $_FILES['file']['tmp_name']; // ä¸´æ—¶æ–‡ä»¶è·¯å¾„
$error = $_FILES['file']['error'];   // é”™è¯¯ä»£ç 
```

![](img/d46d35f9da3b449d82f2d2e69503e40e_88.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_90.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_91.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_93.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_95.png)

**ä»£ç è¯´æ˜**ï¼š
*   `â€˜fileâ€˜` å¯¹åº”HTMLè¡¨å•ä¸­æ–‡ä»¶è¾“å…¥æ¡†çš„ `name` å±æ€§ã€‚
*   `tmp_name` æ˜¯æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨åçš„ä¸´æ—¶å­˜å‚¨è·¯å¾„ï¼Œè„šæœ¬æ‰§è¡Œå®Œæ¯•åä¼šè¢«æ¸…é™¤ã€‚
*   `error` ä¸º0è¡¨ç¤ºä¸Šä¼ æˆåŠŸï¼Œå…¶ä»–å€¼ä»£è¡¨ä¸åŒç±»å‹çš„é”™è¯¯ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_97.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_99.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_100.png)

### æ ¸å¿ƒä»£ç ï¼šç§»åŠ¨ä¸´æ—¶æ–‡ä»¶

![](img/d46d35f9da3b449d82f2d2e69503e40e_102.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_104.png)

è·å–æ–‡ä»¶ä¿¡æ¯åï¼Œéœ€è¦ä½¿ç”¨ `move_uploaded_file()` å‡½æ•°å°†ä¸´æ—¶æ–‡ä»¶ç§»åŠ¨åˆ°æˆ‘ä»¬æŒ‡å®šçš„ç›®å½•ï¼š

![](img/d46d35f9da3b449d82f2d2e69503e40e_106.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_108.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_110.png)

```php
// å®šä¹‰ç›®æ ‡è·¯å¾„
$target_dir = "uploads/";
$target_file = $target_dir . basename($name);

![](img/d46d35f9da3b449d82f2d2e69503e40e_112.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_114.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_116.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_118.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_120.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_121.png)

// ç§»åŠ¨æ–‡ä»¶
if (move_uploaded_file($tmp_name, $target_file)) {
    echo "æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼";
} else {
    echo "æ–‡ä»¶ä¸Šä¼ å¤±è´¥ã€‚";
}
```

![](img/d46d35f9da3b449d82f2d2e69503e40e_123.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_125.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_126.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_128.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_130.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_132.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_134.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_136.png)

---

![](img/d46d35f9da3b449d82f2d2e69503e40e_138.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_140.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_142.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_144.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_146.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_148.png)

## ğŸ›¡ï¸ æ–‡ä»¶ä¸Šä¼ å®‰å…¨è¿‡æ»¤

![](img/d46d35f9da3b449d82f2d2e69503e40e_150.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_152.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_154.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_156.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_157.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_159.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_161.png)

å•çº¯å®ç°ä¸Šä¼ åŠŸèƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œå¿…é¡»å¯¹ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œä¸¥æ ¼è¿‡æ»¤ã€‚å¸¸è§çš„è¿‡æ»¤æœºåˆ¶æœ‰ä¸‰ç§ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_163.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_165.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_167.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_169.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_171.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_173.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_175.png)

### 1. é»‘åå•è¿‡æ»¤

![](img/d46d35f9da3b449d82f2d2e69503e40e_177.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_179.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_181.png)

é»‘åå•æœºåˆ¶æ˜¯**ç¦æ­¢ä¸Šä¼ ç‰¹å®šå±é™©åç¼€**çš„æ–‡ä»¶ï¼ˆå¦‚ `.php`, `.asp`, `.jsp`ï¼‰ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_183.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_185.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_187.png)

**æ ¸å¿ƒé€»è¾‘**ï¼š
1.  å®šä¹‰ä¸å…è®¸çš„åç¼€åˆ—è¡¨ã€‚
2.  è·å–ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶çš„åç¼€åã€‚
3.  åˆ¤æ–­è¯¥åç¼€æ˜¯å¦åœ¨é»‘åå•ä¸­ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_189.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_191.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_193.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_194.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_196.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_198.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_200.png)

ä»¥ä¸‹æ˜¯å®ç°ä»£ç ï¼š

![](img/d46d35f9da3b449d82f2d2e69503e40e_202.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_204.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_206.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_208.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_210.png)

```php
// å®šä¹‰é»‘åå•åç¼€
$black_ext = array('php', 'asp', 'jsp', 'aspx');

![](img/d46d35f9da3b449d82f2d2e69503e40e_212.png)

// è·å–ä¸Šä¼ æ–‡ä»¶çš„åç¼€å
$filename = $_FILES['file']['name'];
$ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

![](img/d46d35f9da3b449d82f2d2e69503e40e_214.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_216.png)

// åˆ¤æ–­æ˜¯å¦åœ¨é»‘åå•ä¸­
if (in_array($ext, $black_ext)) {
    die("éæ³•åç¼€æ–‡ä»¶ï¼Œç¦æ­¢ä¸Šä¼ ï¼");
} else {
    // æ‰§è¡Œå®‰å…¨çš„ä¸Šä¼ æ“ä½œ
    move_uploaded_file($tmp_name, $target_file);
    echo "ä¸Šä¼ æˆåŠŸï¼";
}
```

![](img/d46d35f9da3b449d82f2d2e69503e40e_218.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_220.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_222.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_224.png)

**å®‰å…¨éšæ‚£**ï¼šæ”»å‡»è€…å¯èƒ½ä½¿ç”¨ä¸åœ¨åå•å†…çš„è„šæœ¬åç¼€ï¼ˆå¦‚ `.php5`, `.phtml`ï¼‰è¿›è¡Œç»•è¿‡ï¼Œå¦‚æœæœåŠ¡å™¨ç¯å¢ƒæ”¯æŒè§£æè¿™äº›åç¼€ï¼Œåˆ™æ¼æ´ä¾ç„¶å­˜åœ¨ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_226.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_228.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_230.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_232.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_234.png)

### 2. ç™½åå•è¿‡æ»¤

ç™½åå•æœºåˆ¶æ˜¯**åªå…è®¸ä¸Šä¼ ç‰¹å®šå®‰å…¨åç¼€**çš„æ–‡ä»¶ï¼ˆå¦‚å›¾ç‰‡æ ¼å¼ `.jpg`, `.png`, `.gif`ï¼‰ã€‚è¿™æ˜¯æ¯”é»‘åå•æ›´å®‰å…¨çš„ç­–ç•¥ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_236.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_238.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_240.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_242.png)

**æ ¸å¿ƒé€»è¾‘**ï¼š
1.  å®šä¹‰å…è®¸çš„åç¼€åˆ—è¡¨ã€‚
2.  è·å–ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶çš„åç¼€åã€‚
3.  åˆ¤æ–­è¯¥åç¼€æ˜¯å¦åœ¨ç™½åå•ä¸­ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_244.png)

ä»¥ä¸‹æ˜¯å®ç°ä»£ç ï¼š

```php
// å®šä¹‰ç™½åå•åç¼€
$white_ext = array('jpg', 'jpeg', 'png', 'gif');

![](img/d46d35f9da3b449d82f2d2e69503e40e_246.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_248.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_250.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_251.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_253.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_255.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_257.png)

// è·å–ä¸Šä¼ æ–‡ä»¶çš„åç¼€å
$filename = $_FILES['file']['name'];
$ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

![](img/d46d35f9da3b449d82f2d2e69503e40e_259.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_261.png)

// åˆ¤æ–­æ˜¯å¦åœ¨ç™½åå•ä¸­
if (!in_array($ext, $white_ext)) {
    die("éæ³•æ–‡ä»¶ç±»å‹ï¼Œä»…å…è®¸ä¸Šä¼ å›¾ç‰‡ï¼");
} else {
    // æ‰§è¡Œå®‰å…¨çš„ä¸Šä¼ æ“ä½œ
    move_uploaded_file($tmp_name, $target_file);
    echo "ä¸Šä¼ æˆåŠŸï¼";
}
```

### 3. MIMEç±»å‹è¿‡æ»¤

![](img/d46d35f9da3b449d82f2d2e69503e40e_263.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_265.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_267.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_269.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_271.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_273.png)

MIMEç±»å‹æ˜¯æµè§ˆå™¨åœ¨HTTPå¤´ä¸­å£°æ˜çš„æ–‡ä»¶ç±»å‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ `$_FILES[â€˜fileâ€˜][â€˜typeâ€˜]` çš„å€¼æ¥è¿›è¡Œè¿‡æ»¤ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_275.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_277.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_279.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_281.png)

**æ ¸å¿ƒé€»è¾‘**ï¼š
1.  å®šä¹‰å…è®¸çš„MIMEç±»å‹åˆ—è¡¨ï¼ˆå¦‚å›¾ç‰‡ç±»å‹ï¼‰ã€‚
2.  è·å–ä¸Šä¼ æ–‡ä»¶çš„MIMEç±»å‹ã€‚
3.  åˆ¤æ–­è¯¥ç±»å‹æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_283.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_285.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_287.png)

ä»¥ä¸‹æ˜¯å®ç°ä»£ç ï¼š

![](img/d46d35f9da3b449d82f2d2e69503e40e_289.png)

```php
// å®šä¹‰å…è®¸çš„MIMEç±»å‹
$allowed_mime = array('image/jpeg', 'image/png', 'image/gif');

![](img/d46d35f9da3b449d82f2d2e69503e40e_291.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_293.png)

// è·å–ä¸Šä¼ æ–‡ä»¶çš„MIMEç±»å‹
$file_mime = $_FILES['file']['type'];

![](img/d46d35f9da3b449d82f2d2e69503e40e_295.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_297.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_299.png)

// åˆ¤æ–­MIMEç±»å‹æ˜¯å¦åˆæ³•
if (!in_array($file_mime, $allowed_mime)) {
    die("éæ³•æ–‡ä»¶ç±»å‹ï¼Œç¦æ­¢ä¸Šä¼ ï¼");
} else {
    // æ‰§è¡Œä¸Šä¼ æ“ä½œ
    move_uploaded_file($tmp_name, $target_file);
    echo "ä¸Šä¼ æˆåŠŸï¼";
}
```

![](img/d46d35f9da3b449d82f2d2e69503e40e_301.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_303.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_305.png)

**å®‰å…¨éšæ‚£**ï¼šMIMEç±»å‹å®Œå…¨ç”±å®¢æˆ·ç«¯æ§åˆ¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æŠ“åŒ…å·¥å…·ï¼ˆå¦‚Burp Suiteï¼‰è½»æ˜“ä¿®æ”¹ `Content-Type` å¤´ï¼Œä¼ªè£…æˆåˆæ³•ç±»å‹è¿›è¡Œç»•è¿‡ã€‚**å› æ­¤ï¼Œç»ä¸èƒ½ä»…ä¾èµ–MIMEç±»å‹è¿›è¡ŒéªŒè¯**ï¼Œå¿…é¡»ç»“åˆç™½åå•åç¼€æ£€æŸ¥ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_307.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_309.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_311.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_313.png)

**æœ€ä½³å®è·µ**ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œåº”ç»„åˆä½¿ç”¨**ç™½åå•åç¼€è¿‡æ»¤**å’Œ**æœåŠ¡å™¨ç«¯æ–‡ä»¶å†…å®¹æ£€æµ‹**ï¼ˆå¦‚ä½¿ç”¨ `getimagesize()` å‡½æ•°éªŒè¯å›¾ç‰‡æ–‡ä»¶çœŸä¼ªï¼‰ï¼Œä»¥æ„å»ºå¤šå±‚æ¬¡é˜²å¾¡ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_315.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_317.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_319.png)

---

![](img/d46d35f9da3b449d82f2d2e69503e40e_321.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_322.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_323.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_325.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_326.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_328.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_330.png)

## ğŸ“ æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºä¸ç›®å½•éå†

æ–‡ä»¶ç®¡ç†å™¨éœ€è¦èƒ½å¤Ÿè¯»å–å¹¶æ˜¾ç¤ºæŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_332.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_334.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_335.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_336.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_338.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_340.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_342.png)

### æ ¸å¿ƒå‡½æ•°
*   `is_dir($path)`ï¼šåˆ¤æ–­è·¯å¾„æ˜¯å¦ä¸ºç›®å½•ã€‚
*   `opendir($path)`ï¼šæ‰“å¼€ç›®å½•å¥æŸ„ã€‚
*   `readdir($handle)`ï¼šä»ç›®å½•å¥æŸ„ä¸­è¯»å–æ¡ç›®ã€‚
*   `closedir($handle)`ï¼šå…³é—­ç›®å½•å¥æŸ„ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_343.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_345.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_347.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_348.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_350.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_351.png)

### åŸºç¡€å®ç°ä»£ç 

![](img/d46d35f9da3b449d82f2d2e69503e40e_353.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_355.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_357.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_359.png)

ä»¥ä¸‹ä»£ç å®ç°äº†è¯»å–å¹¶æ˜¾ç¤ºå½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼š

![](img/d46d35f9da3b449d82f2d2e69503e40e_361.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_363.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_365.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_367.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_369.png)

```php
function listFiles($dir = '.') {
    if (is_dir($dir)) {
        if ($dh = opendir($dir)) {
            while (($file = readdir($dh)) !== false) {
                if ($file != '.' && $file != '..') { // æ’é™¤å½“å‰å’Œä¸Šçº§ç›®å½•
                    $filepath = $dir . '/' . $file;
                    if (is_dir($filepath)) {
                        echo "[ç›®å½•] " . $file . "<br>";
                    } else {
                        echo "[æ–‡ä»¶] " . $file . "<br>";
                    }
                }
            }
            closedir($dh);
        }
    }
}
// è°ƒç”¨å‡½æ•°ï¼Œæ˜¾ç¤ºå½“å‰ç›®å½•
listFiles();
```

![](img/d46d35f9da3b449d82f2d2e69503e40e_371.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_373.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_375.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_377.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_379.png)

### å®‰å…¨é£é™©ï¼šç›®å½•éå†æ¼æ´

![](img/d46d35f9da3b449d82f2d2e69503e40e_381.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_383.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_385.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_387.png)

å¦‚æœæ–‡ä»¶åˆ—è¡¨åŠŸèƒ½æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„è·¯å¾„å‚æ•°ï¼ˆå¦‚ `?path=./uploads`ï¼‰ï¼Œå¹¶ä¸”æ²¡æœ‰è¿›è¡Œä¸¥æ ¼è¿‡æ»¤ï¼Œæ”»å‡»è€…å¯èƒ½é€šè¿‡è¾“å…¥ `../../../` è¿™æ ·çš„è·¯å¾„åºåˆ—æ¥è®¿é—®æœåŠ¡å™¨ä¸Šçš„ä»»æ„ç›®å½•ï¼Œé€ æˆ**ç›®å½•éå†æ¼æ´**ï¼ˆæˆ–è·¯å¾„ç©¿è¶Šæ¼æ´ï¼‰ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_389.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_391.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_393.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_395.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_397.png)

**æ¼æ´ç¤ºä¾‹**ï¼š
```php
// ä¸å®‰å…¨çš„ä»£ç ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ä½œä¸ºè·¯å¾„
$user_path = $_GET['path'];
listFiles($user_path); // æ”»å‡»è€…å¯ä¼ å…¥ ../../../etc/passwd
```

**é˜²å¾¡æªæ–½**ï¼š
1.  **è·¯å¾„å›ºå®š**ï¼šåœ¨PHPé…ç½®æ–‡ä»¶ï¼ˆphp.iniï¼‰ä¸­è®¾ç½® `open_basedir`ï¼Œå°†PHPè„šæœ¬å¯è®¿é—®çš„æ–‡ä»¶é™åˆ¶åœ¨ç‰¹å®šç›®å½•æ ‘å†…ã€‚
    ```ini
    open_basedir = /var/www/html/
    ```
2.  **ä»£ç è¿‡æ»¤**ï¼šåœ¨ä»£ç ä¸­å¯¹ç”¨æˆ·è¾“å…¥çš„è·¯å¾„è¿›è¡Œè§„èŒƒåŒ–ï¼Œå¹¶è¿‡æ»¤æ‰ `..`ã€`../` ç­‰å±é™©å­—ç¬¦ã€‚
    ```php
    $user_path = $_GET['path'];
    // è¿‡æ»¤ç›®å½•ç©¿è¶Šå­—ç¬¦
    if (strpos($user_path, '..') !== false) {
        die('ç¦æ­¢è·¨ç›®å½•è®¿é—®ï¼');
    }
    // æˆ–è€…å°†è·¯å¾„é™åˆ¶åœ¨ç‰¹å®šåŸºç¡€ç›®å½•ä¸‹
    $base_dir = '/var/www/html/uploads/';
    $real_path = realpath($base_dir . $user_path);
    // æ£€æŸ¥æœ€ç»ˆè·¯å¾„æ˜¯å¦ä»åœ¨åŸºç¡€ç›®å½•å†…
    if (strpos($real_path, $base_dir) === 0) {
        listFiles($real_path);
    } else {
        die('éæ³•è·¯å¾„ï¼');
    }
    ```

![](img/d46d35f9da3b449d82f2d2e69503e40e_399.png)

---

![](img/d46d35f9da3b449d82f2d2e69503e40e_401.png)

## ğŸ“ æœ¬èŠ‚è¯¾æ€»ç»“

![](img/d46d35f9da3b449d82f2d2e69503e40e_403.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†PHPæ–‡ä»¶ç®¡ç†æ¨¡å—çš„ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š

![](img/d46d35f9da3b449d82f2d2e69503e40e_405.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_407.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_409.png)

1.  **æ–‡ä»¶ä¸Šä¼ **ï¼šæˆ‘ä»¬æŒæ¡äº†ä½¿ç”¨ `$_FILES` å…¨å±€å˜é‡å’Œ `move_uploaded_file()` å‡½æ•°å®ç°ä¸Šä¼ çš„åŸºæœ¬æ–¹æ³•ï¼Œå¹¶æ·±å…¥æ¢è®¨äº†ä¸‰ç§å®‰å…¨è¿‡æ»¤æœºåˆ¶ï¼š
    *   **é»‘åå•è¿‡æ»¤**ï¼šç¦æ­¢ç‰¹å®šå±é™©åç¼€ï¼Œä½†å­˜åœ¨è¢«æœªçŸ¥å±é™©åç¼€ç»•è¿‡çš„é£é™©ã€‚
    *   **ç™½åå•è¿‡æ»¤**ï¼šåªå…è®¸ç‰¹å®šå®‰å…¨åç¼€ï¼Œæ˜¯æ›´å¯é çš„ç­–ç•¥ã€‚
    *   **MIMEç±»å‹è¿‡æ»¤**ï¼šæ£€æŸ¥å®¢æˆ·ç«¯å£°æ˜çš„æ–‡ä»¶ç±»å‹ï¼Œä½†ææ˜“è¢«ç»•è¿‡ï¼Œéœ€ä¸å…¶ä»–æ–¹æ³•ç»“åˆä½¿ç”¨ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_411.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_413.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_415.png)

2.  **æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º**ï¼šæˆ‘ä»¬å­¦ä¹ äº†ä½¿ç”¨ç›®å½•æ“ä½œå‡½æ•°è¯»å–å’Œæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶åˆ†æäº†ç”±æ­¤å¯èƒ½å¼•å‘çš„**ç›®å½•éå†æ¼æ´**ã€‚æˆ‘ä»¬ä»‹ç»äº†ä¸¤ç§ä¸»è¦çš„é˜²å¾¡æ€è·¯ï¼šé€šè¿‡PHPé…ç½® (`open_basedir`) è¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œä»¥åŠåœ¨ä»£ç å±‚é¢å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸¥æ ¼çš„è·¯å¾„æ ¡éªŒå’Œè¿‡æ»¤ã€‚

![](img/d46d35f9da3b449d82f2d2e69503e40e_417.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_419.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_421.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_423.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_425.png)

![](img/d46d35f9da3b449d82f2d2e69503e40e_427.png)

ç†è§£è¿™äº›åŠŸèƒ½çš„å®ç°åŸç†å’Œå®‰å…¨è¾¹ç•Œï¼Œæ˜¯è¿›è¡Œå®‰å…¨å¼€å‘ã€ä»£ç å®¡è®¡å’Œæ¼æ´æµ‹è¯•çš„åŸºç¡€ã€‚ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†ç»§ç»­å®Œå–„æ–‡ä»¶ç®¡ç†å™¨ï¼Œå®ç°æ–‡ä»¶çš„ä¸‹è½½ã€åˆ é™¤å’Œç¼–è¾‘åŠŸèƒ½ã€‚