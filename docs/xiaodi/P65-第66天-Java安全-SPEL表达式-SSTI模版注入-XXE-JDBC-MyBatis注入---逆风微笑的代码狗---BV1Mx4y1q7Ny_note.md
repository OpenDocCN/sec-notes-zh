# Javaå®‰å…¨è¯¾ç¨‹ P65ï¼šSQLæ³¨å…¥ã€XXEã€SSTIä¸SPELè¡¨è¾¾å¼æ³¨å…¥ ğŸ”

![](img/e5942ddd3dada5b6ba875c20377dfc49_0.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_2.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_4.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ Javaå®‰å…¨ä¸­å‡ ä¸ªæ ¸å¿ƒçš„Webæ¼æ´ï¼šSQLæ³¨å…¥ã€XXEã€SSTIæ¨¡æ¿æ³¨å…¥ä»¥åŠSPELè¡¨è¾¾å¼æ³¨å…¥ã€‚æˆ‘ä»¬å°†é€šè¿‡ä¸¤ä¸ªé›†æˆæ¼æ´ç¯å¢ƒæ¥æ¼”ç¤ºè¿™äº›æ¼æ´åœ¨Javaä¸­çš„æˆå› ã€åˆ©ç”¨æ–¹å¼ä»¥åŠä¸PHPç¯å¢ƒçš„å·®å¼‚ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_6.png)

## æ¦‚è¿° ğŸ“‹

![](img/e5942ddd3dada5b6ba875c20377dfc49_8.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_10.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_12.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_14.png)

Javaå®‰å…¨æ¼æ´åœ¨åŸç†ä¸Šä¸PHPç­‰è¯­è¨€ç›¸ä¼¼ï¼Œä½†å…·ä½“å®ç°å’Œåˆ©ç”¨æ–¹å¼å­˜åœ¨å·®å¼‚ã€‚æœ¬èŠ‚è¯¾çš„é‡ç‚¹æ˜¯ç†è§£è¿™äº›æ¼æ´åœ¨Javaä»£ç ä¸­çš„è¡¨ç°å½¢å¼ï¼Œç‰¹åˆ«æ˜¯JDBCã€MyBatisæ¡†æ¶ä¸‹çš„SQLæ³¨å…¥ï¼Œä»¥åŠJavaç‰¹æœ‰çš„SPELè¡¨è¾¾å¼æ³¨å…¥ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_16.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_18.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_20.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_22.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_24.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_26.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_28.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_30.png)

## ç¯å¢ƒæ­å»ºä¸å‡†å¤‡ ğŸ› ï¸

![](img/e5942ddd3dada5b6ba875c20377dfc49_32.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_34.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_36.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_38.png)

ä¸ºäº†ä¾¿äºå­¦ä¹ ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªJavaæ¼æ´é›†æˆç¯å¢ƒï¼š`java-sec` å’Œ `hello-java-sec`ã€‚å®ƒä»¬åŸºäºSpring Bootæ¡†æ¶ï¼Œé›†æˆäº†å¤šç§å¸¸è§æ¼æ´ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_40.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_42.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_44.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_46.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_48.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_49.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_51.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_53.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_55.png)

ä»¥ä¸‹æ˜¯ç¯å¢ƒæ­å»ºçš„å…³é”®æ­¥éª¤ï¼š

![](img/e5942ddd3dada5b6ba875c20377dfc49_57.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_59.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_61.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_63.png)

1.  **æ•°æ®åº“é…ç½®**ï¼šå¯¼å…¥é¡¹ç›®æä¾›çš„SQLæ–‡ä»¶ï¼Œå¹¶ç¡®ä¿`application.properties`æˆ–ç›¸å…³é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼ˆå¦‚`jdbc:mysql://localhost:3306/java_sec`ï¼‰ä¸æœ¬åœ°MySQLç¯å¢ƒä¸€è‡´ã€‚
2.  **Javaç‰ˆæœ¬**ï¼šå»ºè®®ä½¿ç”¨JDK 1.8è¿è¡Œç¯å¢ƒï¼Œä»¥é¿å…ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ã€‚å¯åŠ¨å‘½ä»¤ç¤ºä¾‹å¦‚ä¸‹ï¼š
    ```bash
    "C:\Program Files\Java\jdk1.8.0_xxx\bin\java.exe" -jar java-sec.jar
    ```
3.  **é¡¹ç›®å¯åŠ¨**ï¼šæˆåŠŸå¯åŠ¨åï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®å¯¹åº”çš„ç«¯å£ï¼ˆå¦‚`http://localhost:8000`ï¼‰å³å¯è¿›å…¥æ¼æ´æ¼”ç¤ºå¹³å°ã€‚

è¿™ä¸¤ä¸ªç¯å¢ƒç•Œé¢æ¸…æ™°ï¼Œåˆ†ç±»æ˜ç¡®ï¼Œå¹¶ä¸”æä¾›äº†æ¼æ´ä»£ç ä¸å®‰å…¨ä»£ç çš„å¯¹æ¯”ï¼Œéå¸¸é€‚åˆåˆå­¦è€…ç†è§£ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_65.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_67.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_69.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_71.png)

## SQLæ³¨å…¥ï¼ˆJDBC & MyBatisï¼‰ğŸ’‰

![](img/e5942ddd3dada5b6ba875c20377dfc49_73.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_75.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬å‡†å¤‡å¥½äº†å®éªŒç¯å¢ƒï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹Javaä¸­æœ€å¸¸è§çš„æ¼æ´ä¹‹ä¸€ï¼šSQLæ³¨å…¥ã€‚åœ¨Javaä¸­ï¼ŒSQLæ³¨å…¥ä¸»è¦å‡ºç°åœ¨ç›´æ¥æ“ä½œæ•°æ®åº“çš„ä»£ç ä¸­ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨JDBCå’ŒMyBatisæ¡†æ¶æ—¶ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_77.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_79.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_80.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_82.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_84.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_86.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_88.png)

### JDBCä¸­çš„SQLæ³¨å…¥

![](img/e5942ddd3dada5b6ba875c20377dfc49_90.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_92.png)

JDBCæ˜¯Javaè¿æ¥æ•°æ®åº“çš„æ ‡å‡†APIã€‚äº§ç”Ÿæ³¨å…¥çš„æ ¹æœ¬åŸå› æ˜¯**å­—ç¬¦ä¸²æ‹¼æ¥**ã€‚

**æ¼æ´ä»£ç ç¤ºä¾‹ï¼š**
```java
String sql = "SELECT * FROM users WHERE id = " + request.getParameter("id");
Statement stmt = connection.createStatement();
ResultSet rs = stmt.executeQuery(sql);
```
ä¸Šè¿°ä»£ç ç›´æ¥å°†ç”¨æˆ·è¾“å…¥çš„`id`å‚æ•°æ‹¼æ¥åˆ°SQLè¯­å¥ä¸­ï¼Œå¦‚æœç”¨æˆ·è¾“å…¥`1 OR 1=1`ï¼Œå°±ä¼šæ”¹å˜åŸè¯­å¥çš„é€»è¾‘ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_94.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_96.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_97.png)

**å®‰å…¨å†™æ³•ï¼ˆä½¿ç”¨é¢„ç¼–è¯‘PreparedStatementï¼‰ï¼š**
```java
String sql = "SELECT * FROM users WHERE id = ?";
PreparedStatement pstmt = connection.prepareStatement(sql);
pstmt.setInt(1, Integer.parseInt(request.getParameter("id")));
ResultSet rs = pstmt.executeQuery();
```
ä½¿ç”¨`?`ä½œä¸ºå ä½ç¬¦ï¼Œç„¶åé€šè¿‡`setXXX`æ–¹æ³•è®¾ç½®å‚æ•°å€¼ï¼Œæ•°æ®åº“ä¼šå¯¹å¾…å‚æ•°å€¼è¿›è¡Œè½¬ä¹‰ï¼Œä»è€Œé¿å…æ³¨å…¥ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_99.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_101.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_103.png)

**å…³é”®ç‚¹**ï¼šå³ä½¿ä½¿ç”¨äº†`PreparedStatement`ï¼Œä½†å¦‚æœSQLè¯­å¥æœ¬èº«ä»æ˜¯æ‹¼æ¥è€Œæˆçš„ï¼Œé¢„ç¼–è¯‘ä¹Ÿä¼šå¤±æ•ˆã€‚å®‰å…¨çš„æ ¸å¿ƒåœ¨äº **SQLè¯­å¥æœ¬èº«å¿…é¡»ä½¿ç”¨`?`å ä½ç¬¦**ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_105.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_107.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_109.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_111.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_113.png)

### MyBatisä¸­çš„SQLæ³¨å…¥

![](img/e5942ddd3dada5b6ba875c20377dfc49_115.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_117.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_119.png)

MyBatisæ˜¯ä¸€ä¸ªä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œå®ƒä½¿ç”¨XMLæˆ–æ³¨è§£æ¥é…ç½®å’Œæ˜ å°„SQLã€‚åœ¨MyBatisä¸­ï¼Œéœ€è¦å…³æ³¨ä¸¤ç§å‚æ•°ç¬¦å·ï¼š`#{}`å’Œ`${}`ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_121.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_123.png)

*   `#{}`ï¼šç›¸å½“äºJDBCä¸­çš„`?`ï¼Œä¼šè¿›è¡Œé¢„ç¼–è¯‘ï¼Œæ˜¯**å®‰å…¨**çš„ã€‚
*   `${}`ï¼šç›´æ¥è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢ï¼Œç›¸å½“äºæ‹¼æ¥ï¼Œæ˜¯**å±é™©**çš„ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_125.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_127.png)

åœ¨`ORDER BY`ã€`LIKE`å’Œ`IN`ç­‰å­å¥ä¸­ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨`#{}`ï¼ŒMyBatisä¼šæŠ¥é”™ï¼ˆå› ä¸ºé¢„ç¼–è¯‘åå‚æ•°ä¼šè¢«å¼•å·åŒ…å›´ï¼Œå¦‚`ORDER BY â€˜idâ€™`ï¼‰ã€‚å› æ­¤ï¼Œéƒ¨åˆ†å¼€å‘è€…ä¼šå›¾æ–¹ä¾¿ä½¿ç”¨`${}`ï¼Œä»è€Œå¯¼è‡´æ³¨å…¥ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_129.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_131.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_133.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_135.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_137.png)

**æ¼æ´ä»£ç ç¤ºä¾‹ï¼ˆMyBatis XMLæ˜ å°„æ–‡ä»¶ï¼‰ï¼š**
```xml
<select id="findUser" parameterType="String" resultType="User">
  SELECT * FROM users ORDER BY ${orderBy}
</select>
```
å¦‚æœ`orderBy`å‚æ•°ç”¨æˆ·å¯æ§ï¼Œä¼ å…¥`id; DROP TABLE users--`å°±ä¼šå¯¼è‡´æ³¨å…¥ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_139.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_141.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_142.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_144.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_146.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_148.png)

**å®‰å…¨å†™æ³•**ï¼š
1.  åœ¨ä¸šåŠ¡å±‚å¯¹ä¼ å…¥`${}`çš„å‚æ•°è¿›è¡Œä¸¥æ ¼çš„è¿‡æ»¤æˆ–ç™½åå•æ ¡éªŒã€‚
2.  å°½é‡é¿å…åœ¨`ORDER BY`ç­‰å­å¥ä¸­ä½¿ç”¨ç”¨æˆ·åŠ¨æ€ä¼ å…¥çš„åˆ—åã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_150.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_152.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_154.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_156.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_158.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_160.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_162.png)

### ç™½ç›’å®¡è®¡æ¡ˆä¾‹

![](img/e5942ddd3dada5b6ba875c20377dfc49_164.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_166.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_168.png)

åœ¨ä¸€ä¸ªåŸºäºSpring+MyBatisçš„ç½‘æ ¡ç³»ç»Ÿæºç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æœç´¢`${`å…³é”®å­—ï¼Œå‘ç°ä¸€å¤„åˆ é™¤æ–‡ç« çš„åŠŸèƒ½å­˜åœ¨æ³¨å…¥ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_170.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_172.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_174.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_176.png)

1.  åœ¨XMLæ˜ å°„æ–‡ä»¶ä¸­æ‰¾åˆ°è¯­å¥ï¼š`DELETE FROM article WHERE id IN (${ids})`ã€‚
2.  è¿½è¸ªè°ƒç”¨è¯¥è¯­å¥çš„Javaä»£ç ï¼Œå®šä½åˆ°åå°çš„`ArticleController`ä¸­çš„`delete`æ–¹æ³•ã€‚
3.  è¯¥æ–¹æ³•æ¥æ”¶`ids`å‚æ•°å¹¶ç›´æ¥ä¼ é€’ç»™MyBatisæ‰§è¡Œã€‚
4.  æ„é€ è¯·æ±‚`/admin/article/delete?ids=1) OR (1=1`ï¼Œä½¿ç”¨Sqlmapç­‰å·¥å…·å¯æˆåŠŸæ£€æµ‹å‡ºæ³¨å…¥ç‚¹ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_178.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_180.png)

**å®¡è®¡æŠ€å·§**ï¼šåœ¨Javaä»£ç å®¡è®¡ä¸­ï¼Œé’ˆå¯¹SQLæ³¨å…¥ï¼Œå¯ä»¥ä¼˜å…ˆå…¨å±€æœç´¢`${`ã€`ORDER BY`ã€`LIKE`ç­‰å…³é”®è¯ï¼Œå¿«é€Ÿå®šä½æ½œåœ¨é£é™©ç‚¹ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_182.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_184.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_185.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_187.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_189.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_191.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_193.png)

## XXEï¼ˆXMLå¤–éƒ¨å®ä½“æ³¨å…¥ï¼‰ğŸ—‚ï¸

![](img/e5942ddd3dada5b6ba875c20377dfc49_195.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_197.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_199.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_201.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_203.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_205.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_207.png)

SQLæ³¨å…¥ä¸»è¦å‘ç”Ÿåœ¨æ•°æ®åº“äº¤äº’å±‚ï¼Œè€ŒXXEåˆ™å‘ç”Ÿåœ¨XMLè§£æç¯èŠ‚ã€‚Javaä¸­æä¾›äº†å¤šç§XMLè§£æå™¨ï¼Œå¦‚æœé…ç½®ä¸å½“ï¼Œåœ¨è§£æç”¨æˆ·å¯æ§çš„XMLæ•°æ®æ—¶ï¼Œå°±ä¼šå¯¼è‡´XXEæ¼æ´ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_209.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_211.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_213.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_215.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_217.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_219.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_221.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_223.png)

Javaä¸­å¸¸è§çš„å±é™©è§£æç±»/æ–¹æ³•åŒ…æ‹¬ï¼š
*   `XMLReader`
*   `SAXReader`
*   `SAXBuilder`
*   `DocumentBuilder`
*   `XMLStreamReader`

![](img/e5942ddd3dada5b6ba875c20377dfc49_225.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_227.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_229.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_231.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_233.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_234.png)

**æ¼æ´ä»£ç ç¤ºä¾‹ï¼š**
```java
String xmlContent = request.getParameter("content");
SAXReader reader = new SAXReader();
Document document = reader.read(new StringReader(xmlContent));
// ... å¤„ç†document
```
å¦‚æœç”¨æˆ·ä¼ å…¥çš„`content`å‚æ•°åŒ…å«æ¶æ„çš„å¤–éƒ¨å®ä½“å£°æ˜ï¼Œå¦‚ï¼š
```xml
<?xml version="1.0"?>
<!DOCTYPE test [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>&xxe;</root>
```
è§£æå™¨å°±ä¼šè¯»å–æœåŠ¡å™¨ä¸Šçš„`/etc/passwd`æ–‡ä»¶å†…å®¹ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_236.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_238.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_240.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_242.png)

**å®‰å…¨å†™æ³•**ï¼šç¦ç”¨å¤–éƒ¨å®ä½“è§£æã€‚
```java
SAXReader reader = new SAXReader();
reader.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
reader.setFeature("http://xml.org/sax/features/external-general-entities", false);
reader.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
```

![](img/e5942ddd3dada5b6ba875c20377dfc49_244.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_246.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_248.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_250.png)

**é»‘ç›’æµ‹è¯•**ï¼šä¸è¯­è¨€æ— å…³ï¼Œåªè¦å‘ç°è¯·æ±‚æ•°æ®åŒ…ä¸­åŒ…å«XMLæ ¼å¼æ•°æ®ï¼ˆå¦‚`Content-Type: application/xml`ï¼‰ï¼Œå°±å¯ä»¥å°è¯•æ›¿æ¢ä¸ºåŒ…å«æ¶æ„å¤–éƒ¨å®ä½“çš„Payloadï¼Œè§‚å¯Ÿå“åº”ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿæ–‡ä»¶å†…å®¹æˆ–æ˜¯å¦æœ‰å¯¹å¤–éƒ¨ç½‘ç»œçš„è¯·æ±‚ï¼ˆå¦‚ç›‘å¬ç«¯å£æ”¶åˆ°è¯·æ±‚ï¼‰ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_252.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_254.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_256.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_258.png)

## SSTIï¼ˆæœåŠ¡å™¨ç«¯æ¨¡æ¿æ³¨å…¥ï¼‰ğŸ“„

![](img/e5942ddd3dada5b6ba875c20377dfc49_260.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_262.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_264.png)

XXEå¤„ç†çš„æ˜¯ç»“æ„åŒ–æ•°æ®ï¼Œè€ŒSSTIæ¶‰åŠçš„æ˜¯è§†å›¾æ¸²æŸ“ã€‚SSTIå‘ç”Ÿåœ¨ä½¿ç”¨æ¨¡æ¿å¼•æ“æ¸²æŸ“ç”¨æˆ·è¾“å…¥æ—¶ã€‚å½“ç”¨æˆ·è¾“å…¥è¢«ç›´æ¥æ‹¼æ¥è¿›æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”è¯¥æ¨¡æ¿è¢«è§£ææ‰§è¡Œæ—¶ï¼Œå°±ä¼šå¯¼è‡´ä»£ç æ‰§è¡Œã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_266.png)

Javaä¸­å¸¸è§çš„æ¨¡æ¿å¼•æ“æœ‰Thymeleafã€FreeMarkerã€Velocityç­‰ã€‚Spring Booté»˜è®¤æ”¯æŒThymeleafã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_268.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_270.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_272.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_274.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_276.png)

**æ¼æ´ä»£ç ç¤ºä¾‹ï¼ˆThymeleafï¼‰ï¼š**
å‡è®¾ä¸€ä¸ªæ§åˆ¶å™¨æ¥æ”¶`language`å‚æ•°æ¥æ¸²æŸ“ä¸åŒè¯­è¨€é¡µé¢ï¼š
```java
@GetMapping("/greet")
public String greet(@RequestParam String lang, Model model) {
    model.addAttribute("message", "Hello");
    return "greet_" + lang; // ç”¨æˆ·å¯æ§éƒ¨åˆ†æ‹¼æ¥è¿›è§†å›¾å
}
```
å¦‚æœç”¨æˆ·ä¼ å…¥`lang`å‚æ•°ä¸º`__${T(java.lang.Runtime).getRuntime().exec("calc")}__::.x`ï¼Œåœ¨æŸäº›ç‰¹å®šç‰ˆæœ¬å’Œé…ç½®ä¸‹ï¼ŒThymeleafå¯èƒ½ä¼šå°†å…¶è§£ææ‰§è¡Œï¼Œå¼¹å‡ºè®¡ç®—å™¨ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_278.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_280.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_282.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_284.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_286.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_288.png)

**æ¼æ´æˆå› **ï¼šè§†å›¾åç§°ï¼ˆ`return`çš„å­—ç¬¦ä¸²ï¼‰æˆ–æ¨¡æ¿å†…å®¹æœ¬èº«ç›´æ¥åŒ…å«äº†æœªç»éªŒè¯çš„ç”¨æˆ·è¾“å…¥ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_290.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_292.png)

**å®‰å…¨å†™æ³•**ï¼š
1.  å¯¹åŠ¨æ€çš„æ¨¡æ¿åç§°æˆ–å†…å®¹ç‰‡æ®µè¿›è¡Œä¸¥æ ¼çš„ç™½åå•æ§åˆ¶ã€‚
2.  é¿å…ç›´æ¥å°†ç”¨æˆ·è¾“å…¥ä¼ é€’ç»™æ¨¡æ¿å¼•æ“çš„è§£æå‡½æ•°ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_294.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_296.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_298.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_300.png)

**æµ‹è¯•ä¸å®¡è®¡**ï¼š
*   **é»‘ç›’**ï¼šåœ¨æ‰€æœ‰å¯èƒ½å½±å“é¡µé¢æ¸²æŸ“çš„å‚æ•°ä¸­ï¼ˆå¦‚`lang`ã€`template`ã€`name`ç­‰ï¼‰ï¼Œå°è¯•æ’å…¥æ¨¡æ¿å¼•æ“çš„è¡¨è¾¾å¼è¯­å¥ï¼Œå¦‚`{{7*7}}`ã€`${7*7}`ã€`#{7*7}`ç­‰ï¼Œè§‚å¯Ÿå“åº”ä¸­æ˜¯å¦è¢«è¿ç®—æˆ`49`ã€‚
*   **ç™½ç›’**ï¼šå®¡è®¡ä»£ç ï¼ŒæŸ¥æ‰¾`return`è¯­å¥ä¸­å­—ç¬¦ä¸²æ‹¼æ¥ã€æˆ–è€…`model.addAttribute`å°†ç”¨æˆ·è¾“å…¥è®¾ç½®ä¸ºæ¨¡æ¿å˜é‡ç­‰æ¨¡å¼ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_302.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_304.png)

## SPELï¼ˆSpringè¡¨è¾¾å¼è¯­è¨€ï¼‰æ³¨å…¥âš¡

![](img/e5942ddd3dada5b6ba875c20377dfc49_306.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_308.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_310.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_312.png)

SSTIæ˜¯æ¨¡æ¿å¼•æ“çš„é—®é¢˜ï¼Œè€ŒSPELæ³¨å…¥æ˜¯Springæ¡†æ¶ç‰¹æœ‰çš„è¡¨è¾¾å¼æ³¨å…¥æ¼æ´ã€‚SPELæ˜¯ä¸€ç§å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ã€‚å¦‚æœåœ¨è§£æç”¨æˆ·å¯æ§çš„SPELè¡¨è¾¾å¼æ—¶æœªåšé˜²æŠ¤ï¼Œå°±ä¼šé€ æˆä¸¥é‡çš„å®‰å…¨é—®é¢˜ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_314.png)

**æ¼æ´ä»£ç ç¤ºä¾‹ï¼š**
```java
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;

![](img/e5942ddd3dada5b6ba875c20377dfc49_316.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_318.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_320.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_322.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_324.png)

@GetMapping("/eval")
public String eval(@RequestParam String expr) {
    ExpressionParser parser = new SpelExpressionParser();
    Expression exp = parser.parseExpression(expr); // ç”¨æˆ·è¾“å…¥ç›´æ¥è¢«è§£æ
    return exp.getValue().toString();
}
```
ç”¨æˆ·è®¿é—®`/eval?expr=T(java.lang.Runtime).getRuntime().exec('calc')`å³å¯æ‰§è¡Œå‘½ä»¤ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_326.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_328.png)

**å®‰å…¨å†™æ³•**ï¼š
1.  **æ ¹æœ¬é¿å…**ï¼šä¸è¦è§£æç”¨æˆ·å¯æ§çš„å­—ç¬¦ä¸²ä½œä¸ºSPELè¡¨è¾¾å¼ã€‚
2.  **æ²™ç®±é™åˆ¶**ï¼šå¦‚æœä¸šåŠ¡å¿…é¡»ï¼Œåº”ä½¿ç”¨`StandardEvaluationContext`çš„`setRootObject`ç­‰é™åˆ¶è§£æä¸Šä¸‹æ–‡ï¼Œæˆ–ä½¿ç”¨æ›´å®‰å…¨çš„`SimpleEvaluationContext`ã€‚

**é»‘åå•ç»•è¿‡æŠ€å·§**ï¼š
å¦‚æœä»£ç ä¸­ä½¿ç”¨äº†é»‘åå•è¿‡æ»¤å…³é”®å­—ï¼ˆå¦‚`Runtime`ã€`exec`ï¼‰ï¼Œå¯ä»¥åˆ©ç”¨Javaçš„åå°„æœºåˆ¶è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥æ¥ç»•è¿‡ã€‚
ä¾‹å¦‚ï¼ŒåŸPayloadä¸ºï¼š`T(java.lang.Runtime).getRuntime().exec("calc")`
åå°„ç»•è¿‡Payloadå¯èƒ½å½¢å¦‚ï¼š
```
T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("ex"+"ec", T(String[])).invoke(T(String).getClass().forName("java.l"+"ang.Ru"+"ntime").getMethod("getRu"+"ntime").invoke(null), new String[]{"calc"})
```
è¿™åˆ©ç”¨äº†åå°„åŠ¨æ€è·å–ç±»å’Œæ–¹æ³•ï¼Œå°†æ•æ„Ÿå…³é”®å­—æ‹†æ•£ï¼Œä»è€Œç»•è¿‡ç®€å•çš„å­—ç¬¦ä¸²åŒ¹é…è¿‡æ»¤ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_330.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_332.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_334.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_336.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_338.png)

## æ€»ç»“ ğŸ¯

![](img/e5942ddd3dada5b6ba875c20377dfc49_340.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_342.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_344.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_346.png)

æœ¬èŠ‚è¯¾æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†Javaå®‰å…¨ä¸­å››ä¸ªé‡è¦çš„æ¼æ´ç±»å‹ï¼š

![](img/e5942ddd3dada5b6ba875c20377dfc49_348.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_350.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_352.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_354.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_356.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_358.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_360.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_362.png)

1.  **SQLæ³¨å…¥**ï¼šé‡ç‚¹å…³æ³¨JDBCä¸­**å­—ç¬¦ä¸²æ‹¼æ¥**ä¸**é¢„ç¼–è¯‘å ä½ç¬¦`?`**çš„åŒºåˆ«ï¼Œä»¥åŠMyBatisä¸­**`${}`**ä¸**`#{}`**çš„åŒºåˆ«ã€‚å®¡è®¡æ—¶æœç´¢`${`ã€`ORDER BY`ç­‰å…³é”®å­—ã€‚
2.  **XXE**ï¼šç”±ä¸å®‰å…¨çš„XMLè§£æå™¨é…ç½®å¼•èµ·ã€‚å®¡è®¡æ—¶æœç´¢`XMLReader`ã€`DocumentBuilder`ç­‰è§£æç±»ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦ç¦ç”¨äº†å¤–éƒ¨å®ä½“ï¼ˆ`setFeature`ï¼‰ã€‚
3.  **SSTI**ï¼šå‘ç”Ÿåœ¨æ¨¡æ¿å¼•æ“æ¸²æŸ“ç”¨æˆ·å¯æ§çš„æ¨¡æ¿åç§°æˆ–å†…å®¹æ—¶ã€‚æµ‹è¯•æ—¶å°è¯•æ’å…¥æ¨¡æ¿è¡¨è¾¾å¼`{{}}`ã€`${}`ç­‰ã€‚
4.  **SPELæ³¨å…¥**ï¼šSpringç‰¹æœ‰çš„è¡¨è¾¾å¼æ³¨å…¥ã€‚é¿å…ç›´æ¥è§£æç”¨æˆ·è¾“å…¥ä¸ºSPELè¡¨è¾¾å¼ï¼Œè­¦æƒ•`SpelExpressionParser`çš„ä½¿ç”¨ã€‚

![](img/e5942ddd3dada5b6ba875c20377dfc49_364.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_366.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_368.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_369.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_371.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_373.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_374.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_376.png)

![](img/e5942ddd3dada5b6ba875c20377dfc49_378.png)

Javaå®‰å…¨æ¼æ´çš„æŒ–æ˜ï¼Œç™½ç›’å®¡è®¡ä¾èµ–äºå¯¹ä»£ç ä¸­ç‰¹å®šå±é™©æ¨¡å¼ï¼ˆå¦‚å­—ç¬¦ä¸²æ‹¼æ¥ã€ç‰¹å®šè§£æå‡½æ•°ï¼‰çš„è¯†åˆ«ï¼›é»‘ç›’æµ‹è¯•åˆ™ä¸è¯­è¨€å…³ç³»ä¸å¤§ï¼Œæ›´å¤šä¾èµ–äºå¯¹æ¼æ´åŸç†å’Œå¸¸è§Payloadçš„æŒæ¡ã€‚ç†è§£è¿™äº›æ¼æ´åœ¨Javaä¸­çš„ç‹¬ç‰¹è¡¨ç°ï¼Œæ˜¯æˆä¸ºä¸€ååˆæ ¼çš„Javaå®‰å…¨ç ”ç©¶å‘˜çš„å…³é”®ä¸€æ­¥ã€‚