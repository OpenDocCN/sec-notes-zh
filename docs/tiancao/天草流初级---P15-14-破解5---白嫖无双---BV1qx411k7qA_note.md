![](img/ff6fa30eeb687a68709c1d5fa987cb84_1.png)

# 天草流初级破解教程 - P15：第14课 - 破解重启验证与界面修改 🛠️

在本节课中，我们将学习如何破解一个采用重启验证机制的程序，并修改其用户界面。课程将涵盖脱壳、定位关键验证代码、修改程序逻辑以及通过资源编辑修改界面元素。

---

## 课程概述

本节课的目标是分析并破解一个名为“Asparag”的程序。该程序使用重启验证，并具有试用次数限制。我们将从脱壳开始，逐步分析其验证逻辑，并最终实现两种破解方法，同时学习如何修改程序的界面显示。

---

## 第一步：程序分析与脱壳

上一节我们介绍了课程目标，本节中我们来看看如何对目标程序进行初步分析和脱壳。

首先，使用查壳工具确认程序由 **B4++** 加壳。程序采用重启验证机制，当前状态已显示为“过期”。

我们使用 **ESP定律** 进行脱壳。在OD中运行程序后，在栈窗口跟随ESP指针，下硬件访问断点。程序中断后，单步跟踪找到程序的原始入口点（OEP）。

以下是脱壳的关键步骤：
1.  找到OEP地址：`0x1438`。
2.  使用LordPE的“修正镜像大小”功能。
3.  使用Import REC修复输入表。
    *   填入OEP：`1438`
    *   获取的IAT信息为：`RVA: 0x311430, Size: 0x1413`
4.  点击“获取输入表” -> “显示无效函数” -> “追踪层级1”进行修复。
5.  转储并修复进程，生成可运行的脱壳文件。

脱壳完成后，程序可以正常运行，但验证逻辑仍需破解。

---

## 第二步：分析重启验证机制

脱壳完成后，我们开始分析程序的重启验证逻辑。重启验证意味着程序会将验证信息（如试用次数）写入系统的某个持久化位置（如注册表或文件），下次启动时读取。

以下是判断验证类型的几种方法：
*   **注册表验证**：对 `RegOpenKeyExA/W`、`RegQueryValueExA/W` 等API下断点，查找程序读取的键值。
*   **文件验证**：对 `CreateFileA/W`、`ReadFile` 等API下断点，查找程序读取的文件（DLL除外）。
*   **DLL验证**：程序可能通过调用特定DLL的函数来读写验证信息。

在本例中，通过分析，我们确定程序结合了 **注册表** 和 **DLL** 来存储试用次数。

我们在OD中对 `RegQueryValueExA` 下断点。运行程序后，程序在读取注册表时中断。在堆栈窗口可以看到程序正在读取一个特定的注册表键值，其数据是经过加密的试用次数信息。

跟踪代码，我们发现一个关键的比较跳转指令（如 `jnz` 或 `je`），它决定了是否显示“未注册”或“过期”提示。这个跳转通常位于验证函数之后。

---

## 第三步：实施破解（方法一：修改关键跳转）

找到关键跳转后，我们可以实施第一种破解方法——直接修改程序逻辑。

在验证代码之后，通常会有一个条件跳转来决定程序流程。例如：
```assembly
cmp eax, ebx      ; 比较两个值（如当前次数与总次数）
jnz short label_unregistered ; 如果不相等，跳转到未注册流程
```
我们的目标是将这个跳转改为无条件跳转（`jmp`）或无操作（`nop`），使其跳过验证失败的分支。

操作步骤如下：
1.  在OD中找到上述关键跳转指令。
2.  右键该指令，选择“汇编”。
3.  将 `jnz` 修改为 `jmp`，使其无论如何都跳转到注册成功的流程。
4.  将修改保存到可执行文件。

修改后运行程序，发现不再提示注册或过期，破解成功。这是一种典型的“爆破”思路。

---

## 第四步：实施破解（方法二：修改注册表数据）

除了修改程序，我们还可以尝试修改其验证数据源。既然程序从注册表读取加密的试用次数，我们可以尝试修改这个值。

操作步骤如下：
1.  使用注册表编辑器（如 `regedit`）找到程序写入的键值路径（通过之前的断点分析获得）。
2.  尝试将该键值的数值改大（例如，改为一个很大的十进制数或特定的十六进制数据）。
3.  保存注册表并重启程序。

在某些情况下，直接修改注册表值可能导致程序解密出错而报错。此时，可以结合第一种方法，在程序读取注册表后、进行解密判断前，修改内存中的解密结果，使其始终为一个有效值（如 `999`）。

这种方法需要更深入的跟踪，以找到存储解密后次数的内存地址，然后通过OD修改该内存值。

---

## 第五步：修改程序界面与资源

破解验证逻辑后，我们还可以让程序界面更美观，例如修改“未注册”字样、禁用注册输入框等。

我们使用资源编辑工具（如 **Resource Hacker**）来修改程序资源。

以下是需要修改的部分及方法：
*   **修改对话框标题或字符串**：在“String Table”或“Dialog”中找到相关资源，将“Unregistered”等字样改为自定义信息（如你的名字）。
*   **禁用按钮和输入框**：在“Dialog”中编辑主窗口对话框。找到“注册”按钮和用于输入注册码的编辑框，将其属性中的 `Enabled` 状态由 `True` 改为 `False`。这会使它们在界面上显示为灰色不可用状态。

修改完成后保存资源，程序界面即会更新。这通过直接修改资源文件实现，无需修改程序代码。

---

## 知识扩展：代码实现界面控制

为了帮助理解资源修改的原理，我们简单看一下在编程中如何通过代码实现类似功能。例如在易语言或Delphi中：

```pascal
// 在窗口创建事件中，禁用编辑框和按钮
procedure TForm1.FormCreate(Sender: TObject);
begin
  Edit1.Enabled := False; // 禁用编辑框1
  Button1.Enabled := False; // 禁用按钮1
end;
```
这段代码的含义是：在窗体创建时，将组件 `Edit1` 和 `Button1` 的 `Enabled` 属性设置为 `False`（假），从而使它们不可用。我们在资源文件中修改的正是这些属性的初始值。

---

## 课程总结

本节课中我们一起学习了针对重启验证程序的完整破解流程：
1.  **脱壳**：使用ESP定律对B4++加壳程序进行脱壳。
2.  **分析**：通过API断点法分析出程序采用注册表+DLL的重启验证机制，并定位到关键验证跳转。
3.  **破解**：
    *   **方法一（爆破）**：直接修改验证函数后的关键跳转指令（`jnz` -> `jmp`），绕过验证。
    *   **方法二（改数据）**：尝试修改注册表中的验证数据，或修改内存中的解密结果。
4.  **美化**：使用Resource Hacker修改程序资源，更新字符串并禁用不必要的输入控件。

![](img/ff6fa30eeb687a68709c1d5fa987cb84_3.png)

破解的思路是多样的，核心在于理解程序的验证逻辑和数据流。多跟踪、多尝试，往往能发现不止一种解决方法。请在实践中巩固这些知识。