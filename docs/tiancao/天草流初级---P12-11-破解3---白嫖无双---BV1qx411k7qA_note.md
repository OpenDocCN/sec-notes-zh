# 天草流初级破解教程 - P12：第11课 - 破解“同意/不同意”对话框 🛡️

在本节课中，我们将学习如何分析和破解一个带有“同意”与“不同意”选项的注册对话框。我们将通过动态调试，理解程序如何根据用户选择决定后续流程，并学习如何修改程序逻辑以达到“白嫖”使用的目的。

---

## 一、目标程序与初步分析

本次的目标程序是一个屏幕录像软件的注册机。运行后，它会弹出一个对话框，要求用户选择“同意”或“不同意”。点击“同意”可以进入主界面，点击“不同意”则程序会直接退出。

我们的目标是绕过这个选择，让程序无论点击哪个按钮都能直接进入主界面。

首先，使用OllyDbg（OD）载入目标程序。

> 上一节我们介绍了使用OD进行基础调试，本节中我们来看看如何处理这种基于用户交互的验证。

---

## 二、定位关键判断代码

程序运行后，在OD中按F9让程序运行起来，然后尝试点击对话框上的按钮。为了找到处理这个选择的代码，我们需要在OD中设置断点。

1.  在OD中按F12暂停程序。
2.  查看调用堆栈（Call Stack），寻找可能负责创建或处理对话框的函数调用。
3.  经过跟踪，我们定位到一个关键的内存地址：`004083F0`。这个地址存储的值将决定程序的走向。
4.  进一步跟踪，发现程序在地址 `00405215` 附近调用了产生提示音的函数。为了方便调试，我们可以先将其NOP掉（填充为`90`）以消除噪音。

以下是定位到的关键代码区域：

```assembly
004083F0 处进行赋值操作
00405215 处调用声音函数
```

---

## 三、分析程序执行流程

我们通过单步执行（F7/F8）来观察当点击不同按钮时，程序状态的变化。

1.  **点击“同意”时**：
    *   程序在 `004083F0` 处将值设置为 **1**。
    *   随后，在条件跳转指令处（例如 `test eax, eax` / `jz`），因为EAX寄存器值为1（非零），所以**不跳转**。
    *   程序继续执行，顺利弹出注册机的主界面。

2.  **点击“不同意”时**：
    *   程序在 `004083F0` 处将值设置为 **0**。
    *   在相同的条件跳转处，因为EAX为0，所以**发生跳转**。
    *   程序跳转到一个退出函数（如 `ExitProcess`），导致直接关闭。

核心逻辑可以用以下伪代码表示：

```c
int user_choice = ShowDialog("同意", "不同意"); // 对话框函数，同意返回1，不同意返回0
if (user_choice == 0) {
    ExitProcess(); // 退出程序
} else {
    ShowMainWindow(); // 显示主界面
}
```

> 通过以上分析，我们明白了程序的基本逻辑。接下来，我们将尝试修改这个逻辑。

---

## 四、实施破解方案

根据上面的分析，我们有几种思路可以绕过这个对话框：

**方案一：强制跳转永不发生**
*   **原理**：修改决定是否跳转的指令，使其无论条件如何都继续执行。
*   **操作**：找到关键的 `jz` 或 `je`（条件跳转）指令，将其改为 `jmp`（无条件跳转）或直接NOP掉。
*   **效果**：即使点击“不同意”，程序也不会执行退出流程，而是继续显示主界面。

**方案二：锁定返回值为1**
*   **原理**：修改对话框函数的返回值，让它始终返回1（“同意”）。
*   **操作**：在函数返回（`retn`）之前，找到给EAX赋值的指令（如 `mov eax, 1`），确保其始终被执行。或者，在函数调用后，直接使用OD的汇编功能将EAX改为1。
*   **效果**：无论点击哪个按钮，系统都认为用户点击了“同意”。

**方案三：绕过对话框调用**
*   **原理**：直接跳过整个对话框的显示和调用。
*   **操作**：找到调用对话框函数的 `call` 指令，将其NOP掉。但需要注意，这样可能会使程序期望的返回值（EAX）处于未定义状态，可能导致后续判断出错。因此，在NOP掉`call`之后，通常需要手动给EAX赋一个值（如1）。
*   **效果**：程序启动后不再弹出对话框，直接进行后续流程。

在本例实践中，作者采用了**方案二**，将关键地址的值固定为1，成功实现了无论点击哪个按钮都能进入程序的效果。

> 需要注意的是，某些程序会在多处对关键变量进行清零或重赋值。因此，修改一处可能不够稳定。最稳妥的方法通常是**方案一**，即修改关键跳转。

---

## 五、核心概念与编程原理

为什么点击“同意”返回1，点击“不同意”返回0？这不是巧合，而是图形界面编程中的一种常见约定。

在许多编程语言和框架中，标准对话框函数（如 `MessageBox`、`DialogBox`）的返回值就采用了这种约定：
*   **“是”/“确定”/“同意”** 通常对应返回值 **1** (如 `IDOK`, `IDYES`)。
*   **“否”/“取消”/“不同意”** 通常对应返回值 **0** 或 **2** (如 `IDNO`, `IDCANCEL`)。

例如，在Delphi或VC++中，都有类似的机制。程序通过判断这个返回值来决定后续分支。理解这个原理，有助于我们在逆向时快速定位到关键判断点。

---

## 六、总结与练习建议

![](img/2f9c8f10a0c827647b15ade4508a6861_1.png)

本节课中，我们一起学习了如何破解一个带有二元选择（同意/不同意）的对话框程序。

![](img/2f9c8f10a0c827647b15ade4508a6861_3.png)

我们主要掌握了以下步骤：
1.  **动态调试定位**：使用OD运行程序，通过堆栈和代码跟踪找到处理用户选择的关键代码区域。
2.  **流程分析**：通过对比点击不同按钮时的代码执行路径，理解程序的分支逻辑。
3.  **实施修改**：学习了三种常见的破解思路——修改关键跳转、固定函数返回值、绕过函数调用，并理解了各自的适用场景。
4.  **原理理解**：了解了对话框返回值在编程中的常见约定，这有助于举一反三。

**课后练习建议**：
请寻找一个带有类似“确定/取消”或“是/否”对话框的简单程序，使用本节课的方法进行实战练习。重点提升跟踪代码执行流和分析条件分支的能力。记住，耐心和细致的观察是逆向工程中最重要的品质。

![](img/2f9c8f10a0c827647b15ade4508a6861_5.png)

---
**谢谢观看！**