# 天草中级班 - P16：第16课 - 白嫖无双 🛡️

在本节课中，我们将要学习针对特定加壳程序（俗称“穿山甲”）的脱壳与修复技术。课程将演示两种不同的方法，并介绍一个实用工具的使用，以帮助初学者理解脱壳的基本流程和思路。

---

上一节我们介绍了穿山甲加壳程序的多样性。本节中我们来看看一个具体的、具有严格断点检测的案例。

这个案例非常特别。首先需要判断它是单线程还是双线程加壳。观察发现它只有一个线程，属于单线程。尝试用标准方法读取，发现程序无法正常读取。

它虽然显示为标准壳，但用标准方法直接拖拽分析时，程序无法继续执行。

![](img/0cb516b44526997bb44bf71d9f78982a_1.png)

![](img/0cb516b44526997bb44bf71d9f78982a_1.png)

![](img/0cb516b44526997bb44bf71d9f78982a_2.png)

![](img/0cb516b44526997bb44bf71d9f78982a_2.png)

接下来隐藏调试器OD，并下断点。可以看到，程序依然无法进行。这说明它对断点检测非常严格。

改用`HideOD`插件的`H1`选项来隐藏调试器。使用后，程序可以继续，证实了其严格的断点检测机制。

修改相关设置后，找到并撤销一个逃避技巧的调用。然后继续使用断点进行分析。这里需要手动查找输入表（IAT）。

![](img/0cb516b44526997bb44bf71d9f78982a_4.png)

发现只有340个函数，这对于一个大型软件来说是不符合常识的。继续向上查找，因为每个程序的起始部分通常包含注册函数。

![](img/0cb516b44526997bb44bf71d9f78982a_4.png)

记录下起始地址。使用上面的地址进行定位，并需要找到结尾。

按住键盘的向下箭头键查找，可以找到结尾位置。

现在计算大小：
```
Size = 结束地址 - 起始地址 = 148C
```
计算RVA（相对虚拟地址）：
```
RVA = 地址 - 0x400000 = 73A8
```
其中，`Size`是大小。

现在进行修复操作，结果显示有19个无效指针。

检查无效指针，发现大量指向`time`等库函数。继续查看下一个，情况类似。

无需理会，直接将这些无效指针减掉。

![](img/0cb516b44526997bb44bf71d9f78982a_6.png)

![](img/0cb516b44526997bb44bf71d9f78982a_6.png)

运行修复后的程序，确认可以正常运行。

![](img/0cb516b44526997bb44bf71d9f78982a_8.png)

![](img/0cb516b44526997bb44bf71d9f78982a_8.png)

![](img/0cb516b44526997bb44bf71d9f78982a_9.png)

![](img/0cb516b44526997bb44bf71d9f78982a_9.png)

---

![](img/0cb516b44526997bb44bf71d9f78982a_11.png)

上一节我们使用了手动查找和修复IAT的方法。本节中我们使用另一种方法，借助一个专用工具来完成。

首先重新开始。这次先不手动找OEP（原始入口点），而是使用脚本来自动寻找OEP以节省时间。

![](img/0cb516b44526997bb44bf71d9f78982a_13.png)

![](img/0cb516b44526997bb44bf71d9f78982a_13.png)

脚本成功找到OEP。现在打开脱壳工具。

![](img/0cb516b44526997bb44bf71d9f78982a_15.png)

![](img/0cb516b44526997bb44bf71d9f78982a_15.png)

工具中，`TN`是进程ID，此处显示为`7D0`。

![](img/0cb516b44526997bb44bf71d9f78982a_17.png)

![](img/0cb516b44526997bb44bf71d9f78982a_17.png)

![](img/0cb516b44526997bb44bf71d9f78982a_19.png)

接下来，在工具中打开进程的内存镜像。

![](img/0cb516b44526997bb44bf71d9f78982a_21.png)

![](img/0cb516b44526997bb44bf71d9f78982a_19.png)

![](img/0cb516b44526997bb44bf71d9f78982a_21.png)

![](img/0cb516b44526997bb44bf71d9f78982a_23.png)

找到第一个区段，地址是`00401000`，该区段长度是`58B123`。

![](img/0cb516b44526997bb44bf71d9f78982a_23.png)

![](img/0cb516b44526997bb44bf71d9f78982a_25.png)

现在需要修复输入表。原始输入表地址在`B3ADD8`。

![](img/0cb516b44526997bb44bf71d9f78982a_25.png)

![](img/0cb516b44526997bb44bf71d9f78982a_27.png)

查看该地址所属区段。

![](img/0cb516b44526997bb44bf71d9f78982a_27.png)

输入表位于这个区段。现在将其移动到另一个空闲区段。不能移动到第一个区段，选择另一个可用区段。

以下是移动IAT的步骤：
1.  原始位置：`BaseAddr`
2.  原始大小：`Size`
3.  新位置：`CC7`（目标区段地址）

点击执行，等待操作完成。我们来对比两种方法的结果。

![](img/0cb516b44526997bb44bf71d9f78982a_29.png)

![](img/0cb516b44526997bb44bf71d9f78982a_29.png)

![](img/0cb516b44526997bb44bf71d9f78982a_30.png)

![](img/0cb516b44526997bb44bf71d9f78982a_30.png)

![](img/0cb516b44526997bb44bf71d9f78982a_31.png)

![](img/0cb516b44526997bb44bf71d9f78982a_31.png)

操作完成，输入表地址已更改为`CC7`。

![](img/0cb516b44526997bb44bf71d9f78982a_33.png)

![](img/0cb516b44526997bb44bf71d9f78982a_33.png)

现在开始脱壳。在脱壳工具中选择`Dumper`，并将输出格式改为`EXE`。

![](img/0cb516b44526997bb44bf71d9f78982a_35.png)

![](img/0cb516b44526997bb44bf71d9f78982a_35.png)

![](img/0cb516b44526997bb44bf71d9f78982a_37.png)

![](img/0cb516b44526997bb44bf71d9f78982a_37.png)

同样需要进行修复。需要手动填写OEP的RVA和大小。此时IAT大小变为`8C7`，但总的大小不变。

![](img/0cb516b44526997bb44bf71d9f78982a_39.png)

![](img/0cb516b44526997bb44bf71d9f78982a_39.png)

进行修复。

![](img/0cb516b44526997bb44bf71d9f78982a_41.png)

![](img/0cb516b44526997bb44bf71d9f78982a_41.png)

![](img/0cb516b44526997bb44bf71d9f78982a_43.png)

修复后的程序也可以正常运行。

![](img/0cb516b44526997bb44bf71d9f78982a_43.png)

![](img/0cb516b44526997bb44bf71d9f78982a_45.png)

程序是试用版，需要网上注册购买，没有直接输入注册码的地方。

![](img/0cb516b44526997bb44bf71d9f78982a_45.png)

但可以对其进行破解。两个方法脱壳后的文件大小都是12.9MB，没有区别。

本节课的主要目的是介绍这个脱壳工具的使用。

---

![](img/0cb516b44526997bb44bf71d9f78982a_47.png)

接下来尝试为脱壳后的文件“减肥”，即删除无用区段。

![](img/0cb516b44526997bb44bf71d9f78982a_49.png)

![](img/0cb516b44526997bb44bf71d9f78982a_47.png)

以下是可删除的区段列表：
*   删除某个无用区段。
*   删除另一个无用区段。
*   删除第三个无用区段。

![](img/0cb516b44526997bb44bf71d9f78982a_51.png)

**注意**：包含输入表（IAT）的区段不能删除，因为之前已将IAT移动到此区段。

![](img/0cb516b44526997bb44bf71d9f78982a_52.png)

![](img/0cb516b44526997bb44bf71d9f78982a_51.png)

![](img/0cb516b44526997bb44bf71d9f78982a_54.png)

![](img/0cb516b44526997bb44bf71d9f78982a_52.png)

删除部分区段后，程序仍可运行。

![](img/0cb516b44526997bb44bf71d9f78982a_56.png)

![](img/0cb516b44526997bb44bf71d9f78982a_54.png)

此时文件大小减小到9.07MB。

![](img/0cb516b44526997bb44bf71d9f78982a_58.png)

![](img/0cb516b44526997bb44bf71d9f78982a_56.png)

尝试继续删除`data`段。

![](img/0cb516b44526997bb44bf71d9f78982a_58.png)

删除`data`段后程序无法运行。因此，包含IAT的`.idata`段不能删除。文件最多只能减肥到9.07MB，尝试减到8.17MB会导致运行失败。

关于该试用版软件的破解，留给大家自行练习。在初级班课程中讲解的一些破解方法，例如`F4`暂停法、`F2`断点法等，都是非常实用且应用广泛的技术，在后续破解外挂等场景中都会用到，请大家务必掌握并多加练习。

本节课中我们一起学习了针对严格检测型穿山甲壳的两种脱壳方法，重点介绍了使用专用工具进行IAT转移和修复的流程，并演示了脱壳后的基本减肥操作。破解实践部分需要大家结合已有知识完成。

![](img/0cb516b44526997bb44bf71d9f78982a_60.png)

![](img/0cb516b44526997bb44bf71d9f78982a_60.png)