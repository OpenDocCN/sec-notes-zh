# P1：【录屏】探秘深藏不漏之马_撬开php加密后门-大咖远弈-漏洞银行大咖面对面第79期 - 漏洞银行BUGBANK - BV17t411m78f

![](img/3196fc4cf239c9d7d25c20a7faf508ee_0.png)

为知识而存，因技术而生，小伴晚上好，欢迎参加第79期漏洞银行安全技术直播大咖面对面，我是主持秋秋。今晚我们请到的是来自南天安全团队大咖袁艺袁艺。

他也曾担任过CTFAWD安全赛企业培训讲师爱好挖洞CMS审计流量分析电子取证等。今晚他将分享的议题叫探秘深藏不露芝麻，撬开PHP加密后门，内容记术性很强哦。希望观众伙伴们可以多多交流，一起互动。😊。



![](img/3196fc4cf239c9d7d25c20a7faf508ee_2.png)

那直播不只有听讲，大咖演讲结束之后，还会有问答和福利环节，大家可以登录直播间在聊天区讨论或发出提问。问答结束后，元艺大咖好选择迷信观众赠与书籍恶意代码分析实战。那期待你可以获得它哦。好啦。

那下面就请元艺大咖开始进行的分享吧。😊，大家好，我是远艺。呃，很高兴来到乐洞银行和大家分享PHP加密后门的技术。呃，今天呢我们主要探讨的问题就是各式各样的PHP加密后门。

以及我给大家呃准备了一个比较厉害的后门，我们一起去调试一下。好的，先做一个综述。呃，在做渗透或者做网站运维的时候，我们都可能会接触一些呃后门。后门呢主要是用来执行恶意代码啊。

比如说有一句话的小码EVAL啊，post，我们的一句话小码也有一些大码。呃，在这些码的基础上，我们还会对它做一些修改。比如说。把它做的更有隐蔽性。啊，比如说把它的加密做一个加密功能。那我们先看一下。

先看这个问题吧，如何识别一个。后面。我来举一个例子，咱们看一个简单的。呃，这里是一个呃这里是一个函数。然后括号在这里，我们从这儿开始。是我们的代码。执行了一个自定义的函数。

然在这个函数中经过了b64解码。呃，也经过了。GZ呃inflate这个函数呢是相当于是GZdecode。只是在一些老版本中没有GZ抵扣的PP5。4之前。呃，只能用GZ inflat。

不能用GZdecode，它是可以去解码呃GZIP的一个字符串。在经过解密后呃，在for循环中嗯，我们发现给他ask码，这里做了减一。最后呃return被执行。这样是一个简单的一个加密后门。

这个后门呢呃我们呃一般比较可以容易看见，因为我们这里看到很常见EVL执行函数。以及这么一串啊pa64被加密过的东西。也就是说，刚才我们问题是如何识别一个后门。呃，你会发现。

可能他有EVAL后面有EVAL去执行啊，它有一大堆这样的字符串。通过这些字符串啊，对这些字符串做一些处理。比如说最简单的阿斯克玛减一解贝斯欧4解GZ。呃，经过这样的处理之后，他再去执行。

他有很可能是一个后门。因为他想要隐藏自身，呃，主要还是对。就是它本身的代码做一些变化。我们看见给力一点的东西，有哪些厉害一点的后门。接后门呢是在呃我们的安全比赛，比如说AWD赛。呃。

还有一些网站运维时比较有用的。比如说这是一个可以反复写入的木马。第一行，set time limit0。呃，我们PHP是一个脚本语言，它在执行的时候是有一个周期的这一行这个函数可以把执行的周期变为无限。

也就是说不会自动退出。呃，不会超时。好，第二个函数，ignore user abroad这个函数是用来呃当你的用户浏览器终端断开时，PHP呃还能继续运行。呃，不像一般我们的HTP连接一断掉以后。

它就停止了。就是说在。断掉连接后还继续运行它的代码。好，这两个都保证它一个持续运行的。我们看on link file呃，fill这个是它。呃。

能获取我们这个文件本身的绝对路径on link是一个删除的函数，也就是说删除掉它自身。嗯，well一我们这well循环。well循环中呃，在不停的fill put content，就是说输出一个文件。

输出点webs点PP它的内容就是一个嘛。这个为什么要加点Y点PP呢？因为在linux中啊，我们文件名最开始加点的，代表它是一个隐藏文件。呃，我们后边。大家可能注意到这里。

如果MD5get NT等于一串值，它才能进行后边的操作。这是做一个什么用呢？它其实是一个保护机制。也就是说你必须提交NT等于，比如说等于123这个123的MD5值C010啊。

如果要是能撞对这个MD5值的话，你才可以对这个码进行操作。也就是说把后门种上去以后，嗯，相当于是需要一个密码，呃，才能让你使用。这样也是为了防止你的后门被别人使用。

这是一个可以反复啊在反复生成自己的一个反复生成自己的一个码。而且即使它被删除以后，它也不会断掉。因为它被PP的进程在不断执行，除非是停止掉PP的进程。嗯，Q加它的进程。好，我们再看这个呢。

这是一个混淆的，也就是说它也是。就是对代码本身做了一个掩掩护吧。我们看这样的变量名。呃，是一个下划线。后边呃。还有一些。呃，都是这样的一个变量名的一些处理。这样呃我们直接看是看不出来的。

就是看不懂它是什么意思的。我们需要调试，需要动态调试。呃，具体怎么调试呃，我在后边讲另一个例子的时候，呃，也可以带大家看一下。最终呢他调试的使用方法就是说你需要呃问号后边用get方式提交一个。

下划线变量等于asert。as thirdt是相当于EVL这样的一个执行，但是还是有略有不同的。然后两个下划线的变量呃，提交你要执行代码是PH in for。是用来回显你的PP信息的。

我们再看一点特殊一点的。呃，我们发现了一个规律啊。很多呃我们的加密码都会对它本身的代码做一个隐藏处理。呃，可能会被加密成base64的一个形式。呃，再经过一些积累压缩，各种各样的形式。我们看一个特殊的。

它也是一个base14呃，这个灵感呢来源于1个CTF题。还有什么特点呢？我们制造出来的马是这一句。PPEVLgeA，这是一个一句话木马很常见。但是他有什么特点呢？它经过脚本生成以后啊。

变成了这样的一串SL4。再观察一下这串有什么特点。您会发现呃，他仅用了。这些字符。ABCGTABCGT。就是你可以指定的一些字符。也就是说。呃，你可以指定只出现三四种字母。

比如说只出现ABC3种字母就可以呃把这个一句话小码去做一个加密。它有什么用呢？呃，它可以。就是比如说过狗啊啊比如说不会触触碰一些敏感的规则。因为你可以限制它的字母，这又是什么原理呢？呃。

这一串又怎么用呢？我们这一串是经过啊三次bL4加密，它只要减减b4decode3次以后，就可以被还原成PHPEVL getA这一行。需要3次。啊，三次的解BL4。好像又不太符合我们的常理。

它是利主要是利用了一个bto4解密的时候的一个忽略问题。呃，这个具体想了解的话是一道CTF题。完了我们再继续交流。好，我们看一下一开始的议题，还有一个普通后门和加密后门有什么区别？

普通后门就是我们的小马，普通小马或者普通大马。呃，我们的加密后门和它和普通的后门有什么区别呢？其实关键是要理解。加密是在加密了些什么？我认为加密了呃有3点。第一点是对后门本身的代码做了加密。

比如说这个样子。就对他本身的代码做了一个加密。啊，还有这个样子混淆。第二点呢是对后门的调用方式做了一个加密。比如说。调用这个后门需要提交呃。

下划线等于shirt下划线下划线等于PHP four这个算是一个掩护，但是掩护不够好还不够好。但也是对调用的方式做了一个隐隐蔽吧。第三就是对回传的结果做了一个加密。我们例子面没有呃。

什么是对回传结果做加密呢？比如说。呃，我们执行的恶意代码，我就我们利用后门去执行的恶意代码是用来获取flag的。获取到的flag，我不想被别的人看见，我就把这个结果加密掉。

也就是说加密后门可以加密三样东西，一个是它本身代码，一个是。呃，对调用方式做一个保密。一个是对调动的最后的回传结果做一个保密。好，明白这部分内容以后，我们总结一下它的优点。首先呢通过流量分析啊。

无法知悉传输内容。呃，为什么呢？我们来看一个例子。这个是我们今天重头戏的一个木马。这个加密后门这个加密后门，我们看一下它的调用方式。呃，这是bp的一个抓包。bp的一个抓包。通过我们的发包呃。

获取到了PHP in的信息。你会发现它完整的符合了我们的。三个加密，一个是对代码本身的加密，一会儿大家会看到。另外一个就是对使用方式的加密。你从左左边看不出来。

就我们请求中看不出来我们是怎么去操控这个木马的。就看不到我们的PHP in呃，这个代码藏到了哪里。呃，我可以先提前告诉大家呃，被藏到了refer里边。平时平付。呃。

其实except language呃是做了一个校验，也非常重要非常重要。而我们回传的结果是这一部分。呃，那前面这个又是什么呢？它是一个解密这部分的一个密密钥啊，这个这个词有时候是。呃。

在读蜜月的时候是读月月子。这个是一个非对称的，我们解密是用它加密的时候，并不是用这个密月。这个是一个比较厉害的后门，也就是我们今天要详细了解的。好，先说一下准备工作吧。我们想要调试一个后门。啊。

也是慢慢去调戏这个后门。需要做哪需要准备什么环境呢？首先你要有个外部服务，我这里用的是web server WAMP。呃。

就是W windowsow的意思HR touchM是 mycycl PPP三件套。然后buur suit这个大家都有b suit。Vs code。啊，加XDbugXDbug是用来调试PHP的一个插件。

Vs code是微软的这个编辑器，相当好用。呃，我一会儿会带家带大家呃使用这三种工具，我们去调试。呃，使用XDdog和VS code。的时候呃，之前啊需要一个配置。这个配置过程大家往上去找一下。

可能配置稍微有点麻烦。呃，大家耐心去配置一下。好，我们看看今天的样本。今天的木马的样本就是我们的重头戏出场了。看起来呃比较复杂，内容好多。但是比较显而易见，它是一个。这样一个加密后门。呃。

因为正常写在码，没有人这样写的。他这个隐藏其实很拙劣的，但是这个加密后门呢并不是以隐藏自身为目的。他是以让你调试不出来为目的，或者让你调试的心态崩掉。这些代码啊我们看不出来它本身的样子。

我们需要去做一个结混淆。接很小我们就要动态调试，也就是在VScode和XDbug结合起来使用。我这里就带大家实践操作一下。好，样本已经被我复制过来了，是0点PP。这个就是我们的样本。

我们启用v v code右键open with v code。呃，注意我是在文件夹里边把它打开的。为什么我不单独打开这个文件？因为我要在这个文件夹里面去建立一个调试的一个配置文件。怎么操作？

我现在带概看一下。呃，为什么需要建立这样一个配置文件呢？因为我们需要做一个动态的一个调试。也就是说中间我们可以下断点去。暂停这个PRP的执行过程。好，我们点开0点PP。好。呃，我们第一项是资源管理器。

这一项是调试，你点到调试，这显示没有配置。我们需要点一下这个。齿轮点了以后，再稍等几秒钟不要动，它会自动去生成一个文件夹。就是装置配置文件。这时候会自动弹出来，让你选择环境啊。

大家应该选PHP我们是调试PHP的。好，这就是一个配置文件了。我们这时候可以看到在这个文件夹下生成点VS code。好的，这时候我们就可以下断点了。我们。把断点下到。最后一行吧。想要在这里断下来。

执行这一时候断下来。啊，倒数第二行吧，方便调试一点。呃，我们点击开始调试，这时候他在监听呃，等着你PP程序的运行。我们需要怎么去触发它的运行呢？我们需要在浏览器里。好，我们执行啊访问0点PP。

反这后自动跳过来了，就它是被断下来的，怎么看出来是被断下来的？左边是一个变量窗口。在这里你可以看到呃S变量是什么？S变量是这个I变量是这个，就是说这边是变量窗口。

我们看这一步是对呃这变量做1个STR replace做一个替换。我们执行NF1F11执行。看这变量应该有值了。好的，这边呢有值了。呃，这个就是看起来像是一个完整的代码了。因为呃下一步U等于D。

我们鼠标移上去即可以看到这个D变量只是create function，是创建一个匿匿名函数创建完的函数呃，只付给U由U去调用。那这个D要创建什么函数呢？它里面有。呃。

就是说create function这个函数里面有两个参数，第一个是空，这个代表是创建匿名函数的参数，就不传参数。第二是J这代表就是你要创建这个匿名函数的代码，所以这部分就是函数的代码。

也就是说我们真正的这个木马的样本。优就是去执行它。好，就是说现我明白了，这里面才是我们要的东西。好，在这里右键复制值。可以停下停下运行了。在这里我们新建一个。就叫一点PP。粘进来。先把首尾的引号去掉。

cur保存啊，我们还需要做一下修改，因为这样不好看。这个代码都连成一行，我们用notote pad加加。一点皮食品。好，我们现在手工补一个问号PP头。再补一个结尾。至少我们用插件。

cool format啊，大家可以记住这个插件，用quick format。好，这一个快速的一个。格式化。底线的。啊，我们做一个小修饰吧呃，因为这里你看两个参数被分开了，不太好看。哦，一定要调整一下。

把自动换行关掉关掉。好的。这时候我们就看到了这个样本的全貌，保存一下。好，大家先观察一下这个结构，因为它比较复杂。呃，首先它定义了两个P啊，这两个就是我们的双蜜月。两个屁。然后它定义了个函数。

这个函数大家先不用管，因为到后边才用不上。底下呢就开始执行代码了。大家分好多个部分。比较长，我们稍等一下，挨个慢慢去看。这时候我们已经解了混淆啊，看到了它的真实代码。接下来每一个后门你想要去调用它。

总是要给它传入呃传入一些参数。呃，找就我们需要找到传入参数的方式，我们才能知道怎么去给他传我们的。呃，我需要的这个指令，比如说我们想要获得PHPfer信息，我们要怎么传入它呢？我们从代码里面去找。

在函数X函数定义之后。这里。R等于s这个系统变量。然RR是呃sed servered的HTP referfer，也就是说获取到我们请求头中refer字段。是RR。REFFRER。所以他叫R2。好。

RA这个变量是获取到了accept language。我们看一下。呃，如果要是拿b去随便抓一个包。你就可以修改它的这个refer和except language。这两个传入点。

也就是说从这两个参数我们传入了一些东西。呃，并且底下有个一判断R存在，并且RA存在。呃，才可以走接下来的步骤。所以说我们必须给它传入refer和accept language。好。

接下来部分我们是看电4。2，看U变量和Q变量的含义。好，我们看一下。接下来的代码。我们这里有一个新的优变量。呃，整个马里面的新变了很多，大家。可能需要用点心。这里是pressUL这个函数。

这个函数是对URL做处理的，对RR这个URL做处理。R是我们传进来的refer，它是1个URL。呃，做完处理后的结果给了U，我们看一下pressUL函数的效果。正常传入1个URL。

这是RR这refer的。R。传入这么一串，经过pri URLL变成了这个。它变成了一个数组，里边有4项，第一项是呃skime是HTP第二项host是3W11点com。

第三个是pass和路径是index点PP啊。好，大家关注一下curory这一项。Q位是我们传的参数是A等于1，我们传的BB等于22，还有CC等于33。我们传入。呃，也就是说。

这个URL这个URL经过URLpress这个函数变成了这样的一个数组。呃，后边又是一个函数pri STR。两个参数我们看一下，第一个参数是curate。第二参数Q。呃，Q电量之前没有出现过。

是一个空电量，它是用来装这个结果的。我们看一下对curry。进行了pris STR。转变后变就是STR转变后变成了这样的，只给了Q。也就是说把A等于一这样的一个字符串拆成了数组。数组AA的键值键呃。

一是值BB是键N2是值。好，我们继续往下看。接然又把Q做了一个处理reval。对这个这个数组做了一个reval的处理，也就是把。它变成这个样子，大家对比一下，AA11变成了01N122。

也就是说直接获取上一个数组的值，也是带大家复习一下PT。好。接下来呃我们刚复习了几个PP的小函数，可能只有你比较迷惑。呃，刚才是在做什么呢？这三个函数是在做了什么？其实是把我们传进来的这个refer。

呃，这个URL做了一个处理，把refer里边的我们传的参数就变成了一个数组。做这样一个处理。好，接下来说一个正则表达式。当时在赛场上我调试到这一步的时候，我心态直接就崩了。为什么呢？

因为是一个离线的环境，我没有办法查资料，就没有办法调这个正则表达式。现在咱们可以静下心来复习一下正则。我们看正则表达式是这么一串pledge marshall。是函数名，意思是说把。嗯，RA。

就把RA这个变量里面的所有东西去做一个匹配，匹配到的结果给M变量。N变量线是有空的RA是什么呢？是我们传入的except language。我们access the language传入了什么呢？呃。

传入的就是。那语言啊之类的，是这里。这一串奇怪的纸就是excess language。好，我们来仔细看一下。假如我们现在传入这么一串exces language。传入以后。它的结果呃经过匹配。

它的结果变成了这样的一个数组。这个数组里边有三项，每一项都是一个数组。嗯这个是第一项，它是一个数组。这个是第二项，它是一个数组，第三项还是一个数组。呃，我们来看一下正常一个正则匹配，它的结果应该是什么？

应该是把符合这个条件，符合正则表达式条件的。呃，值。单独去列到数组里，比如说这部分就是它的第一个结果，这是它第二个结果。第三个结果。那后边的两个数组又装的是什么呢？小A大AD234又是什么意思呢？

我们要分析一下这个表达式了，给大家复责复习一下。呃，这个事里边。第一项是括号，中括号杠W。先看中括号吧，中括号是这个。这个是表示字符极的意思。字符集呢呃我们中间是有一个原字符杠W杠W意思就是数字和字母。

那我们意意思是说。呃，只要遇见数字和字母就可以匹配，逗号呢不能匹配，123ABC都可以被匹配。遇见一个呃，单单有一个中括号，又没有加号，说明它只匹配第一个字符。外边的这个小括号是什么意思呢？

就这个原括号是什么意思？他的意思就是说匹配到的内容单独去放到结果里边，呃，单独去成立一个数组。也就是说本来我们的结果应该是这个数组。但就因为他这里有一个圆括号，有一个圆括号。

所以匹配到的内容就放到了这里，就又新加了一个数组去存放。我们看第一个匹配到的是小字母A这里。小字母A，因为它符合呃数字和字母的这个条件，而且又在括号里。所以我们现在匹配到了小A。那第二呃第二个第二项。

你们看一下杠W减和加很懵。刚才说了，这个是字符集的意思，杠W是数字字母，减号是什么意思呢？这个减号是其实是相当于是把减号加入字符集。也就是现在字符集扩大了，变成了数字字母，还有减号。

所有满足数字字母和减号的就可以被匹配，像逗号不可以，分号不可以呃，减号是可以的，加号不可以。好，那我们看后边的加号是什么意思呢？就是最后这个加号括号带的这个意思是说呃匹配多个呃。

我比如说刚才的例子是ABB杠C。A被第一项匹配了，因为它没有加号，所以只匹配匹配一项后边的BB。呃，被这里匹配，为什么呢？因为我们这儿有个加号，第二个B是匹配的，第三个B也是匹配的。第四个减号。

因为我们属于字符集中，所以也被匹配。好，这个C也被匹配。所以说这部分。呃，杠达的加号匹配到了这里。匹配到了这里。A是被第一个匹配的。这是A。啊，这个是匹配了这里。呃，灵魂画手哎。这里有一个分号。

这里有一个分号，Q等于0。2。我们就要看这一部分了。这部分。先观察这个结构吧，我们先把它拆解一下，简化一下，简化成这样的一个结构。括号问号冒号啊，然后中一堆，然后括号问号。少了一个逗号问号是吧？

这个逗号问号意思是说匹配一个逗号就找一个逗号。呃，问号的意思是说可以出现一次或者不出现，就不能出现两三次，就只可以出现一个逗号或者不出现逗号。那我们看这部分是什么意思。后边这个问号意思是括号中的内容。

呃，这个问号的意思是括号中的内容可以呃不出现或者出现一次。因为它在括号的外点，那我们看括号里边的问号又是什么意思呢？这是一个特殊格式，括号问号冒号的意思是说呃，刚才我们不是说了，遇见括号。

它就会单独去列到数组里，单独在数组里列出一项结果。这个意思就是说，虽然这里有括号，但是呢因为这里有问号和冒号，所以不要把括号中的结果单独列出来。这个大家需要学习一下政则表达了，就比较难。呃。

大家不要灰心，因为正的表达就非常难的，而且会学流忘的。我们看一下里边的叉叉那容的。是分号Q等于0点。呃，这个又比较熟了，我们看到这里总是有分号，Q等于0。2。假如说是分号Q等于0。2，这里又是一个括号。

我们刚才说了，遇到括号要做什么呢？要单独把它的结果列出来，列到了这里。这就是我们Q等于0点几的这个括号。那我们这个杠D又是什么呢？杠D是原字符，就杠W是数字字母，杠D是数字。就当地啊是纯数字。

意思就是匹配Q等于零点几，然后就把这个几单独拿出来，放到结果里。好的，正则匹配。呃，我们再来观察一下这个结果。传入ABB杠C。A被第一项匹配放到了这里。BB杠C都符合我们的杠W减这个字符集。

所以但是它又没有，但是它又没有括号，所以不被匹配，就不被单独列出来。后边分号Q等于0。2。分号在这里匹配，Q等于0点这里匹配。二是因为这里有一个括号，这里有一个括号，所以单独被列了出来。GR是这里的。

好，后边是一个道理了，后边APBB杠CK0。3，后面大A是这里这个大A。三是这个30。3个3。后边这个D就是这这个D4是Q0。4。刚才也说第一项呃，是满足这个整式，满足整式的结果会被存入第一项。

第二三项都是我因为我们的括号所以导致的啊，有这样的结果。好，正回表达讲的有点多了，咱们看一下后边的。内容。走到这里了。他要求呃有Q变量，并且有M变量。可能最后大家已经忘了Q和M是什么了。

所以我带大家带大家调试一下。我们呃直接动手尝试一下。呃，我们用动态调试。先来下先来下启动我们调试。第八个。好，我们在这里下一个断点。呃，我们先下断点，养成好习惯，先下断点。然后再启动调试。呃。

然后我们访问这个后门。啊，我们要访问一点PHP了，因为我们解过混淆。分不开呀，拦截。一点甜品。好们 send to repeater这 repeatpeer能调的。这里。😊，呃，可能字有点小。

不好意思啊，看到exccept language，我们要加一个referREFERER。I'll refer。呃，刚才说exccept language是给了RARA进来以后。呃，就是这个正则表达。

我们传一下刚才的那个东西。刚才我们写的是。呃ex language写的是。ABB杠C。根号Q等于0点，随便吧，0。0。4吧。逗号，然后大写的ABB。杠C分号Q等于0。0。我为什么写0。0。

等一下大家会明白。我再写一个。呃，写1个DEE杠F。根号Q等于0。1。好，我们把excect language传进来，也就是传到RA的值是这一个。refer是1个URL，我们随便写1个HTP杠杠。呃。

3W点。123点comM杠。呃，123可能后后面有点重，就HHH点CO。index点PP问号提交一个。呃，我们提交什么呢？提交。P1就是参数一等于。呃，一andP2参数2等于22and P3等于33。

好，我们提交这个。我们点一下go。这里断了下来。我们看一下RA是什么值。呃，大家能看到吗？RA在右边是AB杠C就我们传进来的这个accept。Language。再看一下RR是什么值。

是我们传进来的3W点HH点com这个值。好，这里要经过正则匹配了。M我们现在还是空的。我们来添加一个监视。M。M现在是空的，我们看一下走一步。匹配。😊，匹配到什么内容呢？啊，那这里没有显示，在这里。好。

我们看这里。我们传进的ABB杠C，也就是第一项是完整的一个匹配。好，然后他的第一个小A被放到了这里。它的0Q等于0。44放在这里，这个0。0这里一这里好，和我们预期的结果是一样的。现在Q是什么值？呃。

Q是可能大家也忘了，是我们传进来的这个。呃。这里。P1等于11P2等于22，P3等于33。他对P1这个做了一个这几个函数，press URLpress STRreve做完处理以后，现Q变成了012啊。

这样这个样子。我们把Q添加到监视里。Q。啊，是这样的结构。接下来session start。就把我们的session打开了。S是and session，也就是说把S给它地址付了过去。

SS是sabSTR我们一看这个就是一个很常见的木马里面的操作，是用字符串的名字去做一个函数呃，做一个函数名。我们调用SS和调用sveSTR是一样的，它是字符串截取函数。

SL是STRto lower是大写变小写，这是截截字符，这个大写变小写。好，我们现在定义了两个函数，等是定义两个函数。我们看一下II就是一个没有定义的变量，是M的10和M的11结合。

我们看一下M的10是什么？10是A一是大A，所以I应该是小A加大A，我们走一下。看看I是小A和大A，你们做一个标记吧。辩论爱。是。小A和大A。好，我们放到注释里这里。F呃F又是什么呢？放错行了。

不好意思。呃，H和F又是什么呢？H呃我们看这里啊I是小A和大A点儿就是PHP面的加。把小A大A加上1个KHKH是我们最开始定义的这个K值。第一个K。也就是小A大AD6A6加起来，然后做1个MD5值。

做完MD5值以后，它应该是1个32位MD5被SS subSTR截断，截出了它的前三位。结束的前三位又通过SL这函数是starve to lowerS tell to lower。是把它变成小写。

就是H就AA4。大家记住我们这里的H。等于A。好，这个F又是什么呢？是一样的道理，所以我就不赘述了，F是2D4。好。P是空重新定义的P。好，我们看一下现在走到哪里了。呃。

P值P值接下来是一个比较重要的内容。嗯，比较复比较复杂，我先看一下有没有提问的。啊，确实变量很多。啊，这个工具叫V code。好，我们。看一下。P值的含义。这里它新定义了一个P，我们先看下前面做了什么。

呃，前面通过正则匹配呃，把两个P做了一个转换。把K和我们的传进来的这个I值，I是A是传进来的，做了一个转换，等于是一个有效的一个加密吧。然后接下来我们要对P值做一个变换了。

我们看一下这里一个for循环Z是是新变量，Z是1Z小于M的M1的countM一的大小M一是有三项。也就是Z每次加加Z的值就是。一和2。Z等于一或者是2，就Z可以等于一或者2。我们看P，这就是一个空值。

P要点等于Q变量的M2和Z。M2是什么呢？M2是。401就是Q等0。40。00。1。那Z是什么？Z是一和2，也就是说要把它这项的第一个和第二个挨个去负值。这项是零，这项是一。

也就是说他要把Q的零和Q的一去付给P。这段比较绕啊，大家回去慢慢理解一下，因为时间关系我只能讲快一点啊，也就是说把一这一项和2这一项付给P。其实这个都是我可以操控的。呃，怎么操控呢？刚才我说了在这里。

呃，在这里专门我写了个0。4，因为第1个0。4是没有用的。后面0。0和0。1是我指定了两个两个两项的。就把Q的前两项一和22给了P。我预测这里接下来会变成11。然后再走一轮。还会变成1122。

因为他用这个点加起来了。好，P是112，我们继续接下来看。他要在P中找H。H是什么呢？AA4就要在我们的。1二中找A4，所以我们需要。呃，必须让他的呃A4在开头。所以我们需要改修改一下我们代码了。

因为这里肯定是走不到if里边的，我给跳出去的。我们重设一下断点，设到这里。把就断点取掉。呃，我们在这里把它改一下。要加1个AA4P1等于AA4。一一就删掉吧，直P1等于AA4了。好，我们调试。勾一下。

好，断下来就看P是多少呢？A422。这时候HA4这时就可以进入if里了。呃，我们看一下进的if里，它对SS又是是什么呢？S是一个新建的数组，它里面建了1个AA这一项，只是空。然后P呢又等于。呃。

S的subSTR取P的前三位呃，后三位。我们看P现在是22。就是说虽然传进了AA4，但它又把AA4给截掉了。是什么目的呢？因为它要A4本身是没有意义的，它要留下一个真实的操控的恶意代码。

现在22这部分是恶意代码。啊，我们看如果要是K存在，就是说S数组存不存在AA是存在的。存在以后做什么呢？呃，我们在呃给他复值。就把这个S数组A这一项复值成22。好，先在大家记记一下。

就是S数组S数组的直线是A。R这样的一个值。接下来的操作是。找2D四。啊，在A22里边找2D4和刚才很像啊，刚才是找A4，就从从哪个里面找A4呢？是从P中找H。现是从这个其实也是相当于是P吧。

相当于是P中又要找F。他这个是要做什么呢？这个是为了。呃，就是不让别人去随便利用你的后门，你必须得把这些参数全部全对掉，因为调试对掉才可以。好，我们看这个2D4怎么能让这个中出现出现2D4呢？

我们把22直接改一下吧，直接把22改成2D4。ZR改成。呃，加1个2D4吧2D4。好，我们重新调试，重新下断点。重新下一下断点，下到这里。好，再够一下。看到我们现在S是222D4。呃，这时候找一下。

他找了取了E，这个E呢是2，为什么是二呢？是因为他找222呃2D4在这个字符串取的位置。是在从第二开始的下标是2。也是必须在这个中找到2D4，我们才能走if语句。呃。

if语句中内容呢是先把定义的变量KK是把我们前面的两个K连到了一起。是把这两个K连到了一起。呃，走到这里已经快了，大家再坚持一下，万里长征可能现在已经过了遵义了。呃，我们看一下。

接OBstarOBstar这个函数是把缓冲区打开。我们PHP呃的输出是有一个缓冲区的。嗯，我们把要输出内容先放进缓冲区里，用OBstar就统一先不输出。

等我们clean O B and cleanan的时候再输出。好，这时候我们要做一个执行啊，要做执行。呃，这时候大家可以先松一口气，我们先来看一下这个执行是在是要执行什么。我们先停止调试。

看一下这个执行函数已经到了最后一步了，最后一步。呃，执行。现在我们。传进来的东西去了哪里呢？我们传进来的值啊，其实最后都到了这个里。SS。你在代码里看一下。这么长一串。好，分析下结构。

这个是一个替换呃匹配替换函数，它面有三个参数。一个是这个。一个是这个。一个是这个，我们先看前两个什么意思，还就是说把下划线替换成斜杠。把减号替换成加号。为什么这样做呢？因为他要过一些贝24检测。

比如说你的一些呃一些杀毒，它会遇到贝24会自动解一下，但贝24里面的加号被替换成了减号呃，斜杠被替换成了下压线以后，他解贝24肯定是错误的。他用这样的一个方式去呃，绕过一些检测。让你手工解的时候。

也可能误以为这不是一个对464，因为它解不出来。对于哪一部分内容要做这样的替换呢？是后边的这部分SS是topubSTRtopSTR。SI是什么内容呢？啊，这里啊就是我们刚才那个最后的代码传进了这里。

我们是一个sveSTR，是一个截取，把它。里边最后那个key截掉了，把哪个K呢？这个2D4这个K截掉了，我们来动态调一下，这回我们带一个恶意恶意代码。我们把会A代码。刚才我22我就改了。

注意看本来是222D4，我改成PP info。2D4。好，告一下。这时候我们看SS内S内容是PHP infer后面带的2D4，2D4是无用的。经过这里。呃，我们是会把2D4给裁掉。

裁掉后的内容还做一个b store4的替换。那说明我们这里其实不能不能传P是音符，应该传一个。呃，还没有被贝64decode的内容，因为这要解贝64，还要过X函数，就是X是一个异或函数。

还要过GZ这个反压缩这个这个反压缩解压缩函数才能被执行的。大家注意啊，执行函数在这里又是一场长征呀。啊，但是不要灰心，我们只要反着给他来一下就就好了。呃，我给他看一下怎么反回来。

因为时间关系我就不现场写了，这是我之前写好的。怎么反着来呢？呃。不是这里是这里。好，我们把要执行的PHP in。这是音付。放在这里。然后RES。呃，等于GZcomppress。

就是刚才是GZuncomppress是减缩，我们这个它压缩，刚才是走X函数，我们给它再走一遍。呃，但是注意我们要把这个密钥传进去。刚才的是paase64decode，我们这里给它做一个incode。

decode我们就做incode。然后我们反着给它替换一下，把加号减号小号线替换掉。然后我们输出它，这是X函数的定义。因为我们自也要用到啊。好的。

我们看一下ba呃PHP infer会被编码成一个什么样子。我来访问一下。好，PHP infer被编码成这么一串。现在我们就可以呃在这个里边搞一下repeter。把我们的PHP infer替换成。这一串。

注意还保留了2D4，前面还保留了AA4。我们开始调试。重新购一下。好，到这里我们看。它的值。是我们传进来的这个最后应该有1个2D4。左是个2例4。我们看经过。他的这样一个解解密，经过它的执行。

看一下O是获得我们的缓冲区中内容，获得缓冲区内容。就因为它刚才开的缓冲区不输出，先获取缓冲区中要输出的内容，看O是什么。啊哦O怎么是100？因因为呃因为刚才搞错一个东西啊。不好意思，这里。呃。

这里自己搞错一个东西。我忘了保存了忘了保存了。啊，这个才是PHP infer的代码。们重新勾一下。停下调试，重新开始调试，然后再go一下。好，F10我们看一下OO内容，唉，怎么还是100呢？哦。

粘这里没有粘上，这也没有粘上。好的，现在对了现在对了，我们重新来一下，不好意思，耽误大家时间了。好，我们看下O啊，这有一大堆内容，这就是PHPfer内容啊。然后接下来我们。能直接输出吗？它是不能的。

他又要对它进行一个压缩，走X函数，然后贝64编码，最后生成了D函数。我看D是什么，D又变成这样的一串东西，然后最后被print了出来。好，就是我们最后看到的这串内容，其实PHP in内容。啊。

那那他到底有没有被成功执行了呢？我们再做一个试验，我们把payload再改一下，改成。我们定一个A变量等于98。我们输出。A变量加1。应该是99。好，我们来获取一下。这就是我们新的payload。

加到这里P2。还是要留下2D4。开始调试。搞一下。好，我们看O现在是99。呃，这个就是我们证明我们执行成功了。但是最后我们看不到它的成果，因为它又被编码成了这么一段，怎么解它呢？很容易。呃。

把这段啊先分44解码，然后过X函数，然后再GZ呃oncompress就是解压缩就可以看到99了。好，这个就是我们的这个木马，很大家很辛苦，特别辛苦。呃，数下X函数吧，刚才说的它传入两个参数。

一个K是这两个相加的值。T是传入的需要混淆的内容，它是做一个暗位逐位的一个抑惑，一个逐位抑惑。主页一货完以后呃，返回。所以他怎么它是一个对称的，它是一个对称的。好，说完今天重头戏内容，嗯。

还有一个比较精彩的部分。我们看一下交互脚本，就刚才我们调跟着走完了，但是我们每次利用的时候这样去用很麻烦的对吧？每次需要这样去改改我们的payload，再生成在bb so打很麻烦。啊。

我们怎么才能快速利用呢？我给大家看一下脚本。这个是我写的。呃，这里。稍等一下，有点卡，就用python把这个过程给它重新做了一遍。也就是说我我把我的 payload的。就给它重新的自动生成这两项，然。

重新指定一个P值。嗯，自动的去打，然后最后再自动的去解密，这个是一个不少的代码，你看一下。在这里我们先写写上它的地址，我是1点PP。好，我们的两个key不要变。先运行一下。啊。

我们在这里就可以输我们的payload了。我们来说一下。PHP。应付。好，现在出来一大堆。证明我们的后门是执行成功的。好，我们再输一点别的。我输一个，比如说还是那样吧，定义一个变量，A变量等于678。

然后再来一个B变量。等你。B变量等于123输出。A加B。好，801好，证明我们的这个交互shall是成功了。这样就是调用我们这个后门的正确的方式，呃，需要大家一点python的功底。

时间原因我就带带大家简略的看一下。他怎么做到的？我这里拆了几个函数，一个主函数不停的执行。呃，一个是制造，就是就是修就是创造出except language内容。啊，然后这里是创造出refer内容。

把这里拼接，然后创建我们的payload。然后这个是X函数，因为要做异获的这是发送payload的。发送完以后做一个解密，因为我们要就回传的结果也是加密的呀。我们要是这个加密结果做一个解密。好。

我们大概就明白了这个木马了。这个确实是我遇见过的很复最复杂的一个吧。呃，接下来最后再说一点，还能不能更强。这个这个话题也比较有意思，珠入码呢它其实是一个框架，它其实是一个框架。呃。

也就是说它没有完达到它的完全进化体，就是它可能只是一个暴龙兽，要达到究极丧尸暴龙兽，还有一种还有一点进化的路要走。可以怎么净化它呢？刚才呢给大家讲了很多例子啊，比如说。呃，啊，对。

忘了给大家讲怎么过和谐盾了。我们先来讲一下怎么过和谐盾吧。我们扫一下。稍等，有点卡。我们扫后面样本。我们看下这个原样本，原样本就是我们刚才的这个。就最开始的这个没有结婚淆的。呃，居恩被何一顿扫出来了。

他说内藏啊变量函数后门这样是不科学的，我们给他要改一下。修改一下，我把原样本复制一份。复制一个就叫。呃，叫和谐和谐点MPRP。我们再扫一下。好，我们原样本和和谐都出现了，我们再给它修改一下。

它既然说我们是呃创建函数，应该说的create function。这里我们把注意看啊，我们把这一行给它搞出来，我们来1个RET函数，我随便瞎起的名字，我们来定义一个functionction。RET。

啊，我们新建一个函数。return好。看到操作了吗？我们精建了一个函数，然后return掉我们刚才的这个值，然后D等于RET就是它等于函数的返回值。我们再来扫一下。开始扫描。

注意看和谐和原样的在这里开始扫描。好，和谐消失了，只有原样本了。我们成功过了某个和谐盾。啊，这样的效果肯定是完全和刚才一样的。啊，就是优雅过客阶顿，那多一层使用权的保护和不死保护，还有复杂性这些问题。

啊，我来说一下。呃，怎么才能更强呢？因为更强的是我们追求的这个目标啊。我们一开始就说了几个小样本。从这个码我们可以看到使用前的保护呃，比如说加一个最简单的。MD5MD5验证。呃，比如说。呃。

先把自己做的亲妈都认不出来，展示层一层保护。还有就是我们可以反复的写入自己。让别人删都删不掉，呃，想要删掉他怎么删呢？需要把。PHP的进程Q掉你必须有权限是关掉PHP进程，你才能停掉这个码。

因为他把自己文件删了以后，它一直还在内存里面一直运行着啊，一直在运行。这是几个更强的一个思路。呃，还有就是复杂性这个框架，这个木马就为什么说它是框架呢？因为呃处处都可以变，它最大的优点其实是灵活。

比如说我把正则表达变一变啊，用一些人们不常用的用法，只有我知道的用法啊，稍微变一下。就比如说这个问号冒号，这就已经很让人头疼了。啊，比如说我可以变一下，我不光用refer。

不光用except language，我用一些其他的冷门的。然后我又把这个加上做一些很复杂的障眼法。啊，或者是。我这里再替换再给它多一点。或者我这里的给它再改改一下啊。

或者我可以把这个T解密的key做成非对称的，用这样的K光能加密。我用解密的话，我还不能用这两个K。啊，都是可以变的一些方式。之后呢，相信它可以进化成丧尸暴龙兽的。现在只是它的初初级体。呃，好的。

这个又是我们。啊，我今天今天想讲的主要的技术内容吧。好，嗯，感谢园艺大咖如此细致技术分享啊，感觉大家都看的很认真，认真到了都舍不得在直播间里面分神发言。那好了，现在大咖就演讲完了，大家可以来冒泡啦。

我们下面会进入到我们今天的行长问答环节，大家可以在直播间里面的聊天区进行提问。然后大咖会进行解答。呃，有没有什么特殊姿势加进自己的呢？今天讲了很多特殊的姿势啊。😊，呃，比如说刚才加密的措施啊。

有一个很特殊的那个是我在1个CTF呃决赛里面的一个题。改的就是这里。呃，把它只用个别几个字母，可以甚至可以做到只用ABC3个字母去隐藏EVLgetA这样的一行，这是一个很特殊的姿势。呃。

是1个CTF里面的内容。只有下划线的码怎么调试？呃，这个码当然当然比这个码要简单多了，对吧？比这个码简单多了。但是你可能看到它只有一行不好调试是吧？但实际上PHP是以逗号为呃以分号为分行的。

你手工把它分行，然后下断点呃，如果最后有时间，我可以演示一下。所以你把这里做一个换行换行换行。然后你手工下断点，最后你看它一定是有一个呃执行的，一定是有一个执行的。呃，和谐盾的原理。

核谐盾的原理就是你看一下核谐盾给怎么给你爆读的。比如说他这里报了内藏EVL，你肯定要把EVAL函数给给它藏掉，给它干掉，或者让他找不出来。

刚才他说是内藏呃变量函数后门就create function这个函数。呃，这里是什么情况呢？你看一下，其实是。直刚才是直接把这一句放到放到了这里。我做的操作是把这一句放到了一个函数里。

最后有函数return呃，return的话。在他的他的就是。就是说它结果是一样的，只是把它套多套了一层函数，他就认不出来了。呃，我看看还有什么问题。HDP头重新了密码只用菜刀啊，对。

这个这个码就这个码是没有办法用菜刀的，因为你菜刀只能定制的东西很有限嘛，呃只能调一下你的密码啊，或者是啊好像也可以，好像也可以。但是呢这个码肯定是不适合菜刀的。

所以说我自己写了一个调试的这样的一个脚本这样的一个交互交互脚本。就是因为他不适合菜刀，所以我专门写的。如果他可以用菜刀，我早就用菜刀连了，因为写这一个也真的很麻烦。哦。间接复制。

平时对THP类CMS代码使经的思路，复现别人漏洞可以复现，懂一些漏洞利用，但是自己挖掘的时候不知道怎么下手，就是代码挖掘呃，我也我也是从呃复现别人代码过来的。

我可能复现了十十多二种就是初期的时候二三十种吧。CCMS。然后每个3S我都会找三四个漏洞去复现。复现完以后，你就会发现别人的这样的一些套路。呃，比如说。他是基于函数审计的，或者他是基于逻辑去审计的。

你就。呃，看的多了以后，你就会知道一些套路，知道容易存在问题的地方。比如说上来现在呃先看一下它是一个全局呃，就是参数的传入方式，是一个全局的做过滤呢，还是个别做过滤呢？然后如果要个别做过滤。

你就挨个去审这些过滤点这样的。这是一个很大的话题。😊，嗯。然后挖掘的话，每次就是我会复现完，我会想一个问题。呃，如果我是当时的这个拉动大佬，我是以一个什么思路挖的，我会。就是我需要想到什么。

我才能挖到这个漏洞，就可以给大家提供个思路。呃，上一个叫s这个片是不是只能工去网页？呃，这个是你这个后门啊，是你把自己的后门放到别人呃放放到呃服务器上，就是被就中到服务器上以后，你去用我的交互效去连接。

有连接，你放到哪个地址，你就去连接哪个地址就好了。可以不通过两轨就很强吗？完全可以啊，你这里非常灵活，可以改其他的参数。比如改X four four啊，或者是都可以。把它变异一下，你就可以实现。

这个刚才说了，它其实是一个框架，它的变异性非常强，它就呃随处都可以变，特别灵活。啊，谢谢打call。还有就是有没有复线的网站，这个直接把。啊，后门传到自己的外部目录下，传到自己的外部目录下就可以了。呃。

就可以直接复现了。呃，源码源码的话，这样吧，我。呃，经过呃和表姐商量一下以后，看如果要是哪些能放，我就尽量给大家放了。呃，如果拿到1个CM。呃，做代码审计也是推荐大家多去看一下这样的CMSS漏洞。

因为它比较好调，尤其是滴滴CMS或者一些呃其他的这种国产的，因为注视能看得懂。好的。啊，时间差不多，咱们要不玩个小游戏，开始这个。准备选个新观众吧。行的，那今天因为时间有限。

然后我们问答环节大家也问差不多了，我们就还有问题的话，之后到群里面再交流吧。也可以之后加大咖来进行讨论。那下面我们来到今晚的这个大咖所谓的游戏环节，也是我们的福利环节。

就是我们请园艺大咖来赠出他的赠书叫恶意代码分析实战。那这本书是一本非常权威的恶意代码分析的一本指南性的书籍吧。那下面就请园艺大咖来选信观众吧。好的，你咱们玩个小游戏吧，激动人心的时刻到了。

然后嗯大家准备的什么游戏。是一个抢答游戏。嗯抢答游戏。好抢答游戏那个大家认真听啊，认真听认真听。😊，呃，远义这两个字一共有多少话？第一个出答答正确的，我会选下。这种话咱快点熟起来，我也来数。😊，哎呀。

我算是自己中文没学好。数不清。😊，是原意两个字加起来，两个字加起来加起来，为什么开始爆破，手工爆破。😊，来看你按顺序看一下有没有答对的哦，我看到有答对了，我看到有答对了。你把他的ID报一下呗。

其实其实你们可以手工爆破的这个思路很黑客的。比如说你趁别人答的时候，你先报个1，再报个11，再报个12，我其实挺欣赏这个思路的呃，咱们数一下啊，远第一横一第二横2，撇3，那呃4。😊，呃。

点567应该是一共16号，对吧？16号跟16号吧。嗯，我感觉我可能你们没什123456。91新712对，1616号十6号对，16号，我找一下哪哪哪位是第一个第一个说十6呢？看一下。呃，后来我也去看一下。

找发卡你对你来把他ID报一下。好，我正在找。这个选法也挺有意思的，我又get了一个新get一个新的姿势。😊，到观众是W0RTH1吗？呃对我那是到没，你看到是他的第一个是吧？好的好的，对。

感谢你今天认真认真听的课也属的很快。嗯，我这为ID为W0THE对吗？小伙伴获得了这本大咖的证书。这本睡觉垫起来很舒服的恶意代码分析实战。那请你根据直播间的提示，留下你的联系方式。

或在直播后直接私聊我进行兑讲。😊，好啦，来到今晚直播的尾声了，再次感谢园艺大咖精心准备，分享的内容很充实，希望观众伙伴们能够收获不少。那如果对你有所帮助的话，记得向园艺大咖说一声感谢吧。

那想回顾本期直播的话，在下周五我们将放出今天的录屏，敬请关注官网更新或社群通知。今后也欢迎大家多多关注园艺大咖的个人动态。😊，当然，也感谢所有观众伙伴的踊跃参与。大咖面对面是一个传播知识技术。

展现白毛风采的舞台，不具年龄，不畏资历。如果你也想和大咖一样登台分享，欢迎主动找我报名，加入大咖天团，更能参加年度大咖活动，结交往期大咖伙伴，获得更多漏洞银行的福利优待哟。那另外这里也说一下。

漏洞银行2018年的年度活动已经启动发车，大家可以关注群里的通知，会有好几波活动等你参加。那如果你也想继续交流或关注直播，可以点击页面底部的加群链接。那直播到这里就要结束了。

那请问园艺大咖还有什么想要跟大家交流的吗？呃，好的，联系方式的话可以加我QQ去分享呃，去分享技术吧。然后也欢迎大家来交流呃，我是做CS审计。好的，嗯我刚发那大咖QQ号。

大家感兴趣想认识大咖可以去添加他一下好友。好的，谢谢大家。😊，嗯，好的，那感谢远艺大咖。那今晚我们的直播就到此结束了。嗯，大咖面对面，周午8点见，我们下周再约吧。😊，🎼Yeah。🎼我想那夜空颜色皎洁。

🎼脑海深处的思绪不断摇曳。🎼像清风吹过，定格在这秋天。🎼过往的云烟遮挡住了视线。🎼每当深夜来临，我选择依然逃避，掐住呼咙呼吸，不断反复质问自己，难捱到低潮汐，辗转反侧不容易，未来都成了谜。

下一句怎么下笔，当一切化作生命终不可谋灭。🎼会痛的家情里都是苦心甘。🎼故意别把问题想了。🎼你用什抱。🎼地惫。🎼Yeah。🎼き。🎼眼球里面不闻不问，自我挣扎，也有了自信不愿面对外人说话，我尝试倾静。

尝试诉求，学着表达，可怎么做也得不到想要的回答。😔，🎼为大而沉重，踏上这旅途是否成功，肩上扛的是家人何自有怀揣的梦。🎼心情有多空，又其是在夜里做梦，也时常会清醒的发现自己渴望有恃无恐。😊。

🎼清晨起床发现头有点眩晕平静。🎼放下一步一步电影下午的太。😊，🎼救我体命。🎼的拼命对那美好。🎼化作生命中不可磨灭的尘埃。🎼也许会懂得这经历都是苦尽甘。🎼故意别把问题想的太。😊，🎼继水只。🎼有选吧。

🎼べた。🎼Ba。🎼去。Yeah。