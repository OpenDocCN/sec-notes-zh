# 课程 P1：宽字节注入原理与实践 🛡️

![](img/83177177960e1e8438799eb58a6b7f0c_1.png)

在本节课中，我们将学习宽字节注入的原理、触发条件以及如何利用此漏洞进行SQL注入攻击。宽字节注入是一种特殊的SQL注入手法，其核心在于利用数据库编码转换过程中的特性，绕过常见的单引号转义防护。

## 什么是宽字节注入？🔍

宽字节注入源于程序员在设置数据库连接时，错误地配置了编码。例如，将编码设置为GBK。在这种编码设置下，当进行编码转换时，可能引发注入漏洞。

正常情况下，当GPC（魔术引号）开启或使用`addslashes`函数过滤GET或POST请求参数时，黑客输入的单引号`'`会被转义。转义的方式是在前面加上一个反斜杠`\`，即变成`\'`。

## 环境演示与初步尝试 💻

为了更直观地理解，我们通过一个案例来演示。假设我们有一个查询语句：

```sql
SELECT * FROM news WHERE title = '$title'
```

当我们输入 `title=1` 时，数据库执行语句为 `SELECT * FROM news WHERE title = '1'`。

按照常规测试，我们尝试输入 `title=1'`。如果存在防护，单引号会被转义为 `\'`，因此实际查询变为 `SELECT * FROM news WHERE title = '1\''`。在MySQL中，反斜杠是转义符，因此数据库会尝试寻找字面值为 `1'` 的标题。由于通常不存在，查询可能返回空值，而不会直接报错。

## 宽字节注入的触发 🚀

上一节我们介绍了单引号被正常转义的情况。本节中我们来看看，如果存在宽字节漏洞会发生什么。

我们输入 `%df%27`（其中 `%27` 是单引号的URL编码）。当这个输入经过`addslashes`函数过滤时，单引号会被转义。过程如下：
1.  输入：`%df%27`
2.  `addslashes` 检测到 `%27`（单引号），在其前添加反斜杠的编码 `%5c`。
3.  传递给数据库的字符串变为：`%df%5c%27`

关键在于，数据库连接使用了GBK编码。GBK是一种多字节编码，在汉字编码范围内，两个字节会被解码为一个汉字。此时，MySQL服务器会对查询语句进行GBK解码，将 `%df%5c` 转换成一个特定的汉字（例如“運”），而 `%27` 则被独立解码为单引号 `'`。

这样一来，用于转义单引号的反斜杠（`%5c`）被“吃掉”了，单引号成功逃逸，从而闭合了SQL语句，导致注入漏洞。

以下是利用此漏洞进行注入的示例步骤：

1.  **探测漏洞**：输入 `title=1%df%27`。如果页面返回数据库错误信息，则可能存在宽字节漏洞。
2.  **确定列数**：使用 `ORDER BY` 子句确定查询结果集的列数。
3.  **联合查询**：使用 `UNION SELECT` 语句注入。例如，假设有3列，可以构造：`1%df%27 UNION SELECT 1,2,3 --+`
4.  **获取数据**：将 `UNION SELECT` 后的占位数字替换为想要查询的数据。例如：`1%df%27 UNION SELECT 1, username, password FROM admin --+`

## 核心概念与注意事项 📝

上一节我们演示了利用过程，本节我们来深入几个核心概念。

**GBK编码与数据库的关系**
宽字节注入与网站前台的页面编码（如UTF-8）无关，它只与**数据库连接层使用的字符集**有关。即使页面是UTF-8，只要数据库连接使用GBK，就可能存在此漏洞。

**使用分隔符提高可读性**
在注入获取多个字段（如用户名和密码）时，直接返回的结果可能连在一起，不易阅读。可以使用MySQL的 `CONCAT_WS` 函数或十六进制字面值添加分隔符。
*   **使用 `CONCAT_WS`**：
    ```sql
    UNION SELECT 1, CONCAT_WS('~', username, password), 3 FROM admin
    ```
*   **使用十六进制**：波浪线 `~` 的十六进制是 `0x7E`。在注入语句中直接使用 `0x7E` 作为分隔符，可以避免被转义。

**原理总结**
宽字节注入的核心原理可以概括为以下公式：
```
攻击输入 (%df%27) + 转义函数 (%5c) => 传输数据 (%df%5c%27) + GBK解码 => 汉字('運') + 单引号(')
```
最终，单引号前的转义符消失，单引号生效。

## 其他利用技巧与防御 🛡️

除了 `%df`，任何能与 `%5c` 在GBK编码下组成一个合法汉字的字节都可以利用，例如 `%de%5c`、`%e0%5c` 等。

更巧妙的一种方式是，利用本身包含 `%5c`（即反斜杠）的字符。例如，“錦”字的GBK编码是 `%e5%5c`。如果我们输入“錦'”，经过转义会变成 `%e5%5c%5c%27`。在GBK解码时，`%e5%5c` 被解码为“錦”字，剩下的 `%5c%27` 中，第一个 `%5c` 作为转义符，转义了第二个 `%5c`，使得第二个 `%5c` 失去转义功能，从而让最后的 `%27`（单引号）逃逸。

**如何防御宽字节注入？**
1.  **统一字符集**：确保前端、后端、数据库连接层使用统一的字符集，推荐使用UTF-8。
2.  **使用预处理语句（Prepared Statements）**：这是防止所有SQL注入最有效的方法。参数化查询能确保用户输入始终被当作数据处理，而非SQL代码的一部分。
3.  **正确设置连接字符集**：在PHP中，使用 `mysqli_set_charset($conn, 'utf8mb4')` 或PDO的 `charset` 参数明确设置字符集，避免依赖可能不安全的默认设置。
4.  **避免使用 `addslashes`**：`addslashes` 函数并非为数据库安全设计，应使用数据库驱动提供的特定转义函数（如 `mysqli_real_escape_string`），并配合正确的字符集设置。

## 总结 📚

本节课中我们一起学习了宽字节注入。我们从漏洞的基本概念出发，了解了其成因是数据库GBK编码与转义函数 `addslashes` 共同作用下的字符解析问题。通过案例演示，我们一步步学习了如何探测和利用宽字节漏洞进行SQL注入。最后，我们探讨了漏洞的原理本质，并介绍了最关键的防御方法：使用统一的UTF-8编码和参数化查询。

![](img/83177177960e1e8438799eb58a6b7f0c_3.png)

![](img/83177177960e1e8438799eb58a6b7f0c_4.png)

理解宽字节注入有助于我们认识到，安全是一个整体，任何一个环节（如字符集配置）的疏忽都可能导致严重的漏洞。