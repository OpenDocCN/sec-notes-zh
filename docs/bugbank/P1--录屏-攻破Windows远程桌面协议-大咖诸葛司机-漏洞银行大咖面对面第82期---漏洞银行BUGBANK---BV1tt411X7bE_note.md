![](img/7fcd2d360e8f549b1125ef603363385b_0.png)

# 课程 P1：攻破Windows远程桌面协议 🖥️🔓

![](img/7fcd2d360e8f549b1125ef603363385b_2.png)

在本节课中，我们将学习如何从协议层面分析和攻击Windows远程桌面协议。我们将通过抓包分析协议结构，探讨其存在的安全漏洞，并演示一个实际的攻击工具。课程内容力求简单直白，适合初学者理解。

## 概述

![](img/7fcd2d360e8f549b1125ef603363385b_4.png)

![](img/7fcd2d360e8f549b1125ef603363385b_6.png)

Windows远程桌面协议是用于远程控制Windows系统的标准协议。本节课将深入其协议细节，揭示其加密机制中存在的固有缺陷，并展示如何利用这些缺陷进行中间人攻击，从而获取明文凭据和键盘记录。

---

## 1. 协议抓包与分析

上一节我们介绍了课程目标，本节中我们来看看如何通过抓包来理解RDP协议的工作流程。

![](img/7fcd2d360e8f549b1125ef603363385b_8.png)

![](img/7fcd2d360e8f549b1125ef603363385b_10.png)

使用Wireshark工具可以捕获和分析RDP通信的数据包。在捕获的流量中，我们可以观察到TCP、TPKT以及RDP协议层。

![](img/7fcd2d360e8f549b1125ef603363385b_0.png)

在客户端发送给服务端的初始包中，`Client Security Data`字段至关重要，它声明了客户端支持的加密方式。例如，`0x0B`（十进制11）代表一种特定的加密套件。

![](img/7fcd2d360e8f549b1125ef603363385b_12.png)

服务端的回复包中包含服务器的证书、随机数以及最终协商确定的加密算法（如128位或256位加密）。这个过程与SSL/TLS握手类似，双方交换随机数和证书以生成会话密钥。

**核心概念公式**：
`会话密钥 = f(客户端随机数， 服务器随机数， 预主密钥)`

![](img/7fcd2d360e8f549b1125ef603363385b_14.png)

---

## 2. RDP的三种安全协议

![](img/7fcd2d360e8f549b1125ef603363385b_16.png)

在分析了基础通信后，我们来看看RDP协议提供的三种不同安全层级。

![](img/7fcd2d360e8f549b1125ef603363385b_18.png)

RDP主要支持三种连接类型：
1.  **Standard RDP Security**：几乎没有任何加密保护，数据明文传输。
2.  **Enhanced RDP Security (TLS)**：使用SSL/TLS进行加密，旨在保证通信的保密性。
3.  **CredSSP**：提供了更高级别的身份验证，通常与TLS结合使用，是安全性最高的一种。

其中，TLS加密依赖于公钥和私钥对。然而，这正是RDP协议漏洞的关键所在。

---

## 3. 协议中的核心漏洞

![](img/7fcd2d360e8f549b1125ef603363385b_20.png)

上一节我们了解了RDP的加密方式，本节中我们来看看其加密机制中存在的致命缺陷。

![](img/7fcd2d360e8f549b1125ef603363385b_22.png)

![](img/7fcd2d360e8f549b1125ef603363385b_24.png)

漏洞的核心在于：**微软在实现Enhanced RDP Security (TLS)时，使用了固定的、公开的公私钥对**。

这意味着，所有Windows系统在RDP TLS加密中使用的服务器证书（公钥）和对应的私钥是相同的，并且已被微软公开。这使得本应安全的TLS加密形同虚设，因为攻击者可以轻易获得解密流量所需的私钥。

**攻击原理简述**：
1.  攻击者在局域网内进行中间人攻击，拦截客户端与服务器之间的RDP流量。
2.  在TLS握手阶段，攻击者用自己的证书（使用公开的微软私钥签名）替换掉服务器的真实证书。
3.  客户端验证证书时（通常用户会忽略证书错误），会使用攻击者提供的公钥加密其预主密钥。
4.  攻击者利用已知的私钥解密，从而获得会话密钥，进而解密所有后续通信。

![](img/7fcd2d360e8f549b1125ef603363385b_26.png)

---

![](img/7fcd2d360e8f549b1125ef603363385b_27.png)

![](img/7fcd2d360e8f549b1125ef603363385b_29.png)

## 4. 攻击工具解析

了解了漏洞原理后，我们来看一个利用此漏洞的自动化工具——`Seth`。

![](img/7fcd2d360e8f549b1125ef603363385b_31.png)

`Seth`是一个用Python编写的开源工具，它实现了上述的中间人攻击。其工作流程如下：

![](img/7fcd2d360e8f549b1125ef603363385b_33.png)

以下是`Seth`工具实现攻击的关键步骤代码逻辑：

![](img/7fcd2d360e8f549b1125ef603363385b_35.png)

![](img/7fcd2d360e8f549b1125ef603363385b_37.png)

![](img/7fcd2d360e8f549b1125ef603363385b_39.png)

```python
# 1. 进行ARP欺骗或流量转发，实现中间人位置
subprocess.call(‘iptables -t nat -A PREROUTING …’)

# 2. 克隆或生成一个使用微软公开私钥签名的伪造证书
fake_cert = generate_certificate(microsoft_private_key)

# 3. 拦截Client Hello报文，将客户端支持的加密套件修改为最弱的一种（如仅支持RC4）
modified_packet = downgrade_crypto_suite(original_packet)

![](img/7fcd2d360e8f549b1125ef603363385b_41.png)

# 4. 在TLS握手时，将服务器证书替换为自己的伪造证书
send_to_client(fake_cert)

![](img/7fcd2d360e8f549b1125ef603363385b_43.png)

# 5. 使用已知私钥解密客户端发送的加密预主密钥，计算出会话密钥
session_key = decrypt_with_private_key(encrypted_pre_master_secret, known_private_key)

![](img/7fcd2d360e8f549b1125ef603363385b_45.png)

![](img/7fcd2d360e8f549b1125ef603363385b_47.png)

# 6. 使用会话密钥解密应用层数据，提取RDP登录凭据和键盘输入
credentials = parse_rdp_data(decrypted_traffic)
```

![](img/7fcd2d360e8f549b1125ef603363385b_49.png)

该工具通过`iptables`进行流量重定向，并内置了RDP协议解析和修改模块，能够自动完成证书替换、协议降级和流量解密。

![](img/7fcd2d360e8f549b1125ef603363385b_51.png)

---

## 5. 实战演示与效果

理论结合工具，本节我们进行实战演示，观察攻击的实际效果。

![](img/7fcd2d360e8f549b1125ef603363385b_53.png)

在演示环境中，我们配置攻击机（Kali Linux运行`Seth`）、客户端（Windows 7）和服务端（Windows 10）。

![](img/7fcd2d360e8f549b1125ef603363385b_55.png)

执行以下命令启动攻击：
```bash
./seth.sh eth0 <客户端IP> <服务端IP>
```

当客户端用户像往常一样发起RDP连接并忽略证书警告后，`Seth`的攻击终端会实时显示截获的信息。

![](img/7fcd2d360e8f549b1125ef603363385b_57.png)

![](img/7fcd2d360e8f549b1125ef603363385b_59.png)

**攻击结果展示**：
*   **用户名**: `test`
*   **密码**: `changeme`
*   **键盘记录**:
    *   `[L_SHIFT down]`
    *   `[Q down]`
    *   `[L_SHIFT up]`
    *   `[I down]`
    *   `[U down]`

![](img/7fcd2d360e8f549b1125ef603363385b_61.png)

可以看到，攻击成功获取了明文的用户名和密码，并记录了所有的键盘输入，这意味着攻击者完全获得了该RDP账户的控制权。

---

## 6. 攻击场景与防御建议

在演示了强大的攻击效果后，我们必须讨论其适用场景和如何防御。

![](img/7fcd2d360e8f549b1125ef603363385b_63.png)

**攻击场景限制**：
*   **必须在内网**：此攻击属于中间人攻击，要求攻击者与客户端、服务器在同一局域网内。
*   **依赖用户行为**：需要用户忽略或接受无效的证书警告。

![](img/7fcd2d360e8f549b1125ef603363385b_65.png)

![](img/7fcd2d360e8f549b1125ef603363385b_67.png)

**防御建议**：
1.  **使用有效的证书**：为RDP服务器配置由可信证书颁发机构（CA）签名的证书，并强制客户端验证证书。这样用户会看到明确的警告，且伪造证书无法通过验证。
2.  **启用网络级认证**：在Windows服务器上启用“仅允许运行带网络级身份验证的远程桌面的计算机连接”，这会在建立完整RDP连接前先进行身份验证。
3.  **网络分段与监控**：对关键服务器进行网络隔离，部署入侵检测系统监控异常的ARP请求或SSL中间人攻击行为。
4.  **考虑替代方案**：对于高安全需求环境，考虑使用更安全的远程访问解决方案，如VPN+跳板机。

![](img/7fcd2d360e8f549b1125ef603363385b_69.png)

---

![](img/7fcd2d360e8f549b1125ef603363385b_71.png)

![](img/7fcd2d360e8f549b1125ef603363385b_73.png)

## 总结

![](img/7fcd2d360e8f549b1125ef603363385b_75.png)

![](img/7fcd2d360e8f549b1125ef603363385b_77.png)

本节课中我们一起学习了Windows远程桌面协议的安全机制及其存在的根本性漏洞。我们了解到，由于使用了固定的加密密钥，RDP的TLS加密可以被轻易绕过。通过分析`Seth`工具，我们看到了如何利用此漏洞进行中间人攻击，从而获取明文凭据和键盘记录。最后，我们讨论了该攻击的局限性以及最有效的防御措施——为RDP服务配置有效的CA签名证书。

> 此漏洞源于协议设计实现缺陷，微软未提供直接补丁，防御核心在于实施正确的证书管理策略。