# 课程 P1：SSRF漏洞绕过与利用 🎯

![](img/37252e390c3331726b1d537ab2d34f1b_0.png)

在本课程中，我们将系统性地学习SSRF（服务端请求伪造）漏洞的原理、常见场景、绕过技巧以及实际利用方法。课程内容由浅入深，旨在帮助初学者理解核心概念，并为有经验的安全研究者提供新的思路。

![](img/37252e390c3331726b1d537ab2d34f1b_2.png)

## 概述

SSRF（Server-Side Request Forgery）全称为服务端请求伪造。其核心在于，攻击者能够诱使服务器向任意目标发起网络请求。与主要针对客户端的CSRF漏洞不同，SSRF的攻击面在服务器端，因此常被用于探测和攻击内网服务。

![](img/37252e390c3331726b1d537ab2d34f1b_4.png)

## 漏洞原理与场景 🔍

上一节我们介绍了SSRF的基本概念，本节中我们来看看其具体的工作原理和常见的出现场景。

![](img/37252e390c3331726b1d537ab2d34f1b_6.png)

![](img/37252e390c3331726b1d537ab2d34f1b_8.png)

SSRF的原理如下图所示：当服务器端存在一个功能（例如下载远程图片），且该功能的请求地址可由客户端控制时，就可能产生漏洞。客户端将可控的地址传递给服务器，服务器根据该地址发起请求（如下载图片），并将结果返回给客户端。这个过程使得攻击者可以操纵服务器向任意地址发起请求。

![](img/37252e390c3331726b1d537ab2d34f1b_10.png)

**核心流程公式**：
`客户端输入恶意URL -> 服务器接收并处理 -> 服务器向恶意URL发起请求 -> 服务器返回响应结果`

![](img/37252e390c3331726b1d537ab2d34f1b_12.png)

以下是SSRF漏洞常见的出现位置：

![](img/37252e390c3331726b1d537ab2d34f1b_14.png)

*   **远程资源加载**：如远程图片下载、视频URL预检、网页翻译等功能。服务器会代表用户去获取这些外部资源。
*   **文件处理功能**：例如某些系统在插入视频前，会先由服务器检查该视频URL是否存在。
*   **内部网络探测**：由于服务器通常位于内网，且访问内网资源可能不受外部防火墙限制，因此SSRF常被用于探测内网资产。

## 常见的过滤与绕过方式 🛡️➡️⚔️

理解了漏洞原理后，我们面临的下一个问题是：实际环境中往往存在各种安全防护。本节将探讨常见的过滤机制及其绕过方法。

### 1. 利用HTTP基础认证语法

![](img/37252e390c3331726b1d537ab2d34f1b_16.png)

当服务端代码使用正则表达式过滤特定域名（如 `bugbank.com`）时，可以利用HTTP基础认证的语法进行绕过。

**绕过原理**：在URL中嵌入 `username:password@` 格式。如果目标服务器不返回401状态码要求认证，那么 `username:password@` 这部分会被服务器忽略，但可能绕过简单的字符串匹配过滤。

**示例代码**：
```
http://bugbank:test@www.baidu.com
```
服务器实际请求的是 `www.baidu.com`，但过滤规则可能只检查是否存在 `bugbank` 字符串。

### 2. 利用DNS解析流程（多级域名）

此方法利用DNS解析过程。一个域名（如 `x.bugbank.yourdomain.com`）可以解析到任意IP地址（包括内网IP）。如果目标服务器使用公共DNS，并且其过滤逻辑不严谨，就可能通过多级域名指向内网地址。

**示例**：
将 `ssrf.bugbank.attacker.com` 的A记录指向 `192.168.1.1`。

### 3. IP地址编码与302跳转

当服务端限制只能使用HTTP协议或过滤了常见内网IP段（如10.x.x.x, 172.16.x.x, 192.168.x.x）时，可以结合使用以下技术：

*   **IP进制转换**：IP地址可以用八进制、十六进制、十进制等不同进制表示。
    *   八进制：`0177.0.0.1` (代表 `127.0.0.1`)
    *   十六进制：`0x7f.0x0.0x0.0x1` (代表 `127.0.0.1`)
    *   十进制：`2130706433` (代表 `127.0.0.1`)
*   **302跳转**：在自己的服务器上部署一个302重定向脚本，让服务器先请求一个合法的外网地址，该地址立即返回302状态码，将请求重定向到目标内网地址。这可以绕过协议和IP黑名单限制。

## 漏洞探测与协议利用 🧪

![](img/37252e390c3331726b1d537ab2d34f1b_18.png)

![](img/37252e390c3331726b1d537ab2d34f1b_19.png)

![](img/37252e390c3331726b1d537ab2d34f1b_21.png)

成功绕过过滤后，我们需要确认漏洞存在并探测服务器支持的协议，为后续利用做准备。

![](img/37252e390c3331726b1d537ab2d34f1b_23.png)

![](img/37252e390c3331726b1d537ab2d34f1b_25.png)

### 如何探测SSRF漏洞？

![](img/37252e390c3331726b1d537ab2d34f1b_27.png)

![](img/37252e390c3331726b1d537ab2d34f1b_28.png)

最直接的方法是在自己控制的服务器上开启网络监听（例如使用 `nc -lvp 端口号`），然后在存在疑似SSRF的功能点输入你的服务器地址和监听端口。如果收到来自目标服务器的连接请求，则证明漏洞存在。

### 利用“万能”协议字典

![](img/37252e390c3331726b1d537ab2d34f1b_30.png)

服务器支持的协议决定了攻击面。我们可以使用 `dict://`, `gopher://`, `file://` 等协议进行探测和利用。

![](img/37252e390c3331726b1d537ab2d34f1b_32.png)

![](img/37252e390c3331726b1d537ab2d34f1b_34.png)

以下是几个关键协议的作用：

![](img/37252e390c3331726b1d537ab2d34f1b_36.png)

*   **`file://` 协议**：用于读取服务器本地文件，例如 `/etc/passwd`。
    **示例代码**：`file:///etc/passwd`
*   **`dict://` 协议**：可用于探测服务版本信息，帮助识别内网应用。
    **示例代码**：`dict://127.0.0.1:22/info` (可能返回SSH版本信息)
*   **`gopher://` 协议**：一个非常强大的协议，可以构造任意格式的TCP数据包，用于攻击内网的Redis、MySQL等应用。
*   **`ftp://` 协议**：通常仅用于探测FTP服务是否存在。

![](img/37252e390c3331726b1d537ab2d34f1b_38.png)

## 高级利用：攻击内网应用 🎯

![](img/37252e390c3331726b1d537ab2d34f1b_40.png)

![](img/37252e390c3331726b1d537ab2d34f1b_42.png)

在上一节我们学会了探测，本节我们将深入探讨如何利用SSRF攻击内网中的具体应用，例如Redis数据库。

攻击流程通常如下：
1.  **信息收集**：利用 `dict://` 等协议探测内网开放端口及服务版本。
2.  **协议判断**：确定目标服务（如Redis）使用的通信协议。
3.  **流量抓取与构造**：
    *   在本地搭建与目标同类型的服务（如Redis）。
    *   使用工具（如 `socat`）进行端口转发，捕获客户端（模拟攻击）与本地服务的完整通信流量。
    *   分析抓取到的原始数据包，将其中的换行符（`\r\n`）等特殊字符进行URL编码（如转换为 `%0d%0a`），并计算正确的数据包长度。
4.  **Payload组装与发送**：将处理后的数据包，通过 `gopher://` 协议发送给目标内网服务。
    **关键步骤代码示例（概念性）**：
    ```bash
    # 使用socat进行流量转发和抓取
    socat -v tcp-listen:1234,fork tcp-connect:127.0.0.1:6379
    # 构造gopher payload (需替换[CAPTURED_DATA]为处理后的数据)
    gopher://127.0.0.1:6379/_[CAPTURED_DATA]
    ```
5.  **执行攻击**：例如，向Redis发送命令，写入定时任务（crontab）或SSH公钥，从而获取服务器反弹shell。

## 总结与问答要点 📚

本节课我们一起学习了SSRF漏洞从原理到高级利用的完整链条。

**核心要点总结**：
1.  **原理核心**：利用服务器发起请求的功能，使其访问攻击者控制的或内网的地址。
2.  **绕过关键**：灵活运用URL语法、DNS、IP编码和重定向技术绕过常见过滤。
3.  **利用基础**：通过监听和协议探测确认漏洞并识别攻击面。
4.  **高级攻击**：结合 `gopher` 等协议，通过流量分析重构数据包，攻击内网未授权服务（如Redis），是获取内网权限的有效途径。

![](img/37252e390c3331726b1d537ab2d34f1b_44.png)

![](img/37252e390c3331726b1d537ab2d34f1b_45.png)

**课程中解答的常见问题**：
*   **SSRF与CSRF的区别**：SSRF是服务端发起请求，CSRF是客户端（浏览器）发起请求。两者攻击对象和利用方式截然不同。
*   **漏洞危害等级**：取决于目标服务器在内网中的位置和可访问的资源。核心业务服务器上的SSRF通常属于高危漏洞。
*   **内网渗透延伸**：获得一个内网立足点（如Web Shell）后，可进行信息收集、横向移动（如利用漏洞MS17-010）、攻击运维网络等，逐步扩大控制范围。
*   **盲打SSRF**：在没有回显的情况下，可以通过DNS查询、响应时间差异等方式判断漏洞是否存在及命令是否执行。

希望本教程能帮助你建立起对SSRF漏洞的系统性认识。安全技术不断演进，持续学习、动手实践和合法测试是提升能力的关键。