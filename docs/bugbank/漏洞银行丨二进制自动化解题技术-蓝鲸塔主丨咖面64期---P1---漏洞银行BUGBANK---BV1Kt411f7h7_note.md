![](img/680ae1ed515966b15d367bd1a71209f2_1.png)

# æ¼æ´é“¶è¡Œä¸¨äºŒè¿›åˆ¶è‡ªåŠ¨åŒ–è§£é¢˜æŠ€æœ¯-è“é²¸å¡”ä¸»ä¸¨å’–é¢64æœŸ ğŸš€

![](img/680ae1ed515966b15d367bd1a71209f2_3.png)

![](img/680ae1ed515966b15d367bd1a71209f2_5.png)

## æ¦‚è¿°
åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åˆ©ç”¨è‡ªåŠ¨åŒ–æŠ€æœ¯è§£å†³äºŒè¿›åˆ¶é€†å‘å·¥ç¨‹é¢˜ç›®ã€‚æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ç¬¦å·æ‰§è¡Œçš„æ¦‚å¿µï¼Œå¹¶å­¦ä¹ ä½¿ç”¨ **Angr** å’Œ **Z3** è¿™ä¸¤ä¸ªå¼ºå¤§çš„å·¥å…·æ¥è‡ªåŠ¨åŒ–åˆ†æç¨‹åºã€æ±‚è§£çº¦æŸæ¡ä»¶ï¼Œä»è€Œå¿«é€Ÿæ‰¾åˆ°æ­£ç¡®çš„è¾“å…¥ï¼ˆå¦‚Flagï¼‰ã€‚æœ¬æ•™ç¨‹æ—¨åœ¨è®©åˆå­¦è€…ä¹Ÿèƒ½è½»æ¾ç†è§£å¹¶ä¸Šæ‰‹å®è·µã€‚

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šç¬¦å·æ‰§è¡ŒåŸºç¡€

ä¸Šä¸€èŠ‚æˆ‘ä»¬æ¦‚è¿°äº†è¯¾ç¨‹ç›®æ ‡ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯ç¬¦å·æ‰§è¡Œï¼Œä»¥åŠå®ƒå¦‚ä½•æˆä¸ºè‡ªåŠ¨åŒ–è§£é¢˜çš„åŸºçŸ³ã€‚

ç¬¦å·æ‰§è¡Œæ˜¯ä¸€ç§ç¨‹åºåˆ†ææŠ€æœ¯ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**ä½¿ç”¨ç¬¦å·ï¼ˆå³æœªçŸ¥å˜é‡ï¼Œå¦‚ `x`ï¼‰ä»£æ›¿ç¨‹åºè¾“å…¥çš„å…·ä½“å€¼ï¼Œè®©ç¨‹åºåœ¨ç¬¦å·çŠ¶æ€ä¸‹æ‰§è¡Œï¼Œå¹¶æ”¶é›†æ‰§è¡Œè·¯å¾„ä¸Šçš„æ‰€æœ‰çº¦æŸæ¡ä»¶ï¼Œæœ€åé€šè¿‡æ±‚è§£è¿™äº›çº¦æŸæ¥å¾—åˆ°èƒ½ä½¿ç¨‹åºåˆ°è¾¾ç›®æ ‡çŠ¶æ€çš„å…·ä½“è¾“å…¥å€¼ã€‚**

### ç¬¦å·æ‰§è¡Œè¿‡ç¨‹ç¤ºä¾‹
è€ƒè™‘ä¸€ä¸ªç®€å•çš„ç¨‹åºæµç¨‹ï¼š
1.  ç¨‹åºè¦æ±‚è¾“å…¥ä¸€ä¸ªå€¼ `x`ã€‚
2.  å¦‚æœ `x >= 5`ï¼Œåˆ™æ‰§è¡Œè·¯å¾„ Aï¼›å¦åˆ™æ‰§è¡Œè·¯å¾„ Bã€‚
3.  åœ¨è·¯å¾„ A ä¸­ï¼Œå¦‚æœ `x < 50`ï¼Œåˆ™åˆ°è¾¾ç›®æ ‡ï¼ˆæˆåŠŸï¼‰ï¼›å¦åˆ™å¤±è´¥ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_7.png)

ä¼ ç»ŸåŠ¨æ€åˆ†æéœ€è¦è¾“å…¥ä¸€ä¸ªå…·ä½“å€¼ï¼ˆå¦‚ `10`ï¼‰æ¥æµ‹è¯•ä¸€æ¡è·¯å¾„ã€‚è€Œç¬¦å·æ‰§è¡Œåˆ™ï¼š
*   å°†è¾“å…¥è®¾ç½®ä¸ºç¬¦å· `x`ã€‚
*   åŒæ—¶æ¢ç´¢è·¯å¾„ A å’Œè·¯å¾„ Bã€‚
*   å¯¹äºè·¯å¾„ Aï¼Œæ”¶é›†çº¦æŸæ¡ä»¶ï¼š`x >= 5` ä¸” `x < 50`ã€‚
*   æ±‚è§£å™¨ï¼ˆå¦‚ Z3ï¼‰ä¼šæ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³è¯¥çº¦æŸçš„å…·ä½“å€¼ï¼ˆä¾‹å¦‚ `20`ï¼‰ï¼Œè¿™ä¸ªå€¼å°±æ˜¯èƒ½ä½¿ç¨‹åºåˆ°è¾¾ç›®æ ‡çš„æœ‰æ•ˆè¾“å…¥ã€‚

**å…¬å¼åŒ–æè¿°**ï¼š ç¬¦å·æ‰§è¡Œæ—¨åœ¨æ±‚è§£æ»¡è¶³è·¯å¾„çº¦æŸ **Ï†(path)** çš„è¾“å…¥å˜é‡ **x** çš„å€¼ï¼Œä½¿å¾—ç¨‹åºèƒ½åˆ°è¾¾ç›®æ ‡çŠ¶æ€ **target_state**ã€‚å³æ±‚è§£ **âˆƒx: Ï†(path(x)) âˆ§ (state(x) == target_state)**ã€‚

è¿™ç§æ–¹æ³•å¯ä»¥é¿å…æ‰‹åŠ¨é€†å‘å¤æ‚ç®—æ³•ï¼Œè‡ªåŠ¨éå†æ‰€æœ‰å¯èƒ½çš„è·¯å¾„å¹¶æ‰¾åˆ°é€šå…³æ¡ä»¶ã€‚

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šé™æ€åˆ†æä¸åŠ¨æ€åˆ†æç®€ä»‹

åœ¨æ·±å…¥è‡ªåŠ¨åŒ–å·¥å…·ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€è¦å›é¡¾ä¼ ç»Ÿåˆ†ææ–¹æ³•ï¼Œä»¥ç†è§£è‡ªåŠ¨åŒ–å·¥å…·çš„ä¼˜åŠ¿ã€‚

ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„äºŒè¿›åˆ¶åˆ†æå·¥å…·å’Œæ–¹æ³•ï¼š

![](img/680ae1ed515966b15d367bd1a71209f2_9.png)

![](img/680ae1ed515966b15d367bd1a71209f2_11.png)

*   **`file` å‘½ä»¤**ï¼š æŸ¥çœ‹æ–‡ä»¶ç±»å‹ã€æ¶æ„ï¼ˆå¦‚ 32/64 ä½ï¼‰ã€‚
*   **`strings` å‘½ä»¤**ï¼š æå–æ–‡ä»¶ä¸­æ‰€æœ‰å¯æ‰“å°å­—ç¬¦ä¸²ï¼Œæœ‰æ—¶èƒ½ç›´æ¥å‘ç° Flagã€‚
*   **`ltrace` / `strace` å‘½ä»¤**ï¼š è·Ÿè¸ªç¨‹åºè°ƒç”¨çš„åº“å‡½æ•°æˆ–ç³»ç»Ÿè°ƒç”¨ã€‚
*   **é™æ€åˆ†æå·¥å…· (IDA Pro, Ghidra)**ï¼š åæ±‡ç¼–ç¨‹åºï¼ŒæŸ¥çœ‹æ§åˆ¶æµå›¾ï¼Œå°†æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæ›´æ˜“è¯»çš„ä¼ªä»£ç ã€‚
*   **åŠ¨æ€è°ƒè¯•å·¥å…· (GDB, OllyDbg)**ï¼š è¿è¡Œç¨‹åºï¼Œé€æ­¥æ‰§è¡Œï¼Œå®æ—¶æŸ¥çœ‹å’Œä¿®æ”¹å¯„å­˜å™¨ã€å†…å­˜å€¼ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_13.png)

![](img/680ae1ed515966b15d367bd1a71209f2_15.png)

### æ–¹æ³•å¯¹æ¯”
*   **é™æ€åˆ†æ**ï¼š
    *   *ä¼˜ç‚¹*ï¼š å¯ä»¥æŸ¥çœ‹å…¨éƒ¨ä»£ç ï¼Œå‘ç°æ‰€æœ‰æ‰§è¡Œè·¯å¾„ã€‚
    *   *ç¼ºç‚¹*ï¼š éš¾ä»¥ç†è§£ç¨‹åºåŠ¨æ€äº¤äº’é€»è¾‘ï¼Œå…¥å£ç‚¹å¯èƒ½éš¾ä»¥å®šä½ã€‚
*   **åŠ¨æ€åˆ†æ**ï¼š
    *   *ä¼˜ç‚¹*ï¼š å¯ä»¥è§‚å¯Ÿç¨‹åºè¿è¡Œæ—¶çŠ¶æ€ï¼Œäº¤äº’æ¸…æ™°ã€‚
    *   *ç¼ºç‚¹*ï¼š ä¸€æ¬¡è¿è¡Œåªèƒ½è¦†ç›–ä¸€æ¡è·¯å¾„ï¼Œè·¯å¾„çˆ†ç‚¸æ—¶éš¾ä»¥ç©·å°½ï¼›å¯èƒ½è§¦å‘åè°ƒè¯•æœºåˆ¶ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_17.png)

![](img/680ae1ed515966b15d367bd1a71209f2_19.png)

![](img/680ae1ed515966b15d367bd1a71209f2_21.png)

![](img/680ae1ed515966b15d367bd1a71209f2_23.png)

![](img/680ae1ed515966b15d367bd1a71209f2_25.png)

ç¬¦å·æ‰§è¡ŒæŠ€æœ¯ç»“åˆäº†äºŒè€…çš„ä¼˜ç‚¹ï¼š**åƒé™æ€åˆ†æä¸€æ ·æ¢ç´¢æ‰€æœ‰è·¯å¾„ï¼ŒåˆåƒåŠ¨æ€åˆ†æä¸€æ ·å¤„ç†å…·ä½“çš„ç¨‹åºçŠ¶æ€**ã€‚

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šä½¿ç”¨ Angr è¿›è¡Œè‡ªåŠ¨åŒ–è·¯å¾„æ¢ç´¢

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†ç¬¦å·æ‰§è¡Œçš„åŸç†ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åˆ©ç”¨ **Angr** æ¡†æ¶å®é™…è¿›è¡Œè‡ªåŠ¨åŒ–è§£é¢˜ã€‚

Angr æ˜¯ä¸€ä¸ªåŸºäº Python çš„äºŒè¿›åˆ¶åˆ†æå¹³å°ï¼Œå®ƒé›†æˆäº†ç¬¦å·æ‰§è¡Œã€æ§åˆ¶æµåˆ†æã€æ¼æ´æŒ–æ˜ç­‰åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§æ¶æ„ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_27.png)

![](img/680ae1ed515966b15d367bd1a71209f2_29.png)

### å®‰è£… Angr
æ¨èåœ¨ Linux ç¯å¢ƒï¼ˆå¦‚ Ubuntuï¼‰ä¸‹å®‰è£…ã€‚å¯ä»¥ä½¿ç”¨ pip å®‰è£…ï¼š
```bash
pip install angr
```
æˆ–è€…ä½¿ç”¨ Docker é•œåƒä»¥è·å–å®Œæ•´ç¯å¢ƒã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_31.png)

![](img/680ae1ed515966b15d367bd1a71209f2_33.png)

### å®æˆ˜ 1ï¼šAngr åŸºç¡€ç ´è§£
æˆ‘ä»¬ä»¥ä¸€ä¸ªç®€å•çš„ CTF é€†å‘é¢˜ `r100` ä¸ºä¾‹ã€‚ç¨‹åºä¼šè¦æ±‚è¾“å…¥ä¸€ä¸ªå¯†ç ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_35.png)

![](img/680ae1ed515966b15d367bd1a71209f2_37.png)

**è§£é¢˜æ€è·¯**ï¼š
1.  ç”¨ IDA ç­‰å·¥å…·æ‰¾åˆ°ç¨‹åºè¾“å‡ºæˆåŠŸä¿¡æ¯ï¼ˆå¦‚ `"Nice!"`ï¼‰å’Œå¤±è´¥ä¿¡æ¯ï¼ˆå¦‚ `"Incorrect password"`ï¼‰çš„åœ°å€ã€‚
2.  ç¼–å†™ Angr è„šæœ¬ï¼Œè®©å…¶ä»ç¨‹åºå…¥å£å¼€å§‹ç¬¦å·æ‰§è¡Œï¼Œæ¢ç´¢è·¯å¾„ã€‚
3.  è®¾å®šç›®æ ‡åœ°å€ä¸ºæˆåŠŸåœ°å€ï¼Œé¿å…åœ°å€ä¸ºå¤±è´¥åœ°å€ã€‚
4.  è®© Angr è‡ªåŠ¨æ±‚è§£å‡ºèƒ½åˆ°è¾¾æˆåŠŸåœ°å€çš„è¾“å…¥ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_39.png)

![](img/680ae1ed515966b15d367bd1a71209f2_41.png)

**æ ¸å¿ƒä»£ç æ¨¡æ¿**ï¼š
```python
import angr

![](img/680ae1ed515966b15d367bd1a71209f2_43.png)

![](img/680ae1ed515966b15d367bd1a71209f2_45.png)

# åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸è‡ªåŠ¨åŠ è½½ä¾èµ–åº“ï¼ˆé€‚ç”¨äºå¤§éƒ¨åˆ†CTFé¢˜ï¼‰
proj = angr.Project('./r100', auto_load_libs=False)

![](img/680ae1ed515966b15d367bd1a71209f2_47.png)

![](img/680ae1ed515966b15d367bd1a71209f2_49.png)

# åˆ›å»ºåˆå§‹çŠ¶æ€ï¼ˆä»ç¨‹åºå…¥å£å¼€å§‹ï¼‰
state = proj.factory.entry_state()

![](img/680ae1ed515966b15d367bd1a71209f2_51.png)

![](img/680ae1ed515966b15d367bd1a71209f2_53.png)

![](img/680ae1ed515966b15d367bd1a71209f2_55.png)

![](img/680ae1ed515966b15d367bd1a71209f2_57.png)

# åˆ›å»ºæ¨¡æ‹Ÿç®¡ç†å™¨ï¼Œç”¨äºè·¯å¾„æ¢ç´¢
simgr = proj.factory.simulation_manager(state)

![](img/680ae1ed515966b15d367bd1a71209f2_59.png)

![](img/680ae1ed515966b15d367bd1a71209f2_61.png)

![](img/680ae1ed515966b15d367bd1a71209f2_63.png)

![](img/680ae1ed515966b15d367bd1a71209f2_65.png)

# æŒ‡å®šç›®æ ‡åœ°å€å’Œé¿å…çš„åœ°å€ï¼ˆéœ€é€šè¿‡IDAåˆ†æè·å¾—ï¼‰
find_addr = 0x400844  # ä¾‹å¦‚ "Nice!" çš„åœ°å€
avoid_addr = 0x400855 # ä¾‹å¦‚ "Incorrect password" çš„åœ°å€

# å¼€å§‹æ¢ç´¢ï¼Œå¯»æ‰¾é€šå‘ find_addr çš„è·¯å¾„ï¼Œé¿å¼€ avoid_addr
simgr.explore(find=find_addr, avoid=avoid_addr)

![](img/680ae1ed515966b15d367bd1a71209f2_67.png)

# æ‰“å°æ‰¾åˆ°çš„è§£å†³æ–¹æ¡ˆï¼ˆå³æ­£ç¡®è¾“å…¥ï¼‰
if simgr.found:
    solution_state = simgr.found[0]
    # å‡è®¾è¾“å…¥æ˜¯ä»æ ‡å‡†è¯»å–çš„ï¼Œå¹¶å­˜å‚¨åœ¨ç‰¹å®šçš„ä½ç½®ï¼Œè¿™é‡Œæ‰“å°æ ‡å‡†è¾“å…¥çš„å†…å®¹
    print(solution_state.posix.dumps(0))  # dumps(0) è¡¨ç¤ºæ ‡å‡†è¾“å…¥
else:
    print("No solution found")
```
è¿è¡Œè„šæœ¬åï¼ŒAngr ä¼šè¾“å‡ºæ±‚è§£å‡ºçš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ `b'Code_Talkers'`ï¼Œè¿™å°±æ˜¯æ­£ç¡®çš„å¯†ç ã€‚

---

## ç¬¬å››éƒ¨åˆ†ï¼šå¤„ç†å¸¦å‚æ•°çš„ç¨‹åº

ä¸Šä¸€èŠ‚æˆ‘ä»¬å¤„ç†äº†ä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®çš„ç¨‹åºï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å¤„ç†é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ¥æ”¶è¾“å…¥çš„ç¨‹åºã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_69.png)

å¯¹äºç¨‹åº `ais3_crackme`ï¼Œå®ƒéœ€è¦ä»¥ `./ais3_crackme <secret_key>` çš„å½¢å¼è¿è¡Œã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_71.png)

![](img/680ae1ed515966b15d367bd1a71209f2_73.png)

![](img/680ae1ed515966b15d367bd1a71209f2_75.png)

![](img/680ae1ed515966b15d367bd1a71209f2_77.png)

**è§£é¢˜æ€è·¯**ï¼š
1.  åœ¨åˆ›å»ºåˆå§‹çŠ¶æ€ (`entry_state`) æ—¶ï¼Œéœ€è¦è®¾ç½®ç¨‹åºçš„å‚æ•°åˆ—è¡¨ã€‚
2.  å°†å¾…æ±‚è§£çš„å¯†é’¥è®¾ç½®ä¸ºä¸€ä¸ªç¬¦å·å‘é‡ï¼ˆBitVectorï¼‰ã€‚
3.  å…¶ä½™æ­¥éª¤ä¸åŸºç¡€ç ´è§£ç±»ä¼¼ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_79.png)

![](img/680ae1ed515966b15d367bd1a71209f2_81.png)

**æ ¸å¿ƒä»£ç æ¨¡æ¿**ï¼š
```python
import angr
import claripy  # Angr çš„çº¦æŸæ±‚è§£æ¨¡å—ï¼Œç”¨äºåˆ›å»ºç¬¦å·

proj = angr.Project('./ais3_crackme', auto_load_libs=False)

![](img/680ae1ed515966b15d367bd1a71209f2_83.png)

![](img/680ae1ed515966b15d367bd1a71209f2_85.png)

![](img/680ae1ed515966b15d367bd1a71209f2_87.png)

![](img/680ae1ed515966b15d367bd1a71209f2_89.png)

![](img/680ae1ed515966b15d367bd1a71209f2_91.png)

![](img/680ae1ed515966b15d367bd1a71209f2_93.png)

# åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 50*8 æ¯”ç‰¹çš„ç¬¦å·å‘é‡ï¼Œä»£è¡¨å‘½ä»¤è¡Œå‚æ•°ï¼ˆå­—ç¬¦ä¸²ï¼‰
# BVS è¡¨ç¤º BitVector Symbol
arg1 = claripy.BVS('arg1', 50 * 8)

![](img/680ae1ed515966b15d367bd1a71209f2_95.png)

# åˆ›å»ºåˆå§‹çŠ¶æ€ï¼Œå¹¶è®¾ç½®å‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯ç¨‹åºåï¼Œç¬¬äºŒä¸ªæ˜¯æˆ‘ä»¬çš„ç¬¦å·å‚æ•°
state = proj.factory.entry_state(args=['./ais3_crackme', arg1])

![](img/680ae1ed515966b15d367bd1a71209f2_97.png)

![](img/680ae1ed515966b15d367bd1a71209f2_99.png)

simgr = proj.factory.simulation_manager(state)

![](img/680ae1ed515966b15d367bd1a71209f2_101.png)

![](img/680ae1ed515966b15d367bd1a71209f2_103.png)

# é€šè¿‡IDAåˆ†ææ‰¾åˆ°æˆåŠŸå’Œå¤±è´¥åœ°å€
find_addr = 0x400602  # "Correct" åœ°å€
avoid_addr = 0x4005F7 # "I'm sorry" åœ°å€

![](img/680ae1ed515966b15d367bd1a71209f2_105.png)

simgr.explore(find=find_addr, avoid=avoid_addr)

if simgr.found:
    solution_state = simgr.found[0]
    # è·å–ç¬¦å·å‚æ•° arg1 çš„æ±‚è§£ç»“æœï¼Œå¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    solved_arg1 = solution_state.solver.eval(arg1, cast_to=bytes)
    print(solved_arg1.rstrip(b'\x00'))  # å»é™¤æœ«å°¾çš„å¡«å……ç©ºå­—ç¬¦
else:
    print("No solution found")
```
è¿è¡Œè„šæœ¬åï¼Œå°†å¾—åˆ°æ­£ç¡®çš„å¯†é’¥ï¼Œæ ¼å¼å¯èƒ½ä¸º `b'flag{...}'`ã€‚

---

![](img/680ae1ed515966b15d367bd1a71209f2_107.png)

![](img/680ae1ed515966b15d367bd1a71209f2_109.png)

![](img/680ae1ed515966b15d367bd1a71209f2_111.png)

## ç¬¬äº”éƒ¨åˆ†ï¼šä½¿ç”¨ Z3 æ±‚è§£å™¨å¤„ç†å¤æ‚çº¦æŸ

![](img/680ae1ed515966b15d367bd1a71209f2_113.png)

![](img/680ae1ed515966b15d367bd1a71209f2_115.png)

![](img/680ae1ed515966b15d367bd1a71209f2_117.png)

Angr é€‚åˆå¤„ç†å®Œæ•´çš„ã€è·¯å¾„æ¸…æ™°çš„ç¨‹åºã€‚ä½†å½“é¢å¯¹çº¯ç®—æ³•ã€ä»£ç ç‰‡æ®µæˆ–è·¯å¾„çˆ†ç‚¸ï¼ˆå¦‚å¤§é‡éšæœºæ•°åˆ†æ”¯ï¼‰çš„é—®é¢˜æ—¶ï¼Œæ›´åº•å±‚çš„ **Z3** æ±‚è§£å™¨å¯èƒ½æ›´é«˜æ•ˆã€‚Z3 æ˜¯å¾®è½¯å¼€å‘çš„é«˜æ€§èƒ½å®šç†è¯æ˜å™¨ï¼ŒAngr çš„çº¦æŸæ±‚è§£åç«¯å°±æ˜¯ Z3ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_119.png)

### Z3 åŸºç¡€
Z3 å¯ä»¥ç›´æ¥æ±‚è§£æ–¹ç¨‹ç»„å’Œé€»è¾‘çº¦æŸã€‚ä¾‹å¦‚ï¼Œæ±‚è§£ï¼š
*   `x + y == 6`
*   `2*x == 3*y + 6`

**Z3 æ±‚è§£ä»£ç **ï¼š
```python
from z3 import *

# å®šä¹‰å˜é‡
x = Real('x')
y = Real('y')

# åˆ›å»ºæ±‚è§£å™¨
s = Solver()

![](img/680ae1ed515966b15d367bd1a71209f2_121.png)

![](img/680ae1ed515966b15d367bd1a71209f2_123.png)

# æ·»åŠ çº¦æŸæ¡ä»¶
s.add(x + y == 6)
s.add(2*x == 3*y + 6)

# æ£€æŸ¥æ˜¯å¦æœ‰è§£
if s.check() == sat:  # sat è¡¨ç¤ºå¯æ»¡è¶³ï¼ˆæœ‰è§£ï¼‰
    m = s.model()     # è·å–æ¨¡å‹ï¼ˆè§£ï¼‰
    print(f"x = {m[x]}")
    print(f"y = {m[y]}")
else:
    print("æ— è§£")
```
è¿è¡Œåå°†è¾“å‡º `x = 24/5`, `y = 6/5`ã€‚

### Z3 æ”¯æŒçš„æ•°æ®ç±»å‹å’Œæ“ä½œ
*   **å¸¸ç”¨ç±»å‹**ï¼š `BitVec('a', 32)` (32ä½ä½å‘é‡ï¼Œç±»ä¼¼ int), `Real('x')` (å®æ•°), `Bool('p')` (å¸ƒå°”å€¼)ã€‚
*   **è¿ç®—**ï¼š æ ‡å‡†ç®—æœ¯å’Œé€»è¾‘è¿ç®— (`+, -, *, /, &, |, ^, ==, !=, <, >` ç­‰)ã€‚
*   **æ— ç¬¦å·æ•°æ¯”è¾ƒ**ï¼š å¯¹äºæ— ç¬¦å·ä½å‘é‡ï¼Œéœ€ä½¿ç”¨ `ULT` (æ— ç¬¦å·å°äº), `ULE` (æ— ç¬¦å·å°äºç­‰äº) ç­‰ä¸“ç”¨æ“ä½œã€‚

### å®æˆ˜ 2ï¼šä½¿ç”¨ Z3 é€†å‘ç®—æ³•
å‡è®¾æœ‰ä¸€æ®µ C ä»£ç éªŒè¯å‡½æ•°ï¼Œå…¶æ ¸å¿ƒæ˜¯å¤æ‚çš„ç®—æœ¯å’Œé€»è¾‘è¿ç®—ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿ç®—è¿‡ç¨‹ç”¨ Z3 çš„è¯­æ³•é‡å†™ï¼Œå°†è¾“å…¥è®¾ä¸ºç¬¦å·å˜é‡ï¼Œè®© Z3 æ±‚è§£å‡ºæ»¡è¶³æœ€ç»ˆéªŒè¯æ¡ä»¶çš„è¾“å…¥å€¼ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_125.png)

![](img/680ae1ed515966b15d367bd1a71209f2_127.png)

**é€šç”¨è§£é¢˜æ¨¡æ¿**ï¼š
```python
from z3 import *

# å®šä¹‰è¾“å…¥ç¬¦å·å˜é‡ï¼Œä¾‹å¦‚ä¸€ä¸ª 32 ä½çš„æ•°ï¼ˆå¯èƒ½ä»£è¡¨4ä¸ªå­—ç¬¦ï¼‰
inp = BitVec('inp', 32)

s = Solver()

# æ ¹æ®é€†å‘å‡ºçš„ç®—æ³•ï¼Œæ·»åŠ çº¦æŸæ¡ä»¶
# ä¾‹å¦‚ï¼š (inp * 0x12345678) & 0xFFFF == 0xABCD
s.add((inp * 0x12345678) & 0xFFFF == 0xABCD)

# å¯ä»¥æ·»åŠ é¢å¤–çº¦æŸï¼Œå¦‚è¾“å…¥æ˜¯å¯æ‰“å°å­—ç¬¦
for i in range(4):
    byte = Extract(8*i+7, 8*i, inp)  # æå–ç¬¬ i ä¸ªå­—èŠ‚
    s.add(byte >= 0x20, byte <= 0x7E) # å¯æ‰“å° ASCII èŒƒå›´

if s.check() == sat:
    m = s.model()
    solved_inp = m[inp].as_long()
    # å°†æ•´æ•°è½¬æ¢ä¸ºå­—èŠ‚å­—ç¬¦ä¸²ï¼ˆæ³¨æ„å¤§å°ç«¯ï¼‰
    flag = solved_inp.to_bytes(4, 'little')
    print(f"Found input: {flag}")
else:
    print("No solution")
```

![](img/680ae1ed515966b15d367bd1a71209f2_129.png)

![](img/680ae1ed515966b15d367bd1a71209f2_131.png)

---

![](img/680ae1ed515966b15d367bd1a71209f2_133.png)

## ç¬¬å…­éƒ¨åˆ†ï¼šç»¼åˆå®æˆ˜â€”â€”å¤æ‚éšæœºæ•°é—®é¢˜

![](img/680ae1ed515966b15d367bd1a71209f2_135.png)

![](img/680ae1ed515966b15d367bd1a71209f2_137.png)

æœ‰äº›é¢˜ç›®ç»“åˆäº†éšæœºæ•°ï¼Œä½¿å¾—è·¯å¾„æ•°å‰§å¢ï¼ŒAngr ç›´æ¥æ¢ç´¢æ•ˆç‡ä½ä¸‹ã€‚è¿™æ—¶éœ€è¦ç»“åˆé™æ€åˆ†æã€åŠ¨æ€è°ƒè¯•ä¸ Z3 æ±‚è§£ã€‚

**è§£é¢˜æ€è·¯ï¼ˆä»¥æŸ CTF é¢˜ä¸ºä¾‹ï¼‰**ï¼š
1.  **é™æ€åˆ†æ (IDA)**ï¼š å®šä½ç¨‹åºä¸»è¦éªŒè¯é€»è¾‘ï¼Œå‘ç°å…¶ä½¿ç”¨ `srand(seed)` åˆå§‹åŒ–éšæœºæ•°ï¼Œ`seed` ç”±ç”¨æˆ·è¾“å…¥çš„ç¬¬ä¸€éƒ¨åˆ†è®¡ç®—å¾—å‡ºã€‚åç»­éªŒè¯ä½¿ç”¨ `rand()` ç”Ÿæˆå¤šä¸ªå€¼å‚ä¸è¿ç®—ã€‚
2.  **ç¬¬ä¸€éƒ¨åˆ†æ±‚è§£**ï¼š ç”±äº `seed` çš„è®¡ç®—æ˜¯ç¡®å®šçš„ï¼ˆæ— éšæœºæ•°ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ **SymPy**ï¼ˆç¬¦å·æ•°å­¦åº“ï¼‰æˆ– **Z3** ç›´æ¥æ±‚è§£å‡ºèƒ½äº§ç”Ÿæ­£ç¡® `seed` çš„è¾“å…¥ç¬¬ä¸€éƒ¨åˆ†ã€‚
3.  **åŠ¨æ€è°ƒè¯•è·å–éšæœºåºåˆ—**ï¼š å› ä¸º `srand(seed)` å›ºå®šåï¼Œ`rand()` åºåˆ—æ˜¯å›ºå®šçš„ã€‚ä½¿ç”¨è°ƒè¯•å™¨ï¼ˆå¦‚ GDB é…åˆ IDAï¼‰è¿è¡Œç¨‹åºï¼Œåœ¨è¾“å…¥ç¬¬ä¸€éƒ¨åˆ†åï¼Œè®¾ç½® `seed` ä¸ºæˆ‘ä»¬æ±‚è§£å‡ºçš„å€¼ï¼Œç„¶åæ­¥è¿›ç¨‹åºï¼Œä»å†…å­˜ä¸­æå–å‡ºåç»­ `rand()` ç”Ÿæˆçš„æ‰€æœ‰ç¡®å®šå€¼ã€‚
4.  **ç¬¬äºŒéƒ¨åˆ†æ±‚è§£**ï¼š å°†æå–å‡ºçš„éšæœºæ•°ä½œä¸ºå·²çŸ¥å¸¸é‡ï¼Œä»£å…¥åˆ°ç¬¬äºŒé˜¶æ®µçš„éªŒè¯ç®—æ³•ä¸­ã€‚å†æ¬¡ä½¿ç”¨ **Z3**ï¼Œå°†ç”¨æˆ·è¾“å…¥çš„ç¬¬äºŒéƒ¨åˆ†è®¾ä¸ºç¬¦å·å˜é‡ï¼Œå»ºç«‹æ–¹ç¨‹å¹¶æ±‚è§£ã€‚
5.  **ç»„åˆè¾“å…¥**ï¼š å°†ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬äºŒéƒ¨åˆ†æ±‚è§£ç»“æœåˆå¹¶ï¼Œå³ä¸ºå®Œæ•´ Flagã€‚

è¿™ç§æ–¹æ³•é¿å…äº† Angr åœ¨æ— æ•°éšæœºåˆ†æ”¯ä¸­æŒ£æ‰ï¼Œé€šè¿‡â€œåˆ†è€Œæ²»ä¹‹â€å’ŒåŠ¨æ€è°ƒè¯•è·å–å…³é”®ä¸­é—´çŠ¶æ€ï¼Œå¤§å¤§æå‡äº†æ±‚è§£æ•ˆç‡ã€‚

---

## æ€»ç»“
æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†äºŒè¿›åˆ¶è‡ªåŠ¨åŒ–è§£é¢˜çš„æ ¸å¿ƒæŠ€æœ¯ï¼š

![](img/680ae1ed515966b15d367bd1a71209f2_139.png)

![](img/680ae1ed515966b15d367bd1a71209f2_141.png)

1.  **ç¬¦å·æ‰§è¡ŒåŸç†**ï¼š ç”¨ç¬¦å·ä»£æ›¿å…·ä½“è¾“å…¥ï¼Œé€šè¿‡æ”¶é›†å’Œæ±‚è§£è·¯å¾„çº¦æŸæ¥è·å¾—æœ‰æ•ˆè¾“å…¥ã€‚
2.  **Angr æ¡†æ¶**ï¼š ç”¨äºè‡ªåŠ¨åŒ–åˆ†æäºŒè¿›åˆ¶ç¨‹åºï¼Œè‡ªåŠ¨æ¢ç´¢è·¯å¾„å¹¶æ±‚è§£ï¼Œéå¸¸é€‚åˆå¤„ç†é€»è¾‘æ¸…æ™°ã€è·¯å¾„å¯æ§çš„é€†å‘é¢˜ã€‚
3.  **Z3 æ±‚è§£å™¨**ï¼š å¼ºå¤§çš„çº¦æŸæ±‚è§£å¼•æ“ï¼Œé€‚åˆå¤„ç†å¤æ‚çš„ç®—æ³•é€†å‘å’Œæ•°å­¦çº¦æŸé—®é¢˜ï¼Œå¯ä½œä¸º Angr çš„åº•å±‚æˆ–ç‹¬ç«‹ä½¿ç”¨ã€‚
4.  **æ··åˆç­–ç•¥**ï¼š é¢å¯¹å¤æ‚é¢˜ç›®ï¼ˆå¦‚å«éšæœºæ•°ï¼‰ï¼Œéœ€ç»“åˆé™æ€åˆ†æã€åŠ¨æ€è°ƒè¯•ä¸è‡ªåŠ¨åŒ–æ±‚è§£å·¥å…·ï¼Œå„å–æ‰€é•¿ã€‚

![](img/680ae1ed515966b15d367bd1a71209f2_143.png)

é€šè¿‡æŒæ¡è¿™äº›è‡ªåŠ¨åŒ–æŠ€æœ¯ï¼Œä½ å¯ä»¥æ˜¾è‘—æé«˜è§£å†³äºŒè¿›åˆ¶é€†å‘é¢˜ç›®çš„æ•ˆç‡ï¼Œå°†é‡å¿ƒä»ç¹ççš„æŒ‡ä»¤åˆ†æè½¬ç§»åˆ°æ›´é«˜å±‚çš„é€»è¾‘ç†è§£å’Œå·¥å…·è¿ç”¨ä¸Šã€‚å¸Œæœ›æœ¬æ•™ç¨‹èƒ½ä¸ºä½ æ‰“å¼€äºŒè¿›åˆ¶å®‰å…¨è‡ªåŠ¨åŒ–åˆ†æçš„å¤§é—¨ã€‚