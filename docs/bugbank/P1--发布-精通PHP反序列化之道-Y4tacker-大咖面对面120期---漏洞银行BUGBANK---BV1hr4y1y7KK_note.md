# è¯¾ç¨‹ P1ï¼šç²¾é€š PHP ååºåˆ—åŒ–ä¹‹é“ ğŸš€

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_1.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†è¦å­¦ä¹  PHP ååºåˆ—åŒ–çš„æ ¸å¿ƒæ¦‚å¿µã€æ”»å‡»é“¾ï¼ˆPOPé“¾ï¼‰çš„æ„é€ æ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ Phar ååºåˆ—åŒ–ç­‰æ–¹å¼æ‹“å±•æ”»å‡»é¢ã€‚è¯¾ç¨‹å†…å®¹ä»åŸºç¡€æ¦‚å¿µå…¥æ‰‹ï¼Œé€æ­¥æ·±å…¥åˆ°å®æˆ˜åˆ©ç”¨ï¼Œæ—¨åœ¨è®©åˆå­¦è€…èƒ½å¤Ÿç†è§£å¹¶æŒæ¡ PHP ååºåˆ—åŒ–çš„åŸºæœ¬åŸç†å’Œåˆ©ç”¨æŠ€å·§ã€‚

---

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_3.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_5.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_7.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_9.png)

## åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åŸºç¡€

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_11.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_13.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_15.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_17.png)

åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ˜¯ä¸€ä¸ªç›¸å¯¹çš„è¿‡ç¨‹ã€‚åºåˆ—åŒ–çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³å¦‚ä½•åœ¨ç½‘ç»œä¼ è¾“æˆ–æŒä¹…åŒ–å­˜å‚¨ä¸­ä¿å­˜ä¸€ä¸ªå¯¹è±¡çš„é—®é¢˜ã€‚åºåˆ—åŒ–å¯¹åº”çš„å‡½æ•°æ˜¯ `serialize`ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ååºåˆ—åŒ–å¯¹åº”çš„å‡½æ•°æ˜¯ `unserialize`ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†å­—ç¬¦ä¸²æ¢å¤æˆåŸæ¥çš„å¯¹è±¡ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_19.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_21.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_23.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_25.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_27.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_29.png)

ä»¥ä¸‹æ˜¯ PHP ä¸­ä¸€äº›å¸¸è§çš„é­”æœ¯æ–¹æ³•ï¼Œå®ƒä»¬åœ¨ååºåˆ—åŒ–åˆ©ç”¨é“¾ä¸­æ‰®æ¼”ç€å…³é”®è§’è‰²ï¼š
*   `__destruct()`: å¯¹è±¡é”€æ¯æ—¶è‡ªåŠ¨è°ƒç”¨ã€‚
*   `__toString()`: å¯¹è±¡è¢«å½“ä½œå­—ç¬¦ä¸²ä½¿ç”¨æ—¶è‡ªåŠ¨è°ƒç”¨ã€‚
*   `__get()` / `__set()`: è®¿é—®æˆ–è®¾ç½®ä¸å¯è®¿é—®å±æ€§æ—¶è‡ªåŠ¨è°ƒç”¨ã€‚
*   `__invoke()`: å°è¯•ä»¥è°ƒç”¨å‡½æ•°çš„æ–¹å¼è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ—¶è‡ªåŠ¨è°ƒç”¨ã€‚
*   `__wakeup()`: åœ¨ååºåˆ—åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨ï¼Œå¸¸ç”¨äºä¿®å¤æˆ–å®‰å…¨æ£€æŸ¥ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_31.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_33.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_35.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†åºåˆ—åŒ–çš„åŸºæœ¬æ¦‚å¿µï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å¯»æ‰¾å’Œåˆ©ç”¨ååºåˆ—åŒ–é“¾ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_37.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_39.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_41.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_43.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_44.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_46.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_48.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_49.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_51.png)

---

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_53.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_55.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_57.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_59.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_61.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_63.png)

## å¯»æ‰¾ä¸åˆ©ç”¨ POP é“¾

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_65.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_67.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_69.png)

å¾ˆå¤šæ—¶å€™ï¼Œååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨ä»£ç å¹¶ä¸ä¼šç›´æ¥å‡ºç°åœ¨åƒ `__destruct` è¿™æ ·çš„é­”æœ¯æ–¹æ³•é‡Œã€‚å®ƒé€šå¸¸éšè—åœ¨æ™®é€šçš„ç±»æ–¹æ³•ä¸­ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦æ„é€ ä¸€æ¡å±æ€§å¯¼å‘ç¼–ç¨‹ï¼ˆPOPï¼‰é“¾æ¥è¿æ¥è¿™äº›æ–¹æ³•ï¼Œæœ€ç»ˆè¾¾åˆ°æ‰§è¡Œä»»æ„ä»£ç çš„ç›®çš„ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_71.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_73.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_75.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_77.png)

POP é“¾çš„æ„é€ æ€è·¯æ˜¯ï¼šä»ä¸€ä¸ªå¯è§¦å‘çš„é­”æœ¯æ–¹æ³•ï¼ˆå¦‚ `__destruct`ï¼‰å¼€å§‹ï¼Œé€šè¿‡æ§åˆ¶å¯¹è±¡çš„å±æ€§ï¼Œä½¿å…¶è°ƒç”¨å¦ä¸€ä¸ªç±»çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆå¯èƒ½è§¦å‘å¦ä¸€ä¸ªé­”æœ¯æ–¹æ³•ï¼ˆå¦‚ `__toString`ï¼‰ï¼Œå¦‚æ­¤ä¸²è”ï¼Œæœ€ç»ˆåˆ°è¾¾æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å±é™©å‡½æ•°ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_79.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_81.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_83.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_84.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_86.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_88.png)

ä¾‹å¦‚ï¼Œè€ƒè™‘ä»¥ä¸‹ç®€åŒ–åœºæ™¯ï¼š
1.  ç±» A çš„ `__destruct` æ–¹æ³•ä¼šæ‰“å°å…¶ `$a` å±æ€§ã€‚
2.  å¦‚æœæˆ‘ä»¬èƒ½å°† `$a` è®¾ç½®ä¸ºç±» B çš„å¯¹è±¡ã€‚
3.  é‚£ä¹ˆå½“æ‰“å° `$a` æ—¶ï¼Œå°±ä¼šè§¦å‘ç±» B çš„ `__toString` æ–¹æ³•ã€‚
4.  åœ¨ç±» B çš„ `__toString` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾ç½®æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ä»£ç ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_90.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_92.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_94.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_96.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_98.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_100.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_102.png)

è¿™æ ·ï¼Œæˆ‘ä»¬å°±é€šè¿‡ `__destruct` -> `__toString` è¿™æ¡é“¾ï¼Œå®ç°äº†ä»å¯¹è±¡é”€æ¯åˆ°å‘½ä»¤æ‰§è¡Œçš„è¿‡ç¨‹ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_104.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_106.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_108.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_110.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_112.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_113.png)

---

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_115.png)

## æ‹“å±•æ”»å‡»é¢ï¼šPhar ååºåˆ—åŒ–

åœ¨å®é™…çš„ CMS æˆ–åº”ç”¨ä¸­ï¼Œå¾ˆå°‘ä¼šç›´æ¥å°† `unserialize` å‡½æ•°æš´éœ²ç»™æˆ‘ä»¬ã€‚é€šå¸¸ï¼Œå®ƒä¼šé€šè¿‡å…¶ä»–æ–¹å¼é—´æ¥è§¦å‘ï¼Œä¾‹å¦‚æ–‡ä»¶åŒ…å«ã€‚è¿™æ—¶ï¼ŒPhar ååºåˆ—åŒ–å°±æˆä¸ºæ‹“å±•æ”»å‡»é¢çš„é‡è¦æ‰‹æ®µã€‚

PHP 5.3 ä»¥åæ”¯æŒç±»ä¼¼ Java JAR çš„æ‰“åŒ…æ–¹å¼ï¼Œç§°ä¸º Pharã€‚å®ƒèƒ½å°†å¤šä¸ª PHP æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶ã€‚å…³é”®åœ¨äºï¼Œ**è®¸å¤šæ–‡ä»¶æ“ä½œå‡½æ•°ï¼ˆå¦‚ `file_get_contents`ã€`file_exists`ã€`include` ç­‰ï¼‰åœ¨é€šè¿‡ `phar://` ä¼ªåè®®å¤„ç† Phar æ–‡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨ååºåˆ—åŒ–å…¶ `metadata` éƒ¨åˆ†çš„æ•°æ®**ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_117.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_119.png)

è¿™æ„å‘³ç€ï¼Œåªè¦æˆ‘ä»¬èƒ½ä¸Šä¼ ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„ Phar æ–‡ä»¶ï¼Œå¹¶è®©åº”ç”¨é€šè¿‡ `phar://` åè®®å»åŒ…å«æˆ–è¯»å–å®ƒï¼Œå°±å¯èƒ½è§¦å‘ååºåˆ—åŒ–æ¼æ´ï¼Œå³ä½¿ä»£ç ä¸­æ²¡æœ‰ç›´æ¥çš„ `unserialize` è°ƒç”¨ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_121.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_122.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_123.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_125.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_127.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_129.png)

ä»¥ä¸‹æ˜¯å—å½±å“çš„å‡½æ•°ä¸¾ä¾‹ï¼ˆéƒ¨åˆ†ï¼‰ï¼š
*   `file_get_contents`
*   `file_exists`
*   `fopen`
*   `include`/`require`
*   `unlink`
*   `copy`
*   `file` ç­‰

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_131.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_133.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_135.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_137.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_139.png)

---

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_141.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_143.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_145.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_147.png)

### ç”Ÿæˆä¸åˆ©ç”¨ Phar æ–‡ä»¶

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_149.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_151.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_153.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_155.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_157.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_159.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_161.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_162.png)

ç”Ÿæˆä¸€ä¸ªåŸºæœ¬çš„ Phar æ–‡ä»¶å¾ˆç®€å•ï¼Œä»£ç å¦‚ä¸‹ï¼š

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_164.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_166.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_168.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_170.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_172.png)

```php
<?php
    class TestObject {}
    $phar = new Phar("test.phar"); // ç”Ÿæˆçš„æ–‡ä»¶å
    $phar->startBuffering();
    $phar->setStub("<?php __HALT_COMPILER(); ?>"); // è®¾ç½®stub
    $object = new TestObject();
    $phar->setMetadata($object); // å°†å¯¹è±¡å­˜å…¥metadata
    $phar->addFromString("test.txt", "test"); // æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶
    $phar->stopBuffering();
?>
```

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_174.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_176.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_178.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_179.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_181.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_183.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_185.png)

æ‰§è¡Œåï¼Œä¼šç”Ÿæˆä¸€ä¸ª `test.phar` æ–‡ä»¶ã€‚å½“åº”ç”¨ä½¿ç”¨ `file_get_contents(â€˜phar://./test.pharâ€™)` æ—¶ï¼Œ`TestObject` å¯¹è±¡å°±ä¼šè¢«ååºåˆ—åŒ–ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_187.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_189.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_191.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_193.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_195.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_197.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_199.png)

---

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_201.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_203.png)

### ç»•è¿‡è¿‡æ»¤ï¼šç¼–ç  Phar æ–‡ä»¶

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_205.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_207.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_208.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_210.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_211.png)

ç›´æ¥ç”Ÿæˆçš„ Phar æ–‡ä»¶ï¼Œå…¶ `metadata` éƒ¨åˆ†æ˜¯æ˜æ–‡å­˜å‚¨çš„åºåˆ—åŒ–å­—ç¬¦ä¸²ã€‚å¦‚æœåº”ç”¨å¯¹ååºåˆ—åŒ–çš„å†…å®¹è¿›è¡Œäº†å…³é”®è¯è¿‡æ»¤ï¼ˆå¦‚è¿‡æ»¤äº† `system`ã€`exec` ç­‰å‡½æ•°åï¼‰ï¼Œæˆ‘ä»¬çš„æ”»å‡»å°±ä¼šå¤±è´¥ã€‚

ä¸ºäº†ç»•è¿‡è¿‡æ»¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ Phar æ–‡ä»¶è¿›è¡Œç¼–ç ã€‚ä¸€ä¸ªæœ‰æ•ˆçš„æ–¹æ³•æ˜¯ï¼šå…ˆåˆ›å»ºä¸€ä¸ªåŒ…å« `.metadata` æ–‡ä»¶çš„ç›®å½•ç»“æ„ï¼Œå°†åºåˆ—åŒ–æ•°æ®å†™å…¥è¯¥æ–‡ä»¶ï¼Œç„¶åå°†æ•´ä¸ªç›®å½•æ‰“åŒ…æˆ `tar` æ ¼å¼ï¼Œæœ€åå†ç”¨ `gzip` è¿›è¡Œå‹ç¼©ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_213.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_215.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_216.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_218.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_220.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_222.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_224.png)

```bash
mkdir .phar
cd .phar
echo â€˜åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²â€™ > .metadata
cd ..
tar -cvf test.tar .phar
gzip test.tar
mv test.tar.gz test.phar
```

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_226.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_228.png)

è¿™æ ·ç”Ÿæˆçš„ `test.phar` æ–‡ä»¶ï¼Œå…¶å†…éƒ¨æ•°æ®æ˜¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œè€Œéæ˜æ–‡ï¼Œå¯ä»¥æœ‰æ•ˆç»•è¿‡åŸºäºå­—ç¬¦ä¸²çš„è¿‡æ»¤ã€‚

---

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_230.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_232.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_234.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_236.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_238.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_239.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_241.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_243.png)

## å®æˆ˜æ¡ˆä¾‹ï¼šThinkPHP 6.0.9 ååºåˆ—åŒ–é“¾

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_245.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_247.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_249.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_251.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_253.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_255.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†åˆ©ç”¨ Phar æ‹“å±•æ”»å‡»é¢çš„æ–¹æ³•ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„æ¡†æ¶ååºåˆ—åŒ–é“¾æ¡ˆä¾‹ã€‚æˆ‘ä»¬ä»¥ ThinkPHP 6.0.9 ä¸ºä¾‹ï¼Œåˆ†æä¸€æ¡ç®€å•çš„æ–‡ä»¶å†™å…¥åˆ©ç”¨é“¾ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_257.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_259.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_261.png)

**åˆ©ç”¨é“¾æ ¸å¿ƒæ€è·¯ï¼š**
1.  èµ·ç‚¹åœ¨ `think\cache\Driver` ç±»çš„ `__destruct` æ–¹æ³•ã€‚å¦‚æœ `$this->autoSave` ä¸º `false`ï¼Œå®ƒä¼šè°ƒç”¨ `$this->save()`ã€‚
2.  `think\cache\Driver` æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬æŸ¥çœ‹å…¶å­ç±» `think\cache\driver\File`ã€‚åœ¨å…¶ `save` æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ `$this->has($name)`ã€‚
3.  åœ¨ `think\cache\driver\File` çš„ `has` æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ `$this->getCacheKey($name)` æ¥ç”Ÿæˆå®Œæ•´çš„æ–‡ä»¶è·¯å¾„ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› `false`ã€‚
4.  å›åˆ° `think\cache\Driver` çš„ `save` æ–¹æ³•ï¼Œå¦‚æœ `has` è¿”å› `false`ï¼Œåˆ™ä¼šè°ƒç”¨ `$this->set($name, $value, $this->options[â€˜expireâ€™])`ã€‚
5.  åœ¨ `think\cache\driver\File` çš„ `set` æ–¹æ³•ä¸­ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ `$this->write($cacheFile, $data)`ã€‚
6.  `write` æ–¹æ³•ä½¿ç”¨ `file_put_contents($filename, $data)` å†™å…¥æ–‡ä»¶ã€‚å…¶ä¸­ `$filename` å’Œ `$data` æˆ‘ä»¬éƒ½å¯é€šè¿‡æ„é€ çš„é“¾è¿›è¡Œæ§åˆ¶ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_263.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_265.png)

**æ„é€ åˆ©ç”¨ï¼š**
é€šè¿‡ç²¾å¿ƒæ„é€ å¯¹è±¡å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶å†™å…¥çš„æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶å†…å®¹ï¼Œä»è€Œå®ç°ä»»æ„æ–‡ä»¶å†™å…¥ï¼Œå¦‚æœå†™å…¥çš„æ˜¯ Web ç›®å½•ä¸‹çš„ PHP æ–‡ä»¶ï¼Œå³å¯é€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_267.png)

---

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_269.png)

## æ€»ç»“

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº† PHP ååºåˆ—åŒ–çš„æ ¸å¿ƒçŸ¥è¯†ã€‚æˆ‘ä»¬ä»åºåˆ—åŒ–çš„åŸºç¡€æ¦‚å¿µè®²èµ·ï¼Œç†è§£äº† `serialize` å’Œ `unserialize` çš„ä½œç”¨ã€‚æ¥ç€ï¼Œæˆ‘ä»¬æ¢è®¨äº†å¦‚ä½•æ„é€  POP é“¾ï¼Œå°†åˆ†æ•£çš„é­”æœ¯æ–¹æ³•å’Œæ™®é€šå‡½æ•°ä¸²è”èµ·æ¥ï¼Œå½¢æˆå®Œæ•´çš„æ”»å‡»è·¯å¾„ã€‚

ä¸ºäº†åº”å¯¹çœŸå®ç¯å¢ƒä¸­ååºåˆ—åŒ–å…¥å£ä¸ç›´æ¥æš´éœ²çš„æƒ…å†µï¼Œæˆ‘ä»¬æ·±å…¥å­¦ä¹ äº† Phar ååºåˆ—åŒ–æŠ€æœ¯ï¼Œäº†è§£äº†å¦‚ä½•é€šè¿‡æ–‡ä»¶æ“ä½œå‡½æ•°é—´æ¥è§¦å‘ååºåˆ—åŒ–ï¼Œå¹¶æŒæ¡äº†ç”ŸæˆåŠç¼–ç  Phar æ–‡ä»¶ä»¥ç»•è¿‡è¿‡æ»¤çš„æŠ€å·§ã€‚

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_271.png)

![](img/236f8f8ce25f97fe8a2517a5e52a2a01_273.png)

æœ€åï¼Œæˆ‘ä»¬é€šè¿‡åˆ†æ ThinkPHP 6.0.9 çš„ä¸€ä¸ªå®é™…ååºåˆ—åŒ–é“¾ï¼Œå°†ç†è®ºçŸ¥è¯†åº”ç”¨äºå®æˆ˜ï¼Œç†è§£äº†ä»æ¼æ´å‘ç°åˆ°åˆ©ç”¨é“¾æ„é€ çš„å®Œæ•´è¿‡ç¨‹ã€‚å¸Œæœ›æœ¬è¯¾ç¨‹èƒ½å¸®åŠ©ä½ å…¥é—¨ PHP ååºåˆ—åŒ–å®‰å…¨ç ”ç©¶ï¼Œå¹¶æ¿€å‘ä½ è¿›ä¸€æ­¥æ¢ç´¢çš„å…´è¶£ã€‚