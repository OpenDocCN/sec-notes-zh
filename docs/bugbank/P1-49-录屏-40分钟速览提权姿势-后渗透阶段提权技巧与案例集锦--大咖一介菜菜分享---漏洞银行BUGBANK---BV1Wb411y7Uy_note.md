![](img/df01417e0821c4f444d874269154a2eb_1.png)

![](img/df01417e0821c4f444d874269154a2eb_3.png)

# 课程 P1：后渗透阶段提权技巧与案例集锦 🚀

在本节课中，我们将学习后渗透阶段的核心技术——提权。提权是指对已获取的有限系统权限进行进一步升级，以获得更高控制权的操作。我们将从概念、分类、常用命令讲起，并通过多个实战案例演示Windows系统下的常规与非常规提权方法。

## 什么是提权？🎯

上一节我们概述了课程内容，本节中我们来看看提权的核心定义。

提权，简单说就是对当前权限的进一步提升和运用。当你获得一个初始访问权限（例如一个Webshell）后，可能会发现该权限受限，无法进行更深层次的操作。此时，就需要进行提权操作。

![](img/df01417e0821c4f444d874269154a2eb_5.png)

![](img/df01417e0821c4f444d874269154a2eb_7.png)

![](img/df01417e0821c4f444d874269154a2eb_8.png)

提权可以用于发现更多潜在的服务器或网络设备漏洞。它不仅针对Windows服务器，也适用于一些交换机等网络设备。如果你精通交换机命令，在入侵后可以查看整个网络结构。

![](img/df01417e0821c4f444d874269154a2eb_10.png)

## 提权常用命令 ⚙️

![](img/df01417e0821c4f444d874269154a2eb_12.png)

![](img/df01417e0821c4f444d874269154a2eb_14.png)

要进行提权，必须熟悉一些基本的系统命令。以下是几个关键的命令示例：

![](img/df01417e0821c4f444d874269154a2eb_16.png)

![](img/df01417e0821c4f444d874269154a2eb_18.png)

*   **`net user xxxx /add`**: 添加一个指定用户名的账户。
*   **`net localgroup administrators xxx /add`**: 将上一条命令添加的用户（例如这里的`xxx`）加入到管理员组。
*   **`whoami`**: 查询当前账户的权限。在尝试提权前，务必先查看当前权限。
*   **命令组合示例**: `命令A && 命令B`。这代表先执行符号`&&`前的命令，成功后再执行后面的命令，可以提高效率。

![](img/df01417e0821c4f444d874269154a2eb_20.png)

![](img/df01417e0821c4f444d874269154a2eb_22.png)

## 提权分类 📂

![](img/df01417e0821c4f444d874269154a2eb_24.png)

![](img/df01417e0821c4f444d874269154a2eb_26.png)

提权总体上可以分为两类：常规提权和非常规提权。

![](img/df01417e0821c4f444d874269154a2eb_28.png)

![](img/df01417e0821c4f444d874269154a2eb_30.png)

![](img/df01417e0821c4f444d874269154a2eb_32.png)

*   **常规提权**: 当你拿到Webshell时，可能发现当前账户本身具备提权条件（例如是`Network Service`权限），可以直接利用系统命令完成提权。
*   **非常规提权**: 针对一些新主机或特定服务器设备。它与常规提权的主要区别在于，需要通过利用系统漏洞（EXP）来攻击才能实现提权。

![](img/df01417e0821c4f444d874269154a2eb_34.png)

## 实战演示：常规提权案例 🖥️

![](img/df01417e0821c4f444d874269154a2eb_36.png)

![](img/df01417e0821c4f444d874269154a2eb_38.png)

下面我们通过具体案例来演示常规提权的过程。

![](img/df01417e0821c4f444d874269154a2eb_40.png)

假设我们已经获得一个Webshell。进入后，第一件事是查看当前权限。如果显示当前用户为`test`，这通常是一个低权限账户。

![](img/df01417e0821c4f444d874269154a2eb_42.png)

![](img/df01417e0821c4f444d874269154a2eb_44.png)

在Windows Server 2003系统中，Web进程通常以`Network Service`权限运行，这个权限相对较大。但从Windows Server 2008/2012/2016开始，默认是`IIS_IUSRS`权限，这属于低权限账户。

![](img/df01417e0821c4f444d874269154a2eb_46.png)

所谓的管理员配置不当，就是指将不应赋予网站的权限错误地赋予了。例如，我们发现当前进程是以`Local System`（本地系统）身份运行的，这就具备了直接提权的条件。

此时，我们可以直接执行命令添加管理员账户。例如：`net user admin password /add`。**注意**，在实战中，密码必须进行加密处理，使用明文密码非常危险。

![](img/df01417e0821c4f444d874269154a2eb_48.png)

## 实战演示：非常规提权（EXP利用）💥

![](img/df01417e0821c4f444d874269154a2eb_50.png)

如果当前权限很低（如`IIS_IUSRS`或`test`），就需要利用系统未修补的漏洞（EXP）进行提权。

![](img/df01417e0821c4f444d874269154a2eb_52.png)

首先需要查找系统补丁号（KB号）。可以通过系统命令查询，也可以使用自动化工具。一个关键点是，需要区分“更新程序”和“安全更新程序”。例如，`KB3177467`可能只是一个提高稳定性的更新，而非修复安全漏洞的补丁，因此相关漏洞（如`MS15-051`）可能依然可利用。

![](img/df01417e0821c4f444d874269154a2eb_54.png)

找到可利用的漏洞后，上传对应的EXP程序。这里需要注意路径权限问题。如果是虚拟主机，通常无法直接调用系统目录（如`C:\Windows\System32`）下的文件。我们需要找到一个Webshell账户具备**可读、可写、可执行**权限的目录来存放EXP。

可以使用命令检查目录权限。如果目录不具备相应权限，执行EXP时会提示权限不足。在Windows中，有些目录的权限可以被继承或替换，需要仔细查找。通常，不建议在路径包含空格的目录下放置EXP，这可能导致执行失败。可以搜索“Windows提权常用目录”作为参考。

## 第三方软件提权：Serv-U FTP 🗂️

![](img/df01417e0821c4f444d874269154a2eb_56.png)

除了系统漏洞，第三方软件配置不当也是常见的提权途径。Serv-U FTP是一款第三方FTP服务器软件，其早期版本默认以`System`权限运行。

如果管理员没有为Serv-U设置密码，或者我们能通过其他方式获取其配置文件，就可以利用它进行提权。Serv-U的配置文件通常位于安装目录下，如果该目录可被Webshell访问，就能读取或修改配置。

**防御方法**：
1.  为Serv-U设置强密码。
2.  限制Webshell账户对Serv-U配置目录的访问权限（特别是“写入”权限）。
3.  降权运行Serv-U，使用普通用户（如`guest`）身份运行。

## 数据库提权：MySQL 🗄️

MySQL提权是另一种重要方式，主要利用MySQL的`UDF`（用户自定义函数）功能创建系统用户。

MySQL提权分为两种情况：
*   **MySQL版本 <= 5.0**：需要将UDF动态链接库（DLL）导出到系统目录，如`C:\Windows\`或`C:\Windows\System32\`。
*   **MySQL版本 >= 5.1**：需要将DLL导出到MySQL的插件目录，如`C:\Program Files\MySQL\MySQL Server 5.1\lib\plugin\`。

**如何获取MySQL账号密码？**
1.  通过网站配置文件查找（如`config.php`, `web.config`, `data/db.config.inc.php`等）。
2.  如果存在目录遍历漏洞，尝试下载MySQL的`user.MYD`, `user.MYI`, `user.frm`三个文件，在本地MySQL中覆盖还原，即可查看哈希密码。

获得数据库高权限账号后，即可执行UDF提权命令。常见问题包括DLL导出路径错误、函数创建失败等，需要根据具体错误信息进行排查。

## 数据库提权：MSSQL 🗃️

对于MSSQL（SQL Server），如果获取了`sa`等高权限账户，可以直接使用`xp_cmdshell`存储过程执行系统命令。

在早期版本（如Windows 2000）中，`xp_cmdshell`默认开启。但在后续版本中默认关闭。如果遇到“无法执行”的错误，通常需要先启用它。

![](img/df01417e0821c4f444d874269154a2eb_58.png)

![](img/df01417e0821c4f444d874269154a2eb_60.png)

启用`xp_cmdshell`的命令示例如下：
```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
```
执行成功后，即可通过`xp_cmdshell`执行系统命令，例如添加用户。

如果默认的1433端口被修改，可以通过扫描或查询注册表等方式来定位MSSQL的实际端口。

## 其他提权技巧与问答 🔍

在课程最后，讲师回答了一些常见问题，并补充了一个技巧：

*   **API提权**：当`net`和`net1`命令都被禁用时，可以尝试使用底层Windows API进行提权。这种方法同样需要一定的执行权限，但执行后可能没有明显回显，需要验证是否成功。
*   **核心困难**：提权的最大困难在于“信息不全”。需要耐心收集系统信息、补丁情况、安装的软件、配置文件等。
*   **学习建议**：平时多收集漏洞利用代码（EXP）、多实战、多分析问题原因。遇到失败不要轻易放弃，具体问题具体分析。

![](img/df01417e0821c4f444d874269154a2eb_62.png)

![](img/df01417e0821c4f444d874269154a2eb_64.png)

## 总结 📝

本节课我们一起学习了后渗透阶段提权的核心知识与实战技巧。

![](img/df01417e0821c4f444d874269154a2eb_66.png)

我们首先明确了提权的定义与目的，然后学习了提权的两种主要分类：**常规提权**（利用现有高权限）和**非常规提权**（利用系统或软件漏洞）。接着，我们深入探讨了多种实战提权路径：
1.  利用Windows系统漏洞（EXP）。
2.  利用第三方软件（如Serv-U FTP）的配置缺陷。
3.  利用数据库（MySQL的UDF、MSSQL的`xp_cmdshell`）的高权限执行系统命令。

![](img/df01417e0821c4f444d874269154a2eb_68.png)

![](img/df01417e0821c4f444d874269154a2eb_70.png)

最后，我们了解了一些边缘技巧和解决问题的思路，强调了信息收集和耐心分析在提权过程中的重要性。掌握这些方法，需要结合扎实的基础知识、丰富的工具积累和灵活的实战思维。