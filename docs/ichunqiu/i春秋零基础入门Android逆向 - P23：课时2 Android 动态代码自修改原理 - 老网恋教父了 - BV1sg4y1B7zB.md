# i春秋零基础入门Android逆向 - P23：课时2 Android 动态代码自修改原理 - 老网恋教父了 - BV1sg4y1B7zB

🎼悟空空空。🎼。

![](img/96bfb949167abba5c86554bae0ce31e2_1.png)

呃，好的呃，大家好，我是蒋师艾帮。那么今天就来讲第22课一个关于安卓代码的一个动态自修改的一个原理。那么相信大家都已经呃遇到过了。对于某一些APP文件来说，哎。

原始的程序应该是能够看到它的所有的一个des代码了。但是对于一些加壳以后文件来说的话，比如说哎被一个所谓的360加固宝，它加固加固好以后的一个代码，它就它就变成了一个这种形式了。

可以看到它的所有真实代码都已经不存在，就变成了这种类型。但是这并不影响整一个程序的一个正常执行。那也这为什么？这很显然，就是整一个程序他加载的时候就对自身的代码进行了一个动态修改。

然后把一些原始代码给填充上去了。那么这个很显然就是一个普通的一个加可原理啊，那么它的基础就是一个代码字修改了。那么我们就来看一下啊，对于一个des file来说，一个dess文件来说。

它里面有哪一些知识机制可以让这些加壳程序利用来达到一个动态修改的一个效果呢？我们先回到上一节课所介绍的一个desash文件的一个内容。我们我们来看一下它里面有哪些地方可以让我们去完成一个动态字修改。

首先它入口点的话是一个des的一个head。我们往下转一下的话，可以看到有里面有一个classDADF的一个结构体。那么这个结构题里面就是存方在所有的一个class的一个描述符。

我们从这个class里面往下看。可以看到里面有有一个非常重要的数据，叫做classastic of。那么里面的话就只现着1个DX class data的一个结构体了。好。

那么这个结构体我们上一节课没有介绍。我们这一节课就来讲一下。首先它的第一个参数的话是一个dess header，里面的话就是使用1个UIEB128A存外的所有的一个个数。

哎就是说哎这个t field的一个大小，和的大小。下面就是一个dest method大小，还有vis method一个大小。那么根据这这里的一个大小来初始化这这一些结构的一个长度。好。

那么跟好那么下面就是一个一个结构体所有的还有一都是一个des结构体来描述了我们的一个field的一个属性，就是一个个还有它一就是它访问标志比说个public标志或者或者说一个标志之的。

那么同样同样的那么des个的话，里面就是向一个的一个结构体了。那么里面就是了一个 ID它访问标志以及它的一个码的一偏移。那么这里的代码就比较重要。这里代移的话它就指向了一个des code的一个结构。

那么里面存放的这个方法它所需要的一些内容。比如说这个方法它里面使用了多少个计存器啊，它里有多少个参数啊，对吧？然后下面就是它的一个指令的一个长度，然后它里面指令的一个真实内容。

比如说它然后下面是它一个traice。快的一个长度，还有它的内容啊。好，我们来用1个010 editoritor来打开看一下，看一看它的一个。看一看它的一个呃真实的一个效果吧，我们来打开涂进去。好。

我们打运行一个time。那么关于这样一件一个呃模模板的话，那么在网上也有，我们现在这里不不多说，我们找到一个classify的一个模的一块里面的话，这里对这个class文件来说。

就是一个呃plication，我们打开。好，把到它的这一个class data展开。好啊，里面有很多方法，有很多list子，我们来前面找一个打开。比如说它的field ID。

我们好看到它里面有两个fill，我们打开一个就会看到它哎在field IDS403，对吧？我们从field ID的03里面找一下。

就会发现它是一个在一个someapplication contest的一个film，对吧？对吧？哎，这都是一样的哈，那么它返还标志位的话是一个parry，然后的一个标志位。那么下面也是一样的。

现在的话哎看到它的RDX的话是04。好，那么对应着这里的04的话就是在这个地方一个SO line。哎，注意一下，这里虽然是一对吧？这也是虽然是一，但实际上它是指一个与前面的1个IDS的一个偏离的。

比如说这是03，那么这是一的话应该是3加1，就是这这里的ID实际上应该是04。这是它为了安卓系统，为了一个节省它的数据所做了一个小小的一个或者就是在存放的是是一个偏移。啊，错了第一个是真实的IDX的话。

下面都是以上1个IDX的一个偏移地址来的。好，那么对方法来说也是一样的。比如说这里它有8个direct，那么这里只有8个direct的一个指针。那么这里只有两个vis，那么这里也是一样。

就有两个vis这样一个指针。我们找到这一个一个我们展开看一下也是一样那个ID IDDSS47的话，那么在这一个结构体的第7个片里面也是同样够找到了。好，那么下面就到这里的话，一些点就不说了哈，对吧？

然后这里是7，那么下面的话是7加一等于8。那么再下面的话就是一个呃8加2等于10。好，那么下面的话就是10加1等于11啊，那么这里的方法IDX的话特别说一下。

我们我们最主要就关心它的一个code offset set的一个呃code代码编译。那么这个偏移地址呃，这个偏移地址，它里面就会指向一个code的一个指针。

就就指指向一个code这里这里就只表到它的一个偏移地址为BCC的地方，就是最后存放的这个方法的一个实现了。我们找到你找到配移BCC这个地方，就是这里了BCC好。

这也是对应的一个coded item的一个数据。里面就是存放的这个方法所需要的一些参数。比如说他这里就使用了一个计存器。对吧，然后下面就是它组里面的一个方法的的一个结构体。

它里面的方法的一个数据的一个指令的长度是3好，那么这就展开了，看没里面有三个东西好，123有三个指令好，那3个里面它分别做了这些操作。好，那么这里整一个程序它运行的时候。

安卓程序它运行的时候就可以动态的解析这一个结构体里面里面的内容来动态解析执行数据了。好，那么我们所需要做修改，就是在程序加载以后下载起来以后，找到这个结构体啊找到这个结构体。

然后对它的里面里里面的这一个内容哎进行一个修改。那么这里修改完以后，哎就相当于动态的修改了一个程序的一个代码。那么一些加固加固软件啊，比如说阿巴里的加固的话，那么它它保护的一个原理就是这样的。

那么帮棒的话也其实帮帮的框它原理也是这种样子的，就是把这样一个INSN艾的框它里面的一个指令集里面的一些指令给抽取出来，然后运行的时候在动态释放。它们原理都是这个样子的。那么我们就来看一下。

我们要对它进行了一个修改完以后，哎，是不是能够真正的得到一个呃修改的一个效果。我们先来找一个简单的一个呃写一个简单的程序来进行一下验证，来进行一下修改。好，打开按住tudio。

然后创建一个项目里面项目然后在项目里面的话就使用我们想要的一个。

![](img/96bfb949167abba5c86554bae0ce31e2_3.png)

东西。好，我们就用这个来进行一个说明吧。

![](img/96bfb949167abba5c86554bae0ce31e2_5.png)

我先来看一下，先在看一下它里面的话呃，我已经写好，里面的话函数很简单。好，这里整一个流程，这也是最基本的。然后。然后这里的话就会有一个按钮的点击事件，点击事件里面的话就会打印出一个函数里你的返回内容。

好。转到这个函数中，就会发现它只是单纯的一个反向的一个一的一个内容了。好，那么这样正常跑起来，它是应该知法A一的，我们也可以。试试的跑一下来看一下效果。啊正常来说，它应该是知法A一的。啊不来看一下。

看一下效果。

![](img/96bfb949167abba5c86554bae0ce31e2_7.png)

好，重新打开返回哎表明啊，它返回一了。好，我们下面我们就来对它的一个程序进行一个修改，然后进行一个分析修改吧。我们来。



![](img/96bfb949167abba5c86554bae0ce31e2_9.png)

打开打开它的这个d数据文件。

![](img/96bfb949167abba5c86554bae0ce31e2_11.png)

天吧。好，打开完以后，我们来来用这个模板来打开来分置一下吧。

![](img/96bfb949167abba5c86554bae0ce31e2_13.png)

是吧。跑一个des的一个脚本，一个模板。然后定位到我们的类中，这个类的话是一个van pink的一个类。然后里面的话有一个turn衣的一个方法，我们打折到它。



![](img/96bfb949167abba5c86554bae0ce31e2_15.png)

![](img/96bfb949167abba5c86554bae0ce31e2_16.png)

大概在这个地方。然后找到class data，然后找到一个方法，它一个是一个reial method里面啊有一个returnee就是这个方法了。根那个方法。那我找一下它的code item。

那这里就存放着它的一个code，它里面只有两个一个指令，它指令长度只有2，就是这样一个两个长度1210，还有1个0。00。啊，如果这里大家这里看不清楚的话，也可以使用这样一个呃GEB来进行一个打开。

这里同样也是有一个查看之前码的一个功能的。我们打开看一下。从用JB来打开，然后。啊，一正常的这一批的话，它是配它是带有这个功能，但是为了一个显示简便，它就会以把这些东西给隐藏起来。

那么这里可以这样来进行的打开。

![](img/96bfb949167abba5c86554bae0ce31e2_18.png)

可下就这个打开一个编辑选项，然后在一个配编员里面可以显择这里显示败扣显示一个字写码，就能够显示说哎每一行代码的一个字写码了。我们找到我们的一个函数。找到我们的一个函数，然后一个于衬一的一个函数。

就是这里唉12101210对应的就是一个cos是V01，然后一个02V0对应的这就是发生一个V0的一个值了。那看一下它这里也是一样啊，就是对对吧？是12是一个cos的一个操作。

然后0代表对V0这一个计行器操作，然后一个一。就是负以为一了。那么下面的话就是20就负以为2了。那么我们修改的话，哎，那们修改这一次的修改就简单一点，就是把这样1个120改成1个120，让它从返回一。

变成返回2，我们就来看一下能不能够做到这个样子。好，那既然如此，我们就来开始的进行一个修改吧。我们先来。好，原点就是这样一个样子，定位到DEX文件，计上一个dess code的位置。

然后重写它的ISSNS中数据。那么这里我们就在IDA中先来进行一个正常的一个修改，来看一下能不能够呃把它的值给改掉。



![](img/96bfb949167abba5c86554bae0ce31e2_20.png)

好，ID调试挂上。啊，那么这里的话，那IID调色的话，大家应该都已经很清楚了。嗯，好，打开。用用ID直接挂接。呃，在之前的话是进行一个端口的一个转发。



![](img/96bfb949167abba5c86554bae0ce31e2_22.png)

啊，用ID进行了关接。找不到我们哪个函数好，hel lucky然后就是这样一个地方了，打开。

![](img/96bfb949167abba5c86554bae0ce31e2_24.png)

那么挂机上选完就来找一下这个dash文件吧。首先就是在内存中找到这样一个dash文件的一个位置，然后把它的一个P移给计算上去。比如说哎这里ISNS来P移出这个地方，我们就找到这个ds文件。

计算一下它的一个P移吧。好，那么我们这里要怎么样才能够定位到它的一个dash的文件的一个位置呢？那其实定位的话，对于一些正常的程序来说要定位是很简单的，是很很简单的。

我们按t条加S来打开它的一个map的数据。我们可以看到可以按住弹序它的麦。它的个麦加加来到这么多地方，门们往下滚一下，也可以进行一个搜索。Like is个 holiday。啊。

那么就可以看到它就把我们的的一个dash数据啊，d数据给加载加载到这个内存的地方了，好对吧？FBPK以后呢那是1个APK文件的一个pa的一个dash数据的一个起始地址。它只放在这个地方。

这里我们双击跳过去。好。把这里我们在数据窗口中打开看一下啊，这样看的比较明显。好首先可以看到之前就是一个desk头了，它第一个指针是1个DEY036，这是1个DEXOPT head的一个指针。

看一下这里没有，如果没有的话。嗯。呃，这里这个文件就没有写，但实际上这里就是1个DEXOPThead指针。好，这个一般不用管一般不用管，我们并不关心这个数据。如果想知道它的具体内容的话。

也可以在模板中进行一个打开。打开完以后就能够看到它的一些内容了。这是1个DAXOPT的一个指针。然后它下面的话就会是一个dess文件的一个起始标志了。DAX035非常显然的标志，对吧？

那么脱壳的时候也可以寻找这个标志来进行一个呃内存断驳的。但是这些当然这个对于新的加壳之谜没有用。好，这就是这个d文件的一个就是标志了DEX035。然后后面跟这个更着的就是先表示服。

比如说这里是0127什么什么什么，然后长度是1个OF2914，我们对一下吧啊D035，然后它长度是这唉对吧？那么显然这就就是我们要找的一个d文件的一个标志了。我们就算好一个偏离。

然后对它内存进行一个修改。好，呃，他配您，他其实备置是1个7575147028。95177028。然后呃加上我们的一个。呃，PE地址至于这里的1个des的切构，des的一个code的一个PE地址。

我们找到它，然后进行一个修改。好，我们找到它在这里的其始地址是1个呃11881C8。好，那我记起来它就到这个位置。我们在IDA中定位到按居进行了快速跳转。好，那这里就是我们要修改的一个指令值了。

12100F00。对吧和这里是一样的。好，我们进行一个修改。那么刚才应该把一个修改给明确掉吧。呃，1210是一个负与一的一个操作。那么1120的话是负与2操作，我们把1210改成120呃。

按F2按F2快3快进的F2能够进行一个修改，就是证明好，把120改成120修改完以后再1个F2来让它一个修改成立。好。



![](img/96bfb949167abba5c86554bae0ce31e2_26.png)

这里已经完成了一个代码修改了，我们抛起来看一下效果。抛起来看一下效果。它本来的话正常抛起来应该是反映一个一的。我们就来看一下现在点击按钮发生什么事好，它已经反映二了，对吧？

这边它里面的真实代码已经被我们给修改掉了。不信的话，我们也可以改一下，改一下其他内容。啊，比如说1230。再来点一下。好，测一下。点击。好3哎，对吧？显然我们我们修改就真实的对它的一个代码生效了，对吧？

其实际上我们的一些很多的加固，它都是这个样子的，就是就是把它的1个ISNS的值进行了一个修复。运行的时候对这样一个值进行一个填充修复，来得到一个呃。



![](img/96bfb949167abba5c86554bae0ce31e2_28.png)

一个加可的一个效果好，对吧？原理说白了就是这种东西非常简单，非常重要。那么但是问题就在于我们的在编程的时候，要怎么样才能找到这样一个dash文件。怎么这上去找到它的1个ISNS的一个数据。

然后对它进行一个定位进行一个修改。好，那么这一方面的内容的话，我们就放到下一节课来讲。那么这节课的话就是。简单的介绍一下它的一个修改的一个原理了。那么在安卓的上的话，哎。

我们可以找到很多很多方法来计算出它的一个结果，然后进行一个动察的一个修改了。那么那么修改的一个代码的话，我们在下一节课再讲。那么大家在大家在下面的话，希望能够自己去尝试着去试一下。

能不能够修修改它的一些自己码，对吧？对就有这么多的一个代码，有这么多的一个长度，看一下能不能够进行一个修改。



![](img/96bfb949167abba5c86554bae0ce31e2_30.png)

进行一个填充。它很多的一个软件啊，它都是这种样子的。那那么这一节课的话就到此为止了。好，谢谢大家。🎼悟空。

