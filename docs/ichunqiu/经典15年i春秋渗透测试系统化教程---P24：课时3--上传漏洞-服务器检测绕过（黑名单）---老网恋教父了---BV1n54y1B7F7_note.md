# 经典15年i春秋渗透测试系统化教程 - P24：课时3 上传漏洞-服务器检测绕过（黑名单） 🔒

在本节课中，我们将要学习如何绕过服务器对上传文件的黑名单检测机制。黑名单检测的安全性通常低于白名单，但其绕过方法也更为多样。我们将逐一解析这些方法，帮助初学者理解其原理。

## 概述 📋

黑名单检测是指服务器维护一个危险文件扩展名列表（如 `.asp`, `.php`, `.jsp`），并拒绝上传列表中的文件。然而，由于设计缺陷或配置疏忽，攻击者可以通过多种方式绕过这种检测。

## 黑名单检测原理

当用户上传文件时，服务器程序会检查文件扩展名是否存在于预设的黑名单中。如果存在，上传请求将被拒绝。反之，则允许上传。这种机制的安全性较低，因为攻击者可以尝试不在黑名单内的扩展名或利用解析特性。

## 绕过方法详解

![](img/d2705df490e4e174cd2466b9cb1dd6a5_1.png)

![](img/d2705df490e4e174cd2466b9cb1dd6a5_2.png)

上一节我们介绍了黑名单的基本原理，本节中我们来看看具体的绕过方法。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_4.png)

### 1. 文件名大小写绕过 🔠

这种方法利用黑名单列表通常只包含小写扩展名的缺陷。通过改变扩展名的大小写组合，可以绕过检测。

**原理**：如果黑名单只包含 `asp`，那么上传 `ASP`、`Asp` 或 `aSp` 等变体可能被允许。

**示例**：
```
被拦截：shell.asp
可绕过：shell.ASP 或 shell.aSp
```

![](img/d2705df490e4e174cd2466b9cb1dd6a5_6.png)

### 2. 名单列表遗漏绕过 📝

![](img/d2705df490e4e174cd2466b9cb1dd6a5_7.png)

此方法利用黑名单未包含所有可执行扩展名的漏洞。服务器可能只拦截了常见扩展名，而遗漏了其他同样危险的扩展名。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_9.png)

以下是IIS服务器默认可以解析的部分扩展名：
*   `.asa`
*   `.cer`
*   `.cdx`

![](img/d2705df490e4e174cd2466b9cb1dd6a5_10.png)

**原理**：如果黑名单没有包含 `.cer`，那么上传 `shell.cer` 文件，IIS服务器仍会将其作为ASP脚本解析执行。

### 3. 特殊文件名绕过 ␣

此方法涉及在文件名中插入特殊字符，如点号（`.`）或空格，以干扰服务器的解析逻辑。

**原理**：在Windows系统中，文件名后的点号或空格会被自动去除。例如，上传文件 `shell.asp.` 或 `shell.asp `，服务器可能只检查 `asp` 部分并拒绝。但Burp Suite等工具可以修改十六进制值，将空格（`0x20`）改为空字符（`0x00`）。当服务器解析到空字符时，可能会丢弃其后的所有内容，从而绕过对 `.asp` 的检测。

**注意**：此特性主要存在于Windows系统。Linux系统严格区分大小写，且不会自动去除点号或空格。

### 4. 0x00截断绕过 ✂️

此方法利用空字符（`0x00`）在字符串处理中的截断特性。当服务器程序遇到空字符时，会认为字符串已结束。

**示例**：
上传文件名为 `shell.asp%00.jpg`，服务器可能只识别 `shell.asp`，从而绕过对 `.jpg` 的检测。

### 5. 解析漏洞攻击（Apache） 🐘

此方法基于Apache服务器从后向前解析文件扩展名的特性。

**原理**：Apache在解析 `shell.php.xxx` 这样的文件名时，会从最后开始识别扩展名。如果 `.xxx` 不被识别，它会向前寻找，直到遇到认识的扩展名（如 `.php`），并以此执行。

**示例**：
上传 `shell.php.123`，只要黑名单里没有 `.123`，文件就能上传。Apache在解析时，因不认识 `.123` 而向前找到 `.php`，最终以PHP脚本执行。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_12.png)

![](img/d2705df490e4e174cd2466b9cb1dd6a5_14.png)

### 6. 解析漏洞攻击（IIS 6.0） 🪟

此方法基于IIS 6.0服务器对分号后内容的忽略特性。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_16.png)

![](img/d2705df490e4e174cd2466b9cb1dd6a5_18.png)

**原理**：在IIS 6.0中，对于 `shell.asp;.jpg` 这样的文件名，服务器会忽略分号后的内容，将文件当作 `shell.asp` 来解析执行。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_20.png)

**示例**：
上传 `shell.asp;.jpg`，可能绕过对 `.jpg` 文件的检测，但最终以ASP脚本执行。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_22.png)

### 7. 危险解析配置绕过 ⚙️

此方法利用Web服务器（如Apache）配置文件的错误设置。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_24.png)

**原理**：在Apache的配置文件（`httpd.conf`）中，如果存在类似 `AddHandler php5-script .php` 的指令，并且后面错误地跟上了 `.jpg`，如 `AddHandler php5-script .php .jpg`，那么 `.jpg` 文件也会被当作PHP脚本执行。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_26.png)

**关键**：服务器的安全不仅取决于应用程序代码，中间件（Apache, IIS, Nginx等）的配置也至关重要。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_28.png)

### 8. `.htaccess` 文件攻击 📄

此方法配合“名单列表遗漏”绕过，上传一个自定义的 `.htaccess` 文件。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_30.png)

![](img/d2705df490e4e174cd2466b9cb1dd6a5_32.png)

**原理**：`.htaccess` 是Apache的分布式配置文件，可以覆盖目录级的设置。如果服务器允许上传 `.htaccess` 文件（该扩展名通常不在黑名单内），攻击者可以编写规则，指定特定扩展名（如 `.abc`）由PHP解析器处理。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_34.png)

**示例 `.htaccess` 内容**：
```
AddType application/x-httpd-php .abc
```
上传此文件后，再上传 `shell.abc`，该文件将被当作PHP脚本执行。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_36.png)

![](img/d2705df490e4e174cd2466b9cb1dd6a5_38.png)

### 9. 解析调用/包含绕过 🔗

![](img/d2705df490e4e174cd2466b9cb1dd6a5_40.png)

此方法属于间接攻击，需要配合其他漏洞（如文件包含漏洞）。

**原理**：首先上传一个不在黑名单内的文本文件（如 `shell.txt`），里面包含恶意代码。然后，利用网站的文件包含功能（例如，`include(‘/uploads/shell.txt’)`）来包含并执行该文件中的代码。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_42.png)

## 总结 🎯

![](img/d2705df490e4e174cd2466b9cb1dd6a5_44.png)

本节课我们一起学习了九种绕过服务器黑名单检测的常见方法：
1.  **文件名大小写绕过**：改变扩展名大小写。
2.  **名单列表遗漏绕过**：使用黑名单未收录的可执行扩展名。
3.  **特殊文件名绕过**：利用空字符等特殊字符干扰解析。
4.  **0x00截断绕过**：利用空字符截断文件名。
5.  **Apache解析漏洞**：利用从后向前解析的特性。
6.  **IIS 6.0解析漏洞**：利用分号解析特性。
7.  **危险配置绕过**：利用服务器中间件的错误配置。
8.  **`.htaccess`文件攻击**：上传自定义配置文件重写解析规则。
9.  **解析调用/包含绕过**：结合文件包含漏洞执行恶意代码。

![](img/d2705df490e4e174cd2466b9cb1dd6a5_46.png)

理解这些方法有助于我们认识到，单纯依赖黑名单进行文件上传过滤是极不安全的。在后续课程中，我们将探讨安全性更高的白名单检测机制及其挑战。