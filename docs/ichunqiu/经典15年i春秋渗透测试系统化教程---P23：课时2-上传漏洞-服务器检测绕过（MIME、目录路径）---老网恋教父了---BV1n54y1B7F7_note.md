# 经典15年i春秋渗透测试系统化教程 - P23：课时2 上传漏洞-服务器检测绕过（MIME、目录路径） 🛡️➡️🚫

![](img/f27863acc0b245596a427b007f11163c_1.png)

![](img/f27863acc0b245596a427b007f11163c_2.png)

在本节课中，我们将要学习文件上传漏洞中，如何绕过服务器端的两种常见检测机制：MIME类型检测和目录路径检测。我们将通过原理讲解和DVWA平台上的实战演示，帮助你理解并掌握这些绕过技术。

![](img/f27863acc0b245596a427b007f11163c_4.png)

## 概述：服务器检测绕过原理

![](img/f27863acc0b245596a427b007f11163c_6.png)

![](img/f27863acc0b245596a427b007f11163c_7.png)

上一节我们介绍了文件上传漏洞的基本概念。本节中我们来看看如何绕过服务器对上传文件的严格检查。服务器通常会检查文件的MIME类型和文件路径，如果检查逻辑存在缺陷，攻击者就能上传恶意文件。

![](img/f27863acc0b245596a427b007f11163c_9.png)

![](img/f27863acc0b245596a427b007f11163c_11.png)

## 绕过目录路径检测（00截断）

![](img/f27863acc0b245596a427b007f11163c_13.png)

![](img/f27863acc0b245596a427b007f11163c_15.png)

![](img/f27863acc0b245596a427b007f11163c_16.png)

首先，我们来讲解如何利用“00截断”技术绕过服务器对文件路径的检测。其核心原理是，在某些环境下（如旧版Windows系统），当文件路径解析遇到空字符（`\x00`）时，会停止向后解析，从而“截断”掉后续部分。

![](img/f27863acc0b245596a427b007f11163c_18.png)

![](img/f27863acc0b245596a427b007f11163c_20.png)

### 原理分析

![](img/f27863acc0b245596a427b007f11163c_22.png)

![](img/f27863acc0b245596a427b007f11163c_24.png)

![](img/f27863acc0b245596a427b007f11163c_26.png)

在Windows系统中，如果文件路径包含一个空格（在某些上下文中等同于`\x00`空字符），程序在解析时可能会从后向前判断扩展名。如果遇到空格，它就会忽略空格之后的所有内容。

![](img/f27863acc0b245596a427b007f11163c_28.png)

![](img/f27863acc0b245596a427b007f11163c_30.png)

例如，一个文件名为 `shell.php .jpg`。服务器检测扩展名`.jpg`，认为合法。但在解析执行时，遇到空格后，实际处理的文件名就变成了 `shell.php`。

![](img/f27863acc0b245596a427b007f11163c_32.png)

![](img/f27863acc0b245596a427b007f11163c_33.png)

![](img/f27863acc0b245596a427b007f11163c_35.png)

以下是利用Burp Suite修改数据包实现此绕过的关键步骤：

![](img/f27863acc0b245596a427b007f11163c_37.png)

![](img/f27863acc0b245596a427b007f11163c_39.png)

1.  准备一个一句话木马文件，将其重命名为类似 `shell.php.php.jpg` 的格式。
2.  通过Burp Suite拦截上传请求。
3.  在十六进制视图（Hex）中找到文件名部分，将 `shell.php.php.jpg` 中点号（`.`）后的空格或特定字符替换为 `00`（空字符的十六进制表示）。
4.  转发修改后的数据包。

![](img/f27863acc0b245596a427b007f11163c_40.png)

![](img/f27863acc0b245596a427b007f11163c_42.png)

服务器在路径检测时看到的是合法的 `.jpg` 结尾，但在解析时，`\x00` 会截断其后内容，最终将文件保存为 `shell.php`。

![](img/f27863acc0b245596a427b007f11163c_44.png)

![](img/f27863acc0b245596a427b007f11163c_46.png)

![](img/f27863acc0b245596a427b007f11163c_48.png)

### 相关工具与案例

![](img/f27863acc0b245596a427b007f11163c_50.png)

![](img/f27863acc0b245596a427b007f11163c_51.png)

这种方法在上传漏洞利用中非常常见。一些旧版本的编辑器（如FCKeditor 2.6.4及以下版本）就存在此类漏洞。互联网上有许多公开的案例可供研究。

## 绕过MIME类型检测

![](img/f27863acc0b245596a427b007f11163c_53.png)

![](img/f27863acc0b245596a427b007f11163c_54.png)

接下来，我们看看如何绕过服务器对文件MIME类型的检测。服务器通常会检查HTTP请求头中的 `Content-Type` 字段，判断文件类型是否合法（如 `image/jpeg`, `image/png`）。

![](img/f27863acc0b245596a427b007f11163c_56.png)

![](img/f27863acc0b245596a427b007f11163c_57.png)

### 检测代码分析

![](img/f27863acc0b245596a427b007f11163c_58.png)

![](img/f27863acc0b245596a427b007f11163c_60.png)

我们以DVWA平台的上传模块代码为例，分析三种安全级别的检测差异：

![](img/f27863acc0b245596a427b007f11163c_62.png)

![](img/f27863acc0b245596a427b007f11163c_64.png)

*   **低安全级别**：代码中没有任何对文件类型、大小的判断语句，可以直接上传PHP木马。
    ```php
    // 低级别示例代码逻辑：无过滤
    if (文件上传) {
        move_uploaded_file(临时文件, 目标路径);
    }
    ```
*   **中安全级别**：代码增加了对 `Content-Type` 的检查，只允许 `image/jpeg` 或 `image/png` 类型。
    ```php
    // 中级别示例代码逻辑：检查MIME类型
    $allowed_mime = ['image/jpeg', 'image/png'];
    if (in_array($_FILES['file']['type'], $allowed_mime)) {
        move_uploaded_file(临时文件, 目标路径);
    } else {
        echo “文件类型不允许”;
    }
    ```
*   **高安全级别**：除了检查MIME类型，还可能检查文件扩展名、文件内容头（如GIF89a）甚至文件大小，这是最安全的配置。

![](img/f27863acc0b245596a427b007f11163c_66.png)

![](img/f27863acc0b245596a427b007f11163c_68.png)

![](img/f27863acc0b245596a427b007f11163c_70.png)

### 绕过方法

![](img/f27863acc0b245596a427b007f11163c_72.png)

![](img/f27863acc0b245596a427b007f11163c_74.png)

![](img/f27863acc0b245596a427b007f11163c_76.png)

对于只检测MIME类型的中级防护，有几种绕过方法：

![](img/f27863acc0b245596a427b007f11163c_78.png)

![](img/f27863acc0b245596a427b007f11163c_80.png)

![](img/f27863acc0b245596a427b007f11163c_82.png)

1.  **直接修改请求包**：使用Burp Suite拦截上传请求，直接将 `Content-Type` 字段修改为 `image/jpeg` 等允许的类型。
2.  **制作图片木马**：
    *   **方法一**：将一个真实图片文件（如 `.jpg`）用文本编辑器打开，在文件末尾追加PHP木马代码。服务器检测图片头是合法的，但后续的PHP代码仍可能被解析（取决于服务器配置）。
    *   **方法二**：使用专用工具（如“一句话木马插入工具”）将PHP代码插入到图片文件的二进制数据中，确保不破坏原图片文件头。

![](img/f27863acc0b245596a427b007f11163c_84.png)

![](img/f27863acc0b245596a427b007f11163c_86.png)

## 实战演示：在DVWA中绕过路径检测

![](img/f27863acc0b245596a427b007f11163c_88.png)

![](img/f27863acc0b245596a427b007f11163c_90.png)

现在，我们将在DVWA平台上演示如何利用00截断绕过路径检测。

1.  将DVWA安全级别设置为“低”。
2.  准备一句话木马文件 `shell.php`，并将其重命名为 `shell.php.jpg`。
3.  在DVWA上传页面选择该文件并上传，同时用Burp Suite抓包。
4.  在Burp Suite的Proxy模块中，找到拦截到的POST请求，切换到 **Hex** 标签页。
5.  找到文件名 `shell.php.jpg` 对应的部分。将 `shell.php.jpg` 中第一个点号（`.`）后的字符（即 `p` 的十六进制值）修改为 `00`。
6.  修改后，文件名在显示上可能变为 `shell.php .jpg`（中间有一个空字符）。
7.  转发该数据包。
8.  观察服务器响应，如果绕过成功，文件将以 `shell.php` 被保存，而非 `shell.php.jpg`。

![](img/f27863acc0b245596a427b007f11163c_92.png)

![](img/f27863acc0b245596a427b007f11163c_94.png)

**核心原理回顾**：服务器检测时，看到的是 `.jpg` 结尾，允许上传。但系统在保存文件解析路径时，遇到 `\x00` 空字符便停止，最终文件名为 `shell.php`。

![](img/f27863acc0b245596a427b007f11163c_96.png)

![](img/f27863acc0b245596a427b007f11163c_97.png)

## 扩展知识：文件夹路径截断

![](img/f27863acc0b245596a427b007f11163c_99.png)

![](img/f27863acc0b245596a427b007f11163c_100.png)

![](img/f27863acc0b245596a427b007f11163c_101.png)

另一种相关的攻击手法涉及文件夹命名。在旧版Windows系统（如Windows 2003）中，可以创建名为 `xxx.php` 的文件夹。如果将任何文件（如图片）上传到此文件夹下，访问 `http://目标/xxx.php/图片名.jpg` 时，部分服务器配置可能会将整个路径交给PHP解析器处理，导致图片中的代码被执行。

![](img/f27863acc0b245596a427b007f11163c_103.png)

这种攻击方式同样可以利用00截断，例如构造上传路径为 `/upload/shell.php \x00/legit.jpg`，服务器可能最终将文件保存到 `/upload/shell.php` 目录下。

![](img/f27863acc0b245596a427b007f11163c_105.png)

## 总结

本节课中我们一起学习了两种绕过服务器文件上传检测的方法：
1.  **00截断绕过路径检测**：利用空字符截断文件路径，使服务器保存文件时使用恶意扩展名。
2.  **修改MIME类型绕过内容检测**：通过篡改HTTP请求头中的 `Content-Type` 字段，或制作包含恶意代码的图片文件，欺骗服务器的类型检查。

![](img/f27863acc0b245596a427b007f11163c_107.png)

![](img/f27863acc0b245596a427b007f11163c_109.png)

理解这些绕过技术的原理，有助于我们更好地认识到在开发中实施多层次、多维度文件上传校验的重要性，而不仅仅依赖客户端或单一的服务器端检查。