# 经典15年i春秋渗透测试系统化教程 - P23：课时2 上传漏洞-服务器检测绕过（MIME、目录路径） - 老网恋教父了 - BV1n54y1B7F7

🎼Yeah。呃，接着讲解，我们把这个呃服务器这个。检测这个loggo这个目录路径检测给大家讲解一下啊，其实就是他这。这一块就是这个灵领夹动啊。我们在这里可以看一下。他这个通过00杂动。

就是说呃后面就是说呃GNF就是说例了我们命个名字呃，对一句话命个名字，它我们先打开一下看一下它这个地方就是一句话木马，我们把它扩展名改一下。



![](img/f27863acc0b245596a427b007f11163c_1.png)

![](img/f27863acc0b245596a427b007f11163c_2.png)

不然它是1个PSP点PSP点GPG后面这个点GPG是我加上去的。命个这样的名字，等一下我们在这里加一个空格，就是在这个地方。攒动一下。加个空格，因为在windows号系统里面。

我们就它这个地方如果加一个空格的话。它也是可以的。那么这样解析的时候啊，向前解析的时候，那么如果遇到空格，那么后面一节。他就去掉了。啊，它就去掉了，就就剩下前面一节。因为在解析的时候。

它是它程序在碰撞的时候，通过后面来碰断。啊，通过后面来判断的，比是先判断，如果扩张名是点击BG点，那么也许上去。好，我们来看一下这个。



![](img/f27863acc0b245596a427b007f11163c_4.png)

那么在这个。也就是说，检查一般是检测这个路径是否合法，但是稍微特殊一点，它是没有做防御。比方比如说啊这个编辑器FCK。AD层这个编辑器，也就是说只要说它是它的版本是小于等于2。6。4的。

那么它都存在这个类意文件上传带动。在婺源上面也有啊，婺远这个地址我提供给大家，大家自己去看一下。

![](img/f27863acc0b245596a427b007f11163c_6.png)

![](img/f27863acc0b245596a427b007f11163c_7.png)

这是一个列案例啊一个案例，等一下我就不用这个编辑器了，我等一下直接是通过这个。

![](img/f27863acc0b245596a427b007f11163c_9.png)

DVWA啊，这个上传的也是这个灵载道啊，灵林载道，它这个灵灵载道就是白命呃白命大烙果啊。也就是说，只要是对路径啊，目录路径检测不够以严谨的，哎，一般会导致这个年龄在大。这个在上传的中用的是最多的哈。

我用的是相当多的啊，都是展断一下，看一下能不能上传一个嗯。我马上去。

![](img/f27863acc0b245596a427b007f11163c_11.png)

呃，这个你看到这里，它这里一个上传，通过PSP点E这个版本来进行上传。可以看到我这里通过。

![](img/f27863acc0b245596a427b007f11163c_13.png)

等一下演示的话，我通过BRP那部分你好啊一般BRP这个工具还是不常省器，我是用的最多的。

![](img/f27863acc0b245596a427b007f11163c_15.png)

![](img/f27863acc0b245596a427b007f11163c_16.png)

嗯，后面的解释我在这里就不再解释啊，太多的废话。嗯，到时候自己看一下它问题出现在哪个地方。

![](img/f27863acc0b245596a427b007f11163c_18.png)

嗯，这一档我们我们因为我们我这个案例是DVWA的啊，所以在这里演示的时候嗯。

![](img/f27863acc0b245596a427b007f11163c_20.png)

我就不拉这个FCK这个AD上这个这个编辑器来演示了啊，我就是用这个DVWA代替一下啊，模拟一下就行了。



![](img/f27863acc0b245596a427b007f11163c_22.png)

呃，在DVWA大家可以看一下，我这个因为这个C是这个安全级别。

![](img/f27863acc0b245596a427b007f11163c_24.png)

这个DVW总是有一点问题。我这里是产这个楼低级别。

![](img/f27863acc0b245596a427b007f11163c_26.png)

但是他这里又变回来，这以这个上传，但在这个其他的是OK的，没问题的，都没问题的。就这个上传那总是这个。



![](img/f27863acc0b245596a427b007f11163c_28.png)

高啊我可以看一下这个代码。

![](img/f27863acc0b245596a427b007f11163c_30.png)

这蛋嘛。这张代码就是说如果是高的情况下，它是不存的，你灵里加动也没用哈，灵里加动也没用。那么我们这里这里跟我这里找到的呃，因为我这里安全级别没法设置的话，等一下我用BRP来改。改的话。

我这个地方按代码的高中低这个部分代码。那么嗯在网上就。

![](img/f27863acc0b245596a427b007f11163c_32.png)

![](img/f27863acc0b245596a427b007f11163c_33.png)

找了一下啊，还是存在的。嗯，这里我就用这。

![](img/f27863acc0b245596a427b007f11163c_35.png)

这个给大家。把这个几个行代码给大家先过一遍哈，先过一遍。

![](img/f27863acc0b245596a427b007f11163c_37.png)

那么它这个是它的低一位类动的啊，低位类动就是说这个安全级别为低的情况下，嗯，这个低位类动低的情况下，那么它是它的代码，你在这里可以看到它的代码，它的代码是这一档代码，这一档代码。



![](img/f27863acc0b245596a427b007f11163c_39.png)

![](img/f27863acc0b245596a427b007f11163c_40.png)

那么这种程序它是没有对这个图片类型啊，包括这个呃上传的文件大小，没有做过任何的判断，也就直接可以上传PSPM码。看到这个代码就知道了啊。你看它没有去对大小啊、库杂米呀，没做任何限制啊，没有做任何限制。

嗯，他这张大码没有最新的。别人没有这个衣服。衣附条件。但是当他。中位这种，也就是说你的安全级别。

![](img/f27863acc0b245596a427b007f11163c_42.png)

而且安装级别色产如果是均的情况下。嗯，没问级别会赚的情况下。

![](img/f27863acc0b245596a427b007f11163c_44.png)

那么这个这行那么这个代码就变成哪一个了？第二部分代码，那么这部分代码你可以看到这条啊，它这里看到没有？加了一行这个。



![](img/f27863acc0b245596a427b007f11163c_46.png)

上下他们是做什么的？

![](img/f27863acc0b245596a427b007f11163c_48.png)

这个是对这个图，就是相当于我这个地方啊这这一部分讲解的。比如说它只针对这个什么。

![](img/f27863acc0b245596a427b007f11163c_50.png)

![](img/f27863acc0b245596a427b007f11163c_51.png)

呃，图片的类型来进行验证类型，看它是不是GP级的，以及I级的啊类型啊，只是带个对这个来进行判断。那么这个也是不安全的。我们教大家一个方法捞过。比如说我们把这个呃。木马。你随便打开一个图片。He。嗯。

举个例子哈。呃，找个图片啊，立场围一下。你看在这里是吧。还用记时盘打开。Yeah。嗯，这个你不应该GPG的。Yeah。嗯，找个GPG的图片吧。再把这个。把前面这个复制粘贴到这个。

这个木马里面呢这一句话木马里面呢，通过这个种方式就是复制进去之后啊，你再去上去啊。反在生产这个PSP那么他在碰到的时候，也就是说。他在碰到的时候，只要这个。

PSHP这个就是我们这个上传的木木马里面包含了这个头信息啊，包含了这个文件。

![](img/f27863acc0b245596a427b007f11163c_53.png)

![](img/f27863acc0b245596a427b007f11163c_54.png)

播放了这个文件。包含了这个。搬了这个之后，那么他就可以。当然你如果你不想这么做的话，通过工具也可以哈。工具是哪个工具的？一一款工具。你记得是有一款工具啊，专门用到的一款工具。

就是在这个图片里面插上这个一句换木马。啊，这个感觉。看这个工具。要插一句话木马的，要把这个图片拖进去啊，你看。在这个里面。擦。嗯，这个是比这这个比较好的啊这个比较好的。

再把你的这个相当于把这个图片跟这个一句话木码绑定在一起。啊，接着接着讲解啊，这是这这个DVWA的这个第二种方式。这个对这个图片类型来样证。那么第三种是就是说我们这部分代码。



![](img/f27863acc0b245596a427b007f11163c_56.png)

![](img/f27863acc0b245596a427b007f11163c_57.png)

![](img/f27863acc0b245596a427b007f11163c_58.png)

啊，这部分大码这部分大本这里也有，那这里是一模一样的。

![](img/f27863acc0b245596a427b007f11163c_60.png)

这波传弹吗。你看第三部分代码就不一样了哈，它是不只允许你什么。GPG图片的或者大写的大写小写或者GP1级的。还有这个对这个文件的这个上传的文件的大小做了限制，你看。如果你不符合，那不好意思。

他不允许上传。如果你符合，那就上传了。那么这个这种方法是最安全的啊，也是最安全的。

![](img/f27863acc0b245596a427b007f11163c_62.png)

好，下面我们就给大家演示一下，他这个。雷0咋动它是怎么做的啊，怎么做的？那么在这里我就。

![](img/f27863acc0b245596a427b007f11163c_64.png)

嗯，就拿这个吧。

![](img/f27863acc0b245596a427b007f11163c_66.png)

嗯这个一句话我改了个名字啊，两个后缀名，1个PSP点PSP点GPG是吧？那我们现在给大家来看一下。

![](img/f27863acc0b245596a427b007f11163c_68.png)

这一部分我关掉。好。Yes。哦，我来抓包。

![](img/f27863acc0b245596a427b007f11163c_70.png)

呃，在这个地方，我看一下级别哈。他是低级的。把它载录到这个。一克来来调试。那在这个地方。😡，嗯，他这怎么有啊？有无空景吗。好。先把关掉吧。



![](img/f27863acc0b245596a427b007f11163c_72.png)

怎么这个地方有个空格呀？哎，对呀。

![](img/f27863acc0b245596a427b007f11163c_74.png)

Yeah。

![](img/f27863acc0b245596a427b007f11163c_76.png)

嗯，这样行。好了，我们重新抓包一下。你看如果是GPG的扩展名，它是原许上传的。那么我们先把这里删掉。

![](img/f27863acc0b245596a427b007f11163c_78.png)

他已经上选了1个GPG进去。

![](img/f27863acc0b245596a427b007f11163c_80.png)

你看他已经上传上去了。对对？好，现在我们来看啊。

![](img/f27863acc0b245596a427b007f11163c_82.png)

现在我上传。加个8。嗯。

![](img/f27863acc0b245596a427b007f11163c_84.png)

等一下。那么这个你通过这个1六进制来编辑好来修改一下。在这里。

![](img/f27863acc0b245596a427b007f11163c_86.png)

我们找到这个。好，在这一行，那么改哪个地方呢？你应该是。这个地方。双击一下2一改成00。我要看一下电没呀啊。RE改成00，就是这个PHP点PSHP点后面加了一个什么，你看来这里。

我们来看一下它加了一个这样的光影，这个这是00在荡，这是空格的意思，一个空格啊这种空格啊，这种空格它直接可以把后面的。去掉。这个空格后面的然后在解析的时候，它首先碰种的时候啊，它做碰洞的时候。

就是说一看符合条件GPG是吧？嗯我们可以来到这里。

![](img/f27863acc0b245596a427b007f11163c_88.png)

嗯，那个大码。

![](img/f27863acc0b245596a427b007f11163c_90.png)

哎，我这个代码是哎呀。去啊，我们。就直接说一下吧。就是就是说在碰断的时候啊，服器在碰断的时候，一看它是符合条件的，是GPGPG也就扩展名啊，是没问题的。但是在解析的时候啊。他是从后面往前面。啊。

从后面往前面，但是他GPG看到这里一个空格就载动了，它遇见这个空格，那么它它就往前面解析，那前面解析是PSP这是点PSP那么真真正的是这一部分。那么它遇到空格之后。遇到坑改之后啊，他怎么做呢？

他就把这个去掉了。啊，把后面一节。可能不不解析的，他不解析的，明白没有？😡，好，那么我们现在嗯上传一下。嗯，直接在这边勾一下好。



![](img/f27863acc0b245596a427b007f11163c_92.png)

过下来之后，我们看一下它这个地方看到没有？来到这里，它就变成这种了。看PSP点PSP我们双击哎，这是我们的一句话木嘛，对不对？没问题吧。我们再看一下啊，我把它删掉，你该再看一下啊。



![](img/f27863acc0b245596a427b007f11163c_94.png)

它其实是上传来是这个，你看遇到这个空给他把后面一截直接去掉了吧。你看你再看一下，看结果哎，是不是啊没问题吧，那就是这么回事的啊这么回事的。



![](img/f27863acc0b245596a427b007f11163c_96.png)

![](img/f27863acc0b245596a427b007f11163c_97.png)

好，那关于这一部分我们就给大家大概就讲这么多，就年年假当。

![](img/f27863acc0b245596a427b007f11163c_99.png)

![](img/f27863acc0b245596a427b007f11163c_100.png)

![](img/f27863acc0b245596a427b007f11163c_101.png)

他这个00杂乱，你看是他这里哈，他这里还跟我这里还有一点1有一小点的区别。它其实原理都是一样的方法，它这个是一个文件夹，一个路径的，你看看到没有？你看到这里这里一部分。再个点PSP。啊，这个文件夹一样。

也就是说在windows操作系统里面，IN啊这个6。0的情况下，在2003操作系统。他这个只要这个文件夹嗯文件夹文件夹是什么？点PHP的。

也就是说点APR点GSP啊文件夹取名也是可以这样取的呃一个文件夹。就说我们这个路径。

![](img/f27863acc0b245596a427b007f11163c_103.png)

你注意哈。你可以在这里啊建这样的文件夹啊，123。点PSP。嗯。有的是可以直接创建文件夹的。那么你创建一个这样的文件夹是非常危险的。就是说那么只要对方上传了，如果你的服务器存在这样的一个这样的玩意。

那么任何文件加绍一个图片。图片在这个里面也会当做这个PSP来解析的。嗯。当时是这个来PSP来解析，不管这个这个就跟这个扩展名义没关系的啊。只要这个文件夹是这种文件夹，就是说带后缀的。

就是说PSPGSPPRSBX那么后下面的再根据它这个上面的来来解析来解析，是这么回事的。

![](img/f27863acc0b245596a427b007f11163c_105.png)

但是它在这里大家可以看到这里啊，它这里有一个什么一个空格，你看fg点PSHP啊，一个一个空格，就是零0夹动，砸动了点GIF放斜杠。那么这个地方是什么意思来？

也就是说它的意思是就是说把后面一节把它砸掉了啊，只留了Fg点PSHP就跟我前刚才演示的是一模一样的啊。大家可以看到这点，它后面还有一个哈是吧，这个路径啊，这个非要pass这个路径。

这个f科点PSP空格点加F杠斜杠这个。如果他这个地方有个空点，那么后面一节也是一样去掉折叠开克点PSP那是这么回事的。



![](img/f27863acc0b245596a427b007f11163c_107.png)

好，接着我们看一下这个服务让这个检测到过扩展名，这个文件扩展名的检测。嗯，啊这个刚才刚才给大家呃解释过了啊，就是这种的，你看是吧？就对于扩张比检测不强的，实际上还可以结合路径这个攻击。比如这种。



![](img/f27863acc0b245596a427b007f11163c_109.png)

Yeah。