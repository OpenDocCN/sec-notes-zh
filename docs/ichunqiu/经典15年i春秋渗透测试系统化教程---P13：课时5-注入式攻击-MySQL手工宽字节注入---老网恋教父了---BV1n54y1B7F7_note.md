# 经典15年i春秋渗透测试系统化教程 - P13：课时5 注入式攻击-MySQL手工宽字节注入 🔍

在本节课中，我们将要学习MySQL手工宽字节注入的原理、利用方法以及防御措施。宽字节注入是针对特定字符集（如GBK）环境下，绕过单引号转义过滤的一种高级注入技术。

![](img/8e142ed4f333922dcb01885a44f48485_1.png)

![](img/8e142ed4f333922dcb01885a44f48485_3.png)

## 概述 📖

上一节我们介绍了基础的SQL注入原理。本节中我们来看看当应用程序对单引号等特殊字符进行了转义过滤（例如添加反斜杠`\`）时，如何利用宽字节编码的特性来突破这种防御，实现SQL注入攻击。

## 问题重现：转义导致的注入失败

在渗透测试过程中，经常会遇到应用程序使用函数（如`mysql_real_escape_string`）或开启PHP的魔术引号（`magic_quotes_gpc`）来过滤用户输入。这会将单引号`‘`转义为`\'`。

例如，未过滤的查询语句可能是：
```sql
SELECT * FROM users WHERE username = ‘admin‘
```
经过转义后，语句变为：
```sql
SELECT * FROM users WHERE username = ‘admin\‘‘
```
此时，单引号被反斜杠“保护”起来，失去了闭合字符串的作用，导致后续的注入代码（如`‘ OR 1=1 -- `）无法生效，因为整个`admin\‘`被当作一个普通的字符串值。

## 宽字节注入原理 🧠

宽字节注入的核心在于利用数据库连接使用的字符集编码（如GBK、BIG5等）。在这些双字节字符集中，一个汉字由两个字节组成。

反斜杠`\`在十六进制中是`0x5C`。当我们输入一个特定的、编码首字节为`0xDF`的繁体字（属于GBK字符集）时，例如`運`，其GBK编码为`0xDF5C`。

数据库在解析时，如果连接字符集设置为GBK，它会将`0xDF5C`识别为一个完整的汉字“運”，而不是独立的`0xDF`和`0x5C`。这样，原本用于转义的反斜杠`0x5C`就被“吃掉”了。

**攻击过程可以概括为以下公式：**
```
用户输入：%DF‘
转义后：%DF\‘ (即 0xDF 0x5C 0x27)
数据库（GBK）解析：将 (0xDF 0x5C) 解析为汉字“運”，剩下 (0x27) 即单引号 ‘
最终效果：单引号成功逃逸，可用于闭合语句。
```

## 手工宽字节注入实战 ⚔️

以下是进行手工宽字节注入的关键步骤。

### 第一步：检测是否存在宽字节注入点

1.  在可能的注入参数后尝试输入单引号`‘`，观察是否被转义为`\'`。
2.  如果被转义，尝试输入`%df‘`（注意`%df`需要URL编码）。观察报错信息是否变化，或是否能够成功闭合语句。

### 第二步：利用逃逸的单引号进行注入

当确认`%df‘`能使单引号逃逸后，即可进行常规的联合查询等注入操作。

例如，假设原查询为：
```sql
SELECT * FROM articles WHERE id = ‘$id‘
```
攻击者输入：
```
%df‘ UNION SELECT 1,2,3 --+
```
经过转义和数据库解析后，实际执行的语句变为：
```sql
SELECT * FROM articles WHERE id = ‘運‘ UNION SELECT 1,2,3 --+‘
```
这样，联合查询就被成功执行。

### 第三步：获取数据

一旦注入成功，后续步骤与普通联合查询注入一致：
1.  判断字段数。
2.  确定回显位。
3.  查询数据库名、表名、列名。
4.  获取敏感数据。

## 宽字节注入的防御 🛡️

上一节我们介绍了攻击原理，本节中我们来看看如何有效防御宽字节注入。

防御的核心在于统一字符集，并避免使用可能导致误解析的宽字节字符集。以下是主要的防御方案：

**设置数据库连接字符集为二进制或UTF-8**
在建立数据库连接后，立即执行以下语句（以MySQL为例）：
```sql
SET character_set_client=binary;
```
这条命令将客户端的字符集设置为二进制，这样输入的任何字节都不会被组合解释为宽字符，从根本上杜绝了宽字节注入。

**使用预处理语句（参数化查询）**
这是防止所有SQL注入（包括宽字节注入）的最有效方法。它确保用户输入的数据始终被当作数据处理，而非SQL代码的一部分。
```php
// PDO 示例
$stmt = $pdo->prepare(‘SELECT * FROM users WHERE username = :name‘);
$stmt->execute([‘name‘ => $username]);

// MySQLi 示例
$stmt = $conn->prepare(‘SELECT * FROM users WHERE username = ?‘);
$stmt->bind_param(‘s‘, $username);
$stmt->execute();
```

**避免使用GBK等宽字节字符集**
在项目初期，尽量使用`UTF-8`等安全字符集。如果必须使用GBK，请确保严格按照上述第一种方法设置`character_set_client`。

**禁用魔术引号**
魔术引号（`magic_quotes_gpc`）是一种落后的、不可靠的防御方式，在PHP 5.4及以上版本中已被移除。不应依赖它进行安全防护。

## 总结 📝

本节课中我们一起学习了MySQL手工宽字节注入。我们首先回顾了单引号被转义导致注入失败的问题，然后深入剖析了宽字节注入利用GBK等字符集特性“吃掉”转义反斜杠的原理。通过实战步骤，我们演示了如何检测和利用宽字节注入点。最后，我们探讨了最有效的防御方法，即设置`character_set_client=binary`和使用参数化查询，并强调了统一使用安全字符集的重要性。

![](img/8e142ed4f333922dcb01885a44f48485_5.png)

![](img/8e142ed4f333922dcb01885a44f48485_6.png)

理解宽字节注入有助于我们在面对复杂过滤机制时，拓宽渗透测试的思路，同时也提醒开发者在设计安全方案时需考虑字符编码的深远影响。