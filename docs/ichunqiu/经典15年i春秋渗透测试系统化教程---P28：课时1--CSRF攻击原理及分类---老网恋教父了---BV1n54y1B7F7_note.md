![](img/407fc028cead90c57cef088e38121869_1.png)

![](img/407fc028cead90c57cef088e38121869_2.png)

![](img/407fc028cead90c57cef088e38121869_4.png)

# 经典15年i春秋渗透测试系统化教程 - P28：课时1 CSRF攻击原理及分类 🔐

在本节课中，我们将要学习CSRF（跨站请求伪造）攻击的基本原理及其分类。这是一种利用用户已建立的会话状态，在用户不知情的情况下，以用户名义向服务器发送恶意请求的攻击方式。

![](img/407fc028cead90c57cef088e38121869_6.png)

## CSRF攻击简介

上一节我们介绍了课程概述，本节中我们来看看CSRF攻击的基本概念。CSRF是一种网络攻击，它允许攻击者在受害者不知情的情况下，以受害者的名义伪造请求并发送给受信任的站点。

![](img/407fc028cead90c57cef088e38121869_8.png)

![](img/407fc028cead90c57cef088e38121869_10.png)

**核心概念**：攻击者盗用用户身份，以用户名义发送恶意请求。对服务器而言，该请求是合法的，但实际执行了攻击者期望的操作。

这种攻击的危害性很大，可以导致以用户名义发送邮件、盗取账号、添加系统管理员、购买商品或转移虚拟货币等严重后果。尽管其攻击力度有时被认为较小，但在实际渗透测试中，许多网站都存在此类漏洞。

![](img/407fc028cead90c57cef088e38121869_12.png)

![](img/407fc028cead90c57cef088e38121869_13.png)

![](img/407fc028cead90c57cef088e38121869_15.png)

![](img/407fc028cead90c57cef088e38121869_17.png)

## CSRF攻击原理

理解了基本概念后，我们深入探讨其工作原理。CSRF攻击得以实施，核心在于浏览器与服务器之间建立的会话（Session）或Cookie信息。

![](img/407fc028cead90c57cef088e38121869_19.png)

**攻击前提**：用户成功登录网站（如淘宝），浏览器与服务器建立会话，服务器返回Cookie信息并保存在用户浏览器中。此后，用户在同一浏览器中访问其他页面时，浏览器会自动携带此Cookie，无需重新登录。

![](img/407fc028cead90c57cef088e38121869_21.png)

![](img/407fc028cead90c57cef088e38121869_22.png)

攻击者正是利用这一机制。当用户处于已登录状态时，如果访问了包含恶意代码的页面（攻击者构造的页面），该页面会向目标网站（如淘宝）发起请求。由于浏览器会自动携带用户的合法Cookie，服务器会认为这是用户的正常操作，从而执行恶意请求，例如转账给攻击者。

**攻击流程总结**：
1.  用户登录网站A，建立会话。
2.  用户在未退出网站A的情况下，访问了恶意网站B。
3.  网站B返回的页面中包含向网站A发起请求的恶意代码。
4.  用户的浏览器执行该代码，并自动携带网站A的Cookie向网站A发送请求。
5.  网站A服务器验证Cookie有效，执行该请求（如转账操作），攻击完成。

![](img/407fc028cead90c57cef088e38121869_24.png)

![](img/407fc028cead90c57cef088e38121869_26.png)

以下是CSRF攻击实施的两个关键侧重点：
*   **存在有效的会话或Cookie**：用户必须已与目标网站建立会话，或者浏览器中保存了有效的登录状态信息（如“记住密码”功能）。
*   **欺骗用户访问恶意URL**：攻击者需要诱使用户点击链接或访问包含恶意代码的页面。这常通过与XSS结合、在论坛发布带链接的图片、或捆绑在软件中等方式实现。

![](img/407fc028cead90c57cef088e38121869_28.png)

![](img/407fc028cead90c57cef088e38121869_30.png)

## CSRF攻击分类

![](img/407fc028cead90c57cef088e38121869_32.png)

了解了攻击原理，我们来看看CSRF攻击的分类。根据攻击发生的位置，主要分为站外和站内两种类型。

![](img/407fc028cead90c57cef088e38121869_34.png)

![](img/407fc028cead90c57cef088e38121869_36.png)

![](img/407fc028cead90c57cef088e38121869_38.png)

**站外CSRF**：
其本质是传统的外部数据提交问题。攻击者预测请求参数，在站外的Web页面中编写脚本或伪造表单请求。当已登录的用户访问该恶意页面时，就会被强迫向目标网站发送恶意请求。

**站内CSRF**：
这类漏洞常因程序员滥用`$_REQUEST`这类变量造成。`$_REQUEST`可以接收GET、POST等多种方式的参数。例如，一个修改密码的功能本应只允许POST请求，但如果程序使用`$_REQUEST`获取参数，则GET请求也能生效。
攻击者可以将构造好的恶意请求参数放在站内帖子的图片链接（`<img src="恶意URL">`）中，任何浏览该帖子的已登录用户都会在加载图片时被迫发起这个恶意请求。

## CSRF漏洞检测方法

![](img/407fc028cead90c57cef088e38121869_40.png)

![](img/407fc028cead90c57cef088e38121869_42.png)

![](img/407fc028cead90c57cef088e38121869_43.png)

最后，我们学习如何检测CSRF漏洞。检测工作可能比较繁琐，但有一个核心的简单方法。

**核心检测原理**：抓取一个正常的请求数据包，去掉`Referer`字段（该字段表明请求来源于哪个页面）后重新提交。如果请求依然被服务器成功接受并执行，那么基本可以确定存在CSRF漏洞。

以下是常见的检测方式：
*   **手动检测**：使用Burp Suite等工具拦截正常请求，删除或修改`Referer`头后重放请求，观察结果。
*   **工具检测**：存在一些专门的CSRF检测工具（如CSRF Tester）。其原理通常是抓取浏览器中的请求与表单，修改后重新提交，以测试请求是否会被接受。但许多安全人员认为，熟练使用Burp Suite足以完成检测工作。

![](img/407fc028cead90c57cef088e38121869_45.png)

## 课程总结

![](img/407fc028cead90c57cef088e38121869_47.png)

![](img/407fc028cead90c57cef088e38121869_48.png)

![](img/407fc028cead90c57cef088e38121869_50.png)

本节课中我们一起学习了CSRF攻击的原理与分类。我们了解到，CSRF是一种利用用户会话状态进行身份伪造的攻击，其成功实施依赖于有效的用户会话和诱导用户触发恶意请求。根据攻击源的位置，可分为站外和站内两类。检测CSRF漏洞的关键在于验证请求是否缺乏有效的来源校验（如`Referer`检查）。

![](img/407fc028cead90c57cef088e38121869_52.png)

![](img/407fc028cead90c57cef088e38121869_54.png)

![](img/407fc028cead90c57cef088e38121869_56.png)

![](img/407fc028cead90c57cef088e38121869_58.png)

下一节课，我们将通过实际操作来演示如何发起一次完整的CSRF攻击，以加深理解。