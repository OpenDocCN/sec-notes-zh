# i春秋零基础入门Android逆向 - P26：课时1 Android脱壳中的思路，技巧 - 老网恋教父了 - BV1sg4y1B7zB

好的呃，大家好，我是讲师艾包。那么今天我们来讲一个安卓M的一个脱壳的一课。那么目前的话市面上存在的一种加固服务，就是对一个APK中的一个d文件进行一个加密来达到一个减少体积，还有隐藏代码的一个效果。

啊通常在一种加加密加可的一个技术的话，会让不少的一个新手的立项的话感到无所适从。那么首今从今天开始的话，我就打算用几节课来重点呢去讲一下，我们该如何的去对它进行一个脱壳。啊。

首先先来说一下安卓的一个效的一个大致流程嘛。那么这一种加力像这一类加可的一个软件的话，和window上的一个效，它大致是一样的。它都是先在程序运行的时候的话，先会执行一下可的一个代码。

接着在可的代码之中的话。执行一些解密，还有解码的一个代码，把原始的一个程序的一个代码给还原回去。那么最后再进行一个执行。所以根据这样一个流程的话，我们要脱壳的时候，也是要在它程序解码解密完毕以后。

并且在到达程序的真实入口之前，在它中间的某一个位置把原始代码给原始锁键代码给倒不出来，还原回去。哎，那么这么一来，这么一个解这么一个脱壳就完事了。那当然这里现在也说的很简单。那实际上操作起来的话。

还是有不少的一个的一个坑的。好，那么这里这节课我就打算用一个简单的1个APK文件来进行一个示例。那么嗯我么就来看一下这一节课的一个文件吧。嗯，我们的目目标文件的话是这样一个APK文件。

这是阿里加密的早期的一个版本，是一个呃难度是属于比较偏简单的一个课。我们来看一下啊在安卓Q中加载以后的话，它已经有提示了，这是一个阿里加固的一个课。那么看一下它里面很简单，这一个唉。

刷击过去会它会提示一个一个文件，它类文件已经丢失，没有办法直行打开操作。这是显然的因为它已经把这一个类的文件数据给一个呃一个隐藏起来了。我们在这APV中进行一个打开了。



![](img/2576e293366fab7c5f234ba3650cce49_1.png)

![](img/2576e293366fab7c5f234ba3650cce49_2.png)

![](img/2576e293366fab7c5f234ba3650cce49_3.png)

![](img/2576e293366fab7c5f234ba3650cce49_4.png)

来看一下这个APK文件，可以让我们直接看到的一个函数有多少。

![](img/2576e293366fab7c5f234ba3650cce49_6.png)

那，可以看到这里实际上就只有一个类，只是接着一个叫star application的一个类，把它返问你。哎，可以看一下，它是派设这一个呃它是派设置 application的。

然后它里面在加层代码中什么都没干，基本上什么没改，只是加载加载了一个SO文件呃，这个SO文件的话就是一个呃。好，这是这个内中哎仅仅做了这样一个操作。好，我们再来看一下这样一个东西吧。哎。

首先呃这个APAPK中先来看一下它的一个mini face啊，这个东西的话就像我前面已经说过了，那个mini face文件的话，就指明了整个呃整个APAPK文件所有的一个窗体的一个入口。

还有其他各种各样的一个属性。啊，可以看一下这个APK比较简单，看一下它的Tt，它里面就是一个窗体，再有一个soLRinion的一个窗体，它里面有两个属性，一个 main属性。

还有个lo属性证明它是整一个程序的一个入口点。但是哎像它这样它代码已经被隐藏起来了，这里已经无法直接加载了。那么整个APK程序怎么样能够呃正常打开呢。哎，这是因为对于所有的ITT来说。

有一个更早于他们执行的一个类。这个类就是这样一个application的一个类了。这个东西我们看一下这application的一个标签，我们看一下有个安卓点 name。唉，那么这里只下了这样一个类。

就是application的那一块，是早于所有的1个XT集中优先执行的。所以有很多的可，基本上所有所有的可都是选择在这样一个东西地方执行它的一个解可的一个代码。好，所以对于这样一个ja壳程序中。

我们要一定要注意一下这样一个的一个标签呢。

![](img/2576e293366fab7c5f234ba3650cce49_8.png)

那就是这里了，这是一个可的一个入口，一个application标签中。还有另外一个就是一个程序的一个入口，带 main launch的一个属性的一个activity。



![](img/2576e293366fab7c5f234ba3650cce49_10.png)

好。这里它的一个入口点在这里好，转过去，它里面就加了加下这样1个SO文件。那然后后面什么都在1个SO层，在1个GI层进行一个执询了。好，那这里我们就找找到这样1个SO文件进行一个分析了。



![](img/2576e293366fab7c5f234ba3650cce49_12.png)

这是一个自压缩包，直接进行一个解解压缩。

![](img/2576e293366fab7c5f234ba3650cce49_14.png)

然后呢找到我们要分新的SO文件打开。嗯。好，那么这里我们就可以开始了进行一个分析。那么这里先来说明一下吧啊，像在一种脱壳的一个用到的一些技术的话，肯定是我啊前面的所有课程的一个技术的一个综合。

所以如果前面有哪些课程是跳过的话，那么这节课很有可能就看不懂。那么这个时候建议大家还是把前面的一些课程先翻一下，特别是那些开发的课程，开发相关的课程，虽然那那个比较枯燥。

但是绝对是这一个解解密的课程的一个基础的。好。我们就来进行一个分析吧。嗯。哦，好，先来做一下哈。整一个程序它对原始的代码进行了一进行了一个ja可进行了一个保护。

那么它必然有一个地方是用来存储原始的一个代码的。哎，那么这个地方很显然，就是这样一个ss资源的一个地方了，我们找到它打开，可以看到有4个文件，那4个文件，显然就是存储与存储原始的一个代码文件了。

找一个所用政制文件打开了。

![](img/2576e293366fab7c5f234ba3650cce49_16.png)

嗯，图片的话我们可以不管那么重点的关注一下这三个文件。好呃，是一个pa文件，还有一个呃juice文件，之显然是被某种算法进行压缩过的，对吧？前面标志位是这种样子的，然后后面数据都是没有办法直接看到。

都是被加密过后的一个代码。然后这里是一个f点JR，这是一个非常简单的一个ZIP压缩包啊，实际上这个文件的话是不怎么重要的。我们可以直接忽略。



![](img/2576e293366fab7c5f234ba3650cce49_18.png)

那么这一节啊这一里呢，我们就重点啊去关关注这两个文件，就是一个class点JAR文件，还有一个f点JR文的data文件。这个助力state文件。我们重点关注这两个文件，在SO层。

在这NI层是如何的对它进行一个操作的。啊。把这样一个前提，前面的数据给取出来以后，我们开始进行一个分析。呃，首先是IDA中打开我们的1个SO文件来去直接进行一个分析网。好。拖进去打开。

然后找到里面的两个leted的一个函数，就是这样一个attach base的一个函数，还有一个是on ch的一个函数。我们在SO层找找找到它对应的一个实现。嗯。

这里直接要进行一个搜索pot base contest。

![](img/2576e293366fab7c5f234ba3650cce49_20.png)

好啊，这里把这个关掉。嗯，可以看到的话，这也是不能直接搜索出来的啊，这是非常理所当然的。因为它是一个动态注册过的一个东西。那么关于动态注册哎，关于动态注册。

我们来看一下我们前几节课节课所写的一个呃一个SO的一个函数，1个GNI的函数，就已经知道我们我我们的注册一般都是放在一个GNI哦漏的一个函数中进行一个执行的。



![](img/2576e293366fab7c5f234ba3650cce49_22.png)

![](img/2576e293366fab7c5f234ba3650cce49_23.png)

那么这直接直接跳转过去吧。这于阿诺函数就是所有的SO函数的一个入口点了。好，迁过去。好，这里有一个均安网络函数。那么在这里很显然就是对我们的一些类似的函数进行一个注册。

那么就是对应着对应着这里的这几个函数了。

![](img/2576e293366fab7c5f234ba3650cce49_25.png)

跳这稳路。好，最新落，然后下上面再写个按。首先呃GI文度函数里面有两个参数，第一个是加VM的一个子针。然后第二个是一个reer的一个保留的一个参数。然后在加VM中。

先通过一个ge的一个函数来获取到1个EMV的一个数据。接着哎那么这里把一个enviment取取出来以后，就能够将样里面的一个rejustlect的一个方法来注册一个nettic函数了。注册的时候呢。

先要进行一个find class来获得一个java class中一个度地方，然后再调一个ment的一个register list的函数。好，这里面有三个参数，一个是前面所翻出来的class。

还有是我们的一个一个指向我们的interface list一个东西。然后第三个参数是它的一个我们要想要注册的一个函数的一个数量。好，那么它大致的一个注册流程是这个样子的。那么这里我们对它进行一个还原嗯。

一样，先来录load它的一个 headfi，我们把GI的一个文件给导入进来。

![](img/2576e293366fab7c5f234ba3650cce49_27.png)

好。导进来，然后这里进行一个插入。死间R1N1。然后这里就用一个Y进行一个变量重命名。第一个参数是一个价V。第二个第二个是一个Y的指针，不管，它是re设的是边。

然后他第一步调样给environment是不是和我们编程的时候一样，先调用给environment来获得我们的1个EMV的一个。烟面的一个。东西。

然后下面进行一个fine class来找到我们想要注册的一个类。还有呢这里就就是到这样一个s application中，哎，来找找到这样一个类，然后注册一个let get的函数了。好。

register net是对应着我们这里的一个函数了。首先这是一个class，然后是它的一个genetic method的一个结构体。这里要注册两个函数。好，这是个重命名。我们跳过去吧。

看一下这里的一个地址指向两个函数，这里哪两个函数来看一下att base contest。

![](img/2576e293366fab7c5f234ba3650cce49_29.png)

还有一个oncre函数，就和我们自己的一一对应了哈。那么这里就是它一个呃闹钟，先进行一个注册。进行一个注册，我们把一些方法名字给明名上去，然后把它一些数据给搞上去。

啊op pleasease contact它的机子机址是这一个地方。记录一下。然后是一个onc的一个函数。어 그래 한숙 쓰니까。好，那么这里就是一个在GNI文度中进行一个注册的一个地方。

然后这里就通过这样一个函数分析，就已经取得到了它的一个两两个let message的一个地址了。好，那么问题就来了，为什么一定是这两个方法呢？其实其实这是有一一定的一个道理的。

那么对于这样一个application的一个类，就是一个java中的一个application的类呢，它是啊比较特殊的。因为它有两个函数。

一个attach base content函个onc函数啊onc函数就不用说了。它在一个类中的个对象要创建的时候肯定会调用的。但实际上在这一个函数之前的话，有一个方法，有一个函数是优先被调用的。

就是这一个函数，它是优先于所有的一个方法可以被调用到，所以很多可会在这个函数中执行一个代码的一个还原，对吧？然后在这样一个onre中呢，就来进行一个apbitition的一个构应操作了。

这是一个执行原子的。就是很多代码所呃操进行一个操作的一个两个函数。啊。这这两个函数是自动被样的好，所以我们这里就重点的去关照一下这样一个lic of base contact的函数。

看一下它是如何的去对我们原始代码进行还原的。我们来跳到它地的地方进行一个分析。

![](img/2576e293366fab7c5f234ba3650cce49_31.png)

onre啊，这这该这里这里的话就暂时不分析这样一个oncrel，我们跳到这里直接把命令。好，看一下它里面有三个参数。好，自己的letlet层的三个参数的话，对应着这里哎第一个参数，为什么是三个参数啊？

在这好层中它里面只有一个content那个参数，所以它第三参肯定是一个contest的一个地方。

![](img/2576e293366fab7c5f234ba3650cce49_33.png)

![](img/2576e293366fab7c5f234ba3650cce49_34.png)

那么它前面的两个参数的话，第二个是op over。前面也说过了，那么第一个是一个JRENV的一个参数。好，那我这里前面已经说过，这里就直接略去了。好。这里往下跑过来，我们看一下这个方法中。

它到底怎么怎么样执行。首先它第一个调到的第一个函数是一般ID classes的一个函数，里面传递的一个参数是我们刚才获取到的1个AMBMV的一个参数。好，我们来看一下这个函数做什么，双击跳过去看一下啊。

好，要到一个给我笋。好ge给它的一个获获取到一个java中的某一些属性，某一些变变变量的一些field IDD。另外还有一些方法的一个ID值，把它给保存到一个全局变量之中。啊。

这是对于java层的一些方法，还有一些bu的一个属性进行个获取。那么最后还对它的一个版本进行了java运行整个程序运行的一个版本进行了一个判断，它是运运行在一个de模式下呢。

还是运行在一个ar模式下进行了一个判断。好，这是一个进行一个初始化的一个操作。假如哎它初始化启动以后就调用到下面的一个解合的一个代码了。好，这里就开始执行下去了。好，我们来看一下它的结合代码。

实际上它怎么操作，这是一个ge fast呃，还是一个是ge pass。那么这前面一坨代码呢其实是呃很简单的，不用看了。就是获取一些权局的一个变量，就是它的一些路径。比如说它的一个资源路径。

还有它说它的一个代码，它的资源资源应该释放到哪一个目录下，那前面一坨就是执行这样一个操作和前面无关的。好，直接略过我们往下往慢慢跑慢慢跑。



![](img/2576e293366fab7c5f234ba3650cce49_36.png)

![](img/2576e293366fab7c5f234ba3650cce49_37.png)

来关注一下它是如何的去对我们的一个dess文件进行一个解密的。好，我们现在跑下去，哎，可以看到两个非常关键的函数，一个PDS，还有一个是replace class load cookie的一个函数。

根这名字就能就能够知道，这是这个是对一个d文件进行解码了。那么第二个就是把它给替换到一个class load中去了。好，看一下V38哎，这个配DS的函数中，它两个差数非常简单。

1000美函数是前面传递过来的。那么V38前面初始号为0，显然这是一个输出的一个地方，把这样一个配DS给输出的值哎，放到下面的一个函数中进进行进行一个执行，给进行一个替换。

所以这里也很显欢这个函数是我们最为关注的一个函数。那么在在这个里面的框就完成了对ds文件进行一个解密，还有还原的一个操作。我们就来看一下这里面是怎么进行一个还原网，直接进行一个调试。



![](img/2576e293366fab7c5f234ba3650cce49_39.png)

好，把断点下好进行一个调试。调色框走走到一个限定命令行中去。

![](img/2576e293366fab7c5f234ba3650cce49_41.png)

然后调色的话就打开一个。打开一个笑吧。

![](img/2576e293366fab7c5f234ba3650cce49_43.png)

哦，然后是一个。

![](img/2576e293366fab7c5f234ba3650cce49_45.png)

好，端口转发，然后就是直接ot。好，那么这里的话是并不能够直接attach的。因为呃因为因为这样一种这样一种application标签，这样一种程序结可的话。

它的程序执行起来以后就瞬间马上就会得到一个运行了。所以我们选择挂接上去的时候，这个时间已经错过了。那么这里我们就应该用一个AS效 star application的一个方法来进行一个逛接。



![](img/2576e293366fab7c5f234ba3650cce49_47.png)

![](img/2576e293366fab7c5f234ba3650cce49_48.png)

![](img/2576e293366fab7c5f234ba3650cce49_49.png)

![](img/2576e293366fab7c5f234ba3650cce49_50.png)

好，我们选择一个。

![](img/2576e293366fab7c5f234ba3650cce49_52.png)

呃，调试的那种帮宝。

![](img/2576e293366fab7c5f234ba3650cce49_54.png)

啊，输入它的一个package类，还有它的一个一1个入口点的一个XTT的一个lan来进行一个挂件。

![](img/2576e293366fab7c5f234ba3650cce49_56.png)

来进行一个启动。好，看一下命令NT面需要AS大杠D杠N。好，那么这里去以调色方式给启动。那么这样启动的时候，整个程序就停留在刚开始下载的情况下。

而且这个时候连 application的一个地方也还没有执行的啊。

![](img/2576e293366fab7c5f234ba3650cce49_58.png)

那么这里也就是这个他刚开始要准备执行这个。

![](img/2576e293366fab7c5f234ba3650cce49_60.png)

函数来一个地方了。好，那这个时候我们就能够进行一个tuch了。找到我们刚需要启动起来的一个函数，一个程序inpression就这一个地方了，我们打开它进行一个调机挂接，然后打开monitor。



![](img/2576e293366fab7c5f234ba3650cce49_62.png)

![](img/2576e293366fab7c5f234ba3650cce49_63.png)

然后在java层中把GDB给挂上去。

![](img/2576e293366fab7c5f234ba3650cce49_65.png)

好，看一下端口啊。他说不能保命靠。嗯，把手不能绑定，靠早搞错了。我因为我打开了1个AI安卓studio。我就得按照studio中呃打开模吧。



![](img/2576e293366fab7c5f234ba3650cce49_67.png)

好，找到我们的一个。嗯，阿里点可选的话都会打开。嗯，好，就是这个程序把它87000面个端口给打开，然后这D边挂上去。好，我这样一来，整个调试就跑起来了，我们跑起来。好。嗯，看一下啊看一下。

他的一个笑链接被中断了好。重重新来一遍吧。

![](img/2576e293366fab7c5f234ba3650cce49_69.png)

嗯，把安卓 studio掉关掉啊，这里关掉，不需要了。嗯。手我先把它的端口给挂挂一下。然后monitor也重新启动一下。



![](img/2576e293366fab7c5f234ba3650cce49_71.png)

我们来重新的进行一次调色。

![](img/2576e293366fab7c5f234ba3650cce49_73.png)

呃，这种情况经常出现，特别是在打开了一个安roidd的情况之下话端口很容易易被占用掉了。

![](img/2576e293366fab7c5f234ba3650cce49_75.png)

![](img/2576e293366fab7c5f234ba3650cce49_76.png)

好，我们从下周进入到一个手机端口。

![](img/2576e293366fab7c5f234ba3650cce49_78.png)

然后进行一个挂接，把这个函数断底给卸下来。

![](img/2576e293366fab7c5f234ba3650cce49_80.png)

![](img/2576e293366fab7c5f234ba3650cce49_81.png)

好，ID跨递上去。

![](img/2576e293366fab7c5f234ba3650cce49_83.png)

找到对应的一个函数，在这我们的程序还没启动，我们启把程程序给启动一下。好找到程序换一上序。然后加往层再挂一下GDP挂上去。好。好，调试起来以后就能够直接跑起来了。



![](img/2576e293366fab7c5f234ba3650cce49_85.png)

好，这里插问vo我们的两个SO是不是一样的，选选择是。等程序运行起来。好，那么这里就已经在我们关注这个函数中给断下来了，我们就开始对这个函数进行了分析啊，它是有两个参数的它是有两个参数的。好。

第一个是in本参数，第二个是一个输出的一个参数。我们来关注一下，哎，把它进进入过去，然后引行一个I服务反问率。我们来看一下它整个程序是怎么执行的。好，第一个参数是一个result。这一个输出的一个值。

来看一下啊。好，首先它判断我们的一个手机的个运行环境是一个derris的模式，还是一个ar的一个模式。如果还是一个dry模式的话，就执行这算代码。好，这里哎已经开始去解我我们的一个压缩文件了。

首先是一个class点接R的一个文件，把它给取出来，现在初始换个fi个函数，然后调一个open的一个函数来打开这样一个加文件，把它保存到内存中去。我们跟踪下去看一下它怎么呃执行。好。

如果我们那1个SDK的一个版本大于13的话，执行这样一个函数。如果不是执行这样一个函数，我们由于我的1个APKAPI版本的话，4点多的话，已经大于13是1个API19的版本。

我们就来选到这个地方下一个断点。我们来看一下这个程序怎么做的啊。好，首先看一下它的参数好，看看到的东西，我们过去看一下这个函数，双击跳过去，然后哎跑原。它里面它里面有几个参数，可以不管。

我们看一下它的一个实现。首先用1个IIF data来获取我们一个文件的文件的一个信息。好，那么这里这里就获取到一个文件的一个大小，然后把它map进内存中去。好，注意一下。

这里就把我我我们整个文件给放到一个内存的一个map中去了。好，这里就放到了一个V6的一个地方啊。那就放到这里。好，这里这边来到日程中去了。接着。使用1个IRC4来对map进去的一个类地方。

就是这样一个内存进行1个IRC4的1个解密。好，继续往下跑，解密完以后啊。哎，审对完以后。好，然后再进行一个什么什么LZMMA的一个决密。嗯，所有一切都解密完以后，就去再进行一个返回。

然后这是一个非常简单的一个内存中解密文件的一个操作。读取并且仅密文件。那么这里就是解免我们我们的一个那个class点DX的一个文件了。啊，既然知道它是一个解密文件的的一个操作。

那么这里我们就可以哎直接不用管，因为它是一个解密操作，对不对？我们关注一下好，关注一下它的它的一些参数，看一下它解密以后的代码给放到什么地方。然后这里就是一个。呃，V虎三折。

那么应该解密以后该放到这个地方，它第二个参数我们来好阿一跑过去看一下。好，那解密以后就放到这里。75199000。好。哎，那么解密完以后，哎，就能看到内存中已经出现了这一个原始的代码。

这是一个des035什么什么什么，这很显然啊是一个des file的一个文件。我们把这个地址给把记录一下啊，这是一个des文件，desify文件。好。这个plus点解密码以后。是一个原始啊。好。

既然哎这里已经把一个原则des文件给给弄出来，我们是不是我们是不是就可以把这些数据给保存起来。哎，那么这样一来就完成了整一个脱壳了。然后我们就跑一下脚本，把它的一个地址给动出来吧。

那么动的话可以使用IDC1个IDC脚本，好，这个脚本也很简单，对吧？打开一个文件，使用很多分写方式打开，开始地址，还有它文的文件长度是这样一个样子，进行一个动。



![](img/2576e293366fab7c5f234ba3650cce49_87.png)

那我们把它炖起来吧。好，那么它的长度怎么算？这是一个这是一个dess文件，它其始地址是这个地方啊，是很很显然。那么它的长度呃，它的长度到底是多少呢？哎。

那么这里我们前几节课学所学到的一个dess文件的知识，就能派上一个用场。我们跑一下一个time内看一下。



![](img/2576e293366fab7c5f234ba3650cce49_89.png)

![](img/2576e293366fab7c5f234ba3650cce49_90.png)

好，看一下它的一个dess head里面有一个fi size，那么这个f size呢就表明了整个ds文件的一个音本来的一个长度。看一下它的长度是19好，是在一个偏音为0差20的一个地方中给。存放的啊。

这里也这样好，放到这个地方，拼拼接为0320，也就是对应的这样一个devo数据，就存放着原始的一个文件大小。



![](img/2576e293366fab7c5f234ba3650cce49_92.png)

好。好，把这是一个低端，之持序把它转过去是0000019CF4。好，那么这里就是一个单itch文件中在列存中的一个大小。好，就这里了，我们跑一下脚本，把它的一个数据给倒出来。好。

那么这里我就把一个动出来数据存放到一个UPUPK动的一个目录之下，我们打开一下。好，那么这里就是我们刚登出来的一个数据。好，打开在这EB中打开来看一下它的一个情况。

那理论理论上这就是这就是一个原始的一个脱数据了。好打开。哎，这P正常加载来对吧？是这种情况，我们随便找一个类中，哎min对吧？这里所有的类已经给给还原出来了，你已经能够看到它了，能找到命反面一。哎。

我们哎这个结果哎这个时候就发现出现一些意外状况，看一下它它里面的每一个函数都是进行一个s，进行postse一个runtime session。哎，这是为什么？这是为什么？

那是因为它虽然它的一个主体主体的dess文件给解码了，但实际上它里面里面的一些函数中的真实代码还没有被解压出来。这这个道理和我们上一节课中所提到所提到过的的一个DVN自串杆的原理是一样的。

它就是在程序执行环节以后呢再对这样一些啊原则代码进行一个还原。哎，这是和我们上节课中所说到那一个自创感原理是一样的。那么它下面就应该有一个还原的一个代码。哎，那么这里就来了。

我们就来看一下它如何的去还原我们正式的代码。好，首先它已经把一个dch文件给读取到这样一块内存中去了。



![](img/2576e293366fab7c5f234ba3650cce49_94.png)

慢慢跑下去吧，接下来他怎么搞怎么搞好。慢跑首先它接下来它会他会判断我我们的API版本。然后如果是大于时尚的话，执行这一段代码。如果不是执行这一段代码，那么这一段代码我们来看一下，如果是大于时尚的话。

就调1个DRop函数来获取1个DRARBDVN的一个机子，就是这一个模块的一个机子。接着读取这一个SO文件中的这样一个函数，这就是一个获取函数地址的一个方法了。好。

ZV andX5这是一个 function的一个函数。好，这样通过对这样一个呃函数列表进行一个变历来获取到哎这一个函数的一个地址。好，这个函数方法，这函数它种什么芯肺管，我们来看一下它下一个。

如果它API版本是小于13的时后。你会发现它会以调另一个函数，这个函数就是就是一个DVMX open。那么这个函数的话我们也应该比较熟悉啊。前前几节课中已经讲到过。

这是在内存中给解析DEX文件的一个函数。那么理所当然的上面这个函数这种也是一样的，也是一样从内存中给对原始DDVM还原des来进行一个解析了。啊我们打开一个按照源代码中来进行一个查看吧啊。

像这样一种呃脱壳的时候一定要多点呃去看一下它的一个源代码要知道它的一些内存的一个数据结构和它的一些方法是怎么做用的。不过的话唉否则哎就会很难搞起来，我们来搜索一下进行一个 project来查一下。



![](img/2576e293366fab7c5f234ba3650cce49_96.png)

啊，这里已经查到这个方法，方法名是这样，然后导出了一个描描述服饰这一个样子。那么对应着它的实现在这里。看一下哈说明对吧？是一个静态静态方法，it an open this file好。

里面是一个fi content，这里里面是传传递的我们的一个des file的一个基时地址了。它这个东西的话，这个函数就会从里面取消我们的argument参数，把它转出来，把它一个UU音的指针。

接着调用到这样一个这样一个函数呢，就会把它给解析成一个DDX加的一个的一个结构体，把它转出来，然后把这个结构体进行一个返回，返回地址存放到这个地方中。好。

这个函数的话唉它做就是把我们内存中的d文件给转成这样一个结构体。好，把这个结构体它实际上怎么样呢？我们后天晚点再讲，先保存一下它数据。这是那个文件进行一个转换的一个结构。呃。

具体的实现的话可以有兴趣和以下下面去跟一下。呃，跟的方法很简单啊，好跑到这里R3的地址的话就是一个open file。好，这已经找到了。好，我们来看一下话，这里面是调一个标叉进行了跳转的。好。

看再看一下R3地址是一个基数，所以跳转过去的时候，同时可以实现一个指令集的一个切换。可以相当一个创模式下。那么真实的指令的基子地址应该是68。好，把一个零弹一弹串。啊，这行一个分析。好。

已经把原始代码给分析出来，然后按PD转向函数。看到么这里就是一个open file的一个函数了。里面的一些参数啊，一些类型呃，喜欢的话可以去跟踪一下。那么这里这里就直接了呃这样你直接接了一个跳过一个。

直接跳过这里就。好，这里调造在个dopen find函数来获取到一个对内内选中的数据进行一个解析完以后，解析完以后往下跑会发生什么事啊？首先取出一个V48，那么这里在一个取出来的一个参数就是。

遇上了这样一个词呢。这个值就是我们刚取出来的一个反反合值，这是一个呃D一FO这的结构体，这个结构体到底能够做什么？好。嗯，到底到底能够做什么？先不鉴别款。好，我们往下跑。

我们来看一下它到后面到底做了些什么东西。好，那么后面问题就来了，它下面哎又打开另外一个文件，就是这样一个juice data的文件。

然后使用这个文件对我我们的原始dess文件进行了进行进行了一个patch的一个操作。也就是对它的原始dess文件进行一个某种的一个修复操作。很显然。

这个修复修复操作就是便历它的一个内存的一个desdes的一个结构体，然后把一些code的一个大脑给还原过去。好，这就就是一个还原还原成的一个操作了。好好啊，目前它怎么还原，我们暂时不关心。

我们只看一下这个函数过后，哎，它对我们原始的一个单词文件的一个代码产生了一个什么样的一个修改。好，我们看一下它们的一个参数啊，20的参数跳过去，发现它是指在我们我们的一个des file的一个息的地址。

来，注意一下这个des file的一个地址的话，它和我们刚才记录下来的下来了。在那那个地址的话是不一样的。因为这个地址的话是经过一个解析过后的一个despo JR文件的一个地址。

这是被安卓中安卓系统中给列出来的。他们的一个虽然他们的一个地址，他们的内容是一样。他们但但是他们的地址是不一样的，这是由安卓系统本身所管理的一个地址。这是des的一个地址。好，我们看下去。

然后它第二个参数哎是它的文件长度，19CF4就是这一个长度了。好，这spec长度。然后22是一个另外一个信息。好，那么这个函数过后，哎。

它就会对这样一个内存内存中的一个数据进行一个patch进行一个patch。我们来看一下patch过后的一个效果是怎么样的。8三步步过。好，那么这里。已经对我我们的内存产生了一个修改了。

我们再次把这一个内存数据给动出来。来看一下，看一下它怎么回事。好，其他的不变了，继续跑这一个脚本，把它放动机吧。好。好，脚本。那么倒出来数据就放到这个地方。这是一个大米一的。好，他们两个很显然是不一样。

我们来看一下他被 patch过后是怎么样的样子的。

![](img/2576e293366fab7c5f234ba3650cce49_98.png)

好，对比一下。好，哎，这里看到了吧，这里的这些数据，这些偏直向偏移地址的数据呢已经被补丁过了。好，本来哎是这样样子，就补丁成这个样子。好好好，那么这些偏移都被经过补丁过了。好，经过修正过了。好。

既然是修正过。那么这里动不出来数据就应该是原始的数据了。好，我们再来注B证载度分析一下。这杯鸡打开。对，这一个时候他报了一个错误，他说这是一个无效DNS文件。但是为什么？啊，我们既然这个d文件还有问题。

我们就来在I010艾侧中打开来跑一下一个模板来看一下它存在哪些问题。

![](img/2576e293366fab7c5f234ba3650cce49_100.png)

好。他犯一个错误好，这是个管，我们来往下看一下。这里主要就关心一下我我们的一个class data。好，可以看到这里的所有class data都变成了一个ever的一个标志符。

就表明了在这里就发生了一个解析上的一个错误。我们打开看一下啊，class data of size好，class data item跑过去，然后是一个加密的方法。好。我们来跑一下。

看一下它的co and code就是在哪个地方。这里本来应该是指向它的一个方法的一个实现代码的，就是那个desash code的一个结构体。但是啊。但是这里唉他说哎他这是一个结构体。

它的指针偏移地址应该是1个1A8A0的一个地址。但是这个地址指向已经于已经超出了整个ds文件了。证明我们当初动出来的一个ds文件，已经不包括这个扣的一个地址了。来说明程序解码完以后呢。

他就把它把它的代码给放到它的一个ds文件的文件的一个画面。那么这个时候我们要处理也很简单，把它外面的数据也补进来就完事了。



![](img/2576e293366fab7c5f234ba3650cce49_102.png)

我们看一下这样1个1A810的一个数据。大8那个数据。它在哪个地方？好，本来本来嗯这里是一个。本来它有一个类似基诊室的一个地方的哈。751B3008，这是一个带什么件机子。

然后加上它的1个1A810的一个长度。哎，那那那那么可以发现它的一个扣地址就存放在这个D875147514，然后DYA8的一个地址，我们找到它。好好，在这个段里面，在这个段里面75148A8。

也就是说真实的DEX的一个地方应该是包含这两个段的一个数据的。所以我们要同时把这两个段给动出来。好，我们就直接到码。好，我们我们把它的大小给去计算一下这一个另外一个大期线的地址是1个CD00。

然后结束地址是1个751514000。好。减去它其实地址。是751B3008，就是这个地址了，把它长度算一下是30F8。那么这个才是这一个ds文件的真实的一个地址。好跑一下这个脚本。再炖一次。好。

跑完脚本以后，嗯，我们再来解释一下。这是我们第二次动出来文件啊，大多了196K。

![](img/2576e293366fab7c5f234ba3650cce49_104.png)

继续用这一边右打开。

![](img/2576e293366fab7c5f234ba3650cce49_106.png)

好。哎，那么这么一来，这已经能够非常解析了。打开一个类看一下，哎，可以看到它里面的真实代码已经给全部给补上来了。那那么到这里为止，哎，我们的to壳已经成功了。



![](img/2576e293366fab7c5f234ba3650cce49_108.png)

这是一个呃脱壳基本步骤，是就是在它一个内存中。找到它原始的d文件代码给进行打开，进行一个出口。好，那么这是一个to壳的一个大的大字操作啊，当然呃如果就to壳来说，到目前为止已经完事了。

但是我们有追求一点，我们来看一下它是怎么来还原我们的一个代码的，就是这个函数，它是怎么然样对原始的一个但词代码进行一个还原的，我们继续进行一个调试，重新来一遍好，进行一个调试。把旧的一个GB给关掉了。

还有一些结构体一些方法。直全方。

![](img/2576e293366fab7c5f234ba3650cce49_110.png)

我们重新来调一遍，来分析一下那个方法，看一下它是如何的。去对我们的一个dess单质检码进行一个解析。然后就可挂街跑起来。嗯，怎量才去跑起来好。好，这里已经断在一个Opre。pressDX中继续跑。

因为这是一个open fire head的一个函数中跑下去，这是一个呃这边open five的一个函数。好，那么这里就是我们要分析的一个函数了。

我们又超我们又回到这个函数中DXG的pack就是一个对let存中的de数据进行一个修正的一个函数。我们往下往下走过去来看一下啊，这个函数里面做了些什么东西啊。好。

首先打开了我我们的一个juice data了。好，向下跑把它map倒入水中去，这样一个II map的一个。东西来把麦放这中去。然后哎这个循环中这个循环中就来对我们的一个原始数据进行一个补定。

那么这这样的一个补贴的话，哎，实际上就是和一个DVN支串改是一样的。只是说哎这里有点不一样。我课程中叫了一个支串改，是直接修改一个exstruct的一个数据。

那么这里就是一个patch一个DEX code的一个数据了。这里的表就是这样一个 code的一个数据。好的，这是一个修复，我们来调一下焊下哈。跑跑到这个函数。单幕进行一个单幕调试。

看一下它的一些函数调码，这是那个函数。呃，这是一个reULB118函数，然后对应着下面的话就是一个。这是一个pat的一个写的一个函数了。那么这里就是一个wa的一个函数。看一下它的一个尺寸。

还还有这些操作之类的。嗯，来看一下他的一个地址吧。慢慢跑下去。好，这个函数，这也就是就是一个pat的一个函数了。看一下它的地址。第一个是它的一个dess文件的起始地址。然后第二个是它的一个偏离地址。

然后第三个就是要写入的一个偏移数据。好，那这就是一个patch的一个函数，它也是一样，哎也是一样。对于这类夹壳解壳软件也是一样，它内存中要还原DS数据的时候，肯定是要定位到相关的位置。

然后直接的哎对内存的页内存的数据进行一个读取进行一个修改。好，把这个修改给搞完以后，哎，就能够正常的把一个带数据给还原回去，给加载起来了。那么这是呃对于在dary中加密。

还有加可加固的一个通用的一个方法，也是我在上一节课中所提到的一个方法。这都是通用的哈，所以上一节课唉为什么要讲这个加密。啊，这是为了就是为了我们这里的一个服务了。好。这己就知道了哈。

跟这个东西就已经过了。那么这里就。这个加密的话就算是到此为止了。那么这里我们就来再关系一个结构体，就是这样一个des呃这样的结构体。这个结构体的话，在刚才的一个函数中。

也就是说呃在这样一个opendes file的函数中给用到就是对内存中的文件进行一个解析，然后给放到这个结构体中去。



![](img/2576e293366fab7c5f234ba3650cce49_112.png)

然后他就是他在对这样一个结构体进行一个操作，把它的一个dash文件给还原起来。我们看一下这样一个des文件，这样一个结构体是干什么是？



![](img/2576e293366fab7c5f234ba3650cce49_114.png)

好，哎，再来一遍，这是一个配。我太去。好嗯，我们再来对程序进行一个调试。碰起来。

![](img/2576e293366fab7c5f234ba3650cce49_116.png)

好，那么又到这样一个desplay的一个函数了。那么这一次的话我们并不禁入并不禁用。我们就看一下它的一个返回的第二个参数。这第二个参数是怎么一回事啊？我们来看一下它有少参数。嗯，后面还要自习个反而。

然腐蚀怎么了？我们来看一下这个函数怎么回事黑色哦。啊，实际上啊我们跑起来，这样画起来。把前面断点给取消掉。错了。太注事儿。Pleases crossss。好。哎，实际上实际上。这个这个的话。

这个函数返黑的时候。好。这个函数的话，它反下的时候呢，是1个DS啊加的一个结构体。那么这个DDX的价角物题非常重要，为什么重要呢？我们来看一下它里面有几个指针啊，所以说DIDX如果是1个DX文件的话。

就会到这个内中。如果不是的话，到这个内中好跑下去会发现呢它里面有一个指针，就是指向这1个DVMDX的，然后里面还有1个DSfi的一个print。



![](img/2576e293366fab7c5f234ba3650cce49_118.png)

那实际上这个程序就是解析这样一个结构体来获取到它加载过去的1个DVNDEX的。所以在我我们脱壳过程中，只要我们有办法来获取到这样一个结构体的话，就能完成一个脱壳了。那当然这里只是暂时做一个扩展啊。

具体的一个说明的话，就留在后面的课程再说。那么这里唉先来说一下，就是这样一个DVMDEX的DXXOJR结构的话，非常重要。可以从这里来获取到这样一个结构体。

然后从这里又能够获取获取到我们的一个DS范的一个结构。好，那我这里我就进行一个呃实实际的一个操作，来看一下如何的一个。嗯，或许吧。好，呃，再来一遍。Yeah。打开。我程序进行个调试。嗯。拖学。好啊。

在这里配DDX文件中，它第二个参数保黑值是一个DX加的一个防馈值跑过来。好，看一下这个地址，这个时候它的这个地址的话是一个。就是这里吧。好。0叉6F774。7868。我们来怎么去解析这样一个结构体呢？

好。啊，这是一个desask or加结构体，对比一下对比一下。我们来看一下它的结构。首先它第一个是一个char的指针，指向它的一个fin length。这在1个6F747880，哎。

它内存中的名字叫做memory。好，这个结构体名字叫memory。啊，继续跳回去。我们继续进行一个剖析。然后它第二个结构体就判断它是不是一个dash文件，这也是01，表明它是一个dest的文件。

如果它是dash文件的话，哎，那么它的这一个指针就有效了。如果是没不是的话，那么就这个指针生效，那么这里就是这样一个ro dash file的一个指针生效了，就这一个地址的一个类存数据了。好，嗯。

这里就是一个rDX的一个指针，它里面比较简单。第一个是一个char指针。那么第二个就是一个只剩1个DVNDX的指针了，就是这里的一个地方就是只剩一个DVNDX了。好，对这个数据唉。

那么大家呢已经知道怎么做了。好，第一个是DXDEX five指针，那么它第二个是一个head的一个指针，想取哪个来用都可以。好，使便用一个好，747750，取说DX five。DNX放在框里面。

第一个是OVD head，然后第二个是一个dess head，那么它没有优化过，那么这内就只有一个dess head了。哎，那么这里也是一样。

同样的可以通过这样一个对1个DNEX呃加了一个文字的一个结构进行一个并例，同样能够取出来我们的一个dash file呢在内存中的一个位置了。哎，那么后面想要写脱可加啊之类的。

就可以通过这样一个方法来进行一个入手了。好，这里当然这里也是一样，简单的介绍一下而已。好，嗯，我们就来完成一个后续的操作了，既然在这里我们已经把一个原始的一个dash文件给动出来了。

这样直接动起来并没有意义，对吧？那我们的目的是要进行一个脱口。哎，那么那么我们就要把原始的一个ds数据，一个d的一个画一个结构体给还原回去，就是这个东西给还原回去。那么怎么做呢？怎么做呢？哎。

这样你来简单了，简单打开我们的个PKwo。

![](img/2576e293366fab7c5f234ba3650cce49_120.png)

然后进行一个防便疫。好，使用bamar的一个指令，把它进行一个变译。好，并到这样文件夹中去。

![](img/2576e293366fab7c5f234ba3650cce49_122.png)

那么这里就是它原始的一个smar代码，对吧？然要把这样一个smarile代码给拷贝到原始的APK中去，就这一个目录像。



![](img/2576e293366fab7c5f234ba3650cce49_124.png)

哎，你审么录像好，拷虑过来，接着把它的一个可能入口点给删掉。这里的application标签就是对应着一个可能入口点，把它把它给删掉。好，哎，那么这样就能够变易便携。

那么这样就完成了那对于这个壳的一个脱特了哈。呃，喜欢的话可以自己在手机中进行一个安装，进行一个测试。好，那么这里就是一个简单的一个脱壳的一个操作。那当然这里呢对于这个壳来说还是比较简单的还是比较简单的。

但是但是他已经呃表明了一些脱壳中呃，最基本的一些步骤，最基本的一些操作，还有说它的一个分析方法之类的。那么后面更加复杂可的话，哎，怎么折么脱哎，还是这样类似的进行的。所以不要担心啊。

后面要怎么拓快还是类似的。还是类似。好，那么这节课的话呃就暂且先到此为止吧，那里面所说说到的一些呃概念啊这些东西的话，希望大家在见面好好的熟悉熟悉。



![](img/2576e293366fab7c5f234ba3650cce49_126.png)

🎼那么这节课的话就到此为止了，谢谢大家。

![](img/2576e293366fab7c5f234ba3650cce49_128.png)