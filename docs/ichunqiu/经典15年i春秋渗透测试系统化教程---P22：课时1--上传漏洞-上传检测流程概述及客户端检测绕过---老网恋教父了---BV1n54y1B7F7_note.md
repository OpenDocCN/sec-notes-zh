# 经典15年i春秋渗透测试系统化教程 - P22：课时1 上传漏洞-上传检测流程概述及客户端检测绕过 🔍

## 概述
在本节课中，我们将要学习Web渗透测试中一种常见且高效的攻击方式——文件上传漏洞。我们将重点了解上传漏洞的基本检测流程，并详细讲解如何绕过客户端（JavaScript）的检测机制。

---

## 上传漏洞的重要性
上传漏洞在OWASP（开放式Web应用程序安全项目）的排名中位列前三位，是一种被广泛利用的攻击方式，也是获取Webshell权限最快的方法之一。

在当今安全性越来越高的体系中，SQL注入漏洞已经很难在安全性较高的站点（例如使用.NET或Java框架搭建的网站）中出现。这些站点通常通过参数化查询、过滤用户输入等方式来防御SQL注入。

相比之下，在非PHP站点的Web安全中，上传漏洞出现的概率和危害性（VD）都很大。主要的攻击方法有两种：注入和上传攻击。在实战中，很多站点都是通过这两种方式来获取Webshell权限。

获取Webshell权限较快的方法还包括文件包含、代码注入和命令执行等。通常，Web站点会提供注册功能，用户登录后，大多数情况下都会存在类似头像上传、附件上传的功能。尤其是一些大型论坛站点，以及管理员后台，通常都存在上传功能。

只要我们经过仔细的分析和检测，就有可能绕过上传验证机制，直接上传Web后门，从而控制整个Web业务。在更复杂的情况下，还可以结合Web服务器（如IIS、Apache、Nginx）的解析漏洞来突破上传限制，获取权限。

---

## 上传检测流程概述
下面我们来看一下文件上传的基本流程。

第一张图展示了客户端通过JavaScript进行检测的流程。当用户上传文件时，有些站点会通过前端的JavaScript代码来检测文件扩展名，例如只允许上传`.gif`、`.jpg`、`.png`等图片格式的文件，而不允许上传`.php`、`.jsp`等脚本文件。

这种方式很容易被绕过。如果检测仅由客户端的JavaScript完成，有两种方法可以突破：
1.  将上传页面保存到本地，删除其中限制文件扩展名的JavaScript代码，然后重新上传。
2.  使用Burp Suite这类工具直接拦截数据包，在数据包中修改文件扩展名（例如将`.jpg`改为`.php`），然后转发给服务器。

第二种方法（使用工具拦截并修改）是实践中更常用的方式。

这里有一个注释需要说明：通常，文件上传采用**POST**请求发送给Web服务器。服务器接收请求并同意后，用户与Web服务器建立连接，并传输数据。这些数据通常包含了我们的木马代码，例如一句话木马。

---

## 常见的上传检测与绕过方法
以下是五种常见的上传检测方法及其对应的绕过思路：

**第一种：客户端JavaScript检测**
这种方法在过去很常见，现在相对少了一些。绕过方法正如前面所述，可以通过Burp Suite拦截数据包并修改扩展名来实现。

**第二种：服务端MIME类型检测**
这种方法会检测文件内容，判断其是否为合法的图片类型（例如通过文件头信息）。如果你将一个木马文件的扩展名从`.php`改为`.jpg`，这种方法可以检测出来。绕过方法通常需要在图片文件中插入木马代码，以绕过对文件头内容的检测。

**第三种：服务端目录路径检测**
这种检测与路径（`path`）参数相关。绕过方法通常利用解析漏洞，例如在IIS 6.0或7.5中，如果文件夹名类似`test.asp;`或`test.asp.`，那么该文件夹下的任何文件（即使是`.jpg`）都可能被当作ASP脚本来解析。我们会在后续课程中详细讲解实例。

**第四种：服务端文件扩展名检测**
这种检测基于文件扩展名相关的黑名单或白名单。例如，在IIS服务器中，默认可以解析`.asp`、`.aspx`、`.asa`、`.cer`等多种扩展名。如果程序员在编写过滤程序时，忘记了过滤某些可被解析的扩展名（如`.cer`），攻击者就可以利用这一点绕过检测。

因此，在编写程序时，强烈建议采用**白名单**方式（只允许特定的几个扩展名），而不是**黑名单**方式（禁止已知的危险扩展名），后者非常不安全。

**第五种：服务端文件内容检测**
这种方法会检测文件内容是否包含恶意代码，尤其是一句话木马。这是非常危险的一种检测方式，绕过方法也更为复杂。

---

## 客户端JavaScript检测绕过实战
下面我们直接来看第一种方法：客户端JavaScript检测的绕过演示。

这里我们使用DVWA（Damn Vulnerable Web Application）来模拟演示。首先，设置代理（例如Burp Suite监听8080端口），然后在浏览器中配置代理。

假设我们有一个包含菜刀一句话木马的图片文件（例如`shell.jpg`），但站点前端只允许上传图片格式。

如果检测是JavaScript方式，绕过很简单。我们只需要在点击上传时，使用Burp Suite拦截数据包。

在拦截到的数据包中，找到文件名部分，例如：
```
shell.jpg
```
将其修改为目标脚本的扩展名，例如：
```
shell.php
```
因为DVWA是PHP写的，所以改为`.php`。然后转发数据包。

这样就绕过了客户端的检测。之后，我们可以使用中国菜刀等工具连接这个上传的Webshell文件（例如`shell.php`），密码就是木马中设定的密码，从而获取Webshell权限。

在实战的渗透测试过程中，如果在上传时弹出一个对话框（例如“只允许上传图片格式”），这通常就是客户端JavaScript检测。你可以通过右键查看网页源代码，找到限制上传的JavaScript代码。

确认后，就可以使用Burp Suite拦截数据包并修改扩展名，无需保存页面到本地。

---

## 扩展名绕过的其他思路
关于修改扩展名，不一定只改为`.php`，也可以尝试其他可能被解析的扩展名。

例如，在IIS服务器中，除了常见的`.asp`、`.aspx`，像`.cer`、`.cdx`、`.asa`等扩展名默认也是可以被解析执行的。

如果对方程序员的过滤逻辑不严谨，忘记了过滤`.cer`这样的扩展名，攻击者就可以将文件改为`shell.cer`进行上传并执行。

![](img/9b40d294f88b17676df86a9ae944c678_1.png)

![](img/9b40d294f88b17676df86a9ae944c678_2.png)

因此，在做安全配置时，建议在IIS中删除这些默认存在但不需要的、危险的脚本映射扩展名。在编写代码时，也一定要记得过滤所有可能被解析的扩展名。

突破方法千变万化，非常灵活。

---

## 服务端MIME类型检测绕过
上一节我们介绍了客户端检测的绕过，本节中我们来看看如何绕过服务端的MIME类型检测。

这种检测方式与第一种类似，但检测点不同。它检测的是HTTP数据包中的`Content-Type`字段。

例如，服务器端代码可能会这样判断：
```php
if ($_FILES['file']['type'] != "image/gif") {
    die("Sorry, only GIF images are allowed.");
}
```
它只接受`Content-Type`为`image/gif`的文件。

绕过方法同样使用Burp Suite拦截数据包。在拦截到的数据包中，找到`Content-Type`字段，例如：
```
Content-Type: image/jpeg
```
将其修改为服务器端代码所期望的类型，例如：
```
Content-Type: image/gif
```
然后转发数据包。这样，就绕过了服务端对MIME类型的检测。

只要服务端是通过检测HTTP包中的`Content-Type`类型来进行过滤的，都可以使用这种类似的方法来绕过。

---

## 总结
本节课中，我们一起学习了Web渗透测试中重要的文件上传漏洞。我们概述了上传漏洞的基本流程和五种常见的检测方式，并重点详细讲解了如何绕过**客户端JavaScript检测**和**服务端MIME类型检测**。

核心要点包括：
*   客户端检测可通过**拦截修改数据包**轻松绕过。
*   服务端MIME检测可通过**修改HTTP包中的`Content-Type`字段**来绕过。
*   文件扩展名的绕过思路多样，需结合目标服务器的解析特性。
*   安全开发应优先使用**白名单**策略过滤文件扩展名。

![](img/9b40d294f88b17676df86a9ae944c678_4.png)

![](img/9b40d294f88b17676df86a9ae944c678_6.png)

下一节课，我们将继续讲解第三种检测方式：**服务端目录路径检测**的绕过方法。