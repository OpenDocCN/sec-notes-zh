# 经典15年i春秋渗透测试系统化教程 - P27：课时6 上传漏洞-解析漏洞及上传攻击框架讲解 🎯

在本节课中，我们将要学习文件上传漏洞中的核心部分——解析漏洞，并系统地了解攻击者如何利用上传攻击框架进行渗透。课程将涵盖Apache、IIS等主流服务器的解析漏洞原理、利用方法，并梳理出一个完整的攻击与防御流程图。

---

## 解析漏洞详解 🔍

上一节我们介绍了文件上传漏洞的基本概念和绕过方法，本节中我们来看看服务器在处理上传文件时，自身可能存在的解析逻辑缺陷，即解析漏洞。

### Apache解析漏洞

Apache服务器采用从右向左的解析方式。当遇到不认识的扩展名时，它会向前（向左）寻找认识的扩展名进行解析。

**核心解析逻辑公式：**
`木马.php.xxx` -> Apache不认识`.xxx` -> 向前解析找到`.php` -> 将文件作为`木马.php`执行。

以下是Apache解析漏洞的关键点：
*   **影响版本**：多个版本存在此问题，例如2.2.x、2.4.x等。
*   **利用方法**：上传名为`shell.php.abc`（`.abc`为任意Apache不认识的扩展名）的文件。
*   **补充技巧**：某些服务器配置支持`php3`、`php4`、`php5`等扩展名。如果黑名单仅过滤了`.php`，可尝试上传`.php3`等文件。

### IIS解析漏洞

IIS（Internet Information Services）的解析漏洞主要分为目录解析和文件解析两种。

#### 1. IIS 6.0 目录解析漏洞

如果目录名包含`.asp`、`.asa`、`.cer`等字符串，则该目录下的**所有文件**都会被IIS当做ASP脚本来解析执行。

**利用方法示例代码：**
```
http://target.com/upload/asp目录名/shell.jpg
```
即使`shell.jpg`是图片文件，也会被当做ASP脚本执行。

![](img/14bb62e5f40950eddbcbcf369348f42d_1.png)

![](img/14bb62e5f40950eddbcbcf369348f42d_3.png)

#### 2. IIS 6.0 文件解析漏洞

IIS 6.0在解析类似`shell.asp;.jpg`的文件时，会忽略分号后的内容，将文件作为`shell.asp`来解析。

**利用方法示例代码：**
```
上传文件：shell.asp;.jpg
访问路径：http://target.com/upload/shell.asp;.jpg
```

#### 3. IIS 7.0/7.5 解析漏洞

![](img/14bb62e5f40950eddbcbcf369348f42d_5.png)

![](img/14bb62e5f40950eddbcbcf369348f42d_7.png)

此漏洞与PHP的特定配置（`cgi.fix_pathinfo=1`）有关。攻击者可以上传一个包含恶意代码的图片，然后在URL后添加`/.php`来触发解析。

**利用方法示例代码：**
```
上传文件：shell.jpg (内含PHP代码)
访问路径：http://target.com/upload/shell.jpg/.php
```
此时，服务器会将`shell.jpg`当做PHP文件解析。

---

## 上传攻击框架流程图 📊

了解了具体的解析漏洞后，我们需要从一个更高的视角来审视整个文件上传攻击的流程。攻击者通常会按照一个系统的框架进行尝试。

以下是完整的文件上传攻击流程图，它展示了攻击者层层递进的试探步骤：

![](img/14bb62e5f40950eddbcbcf369348f42d_9.png)

### 攻击流程分解

根据上图，攻击流程可以分解为以下几个阶段：

**第一阶段：客户端检测绕过**
*   **目标**：绕过网页前端JavaScript对文件扩展名、类型的检查。
*   **方法**：使用Burp Suite等工具拦截修改HTTP请求，或直接禁用浏览器JavaScript。

**第二阶段：服务端内容检测绕过**
*   **目标**：绕过服务端对文件内容（如图片头、文件幻数）的校验。
*   **方法**：在恶意代码前添加合法的文件头（如GIF89a），或将恶意代码插入图片的元数据中。

**第三阶段：服务端扩展名检测绕过**
*   **目标**：绕过服务端对文件扩展名的黑名单或白名单过滤。
*   **黑名单绕过**：尝试大小写（`Php`）、特殊后缀（`php3`、`phtml`）、双写（`phphpp`）、点空格点（`shell.php. `）等。
*   **白名单绕过**：结合解析漏洞（如`shell.php.jpg`）或%00截断漏洞（受PHP版本影响）。

**第四阶段：解析与执行**
如果以上检测均被绕过，文件成功上传，攻击进入最后阶段：
*   **利用解析漏洞**：利用本节讲解的Apache、IIS、Nginx等服务器的解析漏洞，使上传的非脚本文件被当做脚本执行。
*   **利用文件包含漏洞**：如果网站存在本地文件包含（LFI）漏洞，可以上传一个文本格式的Webshell，然后通过包含漏洞来执行它。
*   **直接访问**：如果上传的就是一个脚本文件（如`shell.php`）且路径可知，则直接访问即可获得控制权。

---

## 防御建议 🛡️

本节课中我们一起学习了多种解析漏洞和系统的攻击框架。要有效防御此类攻击，开发者应遵循以下原则：

1.  **使用白名单**：严格校验文件扩展名，只允许指定的安全类型（如`.jpg`, `.png`）。
2.  **重命名文件**：对上传的文件使用随机字符串重命名，避免攻击者直接访问或预测路径。
3.  **隔离文件**：将上传的文件存放在独立的、无法通过Web直接访问的目录，通过脚本程序来读取和展示。
4.  **禁用执行权限**：确保上传目录没有脚本执行权限。
5.  **检查文件内容**：使用服务器端逻辑对文件内容进行二次检查（如图像重绘）。
6.  **及时更新**：保持服务器（Apache, IIS, Nginx）、中间件（PHP）和应用程序处于最新版本，修复已知解析漏洞。
7.  **参考安全代码**：建议学习并参考像`DVWA (Damn Vulnerable Web Application)`中高级别的安全上传代码实现。

![](img/14bb62e5f40950eddbcbcf369348f42d_9.png)

![](img/14bb62e5f40950eddbcbcf369348f42d_10.png)

文件上传漏洞危害极大，一旦被利用，攻击者可能直接获取服务器控制权。理解攻击者的思路和方法，是构建有效防御的第一步。