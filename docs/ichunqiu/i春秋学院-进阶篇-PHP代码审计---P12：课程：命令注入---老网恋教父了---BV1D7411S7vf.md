# i春秋学院 进阶篇 PHP代码审计 - P12：课程：命令注入 - 老网恋教父了 - BV1D7411S7vf

大家好，我是vi。这节课给大家带来的是命令注入。那么从这节课开始啊，我将以实战的方式啊带领大家走进审计的领域。啊本节课的内容。这一个就是命令注入。那么我将以命令注入这个漏洞。啊。

来为大家演示敏感函数法的使用。首先我们来讲解一下命令注入。在P表本中，我们可以对输入进行注入攻击。那么什么是注入呢？啊，注入就是通过领无验证的变量。啊，构造特殊语句，对服务器进行渗透。注入的种类有很多。

还不仅仅只是ser注入。啊，PP中啊有大概这几类注入。命令注入ever注入客户端脚本注入，跨网站脚本注入serQ注入动态函数注入以及呃系列化注入对象注入。那么相信大家应该也不会陌生，命令主入。好。

我们在啊危险函数那节曾经讲过。啊，命令注入就是啊利用可控函数啊，可控变量啊，注入这些可执行外部啊程序和命令的一些函数进行注入。那么现在我们来实战演示。



![](img/088c916c3f67c2c6253594579ea7075f_1.png)

啊，首先我们嗯开始注入，我们就要啊开始审计，我们就要啊把握网站的。

![](img/088c916c3f67c2c6253594579ea7075f_3.png)

呃，情大体情况就是把握大局。嗯，我们看它的源码目录结构。首先我们看。啊，他有dmin文件夹啊。嗯，通过猜测名字就可以知道他是后台管理员的一些。操作。然后inst。嗯，安装安装初始化的地方。啊，s。啊。

就是配置信息之类的。然后user。啊，用户前台用户的操作。最后我们再看到inex，这就是入口。整个一个大局就是这样。



![](img/088c916c3f67c2c6253594579ea7075f_5.png)

那么我们来看inex。入口文件啊，入口文件一般是包含一些配置信息的。所以说我们从入口文件就可以知道配置信息的目录。好后，我们就去看配置。conage。那么我们就可以看到，第一个就是错误报告的显示。啊。

在审计的时候，我们就需要把这句。改了。😊，改成显示。我们要显示所有的。啊，错误信息。方便我们审记。我们显示所有至少12。好，接下来他就是。开始判断是否存在lock文件。啊，不存在，他就需要初始安装。

存在的话，他就继续。然后包含lab。嗯，也就是公共函数。接下来就是。呃，定义一些些电量。嗯，去连接数据库，那么这也就是数据库的一些配置信息。连接完数据库之后，就开启下选。嗯。那么我们接下来继续看lab。

啊，定义时区。然后是判断是否开启GPC。啊，如果没有开启的话，它就执行再函数啊，对我们的输入进行过滤转移。我们来分析一下赛函数。首先是判断他是不是一个数组。如果是的话，那就便利速度继续调用赛克函数。

如果是字符串。啊，就直接转移。如果是数字。那么就用inter去。啊，转化。好，接下来是。啊， thank you one。这是一个seQ语句的过滤。那么看到这里。大概可以是尝试绕过。

我们是否能够啊by pass这个函数。那么我们这里就。就是。你。Maybe。By pass。我们先标记出来。好，继续往下看。嗯，getIPget单个IP就获取IP。我们看到这里的时候。啊。

下一步我们就可能考虑他这里的IP能否伪造。我们伪造之后是否能够啊注入。我们这里也是标记出来。我们把握大局的时候，先看大体，不要急于研究。没笔。唔夹。啊，可能存在注入。

因为我们很明显就看到了onIP和叉FF。那我们继续往下看。Clean input。嗯。dirty嗯，就是。脏的污染的可能是污染的。啊，就被污染过来，变量，我们这里先反转移。

因为我们前面都转译过了叫反转移。好，再利用my circle的一个函数。呃，去转移它。然后是返回好，我们再看。Is peak。嗯，就判断是否是图片。咁叫。啊啊，利用分割啊去获取它的后缀。

然后判断是否是GPGGPG以及片G这几个文件。利用后缀，那我们可能是有上传，而且我们可以上传任意文件，但是文件名我们必须是图片类型的文件名。比如说我们可以啊伪造文件名去上传一个任意文件。Yeah。

那么我们大局基本上是看到这里两个呃重要的关键文件看完。再回到ind。你们在在包含头，我们看看这个header这个文件有什么。啊，基本上就是输出。呃。输出模板的。没什么重要的操作信息。啊。好。

再回到inice。继续看迎带。那么这里。啊，就。是否存在modode？好在in code。啊，包含那这里就可能又存在包含漏洞。include可能存在包含漏洞。好，接下来基本上是没有了。

那么我们看到这个INC我们就基本上可以知道它包含的是about。啊，也就明白了这个文件的作用。好，那么我们现在大局已经完全看完了。我们接下来是真正的审计。那也就是我们的敏感函数参数回溯法。啊。

这节课我们讲的话，我们就利用搜索啊全局搜索关键字。系晚。Find。

![](img/088c916c3f67c2c6253594579ea7075f_7.png)

啊，F in five。我们在当前目录这么多个文件里面去搜索关键字。啊，也就函数名或者其他。那么首先是看看有没有sstem这个关键字。



![](img/088c916c3f67c2c6253594579ea7075f_9.png)

么。他搜索出来CSS文件里面的啊，没有什么用。

![](img/088c916c3f67c2c6253594579ea7075f_11.png)

我们关掉继续搜索。啊，我们用快捷键contl。啊，加F可以快捷调出来，我们再看EXEC。

![](img/088c916c3f67c2c6253594579ea7075f_13.png)

Exect。好，那我们现在看到是两个文件存在这个关键字。很明显我们就看到了。Sell， except。执行命令。好么双击它进入这个文件。啊，也就是他自动跳转到了26行这一句话。好，我们开始分析。啊。

这里是执行CMD这个变量里面的字串，好，再返回到re。好再输出。那么我们在往上看CND从哪里来的。然后我们就看到了这个。啊，条件流程。啊，判断哪个操作系统。然后是是windows就执行上面这句。

不是的话，就下面这一句。好，我们看到C然D它等于pin，加上t。那么我们再往上看太迪从哪里来啊，直接从pos过来的。那么我这里就可以知道它并没有过滤，直接是pos过来的数据啊，就拼接。

然后再进入到sellex这个函数里面。那么他就是可控的。前面我们可以看到这个文件路径在addmin啊文件夹下面，也就是管理员啊，这是管理员的操作。啊。如果我们要执行它，就需要管理员权限。

那么我们这节课啊先不讲如何得到管理员权限啊，我们单纯测试啊，这个命令注入是否能够注入成功。

![](img/088c916c3f67c2c6253594579ea7075f_15.png)

그。

![](img/088c916c3f67c2c6253594579ea7075f_17.png)

好，我们界面上是并没有进嗯管理员目录的链接，我们得自己输入add命。啊，进入到后台。因为开启了呃错报告，并且我们加载了啊插 bug。啊，他就会显示一些错误信息啊，这个是一个警告信息。也是提示信息。

就我们的my circle。嗯，conect这个函数已经过时了。啊，他希望我们用PDO啊，这个啊或者是my circlecleI这个啊这个扩展去执行circle啊，这个是。代码的问题我们不予理会。

那么我们要登录这里是因为是审计的，你肯定会知道管理员的用户密码。然后。9B93。明。好满意看到了pin，那就进入。当然可以啊因为美观，你习惯美观的话的话，你就把。啊，那个。什么错误报告给关掉。

你就前面设置为0，不修改它。好，我们开始测试命令是啊，先测试能不能正常。分行执行。好，这里是正常执行了那为什么是乱码呢？啊，因为这可能是字符集的问题。Yeah。好，我们再来测试。注入。Yeah。啊。

管道服。或MI。好，拼。好，那么这里就返回了我们的呼安麦信息，也就是存在注入。好，我们这个啊命令输入啊，成功验证。



![](img/088c916c3f67c2c6253594579ea7075f_19.png)

然后。我们不仅需要啊会议啊审计找到漏洞，我们还啊希望是能够修复这个漏洞。那么如何修复呢？那么就是过滤这个态。我们聘一般是嗯聘IP或者域名。啊，我们可以考虑用正格啊去。判断。那么我们这里是准备了一个正格。

啊。我们需要在这里过滤。啊，粘贴。我们就过滤太几。啊。如果成功的话。我们就执行这些操作。啊，如果不成功的话。哦，就是。什么都不执行。啊，也可以不存不输入。不输出也可以输出错误信息。系。Yeah。

那就是这样，我们过滤了。我们再去验证一下是否过滤。

![](img/088c916c3f67c2c6253594579ea7075f_21.png)

IP is error说明我们的过滤成功了。我们正常听一个。那么能够正常。正常执行啊，也就不能够过滤，但能够正常执行这个漏洞完全修复了。嗯回到我们PPT。好，我们来总结一下我们的审计思路。啊。

首先我们是通过搜索这个telllex。哦，找找到他在pin的文件夹里面。好，我们就找到了他的一些啊。传递方式从pos。到t再到CMD，然后最后是执行。我们就就是像这样去啊审计。好，修复的啊一般可以修复。

也其实也可以不修复。好，本节课的内容啊就讲到这里啊，谢谢大家的观看。😊。

![](img/088c916c3f67c2c6253594579ea7075f_23.png)