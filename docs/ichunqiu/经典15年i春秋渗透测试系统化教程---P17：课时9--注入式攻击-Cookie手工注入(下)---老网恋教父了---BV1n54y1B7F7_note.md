# 经典15年i春秋渗透测试系统化教程 - P17：课时9 注入式攻击-Cookie手工注入(下) 🔍

![](img/b93e320d15b25a5409d7065adfb16564_1.png)

![](img/b93e320d15b25a5409d7065adfb16564_3.png)

![](img/b93e320d15b25a5409d7065adfb16564_5.png)

![](img/b93e320d15b25a5409d7065adfb16564_7.png)

![](img/b93e320d15b25a5409d7065adfb16564_9.png)

在本节课中，我们将要学习Cookie注入的几种自动化与半自动化实现方法。我们将重点介绍使用注入中转工具、穿山甲以及功能强大的SQLmap工具来绕过网站对GET/POST请求的注入防御，实现Cookie注入攻击。

![](img/b93e320d15b25a5409d7065adfb16564_10.png)

![](img/b93e320d15b25a5409d7065adfb16564_12.png)

![](img/b93e320d15b25a5409d7065adfb16564_14.png)

上一节我们介绍了Cookie注入的基本原理和手工测试方法，本节中我们来看看如何利用工具来高效地完成这一过程。

![](img/b93e320d15b25a5409d7065adfb16564_16.png)

![](img/b93e320d15b25a5409d7065adfb16564_18.png)

![](img/b93e320d15b25a5409d7065adfb16564_19.png)

![](img/b93e320d15b25a5409d7065adfb16564_21.png)

## 使用注入中转工具实现Cookie注入 🛠️

![](img/b93e320d15b25a5409d7065adfb16564_23.png)

![](img/b93e320d15b25a5409d7065adfb16564_25.png)

![](img/b93e320d15b25a5409d7065adfb16564_27.png)

第二种方法是使用一种较早（约2006-2007年）的注入中转工具。这类工具通常针对ASP网站，对于PHP网站，建议使用SQLmap或通过Burp Suite实现。以下是使用此类工具的基本步骤。

![](img/b93e320d15b25a5409d7065adfb16564_29.png)

![](img/b93e320d15b25a5409d7065adfb16564_31.png)

以下是使用注入中转生成器的操作流程：

![](img/b93e320d15b25a5409d7065adfb16564_33.png)

![](img/b93e320d15b25a5409d7065adfb16564_35.png)

![](img/b93e320d15b25a5409d7065adfb16564_37.png)

![](img/b93e320d15b25a5409d7065adfb16564_39.png)

1.  打开“注入中转生成器”工具。
2.  在“注入地址”栏中，填写目标网页的URL。
3.  在“注入键名”处填写存在注入漏洞的参数名（例如 `id`）。
4.  在“参数值”处填写该参数当前的值（例如 `58`）。
5.  点击生成，工具会创建一个本地的ASP文件（例如 `GMcodes.asp`）。
6.  用记事本打开生成的文件，可以看到其本质是将我们后续输入的注入语句，通过程序写入到Cookie中提交。
7.  在本地搭建一个Web服务器（如IIS），并运行生成的ASP文件。
8.  访问本地生成的ASP文件地址，并在URL中通过GET方式提交注入参数（例如 `id=58`）。
9.  此时，工具会将GET参数的值转换并写入Cookie，从而绕过网站对GET/POST的直接过滤，实现Cookie注入。

![](img/b93e320d15b25a5409d7065adfb16564_41.png)

当我们在本地页面输入 `id=58 and 1=1` 时，如果页面返回正常，而输入 `id=58 and 1=2` 时页面报错或异常，则证明Cookie注入成功。

![](img/b93e320d15b25a5409d7065adfb16564_43.png)

接下来，我们可以使用联合查询语句获取数据库信息。例如，通过 `order by` 判断字段数，再使用 `union select` 查询用户名和密码字段。

![](img/b93e320d15b25a5409d7065adfb16564_45.png)

**核心查询语句示例：**
```sql
union select 1,2,username,4,5,6,password,8... from admin
```

![](img/b93e320d15b25a5409d7065adfb16564_47.png)

## 使用穿山甲工具实现Cookie注入 ⚔️

![](img/b93e320d15b25a5409d7065adfb16564_49.png)

![](img/b93e320d15b25a5409d7065adfb16564_51.png)

第三种方法是使用穿山甲（Pangolin）这类自动化注入工具。其操作更为简单直观。

![](img/b93e320d15b25a5409d7065adfb16564_53.png)

![](img/b93e320d15b25a5409d7065adfb16564_55.png)

以下是使用穿山甲进行Cookie注入的步骤：

![](img/b93e320d15b25a5409d7065adfb16564_57.png)

![](img/b93e320d15b25a5409d7065adfb16564_59.png)

![](img/b93e320d15b25a5409d7065adfb16564_61.png)

![](img/b93e320d15b25a5409d7065adfb16564_63.png)

![](img/b93e320d15b25a5409d7065adfb16564_65.png)

1.  在穿山甲工具的URL地址栏中输入目标地址。
2.  在注入参数处，将注入类型从默认的“GET/POST”切换为“Cookie”。
3.  点击“检测”，工具会自动识别注入点并判断数据库类型。
4.  注入点确认后，可以使用工具的“猜解表名”、“猜解列名”、“猜解数据”等功能自动化获取数据库信息。
5.  工具会自动列出数据库中的表（如 `admin`），表中的列（如 `username`, `password`），并最终导出表中的数据。

![](img/b93e320d15b25a5409d7065adfb16564_67.png)

![](img/b93e320d15b25a5409d7065adfb16564_69.png)

![](img/b93e320d15b25a5409d7065adfb16564_71.png)

这种方法比手工注入效率高很多，适合快速测试。

![](img/b93e320d15b25a5409d7065adfb16564_73.png)

![](img/b93e320d15b25a5409d7065adfb16564_75.png)

## 使用SQLmap工具实现Cookie注入 🚀

![](img/b93e320d15b25a5409d7065adfb16564_77.png)

![](img/b93e320d15b25a5409d7065adfb16564_79.png)

![](img/b93e320d15b25a5409d7065adfb16564_81.png)

![](img/b93e320d15b25a5409d7065adfb16564_82.png)

SQLmap是一款功能极其强大的开源渗透测试工具，在国际黑客工具排行榜中名列前茅。它远比明小子、啊D、NBS等工具强大，是专业渗透测试人员的首选。强烈建议学习者将精力投入在掌握SQLmap上。

![](img/b93e320d15b25a5409d7065adfb16564_84.png)

![](img/b93e320d15b25a5409d7065adfb16564_86.png)

![](img/b93e320d15b25a5409d7065adfb16564_87.png)

![](img/b93e320d15b25a5409d7065adfb16564_89.png)

首先，需要在系统中安装Perl环境，然后才能运行SQLmap。具体安装教程可在网上搜索“SQLmap安装”找到。

![](img/b93e320d15b25a5409d7065adfb16564_91.png)

![](img/b93e320d15b25a5409d7065adfb16564_93.png)

对于Cookie注入，SQLmap的命令格式与常规注入略有不同。

![](img/b93e320d15b25a5409d7065adfb16564_95.png)

![](img/b93e320d15b25a5409d7065adfb16564_96.png)

**基本命令结构：**
```bash
sqlmap.py -u “目标URL” --cookie=“注入参数=参数值” --level=2
```
*   `-u`：指定可能存在注入点的URL。
*   `--cookie`：指定需要注入的Cookie参数及其值。例如，如果参数 `id=58` 存在注入，则写为 `--cookie=“id=58”`。
*   `--level`：设置测试等级。进行Cookie注入时，等级必须大于等于2（推荐设为2）。等级越高，测试越全面但速度越慢。

![](img/b93e320d15b25a5409d7065adfb16564_98.png)

执行命令后，SQLmap会检测注入点。如果发现注入，可以继续使用以下命令进行深入利用：

![](img/b93e320d15b25a5409d7065adfb16564_100.png)

![](img/b93e320d15b25a5409d7065adfb16564_102.png)

![](img/b93e320d15b25a5409d7065adfb16564_104.png)

![](img/b93e320d15b25a5409d7065adfb16564_105.png)

1.  **获取数据库表名：**
    ```bash
    sqlmap.py -u “目标URL” --cookie=“id=58” --level=2 --tables
    ```

![](img/b93e320d15b25a5409d7065adfb16564_107.png)

2.  **获取指定表的字段名：**
    ```bash
    sqlmap.py -u “目标URL” --cookie=“id=58” --level=2 -T admin --columns
    ```

![](img/b93e320d15b25a5409d7065adfb16564_109.png)

3.  **导出指定表中的数据（脱库）：**
    ```bash
    sqlmap.py -u “目标URL” --cookie=“id=58” --level=2 -T admin -C “username,password” --dump
    ```
    *   `-T`：指定表名。
    *   `-C`：指定要导出的字段名。
    *   `--dump`：导出数据。

![](img/b93e320d15b25a5409d7065adfb16564_111.png)

![](img/b93e320d15b25a5409d7065adfb16564_113.png)

![](img/b93e320d15b25a5409d7065adfb16564_115.png)

![](img/b93e320d15b25a5409d7065adfb16564_117.png)

![](img/b93e320d15b25a5409d7065adfb16564_119.png)

SQLmap运行过程中，每一步的详细日志都会保存在其 `output` 目录下对应的站点文件夹中。导出的数据（如用户名和密码）默认会保存在一个 `.csv` 文件中，方便查看和整理。

![](img/b93e320d15b25a5409d7065adfb16564_121.png)

![](img/b93e320d15b25a5409d7065adfb16564_123.png)

如果密码是MD5加密，SQLmap还会询问是否使用内置字典进行破解。但内置字典较弱，对于复杂密码破解成功率不高。

![](img/b93e320d15b25a5409d7065adfb16564_125.png)

![](img/b93e320d15b25a5409d7065adfb16564_127.png)

![](img/b93e320d15b25a5409d7065adfb16564_128.png)

![](img/b93e320d15b25a5409d7065adfb16564_130.png)

![](img/b93e320d15b25a5409d7065adfb16564_132.png)

本节课中我们一起学习了三种实现Cookie注入的工具方法：古老的注入中转工具、图形化的穿山甲以及功能强大的命令行工具SQLmap。掌握这些工具，尤其是SQLmap，能极大提高我们在渗透测试中识别和利用SQL注入漏洞的效率。需要注意的是，工具是能力的延伸，理解其背后的原理至关重要。