# iæ˜¥ç§‹é›¶åŸºç¡€å…¥é—¨Androidé€†å‘ - è¯¾æ—¶14ï¼šIDAè„±å£³ä¿®å¤è„šæœ¬ç¼–å†™ ğŸ› ï¸

![](img/d9ab133e6fc4574b5058034085f6ceaa_1.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_2.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_4.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_5.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ç¼–å†™ä¸€ä¸ªè„šæœ¬ï¼Œå°†è„±å£³å¾—åˆ°çš„ODEXæ–‡ä»¶ä¿®å¤ä¸ºå¯ç”¨çš„DEXæ–‡ä»¶ã€‚ä¸Šä¸€èŠ‚æˆ‘ä»¬åˆ†æäº†Androidç³»ç»Ÿå¦‚ä½•å°†DEXæ–‡ä»¶ä¼˜åŒ–ä¸ºODEXæ–‡ä»¶ï¼Œå¹¶é‡å†™äº†éƒ¨åˆ†Opcodeã€‚æœ¬èŠ‚æˆ‘ä»¬å°†å°è¯•å°†è¢«é‡å†™çš„Opcodeè¿˜åŸå›å»ã€‚è¿™ç§ä¿®å¤åœ¨æŸäº›è„±å£³æ•°æ®ä¸åŒ…å«ODEXä¿¡æ¯æ—¶éå¸¸å¿…è¦ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_7.png)

æˆ‘ä»¬å°†ä»¥é˜¿é‡ŒåŠ å›ºå£³ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚

## ç¯å¢ƒå‡†å¤‡ä¸è„±å£³

![](img/d9ab133e6fc4574b5058034085f6ceaa_9.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_11.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_13.png)

é¦–å…ˆï¼Œå®‰è£…ç›®æ ‡APKå¹¶è¿›è¡Œè°ƒè¯•æŒ‚æ¥ï¼Œä½¿ç”¨è„šæœ¬å°†å†…å­˜ä¸­çš„DEXæ•°æ®æå–å‡ºæ¥ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_15.png)

ä»¥ä¸‹æ˜¯æå–å†…å­˜DEXæ•°æ®çš„æ ¸å¿ƒæ­¥éª¤ï¼š

![](img/d9ab133e6fc4574b5058034085f6ceaa_16.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_18.png)

1.  ä½¿ç”¨IDAé™„åŠ åˆ°ç›®æ ‡è¿›ç¨‹ã€‚
2.  è¿è¡Œè„±å£³è„šæœ¬ï¼Œè¯†åˆ«å¹¶dumpå‡ºå†…å­˜ä¸­è§£ç åçš„DEXæ•°æ®ã€‚
3.  è„šæœ¬ä¼šå°†æ•°æ®è¾“å‡ºåˆ°æŒ‡å®šç›®å½•ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_20.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_21.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_22.png)

è„±å£³å®Œæˆåï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªåŸå§‹çš„DEXæ–‡ä»¶ï¼ˆé€šå¸¸ç§°ä¸º`dump.dex`ï¼‰ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_23.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_25.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_27.png)

## åˆæ­¥åç¼–è¯‘ä¸é—®é¢˜åˆ†æ

![](img/d9ab133e6fc4574b5058034085f6ceaa_29.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_30.png)

å¾—åˆ°DEXæ–‡ä»¶åï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨åç¼–è¯‘å·¥å…·ï¼ˆå¦‚baksmaliï¼‰å°†å…¶è½¬æ¢ä¸ºsmaliä»£ç ã€‚

```
java -jar baksmali.jar dump.dex -o output_dir
```

![](img/d9ab133e6fc4574b5058034085f6ceaa_32.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_34.png)

ç„¶è€Œï¼Œåç¼–è¯‘è¿‡ç¨‹å¯èƒ½ä¼šæŠ¥é”™ï¼Œæç¤ºâ€œæ­£åœ¨å°è¯•åç¼–è¯‘ä¸€ä¸ªODEXä»£ç â€æˆ–é‡åˆ°éæ³•å€¼å¼‚å¸¸ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºè„±å‡ºçš„DEXæ•°æ®ä»åŒ…å«ODEXçš„ä¼˜åŒ–ç»“æ„ï¼Œéƒ¨åˆ†Opcodeæœªè¢«æ­£ç¡®è¿˜åŸã€‚

ä¾‹å¦‚ï¼Œé”™è¯¯ä¿¡æ¯å¯èƒ½æŒ‡å‘æŸä¸ªç±»çš„ç‰¹å®šåç§»åœ°å€ï¼Œæç¤ºè¯¥å¤„çš„å€¼éæ³•ã€‚æˆ‘ä»¬éœ€è¦å®šä½åˆ°è¿™ä¸ªç±»ï¼Œå¹¶æ‰‹åŠ¨ä¿®å¤é”™è¯¯æ•°æ®ã€‚

## æ‰‹åŠ¨ä¿®å¤é”™è¯¯æ•°æ®

![](img/d9ab133e6fc4574b5058034085f6ceaa_36.png)

å½“åç¼–è¯‘å·¥å…·åœ¨æŸä¸ªç±»å¤„æŠ¥é”™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨æ‰“å¼€`dump.dex`æ–‡ä»¶ï¼Œå®šä½åˆ°æŠ¥é”™çš„ç±»åŠå…¶åç§»åœ°å€ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_38.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_40.png)

ä»¥ä¸‹æ˜¯ä¿®å¤æµç¨‹ï¼š

![](img/d9ab133e6fc4574b5058034085f6ceaa_41.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_43.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_44.png)

1.  åœ¨åç¼–è¯‘é”™è¯¯æ—¥å¿—ä¸­æ‰¾åˆ°æŠ¥é”™çš„ç±»åå’Œåç§»åœ°å€ï¼ˆä¾‹å¦‚ï¼š`0x11687`ï¼‰ã€‚
2.  ç”¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨æ‰“å¼€`dump.dex`ï¼Œè·³è½¬åˆ°è¯¥åœ°å€ã€‚
3.  è§‚å¯Ÿè¯¥åœ°å€é™„è¿‘çš„æ•°æ®ï¼Œå¦‚æœå‘ç°æ˜æ˜¾å¼‚å¸¸çš„å€¼ï¼ˆä¾‹å¦‚ï¼ŒæŒ‡å‘æ–‡ä»¶å¤´çš„åœ°å€ `0x3036`ï¼‰ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯åŠ å›ºå£³å¡«å……çš„æ— æ•ˆæ•°æ®ã€‚
4.  å°†è¿™äº›éæ³•å€¼ä¿®æ”¹ä¸º `0` å¹¶ä¿å­˜ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_46.png)

ä¿®æ”¹åï¼Œå†æ¬¡å°è¯•åç¼–è¯‘ï¼Œä¹‹å‰çš„å¼‚å¸¸å¯èƒ½æ¶ˆå¤±ï¼Œç±»èƒ½è¢«éƒ¨åˆ†åç¼–è¯‘ã€‚ä½†æ­¤æ—¶åç¼–è¯‘å‡ºçš„smaliä»£ç å¯èƒ½åŒ…å«ä¼˜åŒ–è¿‡çš„Opcodeï¼ˆå¦‚ `iget-quick`ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´åç»­é‡æ–°ç¼–è¯‘ï¼ˆsmali -> dexï¼‰å¤±è´¥ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_47.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_49.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_50.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_52.png)

## ä½¿ç”¨è„šæœ¬è‡ªåŠ¨åŒ–ä¿®å¤ODEX

![](img/d9ab133e6fc4574b5058034085f6ceaa_54.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_55.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_57.png)

æ‰‹åŠ¨ä¿®å¤æ•ˆç‡ä½ä¸‹ä¸”ä¸å½»åº•ã€‚æ›´ä¼˜çš„æ–¹æ¡ˆæ˜¯ç¼–å†™è„šæœ¬ï¼Œç³»ç»Ÿæ€§åœ°å°†ODEXä¸­çš„ä¼˜åŒ–Opcodeé€†å‘è¿˜åŸä¸ºæ ‡å‡†DEXçš„Opcodeã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_59.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_61.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_63.png)

è„šæœ¬çš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼šéå†DEXæ–‡ä»¶ä¸­çš„æ‰€æœ‰æ–¹æ³•ä»£ç ï¼ˆCode Itemï¼‰ï¼Œè¯†åˆ«å‡ºä¼˜åŒ–è¿‡çš„Opcodeï¼ˆå¦‚ `iget-quick`, `invoke-virtual-quick` ç­‰ï¼‰ï¼Œå¹¶æ ¹æ®Androidç³»ç»Ÿçš„ä¼˜åŒ–è§„åˆ™ï¼Œå°†å…¶æ›¿æ¢å›æ ‡å‡†çš„Opcodeï¼ˆå¦‚ `iget`, `invoke-virtual` ç­‰ï¼‰ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_64.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_65.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_67.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_69.png)

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¿®å¤é€»è¾‘ä¼ªä»£ç ï¼š

![](img/d9ab133e6fc4574b5058034085f6ceaa_71.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_72.png)

```python
def repair_opcode(optimized_opcode, operands):
    # å»ºç«‹ä¼˜åŒ–Opcodeåˆ°æ ‡å‡†Opcodeçš„æ˜ å°„å…³ç³»
    opcode_map = {
        â€˜iget-quickâ€™: revert_iget_quick,
        â€˜invoke-virtual-quickâ€™: revert_invoke_virtual_quick,
        # ... å…¶ä»–ä¼˜åŒ–Opcode
    }
    if optimized_opcode in opcode_map:
        standard_opcode, new_operands = opcode_map[optimized_opcode](operands)
        return standard_opcode, new_operands
    else:
        return optimized_opcode, operands # æ— éœ€ä¿®å¤
```

![](img/d9ab133e6fc4574b5058034085f6ceaa_74.png)

è¿è¡Œä¿®å¤è„šæœ¬ï¼š

```
python repair_odex.py -i dump.dex -o repaired.dex
```

![](img/d9ab133e6fc4574b5058034085f6ceaa_76.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_77.png)

è„šæœ¬æ‰§è¡Œåï¼Œä¼šç”Ÿæˆä¿®å¤åçš„ `repaired.dex` æ–‡ä»¶ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_79.png)

## éªŒè¯ä¿®å¤ç»“æœ

![](img/d9ab133e6fc4574b5058034085f6ceaa_80.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_82.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_83.png)

ä½¿ç”¨ä¿®å¤åçš„DEXæ–‡ä»¶è¿›è¡Œåç¼–è¯‘å’Œé‡æ‰“åŒ…æµ‹è¯•ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_85.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_86.png)

1.  åç¼–è¯‘ä¿®å¤åçš„DEXï¼š
    ```
    java -jar baksmali.jar repaired.dex -o repaired_smali
    ```
2.  å°†smaliä»£ç é‡æ–°ç¼–è¯‘ä¸ºDEXï¼š
    ```
    java -jar smali.jar assembled repaired_smali -o final.dex
    ```
3.  ç”¨ `final.dex` æ›¿æ¢åŸAPKä¸­çš„DEXæ–‡ä»¶ï¼Œå¹¶é‡æ–°ç­¾åå®‰è£…ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_88.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_89.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_91.png)

å¦‚æœåº”ç”¨èƒ½æ­£å¸¸è¿è¡Œï¼Œè¯´æ˜ä¿®å¤æˆåŠŸã€‚å¯ä»¥å¯¹æ¯”ä¿®å¤å‰ååç¼–è¯‘çš„smaliä»£ç ï¼ŒåŸæœ¬çš„ `iget-quick` ç­‰æŒ‡ä»¤åº”è¢«è¿˜åŸä¸º `iget` ç­‰æ ‡å‡†æŒ‡ä»¤ã€‚

## è¡¥å……ï¼šå…³äºåç¼–è¯‘å·¥å…·çš„ `-x` å‚æ•°

![](img/d9ab133e6fc4574b5058034085f6ceaa_93.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_94.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_96.png)

åç¼–è¯‘å·¥å…·ï¼ˆå¦‚baksmaliï¼‰æä¾›äº† `-x`ï¼ˆæˆ– `--experimental`ï¼‰å‚æ•°æ¥ç›´æ¥å¤„ç†ODEXæ–‡ä»¶ï¼Œä½†å®ƒéœ€è¦ä¾èµ–Androidç³»ç»Ÿçš„å¯åŠ¨ç±»è·¯å¾„ï¼ˆboot classpathï¼‰æ–‡ä»¶ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_98.png)

ä»¥ä¸‹æ˜¯ä½¿ç”¨ `-x` å‚æ•°çš„æ­¥éª¤ï¼š

![](img/d9ab133e6fc4574b5058034085f6ceaa_100.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_101.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_103.png)

1.  ä»è®¾å¤‡ä¸­å¯¼å‡º `/system/framework/` ç›®å½•ä¸‹çš„æ‰€æœ‰BOOTCLASSPATHæ–‡ä»¶ã€‚
    ```
    adb pull /system/framework/ ./framework/
    ```
2.  ä½¿ç”¨ `-d` å‚æ•°æŒ‡å®šæ¡†æ¶ç›®å½•è¿›è¡Œåç¼–è¯‘ã€‚
    ```
    java -jar baksmali.jar -x -d ./framework/ dump.odex -o odex_output
    ```

![](img/d9ab133e6fc4574b5058034085f6ceaa_105.png)

æ­¤æ–¹æ³•è™½ç„¶æœ‰æ•ˆï¼Œä½†éœ€è¦æå–ç³»ç»Ÿæ–‡ä»¶ï¼Œè·¨è®¾å¤‡æ—¶å¯èƒ½ä¸é€šç”¨ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œæˆ‘ä»¬ç¼–å†™çš„ä¿®å¤è„šæœ¬æ›´å…·é€šç”¨æ€§å’Œçµæ´»æ€§ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_107.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_108.png)

## è„šæœ¬å®ç°ç»†èŠ‚æ¢è®¨

ä¿®å¤è„šæœ¬çš„å…³é”®åœ¨äºå‡†ç¡®è¿˜åŸä¼˜åŒ–Opcodeã€‚è¿™é€šå¸¸æ˜¯ä¸€å¯¹å¤šçš„é€†å‘æ˜ å°„ï¼Œéœ€è¦æ ¹æ®æ“ä½œæ•°ç±»å‹ç­‰ä¿¡æ¯è¿›è¡Œåˆ¤æ–­ã€‚

ä¾‹å¦‚ï¼Œä¼˜åŒ–æŒ‡ä»¤ `iget-quick` å¯èƒ½å¯¹åº”åŸå§‹æŒ‡ä»¤ `iget`ã€`iget-wide`ã€`iget-object`ã€`iget-boolean`ã€`iget-byte`ã€`iget-char` æˆ– `iget-short`ã€‚è„šæœ¬éœ€è¦é€šè¿‡åˆ†æè¯¥æŒ‡ä»¤æ“ä½œæ•°æ‰€å¼•ç”¨çš„å­—æ®µç±»å‹ï¼Œæ¥å†³å®šè¿˜åŸä¸ºå“ªä¸€ç§å…·ä½“çš„ `iget-*` æŒ‡ä»¤ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_110.png)

ç›®å‰è„šæœ¬å¯èƒ½æ— æ³•å¤„ç†æ‰€æœ‰ç±»å‹çš„ä¼˜åŒ–æŒ‡ä»¤ï¼ˆå¦‚æŸäº› `*quick` æŒ‡ä»¤æˆ– `volatile` è®¿é—®ä¼˜åŒ–ï¼‰ã€‚å¯¹äºæ— æ³•ä¿®å¤çš„æƒ…å†µï¼Œä¸€ç§ä¿å®ˆçš„ç­–ç•¥æ˜¯åƒä¹‹å‰æ‰‹åŠ¨ä¿®å¤ä¸€æ ·ï¼Œå°†ç›¸å…³ä¼˜åŒ–æ ‡å¿—ä½æ¸…é›¶ï¼Œä½¿å…¶é€€åŒ–ä¸ºéä¼˜åŒ–ä»£ç ï¼Œè¿™è‡³å°‘èƒ½ä¿è¯ä»£ç å¯è¢«åç¼–è¯‘å’Œé‡æ–°ç¼–è¯‘ã€‚

![](img/d9ab133e6fc4574b5058034085f6ceaa_112.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_114.png)

![](img/d9ab133e6fc4574b5058034085f6ceaa_116.png)

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†å¦‚ä½•é€šè¿‡ç¼–å†™IDAè„±å£³ä¿®å¤è„šæœ¬ï¼Œå°†åŒ…å«ä¼˜åŒ–Opcodeçš„ODEXæ•°æ®ä¿®å¤ä¸ºæ ‡å‡†çš„DEXæ–‡ä»¶ã€‚æˆ‘ä»¬äº†è§£äº†æ‰‹åŠ¨ä¿®å¤çš„å±€é™æ€§ï¼Œæ¢è®¨äº†è‡ªåŠ¨åŒ–è„šæœ¬çš„æ ¸å¿ƒä¿®å¤é€»è¾‘ï¼Œå¹¶ä¸åç¼–è¯‘å·¥å…·çš„ `-x` å‚æ•°æ–¹æ³•è¿›è¡Œäº†å¯¹æ¯”ã€‚æŒæ¡è¿™é¡¹æŠ€èƒ½èƒ½æœ‰æ•ˆæé«˜å¤„ç†åŠ å›ºå£³è„±å£³æ•°æ®çš„æ•ˆç‡ã€‚