# i春秋零基础入门Android逆向 - P30：课时5 arm 汇编代码讲解5 - 老网恋教父了 - BV1sg4y1B7zB

🎼。

![](img/9fcfabd8503de28fb6f8e12565251e0b_1.png)

嗯，好的，呃，大家好，我是讲师艾8。那么今天来讲一个R代码的一个letty hook，也就是我们俗称的函数规则。ho代码的话，在前面已经讲过一个java成上的一个ho了。可以用一个SI来做。

那么这次的话就来讲一下一个对于SO函数的一个ho。嗯，首先那么ho的话呃，这里我现在大致的介绍一下。他顾名思义的话就是对某一个函数来下钩子，来来达到对整一个程序，也就是说对某一个函数达到一个接款的作用。

这一点他的思想无论是在java上，还是说在内层上都是一样的。也就是说用自己的函数来代替它原来的函数来达到替换，还有说修把功能的一个效果。好，那关键就在于哎我们要怎么去替换，怎么去修改。

那我这里我这一节课的话我们就来讲一个C我们如何去C来进行来用进行一个啊 hook。那么实际上在SO上ho相关代码话已经是非常非常的多。

有兴趣的话可以自己去查一下上有有不少不错的开源代码那么ho方法的话也分为好几种，可以通过一个跳转，或者说通过过表后啊什么的，都是可以的。那么这个CDA框那么它下构方法比较简单我们也来讲一讲。好，嗯首先。

我们先来看一下CRDA机中所提供的1个SDK，这是我们呃实习第十课时候说到的1个CRDA了。我们打开它的话可以发现。里面除了给我提供给ja上的一个AP以外呢，还有提供给一个let体上IB文件。

就是这些SO文件。那么这些SO文件的话，它本身就能够使用于一个上面去。因为它提供了两层的一层是一个ja层的一层是一个层的那对层下工的话。

我们可以在层上对函数下钩也可以在一个let层上对我们的一个let函数下钩啊，这两个是有区别的。如果你对ja层下钩的话，那么就要区分一个机行运行一个模式。

那么这解目前来说需要的话只支持DV模式钩不支持一个模式钩，所以这一点大大家在下面的话要注意了机一定是要行到VM的话才能够对下钩。但是果是对本S函数本身的一个地方下钩的话，模模式一区别。好。

那么这里我们就介绍一个对于类体程度的的一个下钩。我们先来看一下我们如何的去写下一个程序，把这个东西给打开话会发现它里面有一个图文件，还有一个LB文件。那么这两个就是我们写钩子所需要的一个代码。好。

那么我们就来把我们的一个呃按出这打开，我们来看一下一个图一个正常的一个下钩的一个例子是怎么写的。那么这里由于时间问题的话，我已经先给大家来写好。

那么我来给大跟大家来介绍介绍它的下钩的一个流程是怎么样子了。现在打开一个目标程序，那么这里我的程序的话是修改自前几节课所编创的一个hello的一个地方。



![](img/9fcfabd8503de28fb6f8e12565251e0b_3.png)

从那边直接去改过来就可以了。好，现在打开一个按卓t。

![](img/9fcfabd8503de28fb6f8e12565251e0b_5.png)

然后。然后打开我们的一个函数勾列以后。我们等着一个程序要打开。

![](img/9fcfabd8503de28fb6f8e12565251e0b_7.png)

我们来看一下它给我们提供了呃什么什么样的函数吧。首先是个是一个get image by啊，相当于取获得某1个SO函数的一个基地址了啊，和1个DODAL load的话，那个功能是一样的。

还有一个是fin symbol，也就是获取某一个函数的一个地址，传电参数的话式上面获取过来的1个SO地址的一个基址。这个和DLSYN的函数作用是一样的。



![](img/9fcfabd8503de28fb6f8e12565251e0b_9.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_10.png)

可以看到的话，这两个只是对一个第二个函数进行了一套封装。那么如果下面的话还是真正的一个下钩的一个函数。



![](img/9fcfabd8503de28fb6f8e12565251e0b_12.png)

我们来看一下这是这段时间的一个代码。嗯，首先我们得先把1个JI文件，也就是它的一个图文件给导进来，然后把它的一个libveary两个呃2个ESO文件快放到呃JILB目录下。

就在J命这里放到这个JILB目录下。这里本来是没有夸仔细己去创建一个。如果如果当我们把一个SO文件放到这个目录下来的话，那么按照tio在打包的时候会自动的把这几个SO文件给打包到APC程序中去。啊。

这是它默认的一个呃存呃就目录的一个存放的位置。接着我们把这这几个东西，这几个图文件，还有一个S文件给发进去以后，我们现在一个be进行一个修改。就是我们的一个呃GI调的一个设置。我们要添加几个啊fag。

我们找到1个NDK背应的一个地方，就是这个模块了，我们添加两个分两个库，一个是1个D二库，用来进行一个呃加载的一个。用它进行用来进行一个SO加载的，还有两个CP两个fag就是一个VV一两两个版本。

一个是RABI，还有叉86的一个版本。好，就是对应着这两个版本。我们规定它只编辑这两个版本，因为其他地方都编辑不出来。好，把这规规定好以后，哎，那么这里算是把它的1个CRD给导入完成了。导入好以后。

我们再来进行一个编程。我们看一下它的一个图文件。文件的话是这个样子的。那么它写的话它也是说写的非常规范的那种。那么对于一个安卓，还有linux是至是一个apple跨度进行的一个区分。嗯。

那么这里因为我们只写一个安卓上钩子，我们就只关注hand卓上的一个函数。那么它只提供了这几个函数，首先是一个通用的几个函数的话，就是。还有我刚才介绍过的一个 by获得一个SO机址的。

然后是一个fin获取一个函数的地址，然后是一个对函数下钩 function。那么在下面的话就是对安卓特有的一个几个函数，就是一个叫对jaho的一个函数啊。那么可以看到的话。

这个这里是叫ho下钩特别的函数。啊，这设几个函数的话，只在DVM有效。好，那么下面的话就是它一些函数的一个具体的具体的一些实现了。比如说找到它的一个呃class啊之类的，都是各种的调。

还有说反射调之类的。啊，那么这里都是一个CCPP类型的一个东西。那么这就是一个图文件，我们要现在这这今天要做的话，就是利用这几个函数来下一个钩子。首先我们下钩子的地方。

首先第一个就是一个实际的是一个点了。

![](img/9fcfabd8503de28fb6f8e12565251e0b_14.png)

我们要在什么什么时间来实现对整一个函数的一个挂钩呢？那么我们挂钩时间的话呃，一般一般来说就是在SO加载同时呃对它同时进行一个下钩。

那么这一或者说是在这1网路地方对下下勾也是可以的那么这里我们就在SO初始化的时候同时进行一个下勾。我们找到一个SO实现的主体文件。



![](img/9fcfabd8503de28fb6f8e12565251e0b_16.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_17.png)

好，我们来换一下，那么这里就是一个下钩的一个函数了。首先是它定义的一个红，就是一个初始化的一个函数。使用使用了这个红的话，那么它里面的函数就可以在函数初始化的时候。

同时来实现一个to时R之行里面的一个代码。点进去的话，可以看到它只是呃通知这个函数，就是一个呃这一个函数的初始化的一个应题来使用一个函数。那么这个功能的话和我们使用1个HB这个效果是一样的。对。

和我们使用这样的一个水瓶的效果是一模一样的。好，那么这里就是它的一个初始初始化函数。我们把要像钩子相关的一个代码放到这个地方。然后里面就填写我们要下钩的一个代码。那么这一次我比我写的就比较简单。

因为我已经直接要知道两个函数了。好，我这里的话就是用我们我的一个hello hook的一个方法来直接替换hello的一个方法来达到下勾的一个效果。那么下勾的过程的话，就是像这个样子了。

首先第一个参数是我们的原来的一个原来的方法的一地址。对7加加的一个S文件来说，那么这里站起来的话，就直接把一个函数地址给传递过去了。第二个函数是目标函数的一个地址，这里也一样。

把一个目标函数地址的地址给传递去。那么第三个函数的话，就是问我们是否要保存以前旧的函数的一个旧的一个地址。因为下勾以后的话，那么所有对hello地都会跳转到一个hello hook里面去。

如果我们要保存旧的函数地址，那么就需要在这里把一个参数给传递过去。这样保存下来的的一个结果，就是我们可以在其他地方直接进行。调这里也是一个函数啊，它参数和这里一样。这里是个函数。好。

那么这里就是一套完整的一个下钩的一个代码。如果并不是对本身下钩子，而是对其他的一个那lib本库相钩整的。比说要收到其他文件的话，可以使用这一个函数跟im by then。



![](img/9fcfabd8503de28fb6f8e12565251e0b_19.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_20.png)

另外里面的话，比如说我们要做1个LBTVM架构的话。那么我们就应该这起，然后这里就把它纺贝子给取出来。



![](img/9fcfabd8503de28fb6f8e12565251e0b_22.png)

接着嗯，那么下面就是直接的获取函数地址。

![](img/9fcfabd8503de28fb6f8e12565251e0b_24.png)

那后f simple by lamps获取1个DVM。然后第二个就是函数地址。比如说呃就什么什么什么的，那么返回过来地址就能够直接的进行一个调，或者说直接的进行一个下勾。

这一个地址的话可以直接用到下面这个函数过来。哎，那么这里也就是对其他SO函数下钩子的一个方法。好，那这里我就只只对hello三的一个本身校工。为了简单就只对本称还课程的一些函数来进行一个下勾吧。啊。

那么这里就能够进行一个编译，来看一下它的一个编编译效果，还有运行效果。呃，现在大致的看一下。如果我们没有下钩成功的话。没有下过成功成成功的话，我们来看一下它运行结果应该是怎么样子的。

我们直接来进行一个边线运行，来看一下它的一个运行效果。那么可以看到它，这里只是单纯的对一个hello3D器行一个调存的一个插数器摆进去，然后把它的结果给打印出来。好看一下好，如果没有下钩的时候。

它的一个反馈结果是咨03。因为我们下钩完以后，哎，它的反回结果是什么样子？

![](img/9fcfabd8503de28fb6f8e12565251e0b_26.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_27.png)

我把我们刚才下钩地方就是给还原，我们再来运行一遍，看一下它的结果是不是更改掉了。我们来看一下下购完以后什么样子的。好，那么下钩完以后，哎，它的结果就改变了，证明我们下钩的一个方法，哎。

或者说对它的钩子已经成功了。这是怎么回事啊？它它下钩的原理是什么呢？我们再来看一下它的原理吧，我们来看一下它的原理吧。啊，对于它相相关的地方下一个断点，我们来看一下。我之前嘅。对。



![](img/9fcfabd8503de28fb6f8e12565251e0b_29.png)

本来想这是一个调试的啊，我记得好像是在一个录像过过程中是不能够进行一个la体上的一个调试的。因为一些端头的我们有一些问题啊。嗯，那么这于这里的调试的话，只能让大家下面自己去做。那么可以在下构完以后。

可以在相关的函数地方加一个断点来看一下整一个程序是怎么跑的。好，那么这里我就用用1个IDA来进行一个。用垃机来进行一个嗯。



![](img/9fcfabd8503de28fb6f8e12565251e0b_31.png)

调试吧。好了，呃，打开我们的1个ATK文件，找到我们目标的1个SO程序。

![](img/9fcfabd8503de28fb6f8e12565251e0b_33.png)

然后这里是一个hello的SO了。什么东しう？

![](img/9fcfabd8503de28fb6f8e12565251e0b_35.png)

好，接呢打开1个IDA。我们直接用RDA来对它进行一个分析。

![](img/9fcfabd8503de28fb6f8e12565251e0b_37.png)

现在先来普通的看一下这两个函数的一个地方。首先是一个hello什么什么函数，还有另外一个就是一个hello三的一个函数，这也是两个函数圆的地方。



![](img/9fcfabd8503de28fb6f8e12565251e0b_39.png)

首先是一个hello3，它直接按F5进行一个，然后可以看到的话它只是调用了一个类来进行一个文旋处理。因为是一个hello hook，唉，它里面也是这个样子的，可以看到的话。

这两个函数本身并没有说什么直接跳转。也是比如说这里的hello hook，它本身没有调用到hello3。那么hello三本身的话，它没也没有相关的代码给跳转到一个hello hook里面去的。好哦。

那我这里我们就在相应的地方下断点，我们这里再函数尾一下断点，注意一下啊，这里的话我先在函数尾来下一个断点。那这是有原因的，好看。你就应的靠晚一点再说，我们这目前就在尾部来下一个断点线。呃。

这里的话应该绝对同步一下也可以的。嗯，目前先这样吧，先这样吧，在头部尾不到下一个断点。这现在也是hello hook。因为还有这的话，这个断缆线取消掉。嗯二级四个啊。呃呃。

接着我们就来找到这个初始化的一个函数，就是来。那么这个函数的话呃，这里的话可以这样找到。那基本上可做加S啊，那么就可以看到一个IIDI还有FIII这里我前面已经说过了。

所所有的INIT其实的话都是一个文件。它刚开始加载的时候，首先第步执行的一个地方，用来对某一些群机变量或者说某一些函数变量就是一个初始化的地方。我们双击哎跳过去，看到有两个初始化的一个函数。

那么看过来这里是不知道什么函数。那这里是这样一个样子的。

![](img/9fcfabd8503de28fb6f8e12565251e0b_41.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_42.png)

进行一个反馈页看一下。嗯，我们来看一下这些初始化函数，哪一个是我们真实下的一个下构的函数。好啊，那么这里就是我们下钩的一个函数了，里面进行了那几层的一个调用。这是它第二个函数。第一个函数的话是。嗯。

第一个函数的话是我另外一个初始化函数，用来动态的地球定位一个呃ho钩子的。好，到这里，我就开来看第二个函数吧。这里就是1个72DA像勾子一个函数，ZF反面1走过来。好后这里就是它下勾的一个函数。

我们下一个断点。好，在这里结下。好，状点都下好下好以后，我们来开始的来进行一个调试。然后现在注意一下它本本身的话。本身的话这几个函数都是呃非常正常的，和本没有没有相互调用之类的。那么我们就来下一个断点。

把一个初始化的地方下一个断点，我完来进行一个调试。

![](img/9fcfabd8503de28fb6f8e12565251e0b_44.png)

我调试的方向做，然后前面调试步骤是一模一样的，然后就是1个APP来over一个。处理，然后直接打开一个模拟上试。进行一个呃同大家逛街。因为这里的话。



![](img/9fcfabd8503de28fb6f8e12565251e0b_46.png)

这里的话整一个程序需要需要1个ATP下来进行一个启动。

![](img/9fcfabd8503de28fb6f8e12565251e0b_48.png)

因为这里的启启动的时际非常重要，我们这里并不能用一个attach的地方。因为当我们attt上去的时候，整个SO已经已经加载完成了。那么这就非常纳闷了。我们我们我们要来跟踪它下钩的流程，就需要在一个函数。

它刚开始启动的地方来进行一个下钩。我们就是一个ATP需要来进行一个打开。

![](img/9fcfabd8503de28fb6f8e12565251e0b_50.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_51.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_52.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_53.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_54.png)

看只1个ATAPP下，直接把它打开。然后ID就能够只要进行了挂挂机。

![](img/9fcfabd8503de28fb6f8e12565251e0b_56.png)

找到一个函数，这一个这个函数这个才序的是一个hello的一个名称，找到它。

![](img/9fcfabd8503de28fb6f8e12565251e0b_58.png)

好，这个数这这个程序。手找到以后要跟它跑起来，然后直接下接架网上就行了挂街。靠。

![](img/9fcfabd8503de28fb6f8e12565251e0b_60.png)

那么在使用如果打开了一个安卓t的话，要打开一个内存，通过这种方法然后找到我们的一个hello letty来进行一个开它的一个端口。



![](img/9fcfabd8503de28fb6f8e12565251e0b_62.png)

直接这样往上挂上去。

![](img/9fcfabd8503de28fb6f8e12565251e0b_64.png)

跑起来。好。再一遍站一遍。

![](img/9fcfabd8503de28fb6f8e12565251e0b_66.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_67.png)

Yeah。那么这里连这里连接段的话就再开启一遍就好。这里可能由于一个通讯问题，有时候可能会导致一个连接中断，这种时有可能呢。



![](img/9fcfabd8503de28fb6f8e12565251e0b_69.png)

各种意外情况都有可能发生，我们就来多问次次几遍就好。

![](img/9fcfabd8503de28fb6f8e12565251e0b_71.png)

好嗯那么下好一个断点以后把在1个GDP上进行挂接直接跑起来。

![](img/9fcfabd8503de28fb6f8e12565251e0b_73.png)

好，这一个小程序就执行了。好，哎，那么这里已经停下来了。那么它首先这块停在我们一个下钩子的那个地方，这里下钩子的话就传递了几个参数，首先是一个地址O hell。

然后是一个hello3和hello home那就是原来的函数，还有我们目标函数，我们把对应的地方哎记录下来啊，这里是hello3，它本来是这个样子的本来是这个样子先记录下来。好。

这里顺便就把一个前面的一个质检码，一个背扣给也弄出来。为了方便，就先弄出来先。那么这里是hello3。



![](img/9fcfabd8503de28fb6f8e12565251e0b_75.png)

原版的一个函数，因为下面是一个hello hook。这是它一个目标函数。我们来看一下下钩子之前，它有下钩子之后，它们产生了哪一些变化变化。这是两个函数。我们来走过它一个下钩子的一个地方。

那么这里就是直接对一个函数进行一个下钩啊，里面具体实现的话有兴趣呃，但下面的话可以继续看。那么它涉涉及到的内容比较多，呃，非常并不会说是非常多。那么下面的话我就不说了，然后转过来这个下勾函数以后的话。

就可以对这两个函数下好勾子了。我们再来回头来看一下这两个函数变成什么样样子。首先是一个hello hook啊，是一个原始的一个呃没有改变的，对吧？

和原来原来原来的比一下是没有改变的一个设置hello hook。又回回过去来看一下hello3。哎，那么这里已经它整一个地方已经变了，可以看到它首先是1个B叉P7。就是说这里个机质睫毛变了。

它本来是这个样子的，现在它就使用了这几个函数B叉PC，然后是一个L。我们回去来看一下B叉PC什么样子啊，B叉PC什么意思呢？什么意思？嗯，希望大家还知道啊，当它使用一个B叉PC来进行一个跳转的时候。

那么。它就跳转到PC所在地址。那么PCCC的话是。永远都只指下下两个函数地址的，也就是在这一个函数的一个第一地方了啊，我们按期来我们来把它传强制转换成一个代码，里面是第一行，第二行，第三行。很接着。

由于这里是使用1个BCPC这一个时候的PPPC是一个偶数。那么虽然这里本来是一个创的一个代码，但由于是PC是一个偶数的话，在跳转过去的同时就会变成1个AIM的的一个代码。

所以这里应该也要按照1个AIM代码来进行一个啊。进行一个执行。所以这里需要我们可以强制尝尝试按C来把它强制的转化成一个代码。呃，那肯定会失败了。另外这里是1个AI模式。我们来转它AIAIL先按LT家居。

把后改成一个0，好左成AIM以后。这里把它分析为数据啊，按一个U盘 andify给。我取消掉，然后这里再按C来把它强制的转换成一个代码。哦，那么这里就是它实现了一个一个代码。

可以看到它首先可以跳跳转到PG上去。然后在PC上哎又可以用这个PC唉，又会直接跳选到另外一个地方，也就是贴跳选到这边啊。可以可以发现，哎，这实际上就是进行了一个跳转，先跳到这里，哎。

到这里再跳到我们下面的这里。好，这是你一一个一个跳转，这里实际上是一个跳转。这个下钩以后呢。下钩以后话就变成了一个跳转一个形式，先跳到PC哎，然后要在PC中的什么什么的。我我们把断点给恢复一下。

继续搞起来。嗯好，那么我们再来看一下哈执行。对，那么就像还是一样，等我们的程序本来他该调一个哈lo山的地方，还是会调到哈尔山。好，那么下面才是一个重点。它跳到哈lo山以后，那么等他就干什么？

首先一个B插到1个PC上，同时把一个极指令级进行一个切换。那么下面再进行一个跳转，你直接把这个函数地址给赋予到P7上去，实际上就是一个跳转的一的另外一种形式了。这是1个AIM模式下的一个跳转。好走好。

那就直接的跳转到一个helloho一个地方。嗯，反那这里就进行了我们一个目标钩值的一个一个函数了。回头再看一下，回头再看一下，看我们这这里的hello后话，还有对以以前函数的一个调用。

那就是一个o hello的一个调用了。那么这个调是怎么实现的？我们再来往下跑，找到我们o hello调用的一个地方，就是这里的，这里就是获取我们原来原来的函数地址，然后进行一个调m。我们下断点。

看它啊走下来。

![](img/9fcfabd8503de28fb6f8e12565251e0b_77.png)

好，这就这里就是一个对阿罗斯进行一个调用。可以看到哎这本来是一个串的，然后使用1个B2叉呃，在跳转的时候，同时实现一个指令级的一个切换。好，看一下阿尔3的地址，后面是这么这么多，还，后面建设是1个01。

证明跳过去的时候，把指折令机切换到一个创版本里。那么这里相当于是一个没切换了。好，切换切换换没有关系。好，这里我们就可以尝试跟进去来看一下MF7。啊呃，看到它这里直接爆出了一个异常。

是因为ID对指令集没有识别成功。这然后我们强试进行一个调试的话，就会出现这种样子。那么改变方买了好几种，是第一种就是把它的指令集给改回来。因为这里唉它这里23它识别为1个AI模式，扣删是。

它识别为1个AI模式。但我们已经知道它是一个创的模式。所以在跳过去的时候，由于IDA识别问题，就可以产生一个bug，直接导导这一个调试的一个中断一个退出。所以我们在调试的时候呃，像这种情况啊。

遇到一个比较差的一个跳转的时候呢，我们想要跟进去的时候，一定要多多点多点要出注意一下，看一下IDA是不是正常的一个识别成功了。这里显然是一个呃创的一个代码，把它识别成一，然要按C要墙转。好，这是一个。

创作的一个代码，还有另外一种情况就是IF8直接来进行一个步过。这是啊几种方法。啊，那么这里我们就先别管这个把，因为这里已经产生了一个错，我们在调试的话是没有用的。因为产生一个异常没有处理。

产继续调试的话，会导致一个异常退出。那我们先把前面几个断点取消一下，重新呢重新再来进行一个调试吧。我们这里有几个断点，嗯，是一个hello衫在尾部的一个断点，还有就是一个呃这个函数本身的一个断点。



![](img/9fcfabd8503de28fb6f8e12565251e0b_79.png)

好啊，调试大一遍。

![](img/9fcfabd8503de28fb6f8e12565251e0b_81.png)

好太吃。

![](img/9fcfabd8503de28fb6f8e12565251e0b_83.png)

然后然后下面就是一个AGG挂上去。嗯，跑起来。我架成功下钩子好，已经跑到这个地方了。好，慢慢走下去。慢走下去。下面是这1个23级的。靠，这什么地方我靠。找到他的1个L3进行一个这样的一个地方，有吗？

目前L三的地址然后入相应人比较清楚。啊啊哦好。好像整个程序出了bug了靠。嗯。看来出了bug了，这一个断点，我们我们的这个断点的导致这一个程试出了bug。看一下的话。

那边本来应该是一个呃对L3的一个调的。

![](img/9fcfabd8503de28fb6f8e12565251e0b_85.png)

大家看到大大看大家看到了吧？这里本来是一个对23进行一个调动，由于我下断点的关系，使到这个变成了一个mve20250了。好，所以我们要改一下，把断点把往上移一下。哎，那么这里唉就变成这个样子。

我们再来试一遍。嗯，在调试过程中话，有可能会遇到各种各样问题，特别是像断点的时候，由于对原程序产生了一个修改啊，那么对整个程序会产生什么样的一个作文其实都有是有可能的。

这一方面的话就需要多点的去处调试处理一下，看一下他们具体会产生哪两哪样的功效。好跑起来。几乎。跳回A23中去，那么这里成函数已经变来了，继续去找到1个B2叉对23进行一个这样的地方。

那那么从刚才我们已经知道了，如果这里直接用FG跟过去的话，一个崩溃。果按F8的话就能够直接那么这里又能够正常回到这我们再来一遍按F的话按按F8话按正常走按F的话就会直接崩溃。我们它这里到R3中去好。

那么我们就跟过去看一下L3可以看L3的话，这里01，那么跳过来以后是一个的一个值接，那么这里是为一个LM错了，我们就来改一下按AL加G，那么这里选中这个扣时候可以把下面这里全部都转成一个16个。

如果这里选中某一个一行的话，就只会单纯的把某一行进行一个转换我们选用扣。转化成一个chIAT加去。下面按code来尝试转换成一个code的一个代码。好，可以看一下，跳过来是这种样子的。好。

看过来以后是这么一个模块。我们按F7走过来。好，那么这一时候跳试间跳试已经正常，慢慢慢慢的走好，走走走走走，然后那下面就是BB叉P4P7了PC的时候直接就lowPC什么什么，把这个地址给PC。

然后跳过的时候是跳到加一的一个地方呢。所以跳过去以后，整一个指令计划也同时会进行了改变。好，转过来哈，变成一个串码重新的。好，那我看一下这个地址，哎，这是一个L，就是一个how上那一个下几个。

下几个函数的一个地址了。它它就是直接跳转到23下几个函数。嗯，所以我们就回头来看一下前面跳转前的这个创什么意思啊，其实是一和和号尔3的前面几条指令是一模一样的对吧？前面是一个复小号时间那什么什么。

实际上它就是在下勾的时候，同时呢保存了它前面的几条指令。如果我们要跳转的时候，就把签就先实行我们前几条指令，然后再跳转到一个号3的一个指令程序。那么看一下的哈，这里给保存了呃12个字节的一个代码。

恰好和我们的一个tram的一个跳转的首需和直令是一模一样的。把这几个指令给修复一下，嗯，执行一下，然后再跳水回来。那么就实现了我们的一个函数的一个下勾了。那么这里这里就是把这里就是执行好这个以后。

直接给跳回到一个hello上的一个地方。那么下面就是一个正常的一个hello的一个流程。那么返回的时候可也是一样，直接返回到LR地址中去。那这里就是回到一个。我要到一个。嗯。我跳我这里来了，靠。

这里这这里应该是一个本来是一个白的，也是一样。由于我断点的一个影响，使到它呃出现了一个异常，我们把断点往上移看一下，这有于断点的影响，变成了一个mo20210，本来是一个还原的一个函数了。

政策也是一样啊。只能只能认为是1个IDA的一个bug了。后我们加ttion。我我这里的话，呃刚才介绍就是一个大致的一个下构的一个流程。我们再来调一遍吧，看看看有由于bug的话。

这里的话变成了一个move2020。う。你再一遍。嗯，这这这这这个直接要填上去了。你跳起来。好要跳到23中去，23是一个创，改一改改一下。成本担保啊。那么进去以后。

首先是一个对原来的hello3进行一个。然后是一个直接跳转，跳转到创，这里是本来号有上的一个函数。然后左下来的框，下面就直接返回。然后上击行以后返回。

回来这里的一个hello好 hell home的话继续正常的执行。最后再执行这接是一个返回。那么这就是一套完整的一个下钩的流程。可以看到的话，我们我们的所谓的下勾。

直接上就是这个hello前面来进行一个那个跳转，直接的跳跳到我们的一个目标函数中去。因果我们的一个目标函数想要调用到以前函数的话，就会先调用保存的几个字节码，然后再直接B插到下面的一个地方中去。

那么这里就是一个后的一个原理。我们下面的话就是一个下钩的一个原理。它本来函数流程是这个样子的和分上分，这是原来的一个流程。但我们下钩以后就会变成这个样子。本来整个程序可以普通的调样一个函数。

然后这里下由于已经下钩好下完勾了，所以它会直接的跳到我们我们的下钩的函数，它会从这里直接执行到返回。这是一个普通的流程。如果我们原原来函数，还有对它下钩以前的函数进行的一个下钩的话。

继续性来进行了一个调的话，那么它它这里就会多一步，先会哎像一个玻底的话，先可以对一个保持好的一个创造就进行一个调。然后就是把这前几十2个字节码实行了一个调。然后调完以后再跳出。

这样跳转到原来函数的一个摸底，然后再往往下走，然后结束，然后回到一个我们原来函数进行一个执行啊。然后直接呢进行一个返回。啊，这是一个比较简单的一个下钩的一个方法。这直接的修改原始函数的方法。

还有另外一些就是把对导入表进行一个下勾，然后对这各种各表进行一个下钩的一个方法。那么那些的话哎原理又不一样。下关的代码在getget号上可以查得到。那我这里就不进行一个展开了。好啊。

那么这里就是一个啊函数的一个下钩的一个介绍，和，它的一些原理性的一个东西的一个介绍一下。我先挂代码挂我。呃，是是是希望大家在下面去写一下吧。对内层下锅的话啊用的好的话会呃。会方会方便不少的。

可以减少非常多的一个操作的。下构原原理下个原原理的话就是像这种样子吧。那当然的话，哎但然这里的话虽然我说的很短，对吧？这里它实实间起来也很短，但实际上它是比较难的。正如我上一节课所说过了。

那么在AIM上，它同时存在的1个创代码，它有1个AIM的代码。那么它如果如果需要我们自己手动的去写一个钩子的话，就需要去分析它目标函数或者说原始函数到底是一个AIM还是一个创。如果这个没有弄懂。

没有弄清楚的话，那么在跳转的时候，整一个重数就块直接挂掉。那所以这里面同时也可以实现了一个分分析器的一个汇编的一个会变分析器的。这个自己是实现来说。如果要自己实现的话会比较难。

不过这里就由于有一个已经有它的一个。因为已经有一个有一个他已经做好。哎，当我们把这那几步分析已经做好。摸么这里就不需要我们去重重动的去搞。那么这就是一个函数下勾的一个地方。

那么这节课内容的话就到此为止了。好，谢谢大家。

![](img/9fcfabd8503de28fb6f8e12565251e0b_87.png)

🎼空。