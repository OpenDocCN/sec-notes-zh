# iæ˜¥ç§‹é›¶åŸºç¡€å…¥é—¨Androidé€†å‘ - è¯¾æ—¶5ï¼šARMæ±‡ç¼–ä»£ç è®²è§£5 - ä½¿ç”¨Cydia Substrateè¿›è¡ŒNative Hook ğŸª

![](img/9fcfabd8503de28fb6f8e12565251e0b_1.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨Cydia Substrateæ¡†æ¶å¯¹AndroidåŸç”Ÿï¼ˆNativeï¼‰å±‚çš„å‡½æ•°è¿›è¡ŒHookã€‚æˆ‘ä»¬å°†äº†è§£å…¶åŸºæœ¬æ¦‚å¿µã€å®ç°æ­¥éª¤å’Œå·¥ä½œåŸç†ã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_3.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_5.png)

## æ¦‚è¿°

![](img/9fcfabd8503de28fb6f8e12565251e0b_7.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_9.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_10.png)

Hookï¼Œå³å‡½æ•°é’©å­ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯æ‹¦æˆªå¹¶æ›¿æ¢ç›®æ ‡å‡½æ•°çš„æ‰§è¡Œæµç¨‹ã€‚æ— è®ºæ˜¯Javaå±‚è¿˜æ˜¯Nativeå±‚ï¼Œå…¶æ€æƒ³æ˜¯ä¸€è‡´çš„ï¼šç”¨è‡ªå·±çš„å‡½æ•°æ›¿æ¢åŸå§‹å‡½æ•°ï¼Œä»¥è¾¾åˆ°ä¿®æ”¹æˆ–å¢å¼ºåŠŸèƒ½çš„ç›®çš„ã€‚æœ¬èŠ‚è¯¾é‡ç‚¹è®²è§£åœ¨Nativeå±‚ï¼ˆSOåº“ï¼‰ä½¿ç”¨Cydia Substrateè¿›è¡ŒHookçš„æ–¹æ³•ã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_12.png)

## ç¯å¢ƒé…ç½®ä¸SDKä»‹ç»

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†ARMæ±‡ç¼–çš„åŸºç¡€çŸ¥è¯†ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å°†å…¶åº”ç”¨äºå®é™…çš„Hookæ“ä½œã€‚é¦–å…ˆéœ€è¦é…ç½®Cydia Substrateç¯å¢ƒã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_14.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_16.png)

Cydia Substrate SDKä¸ä»…æä¾›äº†Javaå±‚çš„APIï¼Œä¹Ÿæä¾›äº†Nativeå±‚çš„åº“æ–‡ä»¶ï¼ˆ.soæ–‡ä»¶ï¼‰ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬æ—¢å¯ä»¥åœ¨Javaå±‚æŒ‚é’©ï¼Œä¹Ÿå¯ä»¥åœ¨Nativeå±‚å¯¹æœ¬åœ°å‡½æ•°è¿›è¡ŒæŒ‚é’©ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹Javaå±‚ä¸‹é’©ç›®å‰åªæ”¯æŒDalvikè™šæ‹Ÿæœºæ¨¡å¼ã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_17.png)

ä»¥ä¸‹æ˜¯é…ç½®æ­¥éª¤ï¼š

![](img/9fcfabd8503de28fb6f8e12565251e0b_19.png)

1.  å°†Cydia Substrateçš„`.jar`æ–‡ä»¶å¯¼å…¥é¡¹ç›®ã€‚
2.  å°†å…¶æä¾›çš„`.so`åº“æ–‡ä»¶ï¼ˆå¦‚`libsubstrate.so`å’Œ`libsubstrate-dvm.so`ï¼‰æ”¾å…¥é¡¹ç›®çš„`jniLibs`ç›®å½•ä¸‹ã€‚Android Studioåœ¨æ‰“åŒ…æ—¶ä¼šè‡ªåŠ¨å°†å…¶åŒ…å«è¿›APKã€‚
3.  ä¿®æ”¹`build.gradle`æ–‡ä»¶ï¼Œåœ¨`ndk`æ¨¡å—ä¸­æŒ‡å®šç¼–è¯‘çš„ABIå’Œé“¾æ¥åº“ã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_20.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_22.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_24.png)

```gradle
android {
    ...
    defaultConfig {
        ...
        ndk {
            abiFilters 'armeabi-v7a', 'x86'
        }
    }
}
```

![](img/9fcfabd8503de28fb6f8e12565251e0b_26.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_27.png)

```gradile
// åœ¨æ¨¡å—çš„build.gradleä¸­
android {
    ...
    sourceSets.main {
        jniLibs.srcDir 'src/main/jniLibs'
    }
}
```

![](img/9fcfabd8503de28fb6f8e12565251e0b_29.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_31.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_33.png)

## Hookçš„å®ç°æµç¨‹

![](img/9fcfabd8503de28fb6f8e12565251e0b_35.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_37.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_39.png)

é…ç½®å¥½ç¯å¢ƒåï¼Œæˆ‘ä»¬å¼€å§‹ç¼–å†™Hookä»£ç ã€‚æ ¸å¿ƒæ“ä½œåœ¨Nativeå±‚å®Œæˆã€‚

Cydia Substrate for Android æä¾›äº†å‡ ä¸ªå…³é”®å‡½æ•°ï¼š
*   `MSGetImageByName` / `MSFindSymbol`: ç”¨äºè·å–SOåº“çš„åŸºåœ°å€å’Œå‡½æ•°åœ°å€ã€‚
*   `MSHookFunction`: ç”¨äºå¯¹å‡½æ•°è¿›è¡ŒæŒ‚é’©ã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_41.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_42.png)

æˆ‘ä»¬é€šå¸¸åœ¨SOåº“åŠ è½½æ—¶ï¼ˆå³åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­ï¼‰æ‰§è¡ŒHookæ“ä½œã€‚å¯ä»¥ä½¿ç”¨ `__attribute__((constructor))` æˆ–Cydia Substrateæä¾›çš„ `MSInitialize` å®æ¥å®šä¹‰åˆå§‹åŒ–å‡½æ•°ã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_44.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_46.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_48.png)

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Hookç¤ºä¾‹ï¼Œå®ƒæŒ‚é’©ä¸€ä¸ªåä¸º`hello3`çš„å‡½æ•°ï¼Œå¹¶å°†å…¶æ›¿æ¢ä¸º`hello_hook`å‡½æ•°ï¼š

![](img/9fcfabd8503de28fb6f8e12565251e0b_50.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_51.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_52.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_53.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_54.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_56.png)

```c
#include <substrate.h>

![](img/9fcfabd8503de28fb6f8e12565251e0b_58.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_60.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_62.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_64.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_66.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_67.png)

// åŸå§‹å‡½æ•°å£°æ˜
int (*old_hello3)(int a, int b);

![](img/9fcfabd8503de28fb6f8e12565251e0b_69.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_71.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_73.png)

// æ–°çš„é’©å­å‡½æ•°
int hello_hook(int a, int b) {
    // å¯ä»¥åœ¨æ­¤å¤„æ·»åŠ è‡ªå®šä¹‰é€»è¾‘
    printf("Hello3 is hooked!\n");
    // è°ƒç”¨åŸå§‹å‡½æ•°
    return old_hello3(a, b);
}

![](img/9fcfabd8503de28fb6f8e12565251e0b_75.png)

// åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨SOåŠ è½½æ—¶æ‰§è¡Œ
MSInitialize {
    MSImageRef image = MSGetImageByName("/path/to/libtarget.so");
    if (image != NULL) {
        // æŸ¥æ‰¾å¹¶æŒ‚é’©hello3å‡½æ•°
        void *hello3_addr = MSFindSymbol(image, "hello3");
        if (hello3_addr != NULL) {
            MSHookFunction(hello3_addr, (void*)&hello_hook, (void**)&old_hello3);
        }
    }
}
```

ä»£ç è¯´æ˜ï¼š
*   `MSHookFunction` çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯**åŸå§‹å‡½æ•°çš„åœ°å€**ã€‚
*   ç¬¬äºŒä¸ªå‚æ•°æ˜¯**ç›®æ ‡å‡½æ•°ï¼ˆé’©å­å‡½æ•°ï¼‰çš„åœ°å€**ã€‚
*   ç¬¬ä¸‰ä¸ªå‚æ•°ç”¨äº**ä¿å­˜åŸå§‹å‡½æ•°çš„æŒ‡é’ˆ**ï¼Œä»¥ä¾¿åœ¨é’©å­å‡½æ•°ä¸­ç»§ç»­è°ƒç”¨åŸåŠŸèƒ½ã€‚

å¦‚æœè¦å¯¹å½“å‰SOè‡ªèº«çš„å‡½æ•°è¿›è¡ŒHookï¼Œå¯ä»¥çœç•¥è·å–åŸºåœ°å€å’ŒæŸ¥æ‰¾ç¬¦å·çš„æ­¥éª¤ï¼Œç›´æ¥ä½¿ç”¨å‡½æ•°æŒ‡é’ˆã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_77.png)

## HookåŸç†åˆ†æ

ä»…ä»…å®ç°åŠŸèƒ½è¿˜ä¸å¤Ÿï¼Œç†è§£å…¶åº•å±‚åŸç†è‡³å…³é‡è¦ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡è°ƒè¯•æ¥åˆ†æ`MSHookFunction`æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_79.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_81.png)

![](img/9fcfabd8503de28fb6f8e12565251e0b_83.png)

å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªå‡½æ•°ï¼ˆä¾‹å¦‚`hello3`ï¼‰ä¸‹é’©åï¼Œå…¶å‡½æ•°å¤´éƒ¨çš„æŒ‡ä»¤ä¼šè¢«ä¿®æ”¹ã€‚é€šå¸¸ï¼Œå®ƒä¼šæ›¿æ¢ä¸ºä¸€æ®µè·³è½¬ä»£ç ï¼ˆtrampolineï¼‰ï¼Œå°†æ‰§è¡Œæµå¯¼å‘æˆ‘ä»¬çš„é’©å­å‡½æ•°ï¼ˆ`hello_hook`ï¼‰ã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_85.png)

åœ¨ARMæ¶æ„ä¸‹ï¼Œç”±äºå­˜åœ¨Thumbå’ŒARMä¸¤ç§æŒ‡ä»¤é›†ï¼Œè·³è½¬æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„æŒ‡ä»¤é›†åˆ‡æ¢ã€‚`MSHookFunction`ç”Ÿæˆçš„è·³è½¬ä»£ç ä¼šå¤„ç†è¿™äº›ç»†èŠ‚ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½å…ˆå°†PCå¯„å­˜å™¨æŒ‡å‘ä¸€æ®µä¿å­˜çš„åŸå§‹æŒ‡ä»¤å¹¶åˆ‡æ¢æŒ‡ä»¤é›†ï¼Œç„¶åå†è·³è½¬åˆ°é’©å­å‡½æ•°ã€‚

å½“é’©å­å‡½æ•°éœ€è¦è°ƒç”¨åŸå§‹å‡½æ•°æ—¶ï¼Œå®ƒä¼šé€šè¿‡ä¹‹å‰ä¿å­˜çš„`old_hello3`æŒ‡é’ˆæ¥è°ƒç”¨ã€‚è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªâ€œæ¡¥æ¥â€ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šæ‰§è¡Œè¢«Hookæ—¶æ›¿æ¢æ‰çš„é‚£å‡ æ¡åŸå§‹æŒ‡ä»¤ï¼Œç„¶åè·³è½¬åˆ°åŸå§‹å‡½æ•°çš„å‰©ä½™éƒ¨åˆ†ç»§ç»­æ‰§è¡Œã€‚

è¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸ºä»¥ä¸‹æµç¨‹ï¼š
1.  ç¨‹åºè°ƒç”¨ `hello3`ã€‚
2.  æ§åˆ¶æƒè½¬å‘è¢«ä¿®æ”¹çš„è·³è½¬æŒ‡ä»¤ã€‚
3.  è·³è½¬æŒ‡ä»¤å°†æ§åˆ¶æƒäº¤ç»™ `hello_hook`ã€‚
4.  `hello_hook` æ‰§è¡Œè‡ªå®šä¹‰ä»£ç ã€‚
5.  é€šè¿‡ `old_hello3()` è°ƒç”¨åŸå§‹å‡½æ•°é€»è¾‘ã€‚
6.  åŸå§‹å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å› `hello_hook`ã€‚
7.  `hello_hook` è¿”å›ï¼Œæ•´ä¸ªè°ƒç”¨ç»“æŸã€‚

## æ€»ç»“

æœ¬èŠ‚è¯¾æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†ä½¿ç”¨Cydia Substrateæ¡†æ¶è¿›è¡ŒAndroid Nativeå±‚å‡½æ•°Hookçš„å®Œæ•´æµç¨‹ã€‚æˆ‘ä»¬ä»ç¯å¢ƒé…ç½®å¼€å§‹ï¼Œé€æ­¥å®ç°äº†å¯¹ä¸€ä¸ªæœ¬åœ°å‡½æ•°çš„æŒ‚é’©ï¼Œå¹¶æ·±å…¥åˆ†æäº†HookèƒŒåçš„æŒ‡ä»¤æ›¿æ¢å’Œè·³è½¬åŸç†ã€‚

å…³é”®ç‚¹æ€»ç»“ï¼š
1.  **Hookæœ¬è´¨**ï¼šæ›¿æ¢å‡½æ•°æ‰§è¡Œæµç¨‹ï¼Œç”¨è‡ªå®šä¹‰å‡½æ•°æ‹¦æˆªç›®æ ‡å‡½æ•°ã€‚
2.  **å·¥å…·**ï¼šä½¿ç”¨Cydia Substrateçš„ `MSHookFunction` ç­‰APIå¯ä»¥ç®€åŒ–å¤æ‚çš„åº•å±‚æ“ä½œã€‚
3.  **æ—¶æœº**ï¼šé€šå¸¸åœ¨SOåº“åŠ è½½çš„åˆå§‹åŒ–é˜¶æ®µè¿›è¡ŒæŒ‚é’©ã€‚
4.  **åŸç†**ï¼šé€šè¿‡ä¿®æ”¹ç›®æ ‡å‡½æ•°å¤´éƒ¨çš„æŒ‡ä»¤ä¸ºè·³è½¬ä»£ç ï¼Œå®ç°æ‰§è¡Œæµé‡å®šå‘ã€‚åŒæ—¶ä¿å­˜åŸæŒ‡ä»¤ä»¥ä¾¿åç»­è°ƒç”¨ã€‚

![](img/9fcfabd8503de28fb6f8e12565251e0b_87.png)

ç†è§£Native Hookå¯¹äºAndroidé€†å‘ã€å®‰å…¨åˆ†æå’ŒåŠŸèƒ½å¢å¼ºå…·æœ‰é‡è¦æ„ä¹‰ã€‚è™½ç„¶Cydia Substrateå°è£…äº†å¤§éƒ¨åˆ†ç»†èŠ‚ï¼Œä½†æŒæ¡å…¶åŸºæœ¬åŸç†èƒ½å¸®åŠ©ä½ åœ¨é‡åˆ°é—®é¢˜æ—¶è¿›è¡Œè°ƒè¯•å’Œæ·±åº¦å®šåˆ¶ã€‚