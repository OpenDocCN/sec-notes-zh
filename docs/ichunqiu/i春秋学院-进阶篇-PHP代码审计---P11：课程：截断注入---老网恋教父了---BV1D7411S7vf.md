# i春秋学院 进阶篇 PHP代码审计 - P11：课程：截断注入 - 老网恋教父了 - BV1D7411S7vf

。大家好，我是vient啊，这节课给大家带来的是二次注入。那么本节课的内容也只有一个，就是二次注入。二次注入啊是属于啊3Q注入的一种。呃，为什么会有二次注肉的存在呢？啊。

这是因为啊在一般字符型的呃注入的情况下，它会有单引号存在吗。所以说我们构造输入的时候要闭合单引号啊，如果没有办法闭合单引号就没办法输入了。那么这时候啊又出现了一种新的思路。也就是。

如果存在双条件查询的情况下。啊，可以考虑利用前一个条件去注释一个单引号。后一个条件。啊，就是啊你的payload。Yeah样。你就可以成功的去住了啊。第一次。啊，是前提。第二次根据第一次的前提去注入。

那么如何去转移一个单引号呢？这时候就要考虑到截段了。除了阶段呢，还有一种就是。啊，字符级的转换。或者是反转移。这些都是可能利用的条件。理论上说的再多，你也不会很明白。



![](img/31feb2f3f9262dcd319ca1eac63f3f6e_1.png)

我们还是直接去看代码。我们找了很多地方。漏洞基本上是看了一遍了。啊，基本上没没能省出什么来的，你再从从头再来。



![](img/31feb2f3f9262dcd319ca1eac63f3f6e_3.png)

唔带。啊，没有什么。更多的地方了。我们再看留言这边。查询留言。啊，没有输入的地方。我们再看详情的话，我们输入的ID啊，现在已经过滤掉了。ipad。不成，没办法了。我们再看提交留言啊。

似乎这个页面我们没怎么看过，把它忽略了。啊，我们现在还仔细看。啊。我们看到这一句。他居然没有用seq upsq up。很明显，他是比较相信他的呃单引号的。然后他只是简单的啊进化一下。

就把它带入了这个doQ语句。Yeah。那么在这里我们可以看到这个语句。啊。这种语句是双条件啊或者多条件的。我们查询语句啊，并不是指select。啊，所谓的条件呢其实也不是那么限定。

是后面where后面的条件。只要是两个输入的内容。是有一定的顺序关系的。只要相邻的就好了。嗯。那么看这个双条件啊，这个是cle message。好，前面一个是s里面的user name。

那么这里我们是否可以考虑我们的用户名？啊，截断掉这个呃单引号，把这个单引号弄没。如果把这个单引号啊转译掉了，那么它的闭合单引号就跑到这里来了。这样就是一个用户名。然后。我们这个数据啊，如果把它。

改为一些输入的payload。那么是否就可以啊进行注入呢？理论上这是可行的。这个内容。啊，就是我们的黑。然后啊。Yeah。闭合。好，他们前面是三个内容嘛。好，们用户名一个。

然后payload的话嗯输入一个什么。查询内容。然后。是还一个是now然，获取的是时间。啊，我们随便输入一个。啊，数字一。然后闭合这个括号。闭合这里有括号。然后后面注释掉。Okay。这样子。啊。

那么load的就是这一部分。那么前提就是你的用户名啊，需要有一个结杠。嗯。那么这里你就可以为所欲为的插入一些查询信息了。呃，他没有QQva，你就可以是。Thelect。啊，这lect什么呢？

pas word。啊，不对，啊，是admin thepa。然后from。他的命他可能有多个，我们要限制，只能查一个。Okay。啊，这里内容的话，我们可以用拼接，把它的用户名和密码都拼接过来。

我们这里就不演示那么多。那么前面我们需要怎么控制我们的用户名呢？第一。只有把用户名啊，后面加个斜杠啊，才会。注释掉这个转译掉这个单引号。啊文。找到设置用户名的地方。啊，基本上就是啊改名字或者是注册。

我们先来看注册。啊。判断长度或是clean。我们要看到这个clean input。嗯，他会对我们如果我们输入斜杠啊，它会产生一些什么作用？会有什么变化？好先是自动转移。如果我们输入叉叉叉斜杠啊。

它会变成这样叉叉叉斜杠斜杠。好，反转义。又是叉叉叉铁杠。然后呢，再经过这样的一个规滤，它还又加了一个斜杠。那么他进入数据库的是斜杠呢，还是呃单个斜杠还是两个斜杠？啊，如果只剩下一个斜杠的话。

那么他就可以啊注释掉那个单引号，如果是两个斜杠就不能。그。那这样我们就需要测试。现在我们去注册一个。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_5.png)

啊，注册什么t。然，后面加一个斜杠。然后123456。23456。注册。그。他竟然是两个斜杠。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_7.png)

他为什么会有两个斜杠呢？那我们再回到这边看。嗯，回到瑞。他查询的时候就把play name啊放到了这个session，所以说它输出的啊就是。



![](img/31feb2f3f9262dcd319ca1eac63f3f6e_9.png)

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_10.png)

pre难的内容。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_12.png)

然后。我们再看他在数据库是什么样子的。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_14.png)

它显示的和他进入数据库后的。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_16.png)

那是什么样的一种情况？有是。咦，为什么这里是单斜杠？

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_18.png)

啊，这就是嗯某些函数的特性了。你说进入数据库的。嗯，是单斜杠的。因为他这里是用这个mexiical。mexico的这个转译。四以。我们再来看我们获取到的。



![](img/31feb2f3f9262dcd319ca1eac63f3f6e_20.png)

执行的语句。这里。他真正啊进入数据库的呃，是这样一句。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_22.png)

我们来导出来。放到这里看。啊，他真正进入数据库的是这样子的。那么它的斜杠双斜杠嗯，进入数据库后转移，其实就是单斜杠。



![](img/31feb2f3f9262dcd319ca1eac63f3f6e_24.png)

那么单斜杠进入数据库之后是单斜杠，那么们只要再再次啊找出来，那么它就是单斜杠的。你说我们需要重新登录。我们看登录的地方。和前面图片的地址一样，直接从数据库导出来。那么从数据库导出来的啊。

它的name就是单斜杠的。这样我们就成功的把用户名嗯变为单斜杠哎就。对后面的二次注入提供了必要的前提。我们登录的时候，它也是经过转移，但是查询的时候还是打一斜杠。写账。123456。登录。嗯。

他居然报错了，他进入了USuser页啊页面，它居然报错了。嗯我们来看user。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_26.png)

啊，他在哪里报错？这里他查询用户名的时候报错了。我们来看看是什么一个情况。最后一句。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_28.png)

他查询用户名的时候，因为是有只有一个斜杠，就把最后一个注释掉了。那么这里就出现了错误。比如说我们的用户名成功的变成了单斜杠。那么这时候我们再去提交留言的话呢啊是不是就可以成功的注入了呢？



![](img/31feb2f3f9262dcd319ca1eac63f3f6e_30.png)

啊，我们把pload拿过来。好，进入留言页面。그。我们这里的警号啊是不能够直接在这里提交的吧。来试一下。啊，井号不能提交。咦可以啊是什么问题？好，这里。这样是什么问题？我们。啊，看到具体的。代码。开始。

好变成了这样的情况。哦，对了，我们是不能够在我们的语句中用单引号的，这里前面复制多了。我们退回重新再来。继续留言。成功了。这很明显就是啊。



![](img/31feb2f3f9262dcd319ca1eac63f3f6e_32.png)

管理员的密码，我们来看数据库。管理员。啊，他的密码。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_34.png)

可以说二次输入就这样是成功了。那么当然这个密码是加密的啊，需要去跑散内解密。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_36.png)

那么如何去修复它呢？当然是直接就可以加上一个。啊，过滤。啊。在Q吧。嗯，这还不够，我们需要在。注册这里也要加一个限制。我们的用户名。不能让他有特殊字符。我们用正则去。



![](img/31feb2f3f9262dcd319ca1eac63f3f6e_38.png)

啊，处理它。我们这里提供好了一个代码，是这样。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_40.png)

我们用啊杠W啊去。限制啊，他的用户名只能是铭文。Yeah。可能是什么。哦，也不对，我们要这样。嗯，A到C。好是大写的A到C。然后0到9，我们只允许他的啊用户名是这样子的。啊，这样子就限制了用户名上面嗯。

加点什么斜杠啊什么的。啊，双重保护。然后我们还有啊。修改用户名的地方也需要加上这样一句。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_42.png)

这样就基本上修复了。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_44.png)

我们再来测试。注册一个。AAA铁样。123456。啊，这样就OK了，不能够非法注入。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_46.png)

那我们来总结一下。啊，我们首先看到是啊在提交页面上面，它是有。嗯，双条件。而且他呃mesage条件是没有经过QQ up过滤的。然后我们就去想办法找到user这个用户云设置的地方。我们去添加那个写杠。

让它白pas单引号。转一单引号，我们就又找到了。啊，设置这个值的地方，也就是运。嗯，Right。啊，注册。啊，当然不止一个地方，我这以简单说。他把内容放进了数据库。啊，双斜杠直接查询的话。

到了数据库就是单斜杠了。好，提出来的时候就直接复制到user这里，user name。所以说就导致了存在二次注入。那么本节课到这里就结束了啊，同时啊本期的啊审计课程也就到这里结束了，感谢大家的观看。

谢谢。

![](img/31feb2f3f9262dcd319ca1eac63f3f6e_48.png)