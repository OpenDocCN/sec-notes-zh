# i春秋零基础入门Android逆向 - P40：课时1  Android 加壳原理 - 老网恋教父了 - BV1sg4y1B7zB

🎼。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_1.png)

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_2.png)

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_3.png)

嗯，好的，呃，大家好，我是蒋帅邦。那么今天的话我们来讲第39课。这一节课从这一课节课开始的话，那么这一套尾这一套教程的跨度已经将近一个尾声了。那么最后还有四节课。

我想来跟大家讲一下如何去写个课来来保护我们的一个应用程序。呃呃，我知道是吧，最后这几节课话，可能难度相对于前几节课来，或者说相对于前几十节课来说的话都是大很多很多的。因为这一些课的话。

可能要涉及涉及到一个编程，涉及到各方各面的一个编程。还有另外一点的话就是需要对一个安卓系统有非常非常熟悉。哎，才能够知道这一个加口的一个原理，还有说是一些操作一些函数什么的。嗯。

我知道是应该是有一定的难度的。所以呃在这里在现在听的话，可能会听不懂，我如果听不懂的话，那么留在后面那且一的基础提高完以后再听的话，哎，我相信也是有不少的一个帮助的。嗯。

另外的话我也知道有很非常多同学哎来这一个教程的话，主要还是去想想去学习一下如何去进行一个脱壳。唉，这这是非常正常的一个想法。但是呢在这里的话，我也想来说一下的话，其实加可这一方面和脱壳的话是同样重要的。

如果你们以为哎脱壳是一个非常重要的事情的话，那么重用了夹壳这方面的话，也一定呃不一定会它呃更加没有用，对吧？嗯，有一些东西有有一个比如说解密，哎，你要解解个壳，那么你想脱一个被加固后的一个应用的时候。

我们要怎么去脱壳呢？那么首先我们就得去先知道它是怎么去完成一个加壳的一个原理的。那么当我们知道他知道它加壳是怎么操作的。哎，然后也知道他肯定它原理什么，它一定会对什么地方进行一个操作。哎，那么这么一来。

我们在进行脱壳的时候也思的话，就自然可上来了。所以在这里的话，我会以说哎这样一个夹壳的话，这方面与托壳是同样的是一样非常重要的一个事情。嗯，所以呃在下面的话，我建议大家在以后空闲的时候。

可以自己尝试着去写一个属于自己的一个课来把把写可的当中的一些步骤啊什么的都弄清去。哎，自己写一个可来弄清楚加密的整一课流程。那么我相信对以后的分析会有不少的一个方助。啊，那么废话少说了。

那么今天的话就开始来讲一个加可。我们来怎么样去编写一个属于自己的一个可。那么第一节课的话将会是一些虚认来跟大家讲一下我们加可中所需要用到的一些呃安卓代码中的一个数据，或者说一些函数啊原理之类的。

那么我们就先来说一下整个加可吧。啊，但于对于这么一个加可啊，所有的一个加固，比如说360阿里巴巴一样，哎，他们的加固的一个目的，都是为了原隐藏原始的一个DS文件数据，然后保护它自身的一个程序。呃。

这个数据的话就存放着嗯整一个java层上面的一个所有代码。那么对它保存的话，可以实现保护自己原始的一个代码。那么我们要到底如何去对它进行一个保存呢？那么这一个哎就涉及到一些执行报告的一个技术了。

首先第一个的话就是一个动态加载的一个技术。啊，对于一些文件，比如说这样一个des文件，它要保存，它要保护它要隐藏起来，那么它就需要以某种方式来对它进行一个加密，加密完以后进行一个存储。

但是嗯但是到时候它在解密解口的时候，在运行的时候呢，又要对它进行一个释放，并且来完成一个加载。那么加载的时候怎么办呢？因为我们需要把它给同时给释放到我们的一个des文件中，也把它加到程序中去。

那么这么一来就涉及到一个动态加载了。那么ja层java的话有一个动态加载的一个方法，就是加做一个class load。那么对。按卓来说的话，也有一个对应的一个东西。

那么它就叫做1个DX class load。那么整个安卓程序，它就是通过这样1个DAX class load在java层就通过这样一个方法来完成一个dess文件的一个加载。那么有兴趣的话。

自己尝试的去下面可以用一这样一个函数的话来加载一个des文件。一般在java层加载这一文件都是通过这样一个东西来进行的。那么这里这个函数的话，它会返回一个class load数据。

那么通过这样一个class load就能够dell加载的这样一个de文件的一个函数了。那这里就是它一些函数的说明。好，当我们创建建创建这样一个函数的时候，它第一个参数就是1个DX pass的一个目录。

也就是一个TEX文件在内存中的一个路径。然后第二个目录的话就是一个把它优化后的1个ODX给释放到了一个目录。我们看一下要把它释放到哪一个地方，就把这个地方作为一个参数进行传递。那么第三个参数的话。

就是一个let层的一个S文件的路径。这个路径的话有可能呃需要是我们的一个SO文件，需要买是我们的1个SDX文件需要用到的一个地方。那么如果假如他用到的一些其他的SO文件。

就需要把相应的SO的路径给传递过去，让它进行了加载。那么class load也就是啊它的服的一个class load。这个一般只需要传一个sstem的class load过去就可以了。

那么这个是一个内装载器，是用来进行一个动态加加载的。那么还有另外一些想要登东西的话，就是一个安卓APK它在进行一个原始的一个des文件加载时候，需要用到一些函数。它到底在哪一个地方。

那么我在这里已经帮大家找出来了，最主要的话是在这两个地方，也就是原始des文件给加载完以后哎最主要是影响在这两个ja文件中进行了。这是在一个安卓4。4原码中的一个frame目录像。

里面有一个base ja中的一个呃一个代码。那我这是一些试认。那，前面的话还把一个加口的一个实现流程给先说一下。那么我们加一个可，就是我们把我们自己的APK上传到一个加固网站中，然后加固网站完成加固。

然后再让我们去进行一个下载。那么这是一个网络上进行加固的一个步骤。那么到底在网上它到底进行了一些什么操作呢？其实他大概干的就是这么一些事情。首先就是一个加密原始的一个dess文件出去。

也就是说哎首先的话它可以对我们APKAPK中的一个原始des文件，按照它自己的一个逻辑进行一个保进行一个加密，然后以某一种方式来进行一个保存一些通常的加固文加固的话都可以放到这个物录中。哎。

通常的一些加固的话都会放到他的一个资源目录中去。那么3面的话会特别一点，直接给opend到他自己的一个dess文件中去的。那么接着下一步的话就是添加一个fcess application。

也就是一个可的一个入口点。那么它会通过添加这样一个入口点。然后来达到呃一个让程序入口的时候，添加一个解密的一个外壳。那么在这个解密的外壳中呢，可能会同时使用到一个SO文件。

也就是一个letage层上的一个资源一个呃DX的释放解密的一个操作了。那么这些都是一个基本的一个操作。接着它呢就会对一个安卓的miniface进行修改。

在application标签中呢来插入它自身的一个接口的一个入口点。如果哎如果我们的程序它加密程序本身会重载这样一个application标签的话，那么它就必须把一个原始application数据。

或者说 applicationplication的一个类的名称给以某一种方式来保存回来，然后再解可解完以后，哎，再强行的重新进行一个加载还原培训。这也是我们前几节课在拖那个呃钱宝有票的时候。

为什么要搜索这样一个application的一个数据，把它的一个可能把它程序的原始application进行加载的一个原因了。好，那么最后就把我们哎修改过的一个的1个APP文件进行一个回编译。

给反编译回去。啊，那么他操作啊大概就是这么一回事。它实间不骤的话就这么一回事，就是把我们原始的数据给提取出来，加密，然后把自己的数据给插进去。很简单的一套思路。基本上它的外格程序都是这么一写的。

然后然后为什么它能够做到一个加可的一个通用呢？就是因为它这个加密DX文件，还有说解密个DES文件的时候呢，都是使用它已经规定好的一套加密解密的一个逻辑。那么这样它在密解面的时候都可以用同一套算法。所以。

所以我们可以看到每一次我们上传出去的1个AP文件，然后再下载回来会发现呢它的一个加密解密的1个SO文件都是一样的。因为它就是直接的把自己的一个外壳代码给拷贝过去了。哎，所以在IDA中。

我们上次用到IDA中分析了。假如说我们分析的那个360360的那个SO文件。那么下次我们把这样1个360360的1个SO文件用到其他同样用360加固的A1个APK中的话。

就能够直接用那个SO文件来进行一个分析，进行一个to了。那么像这种加密解密的话，就只需要对一个程序找到一套呃解密的一个方法，就能够非常通用的把它的。把用它来保护的其他程序都一起给拖下来。好。

这都是一些啊加密解密的一个基本的实现步骤。那么下面我们进来继续讲解一下其他的一些知识点。正如果一个安卓APK加载的时候，我们既然要做到一个加密，哎，做到一个动态解密的一个释放。

那么我们就不能够影响整个程序，它本身没有加没有加密时候的一个程序流程，它没有加密的时候的话，是把原始的DEX文件直接加载，然后以某一种形式在一个DVM中进行一个存放了。那么我们加固的时候。

哎完加固完成这样一个动态的一个类加载以后的话，也需要通过某一种方法，使得整一个程序的状态和没有加固的时候一样，也就是说把它收的中动态加载的这样1个DEX文件数据呢给存放到呃相应的一个地方。

以某一种数据的形式给进行一个存放。那么在这里我们可以看得到它原始的1个AP文件，它加载des文件数据的时候，到底对哪一些地方哪些域哪些值进行了一些影响。哎。

我们在这两个教层中能够去看一下它到底干了一些什么样的操作。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_5.png)

好，还是要打开source下来进行代码查看。那么在这里的话呃，像然我课程中用的比较多的话是这样一个source下的一个代码查看。啊后这是一款呃比较比较小，然后运行速度也比较快的一个东西。

当然的话还有另外一个就是一个understand。understand的话也是。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_7.png)

另外一个比较强大的，所以甚至说在功能方面，还说什么其他方面的话，都是比这样一个说型上要强大的多的一个代码查看的些工具。只是它加载的时候话，需要用到比较多的一个资源。



![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_9.png)

🎼，所以就当然。那就非常难。接受，因为它预行的时用的比较多的一个程，一个内存占用，还有说一个硬盘占用。但是它在分析的功能的话是真的是比一个索型上要强的。当样整个程序也比较大。呃。

这个的话嗯主要跟大家来讲一下，想要查看代码话，主要是有这两款工具，一个是sourceci，还有另外一个的话就是一个the stand，这两个都可以在网上来找到相应的一个呃什么什么版，大家都大家都懂的。

那么想要查看代码的话，我希望大家一定要找到一款自己熟悉的一个程序来进行一个代码查看。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_11.png)

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_12.png)

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_13.png)

好，那么在这一块，我还是继续的用一个source赛来跟大家来解些，来跟大家来讲一下这个安卓代码中的这两个文件，它到底在加载原始的ds文件数据的时候进行了哪一些操作。

首先第一个是一个兜底的APK的一个文件。它位于安卓famousface cool中。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_15.png)

好，还是这里这里还是一样的话，导入一个project中以后进行一个打开。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_17.png)

嗯，那么这里已经达到这个地方了。这里啊涉涉及到这样一种末的一个代码中的话，它一般是包含两两层代码的。第一层的话是一个java层，还有另外一层的是一个JI层。

通常都是由它们两层来进行一个交互来完成一个代码的加载的。那么在这里我们就只分析一个java层的代码，来简要的看一下它的一个数据。

首先第一个是一个loaded的APK那么这个loaded的APK的一个函数。这个java文件的话里面就存放着我们每个APK加载时候，他们的一个内存中的一个数据。

到底是一个什么样的一个形式来进行一个存放的。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_19.png)

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_20.png)

我们大致的来看一下这样一个类中，它到底有哪些域以后里面进行了哪一些操作。首先是一个，然后是一个这一个线程，就是一个主线程，也可以理解为整一个程序跑起来以后它都运行在这一个之上的。

然后这里就是一个plication当我们铁中调一个plication获取到了就是这一块的一信息。另外还有一些就就是一个我们的一个AP的一个名称个就是一些数据了，一些它一个地址数据。

甚至是是它的一个库的一个数据。我在下面我们看到一个非常重要的一个一个子就是一个class load数据。

个class load正如我们前面已经说过class load在调中的话翻译过来就是一个装载器那么这一个类装载器的话就是用来给我们来调一个类或者说获取中的某些函数，然后对它进行一个调用。

那么这些函数获取或者说调用的。都是要通过一个类加载器来进行的。所以刚开始1个ABK进行加载的时候，那么它的dess文件就可以通过一个class load来进行加载。

然后加载以后的一个load数据的话就会存放到这样一个域中去。好，那么下面的话，我们就跟我们就跟踪一下这个域到底是在哪里被腐蚀，然后进行一个加载。那么这里有两个class load，一个space的。

一个是一个class load的。还有一些ap的一个信息。然后下面的话就是一些进行一个初始化。来，看到 applicationplication的话，直接反映什么什么。

然后这里就是一个loaded的APK1个初始化固件函数，传递一个base class来进行一个资行的来进行一个呃APK的一个des文件的一个提取来写。然后然后下面的话就来获取class。但这一方面的话。

这一部分的的东西并不是我们所关注的。我们就来关心，主要关心一下它到底是如何去完成一个dess文件的一个加密的。那么在这里我们往下翻来找到我们想要找的一个函数。在这里的话。

最主要还是跟大家讲一下这一个maake application的一个函数。main application根据于它的一个呃文上的名称的话，就是来创建一个application之后，所需要用到的一个数据。

假如我们程序有自己重写过一个application的时候，那么就会调用到这个函数来把我们的application进行一个重新加载。

然后看一下里面它里面的话就会这里就会开始尝试去加载一个新的 applicationplication。比如说这里就可以先获取到一个class load，也就是它本身的一个class order。



![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_22.png)

呃，这里的相关引用代码可以在下面的这个框中来看一下这个函数的一个实现。那么具体到它那边里面的实现的话，可以双击跳过去。当然这这里直接根据名称的话。

就能够知道这里就可以就是跟就是尝试着对我们的classholder来进行一个加载。假如是飞空的话，哎，就接返回。如果是空的话，就可以直接进行一个加载。那么下面的话就是进行一个加载了。

然后application logo里面啊只使用调用这一个gcast load的方法来进行一个代码加载。哎，那么下面就进行一个设置。啊，获取完以后，我们的一个发收的以后呢，就开始来创建我们的一些数据了。

啊，调入到这样一个new application，来创建我们的新ification。哎，然后注意看一下里面进行初始化的时候，是要把我们的这样一个activity spread中的一个数据给创建过去的啊。

这样一个中的话，也在在这里已经标明了，这也是啊比较重要的一个东地方。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_24.png)

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_25.png)

那这样一个东西呃，这样一个函数跑完以后的话，它也就是这样一个application跑完以后的话，它会对我们的这些H些域进行一个操作。哎，这是我们刚创建过来一个application数据。

那么它就会对于我们这两个域进行一个覆盖。那么假如我们程序它本身是有一个application的数据的时候，那么我们要把一个新的 applicationplication给创建回来给覆盖回去。

那么怎么办呢？哎，那么就需要调用到这个函数来创建一个application。然后把这两个域的一个值给通过一个反射方法给强期强制写回去。那么这样一来的话，就能够达到哎按卓它加载的时候。

把一个application的一个数据给复写回去的一个效果了。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_27.png)

那，所以说假如说程序它本来有applicationlic applicationplication的数据，但是我们可能代码却把它的一个数据给覆干掉。那时候怎么办？

我们就是通过手动调用这样一个函数来完成一个application的一个创建。哎，呃这是一个这是一个我们ja格所用到的函数之一。这个函数是来用来呃把以前的application进行一个构建。

所需要调用到的一个地方。啊，那么这是一个application。那么另外一个就是一个这样一个class load。由于这样一个class load的话。

它本来就是把我们的一个load数据给通给存放到一个class load中去。然后这里就通过一个class load把回这样一个Mclass load的一个值。

这个class load数据的话就存放程序本身的一个一个class load数据。所以当我们把一个自己本身的一个class load唉调用这样一个方法来创建完以后的话。

就需要把我们这样这里这样直接创建过来的class load值，通过反射方法，哎把这一个域给覆盖掉。那么这么一来把它覆盖完以后呢，也可以达到一个把自己的APK的一个数据给覆盖上去的一个效果。

那么这里就是一个load的APK中所需要用到的在时候所需要用到的一些数据。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_29.png)

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_30.png)

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_31.png)

好，还有另外一个与文件块，就是一个具体的一个文件。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_33.png)

。那么这个数据的话翻译过来的话就是每一个每个页就是我们打开的一些窗体。我们都知道在我们打开这些窗体的时候的话，里面可以是一个ge空，或者说是ge中来获取整一个程序中它本身的一个class数据。

也就是说啊在这个地方它本身也是会通过某种方法来存储我们的一个application数据，或者说是它的一个 order数据，它都会通过某一些方法来进行一个保存的。所以在这里的话。

我们有必要看一下这个文件它到得做了些什么，哪些域是我们必须要进行一个手动的修改。比如说像这样一个plication数据。那么我们就需要进行一个重写。因为本来这个plication有可能是空的。

或者说有可能是程序本身的一一个plication。当我们把这这己的可给弄上去以后，那么这个域的一个数据的话来就变成我们这些了。所以在我们当我们自己来重新构建。

一个呃程序本身的application的时候，就需要用反射的方法把这一块的一个弹网给给干掉，可以把一个程序本身的一个application给覆盖上去。哎往这么一来这么一来。

这里的一些说到的啊或者说是加格中，可能用到的一些代码的话，就算是基本上跟大家来说没了。当然的话里面更加一些细微的一个实现的话还是有不少的。

那么建议大家的话把这两个文件的一个代码进行一下实图来看一下它里面的一些函数。其实这一个函数的话写的也是非常清晰的。对安卓来说。对于安卓整一个系统来说，它它没有一个代码是比较长特别难读那种。

像这种都是比较短，比较精简，然后又特别易懂的那种。所以建议大家的话还是多一下多多一下这两个代码。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_35.png)

这两个代码它都是在一个使用到教层加密的时候需要用到的一些文件，一些代码。那么这里就只是来做一个课程的一个一介绍，来提跟大家来初步的讲解一下。然后里面的话唉看一下这样一个飞末里面，这样一个飞豹里面的话。

除了这两个cl的呃，或者说与加密有关的一个数据以外的话，还会有其他的一些一些实现。就是说有假如我们想要读懂的一个安卓代码的话，一定要注意一下，把这样一个分末的一个数据给读一下。

这里面它都是涉及到一些比较底层的一个呃服务的一个实现。比如说1个SQL数据啊，还有说一些啊代脑和窗体啊，都可以在这里可以找到相关的一个实现的。当然这里的话就只是简简单单讲接下来一个classload。

好，那么这一节课啊做一个叙弱的话，它要讲的内容的话就到此为止了，谢谢大家。

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_37.png)

![](img/cbbfb6a6b7a277f178e1d6b78e95b32b_38.png)