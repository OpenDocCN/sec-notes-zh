# 经典15年i春秋渗透测试系统化教程 - P30：课时3 CSRF攻击与防御 🔐

在本节课中，我们将要学习跨站请求伪造攻击的原理、利用方式以及防御方法。CSRF是一种利用用户已登录的身份，在用户不知情的情况下，以用户的名义执行非授权操作的攻击方式。

上一节我们介绍了其他类型的Web攻击，本节中我们来看看CSRF攻击。

## CSRF攻击原理与场景

路由器、防火墙等网络设备默认情况下通常只允许内网访问，外网无法直接访问。许多设备的默认管理员密码未被修改，这为攻击者提供了机会。

攻击者可以通过构造恶意请求，诱骗已登录目标设备管理后台的用户去访问，从而在用户不知情的情况下执行修改配置等操作。

以下是CSRF攻击的一个典型场景：

*   攻击者扫描发现大量使用默认密码（如 admin/admin）的路由器。
*   攻击者构造一个恶意请求，例如一个用于开启路由器外网Web管理功能的链接。
*   攻击者通过某种方式（如钓鱼邮件、恶意网站）诱骗已登录路由器后台的用户点击该链接。
*   用户浏览器在不知情的情况下向路由器发送了开启外网管理的请求，由于用户已登录，该请求被成功执行。

![](img/8d67e8104af07dfd288666eda06462c0_1.png)

## CSRF攻击利用演示

接下来，我们通过一个修改路由器设置的例子，来看一下CSRF攻击的具体实现过程。

首先，模拟正常用户登录到路由器管理后台。接着，使用抓包工具（如Burp Suite）拦截一个修改设置的请求，例如开启远程Web管理并将管理IP设置为`255.255.255.255`的请求。

![](img/8d67e8104af07dfd288666eda06462c0_3.png)

![](img/8d67e8104af07dfd288666eda06462c0_5.png)

拦截到的请求可能类似于：
`http://192.168.1.1/cgi?action=save&web_port=80&remote_web_ip=255.255.255.255`

攻击者将此类请求地址构造成一个恶意链接或图片标签，例如：
`<img src="http://192.168.1.1/cgi?action=save&web_port=80&remote_web_ip=255.255.255.255" width="0" height="0" />`

当已登录路由器管理后台的用户访问包含此代码的页面时，浏览器会自动加载图片，从而向路由器发送修改配置的请求，攻击即告完成。此攻击成功的前提是目标设备未修改默认密码。

## 结合其他技术的攻击方式

单纯的CSRF链接需要用户交互。为了扩大攻击范围，攻击者常将其与其他技术结合，实现自动化攻击。

以下是几种常见的结合方式：

*   **结合XSS**：将CSRF攻击代码嵌入到存在XSS漏洞的网站中。当其他用户或管理员浏览该页面时，代码自动执行，在用户不知情的情况下完成攻击（如添加后台管理员账户）。
*   **结合软件自解压功能**：早年曾有人利用WinRAR等压缩软件的自解压功能，在自解压注释中嵌入恶意代码。当用户运行自解压程序时，会同时执行CSRF等攻击代码。
*   **结合蠕虫传播**：在社交网站中，攻击者利用CSRF漏洞（如未经确认的关注、点赞、转发操作），并窃取用户唯一标识（如用户ID），构造出能自动传播的蠕虫链接。用户点击后，蠕虫会以其身份继续向好友传播。

## CSRF攻击的防御措施

要有效防御CSRF攻击，需要从服务端、用户端和安全设备多个层面进行。

### 服务端防御

服务端是防御CSRF的主战场，开发者应在代码层面实施防护。

以下是五种主流的服务端防御策略：

1.  **验证HTTP Referer字段**：检查请求头中的`Referer`字段，判断请求是否来源于可信的本站页面。如果`Referer`是其他站点，则拒绝该请求。这是一种简单有效的方法，但`Referer`可能被浏览器禁用或篡改。
2.  **在请求中添加Token并验证**：在用户会话中生成一个随机的、不可预测的`Token`，并将其嵌入表单或HTTP请求头中。服务器在处理请求时验证此`Token`，非法或缺失`Token`的请求将被拒绝。这是目前最广泛使用的防御方法。
    ```html
    <form action="/transfer" method="POST">
      <input type="hidden" name="csrf_token" value="随机生成的Token值">
      <!-- 其他表单字段 -->
    </form>
    ```
3.  **使用自定义的HTTP头属性**：将`Token`放在自定义的HTTP头（如`X-CSRF-Token`）中发送，而不是作为参数。这通常通过JavaScript（如XMLHttpRequest）实现，可以避免`Token`通过URL泄露，安全性更高。
4.  **严格区分GET与POST请求**：遵循HTTP协议规范，`GET`请求只用于获取资源，不产生副作用；所有会产生数据变更的操作（如修改、删除）都必须使用`POST`、`PUT`、`DELETE`等方法。这能在一定程度上增加攻击构造的难度。
5.  **使用验证码或二次确认**：对于关键操作（如转账、修改密码），要求用户输入验证码或再次输入密码进行确认。这种方法能彻底杜绝CSRF攻击，但会影响用户体验，通常用于高风险操作。

### 用户端防御

普通用户也应养成良好的安全习惯，以降低风险。

*   退出网站时，应点击“注销”按钮，而不仅仅是关闭浏览器标签。
*   不要轻易点击来历不明的链接或图片，尤其是来自论坛、聊天工具和邮件的。
*   尽量避免让浏览器长期保存登录状态（如“记住我”功能），对于重要账户（如邮箱、银行），每次使用后应主动退出。
*   为计算机安装防护软件并及时更新。

### 安全设备防御

企业级网络可以通过部署Web应用防火墙等安全设备来防御CSRF。这些设备内置规则库，能够识别和拦截典型的CSRF恶意请求流量。

![](img/8d67e8104af07dfd288666eda06462c0_7.png)

![](img/8d67e8104af07dfd288666eda06462c0_9.png)

本节课中我们一起学习了CSRF攻击的原理、多种利用手法（包括结合XSS和蠕虫传播）以及从服务端、用户端到安全设备的全方位防御策略。理解CSRF的关键在于认识到它利用的是网站对用户浏览器的“信任”，而非窃取用户数据。因此，在服务端对用户请求进行严格的身份和意图校验是防御的核心。