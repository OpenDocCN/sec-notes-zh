# i春秋零基础入门Android逆向 - P25：课时4 Android 动态代码自修改实现2 - 老网恋教父了 - BV1sg4y1B7zB

🎼。

![](img/5b940375f5810110fc6f34272c6ad053_1.png)

![](img/5b940375f5810110fc6f34272c6ad053_2.png)

嗯，好的呃，大家好，我是贾师艾邦。😊，那么今天我们就来讲一个安卓的1个DVN代码，这修改的第二课。那么在上一节课中话，已经简单的演示过了。

如何去通过一个ja层的一个ref中的一个mes结构体来找到一个DVM去其中的一个me代码啊然后从中来修改它的一个 instructionstruct的一个指向。那么这节课的话，我们就来用另外一种方法。

那么这节课方法的话，就是和前几节课事例中一样的。就就是从就是从一个内存中哎去定位它到它的一个DX的一个文件，然后再从这个文件中呢哎去解析这样内存中中的一个DX文件来获取它的一个地址。

然后直接呢对它的一个内存指向的内容进行个修改。实际上整一个程序它在加载的时候的话，就会首先的对我我们的一个des file进行一个解析。然后最终生成了一个mea结构体的里面的指针。

就是这样一个 instructionioninstruct指针的话，就是指这一个内存的一个东西了。好，那么这里我们就来用代码来实现了我们在几节课中在ID中所演示的一个内容。好。

那么首先来打开我们的一个按卓来以最切话以我们前几节课的那个东西为一个蓝图来进行一个扩展。那，首先的话这几天由于1个安卓 studio有有1个22。01个2。0的一个推送。

那么这个推送的话可能还会有点有点bug，所以没有升的话，暂时不要升级。如果升级的话也没有关系，对编译不到不造成什么影响，只是在写代码时候没有可能没有这么方便。



![](img/5b940375f5810110fc6f34272c6ad053_4.png)

如果是MAC7或者说是0us的话，应该是没问题的。好，我们在按住 studio中打开我们的一个上两节课的一个程序，我们对它进行一个呃扩认。



![](img/5b940375f5810110fc6f34272c6ad053_6.png)

好我找一下。嗯，那么这里我们先在一个java层中导入我们一个就正加一个letl体层上的一个代码。让我们从教层中掉一个letnet层，然后对代码进行一个修改。

那么这一里唉前面的话是一个呃word method。那么这里我们就再加一个东西。这这出去me2，然后它的里面参数就空起了。然后在一个点击按钮以后进行一个调位。好，那么从java层直接修改就到这里为止。

然后我们从java层哎从l层中再添加一个函数引用。然后呃这里的话注册也是。嗯，不像普通程碎一样做菜就行了。好，然后上面哎对我们那个传m2，我们引用现的方法进行一个注射。他那这里哎在这里。

我们就开始给一做的方法写一个实现。

![](img/5b940375f5810110fc6f34272c6ad053_8.png)

啊，现来说一下整整一个大致的一个结构吧。首先我们得从内存中来定位到它的一个mapfi的一个文件。然后对这个mfi进行一个取出来，我们先从IDA中看一下它内存中的一个map是什么样的一个样子吧。啊。

我们手机挂机起来，然后IDA进行一个调节。

![](img/5b940375f5810110fc6f34272c6ad053_10.png)

条件操作的话啊，希望大家已经熟悉起来了，直接泡起来，然后进行个调节调试。

![](img/5b940375f5810110fc6f34272c6ad053_12.png)

嗯。然后打开我们那个安卓 server。

![](img/5b940375f5810110fc6f34272c6ad053_14.png)

好呃手机上跑起来，然后只有1个IIT in。好，然后ID直接挂接上去。

![](img/5b940375f5810110fc6f34272c6ad053_16.png)

![](img/5b940375f5810110fc6f34272c6ad053_17.png)

啊，等整个程序它完成一个呃build的一个安装那行了。好，这第是 map。好，这个鸡翅熟食掉。继续。ね。好，我们等我们等它跑起来继续看。嗯，那么这里的话呃跟大家来说一下，升值设及到2。0以后，哎。

就有一个bug。可以看到这里对于一些NDK中默认的一个图文件是不能够自动的进行一个包含这种的搜索的。像这种原来T还有一个讯SRIB的这种库的一个导入的话，正常来说是应该可以正常导入的。但是这里哎2。2。

0中呃，这个bug的话，就是它无法正常的去搜索到它里面的一个数据。所以导致我下面在这里写代码的时候，哎，各种红色的样子。因为它无无法正常的搜搜索到我们的一个信息。

所以这里哎全都变成一个bug的一个形式了。这是这就是一个所谓德个话的嗯。

![](img/5b940375f5810110fc6f34272c6ad053_19.png)

好，那么现在我们就来看一下吧，这个解要程序已经跑起来了，然后IDH去进行一个debug attach。



![](img/5b940375f5810110fc6f34272c6ad053_21.png)

好，我们我们进行一个挂接，找到目标的一个进程。然我打开它。

![](img/5b940375f5810110fc6f34272c6ad053_23.png)

好，那么这里我们按一个contrl加S来编辑它的一个内存的一个结题。然后可以看到，现在它我在程序运行起来以后呢，它在内置内存中m map了这么多的一个信息。他们这里就是它的一个mac中的一个内容。

可以看看到这里对应的每一个起始地址，结束地址，这个什么名称。然么它的内存访问属性又是一个什么样的一个样子的。那么我们在程序中也是一样，可以做到类似这样一种样子。

便你通过编辑它的一个内存的一个属性来找到我们需要定位的一个de文件地方，哎，就最后进行一个修改。然后这里我们就来尝试去进行一个呃代码的一个修改。那么首先哎其是要定位到这个地方就是一个。



![](img/5b940375f5810110fc6f34272c6ad053_25.png)

DY70的1个OBT的1个head。那们定位到这里，那么这里我们先来进来使用一个呃ga base的一个函数。那么这个函数的话是从一个SO hook的一个代码中给抽出来的。



![](img/5b940375f5810110fc6f34272c6ad053_27.png)

![](img/5b940375f5810110fc6f34272c6ad053_28.png)

嗯，那么它作用就是一个获取一个模块的一个机子。好，我们来。我们来看一下它的一个大重吧。首先只出它的一个PID，然后从PID中就来读取我们的一个process的一个max的一个数据。

从对应地对读出相应地存的一个max数据以后，哎，就从一行一行读出读出它mac信息，然后按每行给打出来，一旦找到我们传递传递过去的一个mod以后呢，就对它的一个进行复值。

然后返回很显然只是一个非常基本的一个变利一个模块地址的一个函数。我们来进行个调来看一下它的一个实际效果。好，那么在里PID传递一个副业的时候，就代表它是一个对于自身的一个全卖火。然后后面来一个置放信息。

随便乱输一点先好，我们来跑一跑一下。看一下一个麦克信息来看。好。这里这里这里这里它提示我使用的使用的一个版本比较近，我们再更新一下。呃，对新码来说的话，现在是用1个0。72法一的一个版本。嗯。

这个一如在官网中也可以看得到。那么现在它对新版的1个呃IDA看到没？对新版的话成的一个插件版本是需要进行一个更新的。可以在官网中进行一个同步的一个查看。那么现在更新完以后，就是一个呃这个样子了哈。

然后再再再再再。好，更希望以后的话是一个道法式的一个版本。1。7。02法式。好，说定一下。我们来看一下整个程序现在跑起来的样子啊。我们点一下按钮，看一下它一个lockck信息的一个输出是什么样的样子。

马那们可以看到这里已经把它一个内存的mac进行了一个便利了，看一下它便利变利的一个效果，对吧？起始地址还有结束地址，然后它的内存访问属性，还有其他的一些大小，这也是它的一个内存度的一个mac大小。

那是时间，然后是一个内存中的这段的一个数据。往下放一下的话，哎，这要给我找到我们想要的一个内存了。

![](img/5b940375f5810110fc6f34272c6ad053_30.png)

好，在这里在这里。这里就是我们需要找到的一个一个目标内存。其实地址是一个7是ECB000的，然后结束地址是这样一个本安外出出现是一个R，还有一个P的一个权限。然后它大小的话哎知道什么。好。

那么这里就是我们要寻找的一个麦。从一个结尾减一个起始地址就能能够算出它的一个长度了。好，那么这里我们就对这个地方进行个变译，找到这里好，找到这里为止，然后开始去读出它类存的一个数据。



![](img/5b940375f5810110fc6f34272c6ad053_32.png)

调用这样一个模块给它的一个磨模掉量给传一个正确的值。然后获取它的一个指针。うん。然后再对它完整性进行了判断。打印一些消息。那么这里由于我在入下程的时候的话是不能够同时进行一个l层上的一个调试的。

那么所以这里的话就尽量的多打几个log消息来对程序进行一个跟踪。那么这里哎你从ID中可以看到，这里取出来来的话，哎是这一种形式的。它首先是一个0328长度的一个呃DSOPT head。

也也就是它的一个优格化后的一个头文件。

![](img/5b940375f5810110fc6f34272c6ad053_34.png)

然后它在下面的话就是一个我们内存中完整的一个d的一个文件了。好，这那么我我们的目标就是取到这样一个d文件，对它进行一个解析。



![](img/5b940375f5810110fc6f34272c6ad053_36.png)

![](img/5b940375f5810110fc6f34272c6ad053_37.png)

好，从这里开始，就是从这样一个带起来head的头开始。从这去到我们那个我们的一个class defined的一个属性。那从class defined中哎，再来取出我我们的一个me的一个结构体。

取出这一个class data，然后在里面取出一个me结构体，你要获取到我们想要的一个方法以后，再从里面取出一个DX code结构。

然后从里面就来修改我们的一个instruction的指向的一个指向的一个内容。啊，我们就来对它来实现我们这里的一个修改。首先对它的这个定位。



![](img/5b940375f5810110fc6f34272c6ad053_39.png)

![](img/5b940375f5810110fc6f34272c6ad053_40.png)

![](img/5b940375f5810110fc6f34272c6ad053_41.png)

![](img/5b940375f5810110fc6f34272c6ad053_42.png)

![](img/5b940375f5810110fc6f34272c6ad053_43.png)

那么这里由如果不需要1个OPD head的话，就直接略过去了。嗯。嗯，也脖过这里不略过也行，直接进行一个fi page也可以。我们来手动的算一下它的长度吧。嗯，这里用它的一个结尾地址。

然后减去它的一个起子地址，就能够算出一个map的一个长度了。好，其实是1个EC的A。好，我操长度是高B40B413。我们对它进行一个获取。好。那么这里就调用一个des five place的一个函数。

那么这个函数的话，从呃第一节课上面节课中已经有人介绍过了，这个参数就是对内存中的1个DX文件进行一个解析，然后转化成到这个DX five的一个属性。嗯。うん。continue是这样对。

传这样一个参数过去，这样他即使发生了一个错误，也会尝试去进行一个解析的。EXFLE然后把一些参数的一些数据。然后最后话要对它行一个释放，不然会造成一个内存上的一个泄露。好。

如果如果这里我们取出一个1个DSfi成功以后的话，那么它内存中哎就可以是这个样子了。我们打开我们那个模板中来看一下。



![](img/5b940375f5810110fc6f34272c6ad053_45.png)

![](img/5b940375f5810110fc6f34272c6ad053_46.png)

找到我们并刷的APPK文件。啊，对它那个DX软件进行一个查看。

![](img/5b940375f5810110fc6f34272c6ad053_48.png)

![](img/5b940375f5810110fc6f34272c6ad053_49.png)

好，摸出它的一个de来一个数据。

![](img/5b940375f5810110fc6f34272c6ad053_51.png)

哦，然后在1个0102盒中进行一个打开，然后又跑一下模板进个解析。

![](img/5b940375f5810110fc6f34272c6ad053_53.png)

![](img/5b940375f5810110fc6f34272c6ad053_54.png)

好，这就这样。好的好，那么解析出来以后，那么这里这里直接解析出来的话，就是一个获取到一个结构，里面有一个向 head，还有一个一个方法的一个deice的一个属性。这也下面的这些就暂时不能用。

因为没有行相应的一个解析。那目前我们可以用的前面这几个数据，我们重新从这几个数据中去找到我们想要的一个类，然后找到想要要一个方法，这个方法进行一个解析。实际上那么这里直接的对一个 ID。

然后进行一个便是可以的对吧？对开也是可以的。那么这里使用原始一点方法从一个。

![](img/5b940375f5810110fc6f34272c6ad053_56.png)

这一个des开始，然后去进行一个配。首先我们要获取它的一个class define一个结构。啊，就是从这里我们进来获取到这样一个结构中，哎，获取这样一个结构中，我们的一个目标函数的目标类的一个信息。

也就是定位到这样一个类中去。好，我们定位到这里。好，那这里是一个desify的一个呃des class defined的一个结构体。好，我们对它进行一个便利。

那么便利的时候我们就要使用到一个d head的一个数据了。うす。好，我们对一个cos下下进行和便理。嗯，我们就这里我们要使用一个ge guess get class defined的一个数据，然后。

一个个修他一个叠叠放里面的一个信息。接着我们对它呃取出我们相应的一个class的一个数据以后呢，对它里面的一个class IDDS，也就是我们的一个数据的一个名称来获取到它一个数据名称来然。

看一下是不是我们要想要找的一个类。好。对一个四符串进行一个对比，这样一个 streamcompare的一个函数里面传的一个参数就是一个。嗯，stream把它IDX就是一个获取它一个字符算数据以后。嗯。

是高斯DX，然后里面传的第二个参数，就是我们要比较的这样一个类了。那么这一个类就是这里的样子。好，那么这里就使用一个最为原始的一个前面加L，后面加分号的一种形式。如果找到以后，哎，我们就直接break。

对我们上面的东西进行个辅蚀，然后。嗯。好，那么这里提一个消息说我们已经找到一个class数据了，然后再从里面再读取我们的一个class data。个す。好，我们取它的一个class data。嗯。

这个它就是一个di的文件。嗯。有 data传的是一个P data，还有是一个prelim指针。那么这里哎这里就能够读出这一个好，这样传过去就能够读出它的一个d中的一个数据了。

然后跳过去看一下哈说明好后面的一个就是它的一个尾尾部指针，传档的话就可以直接的读出来了。然后在涂完以后，后面还要一个进行一个。保证它内全不会泄露。好。

那这里我们读出它的读出它的一个class data以后呢啊就是这样一个data数据，读出来读出来以后，就开始对它的一个shop面的这些便利来找到我们那个return的一个方法，就是这样一个方法。

我们来找到它，然后对它进行一个修改。好，那么下面就是来编辑一个visual measure的一个数据了。好。又是一个循环，这里里面的话就用到一个J。嗯，你用I也可以就I吧这里。

然后SM小于它的预售me method是那个 size。好，那么这里就一个个取出来。那么里面取出来的是一个DSsmith的数据。是一个リメ打概。里面取引用，取个地址出来。

然后跟再根据一个mess去发一个mess ID。好，把一个。ID值取出来以后呢。嗯，好先。把它ID词取出来以后呢，我们就能够获取到这个这样一个方法的一个名称了。我们再对这样一个方法名称进行一个对比。

找到想要的哎，就直接的对它一个code取出来就行了，还是一样。去写一个之后串上的一个对比，然后就是面传从而是一个。stream版ID和PID的一个。然后这也就。或选我们的一个rettrain的一个方法。

好，进几个对比。这边的参数是PDX5。获取完以后呢，我们就获取它的一个cose数据。然后里面穿了是一个P面是。Dスけ call。有应该是一个cos的一个数据。好，获取到以后我们混淆这样一个库数据以后呢。

就能够开始的去就等于获取到这样一个数据以后呢，我们就来就能够开始的去取它的一个exstruct的一个数值，然后进行一个修改了。是在P扣的1个ISIS。我们直接的改这一个地址中的一个内存就行了。



![](img/5b940375f5810110fc6f34272c6ad053_58.png)

呃，由于在IP中已经可以看得到了。那么这里是一个只读访问的。那么对于这样指读访问，我们要改一下，对它变成一个VY，不然的话我们因为微竟我们要对它进行一个写数据。但是由于它的只读的话，如果我们不干。

不改变它的一个内存访问属性。那么这样一写上去，那么整个程序就可以包出一个内存页的一个异常。所以我们就先得先调用一个apple来对它进行一个数据进行一个改变。好。

调换这样n tenL是一个page style，然后是一个page size。后面第三个参数就是我们想要的一个访问权限了。



![](img/5b940375f5810110fc6f34272c6ad053_60.png)

好，我们调用它的一个本态的一个属性。啊，前面几个头文件要引用一下，就是一个这几个头文件。

![](img/5b940375f5810110fc6f34272c6ad053_62.png)

![](img/5b940375f5810110fc6f34272c6ad053_63.png)

然后下面就对它进行一个更改。

![](img/5b940375f5810110fc6f34272c6ad053_65.png)

嗯，好惨。

![](img/5b940375f5810110fc6f34272c6ad053_67.png)

到一个皮扣的一个instruction。要 seeが picture sized。

![](img/5b940375f5810110fc6f34272c6ad053_69.png)

然后第三个参作就是想要的个访问权限。嗯。

![](img/5b940375f5810110fc6f34272c6ad053_71.png)

能要一个整个访问，还有一个呃。还有个斜法的。如果它等于零的时候，就证明它这样一个操作是成功了。那么在等于零的时候，我们就对它进行一个。写一个数据的操作。我们直接把它复制为一个return2的一个数据。

就是这样一个东西。呃，注意一下，这里是一个低端自学区的，所以要转换一下，就是0超000F2012。那么这里是一个低端字节去这样子啊，然后后面就把它的一个。给转回去，那么这里它是一个UE的一个指针。

把它强制转换成一个U4指针，然后再取出来。嗯，出来，然后这里。有时也不知道吗，有时知道。现这应该没问题。好，那我们这里这样强行的取出来以后，哎，它修改完以后，我们就把原始的一个内存页属性给辅助回去。

把一个零给弄回去，那么这样就行一组完整的一个简单的修改。我们尝试进行一个编译来看一下它运行的一个效果。好，那第一个配置赛的时候，他刚刚告诉我们不能够进行个手汉。我们进入一个进行一个墙转吧。

强制组成一个硬核一个数据。好，嗯这样。

![](img/5b940375f5810110fc6f34272c6ad053_73.png)

嗯，是一个好能好个。嗯，我们是不是他要要添加一个f啊？う。这一个。好，添加一个发展的一个数据。好，正在运行。那么这样我们添加这样一个参数的快技，能够完成一个子针间的一个强制转换的。嗯。

这是一个GCC编译的时候的一个参数。那这里我们使用1个CPf and话，就能够为我们的一个程序中哎添加一些编译的一个选项。好，我们对它进行一个编译，然后运行来看一下我们的一个运行效果。

是不是能够正常的取出我们的一个data数据，然后进行一个修改。那么这样也多打印几个信息。好，我们只是运行跑起来。点一下，然后这里就爆出一些错误了。就是该会菜了介绍的 since是 first怎么说说。

変ったけど。日本みで。那部 past this five这也这就这也就说了，我们这里的一个对一个des five进行一个配置的时候就发生一个错误。



![](img/5b940375f5810110fc6f34272c6ad053_75.png)

他说我们的一个数据是太太大太错了，我们这里就改一下。我用我用我们底铺下1个OPT的一个header呢，就把它给取掉。然后这里传递过来，那么s的话就改一下。看这种样子啊，我们再来烤一遍。啊。

这里已经成功的获取到我们我们的我们的的一个模块地址了，就是这种样子。うん。再来改一下变这个样子好。的，我们来看一下。哎，那么这样已经完事了，那已经完善。嗯，看一下它的法回值已经被我们改成是一个二。

从从上往下看的话就是一个获取到一个模破块地址，然后哎就来并列我们的一个方法。或获取到我们的我们那个方法以后呢，就来对我们的一个。一个方法进行一个patch。那么这里就对一个内存页进行一个修改，改完以后。

假如改成功以后就尝行的对内存数据进行一个呃补值。补完以后，把它的内存页也改兴去。哎，那么就把它以后呢又到java常务调我们的一个的一个方法，就发现它里面的数据已经被改掉了。

那么它最终开结果就是那么这样一种从内存中去定位这样一个化的数据，然后从里面再去修改它的TS code的结构的话，在很多加密的一个加固软软件中也都有也是有用到的。他们在一个de上的一个加密的话。

就基本上都是这种思路了。

![](img/5b940375f5810110fc6f34272c6ad053_77.png)

当然现在像现在ja克软件的话就做的比较好。它一开始不掉之前都是不会对这样的一个数据进行一个还原的。发是在调的时候，再对我们我们的DSfi的数据进行一个还原。哎，来到到一个隐藏的一个效果。

但是对于以前的像I加咪的那种样子的话，它就是可以直接的就能够在一个desfi配的地方下个断点。因为那个时候已经把这一层代码全部给解压，还原回去了。

那么对既玩I加咪可以这样来拖来对一个DSfi配的地方下个断点，能够直接的拖下来。

![](img/5b940375f5810110fc6f34272c6ad053_79.png)

哎，这也是他为什么现在这么多加固可以通过这样一种方式来进行一个脱壳的一个缘故。

![](img/5b940375f5810110fc6f34272c6ad053_81.png)

那么这里这就是这节课中哎所要讲到的一个文件修改的一个内容，这里就是一个一个思路。那么当然这里的话，这节课中就用到了一个对于一个dex文件，对于内存中对于一个dash文件进行一个解析的一个呃方法。嗯。

那么这一点这么多函数的话可能用起来比较不方便。这都是一个Dd中提提供了一个原来大家提供的一个函数。那么如果是对一个文件解析对一个d file解析不太明确，不知道怎么改的一个同学的话。

可以去第二上看一下我的另外一个项目。那么这个项目里面的话，就有清晰的说明了如何去解析一个dex的一个文件的。



![](img/5b940375f5810110fc6f34272c6ad053_83.png)

![](img/5b940375f5810110fc6f34272c6ad053_84.png)

![](img/5b940375f5810110fc6f34272c6ad053_85.png)

就是像这种鞋式的。嗯，这里我也做一个宣传。那么请大家在下面的话有时间呢也可以自己去写1个DX文件解析的一个数据。那么相信可以对大家有对一个ds文件数据的一个一个关有一个就是。



![](img/5b940375f5810110fc6f34272c6ad053_87.png)

![](img/5b940375f5810110fc6f34272c6ad053_88.png)

的一个认识有一个比较好的一个帮助的。

![](img/5b940375f5810110fc6f34272c6ad053_90.png)

好。这里就是一个解他数据的一个方法，只能说这是还原了一个基本的大致思路之一吧。

![](img/5b940375f5810110fc6f34272c6ad053_92.png)

好，那么这里是我的另外一个项目，就这一个样子，它里面就是这样一个呃也是一样，把一个文件读到内存中，然后对它进行一个求解。



![](img/5b940375f5810110fc6f34272c6ad053_94.png)

好嗯，那么这节课内存内容的话就呃到此为止了到此为止了。那么可以看一下内它的一个东西这个样子。好，那么其他有什么不懂的话，那么大家下面去行自己去尽量的去呃写一下这样一个加加固的一个代码。

也可以对它去进行一个扩展。比如说哎可以尝试的去把它一个DX的一个数据给抽取出来，然后以这样的一个形式。然后在运习的时候一步步进行一个还原，这是一个加壳，那是一个加固的一个呃比较呃基本的一个啊思路。

可以自己去尝试去写一个思路，写写一个加固吧，它自己大致上就这样一一样东西。

![](img/5b940375f5810110fc6f34272c6ad053_96.png)

![](img/5b940375f5810110fc6f34272c6ad053_97.png)

![](img/5b940375f5810110fc6f34272c6ad053_98.png)

![](img/5b940375f5810110fc6f34272c6ad053_99.png)

好，那么这节课内容的话就到此为止了，谢谢大家。

![](img/5b940375f5810110fc6f34272c6ad053_101.png)

。