# 经典15年i春秋渗透测试系统化教程 - P28：课时1  CSRF攻击原理及分类 - 老网恋教父了 - BV1n54y1B7F7

🎼Yeah。啊，我们这节课给大家讲解一下CSRF攻击啊，它是苏醒的巨类。

![](img/407fc028cead90c57cef088e38121869_1.png)

![](img/407fc028cead90c57cef088e38121869_2.png)

那么我们首先来呃看一下它的一个简介，有关CSRF网上也有很多相关的文档。呃，但是在这个三度测试过程中，很多人用的很少啊，就是说它的攻击力度比较小。

那么下这节课我们来看一下这个到底这个CSRRF到底什么危害啊。

![](img/407fc028cead90c57cef088e38121869_4.png)

首先我们要知道他的这个鱼。那洞它这个是个什么样的形式？那我们来看一下CS2F就是。快上点伪造请求好跟叉SS有点像一样哈，是吧？其实它是两种攻击啊是不一样的。它是一种呃网络攻击啊，CSRF。

这个攻击它是可以在受害受害者毫无知情的情况下，以受害者的这个名义伪造请求发送这个攻击站点，它是这么一回事的。就以在以一个呃合法的这个。合法的手段来进行攻击的。也就是说呃就是说就是你访问一个网站。那么。

我借用你的名义去干一些非法的事，他是这么一回事的。也就说，从而在这个未授权的情况下执行在这个权限保护之下操作。那么具有很大的这个危害性。那么具体来讲可以这样理解CSRCSRF攻机。

那么攻击者他是盗用了你的身份，以你的名义发送这个恶意请求。那么对服务器来讲，啊，这个请求是完全符合法的。但是却完成了更基所期望的一个操作。比如以您的名义发邮件啊。发消息盗取你的账号。

添加管理员、购买商品、虚拟货币等等都可以实现的啊，大家可以在这个网上找得到相关的案例啊，CSRF更新啊，导致这个。



![](img/407fc028cead90c57cef088e38121869_6.png)

重大损失的呃。也很多。那么接着我们看呃CSRF攻击啊，并不是。并不为大家所熟熟知。那么实实际上很多网站都存在CS22F安全雷动。那么这个大家用扫描器一扫一大片啊，好多就是说存在这个CSRIRF攻击。啊。

早在这个2000年的时候，啊CSRRCSR这种攻击的方式已经在这个国外的这个安全量要提出啊，它是国外提出的，2000年就提出来了。但是到了嗯最近几年才就是说真正就是活火起来啊，以前就是很少。

很少采用这种攻击来攻击网站。但在国内直到2006年才开始被关注啊，而2008年就是国外很多这个大型社区啊网站啊交互式的网呃网站向后爆出了这个CSRF类的啊。嗯，我们举个最简单的简单的例子。

像国内一样百度开。嗯，这百度的都存在这个内容啊。呃，百度一些芦琼C呃利用CRCSRF芦琼攻击百度的，造成很多这个用户中招啊。还有纽约时报上面还有一些大型的博客啊啊UTB啊等等，它上面都有啊都都有这种。

曾经遭受过这个CSCSR的攻击。那么直到现在啊，互联网上许多站点来往对这个CSR攻击毫无防备，以至于安全界称为这个CSRF，它是称为这个程序的巨人啊，程序的巨人。



![](img/407fc028cead90c57cef088e38121869_8.png)

那么危胁程度由此就是美玉便可见一斑。

![](img/407fc028cead90c57cef088e38121869_10.png)

那么这个关于他这个CSRCSRF这个攻击原理解释的。我们看一下第二部分。就是当我们打开网站或者登录某个网站之后，就会产生一档产生一个绘画。这个大家很容易理解。就以我们例如我登录淘宝，我输入淘宝账号密码。

一登录进去。那么我就与淘宝进的一个连接，这个连接，就是说我们这个绘画就要么是绘画以后采用或者扩件信息来进行控制。那么我点击另外一个页面。访问另外一个页面。那么这个为什么能访问另外一个页面？

不访问另外一个页面，不需要我们输入账号和密码的。原因就是有了这个呃绘画或者课件信息啊，这样的话我们不需要区分退出了了。退出之后。那么你。嗯，你把把理文器关闭之后，你再打开这个页面，需要你输入账号密码。

如果在没有关闭状态下，那么。他是不需要你再次输入账号密码的。那么攻击者他就是利用这种模方式。来进行攻击的。也就是说，当你访问那个建立绘画的状态下，那么我再发生一段OE代码。那来模拟模拟你这个受害者。

这种方式来进行操作。那么这个唯一的重点就是浏览器与服务器之间，他们是在这个绘画之中。那么在这个绘画没有结束的时候，那么就是可以利用权线来进行操作啊，做什么时候，大家自己看一下。



![](img/407fc028cead90c57cef088e38121869_12.png)

![](img/407fc028cead90c57cef088e38121869_13.png)

好，我们接着下面。

![](img/407fc028cead90c57cef088e38121869_15.png)

这个。嗯，大家过一遍就行了。

![](img/407fc028cead90c57cef088e38121869_17.png)

啊，下面我们就这里有一个实例哈。有个死点。那么这个就是举个例子，淘宝我们举个例子还像例如像像这个账号。啊，SPSISEC啊，这个账号承诺1000块钱啊承诺1000块钱。那么攻击者他只需要改变这个账号。

改变他成成为自己的。例如黑K这个账号。那么。那么这转账就转了1000块钱。他啊觉觉得他这些如果是转账操作话，不能说存钱操作。那这样的话，根记得把把他自己1000块钱存进去了啊，转账才是转1000块钱。

那么呃空间的的话，只需要把这个中号一改。把把这个黑K这个账号，这个右手这个等于黑K这个账号一改。那么就实现了这个。转账了，也就是说他直接把这个钱啊1000块钱转账到了黑K这个账号上面。就这么简单。

就是在建立汇画的状态下，那么直接就直直接来进行转账的。嗯，这个以前是很多网站都有的啊啊，这个是建设CSRCSRS工计。就当然。与对方网站建立汇换的状态下，如何进行转账操作？啊，转账操作。

那么更记的只需要改变账号。本来你是要转给这个的。转账转转给这个SPISEC这个账号。但是。结果。公击者就是把把这个账号改成公击者的这个账号，真样的话卷账就直接卷到这个黑K上面去了。

就是说从你的账号花了1000块钱到了。黑K这个账号上去。

![](img/407fc028cead90c57cef088e38121869_19.png)

这就是这个CSCSR的攻击的这个危害。那么下面我们来看一下它的这个攻击图。那么。呃，他这里分为五步哈。第一步是浏览器必须要使，但就是说用户正常用户要与微博服务器建立连接，就浏览登录网站。那么成功之后。

那么就会返回呃，就是说我们用户这里验证成功之后啊，有一个扣件信息。在这个呃或者是辉画在这个。用户啊这个用户这一档。那么接受就是访问就。OE网站B，那么B要访要访问这个A。

那么接着访问A就B就会执行这个OE的这个B类OE代码。它是这样的一个流程。那么这里我有一个55个步骤的一个解释啊，大家可以看一下。



![](img/407fc028cead90c57cef088e38121869_21.png)

![](img/407fc028cead90c57cef088e38121869_22.png)

这写的非常详细，就说首先用户C就是一个正场用户，打开浏览器访问我们举个例子，叫A是淘宝吧，就访问淘宝。那么这个输入了用户名和密码啊，登录这个淘宝。那么在这个用户信息通过这个链台后。

那么淘宝网站会产接产生一个科技信息，并返回给浏览器。那么此时用户登录网站。A成功。那么这样的话可以正常。呃，请求到文A。那么在用户没有没有退出这个。淘宝之前啊在浏览在同一浏览浏览器中，那么打开。

打开这个呃就是说B的这个OE页面啊，给我们的OE页面。那么这个文上B。啊，就是攻记者嘛啊登记者。那么接受到这个用户请求后，返回一个攻击代码。我更新代码，并发出这个一个请求，要求对这个。

用户啊也正常用户啊去访问这个A这呃访访问这个第三方的这个站点A哈，第三方的站点A。那么浏览器在这个接收到这些攻击的恶意代码之后，根据这个网站的BD请求，在用户不知情的情况下携带了这个科技信息啊。

像网站这个举对的这个是淘宝，那么就是发送一个请求。那么这个嗯。淘宝啊举类的哎，我就代表淘宝啊，那么淘宝他就并不知道这个请求是有这个攻击者，这为我这毕毕竟是攻击者嘛。就B发起的。

所以会根据这个我们正常就是用户C啊。啊，这个正常的用户的扣件信息以这个呃C的权限来进行访问这个请求。那么这样的话就导致恶意代码被执行的。嗯，他就这样的一个过程，现在明白没有，很简单的哈，就是总结一句话。



![](img/407fc028cead90c57cef088e38121869_24.png)

就是说他就是盗用了我们的身份去实施。经技者的目的。就是说我们正常用户去访问网站。放空网站。那么根基者他就是说利用你在当前的绘画状态下。那是是公击的。实施根击的。



![](img/407fc028cead90c57cef088e38121869_26.png)

那么总结的我这里对这个攻击原理就是总结了CSRF攻击的两个侧重点。第一个是CSRF攻击。它首先要与这个浏览器的外部服务器要建立在绘画之中。啊，困坏之中。



![](img/407fc028cead90c57cef088e38121869_28.png)

啊，要么就你就算不在绘画，就是你也要或者你这个。

![](img/407fc028cead90c57cef088e38121869_30.png)

呃，用户这一当有这个课技信息，在下次访问的时候。不需要输入账号密码，在这种状态下，你才可以进行这个CICSRRF空间。它就这样一个过程。呃，有很多用户在访问网站的时候，都是保存账号密码，点击保存的。

在下次这个浏览这个网站的时候，就不需要输入这个。账号密码。为什么这个账号密码这个客件信息啊是保存了在用户这一档，这样的话是存在危险性的。就是CSIIF也就下次你不需要建立这个绘画状态下。

就是说不需要打开IE浏览器。那么更记者，他直接可以，比如把这个更新代码插入到win222压缩包里面。这是当你用户嗯打开这个压缩包的时候，就直接执行到这个OE代码。或者插入到呃其他的地方啊。

一些页呃一些页面啊。啊，绑定在一些软件里面等等等等那些方法很多很多，或者与叉SS结合啊，是吧？

![](img/407fc028cead90c57cef088e38121869_32.png)

太多太多了。第二点是要欺骗用户访问这个URAA了。欺骗用户访问UII。就这个两个侧重点必须要记住。这是构造这个CSCSRF的。



![](img/407fc028cead90c57cef088e38121869_34.png)

根基的两个侧重点。好，接着我们来看一下这个。

![](img/407fc028cead90c57cef088e38121869_36.png)

呃。CSRF的这个分类。

![](img/407fc028cead90c57cef088e38121869_38.png)

啊分ね。那么这个CSRF类种啊，一般分为这个站外和站内两种类型啊，站内攻基和站外根基。那么我们来看一下站外站外类型的站外类型的这个漏洞本质就是传统意义上的外部提交这个数据问题。

那么这个通常是有陈序网会考虑给一些留言就留言板啊、留言榜啊。在用户留言的地方或者品论的地方，这个表单加上血印，以防止这个HPIM这个问题。他说哎这里的SPAAM它是可以简单理解为垃圾流液或垃圾品类啊。

或者是带有障外连接的这个恶意回复。这种这种模式。但是有时为了这个提高用户的。体验性啊。这对方网站。那可能会没有对这些操作做任何限制。所以攻击者可以实先预测并设置请求的参数。

在站外的外博页面或者编写脚本来伪造这个文件请求。或者。和这个自动提交的表单一起实现。getpos的请求。就是当我们用户绘画状态下，点击这个连接就访问了外部的。外面的这个微博页面，这样的话。

客户单就是用户就被抢迫发送请求。那么这个站内呢CSIR站内这个。商类型的这个漏洞是在一定程度上是有程序员滥用。这个离库这个变量啊，这个类的这个变量造成的。嗯，在一些敏感的这个操作中，例如修改密码。

添加用户。本来要求这个用户从表单提交。发起这个pos请求传递给这个。参数给这个程序员，但是由于这个。使用了这个你快速的这个变量，就是这个变量是什么意思？

那就就是说它接收所有的啊所有的啊get出也可以接接收，抛s也可以接收接收或就是也可以接收。这三种器都可以接受，而其他的方式也可以去接受。那么这种是非常危险的啊，本来只是允许pos提交。

结果get也可以就完了。啊，这样子就完了。那么程序员。除了支持这个其他的你那盖造的，我这里都都那个了都写了。所以说啊那么根记者只要把预测请求的这个参数放在站内站内的一个什么贴纸，或者留言这个图片链接里。

那么说外在浏览这个页面就会被强迫发起。这些请求。那么现在我们大家应该嗯。知道了这个。他这两类的一个区别吧，CSRF一个是站内，一个是站外。啊，站内是一个什么形式？站外的是一个。一个什么样的形式？

当然现在应该非常清楚了。

![](img/407fc028cead90c57cef088e38121869_40.png)

好，我们接着看啊，它的这个检测啊，CSSRS类目的一个检测。

![](img/407fc028cead90c57cef088e38121869_42.png)

![](img/407fc028cead90c57cef088e38121869_43.png)

那么要检测这个CSRF雷动，那么它是一项比较繁琐的工作。再简单的方法就是抓起一个正常的这个请求数据包，去掉这个李付这个字导。再重新提交。如果该请求还有效，那么基本上就可以确定这个是存在CS2F内的。

这句话是非常。非常重要的一段话。目前基本上所有的扫描去检测这个CSR那种，那么就是根据这个档。自道买。包括一些防御软件，就是像那个防盗链网站防火墙防盗链这个模块，它也是根据这个李货兹的，就是说。

如果你这个李货知道不是我。本身网站的这个网址，那么你如果从其他的地方来的，那么你就不允许。下载我的资源，那么这就是防盗链实现的。他就是根据这个礼缝来判断的。啊，你过来看到。

那么扫描器检测这个扫描这个呃CSRF雷动的时候，它也是这样，它就是把这个数据包里面的离副字动去掉。确能咧。正常提交啊，数据包是否有问题？如果没。正常可以访问，那说明就存在CSRF。因为我们这个离货。

如果我改成这个。外部地址的任何地址。如果还是跟我们就是有这个离货的本身的网站的。这个网子是一样。是一样的效果，正常返回数据包正常请求。那就是。简单可以看到它是存在的1个CSIF那动的。

那么这就是一个碰撞方法啊。大家等一下，我会给他教大家怎么去操作。一般我们通过什么啊这个BRP来模拟啊，抓一个包。那么随着对这个CSRF雷动的研究的不当深入。

那么不断涌陷出一些专门这个针对CSRF雷动攻击检测工具。比如啊这个工具。嗯，这些工具，那么这些工具你像有awa的啊，awa的。再出。😔，出的这个CSRF taste这个工具。

那么这个工具其实没有BRP好用啊，BRRP的本身自带的这个CSRF比它还好用一些。所以一般情况下，我不推荐大家使用这款工具。大家只要把BUIRP这个神器这款工具啊用的很厉害的。

那么你你这些工具就不用考虑了。那么我们看一下这款工具的它的原理啊，它也是一样的。它是首先抓取这个我们在浏览器访问过的所有连接。以及所有的这个表单等信息。那么通过这款工具修改这个表单里面的信息。

重新提交就相当于一次。伪造这个客户单请求。如果修改后的这个测试请求成功。那么被网站服务所接受，那么就存在这个CSRF那种。当然，这款工具也可以被运来进行CSR分接。



![](img/407fc028cead90c57cef088e38121869_45.png)

CSR购工具。那么这个反正这款工具我一般用的比较少，我一般都不用。但是我在这里也在后面的实验也给大家。



![](img/407fc028cead90c57cef088e38121869_47.png)

![](img/407fc028cead90c57cef088e38121869_48.png)

嗯，写了一下啊，单独针对这款工具写了一下。

![](img/407fc028cead90c57cef088e38121869_50.png)

好。嗯，但是我们的等一下演示，我们还是用B2RP吧。这个工具我我个人就我不怎么喜欢啊，不怎么喜欢。

![](img/407fc028cead90c57cef088e38121869_52.png)

好，那么我们这节课就给大家讲到这里。嗯，下一节课我们直接给大家来实练CSRF。

![](img/407fc028cead90c57cef088e38121869_54.png)

啊，到底怎么样去攻击的啊，怎么攻击的，把这个过程就给大家。嗯，演饰一遍。

![](img/407fc028cead90c57cef088e38121869_56.png)

嗯，这节课就就就讲一下原理就行了哈，你就整个过程好，下节课再见。

![](img/407fc028cead90c57cef088e38121869_58.png)