# 经典15年i春秋渗透测试系统化教程 - P44：课时2 PHP Multipart Form DoS与Slow HTTP Denial 🛡️

在本节课中，我们将学习两种针对Web服务器的拒绝服务攻击：PHP Multipart Form DoS攻击和Slow HTTP Denial慢速攻击。我们将了解它们的原理、演示攻击过程，并探讨相应的防御方案。

## 概述

本节课将介绍两种能够导致Web服务器瘫痪的拒绝服务攻击漏洞。第一种是针对PHP环境的Multipart Form DoS攻击，由百度安全团队发现并上报。第二种是Slow HTTP Denial慢速攻击，它利用HTTP协议特性耗尽服务器连接资源。这两种攻击都可能被安全扫描器（如AWVS）检测出来，但修复方案在网络上相对较少。

## 一、Slow HTTP Denial 慢速攻击 🐌

上一节我们概述了两种攻击，本节中我们来看看第一种：Slow HTTP Denial慢速攻击。这种攻击利用HTTP协议，通过缓慢发送或接收HTTP请求来保持连接长时间打开，从而耗尽服务器的并发连接池。

### 攻击原理与影响

慢速攻击的原理是针对Web服务器HTTP头部传输的最大许可时间缺乏限制。攻击者发送缓慢的HTTP请求，使服务器线程或连接保持等待状态，最终阻塞服务器，导致合法用户无法访问。

这种漏洞在许多服务器上存在，但国内部分扫描器可能无法有效检测。然而，AWVS等扫描器能够识别此漏洞。攻击者无需大量资源，仅需个人电脑和普通带宽即可在一秒钟内使目标网站瘫痪。

![](img/a507b682e9248d5497059aab27ae9b84_1.png)

### 攻击演示

![](img/a507b682e9248d5497059aab27ae9b84_3.png)

以下是使用国外一个Python脚本进行慢速攻击的演示过程。

首先，确保系统已安装Python环境。攻击脚本的使用方法可以通过帮助命令查看。

![](img/a507b682e9248d5497059aab27ae9b84_5.png)

```bash
python slowhttptest.py -h
```

![](img/a507b682e9248d5497059aab27ae9b84_6.png)

![](img/a507b682e9248d5497059aab27ae9b84_7.png)

关键参数说明：
*   `-t`：指定目标域名或IP地址。
*   `-r`：连接速率，可设置为256或512等。
*   `-p`：目标端口，默认为80。

攻击命令示例（针对IP为`192.168.1.110`，端口为8080的目标）：
```bash
python slowhttptest.py -t 192.168.1.110 -r 256 -p 8080
```
执行攻击后，目标服务器将因连接资源被耗尽而无法响应正常请求，网站页面将无法打开。

### 防御方案

![](img/a507b682e9248d5497059aab27ae9b84_9.png)

防御慢速攻击的核心是对HTTP头部传输的最大许可时间进行限制，建议设置为20秒。如果超过指定时间HTTP头部仍未传输完成，则判定该IP为慢速攻击，并将其连接中断并加入黑名单。

![](img/a507b682e9248d5497059aab27ae9b84_11.png)

![](img/a507b682e9248d5497059aab27ae9b84_13.png)

具体实施因服务器中间件而异：

![](img/a507b682e9248d5497059aab27ae9b84_15.png)

*   **Apache**：可以通过模块或修改配置文件进行防护。例如，在配置中限制每个IP的连接数、设置最大活动连接数等。
    *   限制每个IP最多50个连接。
    *   设置活动TCP连接最大数量限制。
    *   当连接数达到阈值时，拒绝新的保持活动连接。
*   **Nginx、Tomcat、IIS**：各有对应的配置方案，通常需要在防火墙或WAF（Web应用防火墙）中设置规则来拦截慢速连接。

对于使用某些Web中间件（如weblogic）搭建的网站，可能需要寻找特定的补丁或配置方法，有时修复起来较为困难。

---

## 二、PHP Multipart Form DoS 攻击 💥

![](img/a507b682e9248d5497059aab27ae9b84_17.png)

了解了慢速攻击后，我们来看第二种更具针对性的攻击：PHP Multipart Form DoS攻击。此漏洞由百度安全团队研究发现并已提交至官方，它通杀所有未打补丁的PHP版本。

### 攻击原理与影响

该漏洞是一个拒绝服务攻击漏洞，专门针对PHP环境。攻击者通过发送特制的`multipart/form-data`请求，可以导致PHP进程消耗100%的CPU资源，从而使服务器瘫痪。只要网站由PHP搭建且未升级到最新安全版本，就可能受到此攻击。

### 攻击演示

![](img/a507b682e9248d5497059aab27ae9b84_19.png)

以下是在本地环境中的攻击演示。

![](img/a507b682e9248d5497059aab27ae9b84_21.png)

首先，找到攻击脚本（通常是一个Python文件）。查看其帮助信息和使用方法。

```bash
python php_multipart_dos.py -h
```

![](img/a507b682e9248d5497059aab27ae9b84_23.png)

基本用法是在`-t`参数后接目标IP地址，如果目标不是默认80端口，则需用`-p`指定端口。

![](img/a507b682e9248d5497059aab27ae9b84_25.png)

攻击命令示例（针对IP为`192.168.1.106`，端口为8080的PHP服务器）：
```bash
python php_multipart_dos.py -t 192.168.1.106 -p 8080
```
执行攻击后，可以观察到目标服务器的CPU使用率瞬间达到100%，网站服务完全无响应。停止攻击后，CPU使用率恢复正常。

![](img/a507b682e9248d5497059aab27ae9b84_27.png)

### 防御方案

修复此漏洞的方法相对直接：**及时升级PHP到最新版本**。PHP官方在接到报告后已发布安全补丁。管理员应关注官方通告，对服务器上的PHP环境进行升级。

---

![](img/a507b682e9248d5497059aab27ae9b84_29.png)

## 总结 🎯

本节课中我们一起学习了两种Web服务器拒绝服务攻击。
1.  **Slow HTTP Denial慢速攻击**：利用HTTP协议缓慢通信的特性耗尽服务器连接资源。防御关键在于在服务器或WAF上对连接超时时间和单IP连接数进行严格限制。
2.  **PHP Multipart Form DoS攻击**：针对PHP环境的特定拒绝服务漏洞，可通杀未打补丁的所有版本。最有效的防御方法是及时将PHP升级到已修复该漏洞的最新版本。

![](img/a507b682e9248d5497059aab27ae9b84_31.png)

![](img/a507b682e9248d5497059aab27ae9b84_33.png)

作为安全测试人员，了解这些攻击有助于评估系统安全性；作为运维人员，则应及时应用修复方案，保护服务器免受此类攻击影响。课后请大家在授权环境下进行练习，加深理解。