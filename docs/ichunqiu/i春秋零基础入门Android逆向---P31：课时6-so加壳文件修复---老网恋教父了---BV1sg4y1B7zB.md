# i春秋零基础入门Android逆向 - P31：课时6 so加壳文件修复 - 老网恋教父了 - BV1sg4y1B7zB

🎼。

![](img/fe7c5eb11b15b90741c2c0e042420518_1.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_2.png)

🎼Yeah。大家好，我是贾师爱8。那么今天的话来讲一个SO文件。它加壳以后，我们应该如何去对它进行一个分析。那么上几节课的话就已经讲过了，对于一些呃对于一些混淆不怎么严重的的1个SO文件。

我们该如何对它进行一个还原进行一个修复。那么这节课的话讲了这个加壳的话，它混淆比较严重。你用以下的方式是呃搞物了，我们来可以来看一下，这是一个帮帮帮加可以后的一个APK文件啊，看一下帮帮加壳了。



![](img/fe7c5eb11b15b90741c2c0e042420518_4.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_5.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_6.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_7.png)

嗯，有于时间问题的话，就嗯就快点啊进行个分析吧。

![](img/fe7c5eb11b15b90741c2c0e042420518_9.png)

那么这个帮方夹可它它它在加载来时候的话，和360是一样的，会首先判断我我们的一个机器的一个版本，看一下是DVN的还是ART的，是超86的还是还是ALN的。如果找到对应的地方的框。

那么就可以加载相应的一个相应的1个SO文件。那么这里由于我是1个DVM的1个ART。

![](img/fe7c5eb11b15b90741c2c0e042420518_11.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_12.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_13.png)

一个R的1个S文件，那么它就可以加载这样一个呃s目录下这个S文件。好，那我们来尝试用IDA对它进行一个打开，来看一下怎么样效果。那么提示我们下说它的table是非法的。

然后然后它提示一个880da是非法的。好，那么接着他就退出了一个。

![](img/fe7c5eb11b15b90741c2c0e042420518_15.png)

加载认为他加载的时候遇到一些错误，没有办法正常的一个进行了。好，那么既然如此，我们来尝试对它进行一个修复。那么修复的时候还是要先使用1个VDEF工具来获取到它的一个呃。



![](img/fe7c5eb11b15b90741c2c0e042420518_17.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_18.png)

EF文这个数据线。

![](img/fe7c5eb11b15b90741c2c0e042420518_20.png)

系系啊。使用立体I服。然后。

![](img/fe7c5eb11b15b90741c2c0e042420518_22.png)

然后然后对它提取出来的一个log数据进行打开来看一下它什么情况。

![](img/fe7c5eb11b15b90741c2c0e042420518_24.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_25.png)

呃，当致一个浏览一下，话可以发现帮帮的话，他已经帮我们把一个筛选 header给证明了。然后下面可以看到它只有一个program header，以后没有说比后说筛选数据都是空的。哎。

这以它的一个自选表已经被干掉了。但是他的program head还是可以看的。那这种情况应该怎么办呢？哎，我们可以尝试从一个program head来重建一个筛选 header。

也就是我们上节课中所讲到用工具的那个办法。

![](img/fe7c5eb11b15b90741c2c0e042420518_27.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_28.png)

那这样这样这种情况的话，用手工来搞的话这不太可能了。好，我们先来跑一下这个洗护工具。

![](img/fe7c5eb11b15b90741c2c0e042420518_30.png)

然后学会在筛选节。

![](img/fe7c5eb11b15b90741c2c0e042420518_32.png)

好，我媳妇完的话是这种情况。

![](img/fe7c5eb11b15b90741c2c0e042420518_34.png)

我们来将IDA打开来进行一个分析。好提示这一种错误，bande是correct，然后什么什么哎这都提示一个错误，但已经能够呃勉强加起来了。右边的左边这个函数能够正常识别出来，然后右边要把变译窗口呃。

只示部分呢给修复过来。

![](img/fe7c5eb11b15b90741c2c0e042420518_36.png)

好，是这样种情况的，我们来看一下。然后点过去里面的一些导数函数会发现哎，非常奇怪，里面的全部的数据都是这样的形式。什么ANEQ是什么意思呢？我们把它的一个呃1G的代码给搞出来，会发现这里全都是零。

证明哎这些数据都是空的，没有数据，这是为什么？这是是是因为它本身这个SO呢是经过加壳的。然后它在运行的时候会把原始的数据给释放出来，然后填充到这里对应的地方上去。



![](img/fe7c5eb11b15b90741c2c0e042420518_38.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_39.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_40.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_41.png)

那么这就涉到于涉及到一个加可的SO的一个还原一个修复了。

![](img/fe7c5eb11b15b90741c2c0e042420518_43.png)

我们该如何把像把像这种呃ja过可的一个文件来完成一个修复呢？那么这就是我们这节课将要讲的一个内容。

![](img/fe7c5eb11b15b90741c2c0e042420518_45.png)

好，那么我们就不微号，我们来看一下它的一些特征吧。我既然说到这个文件可以加加加过壳，那么我们再来看一下为什么说它加过壳呢？我们来看一下它等一个pro，然后主要的留意一下它两个log区段。

就是这个这两个加载区段，前面已经说过link可link的话就可以根据这两个渠段中的数据把文件中的内容给加载到内存中去的。好，那么第一个渠段还没有什么问题啊，文件大小是这样。

然后第二个渠段的话问题就出现了。我来看一下它的文件大小是52C，但是映射到内存中的话是1548，它们中间的话多了你超100进07的之之前的一个数据。那么这个数据是怎么来的。



![](img/fe7c5eb11b15b90741c2c0e042420518_47.png)

那么这个数据的话，就是由于它的1个SO文件给对把这上的那个数据给释放，然后填充回去哎，这样而来的。

![](img/fe7c5eb11b15b90741c2c0e042420518_49.png)

好，那么在对像这种加固可的SO文件的话，非常明显一个特征，就是它的一个文件大小至小于它的一个内存上的一个大小。好，那么这里就是一个加固可的SO文件。既然如此哎我们知道它要自报数据要解密数据了。

那么我们当然的要把它的数据想办想方设法把它原时真实解码以后数据给全部提取出来，那么这样才行。因果提取的操作的话，我相信大家已经想到了，就是没错，就是在一个在它运行的过程中，把它的数据给倒出来。



![](img/fe7c5eb11b15b90741c2c0e042420518_51.png)

那，那么既然如此，我们就来尝试对它数据进行一个提取吧。呃，帮方的这个S文件的话啊教育比较强。那么可能在这里我操作的时候，可能和大家下面这己操作会有比较大的一个出入。

可能按照我的操作也不能不一定能够调试起来。啊，如果出现这种情况的话，可以等我后面杰课把一个仿条视频讲完以后再来进行一个尝试。



![](img/fe7c5eb11b15b90741c2c0e042420518_53.png)

呃，这个这个帮帮的调试校验的话还是比较强大的。我们我们就来一步步尝试吧。呃，首先现来进行一个安装。

![](img/fe7c5eb11b15b90741c2c0e042420518_55.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_56.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_57.png)

然后嗯安装好一个贴文件。然后利用IDA来进行一个调试。

![](img/fe7c5eb11b15b90741c2c0e042420518_59.png)

嗯，然后把一个调试端口给打开。

![](img/fe7c5eb11b15b90741c2c0e042420518_61.png)

打开一个模拟ister。

![](img/fe7c5eb11b15b90741c2c0e042420518_63.png)

然后用I接A来进行一个呃调试挂接。

![](img/fe7c5eb11b15b90741c2c0e042420518_65.png)

好，创建一个。

![](img/fe7c5eb11b15b90741c2c0e042420518_67.png)

文件。

![](img/fe7c5eb11b15b90741c2c0e042420518_69.png)

你一个调试的方式请启动我我们的APK软件。

![](img/fe7c5eb11b15b90741c2c0e042420518_71.png)

然后ID进行挂接。

![](img/fe7c5eb11b15b90741c2c0e042420518_73.png)

那么这个步骤的话，其实大家已经很熟悉了。好，选择好我们要调试程序，关机上去以后用决D并报档。

![](img/fe7c5eb11b15b90741c2c0e042420518_75.png)

我这样一来调试基本操作就已经完成了。但是仅你是这样是还不还不够的，即也是这样还是不能够完美的把它调起来了。那么在像调试这种加不考的程序的话，我们要对调试器进行一些设置，选中这样一个deloger。

然后到os里面，我们选择suspen on这个意思的话，就是在一个程序它加载SO文件的时候给暂停下来。如果我们勾上这个选项的话，就能够在程序刚开始加载这个SO文件的时候，就能够停下来了。



![](img/fe7c5eb11b15b90741c2c0e042420518_77.png)

好，那么这个操作是重要的，我们选项这个选项确定。好跑起来。对，那么这里它突然蹦出一个错误，got signal try signal error。那么tra signal has change。

那么这个错误的话其实是可以白pass掉了。我们把这个错误的话呃直接忽略给返回给采去。这也是一样就行一些设置那个ation，然后ady。



![](img/fe7c5eb11b15b90741c2c0e042420518_79.png)

然后找到我们的is code is11，那么我们找到这个地方右键设置，然后改为一个pas to application。



![](img/fe7c5eb11b15b90741c2c0e042420518_81.png)

好，然后不用管它了，直接跑起来。然后这里还有其他的一些窗口先忽略，然后直接跳到当它开始加载这样1个SO文件的时候，就开始停下来了。那么这里就是我们想要找的找到的一个调试的一个入口点。

那整个程序已经开始加载这一个S文件，我们就可以开始进行一个分析了。找到我们考试S文件，是这里它会对应的这么多，对吧？跳过去的话，发现这里的数据全都是零，因为它还没有进行一个解码的。



![](img/fe7c5eb11b15b90741c2c0e042420518_83.png)

啊，我们再来开始分析吧。呃，在上两节课中已经说到一个link，它带载SO同时呢会调用到它的一个构造函数。那么这个构造函数的话，对应的就是在一个int函数，还有个inter阿的函数。

那么这两个函数的话都会优先被调用来让SO文件完成某一些初始的操作。那么很多加构可的SO文件的话，并在这个地方，或者说在这个地方来完成解可的一个操作。那么对于帮报这个的话就可以在这个函数来完成一个接可。

所以我们找到这个函数等口右口进行一个调试。好，走到这里。嗯。然后这里找到这里好12651，然后把它偏移，还有它的冷膜，加上它的一个模块机子，把它算出来。



![](img/fe7c5eb11b15b90741c2c0e042420518_85.png)

好后加上文花鸡子。好，那么这里就算出了它在一个内存中的这个函数的一个地址。好，在这里看一下它的一个末尾地址是5一。那么它跳过来的时候，自然就会切换到一个topub模式下。好我们选到50。

然后按tA添加区切换成一个top模式。慢拼好，我这样一来把就把这个地方给弄作一个函数，那么把断点设置好行一个调试抛弃。那么整个程序就断下来了哎，注意一下的话。

慢慢的话呢它对于这种软呃这种软断点节测施比较严格的。所以这样断下来以后，最好是马上把我们以前测置好的断点给取消掉。这样把它干掉。那么有兴趣的话可以在这里一步一步进对它进行跟踪。

主要是利用1个F7LF8来对对它进行跟踪，来看一下它是如何进行一个解码操作的。啊，由于这个这样解码的话呃难度比较高，那么我就不在这演示了，我就展示一个比较快速的一个呃脱脱口的一个方法。

我们来找找到我们的一个linker。

![](img/fe7c5eb11b15b90741c2c0e042420518_87.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_88.png)

好后上一节课已经上两节课已经说了，link可它在加载完le以后，会对它的一个过造函数进行一个调，就是对应着这个地方。好，那么这里整一个程序哎，我们现在的地方的话就是对这样1个IIT的一个函数进行了调。

就对应着这样一个地方。那么它返回的时候也是会返回到link中，然后继续的对这样一种IITR里来进行一个调的。那么我们既然已经知道了它这样1个IIT的话是一个初始化。那么我们就找到找到它的一个返回地址。

也就是在在在这里选中跳过去。

![](img/fe7c5eb11b15b90741c2c0e042420518_90.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_91.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_92.png)

那么这里在它反射的地方，哎，就是一个link的一个数据呢，在这里把断点给搜置好。

![](img/fe7c5eb11b15b90741c2c0e042420518_94.png)

然后就能够直直接的跳过对这样一个初始化函数的一步一步跟踪了。我们把这个地方给改回来，给这置好进行个调试。



![](img/fe7c5eb11b15b90741c2c0e042420518_96.png)

这是一个。呃，看一下是不是一个创上是2了。看一下L阿法它是1个CF，它是一个。这种形式的然后CF它应该上一个号，那么这里就是它一个。故造函数的反馈地址。

那么上一个是它调到我们的一个word造函数一个地方了。对吧这也就是跳转到它的一个初始化一个函数，然后下面就是就是进行一个返回的一个立方。我们在这里设置断点，然后进行一个执行。然后那么这么一来。

整一个程序就已经完成一个解码的一个操作了。我们也可以在这里跳过去的话，看一下它这些函数，哎，对吧？已经把所有的代码全部解析回来了。可以看到已经营业数据已经被填充上了。我在这里就可以可以在这个地方。

可以在这个地方这个呃link可中这样一个地方呢开始尝试去进行一个tocker。

![](img/fe7c5eb11b15b90741c2c0e042420518_98.png)

它下面的话还会有对它的1个IIT块的一个调用的。

![](img/fe7c5eb11b15b90741c2c0e042420518_100.png)

有幸呃在这里进行一个呃domeSO文件，或者说在这里进行一个dom也是可以的。好，那么那么我们在这里就慢慢走下去。



![](img/fe7c5eb11b15b90741c2c0e042420518_102.png)

来进行一个洞好。呃，往下跑。

![](img/fe7c5eb11b15b90741c2c0e042420518_104.png)

好好，准备退出了。好，既然到这里为这的话，我们就可以尝试对这样一个模块进行一个提取了。看一下它的机子，还有它的大小是这种样子的，我们就直接从内球中把这个地方给动出来。



![](img/fe7c5eb11b15b90741c2c0e042420518_106.png)

那么动的时候的话呃，还是用回上一次的一个脚本。脚本在在在在这个地方。

![](img/fe7c5eb11b15b90741c2c0e042420518_108.png)

当脚本在。找一下。

![](img/fe7c5eb11b15b90741c2c0e042420518_110.png)

嗯。好呃，波波本脚本在这里，我们直接用这个脚本来进行一个提取。

![](img/fe7c5eb11b15b90741c2c0e042420518_112.png)

这个样子的，然后它其实地址是1个755Z于。13000，然后它大小是32123。然后选择到么这一个位置，分正放到这个地方。是中涛，然后。



![](img/fe7c5eb11b15b90741c2c0e042420518_114.png)

把这样一个S完全给放出来运行脚本。那么这里就开始进行一个提取了。好，那么把所有信息都放到这个SO文件中。那我们稍等一会儿啊，等它会完成整1个呃S文件的提取好，那么这里已经跑完脚本。

那么这里就已经呃提取完了。

![](img/fe7c5eb11b15b90741c2c0e042420518_116.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_117.png)

那这一个就是我们刚提取完的1个SO文件，我们可以尝试用IDA来打开来看一下它的一个效果。

![](img/fe7c5eb11b15b90741c2c0e042420518_119.png)

好。

![](img/fe7c5eb11b15b90741c2c0e042420518_121.png)

呃，可以看一下，还没有修复之前的话，刚蹦出来数据是这像这种样子的呃，有效数据很少很少，对吧？那么这也就需要我们去对它完成一个修复了。



![](img/fe7c5eb11b15b90741c2c0e042420518_123.png)

主要是完成怎么样服务呢？第一步是完成一个内存对接的操作。第二个第二步则是把它的一个下损head的一个数据给补充回去。



![](img/fe7c5eb11b15b90741c2c0e042420518_125.png)

那证明我前面已经说过，link中它加载的时候是只会利用到一个program head来进行一个加载的。然后它筛选筛选head的话是不会被加载到内存中去的。所以我们动出来的数据的话。

是不会去包含它的一个呃筛选的一个数据的。

![](img/fe7c5eb11b15b90741c2c0e042420518_127.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_128.png)

并且它在program head进行加载的时候呢，它也会进行一一种内存上的一个对齐。也就是说它文件的一个拼移地址和它内存中的偏移地址是不会一一对应的。



![](img/fe7c5eb11b15b90741c2c0e042420518_130.png)

比如说在这里它的在文件中是18410的一个位置的话，那么映射到内存中的话就是1个30C10的一个位置。那么这这其中的一个偏移它中呢当中的那些数据的话，哎也是没有被对齐到。

我们因故此我们要对d出来的一个类存数据进行。让让这种SO文件进行一个修复的时候，得先要去把它的一个一个。



![](img/fe7c5eb11b15b90741c2c0e042420518_132.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_133.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_134.png)

他当中的一些数据来进行和内存对齐。那么这里的话也已经在这里，这个软件中已经有修复好了好，这里就是对应的第一第二个功能的话，就是就是可以对更出的SO文件来把它的一些内存进行一个对齐。

那么像88这脚架构壳的况，可以用第二种方法来进行一个修复。

![](img/fe7c5eb11b15b90741c2c0e042420518_136.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_137.png)

我们直接进行个修复。补充一下内存。

![](img/fe7c5eb11b15b90741c2c0e042420518_139.png)

那么这是我们支付的第一个版本，我们再来用IDA打开来看一下。

![](img/fe7c5eb11b15b90741c2c0e042420518_141.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_142.png)

嗯，像这种情况，希完以后打不开了哈。对于这为什么呢？哎，这因为它的数据段还是没有完全没修被修完。好，接着我们就来调用每个筛选机修复修复我腿原酸。



![](img/fe7c5eb11b15b90741c2c0e042420518_144.png)

![](img/fe7c5eb11b15b90741c2c0e042420518_145.png)

好，把它给拖到来，然后输缩。好，那么这么一来，一个最终的支付版本就到这里了。我们拖进去看一下。

![](img/fe7c5eb11b15b90741c2c0e042420518_147.png)

哎，对吧？那么这么一来，它里面所有数据都已经给切完了，就左边的这个是函数地址，然后右边的话是一个反变译窗口，可以看一下里面加过密的一些函数的话，都已经被完全解灭过了。



![](img/fe7c5eb11b15b90741c2c0e042420518_149.png)

那么这里通过这样一种修复的操作，就是对于这一个呃加过可加过密的1个SO函数的一个操作。那当然像这种这样这种修附过的一个SO文件的话，是不能够直接运用到一个加上面去的。

因为里面的里面的某一些区段啊一些内存的话，是没有进行一个对齐，没有进行一个补补补正的。呃，这大这大中的跨就涉及到1个SO文件脱口的问题了。因为脱口的话。需要的知识是非常非常多的。

那么这里的话就只是简单的介绍一下我们如何去达到一个分析的效果就完事了。好，那这题的话，这节课文内容的话就到此为止了。呃大概就说了这样么一种呃脱壳这样一种卸货的方法。



![](img/fe7c5eb11b15b90741c2c0e042420518_151.png)

那么对邦邦的这个可况嗯。

![](img/fe7c5eb11b15b90741c2c0e042420518_153.png)

还有其他非常多的坑，大家可以去尝试的去进行一个调试吧。特别是它的一个解渴解码的地方的话，有非常多对于调试的一个检测的一个机制。呃，这个是呃这去跟踪一下的话，应该是收收益应该挺大的。



![](img/fe7c5eb11b15b90741c2c0e042420518_155.png)

🎼那么这节课的内容的话就到此为止了，谢谢大家。

![](img/fe7c5eb11b15b90741c2c0e042420518_157.png)