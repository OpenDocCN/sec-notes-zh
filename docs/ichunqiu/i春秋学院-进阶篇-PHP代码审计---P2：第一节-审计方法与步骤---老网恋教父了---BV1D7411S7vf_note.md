# 🕵️‍♂️ i春秋学院 进阶篇 PHP代码审计 - P2：第一节 审计方法与步骤

在本节课中，我们将要学习PHP代码审计的核心方法与标准步骤。掌握这些“套路”能帮助我们在审计过程中事半功倍，更高效地发现潜在的安全漏洞。

## 📋 审计前的准备

上一节我们介绍了代码审计的重要性，本节中我们来看看如何为审计工作做好准备。没有充分的准备，审计工作将难以开展。

**以下是审计前必须完成的准备工作：**

1.  **获取源码**：没有源代码，就无法开展代码审计工作。
2.  **本地搭建环境**：在本地搭建运行环境，以便于一边审计一边调试。如果不进行调试，很难真正定位到可利用的漏洞点。
3.  **把握大局**：审计代码不是拿到源码就直接阅读。我们需要对网站有一个整体的了解，理解其程序结构。

那么，如何把握大局呢？

**以下是把握大局的具体方法：**

*   **查看源码文件夹**：通过分析程序的大致目录，了解其包含哪些文件，初步判断它具备哪些功能。
*   **找到入口文件**：通常入口文件是 `index.php`。通过阅读入口文件，可以了解程序的架构、执行流程以及包含的配置。
*   **阅读配置文件**：配置文件通常是 `config.php`。通过阅读它可以获得数据库连接等关键信息。
*   **阅读公共函数文件**：重点是查看其中的过滤功能，当然其他功能也需要了解。

我们来看一个具体的例子，分析一个网站的结构。

![](img/0d79bb0985a895b2f5728fa1c5ebabb5_1.png)

![](img/0d79bb0985a895b2f5728fa1c5ebabb5_1.png)

网站的源码根目录下通常有几个重要文件夹：
*   `admin`：后台管理目录，包含管理员功能。
*   `install`：网站的安装功能目录，其中的 `install.sql` 通常是数据库结构信息。
*   `inc`：此文件夹内通常包含 `config.php`（配置信息）和 `lib.inc.php`（公共函数库），需要重点阅读这两个文件。
*   `user`：用户相关操作目录。

接下来，入口文件 `index.php` 是审计的起点。我们需要阅读 `index.php`、`config.php` 和 `lib.inc.php` 这几个核心文件。

首先看 `index.php`，它一开始就包含了两个文件：一个配置文件和另一个头文件。包含这两个文件后，开始分派整体逻辑。首先是判断是否存在某个模块，存在则包含它，不存在则显示一些基本信息。这就是入口文件的作用。

然后我们去看它的 `config.php` 文件。第三行是关闭错误报告，使得网站浏览时不显示错误信息。第二部分判断是否存在锁文件，如果不存在则跳转到安装文件进行初始化安装。接下来包含 `lib.inc.php` 文件，即公共函数库。之后是数据库信息配置：连接数据库、设置字符集、选择数据库。最后是开启 `session`，因为登录等功能都需要 `session`。

接下来看 `lib.inc.php` 文件。首先是设定时区。然后判断是否开启 `GPC`（魔术引号），如果未开启，则自己实现 `GPC` 的功能，即通过调用 `addslashes()` 函数进行自动转义。因为 `$_FILES` 这部分不属于 `GPC`，所以不管开没开 `GPC` 都要进行转义。这是一个基础的过滤功能。

我们还看到 `sql()` 这个函数，它的作用是过滤 SQL 语句中的一些敏感字符串，防止注入。`getIP()` 函数顾名思义是获取客户端 IP。`clean_input()` 也是一个过滤函数，用于净化输入。`is_image()` 函数通过判断后缀名来确定是否是图片文件，有这个函数说明源码必定有上传图片的功能，很可能是上传头像等。`not_find()` 函数则简单地输出一些 404 错误信息。

在阅读完这三个关键文件后，就可以根据程序的业务逻辑，真正开始审计具体的功能代码了。

![](img/0d79bb0985a895b2f5728fa1c5ebabb5_3.png)

![](img/0d79bb0985a895b2f5728fa1c5ebabb5_3.png)

把握大局是一个必要的步骤，也是审计的前提。只有把握了大局，才能更好地进行后续审计。

## 🔍 审计方法（审计套路）

在做好了前期准备并把握了程序大局之后，我们就可以运用具体的审计方法来寻找漏洞了。主要的审计方法有三类：通读全文法、敏感函数参数回溯法、定向功能分析法。

**首先我们来看通读全文法。**

通读全文法特别麻烦，但又是最全面的审计方法。对于大型程序来说，面对成千上万行的源码，很难完整读完，读起来也比较凌乱。但是这种方法非常有用，因为只有了解整个应用的业务逻辑，才能挖掘到更多更有价值的漏洞。通读全文法可以从细节上全面了解这套源码。这种方法一般是企业对自身产品进行审计时采用。当然，对于小型应用，我们也可以将其通读一遍，毕竟源码量较少。我们前面所说的“把握大局”，其实也是通读全文法的一部分。

**接下来是敏感函数参数回溯法。**

这个方法就是根据敏感的函数，逆向追踪其参数传递过程的一种审计方法。这种方法很高效，也很常用，因为大多数漏洞的产生，都是由于函数使用不当导致的。我们需要去找到这些有“特性”的函数。我们可以通过阅读官方文档，了解这些函数的用法，以及哪些错误用法会导致漏洞。在这方面，有一些工具（如 Seay 源代码审计系统）主要利用正则表达式去匹配一些高危函数和关键字。这种方法属于静态源码审计，但误报率比较高，我个人不推荐完全依赖这种方法。网上也有较多类似的审计工具。无论如何，了解这些函数本身是必要的，只有了解它们，才能利用好这个方法。

**接下来是比较重要的定向功能分析法。**

我认为许多高手其实都在使用这种方法。这个方法就是根据程序的业务逻辑、业务功能来审计一套源码。一个网站程序必定有相应的业务逻辑，比如文件管理、用户安装、登录认证、权限管理、数据库备份恢复等。我们要找到相关的功能，然后根据这些功能推测它可能存在哪些漏洞。这些功能性漏洞是经验总结出来的，在实现相关功能的代码中，开发人员的疏忽可能导致特定类型的漏洞。我们需要去分析代码，判断这些漏洞是否存在。审计方法最主要的就是这种定向功能分析法。

最后，是我个人总结的代码审计套路。

**以下是代码审计的标准步骤：**

1.  **把握大局**：无论面对什么样的网站程序，首先要把握大局，了解网站的整体结构和信息。
2.  **选择方法**：根据程序规模（大型/小型）选择是否采用通读全文法。小型程序代码量少，可以通读。
3.  **功能定向分析**：分析程序有哪些功能（如登录、上传、搜索等），然后去阅读相关功能的实现代码进行审计。
4.  **敏感函数回溯**：在功能代码中，寻找相关的敏感函数，检查这些函数的使用是否正确。因此，审计的最终落脚点常常是敏感函数参数回溯。

所以，完整的审计套路可以概括为：**把握大局 -> 功能定向 -> 敏感函数参数回溯**。

## 📝 总结

本节课中，我们一起学习了PHP代码审计前的准备工作与三种核心的审计方法。我们了解到，审计前必须获取源码、搭建环境并把握程序大局。审计时，可以根据情况选择通读全文、追踪敏感函数参数或针对特定业务功能进行分析。最终，一个高效的审计流程通常遵循“把握大局、功能定向、敏感函数回溯”的步骤。掌握这些方法，将为你的代码审计之路打下坚实的基础。

本节课到此结束。谢谢大家的观看。😊

![](img/0d79bb0985a895b2f5728fa1c5ebabb5_5.png)

![](img/0d79bb0985a895b2f5728fa1c5ebabb5_5.png)