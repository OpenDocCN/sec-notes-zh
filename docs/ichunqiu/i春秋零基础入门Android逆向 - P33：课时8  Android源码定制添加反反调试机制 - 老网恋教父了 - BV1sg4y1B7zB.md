# i春秋零基础入门Android逆向 - P33：课时8  Android源码定制添加反反调试机制 - 老网恋教父了 - BV1sg4y1B7zB

🎼。

![](img/5cd985d13ae587f697c0b10e27029da1_1.png)

![](img/5cd985d13ae587f697c0b10e27029da1_2.png)

啊，好的，呃，大家好，我是蒋石爱邦。那么今天的话我们就来讲一下，我们应该如何对一个安卓源码进行一个定制来添加一个百一个软件的调试的一个功能。啊，我们那么我们就先来回顾一下上一节课中所讲到过的一个调试。

一个反调试的一个方法。呃，首先第一个的话就是对一个文件系统的一个监测。一般的话一些反调式都会监测到一个啊结合工具结合工具。啊，他们都会检测两个文件，一个是一个tus文件和另外一个是GATT文件。

那么这几个文件的话都是位于在一个ces一个目录下面的。那么通过检测这两个文件中的一个PID一个ID的一个的一个位置，或者说检测当中的一个进程的一个状态，就能够获取到当前进程中的一个调试的信息。

那么通通过获取这样一个调试信息，哎就能够知道这一个进程到底有没有处于一个调试状态之中了。那么这节课我们就来讲一下如何的去把这一种调试给去掉。呃，实际上我们要去到的话也是非常简单的。那么既然已经知道了。

我们要呃这个调试都是通过检测这两个文件来进行的。那么我们是只需要找到整个安卓系统，它生成这两个文件的地方，哎，就能够过掉它的一个检测了。那么鉴于这一个两个文件的话，在linux上也有。

就可以知道其实这两个文件的话，是通过一个linkux上的内核中的一个处理，给写到一个文件信息上去的。所以这节课的话，我们要修改内容的话，就对应的我们的一个内核，我们来看一下。



![](img/5cd985d13ae587f697c0b10e27029da1_4.png)

呃，正如我前面所讲到过的一个安卓系安卓系统编译一样，整一个安卓系统的话，它编译分两个部分。第一个就是内核上的编译。当然这一步话不做也没有什么关系。那么另外一步的话则是一个安卓系统本身的一个呃编译。好。

那么这里我们由于我们要修改的是内核，我们就需要打开我们的一个内核。如果说呃前面编辑的时候，把内核这一块呃忽略了，没有进行下载的话，那么到这节这一节课的话，希望大家能够呃自己去下一个，然后进行一个编译。

好，我们来看一下。我们找到一个内核文件之中呢话唉就看了一下这里有这么多的代码。那么我们首先就把这些代码给导入程序中来进行个分析。然后。



![](img/5cd985d13ae587f697c0b10e27029da1_6.png)

在找到我们想要找的一个呃。怎样找到了一个地方。那么这里我们就随便找一款一个呃编程的一个工具打开就可以了。那么这里的话我就选择了这样1个IDEA来作为这样1个CI来作为一个编写工具。

那么建议在编团这的一个代码编写工具的话有不少啊，是比较优秀的一个部助手。那么如果大家是喜欢用1个E些IPSE的那款老老工具的话，呃也是可以的。

那么这里的话我就使用这样一个GIB里面的一个Cline来进行一个编写。那么首先就是把一个代码的一个导入。那么这里呃这款工具来导入源码也非常简单。

直接把一个发译 from source来直接把整一个源码给导进去可以了。那么这里的话我就把整一套呃内核上代码已些导入改过来。可以看一下，在内核这一方面的话呃是有比较多的一个地方的。

是有比较多的一个东西的。那么这个内核结构的话和另ux上是比较类似的对吧？那些工具啊，还有什么相应的一个地方。那么这里我们就来定位到一个啊对于这样proces系统进行读写的一个部分。

那么proces系统的话就在这个地方啊，在一个FS，然后一个PROC目录下话就能够呃找到我们的一个人件系统。啊，就这里那么这个文件夹里面的话，就存放着它程序运行的时候，对于这样一个目录下的文件读写。

那么所有相关存程序的话，都可以在这个里面可以找得到。

![](img/5cd985d13ae587f697c0b10e27029da1_8.png)

![](img/5cd985d13ae587f697c0b10e27029da1_9.png)

好，那么今天早到的话，我们就在这里对这个frs的一个目录下来进行一个分析，来看一下它是怎么完成。对于一个程序的一个读写的。好，那么这里我们切到另外一个ft项目。

那么这里我就把整一个f项目给导到这样一个程序里面去了。那么另外这里的话有一些图文件包含的话，顺便配置一下包含的一个目录。单单的话，这里的喜欢的话也可以使通过一个软转链接来达到一个文件包含的这种。

那么建于这个程序的话是使用一个c make来进行一个链接的。好，我们把整一个for写的一个程序给导进来，然后顺便把图文件给包含起来。然后就可以开始去进行个分析了。那么大致的浏览一下话。

或大概是呃这么多的一个东西，对吧？然后里面的画更文件更包含。那么有兴趣的话，自己可以自身自己去看一下。那这些其要的话也是比较明显的哈。也是挺好挺清晰的，我们就来开始进行一个。啊，修改进行一个阅读。

我们首先找到这样一个base，然后点C的一个文件。那么这个话基本上算是包含了所有操作的一个入口啊，里面对应的每一个信号，然后对的哪一些操作的话，都可以在这样一个文件中来找到对应的一个实现。呃。

就是在这个地方。好，我们可以在这样一个base点H里面找到它对应的文件的一个实现。一些文件系统啊，比如说要读写一个com line的话，都可以在这里找到相应的一个方法。

比如说这样1个cD line对应的一个实现方法，哎跳转过来的话，就可以看到这个位置。嗯，这都是一些呃网他文件系统写信息的一个时间。那么我们就在这里看一下，找到我们想要找到一个s系统。

就是这个地方我们找到这里。就行一个搜索。那那么这里就是对我们的一个state文件进行读显的一个地方。好，找到它之后，我们就跳转过去，跳到这个函数里员。这一个意思就是说对于这个文件的话。

哎就使用这个方法来进行一个协入。好，我们跳过去看一下。嗯。这里的话对着是一个status文件。那么不知道大家还记不记得sstateatus文件里面的数据是怎么一回事了啊？呃，这里的话就给大家来看一下。

再来复习遍这个tatus文件数据格式。

![](img/5cd985d13ae587f697c0b10e27029da1_11.png)

好后把它下。

![](img/5cd985d13ae587f697c0b10e27029da1_13.png)

好，我们进入到pros软件系统里面，然后看到里面的话有非常多的一个呃东西，对吧？然后我们找到随便找到1个process的1个PID。比如说我们要寻找我们C10的1个呃proces。



![](img/5cd985d13ae587f697c0b10e27029da1_15.png)

然后里面就有一个sstateus的一个文件。那么这个文件哎这个文件我们看一下它的一个数据。

![](img/5cd985d13ae587f697c0b10e27029da1_17.png)

好，是这种样子的。是这种样子的。首先第一个是一个名称。

![](img/5cd985d13ae587f697c0b10e27029da1_19.png)

首先第一个是名称，然后接接着是它目前的一个状态，还有它的1个PID的值和它paronPID的值。接着是它的一个调试器的PID值，然后下面就是以它它的一个用用户组ID，还有它的一个group IDD。好。

那么下面的话就是一些其他的一些啊投票一些数据之类的。好，那么这个sta系统的话，这个s文件里面存放的就是当前一个程序的一个信息。那么在这个函数里面，就能够找到相应的一个实现。我来看一下。

首先是获取到这样一个M structure的一个结构体。那么结个这个结构体里面，它以存放着当前进程的一些呃信息了。



![](img/5cd985d13ae587f697c0b10e27029da1_21.png)

![](img/5cd985d13ae587f697c0b10e27029da1_22.png)

![](img/5cd985d13ae587f697c0b10e27029da1_23.png)

接着在下面的话就开始去对一个文件进行一个写信息。来，慢慢来看一下，首先它第一个就是一个啊它的一个名称啊，那么它就会首先这个这样一个呃程序来写个它的名称。哎，这里就开始开始文件了，先写一个lamb过去。

然后接着把链写完以后呢，就把一个正常的名称给写上去了。那下面就开始从这个结构体中取出它的名称，然后把一个字节码给写上去。最后把画行符给弄上去哎。



![](img/5cd985d13ae587f697c0b10e27029da1_25.png)

またり。

![](img/5cd985d13ae587f697c0b10e27029da1_27.png)

这是一个tuch length的一个操作。好，接着就把它的一个state状态，就是这样一个st状态给写过去。那么注意一下这个状态。如果处于调试调试过程中的话，它就可以写一个tra store的状态过去。

通过检测这个状态的话，就能够知道这一个程序，正处于一个单步调试的过程中。哎，我们再来看一下这样一个tra store，我们再再看一下它是怎么样，把我们的一个try数据给写过去了。跳过去看一下。啊。

首先首先啊通过获取它的PID还有PPID的值，然后开始进入一些哎把这上面的必要数据给写完以后，开始就去写它的一个状态属性了。首先这里的话就利用这样一个s print来进行文件的一个写用。

然后上面就是这堆东西就是进行一个格式化的一个地方来对比一下state然后PIDPIDPPID和穿始PIDVID以及GID哎，它就会通过把这一些文件的数据给写进去来达到一个值。



![](img/5cd985d13ae587f697c0b10e27029da1_29.png)

既然是格式化，那么我们就来看一下这样的格式化中，它是输入哪些数据。首先第一个se话，它就对应着第一个函数哎，这样一个getta data里面的反热值来进行一个s的一个写用的。

我们跳过去看一下它是怎么写这样一个seters的。

![](img/5cd985d13ae587f697c0b10e27029da1_31.png)

好，首先它通过传递这样一个结构中，接着哎通过判断这个结构的信息，然后从这样一个ts阿比中的一个数据给取出它的一个值。我们这样的个ts data阿比到底是什么呢？对吧？哎。

下面就通过一个便例来取出它的一个属性了。我们回头看一下这样一个task阿比里面存放什么数据，哎，开过去看一下的话，就会发现。这个tas二的话，实际上就是存在着所有可能的状态，所有可能被执行的一个状态。

比如说正处于一个关暖的状态，sle的状态，还有一个ds之类的一些状态都会有，甚至还有一些另外上其他状态。比如说比还有d的一个状态。这都是通过这样一个ta二中的值给取出来，然后写到这样一个数据中去的。

那么在这里对着四和8这两个位置，本来是一个T，原来是一个小T，还有一个大T的一个状态。那么在这里的话已经被我给改写过了。



![](img/5cd985d13ae587f697c0b10e27029da1_33.png)

![](img/5cd985d13ae587f697c0b10e27029da1_34.png)

啊，可以在这里看一下他的改写之，改写之前是什么样子的。好，我们。我们看一下被我改过之前怎么样子的。

![](img/5cd985d13ae587f697c0b10e27029da1_36.png)

对吧呃，在这里被我修改之前的话，它哎这里我把它修改两个都修改S。然后它修改之前的话，实际上是对应着的一个大T，还有一个小T，大T时候就呃标明着一个stockt的一个情况。

那么小T的时候是一个trat的一个状态。好，那么大家注意一下来，想把这样一个state数据中的一个状态中，把这两个T改掉的话。

只需要把这样一个tastate二中的一个4号8中对应的一个两个数组的数据给改掉就完事了。

![](img/5cd985d13ae587f697c0b10e27029da1_38.png)

这就是把这样两个T的一个数据给改成一个爱斯培好，这是啊第一步修改。这是第步修改。好。呃修改点之一啊我们来看一下这里，把后这样一个t个修改完以后话，那么下面的话，无论是处于调试状态。

还是处于正常的一个运行状态，都会把生一个S的一个状态了。好那这里的一个ter也就。接着我们还需要注意的地方就是这样一个tPID的一个值。这个它通常通常是一个检测复一个正在调试进程的一个状态。

由于在这里的话，我们不好修直接修改这样1个TPID所以这里的话就直接的以用一个零用一个零来代替它来进行个格式化进去，那么这样一来，就不管我们是不是正处于一个调试状态，都能够达到一个。啊。

无没有办法检测出一个调试的1个PID值的一个效果。

![](img/5cd985d13ae587f697c0b10e27029da1_40.png)

好，我这么一来的话，对于这样一个state的一个数据，对这样一个state的一个文件的修改就已经完成了。接下来还有这样1个STAT那个文件的一个修改。



![](img/5cd985d13ae587f697c0b10e27029da1_42.png)

我们再来看一下这样1个SATATK的一个文件。好，保回到上一个目录。好，这t data，然后party state的一个数据。这是对应着SJTS的。那么下面可以看到还有另外一个文件。

就是这样一个啊stateta文件。那么SJATT文件的话就是对应着我们的啊这个东西。

![](img/5cd985d13ae587f697c0b10e27029da1_44.png)

在，里面在这里就存放了当前用户的属性的一个简短的描述符。这个这种形式和刚才data是一样的，只是更加容易容易被别人去阅读。我们就看一下它是怎么处理这个文件的。



![](img/5cd985d13ae587f697c0b10e27029da1_46.png)

好，拷贝过来来看一下它的一个数据。这里我们最主要修改一点的话，就是对于这样一个S的一个状态。这里如果处于调试过程中的话，是或者说处于一个调试停止的过程中的话，是一个小T，或者说是一个大T的一个情况的。

我们就要把这个小T和大T来改成一个S。我们来看一下它是怎么样取出这样一个数据的。

![](img/5cd985d13ae587f697c0b10e27029da1_48.png)

好，跳过去调转到这个函字中去。然，里面很里面比常简单，就调用了一个do task data一个函数。好那看一下，前面还是一样，先初始化一些值。比如说它当前的PID。

还有所有的GID还有还有它的 group的一个ID的一个属性把这些全部都初始化以后的话，就开始去进行一个写数据了。啊，那么上面的话就开始对一些数据进行一个处理。这就一步步一步步的把我们的所有数据。

包括当圈的数据啊，这一些全都开始写下去。好。把数据都获取完以后。读获选完以后就开始就进行一个写数据的一个地方了。首先。



![](img/5cd985d13ae587f697c0b10e27029da1_50.png)

首先我们来看一下他写到了哪一些数据啊，它第一个。一个值是一个当前ID值，然后第二个它是当前的名字，接着是当前的一个状态。好，我们来看一下对应的哪些地方。



![](img/5cd985d13ae587f697c0b10e27029da1_52.png)

好，当前IT值就在这里，然后当前名字哎就在这个地方。多拖是用。接着第三个话就是它当前的state状态了。好，这我们这已经找到了，它是把这样一个state的一个状态给这样直接呃写到文件中去。

我们再看一下这个state状态是在哪里被复制。跳过去看一下。好，可以看到直接通过这样这样一个getta data来获取的。啊，getta state的话也是我们刚才已经看到一个函数了。

它是反回这样一个taask data阿里里面的一个。对应的一个位置来通过获取的。接着这里。再看一下这是法还有一个字符串数轴。接着他在取求自由串数组里面的第一个数字，这里取一个C级。

就是取出这样一个数组里面的第一个位置啊。第一个位置是什么？就是前面的这几块东西。这几个就是它第一个位置的值，好就通过这样直接取出来，就把它的state状态给复制上去了。

所以刚才这里我们把这样一个呃T改成S的话，就已经把这样一个state的数据给改过来了。好。那么这里。

![](img/5cd985d13ae587f697c0b10e27029da1_54.png)

可这么一来的话，对这样一个贴线检测也就完事了。

![](img/5cd985d13ae587f697c0b10e27029da1_56.png)

好，么这里下面的话就对应着没有更改了。好。所以当你实际上要改的部分是比较少的。综合综合上来的话，大概就只有这几块。第一步就是把这样一个呃这样一个地图阿里中的一个t阿里中的一个属性。就是这几个属性。

把它T改成一个S，这是第一步修改。然后第二步修改的话，只是在它正在输入文件的一个PID里面，把这里的一个TBID给改成0，让它无论什么情况都只是写用0。那么通过这几个修改，就能够把它的一个。

检测对stateta还有s文AC文件检测都过掉了。

![](img/5cd985d13ae587f697c0b10e27029da1_58.png)

好，那么这是修改使用一点，这是第一点。老街着。哎，接着的话还有另外一个。一个地方的一个修改。那么这个修改的话啊，也是另外一种，应该是对应的另外一种检测吧。如果不常见，那这里就直接简略的体验一下来算了。



![](img/5cd985d13ae587f697c0b10e27029da1_60.png)

啊，这里的修改文件画一下这样一个被使用录像。好，我们找到。于这样一个base文件来进行一个修改。

![](img/5cd985d13ae587f697c0b10e27029da1_62.png)

嗯，这也就很简单，就对应着这样一个doup圈的一个属性中。呃，假如我在准备向d圈中写入这样一个try数据的时候，我们就把它全都给全都给写成这样一个数据。啊什么时候可以写入这样一个try数据呢？

是就是当程序处于一个调试状态的时候呢啊，就可以像这样一个文件系统来写入这样一正在去调试一个状态。那么在这里我们就把这样一个调试状态干掉，嗯就完事了。啊，这个位置位于1个285行。

这是处于大部圈的一个状态的。

![](img/5cd985d13ae587f697c0b10e27029da1_64.png)

我们找到285。哎，就这里在这里啊，这是一对一个do圈文件的一个修改。好，我们来看一下这个文件在哪。

![](img/5cd985d13ae587f697c0b10e27029da1_66.png)

好，我们来看一下啊。呃，本来呃看一下我们查看它的状态的时候，它平常状态下跨是这种状态的worker，对吧？还有一些其他的一种状态。假如它处于调试过程中的话。

那么这个圈里面的数据的话就可以变成一个串始数据。那么这个时候我们就把这样一个串数据给改写一下。

![](img/5cd985d13ae587f697c0b10e27029da1_68.png)

![](img/5cd985d13ae587f697c0b10e27029da1_69.png)

因为啊当前有一些程序的话，也有可能是通过对这里进行一个检测的。当然这个当然这个检测的话，在上一节这课中的话就没有讲到。那么这里的话就偶尔就想想就提示一下，我们回头来看一下它的一个引用。

我们来看一下这个倒它在哪里被调用到的。好，它是对这样一个d文件写用的时候，唉不用到了好。那么下面的话，大家就要注意一下，把这个文件也修改一下。那么假如以后以后遇到了啊。

或者说自己分析到了某些可对每一个文件来进行一个读取的时候，也可以在这里啊通过这样一个分析对内核文件来完成一个修改，来把pas掉它的一个检测。呃，也比如说360的话，它也会对一个端口进行一个检测。

这时候的话也会对一个端口文件进行一个修改。但这个并不建议。好，那么这就是啊这节课中想要讲到的一个修改的一个点。那么把这些修改完以后的话，就可以对一个内核进行一个重新的一个编译了。编译的时候的话。

就和我以前讲到过的一样。编译编的时候一切都按照。

![](img/5cd985d13ae587f697c0b10e27029da1_71.png)

以前讲过一样，先编译内核，接着再编辑一个系统，把这些都编译完以后就可以进行一个输入。输入的话，如果是不想一个全部给输入起来的话，可以直接这样来进行一个内核的一个刷新。那应该是这一条命令我没有试过。

大家可以去尝试一下。

![](img/5cd985d13ae587f697c0b10e27029da1_73.png)

![](img/5cd985d13ae587f697c0b10e27029da1_74.png)

好，那么刷案即时刷案机格的话，理论上是可以过掉大部分的一个软件的一个检测的。比如说一些360啊这些什么的。好，那这里我们就来尝试一下。把这个代码给全部设完地址以后，代码我们来看一下能不能过掉。

呃我上一节课所弄到的那个检测。

![](img/5cd985d13ae587f697c0b10e27029da1_76.png)

![](img/5cd985d13ae587f697c0b10e27029da1_77.png)

好，我们找回上一节课中啊，找到了一个程序，1个APC程序就是1个APK安装。

![](img/5cd985d13ae587f697c0b10e27029da1_79.png)

![](img/5cd985d13ae587f697c0b10e27029da1_80.png)

来进行一个调试。

![](img/5cd985d13ae587f697c0b10e27029da1_82.png)

![](img/5cd985d13ae587f697c0b10e27029da1_83.png)

![](img/5cd985d13ae587f697c0b10e27029da1_84.png)

好。呃，这样调试端口开起来，然后打开win壳。

![](img/5cd985d13ae587f697c0b10e27029da1_86.png)

然后进写一个调试。打开程序，我们来看一下它调试监控是不是已经没有办法给检测到我们的一个程序了。好，打开调试器，关窗绳。嗯，在在对对。后在这里。啊如这里呃他。但这也快要重新安装一遍才是唉。



![](img/5cd985d13ae587f697c0b10e27029da1_88.png)

![](img/5cd985d13ae587f697c0b10e27029da1_89.png)

那后现在重新进行一个安装。

![](img/5cd985d13ae587f697c0b10e27029da1_91.png)

然后我们再打开看一下。

![](img/5cd985d13ae587f697c0b10e27029da1_93.png)

哦，这已经SO已经打开了。那么现在目前我们已经处于一个加长位这样一个破的一个状态了。我们点击哎那时候它没有办法检测到我们的一个程序，我们再来进行一个挂介绍。



![](img/5cd985d13ae587f697c0b10e27029da1_95.png)

![](img/5cd985d13ae587f697c0b10e27029da1_96.png)

啊，把一个端口进行一个转包，然后进行一个挂接。

![](img/5cd985d13ae587f697c0b10e27029da1_98.png)

找到我们的目标程序。找到以后哎跑起来来看一下检测。对，这一次的话呃，它已经没有办法给检测到我的一个程序。我已经点最和完按钮了。那么大家在下面的话，也请尝试着自己去编一个内核出来。

然后把这样一个呃我上面所说说到的一个修改点给改一下，把这些东西全都给改一下来过掉它的一个检测。那么理论上这样的修改的话能够过市面上的C方式一个口，像360的话，应该是可以过掉了。那么大家可以尝试一下。

在修改完以后去调一下360的那个程序那个外壳。

![](img/5cd985d13ae587f697c0b10e27029da1_100.png)

🎼好，那么这节课的话就到此为止了，谢谢大家。

![](img/5cd985d13ae587f697c0b10e27029da1_102.png)