# i春秋零基础入门Android逆向 - P27：课时2 elf结构详解：动态运行库so文件的文件组成结构 - 老网恋教父了 - BV1sg4y1B7zB

🎼。

![](img/0e409b1fd8ee4973368b77288f17a021_1.png)

嗯，好的，呃，大家好，这里是0日安全论坛的安卓零基础稳定向论文培训教程。我是讲师爱8。那么今天我们来讲第26课。那么上一节课的话我们就来简单的去介绍过了一个脱壳的一个简单的步骤。那么从理论上来说的话。

那么这节课应该是讲脱壳的第二课的。那实际上在进行下一步的一个脱壳之前，我们可以看到会有一些新的阻碍，可以就出现在我我们的一个面前。呃，不知道大家有没有尝试过利用上一节课所说到的一些方法，还有技巧的话。

去尝试着去脱一些比较新版的一个课。那么今天我提供了这样一个样本来看一下这些新新版的课，有一些什么样的一个喂样啊。因为这些新的口话都会有一些不一样的不同的一个比较新的一个加密方法。

导致我们比较老的一个方法给分使用了。我们来看一下啊今天的今天的这个样本。首先来分析一下一个这样一个SML。



![](img/0e409b1fd8ee4973368b77288f17a021_3.png)

一个标签，它的min main face标签。看一下它的一个application的一个入口点。好，那么这里哎它还是一样替换了这样一个 application的一个一个入口点。

然后在这里来执行一个S文件的一个呃释放。还有说将再这样一个S文件还原一个des文件。那么简单的去看一下它的一个东西吧。来看一下这里它的一个一个入口点，是这样一个接口点U来。

然后一个top application的证明这是一个使用一个360加酷宝来进行加格保护的一款APK。我们来看一下它的这一个入口点是怎么一回事。嗯那么大致的取暖一下它的一个操作，看一下，哎。

它的第一步入口点肯定是在一个attach base contest的。那么这里它会首先的对于我们的一个运行版本进行一个判断是arm的是64倍的，还是一个叉86的，还或者说是一个叉64的。

如果哎是1个332位的话，如果然后哎就是这这样的一些判断了。那么这里它实际上的操作的话，就是根据我们的运行的一个机器的一个版本来加载相应的1个S文件。来看一下。假如是1个ART模式下的1个322位的话。

就可加载这样1个S文件。如果是DVI模式的话，哎，就可加载这样一个文件了。好，那么这里我们就来看一下我们的这样一个要被加载的这样一个目标文件吧。那么这里由于我们是1个DVI模式下的话。

应该找到这样一个SO文件的。如果CRT的话，就请大家找到相应的一个文件吧，直接拖到1个IDA中进行一个分析。我们来看一下。



![](img/0e409b1fd8ee4973368b77288f17a021_5.png)

哎，可以看到这里IDAIDA中提示它已经分析完成了，但是左边的这一块可以看到这个分析winle里面的分数量里面，这栏是空的，然后右边的反面窗口大致的看一下话会发现这里全都是分析为一个数据。哎。

全都是一个数据，这里就表明了IDA把这个SS文件识别为在普通的一个二定制文件嘛。看一下这样的一种情况哎，连正常分析和分析都不能够完成一个分析，就更加不要停如话对它进行一个脱壳。

那么这就涉及涉及到一个问题了，像这一种加固加壳的软件是如何的去对1个SO文件来进行一个保护的呢？所以呃从今天开始就来打算呢来用节课的时间来讲一下一个ESO文件的一个修复，还有它的一个保护。



![](img/0e409b1fd8ee4973368b77288f17a021_7.png)

![](img/0e409b1fd8ee4973368b77288f17a021_8.png)

那么这是这几节课的一个内容。

![](img/0e409b1fd8ee4973368b77288f17a021_10.png)

我们来看一下吧，呃像这样一种S文件的话，它都是linkux上的来自linux上的1个ERF的一个文件。它的几个结构呢也是一个类似的一个情况的。呃，不相信的话也可以。不相限可以用一个石有进制文件。

用一个石有进制工具来打开一个S文件行一个分析。我这里我们就我们就用一个没有被加密过的一个S文件来看一下它的一个内容吧。打开这样一个比较小的S文件，这里可以自己编译个出来。

那么看一下它前四个视节是一个非常明显的一个me number，对吧？1个CF开头，接着是1个ELF3个呃3个英文。这表明了它是1个ERF格式的一个文件。呃，所有的SO的话都是这样一款软件的。哎。

那么今天呃第一节课作为ERF识别结构讲起的第一节课呢，我们就来说一下整1个ELF上的一个格式吧。首先嗯安卓的一个这样一个S文件的话，它是来自于linina上的一个动态链接库的。那么它的一个结构啊。

还有说一些文件的一个标志类类型之类的也是相通的。所以这里可以直接的去看一下linina上相关的一个说明也是一样的。那么这里我们就来看一下，对于这样一种新，我们就来学一下这样1个ELF的格式。嗯。

像像比如说我们这里要学习一种新的格式的话，最好还是拖到这样1个0010中，然后打开一个模板来跑一下，来看一下它的一些数据才取的。那么这里就选择1个EF的一个模板，然后进行运行。

可以看到这里分析已经出来了。哎，可以看到这有4个header table，第一个是1个EF header，然后第二个是一个propro header，然后然后第三个呢是一个session header。

最后一个是一个呃ever simple head table。那我们就来看一下这是个头是什么东西，它们为什么哎就这么重要呢？那么先来大致的来说一下整1个EIF格式的一个总览吧。首先整1个SO文件。

也就是1个ERF文件的话，它是分分成两种视图的。第一种就是一个链接视图。呃，也就是我们平常可以看到的像这种视图，然后另外一种呢就是一个执行视图，也就是说它从内存中哎它把这样一个EO文件。

从一个呃存储设备中加载到内存中的时候，就可以完成这样一个链接视图到一个执行视图的一个转化。哎，这表面什么？就是它在加载前还有它加载后，它的一个结构呢是不一样的。

那么这就给一个加密呢提供了某某种程度上的一个方便的。可以看一下，本来它那个面的话是这种样子的一个EF头，然后下面是一个 head，然后下面的话就是选最后是个选 head。

然后选 head里面数据就指向的每一个不同的一个。这是它的一个链接视图，然后接着是它加载到内存中的一个执行视图，也就是这样一个ex，可以看到里面就有一个EI head，然后是一个 head。

下面的话就是几个s文了。然后后面的一个 table，这里虽然已经写出来。但实际上这个表是不会被加载到内存中去的。

那么可以看一下它从一个链接视图到转换为这样一个执行视图里面的话会会产生了一种s文的一个合并。也也就是说这里多个session会合并到一个s文中去。

具体来说的话就是把它的一个标志为相同的一个session给合并到同一个s文中去来加快它的一个加载的一个速度了。哎，那么这些问题就来了，为什么会存在这样两种的视图呢？对吧？为什么会存在这两种视图？

那么下面我们就来详细的去讲解一下。对于这样1个EELF文件话里面存在三个常重要的一个口，第一个是1个EF。然后第二个是pro。然后第三个就是一个选link话就根据这三个图信息来进行一个文件的一个加载。

首先第一个是1个ELF的一个er。那么这里就存储的一个S文件最基本的一个信息。比如说它运行的1个CPU平台。然后它的一个版本，接着是它的一个光转开的人的一个数量，还有它的偏移地址。

还连接着是它的一个s选headle的一个数量偏移地址。那么它的一个作用的话，哎，用DEX文件来说的话，就是相当于一个dash head的一个情况。那么下面下一个就是一个s。

那么这个的话就存储了一个S文件对的一个链接用信息。比如说哎它可存储第几行，对于对于哪一个函数，它什么位置，然后它的长度是对多少并源码是哪个位置。那么IDA像ID那种分尽量分析工具的话。

就是通过读取这样一个同步信息来进行一个S文件的一个数据分析的。那么在下一个的话就是一个program。那么这个东西的话就是存储在S文件它运行时候所需要的一个信息。

这些信息的话会直接直接的去被link进行一个使用。然后运用到一个S文件加载上面去的。好，那么这里直接说的话可能比较呃比较不清晰。我们就来看一下它的具体的一个实现吧。我们这里先来对这个SO文件。

这个没有加密或者或的SO文件来完成一个大致的一个分析了。那么这里我们可以借助一下lin上的一个readDF的工具。这个工具的话，在前面几节课中已经有接绍C操作了。它是lin上新定的一个软件。好。

用法是这个样子的。好，我们只序直接进行一个使用。不好。我们把它的被EERF的信息分析全部输出到1个TST中，然后打开它来看一下整个ERF工具存储的哪一些信息。



![](img/0e409b1fd8ee4973368b77288f17a021_12.png)

好，第一个至于我前面所说的第一个是1个ERF的1个header。对应成这也就是这一个数据啊，对应着1Iipad的地段是一个I等的一个数据。里面的话就存储了哎它的一个me number。

然后它对应的car是1个32位的文件，那其他的还有1个64位的文件呢，因后它的一个日日期，然后它的的一个版本可以运行在1个API的一个地方。

比如说这里是1个AIM它能够运行在AIM平台上的那么这些东西overhead的一个起始位置，然后它的一个大小。还有，偏移地址对啊，开偏移地址，还有下水headd的的一个偏移地址。

下选headd的一个大小，还有它的数量。这些东西的话都会在这一个Eipad中得得到一个存储进行一个保存。那么这几个则是最为基本的一些信息，这就是一个E的一个地方。

它重要信的就相当当于一个des从这里就指出了另外两个head另外两个头的一个P地址。也就引出了另外两个头的一个信息的。好，那么第二个就是一个选 head。

那么刚才我已经说过了ID的话是利用在一个选 head一个数据来进行一个S文件的一个分析了。我们可以尝试着把这一个S文件给拖到ID中进行一个分析。好那么这里有于没有加密过，已经正常的分析完成了。

按ctl加S打开一个s文还可以看到这里的一个sment和这里的一个下选下选 head是一一对应的。比如说哎这里看到一个IIER就对应着这样一个段了，其实地址是这样一个样子。然后结尾是这样。

然后它访问标志位唉是这个东西的。然后是一个FII那么这里就对应着SO文件，它呃在启动的时候初进行初始化的几个函数，还有它构的时候对应的几个函数。还有另外就是一些其他的一个table了。

对吧这里就是它的一个test的一个table，就是它的一些函数的一个地方。那么这里唉这里这里还有一些其他的数据的话，就不详细说了。总而言之的话。

IDA就是通过读取这样一个头信息来获取整个SO文件的一个分析的我文来展开。随便展开一个图来看一下的话，它里面每一个图的数据都非常的简单。就是呃这里就是整这里的每一个筛选的话，都可以对应着一个偏移地址。

然后它的一个呃，比如说它文件文件中的配移地址，还有它内存中的偏移地址，以及它的一个大小。那么这里的一个每一个筛选的话，都可以有这样一个指向。

那这里就把整个S文件块分成了这样一个2方分成这样连26个session呢。好，比如说这里我们就以这样一个sction来进行一个举例吧。我们看一下它的，也就是它的一个呃偏移地址，它这里就说了。

在文件配移地址为80C对吧？然后它大小为833的这一段数据呢，它就对应着这样一个train tabletable的一个属性的一个s吧，是这样一个表，我们转到这个地方。

看一下它的一个str是怎么一个样子的。那么转过去看一下。好，从这里开始可以看到哎，这里从概这里开始的话，就是一些存储一个字符串数据的一个地方了。这也是这样一个s选的一个表的一个作用。

它就是把整个S文件给分成多个sction。嗯，那么这么多s选它对应着不一样的一个类型，那么里面的作用也就当然不一样了。比如说这里就是存放一个字符创信息的一个s选。

然后这里的DISSYN的话就是存储一个函数的一个session。那么下面对应着就是就是存储一个从定位信息的一个表。我通过这么多信息来组成一一个可以让静态文静态分析工具所分析的一个咨询table。啊。

那么这里这一个就是一个session table的一个作。好。s选headtable这种对应的就是这里的，可以看到对吧？筛选一，然后筛选N都是由筛选筛选黑 head table来指向的。好。

那么这里就是一个session header。那么下一个哎就是一个program program的一个header。这里我前面都所说到呢。

link的话就是通过读取这样一个program header来进行一个加杂的。可以看到话它里面的数据呃和s head的话也是一样，也是比较简单的。它同样也是把整个S文件给分成不同的一个sg文段。

对吧比如说它的一个类型，还有它的内存中的一个偏移，然后是一个文件，文件中的偏移，还有文件中的大小以及内存中的一个大小。这都是一个对应的一个加载以后的一个信息。特别是这两个漏的区段的话。

那么link可就可以根据这两个漏的区段中的一个偏移的信息，来把整一个S文件给加载进去。看一下它的这两个路路去状的话，是包含前面前面的head，以及后面的一个一个地址的。

那么它两个之间来理论上它两个之间所存储的一个信息呢是一个等价的。来从可以看一下下面的一个映射表中，已经看到了表这里有一个从00到0899行数据，这九行数据代表什么呢？那么这九行数据的话。

就和我们前面的九行的一个pro head是息对应着这里每一个pro的话，每一行是指向一个second一个段。然后下面的话就指明了哪哪一个筛选给映射到哪个段中去了。比如说01这个段也就是这个段的话。

整个segment就有这样一个筛选table给映射过去。然后02就是这样一个loader load的一个sgament中了，这会有这么多的一个筛选的一个数据给映射过去了。

03对应的这里哎就会有一个哎就会有这些数据给映射过来。那们这里一个f head，还有一个session head的话是一一对应，然后是一个映射的一个关系。

这里大致上来说就是把一个标志位相同的一个sction head给映射到同一个f head中去了。然后加载的时候直接根据这样一个呃标志位哎这样一个东西来进行一个加载，可以提升它的一个d的一个速度。呃。

由于那么这就导致了它存在两种视图。对吧第一种就是利用1个Eip，还有它的一个s选 head组成的一个链接视图。另外一个就是一个EF head加上它的一个program head来组成的一个呃执行视图。

然后它从文件中加载到那内程中的时候，就可以把这些选给映射到一个段中去，这些段的话是由program head来指向的。然后像前面的筛选前面的s选段的话就是有一个s选 head来一一指向的。

他们都是把内存中中的数据给指向出来，他们代表的信息哎也是一样的。只是分析起来哎，他们分析起来取出来数据的方法是不一样的。是不一样的。那么前面说了这么多，可能对还会有有点不一不应吧，对吧？

比如说这里哪一个sgament的一个下水head，哎，可能已经说明白了。对吧但是呃这里的一个对应对应的这样一个program可能还说不太清楚。好，那么这里我们就来看一下这样一个program。

也就是说它的内存中已经执行起来以后，它的一个内存视图是什么样子的。我们尝试着从一个内存中进行一个加载吧。

那么这里我们就从呃就利用通过把内存中把这样一个SO文件的信息给动出来的方法来获取这样一个执行视图吧。

![](img/0e409b1fd8ee4973368b77288f17a021_14.png)

![](img/0e409b1fd8ee4973368b77288f17a021_15.png)

![](img/0e409b1fd8ee4973368b77288f17a021_16.png)

![](img/0e409b1fd8ee4973368b77288f17a021_17.png)

嗯，方法很简单。呃，直接呃在手机上进行一个运行，然后把它从内内存中给释放出来就完事了。那么它的它的一个方法话和我们上一节课时所教到的是一模一样的。好，我们直接运行。



![](img/0e409b1fd8ee4973368b77288f17a021_19.png)

然后进行一个调试。

![](img/0e409b1fd8ee4973368b77288f17a021_21.png)

![](img/0e409b1fd8ee4973368b77288f17a021_22.png)

好，把调试端口打开，然后进行一个端口上的一个转发。

![](img/0e409b1fd8ee4973368b77288f17a021_24.png)

然后IDA我们这里打开一个空的IDA来进行个挂接。然后挂机上我们刚才。想要动出来的一个程序。好等IDA完成一个啊加载，还有分析以后呢。那么直接呢选择这一个modmod的一个窗口，收到我们的一个。好。

收到我们的盖收文件。看一下它的哎里面有这么多函数多风管，我们来看一下它的一个即使即使地址，还有它的大小。那么通过把这段的地址这地方给 dump出来就完事了。我们来排一个脚本。

那么这个脚本的话就是上一节课中所用到的那个脚本呢，我们要来找找回它。好，找到这个下样一个脚短。那么进行一个呃适当的一个修改。它的起始地址是这个地方，然后它的一个大小是这样一个。东西是1个756670。

这个是1个600的大小。然后把它动到这一个地方上去。好嗯。然后好一下这样一个脚本。啊，那么这样一来呢，就把它内存中把这样1个SO文件呃给倒出来了好。那么这个SO文件和原来的SO文件的话，看一下。

它大小是不一样的。因为它加载的时候就完成了一个内存对齐对齐的一个操作。所以理理论上是大一点是没错的。我们另开1个IIDA来对它进行一个分析。好，这哎就表明了。它的sctiontable的数据是空的。



![](img/0e409b1fd8ee4973368b77288f17a021_26.png)

那他我把同学。那么这里它就使用一个bing head来进行一个加载了，可以看一下这样加载出来的效果。哎，比我们从一个下选head中直接加载这个效果就差远了。



![](img/0e409b1fd8ee4973368b77288f17a021_28.png)

好，那我这里不需要先关掉。

![](img/0e409b1fd8ee4973368b77288f17a021_30.png)

哎，这样加载出来的一个效果的话，哎，可以看一下里面有一些函数分析是不能不怎么成功的。嗯，不过一些某一些断数据的话倒是已经出来了。这是只使用一个program head进行加载的一个情况。好。

我们来按ctrl加S，打看它的这一个筛选轴表。可以看到哎，它执行的话就只剩下这几个段给加载到列存中去了，就是对应着两个load的段，就是它加载了一个段。有个S整段，还有个ABS段。

也就是说哎这几个段可以被加载到到内存中去了。

![](img/0e409b1fd8ee4973368b77288f17a021_32.png)

那，这也是我们刚才所说过的一个呃执行的一个视图。执行了一个视图。好，这是这几个地方所指向的一个中心。那么在这里的话，我们只需要明确选一个SO文件，它在执行，还有它存储的时候是两种不一样的格式。

目前来说只需要知道这一个就已经足够了。好，我们再来看一下其他我们再看一下这几个表中，这几个session中有哪几个session是比较重要的。它里面存储了哪些数据是我们想要的一个地方嘛。

首先第一个是一个train的一个session。这里面刚才已经展示过了，里面存储的就是我们的一个呃所有一个字符串的一个基础地址。比如说一些函数名字啊。

也可以存储到这个sction的一个table里面中去了。所以从这里大可以找到我们想要的一个函数名，哎之类的都东西都是有可能的。通过分析这个表中的一个数据块。

甚至某一些加密方法也可以找到一些哪一个东情况的。那么另外一个呢就是一个亚工呢的话就是一个。就这样一个session呢，就是一个动态的一个session。它为什么这么重要呢？哎。

那么这里呢就是存放着嗯一些函数啊，或者说它依赖的1个SO文件，它都会在这样一个table中进行一个存储的。我这样一个sction的话，就是对应着我们的这个当当元sction呢就是这一个地方了。

里面存储的它的一个其他表的一个属性。比如说go table，还有一个这是它的从定位的一个表述性，啊它的讯贴，还有它的自符创table，然后它依赖的一个SO文件。然后他初始化的一个基始地址，还有就住地址。

这都块有这进行一个存储，然后下面就是一个重定位的一个表。那么这个表哎RELDIM对应的这个表数据的话。对应的就是这里这里一个号就是存放着一个重定位的一个数据。

然后这里就是一个函数的一重定下从重定位的一些函数。那么这是1个P7的一个地方，演示一下，通过呃我们需要导入的一些函数进行一个重定位。那么接着是1个AIMEXIDX。

这是AIM平台的一个S文件所特有的一个表，里面的话就是存放着一些函数的一个中转表，对吧？可以看一下里面呃大致也浏染一下吧。那么这一般不会用用的到，我们呃大致也的染一下就足够了。

还有另外一个就是一个动态表DINASIM那么这个就比较重要了。从这里这一个s选中呢，就是在一个sim material中，我们也可以找到它里面所需要导入的所有函数的一个名字，还有它的起始地址。

还有它的一个大小。甚至它的一个防范权限，比如说gogle还是vicF本之类的。这也包括它需要从外面导入到函数，或者说自己定义的函数里面都有。

所以一般假如说我们从IDA中IDA中无法正常的分析去找到它的一些函数的时候，我们可以通过从这样一个table中找到相应的函数来进行一个分析的。啊就是。对这些这些数据的话是肯定是正确的。

因为link的加中的话也是会用到这一些数据的。那么这是一个呃这几个一个simbol table的一个这种。那么下面的话呃它重要性就没有那么强大。那么最后还有一些结尾性的一个分析。

我这里就是一个S文件的一个总览的。那么可以看到的话。那么可以看到整这里的一个s筛选 head是非常非常重要的。然后在program的话则适用于一个家的的。那么回头再来看一下。

这里的整1个360它的一个加密的一个发布，为什么会导致我们的1个IDA不能够正常的去分析出这样1个SO文件呢？哎，这为什么我们就来。使用这个东西来进行一个分析吧。好，我们打开资源文件。

找到我们相份CS文件，然后使用1个VDLF工具。

![](img/0e409b1fd8ee4973368b77288f17a021_34.png)

然后读取它的一个数据。好。进行一个打开。嗯，对已经提示了，它里面里面很多数据都是不正确的，是假的。哎，会很容易会会导这个错误。好，我们再来把它拖到是对一个分析进行一个打开。



![](img/0e409b1fd8ee4973368b77288f17a021_36.png)

那们大致的我们大致的浏浏览一下啊，首先是1个EF head，这是真的正确的。接着我们来看一下这样一个筛小小子。哎，可以看到这里的che实head哎这个名称哎，显然是一个错误的。

然后它的类型全都是显示为一个go table，还有什么什么de类的。这显然是非法，然后它的地址长度大小，也就全都是被啊被混淆过了，不能够之行识别了，然后IDA就根据这样一个东西来进行一个识别的话。

就直接崩溃了。但是我们再来回头看一下它的一个program。哎，这些东西的话，显然这样比较prologgram head的话是非常正常的。哎，表面这一个是无法修改的因maillink它加的时候就用得到。

然后下面的映射表也是乱乱七八糟的，然后它是一个动态筛选，哎，这个还是可看的对吧？然后就是它下面加载的一些函数了，可以看到纽约360的一个对于s纽约360对它的一个筛选head进行了一些混淆。

或者说是填充一些垃圾数据的一个关系呢，导致这里的识别也是一样乱七八糟的。可以看一下这里的识别全都是非法的里面数据都是非法的。好，这这就是360。它为什么能够要过1个IDA的一个加载了？

就是因为它对于我们IDA中所需要的一个session里面填充了这样一些垃圾数据的关系，所导致到唉IDA中无法正常的一个加载一个分析。这就是一个加密的一个作用。

那么我们到底该如何对它进行一个还原进行一个修复呢？哎，那么这些我们这里有待下几节课中来进行一个讲解呢。好的，那么这节课的内容的话就到此为止了，谢谢大家。



![](img/0e409b1fd8ee4973368b77288f17a021_38.png)

🎼。