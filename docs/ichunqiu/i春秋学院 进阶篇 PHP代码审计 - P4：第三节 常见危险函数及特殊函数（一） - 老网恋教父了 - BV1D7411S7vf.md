# i春秋学院 进阶篇 PHP代码审计 - P4：第三节 常见危险函数及特殊函数（一） - 老网恋教父了 - BV1D7411S7vf

。大家好，我是viry。这节课给大家带来的是常见危险函数及特殊函数。本节课有5个内容，一、代码执行函数。2、包含函数。3、命令执行函数。4、文件操作函数。5、特殊函数。首先。是代码执行函数。

第一个ever。啊，想必大家都不会陌生，这个函数是把字符串作为切P代码执行。很多常见的we cell都是用ever来执行具体操作的。第二个a third。断言这是一个调试函数。

然后同样它也具有把字幅串作为PT代码执行的功能。嗯，在大多数s软把ever列入黑名单之后，就用来替代ever。然后是ppay。啊，这个函数的作用是执行正格表达式进行搜索和替换。当使用杠E修正符的时候。

啊去将 replacement。呃，当做PAP代码进行执行。然后是create function。啊，这函数是创建一个匿名函数。啊，啊我们可以把啊这幅串。嗯，内容作为函数去执行。好。

因为呃PHT的一个特性。可以把变量作为函数名执行。所以所以就有了一类一系列的匿名函数。嗯，最后是回调函数call you和call you every。嗯，两个函数都差不多，都是回调嗯，调用其他的函数。

嗯，只是后面的参数不同，一个是呃多参数形式，一种是数组形式。好，接下来我们看具体代码。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_1.png)

首先是ever。同样是啊有两句输出，一句是i里面的字符串输出test，另一句是直接输出。然后我们使用s test two的执行脚本的功能。嗯，也是。to build功能control B快捷执行。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_3.png)

成功输出两句话嗯，中间输出是换行，也说appvo函数和普通字星是一样的。I后 to assert。我们中间的代码是执行。是很函数。好，不行，who am I命令。嗯，一样执行。嗯，成功输出。有成功执行。

然后是p。然后再搜索tt。嗯，并替换的时候，他用了刚毅修正符，也将会执行这双字符算执行KTin这个函数。我们执行。这样确实是输出了内容。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_5.png)

我们到浏览器看一看。还好输出。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_7.png)

我们再来看下面的匿名函数。啊，这里用。Create function去。呃，创建一个函数是返回。啊，sstem的执行的值。然后这里的V是参数。呃，参数传递到stem里面。好用。嗯。

变量这种形式去执行这个函数。我们执行。也是可以正常执行。那么我们再看另外一种形式的匿名函数。嗯，直接将字符串拼接并赋予赋值。好，这时候也是直接调用。执行。好，还是正确正常输出，就正常调用。그。好。

最后是回调函数。啊，因为是回调函是我们这里是。调用了嗯，先是自定义一个tt函数。然后输出。probal，然后是输出变量。啊，也就是传输过来的参数。那么我们调用tt。然后是传递ra这个参数。好。

我们在执行。完全输正常输出。嗯，改一下参数。我继续执行。哦，如果我们是把。函数改成。System。好，参数还是改成OMI。继续执行。也是能够执行。Okay。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_9.png)

好，接下来我们继续看。包含函数。Require。Include require one。 includenc one。啊，包含还是一共有4个。主要作用就是包含并运行指定文件。啊。

这里的运行指令文件是指运行文件里面的啊在PP标签里面的PP代码。然后为什么有4个呢？啊，他们有4个有不同的区别。啊，至至于他们的区别啊，大家想要了解就去官网看。好，接下来是。嗯。

包含函数一般是incode，后面加文件名，文件路径。啊，们这里是电量带。然后在拜可控的情况下，我们就可以包含任意文件。好，从而达到excel的目的。然后这里所谓的任意文件是指文件名任意。

可以是包含图片或者文档或者压缩文件。但是只要这个文件的铭文。它是PP标签所包含的PP代码，它就会执行里面的代码。然后是在不同的配置环境下，还有分有两种包含形式，一种是包含远程文件，一种是包含本地文件。

因为服务器配置一般都是默认关闭远程包含的。可以说大多数情况下就只能包含本地文件。如果远程文件包含是打开的话，它就可以是。啊，包含网上啊任意资源的文件，你可以在自己的服务器上面写一段代码。

让它包含就是一个远程的seel。啊，在大多数情况下就包含本地文件，就需要你上传上传一个exel。或者是上传一个带有cel呃代代码的图片之类的。好，包含函数的另一个特性就是能够读取任意文件。嗯。

这里读取任意文件主要是用到了封装协议以及过滤器。例如利用P气流better啊去读取任意文件。然后就是啊利用它的转换过滤器，把base64编码。好。将文件的内容编码之后再包含进来。啊，由于编码之后。

它没有了标签，它就不会执行函数。那就当做普通的文本包含进来。嗯，一样，我们再去看代码。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_11.png)

嗯，首先我们还是一样。呃，先是输出它的配置信息。然后。好，我们再去包含我们传递过来的参数。嗯。啊，先是嗯我们就去网页去执行代码。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_13.png)

啊。传递V等于我包含一个本地文件LSI点PHP。嗯。好，首先它是输出配置信息，就是一般远程为包含是关闭的。好是，但是他又可以打开远程文件。嗯，能打开，但不能包含。

但是啊所以说这时候在inco就不能使用啊，远程文件。啊，相比其他的文件操作函数就可以打开远程的文件。也就读取远程文件内容。嗯，那个稍后再说。啊，现在是包含了LFI点PP这个脚本的信息。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_15.png)

啊，就是输出这样的一些。就是算好，我们再去看一下那个文件的。他首先就是LFI这啊普通的文本。然后是P7标签里面的内容嗯，输出这一串字符串。Test F FI。嗯，他没有标签的，就直接输出，有标签的。

它就执行后输出。可以说这里就产生了一个可以用过滤器去读取任意文件的特性。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_17.png)

好，我们来试试。嗯，这里是。包含。In带。啊啊，就是读取inest代码。Yeah。好，执行后这一串。就是in depth的代码。啊，因为经过这水64加密了。好，我们可以来解密看看。Yeah。好。

这些是解灭后的内容。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_19.png)

啊。这里就是in depth的内容，我们去看看in depth。Yeah。好，这就是包含的啊功能。任意文件读取。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_21.png)

然后是命令执行函数。PHP的命令函数嗯。大概有这些啊，但应该不限于这几个。嗯，也许还有我没有列出来的。然，这样的命令执行函数其实调用外部的函数啊，调用外部的程序。或者。通过sell环境执行命令。

然后当我们。呃，这些命令执行函数的参数可控的时候。你就可以执行任意命令。比如我们。原本是要进行拼命令的。然后这个态极变量。如果可控的话。我们就可以利用一些类是管道符等特殊字符啊，进行截断。

从而执行任意命令。一样，我们继续看代码。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_23.png)

嗯。我们这里用是sell effect。啊，首先我们是执行。啊，聘本地。然，在输出的内容。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_25.png)

哦，因为编码问题不显示，我们在网页这边直接看刷新。哦，成功的拼了之后。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_27.png)

好，我们再来看。嗯，再来看这一句。啊，就是我们P后面是自定义的IP，但是当我们V。呃，可控没有检查我们输入的内容的时候，我们就可以用来截断。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_29.png)

啊，如我们也是同样先。填充1个IP。然后我们用管道和截断输出OMI00。这时我们在执行。他现在是死行了，听命令。然后是执行后MI命令，最后输出的是我们后MI执行后的结果。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_31.png)

![](img/c93ebe53fbd2cc30c5976f56d04b231f_32.png)

Yeah。执行命令。啊，就讲到这里，我们再看文件操作函数。文件操作函数有很多很多，我这里只列出了一小小部分。哎。任E文件。啊，文件操作命令啊，这个文件操作函数的参数可控的话。

就可能导致任意文件的读取、写入、删除等。然后在不同的函数，在不同的场景有不同的对用，以及不同的利用手法一堆的不同。然后在当可以读取的时候，我们就可以读取配置信息呀，以及读取源码。啊，在写入的时候。

我们就可以写入fiel代码，写入后门。删除的话就可以删除点lock文件，从而重新覆盖安装。啊，还有更多的思路呢啊就大家自行挖掘。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_34.png)

哦，这里也稍微演示一两个。首先我们是。啊，输出testt内容到啊FPC点text这个文件。我们先来看。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_36.png)

哦，打开他的当前目录。嗯，这里并没有1个FCCT。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_38.png)

这个文件。好，我们来执行。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_40.png)

嗯。好，再来看它已经多了一个文件，它的内容就是t。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_42.png)

然后。我们执行。啊，我还可以是啊，对，还可以读取远程文件。嗯，我们把用另外一个函数byget content。嗯。我们都去。啊，百度的内容。嗯。我们把读取百度的内容输出到这个文件里面。然，在执行。

嗯成功。你再来看这个文件。他这些是百度的代码。那就是打开远程文件的功能。我这里。再用on link啊，这个是删除函数。他等于delete。好，我们来执行。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_44.png)

我们再看已经没有了，前面生成的SPC文件已经没有了。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_46.png)

可控的话，我们就可以对任意文件进行操作了。还有其他什么改名的，我就不一掩示了。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_48.png)

Yeah。然后是特殊函数。这一类的特殊函数比较多。我这里也列举不完嗯，各种函数都是己慢慢积累的。首先第一个就是PT info。这个函数啊输出PT当前大量信息。好，是一个比较敏感的信息泄露的问题。啊。好。

第二个是软链接。然后利用软链接去读取文件内容啊，这个一般是在linux服务器上面使用的。就为某目标建立一个链接，在读取这个链接所连接的那个文件。好，返回他的内容。然是。环境变量。在当前请求期间。

然他可以设置一些变量。嗯，也可以获取自定义的环境变量或者是系统的环境变量。我们来看一下代码。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_50.png)

呃，代码的意思首先是呃获取test环境面量。如果有就返回处，没有就返回for。然后我们再临时设置一个t等于123。然，再输出tap。好，我们来执行。首先是。for他并没有test这个变量。

然后把它设置为三的时候，再次输出，它就是为123了。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_52.png)

这就环境变量。然后是加载扩展的话，它一般是。呃，加载一些PPT的特定或展。嗯。这个也自行研究，这里不做演示。啊，配置相关的特殊函数。I N I get。 I N I set。啊。

就是在也是在当前请求期间啊临时设置。啊，一些配置信息。啊我们还是看代码。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_54.png)

。我们这里是首先是输出。display errors它的配置信息。好，我们这里把它设置为停，也就for。嗯，关闭它。然后再去输出。我们执行。一开始啊默认是on。

毕竟我们审计代码都要把KTINI的配置设置为on。啊，查看他的错误信息，然后我们临时把它关闭掉了。啊，在输出的时候啊，它就是关闭的。好，我们再请求一次。他还是on。嗯，所以说是每一次请求，它都是默认值。

这里的设置值当前设置在。后面一句有用。

![](img/c93ebe53fbd2cc30c5976f56d04b231f_56.png)

。好，是数字判断。这个函数是判断这个参数。啊，是数字。和数字字符嗯或者其他。好。这是有一个也比较严重的问题。请用这个函数去判断。而不用interval去转换，就有可能导致插入16进制的字符串到数据库。

进而导致啊可能导致二次注入。而，这可能是因为利用二次注入也是有一定条件的。好，我们这里就只来讲这个函数。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_58.png)

还是看代码。然，这里是。首先是输出我们提交的内容来判断判断它是否是数字或者数字字符串。好，我们输出我们当前的内容。然后再用inter去转换，看他能转换成什么样的结果。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_60.png)

我们这次到网页去。啊，一我们先是123。首先判断他是不是数字。好，他就是的。返回来处。输出了转换后也是123。我们注入一般用的是啊单引号来测试是否注入。好，他明显就错了，并不是不是这个数字。

还有了一个符号，就是字符串。好，我们这里如果用1六进制的话，0F123。然后你再来执行。他数是数字，十六进制的也是数字。但是他用inter转换之后，它却是0。啊，他就把。啊，这是串。嗯，字母的。都。

去掉了。然后再就把保留最前面的数字部分，我们在最前面加上一个字符。他也就还是0，默认为0。然后我们用科学计数法011。他还是数字。但是他inter就还是0。你说。啊，尽量用interval去。佢有这种。

啊，判断或者转换。啊对。这个判断数字或者数字字符串不是很靠谱。你继续看。数组相关的in error。好，这个函数就是判断。某一个。啊，变量。啊，是否存在于这个数组里面？然后他这个函数有一个特性。

在比较之前啊会自动类型转换。然后当然如果把这个STRICT这个设置为处的话。然后他就不会自动转换了。嗯，大多数都没有设置。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_62.png)

好，我们再来看代码它是怎么样的转换。Yeah。首先我们把V这个变量设置为一。然后。我们来判断这个变量的值是否。啊，在这个数组里有是否等于这数组里的某一个值？他这时候比较的时候。

他先会把这个字符串形式的一转化为啊数字形式的一，然后再去比较，那么它就是相等的。然后。我们在设置啊负值1ABC负制到变量V。好，再去判断。这个V是否是在123这个数字里面？Yeah。哦。

也是同样在比较的时候，这个一。啊，1ABC它会先转化为一啊，再去和后面的数字一进行比较。Yeah。好，我们来。再看最后一个就是他在判断是否在这个另外一个的数字里面，这里没有一，也没有。啊，没有数字的一。

也没有字符上的一，他就应该不在的。啊，你看执行效果。首先就是to前面这个正确。啊，第二个也是醋。第三个就是ts。啊，这也就是它的自动啊自动类型转换的一个。呃，漏洞吧。啊，这个。如果我们用了te的话啊。

这个等于t，我们来试试看。你再来执行。他就是说报下来强制。嗯，强制对比也就是这种。然后就不会自动转换。



![](img/c93ebe53fbd2cc30c5976f56d04b231f_64.png)

![](img/c93ebe53fbd2cc30c5976f56d04b231f_65.png)