# i春秋学院 进阶篇 PHP代码审计 - P6：第五节 XDebug的配置和使用 🐛

在本节课中，我们将要学习PHP调试工具XDebug的配置与使用方法。XDebug是PHP代码审计中一个非常强大的辅助工具，能够帮助我们跟踪、调试和分析PHP程序的运行状况。

## XDebug介绍

上一节我们介绍了代码审计的基础环境，本节中我们来看看一个核心的调试工具。XDebug是一个开放源代码的PHP程序调试器，也是一个PHP的扩展插件。它可以用来跟踪、调试和分析PHP程序的运行状况。这个强大的工具对我们的代码审计工作有非常大的帮助。

## XDebug配置

介绍完XDebug的基本概念后，本节中我们来看看如何配置它。XDebug的配置主要涉及日志、数据显示、格式和行为等方面。

以下是XDebug的主要配置项：

*   **日志配置**
    *   `xdebug.trace_output_dir`：设置输出文件的目录。所有追踪信息都将输出到该目录下。
    *   `xdebug.trace_output_name`：设置保存记录的方式，有追加和覆盖两种模式。默认是覆盖模式，推荐使用覆盖模式。如果使用追加模式，随着记录增多，文件会变得非常大，不便于阅读。

*   **显示数据配置**
    XDebug的追踪方式以函数为主线，记录每个函数的执行状况。显示数据的配置也与函数相关。
    *   `xdebug.collect_params`：控制是否显示函数的参数信息。
    *   `xdebug.collect_return`：控制是否显示函数的返回值。
    *   `xdebug.collect_vars`：控制是否显示当前作用域的局部变量。
    *   `xdebug.collect_assignments`：控制是否显示变量的赋值情况。

*   **格式配置**
    `xdebug.trace_format`：设置日志的保存格式。主要有三种：
    *   `0`：人可读格式。推荐使用此格式，显示信息详细，包含变量名和参数名。
    *   `1`：机器可读格式。主要供其他工具解析，不如人可读格式方便详细。
    *   `2`：HTML网页格式。

*   **行为配置**
    `xdebug.auto_trace`：控制追踪行为。
    *   `On`：自动追踪。推荐在审计时使用此模式，每次访问脚本都会自动生成最新的追踪信息。
    *   `Off`：触发式追踪。需要手动触发。

*   **扩展加载**
    要使用XDebug，必须在PHP配置中加载其扩展文件。扩展文件的版本与PHP版本紧密相关，必须使用对应版本的XDebug扩展。例如，在PHP 5.5环境下，配置如下：
    ```ini
    zend_extension = “D:/phpStudy/PHPTutorial/php/php-5.5.38/ext/php_xdebug.dll”
    ```

以上是进行PHP代码审计时最常用和必要的配置。XDebug还有更多配置选项，如需深入了解，请自行查阅官方文档。

## XDebug使用

![](img/72a125fe12683848c27a00fb514d5609_1.png)

配置好XDebug后，本节中我们来看看如何在审计中实际使用它。

假设我们有一个简单的PHP文件 `test.php`，其内容如下：
```php
<?php
$str = “Hello World”;
$v = $str;
echo $v;
?>
```
当我们访问这个脚本时，XDebug会在配置的输出目录下生成对应的追踪文件（`.xt` 文件）。

直接阅读生成的 `.xt` 文件可能不太方便。我们可以使用文本编辑器（如 Notepad++）打开，并启用PHP语法高亮，同时利用其“函数列表”或“折叠”功能，就能清晰地看到每个函数的执行状况以及变量的赋值过程。

基本的审计流程是：访问目标PHP页面 -> 在输出目录查看生成的追踪文件 -> 用编辑器分析追踪日志。在复杂的框架中，追踪文件会包含大量加载和执行信息。此时，我们可以直接搜索关键函数名或SQL语句片段来快速定位核心代码的执行路径。

![](img/72a125fe12683848c27a00fb514d5609_3.png)

### XDebug的“黑科技”：辅助代码解密

XDebug还有一个强大的用途，即辅助分析经过加密或混淆的PHP代码。

![](img/72a125fe12683848c27a00fb514d5609_5.png)

![](img/72a125fe12683848c27a00fb514d5609_7.png)

假设我们遇到一个被加密的文件 `xdebug_test.php`，其核心逻辑被隐藏。加密后的代码可能非常复杂，难以直接阅读。

当我们访问这个加密文件时，XDebug同样会记录其执行过程。加密代码最终通常需要通过 `eval()` 或类似函数来执行解密后的真实代码。

我们可以在生成的XDebug追踪日志中，直接搜索关键词（如提交表单的字段名 `password`，或关键函数 `eval`）。通过追踪 `eval()` 函数执行时传入的参数，我们就有可能直接看到被还原的源代码片段，从而绕过复杂的加密逻辑，快速理解程序意图或找到关键信息（如硬编码的密码）。

这种方法能帮助我们破解大多数基于 `eval` 执行的简单代码加密。

![](img/72a125fe12683848c27a00fb514d5609_9.png)

![](img/72a125fe12683848c27a00fb514d5609_11.png)

## 总结

![](img/72a125fe12683848c27a00fb514d5609_13.png)

本节课中我们一起学习了PHP调试工具XDebug。我们首先了解了XDebug的基本概念和作用。然后，详细讲解了其核心配置方法，包括日志、数据显示、格式和行为等。最后，我们通过实例演示了如何使用XDebug追踪普通代码的执行流程，以及如何利用它辅助分析加密的PHP代码，这是代码审计中一个非常实用的技巧。掌握XDebug的使用，将极大提升我们进行PHP代码审计的效率和深度。