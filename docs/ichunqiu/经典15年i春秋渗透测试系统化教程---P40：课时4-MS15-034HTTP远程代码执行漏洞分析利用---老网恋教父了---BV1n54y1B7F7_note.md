# 经典15年i春秋渗透测试系统化教程 - P40：课时4 MS15-034 HTTP远程代码执行漏洞分析利用 🔍

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_1.png)

在本节课中，我们将要学习一个影响广泛的微软漏洞——MS15-034。这是一个存在于IIS服务器中的HTTP远程代码执行漏洞，可能导致服务器蓝屏或崩溃。我们将从漏洞原理、影响范围、利用方法到修复方案，进行全面的分析和实践演示。

## 概述与影响范围 📋

上一节我们介绍了漏洞的基本概念，本节中我们来看看MS15-034的具体情况。

该漏洞编号为MS15-034，是2015年初公开的一个新漏洞。漏洞存在于 **`HTTP.sys`** 这个驱动文件中。这个文件是微软为Windows平台的IIS服务器引入的一个内核级驱动程序，主要用于处理HTTP请求的接收、响应和缓存，以提高性能。需要注意的是，IIS 6.0以下的版本没有这个文件，因此不受影响。

以下是受该漏洞影响的操作系统版本列表：
*   Windows 7
*   Windows Server 2008 R2
*   Windows 8
*   Windows Server 2012
*   Windows 8.1
*   Windows Server 2012 R2

## 漏洞原理浅析 ⚙️

了解了漏洞的影响范围后，我们深入了解一下其原理。

该漏洞由美国虚拟化软件公司VMware的研究人员发现。在微软发布补丁后约12小时内，攻击代码就在网络上被公开。

**`HTTP.sys`** 驱动程序在处理特制的HTTP请求时存在缺陷。具体来说，是在处理 **`Range`** 请求头时，对偏移量和长度的校验不严格，可能导致越界读取或写入。攻击者可以构造一个包含恶意 **`Range`** 头的HTTP请求，例如：
```
Range: bytes=0-18446744073709551615
```
这个请求指定了一个巨大的字节范围（接近2^64），超出了正常缓冲区的大小，从而触发漏洞，导致系统蓝屏（BSOD）或服务崩溃。目前公开的利用代码主要造成拒绝服务（DoS），尚未出现能稳定获取系统权限的利用方式。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_3.png)

## 漏洞检测与利用演示 💻

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_5.png)

明白了原理，接下来我们进行实际的检测和利用操作。以下是利用该漏洞的基本步骤。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_7.png)

首先，我们需要检测目标服务器是否存在此漏洞。可以使用一个简单的检测脚本，通过发送特定的HTTP请求并检查响应头来判断。如果响应头中包含 **`Requested Range Not Satisfiable`** 字样，则表明存在漏洞。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_9.png)

如果检测到漏洞存在，则可以发起攻击。攻击通常使用Burp Suite等工具，手动构造并发送恶意的HTTP请求数据包。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_11.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_13.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_15.png)

以下是攻击数据包的关键特征：
*   **请求方法**：GET
*   **请求头**：包含恶意的 `Range: bytes=0-18446744073709551615`
*   **请求资源**：目标服务器上的一个有效文件路径（例如一张图片）

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_17.png)

发送此数据包后，未打补丁的服务器通常会立即蓝屏、崩溃或变得无响应。有时可能需要发送多次请求才能触发。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_19.png)

## 漏洞修复方案 🛡️

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_21.png)

演示了攻击效果后，我们必须了解如何防御。以下是修复此漏洞的几种方案。

最根本的解决方案是安装微软官方发布的补丁。你可以访问微软官方安全公告，根据操作系统版本下载并安装对应的安全更新。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_23.png)

如果由于业务原因无法立即重启服务器安装补丁，可以采取临时缓解措施：在IIS管理器中，禁用 **`HTTP.sys`** 的缓存功能。
1.  打开IIS管理器。
2.  选择服务器节点，打开“输出缓存”功能。
3.  将相关规则的缓存模式设置为“禁用”。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_25.png)

**注意**：这只是临时方案，可能会影响服务器性能，最终仍需安装官方补丁。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_27.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_29.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_31.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_33.png)

## 总结与要点回顾 📝

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_35.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_37.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_39.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_41.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_43.png)

本节课中我们一起学习了MS15-034 HTTP.sys远程代码执行漏洞。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_45.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_47.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_49.png)

我们首先了解了该漏洞的影响范围，主要波及IIS 6.0以上的Windows服务器系统。接着分析了漏洞的根源在于 **`HTTP.sys`** 驱动对HTTP请求中 **`Range`** 头处理不当。然后，我们逐步演示了如何使用检测脚本发现漏洞，并利用Burp Suite构造恶意请求进行攻击，导致目标服务器蓝屏或服务拒绝。最后，我们探讨了两种修复方案：安装官方补丁是根本解决方法，而禁用HTTP.sys缓存可作为临时缓解措施。

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_51.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_53.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_55.png)

![](img/5a64ccdc7aad5f9b419436ebc06da8d3_57.png)

请务必在授权环境下进行安全测试，并及时为生产系统更新补丁，防范此类高危漏洞。