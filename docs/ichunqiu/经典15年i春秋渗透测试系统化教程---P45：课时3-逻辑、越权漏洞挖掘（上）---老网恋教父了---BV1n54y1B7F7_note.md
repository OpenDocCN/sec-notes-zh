![](img/0513879ef5f3ed298c3656c784206670_1.png)

# 经典15年i春秋渗透测试系统化教程 - P45：课时3 逻辑、越权漏洞挖掘（上）🔍

## 概述
在本节课中，我们将要学习逻辑漏洞与越权漏洞的基础知识、核心概念以及初步的挖掘思路。这两种漏洞是渗透测试中常见且危害性高的类型，通常无法被自动化扫描器发现，需要依靠手工测试来挖掘。

![](img/0513879ef5f3ed298c3656c784206670_3.png)

![](img/0513879ef5f3ed298c3656c784206670_5.png)

## 逻辑与越权漏洞简介
从这节课开始，我们讲解逻辑漏洞挖掘。逻辑漏洞是目前比较流行的漏洞类型。

![](img/0513879ef5f3ed298c3656c784206670_7.png)

![](img/0513879ef5f3ed298c3656c784206670_9.png)

为什么流行呢？很多网站在做渗透测试时，当注入类、文件上传类、代码执行类漏洞，用扫描器或手工检测都找不到时，并不代表没有漏洞。因为企业通常也有安全测试人员，会使用各种扫描器扫描公司网站。但渗透测试主要看测试人员水平的高低，能否找出漏洞。一般的网站都有漏洞，关键是看你的能力去找。如果这些常见漏洞都没有的情况下，我们怎么去找漏洞？通过什么样的方式？这节课就是教大家，当扫描器发现不了漏洞时，如何靠手工去挖掘逻辑漏洞。

大家都知道扫描器是不会扫描逻辑漏洞的，它不像人一样能模拟用户的各种操作，那是不现实的。目前没有一款扫描器能扫描逻辑漏洞。例如越权漏洞，扫描器几乎也扫不出来。有些页面扫描器能爬到，但它不知道这个地方存在越权操作，例如能访问到管理页面，它不会提示。

这是我们今天一节课的重点，也是学习渗透测试必学的知识。

![](img/0513879ef5f3ed298c3656c784206670_11.png)

## 漏洞统计与分类
我们对常见的漏洞进行过统计，发现其中越权和逻辑漏洞占的比例比较高。也就是说，在我们所渗透过的平台中，基本上都发现过逻辑漏洞，包括任意查询用户信息、任意删除等行为。这类漏洞常出现在账号安全、密码重置、验证码暴力破解等方面。

注意，逻辑漏洞其实跟越权是分开的，是两大块。这两大块，我在这里主要是把它们合二为一，放在同一个文档里，没有把它们区分开来。其实在渗透测试过程中这是两大块，逻辑和越权，写报告也是分开写的，不能混为一谈。

![](img/0513879ef5f3ed298c3656c784206670_13.png)

![](img/0513879ef5f3ed298c3656c784206670_15.png)

在讲课过程中，我提前给大家说一下，因为我这里文档写的是把两个都合在一起写的，我不想分开，分开的话写两个word文档不好写，所以我把它写在一起了。

![](img/0513879ef5f3ed298c3656c784206670_17.png)

![](img/0513879ef5f3ed298c3656c784206670_19.png)

![](img/0513879ef5f3ed298c3656c784206670_20.png)

## OWASP Top 10 中的定义
我们来看一下OWASP Top 10。它也提及到了逻辑漏洞，但它不命名为逻辑漏洞，它分别命名为“不安全的对象引用”和“功能级别访问控制缺陷”。

![](img/0513879ef5f3ed298c3656c784206670_21.png)

其中，“不安全的对象引用”指的就是平行越权。“访问控制缺陷”指的是垂直越权。

![](img/0513879ef5f3ed298c3656c784206670_23.png)

记住，“不安全的对象引用”就是越权，具体叫平行越权。平行越权是什么意思呢？举个例子，我是普通用户，你也是普通用户，但是我可以查看到你这个用户的相关敏感信息。那么就叫做平行越权。正常情况下，如果没有这个平行越权的漏洞，那么你是不可能查看到对方账号里面的敏感信息。例如，A可以查看B的银行账号、金额。正常情况下，我绝对不可能去查看到对方银行卡里面有多少钱，或者修改他的金额。但是如果存在这个漏洞，那么我就可以改他的金额，知道他的相关信息、身份证号、姓名、金额。

![](img/0513879ef5f3ed298c3656c784206670_25.png)

![](img/0513879ef5f3ed298c3656c784206670_27.png)

这里我举了一个例子。

![](img/0513879ef5f3ed298c3656c784206670_29.png)

![](img/0513879ef5f3ed298c3656c784206670_31.png)

![](img/0513879ef5f3ed298c3656c784206670_33.png)

![](img/0513879ef5f3ed298c3656c784206670_34.png)

那么什么是垂直越权呢？垂直越权是普通用户跟管理员账号之间的权限跨越。举个例子，A账号是一个普通账号，B账号为管理员账号。那么B账号的管理页面是必须是以管理员权限进行登录查看的。这一点是毫无疑问。但是当A账号可以通过直接访问管理页面的URL的方式时，那么这种方式就可以绕过了管理员登录的限制，查看管理员页面。这个漏洞也有，尤其是刚开发出来的一些小网站，包括大网站也有，我也遇见过。在企业内部渗透测试过程中，如果一个普通用户登录进去之后，我知道管理页面的路径，接上这个管理页面的路径一访问，结果我的普通用户就能访问管理员后台页面。那么这个就是垂直越权。

![](img/0513879ef5f3ed298c3656c784206670_36.png)

![](img/0513879ef5f3ed298c3656c784206670_37.png)

![](img/0513879ef5f3ed298c3656c784206670_39.png)

![](img/0513879ef5f3ed298c3656c784206670_40.png)

记住，平行越权就是两个权限是一样的（A和B权限相同）。垂直权限就是我是一个普通用户，你是一个管理员，我普通用户来访问管理员的相关页面。这就叫垂直越权。

![](img/0513879ef5f3ed298c3656c784206670_42.png)

因此，在OWASP中称为“不安全的对象引用”和“功能级别访问控制缺陷”。该类漏洞属于业务逻辑设计的缺陷，因此传统的扫描器是无法发现的。平行越权、垂直越权，扫描器是不能知道的，目前没有一款扫描器有这个功能，只能通过手工渗透测试进行检查。

![](img/0513879ef5f3ed298c3656c784206670_44.png)

![](img/0513879ef5f3ed298c3656c784206670_46.png)

在金融平台中，平行越权的访问控制缺陷较为常见。我测试了这么多项目、这么多站点，发现大量的有平行越权漏洞。

![](img/0513879ef5f3ed298c3656c784206670_48.png)

![](img/0513879ef5f3ed298c3656c784206670_50.png)

![](img/0513879ef5f3ed298c3656c784206670_51.png)

## 常见的逻辑漏洞场景
接着我们看一下常见的逻辑漏洞。逻辑漏洞一般存在于交易支付、密码修改、密码找回、越权修改、越权查询、突破限制等各类业务环节。

![](img/0513879ef5f3ed298c3656c784206670_52.png)

![](img/0513879ef5f3ed298c3656c784206670_54.png)

![](img/0513879ef5f3ed298c3656c784206670_56.png)

这个图是乌云上面提供的，我觉得是目前做得最好的一张图，它综合了密码找回逻辑漏洞的挖掘思路。

![](img/0513879ef5f3ed298c3656c784206670_58.png)

![](img/0513879ef5f3ed298c3656c784206670_60.png)

![](img/0513879ef5f3ed298c3656c784206670_61.png)

以下是密码找回逻辑漏洞的一些常见类型：

![](img/0513879ef5f3ed298c3656c784206670_63.png)

![](img/0513879ef5f3ed298c3656c784206670_65.png)

1.  **用户凭证暴力破解**：很多网站的验证码是4位或6位，例如手机验证码，用于注册或修改密码。如果验证码没有尝试次数或时间限制，我们可以用Burp Suite的Intruder功能抓包，将验证码作为变量进行暴力破解，从而修改他人密码。
2.  **返回凭证**：比较简单，就是在返回的页面或数据包中，直接包含了敏感信息，如密码提示问题的答案。
3.  **邮箱/手机Token重置密码**：例如，在找回密码时，服务器返回一个加密的字符串（Token），而这个Token可能被直接放在页面源码中，或者其加密方式可被破解（如使用时间戳的MD5），从而绕过验证。
4.  **用户凭证有效性**：例如，短信验证码在服务器端验证逻辑有误，导致可以重复使用或修改接收手机号/邮箱。

![](img/0513879ef5f3ed298c3656c784206670_67.png)

![](img/0513879ef5f3ed298c3656c784206670_69.png)

这里有很多对应的案例，乌云上面大家可以去看。我不一一给大家讲了，这里有个地址，我给大家随便挑几个案例看一下。

![](img/0513879ef5f3ed298c3656c784206670_71.png)

## 经典案例分析
已经打开了，随便挑几个案例，举个例子，这也是当当网的任意用户密码修改。我们看一下微信的案例。

![](img/0513879ef5f3ed298c3656c784206670_73.png)

![](img/0513879ef5f3ed298c3656c784206670_75.png)

![](img/0513879ef5f3ed298c3656c784206670_77.png)

![](img/0513879ef5f3ed298c3656c784206670_79.png)

微信最早的一个任意用户密码修改漏洞是我的原创。当时微信刚出来的时候，在注册账号发送手机验证码时，验证码其实是一个MD5加密的值，并且直接放在了网页的源代码里。把这个值复制出来进行MD5解密，就得到了验证码，从而可以用任意手机号注册微信。

![](img/0513879ef5f3ed298c3656c784206670_81.png)

后来这个漏洞提交给微信后修复了。

![](img/0513879ef5f3ed298c3656c784206670_83.png)

![](img/0513879ef5f3ed298c3656c784206670_85.png)

![](img/0513879ef5f3ed298c3656c784206670_87.png)

我们看一下作者“orin”发表的一个微信任意用户密码修改漏洞。这个思路也比较好。漏洞的产生是说，在修改密码时，最关键的一步是验证码。我们不知道验证码就改不了密码。点击提交时抓取数据包，载入到Burp Suite的Intruder功能里暴力破解四位验证码。但微信做了防御，尝试次数过多会提示“请求过于频繁”。突破的方法是在手机号码参数后面随便加一些字符（如`%00`），再进行爆破时，就不会出现频繁提示了，从而成功破解验证码重置密码。这就是典型的逻辑漏洞，没有对参数进行严格过滤和限制。

![](img/0513879ef5f3ed298c3656c784206670_89.png)

![](img/0513879ef5f3ed298c3656c784206670_91.png)

![](img/0513879ef5f3ed298c3656c784206670_93.png)

当时，50个线程发包，3分钟之内就可以修改一个密码。

![](img/0513879ef5f3ed298c3656c784206670_95.png)

![](img/0513879ef5f3ed298c3656c784206670_97.png)

接着看一下，天天网的案例。在找回密码时，填写邮箱和验证码后抓包，会发现返回一个加密的字符串。仔细观察，这个加密字符串和之后页面中需要填写的验证码竟然是同一个，这样邮箱验证码就可以直接绕过，因为只要解密这个字符串就行了。这就是一个返回凭证泄露的漏洞。

![](img/0513879ef5f3ed298c3656c784206670_99.png)

![](img/0513879ef5f3ed298c3656c784206670_101.png)

还有搜狐邮箱的任意密码修改。点击网上申诉，在申诉页面源代码中不仅有密码提示问题，隐藏表单里竟然泄露了问题的答案。这样就可以获得用户修改密码的问题答案，轻而易举修改密码。

![](img/0513879ef5f3ed298c3656c784206670_103.png)

![](img/0513879ef5f3ed298c3656c784206670_105.png)

所以说逻辑漏洞的危害相当高。后面有大量的案例，包括奇虎360、网易、12306、12308等大型网站都存在。我建议大家学习逻辑漏洞时，无论如何把这篇文章（指乌云相关合集）全部看完，并且把里面的案例都过一遍。因为乌云这个站是比较好的网站，它记录了各类大网站被攻击的详细流程。你看完之后，自己在本地搭建环境进行逻辑漏洞测试。

![](img/0513879ef5f3ed298c3656c784206670_107.png)

## 如何挖掘逻辑漏洞
下面我们接着讲解如何挖掘逻辑漏洞。

![](img/0513879ef5f3ed298c3656c784206670_109.png)

![](img/0513879ef5f3ed298c3656c784206670_111.png)

挖掘逻辑漏洞，你首先要知道并模拟正常的业务流程。接着我们尝试修改流程中的相关参数。

以支付流程为例，我们在网上购买商品时，流程通常是：选定商品加入购物车 -> 确认购物车信息 -> 输入物流及收货人信息 -> 确认订单进入支付环节 -> 交易成功等待发货。

作为渗透测试人员，我们怎么在这个流程里找逻辑漏洞？找逻辑漏洞的流程你一定要非常清楚。

![](img/0513879ef5f3ed298c3656c784206670_113.png)

以下是挖掘支付逻辑漏洞的一些思路：

![](img/0513879ef5f3ed298c3656c784206670_115.png)

![](img/0513879ef5f3ed298c3656c784206670_117.png)

![](img/0513879ef5f3ed298c3656c784206670_119.png)

![](img/0513879ef5f3ed298c3656c784206670_120.png)

1.  **修改购买数量**：将商品加入购物车后，用Burp Suite拦截请求，尝试修改购买数量参数，例如改为`-3`或`0`，然后提交，看是否能以负价格或零元购买。
2.  **修改商品价格**：除了改数量，还可以尝试直接修改商品单价参数，例如改为`-100`或`0`，然后提交。
3.  **修改折扣或总金额**：在确认购物车信息时，尝试修改折扣参数或商品总金额。
4.  **修改或绕过运费**：尝试控制或修改运费参数。
5.  **绕过支付环节**：在跳转到支付接口时，尝试修改支付金额，或者尝试不支付直接跳转到“交易成功”的环节。例如，先正常支付1分钱走完流程，抓取最后“完成”步骤的数据包。第二次购买时，不进行支付，直接尝试重放或跳转到最后“完成”的页面。

![](img/0513879ef5f3ed298c3656c784206670_121.png)

![](img/0513879ef5f3ed298c3656c784206670_123.png)

![](img/0513879ef5f3ed298c3656c784206670_125.png)

我以前经常挖这样的逻辑漏洞，测试过大量的网站，包括一些大型网站。当然，现在大部分大型网站都修复了这些漏洞。

![](img/0513879ef5f3ed298c3656c784206670_127.png)

![](img/0513879ef5f3ed298c3656c784206670_129.png)

![](img/0513879ef5f3ed298c3656c784206670_131.png)

![](img/0513879ef5f3ed298c3656c784206670_133.png)

## 密码修改逻辑漏洞挖掘
接着我们来看一下密码修改的逻辑漏洞挖掘。

![](img/0513879ef5f3ed298c3656c784206670_135.png)

![](img/0513879ef5f3ed298c3656c784206670_136.png)

![](img/0513879ef5f3ed298c3656c784206670_138.png)

密码修改一般需要旧密码。以下是测试思路：

![](img/0513879ef5f3ed298c3656c784206670_140.png)

![](img/0513879ef5f3ed298c3656c784206670_142.png)

1.  **尝试不输入旧密码**：在修改密码提交时，抓包尝试删除旧密码参数，然后提交。
2.  **检查旧密码输入处是否存在SQL注入**。
3.  **尝试跳过输入旧密码的步骤**：直接尝试访问修改新密码的页面或接口。
4.  **修改用户身份标识**：在提交的修改密码数据包中，通常包含用户身份信息（如用户ID、用户名）。尝试修改这个身份标识为其他用户，看是否能成功修改他人密码。

![](img/0513879ef5f3ed298c3656c784206670_144.png)

![](img/0513879ef5f3ed298c3656c784206670_146.png)

以下是挖掘密码修改/找回漏洞的一般流程：

![](img/0513879ef5f3ed298c3656c784206670_148.png)

![](img/0513879ef5f3ed298c3656c784206670_150.png)

1.  首先走一遍正常的密码修改/找回流程，保存过程中所有的数据包。
2.  分析流程中哪些步骤使用了哪些身份认证信息和认证方法。
3.  分析哪个步骤可以跳过，或者可以直接访问某个步骤。
4.  分析每个认证方法是否存在缺陷，是否可以越权。
5.  尝试不同的找回方式，如邮箱、手机、密码提示问题等。
6.  分析各种找回机制所采用的验证手段，如验证码的有效期、生成规律、是否与用户信息相关等。
7.  抓取修改密码步骤的所有数据包，尝试修改关键信息，如用户名、用户ID、邮箱、手机号等。

![](img/0513879ef5f3ed298c3656c784206670_152.png)

![](img/0513879ef5f3ed298c3656c784206670_154.png)

![](img/0513879ef5f3ed298c3656c784206670_155.png)

详细的案例可以参考我整理的资料。由于时间有限，这些案例不在此赘述，我们后续会单独用一节课在本地环境给大家演示。

![](img/0513879ef5f3ed298c3656c784206670_157.png)

![](img/0513879ef5f3ed298c3656c784206670_158.png)

![](img/0513879ef5f3ed298c3656c784206670_160.png)

## 总结
本节课中，我们一起学习了逻辑漏洞与越权漏洞的基本概念。我们了解到，逻辑漏洞和越权漏洞（包括平行越权和垂直越权）是业务设计缺陷导致的安全问题，无法被自动化工具有效发现，必须依靠手工测试。我们分析了这些漏洞的常见场景，如支付、密码修改/找回等，并学习了初步的挖掘思路和方法，包括修改参数、绕过步骤、暴力破解等。最后，我们强调通过研究历史案例和搭建环境实践是掌握这类漏洞挖掘的关键。下节课我们将进行实际操作演示。