# iæ˜¥ç§‹é›¶åŸºç¡€å…¥é—¨Androidé€†å‘ - P33ï¼šè¯¾æ—¶8 Androidæºç å®šåˆ¶æ·»åŠ ååè°ƒè¯•æœºåˆ¶ ğŸ› ï¸

![](img/5cd985d13ae587f697c0b10e27029da1_1.png)

![](img/5cd985d13ae587f697c0b10e27029da1_2.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•é€šè¿‡ä¿®æ”¹Androidå†…æ ¸æºç ï¼Œæ¥æ·»åŠ ååè°ƒè¯•æœºåˆ¶ï¼Œä»è€Œç»•è¿‡åº”ç”¨ç¨‹åºå¯¹è°ƒè¯•çŠ¶æ€çš„æ£€æµ‹ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_4.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†åº”ç”¨ç¨‹åºå¦‚ä½•é€šè¿‡æ£€æµ‹`/proc`æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç‰¹å®šæ–‡ä»¶ï¼ˆå¦‚`status`å’Œ`stat`ï¼‰æ¥å‘ç°è°ƒè¯•å™¨ã€‚æœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä»ç³»ç»Ÿå±‚é¢ä¿®æ”¹è¿™äº›æ–‡ä»¶çš„è¾“å‡ºå†…å®¹ï¼Œä½¿å…¶æ— æ³•æš´éœ²è°ƒè¯•ä¿¡æ¯ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_6.png)

## å†…æ ¸æºç ç»“æ„æ¦‚è¿°

Androidç³»ç»Ÿç¼–è¯‘åˆ†ä¸ºå†…æ ¸ç¼–è¯‘å’Œç³»ç»Ÿæœ¬èº«ç¼–è¯‘ä¸¤éƒ¨åˆ†ã€‚æœ¬æ¬¡ä¿®æ”¹ä¸»è¦é’ˆå¯¹å†…æ ¸éƒ¨åˆ†ã€‚å†…æ ¸æºç çš„ç»“æ„ä¸Linuxå†…æ ¸ç±»ä¼¼ï¼Œä¸è¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿï¼ˆ`procfs`ï¼‰ç›¸å…³çš„ä»£ç ä½äº`fs/proc`ç›®å½•ä¸‹ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_8.png)

![](img/5cd985d13ae587f697c0b10e27029da1_9.png)

## å®šä½å…³é”®ä¿®æ”¹ç‚¹

æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ç”Ÿæˆ`/proc/[pid]/status`å’Œ`/proc/[pid]/stat`æ–‡ä»¶çš„æºç ä½ç½®ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_11.png)

ä»¥ä¸‹æ˜¯å…³é”®æ­¥éª¤ï¼š

![](img/5cd985d13ae587f697c0b10e27029da1_13.png)

![](img/5cd985d13ae587f697c0b10e27029da1_15.png)

![](img/5cd985d13ae587f697c0b10e27029da1_17.png)

![](img/5cd985d13ae587f697c0b10e27029da1_19.png)

1.  **å¯¼å…¥å†…æ ¸æºç **ï¼šä½¿ç”¨IDEï¼ˆå¦‚CLionã€Eclipseç­‰ï¼‰å¯¼å…¥æ•´ä¸ªå†…æ ¸æºç å·¥ç¨‹ï¼Œä¾¿äºåˆ†æå’Œæœç´¢ã€‚
2.  **å®šä½procæ–‡ä»¶ç³»ç»Ÿ**ï¼šæ ¸å¿ƒä»£ç åœ¨`fs/proc`ç›®å½•ä¸­ã€‚`base.c`æ–‡ä»¶æ˜¯è®¸å¤šprocæ–‡ä»¶æ“ä½œçš„å…¥å£ã€‚
3.  **æŸ¥æ‰¾statusæ–‡ä»¶ç”Ÿæˆå‡½æ•°**ï¼šåœ¨`base.c`ä¸­æœç´¢`status`ï¼Œå¯ä»¥æ‰¾åˆ°å…¶å¯¹åº”çš„æ“ä½œå‡½æ•°ï¼Œä¾‹å¦‚`proc_pid_status`ã€‚
4.  **åˆ†æstatæ–‡ä»¶ç”Ÿæˆå‡½æ•°**ï¼šåŒæ ·ï¼Œåœ¨`base.c`æˆ–ç›¸å…³æ–‡ä»¶ä¸­æ‰¾åˆ°`stat`æ–‡ä»¶çš„ç”Ÿæˆå‡½æ•°ï¼Œå¦‚`proc_pid_stat`ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_21.png)

## ä¿®æ”¹statusæ–‡ä»¶å†…å®¹

![](img/5cd985d13ae587f697c0b10e27029da1_22.png)

![](img/5cd985d13ae587f697c0b10e27029da1_23.png)

![](img/5cd985d13ae587f697c0b10e27029da1_25.png)

`/proc/[pid]/status`æ–‡ä»¶åŒ…å«äº†è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ï¼Œå…¶ä¸­`State`å­—æ®µå’Œ`TracerPid`å­—æ®µæ˜¯åè°ƒè¯•æ£€æµ‹çš„é‡ç‚¹ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_27.png)

ä»¥ä¸‹æ˜¯éœ€è¦ä¿®æ”¹çš„æ ¸å¿ƒéƒ¨åˆ†ï¼š

![](img/5cd985d13ae587f697c0b10e27029da1_29.png)

![](img/5cd985d13ae587f697c0b10e27029da1_31.png)

*   **ä¿®æ”¹è¿›ç¨‹çŠ¶æ€å­—æ®µ**ï¼šå½“è¿›ç¨‹è¢«è°ƒè¯•æ—¶ï¼Œå…¶`State`å­—æ®µä¼šæ˜¾ç¤ºä¸º`t`ï¼ˆtracing stopï¼‰æˆ–`T`ï¼ˆstoppedï¼‰ã€‚æˆ‘ä»¬éœ€è¦å°†å…¶ä¿®æ”¹ä¸º`S`ï¼ˆsleepingï¼‰ã€‚
    *   **å®šä½**ï¼šåœ¨`fs/proc/array.c`æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°`task_state_array`æ•°ç»„ã€‚
    *   **ä¿®æ”¹**ï¼šå°†è¯¥æ•°ç»„ä¸­ç´¢å¼•ä¸º4ï¼ˆå¯¹åº”`t`ï¼‰å’Œ8ï¼ˆå¯¹åº”`T`ï¼‰çš„å…ƒç´ å€¼ä»`"t"`å’Œ`"T"`éƒ½æ”¹ä¸º`"S"`ã€‚
    *   **ä»£ç ç¤ºä¾‹**ï¼š
        ```c
        // ä¿®æ”¹å‰
        static const char * const task_state_array[] = {
            "R (running)",        /*   0 */
            "S (sleeping)",       /*   1 */
            "D (disk sleep)",     /*   2 */
            "T (stopped)",        /*   4 */ // éœ€è¦ä¿®æ”¹
            "t (tracing stop)",   /*   8 */ // éœ€è¦ä¿®æ”¹
            ...
        };
        // ä¿®æ”¹å
        static const char * const task_state_array[] = {
            "R (running)",        /*   0 */
            "S (sleeping)",       /*   1 */
            "D (disk sleep)",     /*   2 */
            "S (sleeping)",       /*   4 */ // å·²ä¿®æ”¹
            "S (sleeping)",       /*   8 */ // å·²ä¿®æ”¹
            ...
        };
        ```

*   **ä¿®æ”¹è°ƒè¯•è¿›ç¨‹PIDå­—æ®µ**ï¼š`TracerPid`å­—æ®µè®°å½•äº†è°ƒè¯•è¯¥è¿›ç¨‹çš„è°ƒè¯•å™¨PIDã€‚æˆ‘ä»¬éœ€è¦è®©å…¶å§‹ç»ˆè¿”å›0ã€‚
    *   **å®šä½**ï¼šåœ¨`proc_pid_status`å‡½æ•°ï¼ˆé€šå¸¸åœ¨`fs/proc/array.c`ï¼‰ä¸­ï¼Œæ‰¾åˆ°æ ¼å¼åŒ–è¾“å‡º`TracerPid`çš„ä»£ç è¡Œã€‚
    *   **ä¿®æ”¹**ï¼šå°†ä¼ å…¥æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„`tracer pid`å‚æ•°å€¼å¼ºåˆ¶æ”¹ä¸º0ã€‚
    *   **ä»£ç ç¤ºä¾‹**ï¼š
        ```c
        // ä¿®æ”¹å‰ï¼Œseq_printfå¯èƒ½ä¼šä½¿ç”¨task->ptrace_leaderç­‰çœŸå®å€¼
        seq_printf(m, "TracerPid:\t%d\n", task->pid);
        // ä¿®æ”¹åï¼Œç›´æ¥è¾“å‡º0
        seq_printf(m, "TracerPid:\t0\n");
        ```

![](img/5cd985d13ae587f697c0b10e27029da1_33.png)

![](img/5cd985d13ae587f697c0b10e27029da1_34.png)

![](img/5cd985d13ae587f697c0b10e27029da1_36.png)

## ä¿®æ”¹statæ–‡ä»¶å†…å®¹

![](img/5cd985d13ae587f697c0b10e27029da1_38.png)

`/proc/[pid]/stat`æ–‡ä»¶ä»¥æ›´ç´§å‡‘çš„æ ¼å¼å­˜æ”¾ç±»ä¼¼ä¿¡æ¯ï¼Œå…¶ç¬¬ä¸‰ä¸ªå­—æ®µå°±æ˜¯è¿›ç¨‹çŠ¶æ€ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_40.png)

![](img/5cd985d13ae587f697c0b10e27029da1_42.png)

ä»¥ä¸‹æ˜¯éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼š

![](img/5cd985d13ae587f697c0b10e27029da1_44.png)

![](img/5cd985d13ae587f697c0b10e27029da1_46.png)

*   **ä¿®æ”¹è¿›ç¨‹çŠ¶æ€å­—æ®µ**ï¼šä¸`status`æ–‡ä»¶åŒç†ï¼Œéœ€è¦å°†è¡¨ç¤ºè°ƒè¯•çŠ¶æ€çš„å­—ç¬¦`t`æˆ–`T`æ”¹ä¸º`S`ã€‚
    *   **å®šä½**ï¼šåœ¨ç”Ÿæˆ`stat`æ–‡ä»¶çš„å‡½æ•°ï¼ˆå¦‚`do_task_stat`ï¼‰ä¸­ï¼Œä¼šè°ƒç”¨`get_task_state`æ¥è·å–çŠ¶æ€å­—ç¬¦ä¸²ã€‚
    *   **åŸç†**ï¼š`get_task_state`å‡½æ•°æ­£æ˜¯ä»æˆ‘ä»¬ä¸Šé¢ä¿®æ”¹è¿‡çš„`task_state_array`æ•°ç»„ä¸­å–å€¼ã€‚å› æ­¤ï¼Œä¿®æ”¹äº†æ•°ç»„åï¼Œ`stat`æ–‡ä»¶çš„çŠ¶æ€å­—æ®µä¹Ÿä¼šè‡ªåŠ¨å˜ä¸º`S`ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_48.png)

## å…¶ä»–å¯èƒ½çš„ä¿®æ”¹ç‚¹

![](img/5cd985d13ae587f697c0b10e27029da1_50.png)

![](img/5cd985d13ae587f697c0b10e27029da1_52.png)

æŸäº›åè°ƒè¯•æ–¹æ¡ˆå¯èƒ½ä¼šæ£€æµ‹`/proc/[pid]/wchan`æ–‡ä»¶ï¼ˆæ˜¾ç¤ºè¿›ç¨‹å½“å‰åœ¨å“ªä¸ªå†…æ ¸å‡½æ•°ä¸­â€œç¡çœ â€ï¼‰ã€‚å½“è¢«è°ƒè¯•æ—¶ï¼Œæ­¤æ–‡ä»¶å†…å®¹å¯èƒ½å˜ä¸º`ptrace_stop`ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_54.png)

ä»¥ä¸‹æ˜¯ä¿®æ”¹æ–¹æ³•ï¼š

![](img/5cd985d13ae587f697c0b10e27029da1_56.png)

![](img/5cd985d13ae587f697c0b10e27029da1_58.png)

*   **å®šä½**ï¼šåœ¨`fs/proc/base.c`æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°`proc_pid_wchan`å‡½æ•°ã€‚
*   **ä¿®æ”¹**ï¼šåœ¨å‡½æ•°ä¸­ï¼Œåˆ¤æ–­å¦‚æœå½“å‰è¿›ç¨‹å¤„äºè¢«è·Ÿè¸ªï¼ˆ`ptrace`ï¼‰çŠ¶æ€ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²æˆ–æ— å…³å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯çœŸå®çš„`wchan`ä¿¡æ¯ã€‚
    *   **ä»£ç ç¤ºä¾‹**ï¼š
        ```c
        static int proc_pid_wchan(struct seq_file *m, struct pid_namespace *ns,
                                  struct pid *pid, struct task_struct *task)
        {
            // æ·»åŠ åˆ¤æ–­ï¼šå¦‚æœè¿›ç¨‹è¢«ptraceè·Ÿè¸ªï¼Œåˆ™è¾“å‡ºç©ºå€¼
            if (task->ptrace) {
                seq_putc(m, '0');
                return 0;
            }
            // ... åŸæœ‰çš„wchanæŸ¥è¯¢é€»è¾‘ ...
        }
        ```

![](img/5cd985d13ae587f697c0b10e27029da1_60.png)

![](img/5cd985d13ae587f697c0b10e27029da1_62.png)

## ç¼–è¯‘ä¸æµ‹è¯•

![](img/5cd985d13ae587f697c0b10e27029da1_64.png)

![](img/5cd985d13ae587f697c0b10e27029da1_66.png)

å®Œæˆä¸Šè¿°æºç ä¿®æ”¹åï¼Œéœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸å¹¶åˆ·å…¥è®¾å¤‡ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_68.png)

![](img/5cd985d13ae587f697c0b10e27029da1_69.png)

ä»¥ä¸‹æ˜¯æ“ä½œæµç¨‹ï¼š

![](img/5cd985d13ae587f697c0b10e27029da1_71.png)

1.  æŒ‰ç…§å†…æ ¸ç¼–è¯‘æ ‡å‡†æµç¨‹ï¼Œç¼–è¯‘ç”Ÿæˆæ–°çš„å†…æ ¸é•œåƒï¼ˆå¦‚`zImage`æˆ–`boot.img`ï¼‰ã€‚
2.  å°†æ–°å†…æ ¸åˆ·å…¥Androidè®¾å¤‡æˆ–æ¨¡æ‹Ÿå™¨ã€‚å¯ä»¥ä½¿ç”¨`fastboot flash boot boot.img`å‘½ä»¤ã€‚
3.  é‡å¯è®¾å¤‡ï¼Œä½¿æ–°å†…æ ¸ç”Ÿæ•ˆã€‚
4.  æµ‹è¯•ï¼šä½¿ç”¨è°ƒè¯•å™¨ï¼ˆå¦‚`gdbserver`+`IDA Pro`ï¼‰é™„åŠ ä¸Šä¸€èŠ‚è¯¾ä¸­å…·æœ‰åè°ƒè¯•åŠŸèƒ½çš„ç¤ºä¾‹APKã€‚æ­¤æ—¶ï¼Œåº”ç”¨ç¨‹åºåº”æ— æ³•æ£€æµ‹åˆ°è°ƒè¯•å™¨çš„å­˜åœ¨ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_73.png)

![](img/5cd985d13ae587f697c0b10e27029da1_74.png)

![](img/5cd985d13ae587f697c0b10e27029da1_76.png)

**æ³¨æ„**ï¼šç›´æ¥åˆ·æ–°å†…æ ¸å­˜åœ¨é£é™©ï¼Œå»ºè®®åœ¨æ¨¡æ‹Ÿå™¨æˆ–ä¸“ç”¨æµ‹è¯•è®¾å¤‡ä¸Šè¿›è¡Œã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_77.png)

![](img/5cd985d13ae587f697c0b10e27029da1_79.png)

![](img/5cd985d13ae587f697c0b10e27029da1_80.png)

![](img/5cd985d13ae587f697c0b10e27029da1_82.png)

![](img/5cd985d13ae587f697c0b10e27029da1_83.png)

![](img/5cd985d13ae587f697c0b10e27029da1_84.png)

## æ€»ç»“

![](img/5cd985d13ae587f697c0b10e27029da1_86.png)

![](img/5cd985d13ae587f697c0b10e27029da1_88.png)

![](img/5cd985d13ae587f697c0b10e27029da1_89.png)

![](img/5cd985d13ae587f697c0b10e27029da1_91.png)

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†å¦‚ä½•é€šè¿‡ä¿®æ”¹Androidå†…æ ¸æºç æ¥å®ç°ååè°ƒè¯•æœºåˆ¶ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_93.png)

![](img/5cd985d13ae587f697c0b10e27029da1_95.png)

![](img/5cd985d13ae587f697c0b10e27029da1_96.png)

![](img/5cd985d13ae587f697c0b10e27029da1_98.png)

æˆ‘ä»¬ä¸»è¦å®Œæˆäº†ä»¥ä¸‹æ ¸å¿ƒä¿®æ”¹ï¼š
1.  åœ¨`task_state_array`ä¸­å°†è°ƒè¯•çŠ¶æ€`t`å’Œ`T`æ›¿æ¢ä¸ºç¡çœ çŠ¶æ€`S`ã€‚
2.  åœ¨è¾“å‡º`status`æ–‡ä»¶æ—¶ï¼Œå°†`TracerPid`å­—æ®µå›ºå®šä¸º0ã€‚
3.  å¯é€‰åœ°ï¼Œä¿®æ”¹äº†`wchan`æ–‡ä»¶çš„è¾“å‡ºä»¥éšè—`ptrace_stop`ä¿¡æ¯ã€‚

![](img/5cd985d13ae587f697c0b10e27029da1_100.png)

![](img/5cd985d13ae587f697c0b10e27029da1_102.png)

è¿™äº›ä¿®æ”¹ä»ç³»ç»Ÿå±‚é¢æ¬ºéª—äº†é€šè¿‡è¯»å–`/proc`æ–‡ä»¶ç³»ç»Ÿæ¥æ£€æµ‹è°ƒè¯•å™¨çš„åº”ç”¨ç¨‹åºï¼Œä½¿å¾—å¸¸è§„çš„åŸºäº`status`å’Œ`stat`æ–‡ä»¶çš„åè°ƒè¯•æ‰‹æ®µå¤±æ•ˆã€‚é€šè¿‡å®è·µæœ¬è¯¾å†…å®¹ï¼Œä½ å¯ä»¥å®šåˆ¶ä¸€ä¸ªæ›´æœ‰åˆ©äºé€†å‘åˆ†æçš„ç³»ç»Ÿç¯å¢ƒã€‚