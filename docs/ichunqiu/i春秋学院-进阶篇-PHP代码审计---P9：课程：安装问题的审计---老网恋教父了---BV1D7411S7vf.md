# i春秋学院 进阶篇 PHP代码审计 - P9：课程：安装问题的审计 - 老网恋教父了 - BV1D7411S7vf

。大家好，我是vient。这节课给大家带来的是安装问题的审计。本节课有一个内容，就是安装问题的审计啊，我将以安装问题啊进行特定功能定向法的介绍使用。Yeah。嗯，首先我们来了解一下安装问题。啊。

一般PHT的程序都有一个初始的安装功能啊，这个安装功能主要有啊数据库的初始初始化啊。啊，写入一些啊数据库结构啊，初始信息。然后是写配置。啊，填写一些数据库的连接信息等配置。

那么安装问题可能会存在哪些漏洞呢？第一个啊无验证功能。啊，没有验证的功能就可以导致任意重装覆盖。好，第二个呃step跳过限制。哦后某个大型的CMS曾经出过这样的漏洞。他分123的几步。

然后就可以直接跳过。好，第三个就是变量覆盖导致重装。第四个啊判断lock，然后跳转的时候没有efi，没有结束当前进程。他访问请求之后，他就没有结束。他程序就会继续执行下去，但是不返回给我们客户。

我们浏览器呢就啊只显示接收接收跳转后的信息。好，最后两个啊就是解析漏洞以及其他特定功能绕过的漏洞。好，特定功能啊，这个意思就是不同的程序啊，它有不同的安装功能啊，也也有不同的验证功能。

就导致不同的绕过了。

![](img/0ca7da7be87ff1765fee68c763417348_1.png)

那么现在来看代码。

![](img/0ca7da7be87ff1765fee68c763417348_3.png)

首先我们是找到并打开。呃，这个安装文件。I。从头开始往下看，他就是判断。啊，是否存在lock文件？如果存在的话，那就跳转到ind。然后不存在它就继续执行。那么我们这里就很明显就发现了第一个漏洞。

就是啊判断lock后跳转却没有啊进行exit，也没有结束。没有结束的话，就可能导致。我们的重装。那我们看继续往下看重装还可能会导致哪些漏洞的产生。那么他首先是定义一个函数，检查文件文件是否可写。好。

接下来是嗯。显示一些。啊，系统环境的一些信息。各种土建。是否存在？好后是判断目录是否可写。呃，接下来是po post这个判断就是他这个页面接收我们。的输入信息。那么接收的只要有4个。

看到4个pos信息复制。啊，第一个DB hottDB userDB park keeping name。也就是啊地址、用户名、密码以及数据库名。那接下来是啊connect就连接数据库。

我是show database。啊，显示所有数据库的数据库名。啊，系统里面有哪些数据库？好，在判断我们当前输入的这些数据库名是否存在了。啊存在了就结束了，不存在，他就创建继续往下走。那么创建。

这是利用seq语去创建。T you name。好，成功创建之后。嗯。我们可以大概可以看到这是一个配置的文件。的内容。好，复制全部复制到STRten。啊，这里就写入配置信息。啊。

最后是创建啊连选择我们这个数据库。然后去设置字符导入啊int点srcle的内容。啊，就安装成功。那我们再看这里有一个写入文件的功能。那么他写入的内容是否进行过滤啊，是否可控。

我们是否能够写入我们想要的一些内容。那我们继续再往上看。我们前面可以看到它并没有进行过滤DB name。啊，直接就写入了。这个配置文件而且还是PHP文件可以执行的。那们就应可以考虑写入一些执行代码。好。

我们再回到这上面。啊，这里他需要啊成功执行。搜口语句才会往下走，不然就是带啊就停止了。那么我们要考虑的话啊，就是我们构造的语句。要能够啊执行scle，然后就可以写入了文件。好，我们来开始构造。EXP。

啊，这个是数据库名称。好，接下来我们要怎么做呢？首先是。啊。结束掉啊，这个社Q语句啊分号。然后我们用注释。啊，这个是d口语句的一个注释服。我们注释之后就。可以考虑写入一些代码信息。哎，有执行命令。好。

我们再去看compage文件是怎么样子的。那我们主要写入的信息是dabb有数据库名称。那他写入的信息在这一部分。阿没。EXP写在这里。嗯我。啊。这是注饲掉之后呢，我们要怎么。操作完呢。首先我们要。闭合。

就闭合后闭合它的原始的内容。然后。我们要。啊，写入我们的执行代码。我们闭合的话就是。从引号闭合他。啊，还有。分号。结束掉。嗯，闭合它在分号结束掉。啊，写入我们的代码，啊，这里就用PDPin来演示。

好再闭合然后我们这里是写入的内容。然后后面还有一个双引号和根号，那我们就要把它注释掉。那么这一部分。就是我们写入的内容。我们在恢复他原来的模样，因为我们已经找到了。他的。注入的。啊， payload。

Yeah。也就是这样。我们输入的就是这里。我们现在应该去看看我们这一句能不能正确执行，成功写入。

![](img/0ca7da7be87ff1765fee68c763417348_5.png)

哦。啊，没用啊，直接去访问inst。

![](img/0ca7da7be87ff1765fee68c763417348_7.png)

Yeah。很明显，他就跳转到了ind。然后。我们可以用。啊。perfect sweet去抓包。看他能够做到什么信息。行轻。啊，在使用代理。好，再一次inst。我们之后我们做到这样的一句。那我们执行。呃。

跳转到的in。我们看我们抓的。历史数据。好，我们getin我们看它的响应。他完全把这些都响应。响应了，也就是他后面的语句执行了。妈么。我们 say嘿。让他执行后面的语句的。



![](img/0ca7da7be87ff1765fee68c763417348_9.png)

嗯。那么我们在审计的时候啊，其实我们就可以把这个注释掉。让我们获得呃最后postt信息。当然我们可以直接把这些拿出去呃定义一个。HTML。或者是直接post啊这些数据。



![](img/0ca7da7be87ff1765fee68c763417348_11.png)

你再次抓到。啊，先不抓包，我们要获取了数据pos的时候再抓包。

![](img/0ca7da7be87ff1765fee68c763417348_13.png)

嗯，没有保存。好，获取到了这个页面，我们开始抓包，抓包之后再点击安装获取到的它的po包。

![](img/0ca7da7be87ff1765fee68c763417348_15.png)

好，我们把它弄到啊。重放这里。重放最后我们是。呃，先是关掉这个代理。好，我们重放就把刚刚刚刚做好的构造好的配料的拿过来。Db name好，我们数据库名词。EFTA。好，现在我们来。啊。

恢复他前面的那个header。Yeah。好，现在我们来发送pos信息。Okay。好，他这里基本上应该是成功了。



![](img/0ca7da7be87ff1765fee68c763417348_17.png)

我们去看compage文件得load。EFPAA成功写入了PT。我们去访问这个compage。

![](img/0ca7da7be87ff1765fee68c763417348_19.png)

S Y， S6。compage点PDP。

![](img/0ca7da7be87ff1765fee68c763417348_21.png)

嗯，完全执行能够执行我们的。自己的命令了。

![](img/0ca7da7be87ff1765fee68c763417348_23.png)

嗯，们这里再试一下，写入一句话。变成B。啊，这里是。EVal。Post。一。好，们一句话。再次发送。我们再看。



![](img/0ca7da7be87ff1765fee68c763417348_25.png)

成功写出的。我们来测试一下我们的。

![](img/0ca7da7be87ff1765fee68c763417348_27.png)

啊，破产是否有效？一等于什么？我们要咨询一些什么代码呢？选ECHO。D我们输出123。执行。啊，说出了。你知道为什么后面是这些吗？因为我们数据库写入之后，数据库名称是这个，但是我们这里啊填写的就是这个。



![](img/0ca7da7be87ff1765fee68c763417348_29.png)

这是一个。严重的问题。嗯。然后我们成功执行之后，然后他再去连击数据库。比如说我们的sell是可以执行的。



![](img/0ca7da7be87ff1765fee68c763417348_31.png)

前面的123也显示了这里。我们再利用PPIFO。

![](img/0ca7da7be87ff1765fee68c763417348_33.png)

是可以成功执行的。

![](img/0ca7da7be87ff1765fee68c763417348_35.png)

好，那我们现在来开始。加上eect，你就把它修复。我们再去执行。执行。302那放。啊，他就不往下执行了。我们在执行啊结束之前输出一些信息来测试。是否在这里？Fit。看，完全就是修复了。

他在这一步判断已存在的时候。啊，就已经。修复了他不能够往后面执行了。그。啊买。好，接下来是总结。我们的审计思路。啊，也就是特定功能法，我们是直接去找到安装的问题，我们直接去看安装问题。这个就是定向功能。

你就只从安装问题去寻找漏洞。那么他判断loc后面无if没有结束。你就看他的代码，看他重装有什么漏洞。结果我们发现。B啲 name。啊，这里。这个。电量是进入了呃scle语句。能执行的话，他就往下继续啊。

写到了配置文件里面。嗯。这个就是我们最终的思路。那么这节课就讲到这里啊，谢谢大家的观看。

![](img/0ca7da7be87ff1765fee68c763417348_37.png)