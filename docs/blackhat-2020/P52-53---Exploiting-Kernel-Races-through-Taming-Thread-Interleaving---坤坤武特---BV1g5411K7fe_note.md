# P52：53 - 利用内核竞态通过驯服线程交错 - 坤坤武特 - BV1g5411K7fe

![](img/ee05ad14cc1b06a5f41d8953ac490d00_1.png)

## 概述

在本节课中，我们将学习如何通过驯服线程交错来利用内核竞态。我们将探讨 lace 条件、其类型、不可解释性以及如何将其转化为可利用性。

## lace 条件简介

**lace 条件**是一种在多线程开发中常见的缺陷，当多个进程访问相同的内存位置时，由于访问顺序不同，会导致不同的内存状态。**公式**：

```
lace\_condition = (多进程访问相同内存位置) ∧ (访问顺序不同) → (不同内存状态)
```

## lace 条件类型

以下是 lace 条件的几种类型：

1. **单变量 lace 条件**：涉及单个变量的 lace 指令对。
2. **多变量 lace 条件**：涉及多个变量的 lace 指令对。
   - **包含型多变量 lace 条件**：时间窗口 X 包含时间窗口 Y。
   - **非包含型多变量 lace 条件**：时间窗口 X 不包含时间窗口 Y。

## lace 条件的可利用性

某些 lace 条件可能无法通过暴力破解触发，因为它们的执行顺序无法保证。**公式**：

```
不可利用的 lace\_condition = (无法保证执行顺序) ∧ ( lace\_condition )
```

## ESP-LACE 方法

ESP-LACE 是一种新的方法，用于扩展时间窗口，从而将不可利用的 lace 条件转化为可利用性。它利用硬件的基本中断机制，因此不受配置或特定硬件的影响。

**ESP-LACE 工作原理**：

1. 使用系统调用间接发送中断（IPI 和 IRQ）。
2. 通过 TLV 关闭或硬件中断来扩展时间窗口。

## SP-LACE 方法

SP-LACE 是一种利用 ESP-LACE 方法来利用非包含型多变量 lace 条件的技术。

**SP-LACE 工作原理**：

![](img/ee05ad14cc1b06a5f41d8953ac490d00_3.png)

1. 使用 ESP-LACE 扩展时间窗口。
2. 在正确的时间触发中断，从而利用漏洞。

![](img/ee05ad14cc1b06a5f41d8953ac490d00_5.png)

## 总结

在本节课中，我们一起学习了 lace 条件、其类型、不可解释性以及如何将其转化为可利用性。我们介绍了 ESP-LACE 和 SP-LACE 方法，这些方法可以帮助我们利用那些无法通过暴力破解触发的 lace 条件。