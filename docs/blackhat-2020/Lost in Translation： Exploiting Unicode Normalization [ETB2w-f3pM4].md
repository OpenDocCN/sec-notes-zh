# Lost in TranslationÔºö Exploiting Unicode Normalization [ETB2w-f3pM4]

Good morning„ÄÇ making sure everybody can hear me„ÄÇ Okay„ÄÇ welcomeÔºå Thank you for coming to our talk„ÄÇ

 Next two slidesÔºå of courseÔºå I don't really need to cover as much„ÄÇ go that one there we go„ÄÇ

 John covered all this rightÔºå so I don't really need to harp on this„ÄÇ

 but my main thing here is I'm very proud cyberdad as John said„ÄÇ

 because I get to introduce my daughter Isabella„ÄÇ So IsabellaÔºå anything else you wanted to say„ÄÇ

 Hi everyone„ÄÇ My name is Isabella BarnettÔºå Also known as Angel hacker like John said„ÄÇ

 I'm a cybersecurity engineering student and I'm super pleased to be here„ÄÇüòäÔºåAll right„ÄÇ

 so before we dive inÔºå when we're discussingÔºå as we saidÔºå okay„ÄÇ

 how do we do an intro to the problem that we're talking about hereÔºü

 So we want to come up with realworld analogies„ÄÇ So we're assuming most people have probably played telephone game„ÄÇ

 Either when you're a kid or at a party If you haven't ever played it„ÄÇ This is the basic concept„ÄÇ

 somebody comes up with some phrase„ÄÇ they whispered into somebody's ear„ÄÇ

 it slowly goes down the lineÔºå whisper a whisper„ÄÇ And over the course of that„ÄÇ

 either because of omissionsÔºå additions or people wanting to be funny„ÄÇ

 it changes along the way until the end„ÄÇ And then the person at the end saysÔºå ohÔºå here's what I hurt„ÄÇ

 and it's usually something completely different So take that party game concept and then apply it here to the web„ÄÇ

 So it's the web telephone game that we're essentially dealing with„ÄÇ

 Now this is a very rudimentary architecture right there's way more complex stuff happening here„ÄÇ

 But the idea is that same telephone game of you have an end client sending a web request„ÄÇ

 There's multiple different intermediaries or different„ÄÇ

Systems where that data is going to flow through„ÄÇ So in this caseÔºå CdNÔºå that's what I do„ÄÇ

 and then protecting customer apps„ÄÇSo hereÔºå if we goÔºå you knowÔºå with this next flow here„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_1.png)

It's the proliferation of bug downty hunting„ÄÇThat's really changed from my perspective„ÄÇ

 what we look at what we doÔºå different issues that we find„ÄÇ So in this scenarioÔºå right„ÄÇ

 you have a bug hunterÔºå they're sending stuff through and this is where we were kind of correlating or I was putting into different buckets„ÄÇ

 problems that I was seeing sayÔºå heyÔºå we're supposed to block attacks something missed„ÄÇ

 what is this And I started putting them in these buckets and realizingÔºå okay„ÄÇ

 there' are certain commonalities here„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_3.png)

But here againÔºå if we're looking at the flowÔºå you have the different layers where you're doing security detection logic„ÄÇ

 maybe upstream in a CDN inside the applicationÔºå I'm sure there's a bunch of security checks„ÄÇ

 and then the data is used in some way„ÄÇSo going through these security checks„ÄÇ

 well then when data is being sentÔºå the problem is after those security checks„ÄÇ

 there's something inside these applications that's actually processing and changing and manipulating data„ÄÇ

 and it turns it from something that at that point was not an attack or malicious into something that actually works„ÄÇ

ÂºÄ„ÄÇSo this is a big takeaway if there's like one thing you take away from this talk it's CW 180 when I was putting it into these buckets and thinking„ÄÇ

 okayÔºå what's the commonalityÔºå it's this order of processing problem just like you see here on the screen„ÄÇ

 a security check later on data changes recipe for disaster„ÄÇ

So this is a rough outline of what we're going to talk about for like the next 30 minutes„ÄÇ

 how Isabel and I were working togetherÔºå obviously I got a lot of data where I work„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_5.png)

But then I would group it into these buckets„ÄÇ I would sanitize all this stuff right„ÄÇ

 so I could talk with my daughter about it„ÄÇ And we made these into like research projects„ÄÇ

 And so that's really where Izzy was helping out to do all this analysis„ÄÇ

So we have a QR code here that will take you to these Dojo labs createdÔºå yes„ÄÇ

 we hackCC has this platform where you can create these labs to simulate different process flows„ÄÇ

 so we've created individual labs for the different topics we're going to be talking about and since we don't have time to go over them you can follow this QR code and hack it yourselves„ÄÇ

So first up we're going to go over UniIcode just a little bitÔºå it's a broad topic„ÄÇ

 but first up is internationalizationÔºå it's this process of making sure that code can handle languages from around the world so many different character sets and glyphs that need to be handled by these computers so that they can understand each other and maintain data integrity„ÄÇ

 including things like emojis„ÄÇSo this is a great toolÔºå a UTF8 visualizer by Soar source„ÄÇ

 you can see here in white the Unicode code pointÔºå this is the numeric representation of the Glyph„ÄÇ

 then you have the raw bytesÔºå this is the binary that would be stored in a database or in memory„ÄÇ

And then lastlyÔºå you have the UTF F encoding there at the bottom„ÄÇ

 this is how it's going to be sent over the web in web requests„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_7.png)

Unicode is such a large topic that we don't have time today to cover everything„ÄÇ

 but we wanted to focus on kind of three main key things that are critical to our talk today„ÄÇ

 UniIode represents a wide range of characters and can be multibyte in length„ÄÇ However„ÄÇ

 ASCI on the other handÔºå is a subsetÔºå which is only a single byte represented in seven bits„ÄÇ

 This means it requires less storage space compared UniIode„ÄÇ

 which can be longer and sometimes require more storage space„ÄÇ So the real issues we get into here„ÄÇ

 is how do you maintain this data integrity when you're switching between Uniode and ASI„ÄÇSo first up„ÄÇ

 we have decoding errorsÔºå specifically multibyte awareness that leads us to CWE 172„ÄÇ

 which is encoding errorsÔºå this also includes decoding errors or any sort of issues that you get when you're decoding and you sometimes get incorrect output if text is garbled or not what it originally was„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_9.png)

AgainÔºå with the visualizerÔºå you have the capital letter A an ASI character and then a laptop emoji„ÄÇ

 for exampleÔºå which is multibyte As you can see here„ÄÇ

 the leading bits will signal the character byte length if it is a zero that means it is a single byte character and on the other hand you have four leading ones this means it's four bytes long as you can see there's these different continuation bytes with a one and a0 at the beginning„ÄÇ

 this signals that these bytes are linked it is a part of a single character it's working together to represent it and they can't be separated but what if during processing it is treated as separate bytes if these leading ones are switched to zeros„ÄÇ

 you get something called Mujibake output which is Japanese roughly translates to character mutation So if you change those leading ones to zeros it separates the characters in four different separate characters that have no relation to the original intended input„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_11.png)

I'm sure most of you know what Bp suiteite isÔºå it's a great tool to test web applications„ÄÇ

So let's say we're wanting to input this left angle bracketÔºå it's multibyte„ÄÇ

 so you're going to take the UTF8 encoding at the bottom„ÄÇ

' going to input it into Bps decoder and as you can see„ÄÇ

 Bps decoder is not multibyte aware you get Mojiba output three random unode characters that have no relation to the left angle bracket„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_13.png)

But what we can do is go to the bep store and install decoder ImpÔºå it has UniIcode support„ÄÇ

 it can correctly display these characters because of the Java swing elements„ÄÇAs you can see„ÄÇ

 when using decoder improvedÔºå which is multi byte aware you get the correct decoding and you can see the left angle bracket„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_15.png)

You can also go to the Bp store and get Act Sc plus plus we have made some updates that have been released as of today„ÄÇ

 specifically the suspicious input transformation„ÄÇYou've got a left anchor and a right anchor these are used for taint tracking so that whatever your input is„ÄÇ

 you'll be able to find it reflected back in the output and see if there's been any transformations„ÄÇ

 specifically we want to see if the Greek capital letter alpha has been transformed into two characters„ÄÇ

 Latin capital letter N and device control1Ôºå this is going to be an indicator that whatever decoding is not multi byte aware„ÄÇ

 this could be a potential exploit vector that you could pursue„ÄÇOkay„ÄÇ

 so next subsection here under decoding errors and just highlighting again„ÄÇ

 this is not typical like Unicode stuff that we're talking about„ÄÇ

 but it's important because this is a pipeline processing you got to get this stuff right before you do an A yourR security logic„ÄÇ

 So just making sure we're level sitting there So here it's over long encoding in this case we're referencing KPEC 80 because it's talked specifically about this scenario different UTF8 encodings„ÄÇ

So I love real world analogies as we were discussing what this is it's like as anybody else ever received an Amazon package„ÄÇ

 you open it upÔºå there's a bunch of filler in there packing material and you open and pull out another Amazon package you're like why didn't you just send me this package so needless packaging that's essentially what this is so back to the visualizer here you have the normal capital letter a that we've kind of been talking about single byte right and that leading bit is zero it's only one byte long„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_17.png)

HoweverÔºå you can take that data and forcefully split it into two and do over long encoding„ÄÇ

 in this caseÔºå two bytes„ÄÇ You can do three bys„ÄÇ you can do moreÔºå but we are keeping it basic here„ÄÇ

The scenario isÔºå as Isabella was saying earlierÔºå those bits mean something in those bytes„ÄÇ

 some whole dataÔºå the beginning ones are referencing is this a leading byte is it a continuation byte„ÄÇ

 So if we're going to force it into be two bytes long looking as we can see on the screen there„ÄÇ

 you have to take a piece of data and move it because one byte saying ohÔºå we need a10„ÄÇ

 this is a continuation byÔºå the rest of the data is in the other byte right„ÄÇNow„ÄÇ

 the key here is you're sending that data across„ÄÇ it's still supposed to represent the exact same character„ÄÇ

 What you don't know is how's the application going to respond„ÄÇ

Now early UTFA encoding this was allowedÔºå they changed it say noÔºå no you shouldn't do this„ÄÇ

 there's certainly not good reasons to do thisÔºå it can cause problems as we will show you„ÄÇ

 but is an app going to block itÔºå not let it through most don't like to do that are they going to correctly normalize it back to the ASI character or is it going to be a Moji Bque situation going forward here we'll take a look„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_19.png)

This was something fun for us as well as we were researching„ÄÇ

If you look at those characters at the topÔºå I see some heads nodding„ÄÇYou have a dot„ÄÇ

 a forward slash and a back slash„ÄÇThen then you look at the bottom and you see if it's UTF8 encoded„ÄÇ

Was there anybody doing web security in 2001ÔºüAnd recognizes what this might be in relation to„ÄÇAny„ÄÇ

 anybody can't see what the lights„ÄÇ OkayÔºå this was also referenced in Miko's keynote yesterday when he was talking about slammer and all these different things„ÄÇ

 But we'll show you what it is hereÔºå Nimda„ÄÇSo I was working actually at the time protecting some government websites„ÄÇ

 rightÔºå OhÔºå heyÔºå he's in there„ÄÇ There we go„ÄÇÂóØ„ÄÇThat's funny„ÄÇTrew me upPro the website„ÄÇ

 I saw this coming in„ÄÇ I'm like what the heck is going on here„ÄÇ Fortunatelyly„ÄÇ

 ours weren't running this right so it didn't impact our environment but I had to figure out what was going on So this was using that over long UTFA encoding„ÄÇ

 So it had a problem where there was some security checks looking for dot dot slashes directory traversals„ÄÇ

 It bypassed that then it gets normalized back right and so then it was a problem„ÄÇ

So another example from a tooling perspective likeÔºå okayÔºå that's interesting„ÄÇ

 but how else can this be used todayÔºå So for SQL injections„ÄÇ

 SQL mapap is one of the very popular tools to do this„ÄÇ In this caseÔºå there's tamper scripts„ÄÇ

 all sorts of different ways you can take whatever you wanted to send„ÄÇ

 obfuscate it in some way and see if it bypasses some security logic„ÄÇ And in this case„ÄÇ

 what it's doingÔºå it's taking the ASI space character over long encoding it to two bytes„ÄÇ

 sending it on its way„ÄÇSo here we want to show one example of you know quote unquote security logic and where this is causing the problem„ÄÇ

 So here we're using that rex 101 website and we're able to take that exact same payload we saw pass it in the query string you see up there in the URL bar and then you apply some sort of regular expression against it„ÄÇ

 Now this is very basic but let's say you're looking for select and from and in between there you can have some space characters and then something that's not a space the problem is this does not match right it shows you up in the corner„ÄÇ

 is this redx doesn't match And the question is why and then you look at the bottom and you see the test string„ÄÇ

Now in this caseÔºå this website was not normalizing the over long encoding back and putting in a space„ÄÇ

 kind of amoji boque situations as here's two bytes„ÄÇ

 we can't really represent this so it's putting in a replacement character„ÄÇ

 but the point here is this pipeline„ÄÇYou're supposed to you do URL decoding„ÄÇ

 Then you apply your security check because the decoding was wrong„ÄÇ your check fails„ÄÇ So again„ÄÇ

 take this as just one small example that you can check back at work„ÄÇ

And next up we have bitete truncation„ÄÇAnd our case study for today is going to be a bug hunter who found control line feed injection in Microsoft„ÄÇ

So here you've got the payload and you've got these two charactersÔºå carriage return in linefe„ÄÇ

 UTF8 encodedÔºå but if you submit this as expectedÔºå you get blockedÔºå access denied„ÄÇ

 they understand what you're trying to do„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_21.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_22.png)

But as you can see hereÔºå the attacker has„ÄÇThe two UTF8 characters encodedÔºå sent in„ÄÇ

 And in the responseÔºå you can see that the set cookie header has successfully been injected„ÄÇ

 How did they accomplish this„ÄÇWith a tool cyberberCh we're going to do a URL decocode recipe and as you can see you get these two Chinese characters„ÄÇ

 this is not control line feedÔºå how is this executing what's happeningÔºü



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_24.png)

This is a potential scenario„ÄÇ As in most of these examples„ÄÇ it's a black box„ÄÇ

 We don't know what exactly the web application might be doing or what processing might be happening„ÄÇ

 but this is potentially what could be going on„ÄÇ A bite ordering if they're doing little Indian„ÄÇ

 they're going to take the least significant biteÔºå the one on the right„ÄÇ

 and they're going to store it first„ÄÇ So with that in mindÔºå with the Chinese character„ÄÇ

 you've got a single bite buffer„ÄÇ and then three bites„ÄÇ

 The least significant bite is going to be stored first„ÄÇ

 It fills that buffer and the rest of the bites are discarded„ÄÇ

 So you just have this least significant biteÔºå which happens to be the carriage return„ÄÇ

 This is called bite truncation„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_26.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_27.png)

AgainÔºå with cyberberChÔºå if we apply the Incode text recipeÔºå specifically US ASI 7 bit„ÄÇ

 this is going to mimic what might be happening server side where it's just storing a single bite„ÄÇ

 you're going to get bite truncation and you get control line feed characters right before the set cookie„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_29.png)

Here's a great tool called Shazzar by Gareth Hayes„ÄÇ

 you can input a Hex character and then you get back different UniIode characters that would be truncated to that character„ÄÇ

 it's great for testing„ÄÇAgainÔºå active scan plus plus the PR request between the left and right anchors you have the Hungol symbol„ÄÇ

 if you input that and you get back a left curly bracket„ÄÇ

 this could be an indicator that you could do serverside template injection„ÄÇAll right„ÄÇ

 next up is confusibles„ÄÇGenerally speaking when I was starting to talk with other people about oh„ÄÇ

 what's your talk about and I say oh UnicodeÔºå they immediately think of this confusibles especially when you think about domainpoofing and fishingish and that kind of stuff so we're not really talking about that we're talking about more of these specific web application layer stuff so jumping in here„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_31.png)

Going back to our map scenarioÔºå if you in this case have somebodyÔºå let's say they're in Greece„ÄÇ

 they're sending some dataÔºå Greek charactersÔºå rightÔºå Greek capital letterÔºå alphapha„ÄÇ

 they send it to a website that's only receiving ASCII„ÄÇGeneralized questionÔºå what do you doÔºü

y arere you going to block it„ÄÇ They don't want to do that„ÄÇ So they sayÔºå well„ÄÇ

 I don't have that character„ÄÇ I have something that kind of looks like that character„ÄÇ

 So I'm just going to switch that to this other character„ÄÇ rightÔºå And No Aski kept a letter A„ÄÇ

 that's not going to cause any problemsÔºå right„ÄÇRight„ÄÇSo it's the raised eyebrow here„ÄÇ Of course„ÄÇ

 it's going to cause problems„ÄÇ Otherwise we wouldn't be covering this section normalization forms right from the title again„ÄÇ

 there's four major normalization forms„ÄÇ They do different things„ÄÇ

 They're used for different purposes„ÄÇWe're mainly focusing on the bottom two capability because that's more of a confusible lookalike best fit mapping„ÄÇ

 which we'll talk about here„ÄÇ It is important at the top though„ÄÇ

 to realize when you're doing decomposition and composition Isabel is going to talk about that a little bit later„ÄÇ

 but highlighting here the third row specifically we are showing the one with a circle around it„ÄÇ

 There's a couple different names for it„ÄÇ I call it enclosed alpha numerics„ÄÇ

 I see these a lot and SSRf type of attacks„ÄÇ Anything that's whying you to look at the domain name and try and figure out ways around security filters„ÄÇ

 on the UniIcode websiteÔºå they do have a lot of really good tools„ÄÇ

 If you've never checked out the website please go check these out„ÄÇ

 This is where it's showing you different IA processing for those domain names„ÄÇHere in the field„ÄÇ

 you can see it's kind of highlightedÔºå I was putting in an example of enclosed alpha numers for the loop back IP„ÄÇ

 127001„ÄÇThink back to the red X that we were just doing if you look for 127Ôºå001Ôºå right„ÄÇ

 digits and dotsÔºå this is not going to match„ÄÇBut in the bottom„ÄÇ

 you can see the different types of I a processing that may be there„ÄÇ

 they do get normalized and actual ASI and integer values„ÄÇSo for the next example„ÄÇ

 we wanted to kind of mimic what could be happening„ÄÇSo especially in an SSRF situation„ÄÇ

 you get data from a query string some sort of parameter„ÄÇ

 It's probably going to be called in a subrequest with some sort of web clientÔºå rightÔºå Lib curl„ÄÇ

 something like that makes a subrequest does whatever it's supposed to do„ÄÇ

 So we're just mimicking this behavior here again„ÄÇ You justÔºå you know„ÄÇ

 get at the command prompt using curl„ÄÇ This is mimicking that SSRF scenario„ÄÇ

 And as you can see down on around the fourth line„ÄÇ It does get normalized back to normalÔºå you know„ÄÇ

 ASI textÔºå isn't it resolved correctly to the loop back I„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_33.png)

All rightÔºå so case study timeÔºå it was great againÔºå as we were researching saying„ÄÇ

 how are we actually going explain this stuff because I I can't use my stuff from work at the sanitai So anytime I was seeing stuff that was like oh„ÄÇ

 that's the same topic„ÄÇ It's public information perfect„ÄÇ So this was done by search like Cy in July„ÄÇ

 And it was talking about Unicode normalization issues in dotnet Nuke„ÄÇ

 So we're gonna take a quick quick dive here this is the web request they were using in the example„ÄÇ

üòä„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_35.png)

The only takeaway you really have to have here is down in the bottom„ÄÇ

 This is a post request doing multipart with a file attachment„ÄÇ The key here is the name of the file„ÄÇ

 and specifically the name of the fileÔºå they were doing some UTFiding codingding of Uniiccode characters„ÄÇ

 So keep that in mind„ÄÇ this is where it came from from an attack perspective„ÄÇ

 But now we're going to look at the code„ÄÇOr sorry the payload and see exactly if you do a UTF8D code what does this look like And again we're thinking confusibles here right so in your eyes you're thinking oh yeah„ÄÇ

 those are backslashes and dots no they're not these are different Unicode characters that look similar but a lot of these are the full width versions of their ASI counterparts so those aren't actually backslashes and dots keep that in mind Okay so now we'll look at the code there's a lot of different things in the blog post I suggest you read it fully because it's fantastic We just pulled out a few pieces that were directly related„ÄÇ

üòä„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_37.png)

So here we're talking about a regular expressionÔºå it's checking the file name„ÄÇ

So remember what we just showed on that screenÔºå this redx is looking for ASII dot characters because it says wait a second„ÄÇ

 we want to make sure that dot that's in relation to the extension of the file is the only dot that's allowed if there's any dots before that we want to strip them out„ÄÇ

 get rid of those„ÄÇNowÔºå the problem is at the bottomÔºå as you seeÔºå the grx again„ÄÇ

 that's not going to match„ÄÇThose Arttozaki characters doesn't match„ÄÇ

 So then it moves on to the next section of code„ÄÇNow you're back to C W180 right„ÄÇ

 this reoccurring theme„ÄÇ applyly a security check afterwards„ÄÇ

 let's do what's called best fit mapping in Microsoft„ÄÇ So highlighted at the bottom there„ÄÇ

 this is a code page 1251„ÄÇ So you may be askingÔºå okay„ÄÇ

 what is that So you can actually go on UniIode's website and find these different code pages„ÄÇ

So againÔºå this is similar to the normalization forms„ÄÇ

 but these are direct mappings that Microsoft hasÔºå depending on the code pages you want to use„ÄÇ

But we're highlighting there and if the next screen will show you here specifically that mapping„ÄÇ

 just you knowÔºå this relates back to our payload that we are talking about„ÄÇ

 so that full stop gets translated into the normal ASIs dot character so remember that would have matched the redja„ÄÇ

But now afterft wordsÔºå it gets changed„ÄÇSo at the bottom is the updated payload„ÄÇSo now„ÄÇ

 if you look at the beginning„ÄÇAnd you have those double back slashes„ÄÇ Well„ÄÇ

 then in a Windows environmentÔºå rightÔºå you have an absolute path„ÄÇ

 You're dealing with UN NC and sayingÔºå ohÔºå wait a second„ÄÇThis is a remote server„ÄÇ

 This is a remote host„ÄÇ I can make an outbound connection there„ÄÇ

 And if you look at what that domain name isÔºå OasifyÔºå right„ÄÇ

 you Bt collaborator out of band beening types of domains„ÄÇIf this dotnet nuke is vulnerable„ÄÇ

 it's going to make an outbound connection and it can leak credentials„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_39.png)

And that's actually what they found when they did this right up„ÄÇDue to timeÔºå again„ÄÇ

 we can't dive into all the case studiesÔºå but I did want to reference this from Oranges„ÄÇ

 fantastic researcherÔºå Blackcat yourup TalkÔºå go to the website W„ÄÇfitÔºå it's got great tooling„ÄÇ

 highly suggest if you're interested in this go check it out„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_41.png)

Another utilityÔºå you can go here on the UniIcode websiteÔºå you can put in an ASCI character„ÄÇ

 hit returnÔºå it's going to show you all those different variants of UniIcode characters depending on the normalization form made map back to that„ÄÇ

Al rightÔºå back to active scan plus plus updates„ÄÇ So this is a check generalized to say„ÄÇ

 let's look to see if there's any normalization forms that are happening here„ÄÇ

 It's not specific to anyone„ÄÇ You just want to see if there's something going on„ÄÇ

So you have the same left and right anchorÔºå the same type of processing„ÄÇ

 The key here is what character do you use efficiently to do a quick test„ÄÇ

So what's interesting is the Kelvin timeÔºå it's one of the few that actually under any transformation normalization form will get mapped back to a normal capital letter K and ASI„ÄÇ

 so veryÔºå very useful to quickly test„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_43.png)

So we were mentioning these active scan updatesÔºå but maybe you're getting tired of looking at PRs„ÄÇ

 so we wanted to show this live in action so we're able to run this tool right with the updates that we had„ÄÇ

Active scan says heyÔºå we found a suspect transform problem here„ÄÇ So in this case„ÄÇ

 you're looking at the raw request„ÄÇ But on the right hand side„ÄÇ

 you can see the data right that's that we're sending„ÄÇ

 So you have your left and right anchor in between„ÄÇ you have the UTF8 encoded Kelvin sign„ÄÇ

 and you you it go If you then click over to the response tab„ÄÇ

 We also did render just for you all visually to quickly see what we're talking about„ÄÇ

 you get your left and right anchor and in betweenÔºå indeedÔºå it is now a capital letter K„ÄÇ

 So you knowÔºå there's some sort of normalization happening there„ÄÇ

 And that's the idea right with active scan„ÄÇ It's sayingÔºå hey„ÄÇ

 here's something you need to look deeper into„ÄÇÂñÇ„ÄÇAll right„ÄÇ

 next one casing this is another one that was interesting actually we'll go one more for it when I was looking at this for work„ÄÇ

 I got an example cross hate scripting issue they said heyÔºå this didn't get blockedÔºå what is this„ÄÇ

 what's going on here so it was similar kinds of processing when I was looking but it wasn't fitting into the existing buckets I was already researching so what is going on here„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_45.png)

So taking that data at the bottomÔºå right you have the script tagÔºå so what was happening here„ÄÇ

 this UTF8 character„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_47.png)

RightÔºåAnd it's got a long nameÔºå so I'm actually going to read it Latin small letter dotless eye„ÄÇ

That's not an ASIÔºå rightÔºå so if you end up doing some sort of redja„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_49.png)

And trying to apply thatÔºå if you sayÔºå hey look for less than in a script tagÔºå of course„ÄÇ

 that's not going to match that that's not what that character is„ÄÇ So again„ÄÇ

 we're back to this common theme„ÄÇ But the question isÔºå why did it turn into a script or the I„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_51.png)

So now you get into these casing charts rightÔºå So you have case foldingÔºå you have lowercase„ÄÇ

 uppercaseÔºå title caseÔºå there's all these different combinations„ÄÇ

 So it depends on exactly what language you're using in processing here„ÄÇ But think about this„ÄÇ

 especially any bug hunters out there or if you're actually on the application security side„ÄÇ

 Any input that you're getting that you apply an uppercase transform to„ÄÇ

 You probably have reasons to do that that you want to normalize stuff you don't want these collisions with an admin with a capital A and an admin with a low and you can't reconcile„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_53.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_54.png)

But keep in mindÔºå there could be a unicode type of mapping that's associated here„ÄÇ So in this case„ÄÇ

 that dotless eye was getting changed„ÄÇSo here we did a quick just to demo and Python this kind of internal processing„ÄÇ

 So we take that same payloadÔºå we apply a decode to it„ÄÇThen you apply the upper method to it„ÄÇ

 and then we're going to show you both the outputs„ÄÇ So if we hit enter„ÄÇ

 this is the output you get at the top is what it would have been„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_56.png)

It does not execute„ÄÇThe browser is not going to treat that as a script tag„ÄÇ

The problem is that uppercase transform change that character back into the capital letter I„ÄÇ Now„ÄÇ

 hereÔºå the mileage may actually vary„ÄÇ rightÔºå We did a little bit of research looking at this to figure out„ÄÇ

Does this workÔºå WaitÔºå Will this executeÔºå So it depends on the payload that the attacker might want to use in the context that it's in the key takeaway„ÄÇ

 thoughÔºå is„ÄÇIt's changing those letters„ÄÇ And it's turning into something a browser would not execute into something that it might„ÄÇ

 So keep pasing in mind and and look in your application„ÄÇ anytime you're using uppercaseÔºå lowercase„ÄÇ

Check that dataÔºå okay„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_58.png)

There was an update we did here to a different tool this time This tool is called recollapse„ÄÇ

 it's another fantastic tool out there„ÄÇ It was doing similar types of things I had heard of recolllaapse and we were researching different tools to say„ÄÇ

 hey what what can we update and use for this so I worked with the creator of that to add some casing tests as well so this is another way you can do the tool I think we have a screenshot Yeah so as an example there's new flags so you could put this flag on here and say hey„ÄÇ

 here's the end result that I want and itll give you different options to see from a casing perspective if you could use a different character that might map to it so go check out recolllapse that was just updated I think today as well„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_60.png)

ÂèØ‰ª•„ÄÇAnd finallyÔºå best for last we have combining diritics also known as combining characters„ÄÇ

 so if you've got a normalization form that's performing decomposition„ÄÇ

 it will separate this character into two separate code points„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_62.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_63.png)

And for our case studyÔºå we're going to be talking about a zero click account takeover„ÄÇ

So as you can see hereÔºå this would be a normal process flow for a password reset„ÄÇ

 a user would submit their emailÔºå the server would send it onto the database which would perform a check saying is this a valid user„ÄÇ

 if it isÔºå it will send back a token allowing them to reset the password„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_65.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_66.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_67.png)

So let's take a deep dive into the MySQL databaseÔºå let's see what kind of collation they might be doing„ÄÇ

As you can see it's 0900Ôºå that's the Colatlation algorithm versionÔºå and then there's AI and CI„ÄÇ

 which means accent insensitive and case insensitiveÔºå but what exactly does that meanÔºü

That means if you're submitting this lowercase A with an accent and comparing it to the lowercase A in the uppercase A for both of them„ÄÇ

 you would get trueÔºå the database treats them as equivalent characters„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_69.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_70.png)

On the flip sideÔºå you can see if it's accent sensitive and case sensitiveÔºå then of course„ÄÇ

 they will not be true when compared„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_72.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_73.png)

So now here the attacker is going to send in this email with a custom domain that includes a Uniode character how is the database going to treat it„ÄÇ

 it's going to look at this domain and say yesÔºå Latin small letter A with doubleGv is equivalent and absolutely the same as the Latin small letter A„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_75.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_76.png)

So when it receives his email and it's comparing inside the databaseÔºå it says yes„ÄÇ

 this is user@gmail„ÄÇ coÔºå and here's the issue„ÄÇ when it sends back that token„ÄÇ

 it sends it to the user supplied GmailÔºå not what was stored in the database„ÄÇ Therefore„ÄÇ

 the attacker now has a reset token for somebody else's password„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_78.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_79.png)

Here's a collation chart on the UniIcode page which demonstrates how the lowercase A can be collated and equivalent to all these other UniIcode versions„ÄÇ

And then for our final case studyÔºå XSSE has a really cool lab that we're going to take a look at„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_81.png)

In the top URL barÔºå you can see there's the name parameter„ÄÇ

 We're just inputting a placeholder Uniiccode characterÔºå something with an accent„ÄÇ

 And you can see in the text areaÔºå it is properly rendered back„ÄÇ

 that can clue us in that some kind of normalization composition is happening here„ÄÇ

 and it might be vulnerable„ÄÇ If you take a look in the HTML source code down at the bottom here„ÄÇ

 you can see that it is a container elementÔºå which means that our input„ÄÇ

 our parameter input is in between two text area tags„ÄÇ

 And as you can see it is right next to that greater than symbol positioned very conveniently„ÄÇ

 So we can exploit it„ÄÇ

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_83.png)

![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_84.png)

On the backend server sideÔºå it's got free marker and you can see that our input is being concatenated with that text area tag and then all of it is together normalized„ÄÇ

 so our goal here is to how can we modify and change that greater than a symbol„ÄÇ

So we've got this Python script that's going to be cycling through different characters„ÄÇ

 they're being concatenated with the greater than symbol and what you're trying to see is how this string would not start with the greater than symbol„ÄÇ

 meaning it would be modified„ÄÇAnd that happens to be this character here„ÄÇ

 which is the combining long solds overlayÔºå a combining character„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_86.png)

So when the greater than symbol is concatenated with this combining long soness overlay„ÄÇ

 you get the not greater than symbol„ÄÇ This means that you' are effectively changing that character entirely into a different code point„ÄÇ

So you're going to take the combined W sosÔºå you're going to UTFA encode it and place it at the beginning of the name parameter„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_88.png)

This is a fun little thing we noticedÔºå not super critical to this„ÄÇ

 but it combines with the equal symbol in the URL bar making it not equals„ÄÇ

 which is just a nice visual way to see that the browser is performing this composition„ÄÇ

But when you submit the payloadÔºå you can see that it is modifying the greater than symbol into a not greater than you have broken the context of that text area tag„ÄÇ

 you've injected an onfocus alert event handler and the alert pop up„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_90.png)

And boomÔºå crossite scripting performed„ÄÇNice„ÄÇAnd then againÔºå we've updated Actcan++ to look for this„ÄÇ

 this time you're only having the right anchor because you don't want a left anchor„ÄÇ

 you want it to be able to combine with the greater than symbol before it and you're trying to get the not greater than symbol that would be a hint that there's some form of composition happening and it's potentially exploitable„ÄÇ

All rightÔºå so to wrap upÔºå I've got the sound bites got to make sure you have those takeaways„ÄÇ

 so it should be clear now the very first one that was that CWE 180 again„ÄÇ

 that's the number one thing„ÄÇIf you're going back and checking your apps„ÄÇ

 you got to find everywhere that this may be a problem right because we gave lots of examples of how it can be„ÄÇ

Also mentioning validating that URL decoding againÔºå that's not really Unicode normalization„ÄÇ

 but it's your entire pipeline right if you get it wrong at the beginning„ÄÇ

 it's going to impact everything else„ÄÇAnd then also just normalization forms that are in use„ÄÇ

 figuring out what you haveÔºå ensure that it's consistent with however you want to process that data„ÄÇ

 but obviously what we're showing hereÔºå it's most problematic if you're converting stuff into ASII and some of the kind of harder parts here is when applications do stuff kind of natively that you weren't thinking of like you maybe know oh yeah we're handling generally normalization in unicord unode this way„ÄÇ

 but as we are showing there's some built-in thirdpart libraries that may be doing something that you're not aware of and that's the hard part„ÄÇ

 So again that's why we were trying to update the tooling to help you go ferret out these different scenarios„ÄÇ

 say wait I got weird going on hereÔºå let's go check it So for both defenders bug hunters hopefully this information was useful go forth„ÄÇ

 find uncode problems and get those corrected with that we will we have a few minutes left I guess we can open up if there are any questions we'll go from there„ÄÇ



![](img/8ed1dc8bacc61f39b2090cdcd6e32f17_92.png)

So thank you for comingÔºåAnd if there are no questions orÔºå you know„ÄÇ

 you want to talk to us after the fact we are going to go to that wrap up roomÔºå so feel free„ÄÇ

So thank you„ÄÇ Thanks againÔºå okay„ÄÇ