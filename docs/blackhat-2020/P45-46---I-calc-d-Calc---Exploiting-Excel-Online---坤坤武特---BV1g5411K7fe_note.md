![](img/1aae56d9a293b362963edf117fa77443_1.png)

# P45：46 - I calc'd Calc - Exploiting Excel Online - 坤坤武特 - BV1g5411K7fe

## 概述

在本节课中，我们将学习如何利用Excel在线服务中的漏洞。我们将探讨Office在线服务器的工作原理，以及如何利用Excel公式进行攻击。

## Office漏洞

在微软的MSRC工作，可以看到大量的漏洞。近年来，针对Office核心功能的漏洞相对较少。例如，五年前，一些针对Office EPS解析器的漏洞引起了人们的关注。

## Office在线

Office在线服务器是一个IS服务器，Excel在线是其中的一个服务。如果桌面Excel存在漏洞，那么很可能也会影响在线服务器。

## 漏洞挖掘

为了找到Excel在线的漏洞，我们可以使用fuzzer进行测试。Excel拥有超过200个公式，我们可以通过查找公式中的漏洞来进行攻击。

## 漏洞利用

我们找到了一个名为FM concatenate的公式，该公式在2015年添加了对三维引用的支持。通过构造一个特定的公式，我们可以触发一个访问违规或写入违规。

## 漏洞利用细节

1. **堆溢出**：通过构造公式，我们可以触发堆溢出，从而控制堆栈。
2. **内存泄漏**：Excel存储字符串时，会在计数器后跟字符串本身。我们可以通过覆盖计数器来读取字符串边界之外的数据。
3. **读取原始数据**：我们可以使用字符串函数来操作这些指针，从而读取Excel服务器中的数据。

## 漏洞利用示例

![](img/1aae56d9a293b362963edf117fa77443_3.png)

1. **喷洒堆栈**：在堆栈上创建一些空槽，以便稍后填充并触发漏洞。
2. **触发漏洞**：构造一个公式，使其触发漏洞并显示异常字符。
3. **读取V表**：通过构造公式，我们可以读取V表中的数据。
4. **触发执行**：通过调整图表的大小，我们可以触发执行并执行恶意代码。

![](img/1aae56d9a293b362963edf117fa77443_5.png)

## 总结

在本节课中，我们一起学习了如何利用Excel在线服务中的漏洞。通过构造特定的公式，我们可以触发漏洞并执行恶意代码。希望这节课对您有所帮助。