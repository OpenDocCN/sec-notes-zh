![](img/f2816595a5d6b02700d9a0ca3e489284_1.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_3.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_5.png)

# P31：32 - 检测访问令牌操纵 - 坤坤武特 - BV1g5411K7fe

![](img/f2816595a5d6b02700d9a0ca3e489284_7.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_9.png)

## 概述

在本节课中，我们将学习如何检测访问令牌操纵。我们将探讨Windows环境中访问令牌的工作原理，以及攻击者如何滥用合法的Windows功能来攻击整个域。我们将通过展示攻击和防御的技巧，帮助防御者了解检测和响应此类攻击的能力。

![](img/f2816595a5d6b02700d9a0ca3e489284_11.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_13.png)

## Windows安全内部机制

![](img/f2816595a5d6b02700d9a0ca3e489284_15.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_17.png)

### 登录会话与访问令牌的关系

![](img/f2816595a5d6b02700d9a0ca3e489284_19.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_21.png)

- 登录会话表示用户在机器上的存在，开始于用户成功认证，结束于用户注销。
- 访问令牌与登录会话相关联，但每个访问令牌只能与一个登录会话相关联。
- 访问令牌充当登录会话的代理或扩展，用于确定用户的安全上下文。

![](img/f2816595a5d6b02700d9a0ca3e489284_23.png)

### 网络身份验证

![](img/f2816595a5d6b02700d9a0ca3e489284_25.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_27.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_29.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_31.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_33.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_35.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_37.png)

- 在域环境中，客户端无法将令牌发送到网络，因为服务器无法验证令牌的真实性。
- Windows会自动缓存凭据，以便在尝试访问资源时进行身份验证。
- 服务器使用登录会话和令牌来执行工作，并强制执行客户端/服务器应用程序中的访问控制。

![](img/f2816595a5d6b02700d9a0ca3e489284_39.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_41.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_43.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_45.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_46.png)

## 攻击者如何滥用访问令牌

![](img/f2816595a5d6b02700d9a0ca3e489284_48.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_50.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_52.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_54.png)

### 使用“仅网络”标志和传递票据攻击

![](img/f2816595a5d6b02700d9a0ca3e489284_56.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_58.png)

- 攻击者可以窃取已登录的特权用户的令牌，并使用该令牌进行横向移动。
- 攻击者可以创建新的登录会话并模拟返回令牌或使用它来创建进程。
- 攻击者可以更改当前登录用户的缓存凭据。

![](img/f2816595a5d6b02700d9a0ca3e489284_60.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_62.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_64.png)

### 越过哈希

![](img/f2816595a5d6b02700d9a0ca3e489284_66.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_68.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_70.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_72.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_74.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_76.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_78.png)

- 攻击者可以将NTLM哈希转换为完整的TGT，并将其注入到Kerberos提供程序中。
- 攻击者可以枚举登录会话，找到适当的位置，并注入新的哈希值。

![](img/f2816595a5d6b02700d9a0ca3e489284_80.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_82.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_84.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_85.png)

## 检测这些攻击

![](img/f2816595a5d6b02700d9a0ca3e489284_87.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_89.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_91.png)

### 使用Freedom框架

![](img/f2816595a5d6b02700d9a0ca3e489284_93.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_95.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_97.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_99.png)

- Freedom框架允许我们在飞行中编写自定义和可脚本化的检测逻辑。
- 我们可以分析函数调用前后的参数，并根据传递给函数的参数或函数返回值做出决策。

![](img/f2816595a5d6b02700d9a0ca3e489284_101.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_103.png)

![](img/f2816595a5d6b02700d9a0ca3e489284_105.png)

### 其他遥测源

- Windows事件日志和进程事件可用于检测“仅网络”登录会话和进程创建信号。
- 可以使用LSA调用身份验证包来检测传递票据攻击。
- 可以使用NTLM信息威胁来检测越过哈希攻击。

![](img/f2816595a5d6b02700d9a0ca3e489284_107.png)

## 总结

在本节课中，我们一起学习了如何检测访问令牌操纵。我们探讨了Windows环境中访问令牌的工作原理，以及攻击者如何滥用合法的Windows功能来攻击整个域。我们通过展示攻击和防御的技巧，帮助防御者了解检测和响应此类攻击的能力。