# 课程P68：第37天 - Windows权限提升：信息收集与内核漏洞提权 🔍

在本节课中，我们将学习Windows系统权限提升的核心概念、信息收集方法以及利用内核漏洞进行提权的技术。课程内容将分为权限提升概述、信息收集、内核漏洞提权以及服务漏洞利用四个主要部分。

## 一、权限提升概述 🎯

权限提升是指攻击者利用安全漏洞，将已获取的受限制低权限用户身份，突破系统限制，提升至高权限的管理员用户，从而获得对整个系统的控制权。

进行权限提升有一个前提：攻击者需要已经获得了目标系统的某种初始访问权限。例如，通过Web服务器漏洞获取的`web shell`权限（如Apache或IIS服务账户），或通过数据库漏洞获取的`mysql`、`sql server`服务账户权限。这些账户通常权限较低，无法访问关键目录或执行特权操作。

提权的目的正是突破这些限制，获取系统管理员权限。在Windows系统中，这通常意味着从普通`User`提升至`Administrator`，甚至更高的`SYSTEM`权限。在Linux系统中，则是从普通用户提升至`root`用户。

### 提权类别

提权主要分为以下几类：

1.  **本地提权**：在已获得的低权限用户环境下，利用系统或应用程序的漏洞，直接提升至系统最高权限。
2.  **远程提权**：通过网络直接利用漏洞，获取远程服务器的管理员权限。

无论是本地还是远程提权，核心都在于发现并利用系统中存在的、可用于提权的漏洞。

### 提权条件

成功提权通常需要满足以下条件：

1.  拥有一个初始的`shell`或普通用户权限。
2.  拥有某些软件或服务的账号密码（这是最直接的方式）。
3.  目标本地或远程服务器上存在可利用的提权漏洞。
4.  拥有针对该漏洞的利用工具或代码。

## 二、Windows提权信息收集 📊

上一节我们介绍了提权的基本概念，本节中我们来看看如何为Windows提权进行信息收集。信息收集是渗透测试的第一步，决定了后续攻击的方向和广度。

首先，我们需要获取一个初始的`meterpreter shell`或类似的低权限访问。这可以通过之前课程中介绍的MSF、CS框架或Web漏洞利用等方式实现。

以下是进行Windows提权信息收集的常用方法和工具。

### 使用WMIC命令行工具

`WMIC`是Windows管理工具的命令行接口，可用于执行系统管理任务，是信息收集的利器。

我们可以通过`wmic /?`查看其帮助信息。例如，要查看系统所有用户账户，可以使用以下命令：

```cmd
wmic useraccount list brief
```

该命令会列出账户类型、域名、SID、全名等简洁信息。

### 使用WMIC信息收集脚本

![](img/31590aa228067565953652604271e9be_1.png)

![](img/31590aa228067565953652604271e9be_2.png)

有现成的脚本可以自动化执行WMIC信息收集。例如`winmsinfo.bat`脚本，它会收集进程、服务、用户账户、网络接口、操作系统、已安装软件、启动程序等信息，并将结果格式化为HTML文件输出。

![](img/31590aa228067565953652604271e9be_4.png)

### 收集系统补丁信息

了解系统已安装的补丁至关重要，这能帮助我们判断哪些漏洞可能未被修复。使用以下命令可以列出所有已安装的补丁：

```cmd
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

![](img/31590aa228067565953652604271e9be_6.png)

![](img/31590aa228067565953652604271e9be_8.png)

我们可以通过`findstr`命令过滤特定的补丁号（如KB编号），以判断对应漏洞是否可利用。

### 收集杀毒软件信息

![](img/31590aa228067565953652604271e9be_10.png)

![](img/31590aa228067565953652604271e9be_11.png)

![](img/31590aa228067565953652604271e9be_13.png)

了解目标安装了哪些杀毒软件，有助于我们规避检测。可以使用以下命令：

```cmd
wmic /namespace:\\root\securitycenter2 path antivirusproduct get displayname,pathToSignedProductExe
```

![](img/31590aa228067565953652604271e9be_15.png)

![](img/31590aa228067565953652604271e9be_17.png)

### 使用SC命令行工具

![](img/31590aa228067565953652604271e9be_19.png)

![](img/31590aa228067565953652604271e9be_21.png)

![](img/31590aa228067565953652604271e9be_23.png)

`SC`是用于与服务控制管理器通信的命令行程序，可以检索和控制系统服务。其功能类似于图形界面中的“服务”管理工具。

![](img/31590aa228067565953652604271e9be_25.png)

![](img/31590aa228067565953652604271e9be_27.png)

例如，要获取所有系统注册服务的状态信息，可以使用：

```cmd
sc query state= all
```

![](img/31590aa228067565953652604271e9be_29.png)

![](img/31590aa228067565953652604271e9be_30.png)

### 自动化信息收集脚本

![](img/31590aa228067565953652604271e9be_32.png)

除了基于WMIC的脚本，还有其他强大的自动化信息收集脚本，例如：

![](img/31590aa228067565953652604271e9be_34.png)

![](img/31590aa228067565953652604271e9be_36.png)

1.  **winPEAS.bat**：这是一个功能全面的提权信息枚举脚本，能检查系统配置、凭证、服务、计划任务、安装的软件、补丁等大量可能用于提权的信息点。
2.  **PowerSploit/PowerUp**：这是一个PowerShell脚本框架，其中的`Invoke-AllChecks`模块可以快速检查常见的错误配置和漏洞，如可写服务路径、AlwaysInstallElevated注册表项等。

执行这些脚本后，仔细分析输出结果，寻找薄弱的配置或已知的漏洞点。

## 三、内核漏洞提权 ⚙️

![](img/31590aa228067565953652604271e9be_38.png)

![](img/31590aa228067565953652604271e9be_40.png)

![](img/31590aa228067565953652604271e9be_42.png)

在完成了详尽的信息收集后，我们就可以进入提权阶段。本节我们将重点介绍利用Windows内核漏洞进行提权的方法。

![](img/31590aa228067565953652604271e9be_44.png)

![](img/31590aa228067565953652604271e9be_46.png)

内核漏洞提权通常涉及操作系统底层的安全缺陷，利用成功可以直接获得`SYSTEM`权限。这类漏洞的利用代码通常以可执行文件（`.exe`）的形式存在。

![](img/31590aa228067565953652604271e9be_48.png)

![](img/31590aa228067565953652604271e9be_50.png)

![](img/31590aa228067565953652604271e9be_51.png)

### 提权流程

一个典型的内核漏洞提权流程如下：

![](img/31590aa228067565953652604271e9be_53.png)

![](img/31590aa228067565953652604271e9be_55.png)

1.  **信息收集**：确定目标系统版本、架构（x86/x64）、已安装补丁。
2.  **漏洞匹配**：根据收集到的信息，在漏洞数据库（如Exploit-DB）或提权辅助脚本（如winPEAS）的建议中，寻找可能适用的内核漏洞。
3.  **上传利用程序**：将对应漏洞的利用程序（例如`MS16-032.exe`, `CVE-2018-8120.exe`）上传到目标机器。
4.  **执行利用**：在获得的`shell`中执行该利用程序。
5.  **获取权限**：利用程序运行后，可能会生成一个新的具有`SYSTEM`权限的`shell`或进程。

![](img/31590aa228067565953652604271e9be_57.png)

![](img/31590aa228067565953652604271e9be_59.png)

![](img/31590aa228067565953652604271e9be_61.png)

### 常用提权工具示例：“烂土豆”（RottenPotato）

![](img/31590aa228067565953652604271e9be_62.png)

![](img/31590aa228067565953652604271e9be_64.png)

![](img/31590aa228067565953652604271e9be_65.png)

“烂土豆”（RottenPotato）及其变种（如JuicyPotato, PrintSpoofer）是经典的提权工具，它们利用了Windows令牌模拟机制中的漏洞。

![](img/31590aa228067565953652604271e9be_67.png)

![](img/31590aa228067565953652604271e9be_69.png)

![](img/31590aa228067565953652604271e9be_71.png)

其核心作用是将一个已有的服务账户权限提升至`SYSTEM`。基本用法是将其上传至目标并执行。如果利用成功，它会在系统中创建一个具有`SYSTEM`权限的令牌（Token）。

![](img/31590aa228067565953652604271e9be_72.png)

![](img/31590aa228067565953652604271e9be_74.png)

![](img/31590aa228067565953652604271e9be_76.png)

### 令牌（Token）窃取与利用

![](img/31590aa228067565953652604271e9be_78.png)

![](img/31590aa228067565953652604271e9be_80.png)

![](img/31590aa228067565953652604271e9be_82.png)

Windows系统使用令牌来标识用户身份和权限。主要有两种类型：
*   **授权令牌（Delegation Token）**：用于交互式登录（如远程桌面登录）。
*   **模拟令牌（Impersonation Token）**：用于非交互式会话（如网络映射驱动器）。

![](img/31590aa228067565953652604271e9be_84.png)

这些令牌在系统重启前会一直存在。在获得初始`shell`后，我们可以尝试窃取系统中已存在的更高权限的令牌。

例如，在Meterpreter中，可以使用`incognito`模块来列举和窃取令牌：

```bash
# 加载incognito模块
load incognito
# 列出所有可用令牌
list_tokens -u
# 窃取SYSTEM令牌
impersonate_token "NT AUTHORITY\\SYSTEM"
```

执行成功后，当前Meterpreter会话的权限就提升到了`SYSTEM`。

“烂土豆”等工具的本质就是通过漏洞创建一个`SYSTEM`令牌，然后我们可以用上述方法窃取并使用它。

## 总结 📝

本节课我们一起学习了Windows系统权限提升的完整路径。

我们首先明确了权限提升的概念和前提条件。然后，深入探讨了如何进行全面的信息收集，包括使用`WMIC`、`SC`命令以及自动化脚本如`winPEAS`来搜集系统版本、补丁、服务、安装软件等关键信息。

接着，我们讲解了如何利用内核漏洞进行提权，介绍了从漏洞匹配、上传利用程序到执行提权的标准流程，并以“烂土豆”为例，阐述了令牌窃取这一核心提权技术。

![](img/31590aa228067565953652604271e9be_86.png)

掌握这些信息收集方法和提权思路，是进行深入系统安全测试的关键一步。请务必在授权环境下进行练习，巩固所学知识。