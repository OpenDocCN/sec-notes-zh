# 郁金香老师C／C++纯干货 - P194：209-外挂控制台相关接口设计(游戏与控制台双向通信)_old - 教到你会 - BV1DS4y1n7qF

![](img/01908eada3ebfe22b12ea122d67a2963_0.png)

大家好，我是郁金香老师，那么这节课我们继续探讨进程间的一个通信数据的传递，那么这节课呢我们主要是通过控制台来获取我们游戏进程的一些数据，当然我们之前的话可以通过一个跨进程的一个啊。

主体呢也能够获取游戏的数据，那么我们现在讨论的主要是这个游戏啊，游戏进程的这个代码与我们的控制台代码进行一个通信，以及数据的一个方，那么我们先来看一个写一段代码来看一个例子。



![](img/01908eada3ebfe22b12ea122d67a2963_2.png)

那么我们首先呢，280克的代码复制一下，在它的基础上我们进行修改，那么首先呢我们从控制台来发送指令到我们的这个游戏进程的代码啊，然后呢游戏进程的代码呢把我们的数据来传递给我们的工作台，大致就是这样的。



![](img/01908eada3ebfe22b12ea122d67a2963_4.png)

那么我们看一下怎么来设计的，那么这里呢我们同样是呃选用了用消息来传递这个数据，那么首先呢我们呃定一个人物结构属性啊，这个呢我们就是返回我们的整个的这个属性的一些数据强势的，那么之前呢我们也有进入这个行。

然后呢我们需要把它的地址啊，这个结构的地址传递给我们一些进程里面的代码。

![](img/01908eada3ebfe22b12ea122d67a2963_6.png)

那么我们再打开200几克的代码。

![](img/01908eada3ebfe22b12ea122d67a2963_8.png)

那么同样的我们的数据呢是在这个控制台接口这个单元来实现，主要我们也是在这个根这个excel不设计这里面来接收我们相应的指定啊，然后呢再来访问我们的数据，那么我们先写发送短。

那么控制台台这一段呢我们主要是通过一个send message消息传递过去，那么上一节课呢我们请了一个新的dt图片，那么我们可以将就啊这个函数来使用。

那么当时呢要是在这里是用的copy代替这个这个消息类型来传递的，那么实际上我们可以另外的定义消息类型呢，可以把它简化一些，那么这节课呢我们就基于了这个top dt来讨来讨论，不谈其他的情况。

今天在这里呢我们也进入一个指令的类型，那么我们就在前面的这个指令的基础上加上一我区分大，然后我们同样的在这里来借助于我们这个copy代替，那这个结构呢来传递我们的数据。

那么其中呢它的这个dw代替了就是相当于疾病的类型，当然我们可以在这个游戏进程的代码里可能对这个类型来进行判断，那么这里呢是它的这个数据环境的一个大小，那么在这里的话我们就是把这个结构的大小。

然后呢在这里呢我们要注意，在这里呢我们是传递它的这个真的一个指针啊，如果是直接把这个指针的地址啊就传进去了，那么直接传传进去的话，他就只能传传送这个结构里面的数据传送过去。

但是呢它本身的地质文化就不能传送过去，那么这一点呢，因为它是把我们的整个结构的这个数据的复制一个拷贝啊，然后呢，相当于是一个备份啊，这样传递给我们的这个游戏进程的代码，那么等会我们通过测试了，你会看到。

那么所以说在这里的话，应当传递进去的是这个，这个结构啊，或者说我们在这里这样写，可能更方便我们理解一些，那么在这里的话size就是就是一个实质阶段，实际实际上就是我们的这个真的一个类型，好的。

那么我们编译生成一下，那么这样的话我们这个结构的地址的话就相当于传送过去的话，那么我们呃接下来的代码呢，我们就是需要在这个游戏进程里面呢对这个指令做一个判断，判断它是这个copy bt之后呢。

我们在这里的话可以用一个switch语句来进行一个判断，那，么这句让我们放在前面，那么这里dw呢将是我们的这个指令的一个，指令的秘诀，那么这里我们做一下了解啊，这里是室外切的结束。

那么在这里呢我们之前的话有一个字串的一个类型在这里，那么这里呢我们把这个类型呢重新定义一下，图文件里，这样复制一下，替换一下，这里边第一个这个指令的类型呢一定要一致啊，后边的数字好。

然后我们再切换到游戏的进程里，再来看一下，那么在这里的话我们就开始进行相关的一个处理，那么这个呢将是我们获取人物信息的这个，那么其他的我们可以呢，这里也可以进行一下n卡，完成我们的case，好的。

我们先编译申请一下，然后在这里呢我们进行相关的一个处理，那么首先我们看这里我们接收到的这个信息的话啊，首先呢就是我们这边的这个结构啊，传进来的这个信息，那么首先呢就是指令的类型，指令类型匹配之后呢。

我们获得的将是一个这个人物信息的啊啊它的这个结构指针，指针的一个指针，那么首先呢我们要去除这个结构的地址，这个指针的地址，那么我们先来看一下切换到我们的相应的代理，那么在这里呢我们提取代码块。

同时把我们这个结构类型呢需要复制过来，然后在这里呢进行一个相应的这个支撑来进行一个调，那么由于我们传进来的这个地址的话，我们也需要对它进行一个取出的一个操作，那么首先呢我们取出里面它传进来的这个数据。

也就是我们，也就是这一个指针的一个词，我们就要把它取出来，那么在这里的话，我们首先呢是取得它是像这个指针的指针的一个数值，那么取出来的话，在这里的话我们可以直接用dvd新的这个类型来取，选完之后。

然后我们再进行一下强化，那么这个地址取出来之后呢，它实际上也就是我们控制台这个进程里边它这个数据块的一个地址，那么我们要访问我们的数据的话，就需要先取出来了。

然后需要跨进程的把这个数据写入到这个地址可以去啊，那么所以说这里呢我们还需要自己写一个，跨进程的一个函数，那么我们看一下这里的函数是什么情，那么实际上这个函数呢我们就是用了一个y pocs的。

这个我们之前有啊有用过，因为我们自己的这个控制台呢，它是没有饱和的，直接写就可以，然后这里呢我们是通过我们这个控制台的这个窗口句柄，来获取它的p i d，然后获取控制台的一个进程句柄。

然后向我们控制台写入我们的数据，这是开始的地址，这是写入的缓冲区，要写入的数据，那么这是写作的一个大小，写入数据的一个大小，那么写入字我们要写入的这些数据呢，通过我们的这个全局变量来获取。

那么这里呢我们有一个全局变量单元，然后我们可以这里是我们人类的属性，我们需要先初始化，然后初始化之后呢，我们就把这个数据来到这个结构，是这里面，最终呢我们把这个过去的数据呢。

通过这个函数呢写入到我们的控制台进程，我们来看一下代码调用，那么首先呢我们也需要定一个相应的这个变量，那么在这个结构变量呢是木兰取得我们这个游戏进程的角色的数据的。

然后呢角色的数据呢我们是通过这个函数来获取，获取之后存放到这个结构里面，然后我们调用一下这个几个，那么这个是输出数据的，我们可以加一个空的一个红框报纸，增强一个可能性好，那么这个时候呢。

我们把我们的武器进程的这个人物的属性呢放到这个结构里面，然后我们需要把这个结构呃，里面的数据呢写到我们的控制台的这个结构地址里面啊，那么这里呢实际上是取得了控制排列结构地址，然后我们就用这个ip。

那么为什么呢，这个首先呢我们第一个参数呢，也就是我们控制台的这个窗口的距离，那么控制台的窗户距离的话，我们之前在调用这个w cpdt的时候，在这边啊，它的第一个参数就是这个控制台的这个距离。

第二个第二个采取新的message，我们看一下新的，那么也就是倒数的第二个参数就是它的窗口区，那么所以说我们在这里的话，我们也就是这个参数对应起来，也就是我们窗口的具体。

那么在这里呢用来做它是第一个参考，那么第二个参数呢是我们要写入的起始地址，那么也就是我们控制台的这个结构的一个起始地址放在这个位置，然后呢是我们缓冲区，缓冲区的话。

也就是我们的这里获取获取的这个呃人物属性的这些信息，它的起始地址呢我们就给他们相应的地址，然后它这个数据的大小的话就是3o，通过三后来取得它的大小啊，理论上的话这样就可以了，但是我们还要注意一点啊。

我们这个vs 2010之后呢，它有一个，看一下清单文件里面有一个uvc，这个呢我们可以把它关掉，或者是uvc的请帖呢，我们把它调到最高啊，这就啊也就是这个账户不控制的啊。

不然的话我们可能在呃打开这个进城的时候呢，他们有这个相应的权限好了，做完这几步的话，我们也不能上来，就把我们的数据返回到了我们的控制台，那么控制台我们获取数据之后呢，我们可以把它打印出来看一下。

那么在这里呢我们另外用一个按钮来测试一下，那么在测试之前呢，我们在这里的话是首先要包含它相应的图文件，这里已经包含包含通文件之后呢，我们需要进入一个缓冲区，然后呢用来保存过程的视频。

那么我们也需要把这个函数先停止一下，然后我们再来看一下它的第一个参数，那么第一个参数呢就是我们，我们可以用啊获取我们一系的，进去给，那么第二个参数呢就是我们发送的嗯，这个窗口去买。

那么第三个呢就是我们这个结构的，那么我们通过这三句呢，我们理论上就可以把我们的游戏进程的这个数据保存到这个结构里面，然后呢我们再把它里面的这个数据的打印出trs，我可以求自己去打印，哈哈哈哈，嗯。

好的我们再编译生成一下，然后在这里呢我们再加上一个区，表示执行到了这个地步，然后把我们申请的动态链接库放到我们的游戏下面。



![](img/01908eada3ebfe22b12ea122d67a2963_10.png)

![](img/01908eada3ebfe22b12ea122d67a2963_11.png)

那么首先呢我们也需要打开我们相应的工具，在这里呢我们挂接一下主线程，然后类型我们的控制台相关的程序，那么这里呢我们又加上问号，那么在后边呢它就会因为在这里包含了相应的文件，就会出现类似的错误。

那么我们服务建筑加上这，清醒，那么这个时候我们可以看到这里的hp和mp以及金币，当然这个人物的名字是错的，就用代码很显著，那么我们看一下金币在这里的话，我们也能看到，因为我们在这里发生的是不是啊。

所以说我们这里的这个twice的这个游戏的，他是在这里说的，没有行驶到我们这个地方，如果是单独运行的话，那么他会在这个地方的第八国度里面来显示他这一段里面，好的，我们看一下我们还有哪一段代码，请求答案。

靠自我没有获取，这个人物的名字啊对了，在这里的时候，我们应当是，德国属性，然后呢啥意思，对不对，这样的话才是获取我们的属性，这里可能要用破皮或者是四条，我们重新把游戏关掉，再来做一下测试。



![](img/01908eada3ebfe22b12ea122d67a2963_13.png)

![](img/01908eada3ebfe22b12ea122d67a2963_14.png)

![](img/01908eada3ebfe22b12ea122d67a2963_15.png)

听，那么首先呢我们也缓解一下我们这些成年。

![](img/01908eada3ebfe22b12ea122d67a2963_17.png)

那么在这里呢我们可以直接找到了，在第八层地讲起，那么我们可以直接运行这个ex，那么这样的话看拦截的这个信息的话，应当在这个评判的，那么首先我们登录一下游戏，好的，然后我们再次在这里获取的信息。

关键我们都不适应了，还有我们这里需要挂机的进程。

![](img/01908eada3ebfe22b12ea122d67a2963_19.png)

那么我们扫描一下那个过滤，在这里呢我们还是需要先给它加点代码。

![](img/01908eada3ebfe22b12ea122d67a2963_21.png)

那么在这里的话，我们还有一个过滤。

![](img/01908eada3ebfe22b12ea122d67a2963_23.png)

那这里呢我们必须要加上这个跟这个图，它才会显示相关的这个信息，那么所以说我们在这里调试的时候，输出调试信息的时候，我们需要加这个前缀，这样他才会显示出，在这个位置，这样可以。

那么这个时候呢因为我们的游戏已经死掉了吧，所以说我们这里呢取得的这个信息的话，它是不正确的，那么在这里呢我们需要最好把它相应的这个结构的初始化一下。



![](img/01908eada3ebfe22b12ea122d67a2963_25.png)

那么我们再重新进一下游戏。

![](img/01908eada3ebfe22b12ea122d67a2963_27.png)

哒哒哒哒哒。

![](img/01908eada3ebfe22b12ea122d67a2963_29.png)

![](img/01908eada3ebfe22b12ea122d67a2963_30.png)

那么在这里的话我们看一下啊，获取信息的时候，它就会显示我们的全部的名字啊，血量更替及我们的金币，看一下金币的数量，329112623，那么都是正确的，这那么其他的数据的一个回程的一个方式呢。

我们也可以借鉴这这一类的方法，那么注意到我们在这个地方，它是决赛的，因为我们用的是新的那些题，那么执行到这里的时候，执行到新的message的spa，实际上它会一直的等待，那么等待什么。



![](img/01908eada3ebfe22b12ea122d67a2963_32.png)

等待我们的这个游戏进程里面的代码执行完它才会发。

![](img/01908eada3ebfe22b12ea122d67a2963_34.png)

那么我们再来看一下，有些清怎么办。

![](img/01908eada3ebfe22b12ea122d67a2963_36.png)

那么实际上我们在控制台它执行到这一步的时候，他就会一直停在这里，他要等到什么呢，等到我们的，这个游戏的话，我们新安装的这个词化的这个窗口，它会一直执行，执行到我们的指导不到这个旅程。

那么执行完了之后他才会发，那么我们最后呢是在这个地方瑞克之前呢，我们就没看，那么表示我们粗略了这个数据，我们直接找一个增值就可以，这里呢我们就好这样的方式来书写，这个人也是这样写的，那么这样写的话。

我们把数据写入完了之后呢，它就会直接返回我们的数据，那么如果是在他之前返回的话，肯定也是不行的，那么所以说这一点需要注意，那么这节课呢我们暂时就讨论到这个地方啊。



![](img/01908eada3ebfe22b12ea122d67a2963_38.png)