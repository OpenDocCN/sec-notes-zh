![](img/1e062631f7e8eb678160e04d2885d7da_0.png)

![](img/1e062631f7e8eb678160e04d2885d7da_2.png)

# 课程 P149：160-游戏自动登录设计-分析断线判断标志 🔍

![](img/1e062631f7e8eb678160e04d2885d7da_3.png)

![](img/1e062631f7e8eb678160e04d2885d7da_5.png)

在本节课中，我们将学习如何分析一款网络游戏客户端的断线判断机制。我们将通过逆向工程的方法，定位并理解游戏在检测到网络断开时使用的关键标志。

![](img/1e062631f7e8eb678160e04d2885d7da_7.png)

![](img/1e062631f7e8eb678160e04d2885d7da_9.png)

---

![](img/1e062631f7e8eb678160e04d2885d7da_11.png)

![](img/1e062631f7e8eb678160e04d2885d7da_12.png)

## 概述

![](img/1e062631f7e8eb678160e04d2885d7da_14.png)

本节课的核心目标是找到游戏客户端用于判断网络连接是否断开的标志位。我们将从上一节课的分析结果出发，深入游戏代码，追踪其网络事件处理逻辑，最终定位到关键的套接字状态值。

---

![](img/1e062631f7e8eb678160e04d2885d7da_16.png)

## 分析过程

上一节我们介绍了如何定位到显示“断线”提示窗口的函数。本节中，我们来看看这个函数周围的代码逻辑，以找到触发断线判断的具体条件。

首先，我们附加到游戏进程。在上一节课的分析中，我们已经找到了显示断线窗口的函数调用位置。这个函数需要特定的条件才会被触发。

### 寻找断线判断逻辑

![](img/1e062631f7e8eb678160e04d2885d7da_18.png)

断线可能由多种原因引起，例如服务器关闭、网络适配器被禁用或物理网线被拔掉。因此，游戏代码中可能存在多处判断逻辑。在我们找到的函数附近，可以看到至少有三处不同的判断分支。

以下是其中一处关键判断的代码逻辑：

![](img/1e062631f7e8eb678160e04d2885d7da_20.png)

![](img/1e062631f7e8eb678160e04d2885d7da_22.png)

```assembly
cmp dword ptr [ebx+10h], -1
jnz short loc_continue
; 如果 [ebx+10h] 不等于 -1，则跳转到正常流程
; 否则，继续执行断线处理代码
```

这段代码读取 `ebx+10h` 地址处的值，并与 `-1` 进行比较。如果不等于 `-1`，则跳过断线处理。

### 定位关键数据

为了验证这个判断，我们需要找到写入 `ebx+10h` 地址的代码。通过搜索内存写入访问，我们找到了几处可能的位置。

其中一处关键的写入操作如下：

```assembly
mov dword ptr [ebx+10h], 0FFFFFFFFh ; 写入 -1
```

这段代码将值 `-1` 写入目标地址。结合前面的判断，可以推测：**当该地址的值为 `-1` 时，游戏判定为网络已断开**。

### 验证数据含义

我们进一步分析发现，`ebx+10h` 地址实际上存储的是一个**套接字（Socket）句柄**。在正常的网络通信中，这是一个有效的句柄值。当网络断开时，游戏内核或网络层可能会将这个句柄值设置为 `INVALID_SOCKET`，在许多系统中，这个值就是 `-1`。

因此，游戏的断线判断逻辑可以总结为以下公式：

![](img/1e062631f7e8eb678160e04d2885d7da_24.png)

**断线标志 = (套接字句柄 == -1)**

当此条件为真时，游戏就会执行显示断线窗口等一系列断线处理操作。

![](img/1e062631f7e8eb678160e04d2885d7da_26.png)

![](img/1e062631f7e8eb678160e04d2885d7da_28.png)

### 观察发包行为

![](img/1e062631f7e8eb678160e04d2885d7da_30.png)

为了进一步确认，我们观察了游戏发送网络数据包（发包）的函数。在发包函数入口处，也有类似的检查：

```assembly
mov edi, [ecx+10h]
cmp edi, -1
jz short loc_skip_send ; 如果套接字无效，则跳过发送
```

![](img/1e062631f7e8eb678160e04d2885d7da_32.png)

当网络断开、套接字被置为 `-1` 后，所有发包请求都会被此检查跳过，从而避免了无效的网络操作。

![](img/1e062631f7e8eb678160e04d2885d7da_34.png)

---

![](img/1e062631f7e8eb678160e04d2885d7da_36.png)

![](img/1e062631f7e8eb678160e04d2885d7da_38.png)

## 核心发现总结

通过以上分析，我们确定了游戏客户端的断线判断核心机制：

1.  **关键地址**：游戏使用一个固定的内存地址（例如 `[基址+偏移]`）来存储当前网络连接的套接字句柄。
2.  **判断逻辑**：通过持续检查该地址的值是否等于 `-1`（即 `0xFFFFFFFF`）来判断网络是否断开。
3.  **行为影响**：一旦检测到套接字为 `-1`，游戏将：
    *   阻止后续所有网络数据包的发送。
    *   调用函数，显示“网络断开”或“重新连接”的用户界面。

![](img/1e062631f7e8eb678160e04d2885d7da_40.png)

这个标志位非常稳定，无论是服务器主动断开、本地禁用网卡还是其他网络故障，最终都会导致该标志被设置为 `-1`。

![](img/1e062631f7e8eb678160e04d2885d7da_42.png)

---

![](img/1e062631f7e8eb678160e04d2885d7da_44.png)

![](img/1e062631f7e8eb678160e04d2885d7da_46.png)

## 下节课预告

本节课中我们一起学习了如何定位并分析游戏断线的内存判断标志。我们找到了关键的套接字句柄地址，并理解了其值为 `-1` 时代表断线。

![](img/1e062631f7e8eb678160e04d2885d7da_48.png)

在下一节课中，我们将利用这个发现来编写代码。我们将学习如何读取游戏内存中的这个标志位，并实现一个自动检测断线、然后自动重启游戏或执行登录脚本的自动化工具。