# 课程 P77：088-遍历可做任务列表 📋

![](img/4562c29faa384ea413b198808a903981_1.png)

在本节课中，我们将学习如何遍历游戏中的任务列表。我们将基于上一节课分析的数据结构，编写代码来读取并打印出任务名称。课程将涵盖关键的内存偏移计算、汇编代码的封装与调试，并区分“可执行任务”与“所有任务”列表。

---

## 回顾与分析数据 📊

上一节课我们分析了任务列表的相关数据结构。

以下是任务名称的读取公式：
```
任务名指针 = [[[基址] + 偏移1] + 偏移2] + 偏移3
```

![](img/4562c29faa384ea413b198808a903981_3.png)

![](img/4562c29faa384ea413b198808a903981_5.png)

![](img/4562c29faa384ea413b198808a903981_6.png)

具体来说：
*   任务名称来源于一个特定的内存地址链。
*   遍历任务列表时，存在一个起始条件（偏移 `+4C4`）和一个结束条件（偏移 `+4C8`）。
*   每次遍历，指针会增加 **8 字节**。

![](img/4562c29faa384ea413b198808a903981_7.png)

![](img/4562c29faa384ea413b198808a903981_8.png)

有了这些数据，我们就可以开始编写遍历代码。

---

## 编写遍历函数 💻

我们将打开第86课的代码，在测试单元中封装一个遍历函数。

首先，转到结构单元，在末尾添加一个遍历函数。函数需要处理日常的数据准备和地址计算。

以下是函数的核心步骤概述：
1.  定义遍历的起始地址和结束地址。
2.  使用循环，每次指针增加8字节，直到到达结束地址。
3.  在循环体内，根据分析出的公式读取当前任务名称。

关键的内存读取操作使用内联汇编实现，以确保精确性。我们需要初始化相关寄存器（如 `EDI`, `ECX`），并处理两种可能的名字读取路径（取决于某个偏移值是否大于 `0x18`）。

循环的判断条件是：当前地址（`EDI`）加上8字节后，是否小于结束地址。如果不满足，则继续循环。

---

![](img/4562c29faa384ea413b198808a903981_10.png)

## 调试与问题排查 🔍

编写完初步代码后，我们注入游戏进行测试。发现打印出的任务列表与预期不符，只显示了部分“可执行任务”，而非“所有任务”。

![](img/4562c29faa384ea413b198808a903981_12.png)

通过对比OD（OllyDbg）中的调试数据，我们发现了两者的关键区别：

![](img/4562c29faa384ea413b198808a903981_14.png)

**“可执行任务”列表的起始偏移是 `+4C4`。**
**“所有任务”列表的起始偏移是 `+444`。**

![](img/4562c29faa384ea413b198808a903981_16.png)

我们修改代码中的偏移值为 `+444` 和 `+448`，重新编译并测试。这次成功遍历并打印出了完整的“所有任务”列表。

![](img/4562c29faa384ea413b198808a903981_18.png)

---

![](img/4562c29faa384ea413b198808a903981_20.png)

## 遗留问题与下节预告 🔮

![](img/4562c29faa384ea413b198808a903981_22.png)

![](img/4562c29faa384ea413b198808a903981_24.png)

目前我们的代码成功获取了任务名称。但观察游戏内完整的任务列表，会发现每个任务前还有一个**等级标识**。

![](img/4562c29faa384ea413b198808a903981_26.png)

这个等级信息的偏移地址，我们在OD调试时已经看到过（一个格式化字符串处理的位置）。这留作一个练习，请大家课后尝试分析并找出其偏移。

下节课，我们将一起完成这个等级信息的读取，完善我们的任务列表遍历功能。

![](img/4562c29faa384ea413b198808a903981_28.png)

---

![](img/4562c29faa384ea413b198808a903981_30.png)

## 总结 ✨

本节课我们一起学习了：
1.  **回顾了任务列表的数据结构**，明确了任务名的读取公式。
2.  **编写并封装了遍历函数**，使用内联汇编实现了内存地址的精确读取和循环遍历。
3.  **进行了调试与问题排查**，发现了“可执行任务”与“所有任务”列表的关键偏移差异（`+4C4` vs `+444`），并修正了代码。
4.  **提出了下一步目标**，即分析并获取任务前的等级标识信息。

![](img/4562c29faa384ea413b198808a903981_32.png)

通过本课，你掌握了遍历复杂游戏数据结构的基本方法，包括分析、编码和调试的全过程。