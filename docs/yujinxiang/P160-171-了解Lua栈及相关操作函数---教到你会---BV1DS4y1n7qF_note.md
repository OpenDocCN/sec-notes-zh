# P160ï¼š171-äº†è§£Luaæ ˆåŠç›¸å…³æ“ä½œå‡½æ•° ğŸ“š

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†è¦å­¦ä¹ Luaè™šæ‹Ÿæ ˆçš„åŸºæœ¬æ¦‚å¿µä»¥åŠå¦‚ä½•é€šè¿‡C APIå¯¹æ ˆè¿›è¡ŒåŸºç¡€æ“ä½œï¼Œä¾‹å¦‚å‹æ ˆã€å‡ºæ ˆå’Œå–å€¼ã€‚æ ˆæ˜¯Luaä¸Cè¯­è¨€ä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢çš„æ ¸å¿ƒæœºåˆ¶ã€‚

## æ¦‚è¿°

Luaæ ˆæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ ˆç»“æ„ï¼Œä¸»è¦ç”¨äºå‡½æ•°ä¹‹é—´ä¼ é€’å‚æ•°ï¼Œæˆ–æ˜¯åœ¨Luaè„šæœ¬ä¸Cä»£ç ä¹‹é—´ä¼ é€’æ•°å€¼æ•°æ®ã€‚æ ˆä¸Šçš„æ•°æ®å¯ä»¥æ˜¯å¤šç§ç±»å‹ï¼Œä¾‹å¦‚ç©ºç±»å‹ã€æ•°å­—æˆ–å­—ç¬¦ä¸²ç­‰ã€‚æˆ‘ä»¬å°†åœ¨åç»­è¯¾ç¨‹ä¸­é€æ­¥æ·±å…¥äº†è§£ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_1.png)

![](img/7c3ef4bef277fa9c9c0621351ddda889_3.png)

![](img/7c3ef4bef277fa9c9c0621351ddda889_5.png)

## Luaæ ˆçš„åŸºæœ¬ç‰¹æ€§

![](img/7c3ef4bef277fa9c9c0621351ddda889_6.png)

æ— è®ºä½•æ—¶è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„æ ˆã€‚è¿™ä¸Cè¯­è¨€æˆ–æ±‡ç¼–ä¸­çš„æ ˆæ¦‚å¿µç±»ä¼¼ï¼Œæ¯ä¸ªè°ƒç”¨éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆå¸§ã€‚Luaæ ˆç‹¬ç«‹äºCå‡½æ•°è°ƒç”¨æ ˆã€‚

æ‰€æœ‰å¯¹æ ˆçš„æ“ä½œéƒ½é€šè¿‡ä¸€ä¸ªç´¢å¼•æ¥æŒ‡å‘æ ˆä¸­çš„å…ƒç´ ã€‚æ­£çš„ç´¢å¼•å€¼è¡¨ç¤ºä»æ ˆåº•å¼€å§‹çš„ç»å¯¹ä½ç½®ï¼ˆä»1å¼€å§‹ï¼‰ï¼Œè€Œè´Ÿçš„ç´¢å¼•å€¼åˆ™è¡¨ç¤ºä»æ ˆé¡¶å¼€å§‹çš„åç§»é‡ã€‚

## æ ˆæ“ä½œçš„æ ¸å¿ƒå‡½æ•°

ä»¥ä¸‹æ˜¯æœ¬èŠ‚è¯¾å°†æ¶‰åŠçš„å‡ ä¸ªæ ¸å¿ƒæ ˆæ“ä½œå‡½æ•°ã€‚

*   `lua_pushnumber`ï¼šå°†ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°å‹å…¥æ ˆé¡¶ã€‚
*   `lua_pushinteger`ï¼šå°†ä¸€ä¸ªæ•´å‹æ•°å‹å…¥æ ˆé¡¶ã€‚
*   `lua_pop`ï¼šä»æ ˆé¡¶å¼¹å‡ºæŒ‡å®šæ•°é‡çš„å…ƒç´ ã€‚
*   `lua_tonumber`ï¼šæ ¹æ®ç´¢å¼•ä»æ ˆä¸­è·å–ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°å€¼ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_8.png)

## å®è·µï¼šæ•°å­—çš„å…¥æ ˆä¸å–å€¼

![](img/7c3ef4bef277fa9c9c0621351ddda889_10.png)

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†æ ˆçš„åŸºæœ¬æ¦‚å¿µï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å°†æ•°å­—å‹å…¥æ ˆä¸­å¹¶è¯»å–å®ƒä»¬ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_12.png)

![](img/7c3ef4bef277fa9c9c0621351ddda889_14.png)

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªLuaçŠ¶æ€å¹¶æ³¨å†Œä¸€ä¸ªCå‡½æ•°ä¾›æµ‹è¯•ã€‚åœ¨æµ‹è¯•å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†ä¸€ç³»åˆ—æ•°å­—å‹å…¥æ ˆã€‚

```c
// å°†æ•°å­—1åˆ°6å‹å…¥æ ˆ
lua_pushnumber(L, 1);
lua_pushnumber(L, 2);
lua_pushnumber(L, 3);
lua_pushnumber(L, 4);
lua_pushnumber(L, 5);
lua_pushnumber(L, 6);
```

![](img/7c3ef4bef277fa9c9c0621351ddda889_16.png)

å‹æ ˆåï¼Œæ ˆåº•ï¼ˆç´¢å¼•1ï¼‰æ˜¯æ•°å­—1ï¼Œæ ˆé¡¶ï¼ˆç´¢å¼•-1ï¼‰æ˜¯æ•°å­—6ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`lua_tonumber`å‡½æ•°å¹¶æŒ‡å®šç´¢å¼•æ¥è·å–å€¼ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_18.png)

![](img/7c3ef4bef277fa9c9c0621351ddda889_20.png)

```c
// è·å–æ ˆåº•å…ƒç´ ï¼ˆç´¢å¼•1ï¼‰
double bottom = lua_tonumber(L, 1); // å€¼ä¸º 1.0
// è·å–æ ˆé¡¶å…ƒç´ ï¼ˆç´¢å¼•-1ï¼‰
double top = lua_tonumber(L, -1); // å€¼ä¸º 6.0
```

![](img/7c3ef4bef277fa9c9c0621351ddda889_22.png)

ç´¢å¼•è§„åˆ™å¦‚ä¸‹ï¼š
*   æ­£ç´¢å¼•ä»æ ˆåº•ï¼ˆ1ï¼‰å¼€å§‹å‘ä¸Šè®¡æ•°ã€‚
*   è´Ÿç´¢å¼•ä»æ ˆé¡¶ï¼ˆ-1ï¼‰å¼€å§‹å‘ä¸‹è®¡æ•°ã€‚

ä¾‹å¦‚ï¼Œè¦è·å–æ•°å­—4ï¼Œå¯ä»¥ä½¿ç”¨ç´¢å¼•4ï¼ˆä»æ ˆåº•æ•°ç¬¬4ä¸ªï¼‰æˆ–ç´¢å¼•-3ï¼ˆä»æ ˆé¡¶æ•°ç¬¬3ä¸ªï¼‰ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_24.png)

![](img/7c3ef4bef277fa9c9c0621351ddda889_26.png)

```c
double val1 = lua_tonumber(L, 4);  // å€¼ä¸º 4.0
double val2 = lua_tonumber(L, -3); // å€¼ä¸º 4.0
```

![](img/7c3ef4bef277fa9c9c0621351ddda889_27.png)

![](img/7c3ef4bef277fa9c9c0621351ddda889_29.png)

## å®è·µï¼šå‡ºæ ˆæ“ä½œ

![](img/7c3ef4bef277fa9c9c0621351ddda889_31.png)

äº†è§£äº†å¦‚ä½•å‘æ ˆä¸­æ·»åŠ å’Œè¯»å–æ•°æ®åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ç§»é™¤æ ˆé¡¶çš„å…ƒç´ ã€‚è¿™é€šè¿‡`lua_pop`å‡½æ•°å®ç°ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_33.png)

`lua_pop(L, n)`å‡½æ•°ä»æ ˆé¡¶å¼¹å‡º`n`ä¸ªå…ƒç´ ã€‚ä¾‹å¦‚ï¼Œåˆå§‹æ ˆä¸º `[1, 2, 3, 4, 5, 6]`ï¼ˆæ ˆåº•åˆ°æ ˆé¡¶ï¼‰ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_35.png)

```c
// å¼¹å‡º2ä¸ªå…ƒç´ 
lua_pop(L, 2);
// æ­¤æ—¶æ ˆå˜ä¸º [1, 2, 3, 4]ï¼Œæ ˆé¡¶å…ƒç´ æ˜¯4
double new_top = lua_tonumber(L, -1); // å€¼ä¸º 4.0
```

![](img/7c3ef4bef277fa9c9c0621351ddda889_37.png)

å¦‚æœå¼¹å‡ºå…ƒç´ çš„æ•°é‡ç­‰äºæˆ–è¶…è¿‡æ ˆçš„å¤§å°ï¼Œæ ˆä¼šè¢«æ¸…ç©ºï¼Œæ­¤æ—¶å†å°è¯•å–å€¼å¯èƒ½å¾—åˆ°æœªå®šä¹‰çš„ç»“æœï¼ˆå¦‚0ï¼‰ã€‚

```c
lua_pop(L, 6); // å¼¹å‡ºæ‰€æœ‰å…ƒç´ 
// æ ˆå·²ç©ºï¼Œä»¥ä¸‹æ“ä½œå¯èƒ½å¾—åˆ°0æˆ–æœªå®šä¹‰å€¼
double undefined = lua_tonumber(L, 1);
```

![](img/7c3ef4bef277fa9c9c0621351ddda889_39.png)

## æ•´æ•°ä¸æµ®ç‚¹æ•°çš„å‹æ ˆ

![](img/7c3ef4bef277fa9c9c0621351ddda889_41.png)

Luaæä¾›äº†ä¸åŒçš„å‡½æ•°æ¥å‹å…¥æ•´æ•°å’Œæµ®ç‚¹æ•°ï¼Œä½†éœ€è¦æ³¨æ„å®ƒä»¬åœ¨æ ˆå†…çš„å­˜å‚¨æœ€ç»ˆéƒ½ä¼šç»Ÿä¸€ä¸º`double`ç±»å‹ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_43.png)

![](img/7c3ef4bef277fa9c9c0621351ddda889_45.png)

*   `lua_pushinteger(L, ivalue)`: å‹å…¥ä¸€ä¸ª`lua_Integer`ç±»å‹ï¼ˆé€šå¸¸æ˜¯`long long`ï¼‰çš„æ•´æ•°ã€‚
*   `lua_pushnumber(L, nvalue)`: å‹å…¥ä¸€ä¸ª`lua_Number`ç±»å‹ï¼ˆé€šå¸¸æ˜¯`double`ï¼‰çš„æµ®ç‚¹æ•°ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_47.png)

å³ä½¿ä½¿ç”¨`lua_pushinteger`å‹å…¥æ•´æ•°ï¼Œå½“ä½¿ç”¨`lua_tonumber`è¯»å–æ—¶ï¼Œè¿”å›çš„ä»æ˜¯`double`ç±»å‹ã€‚å¦‚æœéœ€è¦æ•´æ•°ï¼Œå¯ä»¥è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_49.png)

```c
lua_pushinteger(L, 100);
// è¯»å–ä¸ºæµ®ç‚¹æ•°
double dval = lua_tonumber(L, -1);
// è½¬æ¢ä¸ºæ•´æ•°
int ival = (int)lua_tonumber(L, -1); // æˆ–è€…ä½¿ç”¨ lua_tointeger å‡½æ•°
```

## æ€»ç»“

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†Luaæ ˆçš„åŸºç¡€çŸ¥è¯†ã€‚æˆ‘ä»¬äº†è§£åˆ°æ ˆæ˜¯Luaä¸Cäº¤äº’çš„æ¡¥æ¢ï¼Œé€šè¿‡ç´¢å¼•ï¼ˆæ­£ç´¢å¼•ä»æ ˆåº•å¼€å§‹ï¼Œè´Ÿç´¢å¼•ä»æ ˆé¡¶å¼€å§‹ï¼‰æ¥è®¿é—®å…ƒç´ ã€‚æˆ‘ä»¬å®è·µäº†å››ä¸ªæ ¸å¿ƒæ“ä½œï¼š
*   **`lua_pushnumber` / `lua_pushinteger`**ï¼šç”¨äºå°†æ•°å€¼å‹å…¥æ ˆé¡¶ã€‚
*   **`lua_pop`**ï¼šç”¨äºä»æ ˆé¡¶å¼¹å‡ºæŒ‡å®šæ•°é‡çš„å…ƒç´ ï¼Œæ”¹å˜æ ˆé¡¶æŒ‡é’ˆã€‚
*   **`lua_tonumber`**ï¼šç”¨äºæ ¹æ®ç´¢å¼•ä»æ ˆä¸­è·å–ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°å€¼ã€‚

![](img/7c3ef4bef277fa9c9c0621351ddda889_51.png)

è¿™äº›æ˜¯æ“ä½œLuaæ ˆæœ€åŸºæœ¬å’Œå¸¸ç”¨çš„å‡½æ•°ã€‚åœ¨åç»­è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åˆ©ç”¨æ ˆæ¥ä¼ é€’å‡½æ•°å‚æ•°å’Œè¿”å›å€¼ã€‚