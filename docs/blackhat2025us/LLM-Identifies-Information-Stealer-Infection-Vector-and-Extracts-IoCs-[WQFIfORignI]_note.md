# 课程 1：利用LLM识别信息窃取器感染途径并提取IoC 🕵️‍♂️

在本节课中，我们将学习如何利用大型语言模型（LLM）分析信息窃取器（Info Stealer）感染后留下的截图，从而自动化地识别感染途径、提取攻击指标（IoC）并追踪恶意活动。

## 概述

信息窃取器是一种恶意软件，它感染用户计算机后，会窃取各种凭证、密码、加密货币钱包等信息。攻击者通常会将窃取的数据打包，通过Telegram等渠道进行售卖。有趣的是，许多窃取器在运行时会自动截取受害者屏幕的截图。这些截图就像“犯罪现场的自拍”，包含了大量关于感染源（如诱饵软件、下载链接）的线索。我们将构建一个基于LLM的自动化分析管道，从海量截图中高效提取这些关键信息。

![](img/0b093f196e20bcc841959b6f130d9cc4_1.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_2.png)

## 信息窃取器现象

![](img/0b093f196e20bcc841959b6f130d9cc4_4.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_5.png)

信息窃取器恶意软件是一种常见的威胁。其感染流程通常如下：用户下载并执行了恶意软件（通常是伪装成破解软件或其他诱饵），该恶意软件随后在受害者计算机上运行。它之所以被称为“信息窃取器”，是因为它会窃取计算机上所有可访问的信息，包括凭证、加密货币钱包、密码管理器数据、系统信息、剪贴板内容等。这些数据随后被打包并上传到攻击者的命令与控制（C2）基础设施，最常见的是通过Telegram。

![](img/0b093f196e20bcc841959b6f130d9cc4_7.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_8.png)

这些感染产生的数据（或称“日志”）会被打包，并由网络犯罪分子在Telegram上再次转售。因此，这里存在两级Telegram活动：一级是窃取器上传数据，另一级是犯罪分子转售这些数据日志。

## 为什么关注截图？📸

攻击者在恶意软件中加入了截图功能，可能是为了检测沙箱环境（因为沙箱环境很容易通过截图识别），或者为了获取更多受害者上下文信息。然而，对我们防御方而言，这些截图就像是攻击者留下的“犯罪现场自拍”，包含了大量可用于追溯感染源的信息。

![](img/0b093f196e20bcc841959b6f130d9cc4_10.png)

例如，一张截图可能显示一个关于“破解《堡垒之夜》软件”的YouTube视频页面，其中包含下载链接和解压密码。另一张截图可能显示一个包含Office套件破解版下载链接的MEGA网盘页面。这些视觉线索正是我们理解感染故事所需的关键。

![](img/0b093f196e20bcc841959b6f130d9cc4_12.png)

我们通过渗透相关Telegram群组和网络犯罪团体，收集了超过1100万张截图，涉及11个不同的恶意软件家族。手动分析如此大量的截图是不现实的，因此我们转向利用AI和LLM技术来解决这个问题。

## LLM分析管道设计 🤖

![](img/0b093f196e20bcc841959b6f130d9cc4_14.png)

我们设计了一个两层的LLM分析管道来处理截图。

![](img/0b093f196e20bcc841959b6f130d9cc4_16.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_18.png)

以下是该管道的核心流程：

![](img/0b093f196e20bcc841959b6f130d9cc4_20.png)

1.  **第一层LLM（视觉评估层）**：接收原始截图，输出结构化的文字描述。
2.  **第二层LLM（推理分析层）**：接收第一层的描述，识别具体的感染途径（如“通过YouTube视频下载破解软件”）和攻击主题（如“《堡垒之夜》作弊工具”）。
3.  **IoC检查管道**：对提取出的潜在攻击指标（如下载链接）进行有效性检查，区分存活链接、已失效链接以及仅包含攻击主题的条目。

![](img/0b093f196e20bcc841959b6f130d9cc4_22.png)

你可能会问，为什么需要两层LLM？这是一个很好的问题。接下来我们将解释背后的原因。

### 为何需要两层LLM？

![](img/0b093f196e20bcc841959b6f130d9cc4_24.png)

最初，我们尝试使用单层LLM，直接让其“识别感染途径”。但这并没有成功。原因在于，人类分析师在分析截图时，实际上无意识地执行了两个独立的任务。

![](img/0b093f196e20bcc841959b6f130d9cc4_26.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_28.png)

以一张截图为例：人类首先会**视觉评估**整体情况（“这是一个关于《堡垒之夜》的YouTube视频，涉及下载”）。然后，基于领域知识，进行**推理分析**，指出具体的感染载体（“用户下载了视频描述中的`FortniteHack.zip`文件，这很可能是感染途径”）。

![](img/0b093f196e20bcc841959b6f130d9cc4_30.png)

对于单层LLM，我们要求它在一个步骤中完成这两个任务，这超出了其能力范围。LLM无法像人类一样“自己领悟”，我们必须将分析师的直觉分解成明确的指令。因此，我们最终设计了两层结构：第一层专门负责客观描述截图内容，第二层则基于描述进行安全分析推理。

![](img/0b093f196e20bcc841959b6f130d9cc4_32.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_34.png)

## 第一层LLM：提示工程与视觉评估

![](img/0b093f196e20bcc841959b6f130d9cc4_36.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_38.png)

我们首先对大量截图进行了人工分析，发现它们大致可分为三类：纯网页内容、纯文件系统界面以及两者混合的界面。

针对不同类型的截图，我们为第一层LLM设计了不同的提取要求：

*   **对于网页内容**：要求提供页面的一般描述、可见的链接以及浏览器标签页信息。
*   **对于文件系统内容**：要求提供描述、文件资源管理器中的文件名，如果正在安装软件，还需指出安装的程序。
*   **对于混合内容**：要求提取以上所有信息。

![](img/0b093f196e20bcc841959b6f130d9cc4_40.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_41.png)

此外，为了给第二层分析提供线索，我们还要求第一层LLM指出任何看起来可疑的元素，例如提及“破解”（crack）的YouTube视频、分享链接等。

![](img/0b093f196e20bcc841959b6f130d9cc4_43.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_45.png)

最终的第一层提示词结构如下：
```
主要描述：[描述截图主要内容]
文件和程序：[列出文件和安装的程序]
链接：[提取所有可见链接]
浏览器标签页：[识别所有标签页]
可疑元素：[指出任何可疑内容，如提及破解、要求禁用杀毒软件等]
```

![](img/0b093f196e20bcc841959b6f130d9cc4_47.png)

我们将一张截图输入第一层LLM，它成功输出了格式化的描述，识别了Eset安全警告窗口、YouTube视频、相关文件，并将YouTube视频和许可证密钥输入提示标记为可疑元素。这为第二层分析提供了良好的输入。

### 第一层性能评估与优化

![](img/0b093f196e20bcc841959b6f130d9cc4_49.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_51.png)

在将第一层输出送入第二层之前，我们必须评估其准确性，因为第二层的输入质量直接决定最终结果。

![](img/0b093f196e20bcc841959b6f130d9cc4_53.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_54.png)

我们在1000张截图上评估了第一层LLM的性能：
*   **场景描述**：正确率96%。
*   **文件资源管理器识别**：正确率100%。
*   **链接提取**：正确率100%。
*   **可疑元素识别**：正确率95%。
*   **浏览器标签页识别**：非常不一致，仅30%完全正确，32%信息缺失，36%完全错误。

![](img/0b093f196e20bcc841959b6f130d9cc4_56.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_57.png)

例如，在一张失败的案例中，LLM没有正确识别所有标签页，反而错误地列出了书签栏的内容。由于标签页识别的不稳定性且对后续分析影响不大，我们决定从提示词中移除这项要求。移除后，整体管道准确率并未下降，从而简化了流程。

![](img/0b093f196e20bcc841959b6f130d9cc4_59.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_61.png)

## 第二层LLM：识别感染途径与主题

第二层LLM的职责是基于第一层的格式化描述，识别具体的感染途径（Vector）和攻击主题（Theme），并将结果格式化以便后续利用。

其输出格式类似：
```
感染途径：文件分享平台（MEGA）
攻击主题：Microsoft Office 2019 破解版
```

![](img/0b093f196e20bcc841959b6f130d9cc4_63.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_65.png)

至此，我们成功构建了一个能够自动从截图描述中提取关键安全信息的LLM层。

![](img/0b093f196e20bcc841959b6f130d9cc4_67.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_69.png)

## IoC检查与分类管道 🎯

![](img/0b093f196e20bcc841959b6f130d9cc4_71.png)

运行整个管道后，我们发现提取出的许多IoC（如下载链接）已经失效。这对于威胁情报而言价值不大，因为我们需要的是当前活跃的威胁。

![](img/0b093f196e20bcc841959b6f130d9cc4_73.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_75.png)

因此，我们引入了IoC检查管道，旨在区分三类结果：
1.  **存活IoC**：链接当前有效，可以下载或访问。
2.  **失效IoC**：链接已失效（如文件被删除、视频下架）。
3.  **主题IoC**：链接本身可能失效，但其中包含的攻击主题（如“Adobe Photoshop 破解”）仍然具有跟踪价值。

![](img/0b093f196e20bcc841959b6f130d9cc4_77.png)

我们针对不同类型的IoC（主要是URL）采用了不同的启发式方法进行检查：

![](img/0b093f196e20bcc841959b6f130d9cc4_79.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_81.png)

*   **文件分享平台（如MEGA）**：这些平台有清晰的错误信息和HTTP状态码，易于判断文件存活与否。即使文件需要密码（密码常在视频描述中），只要平台链接有效，我们仍视其为“存活”，因为用户最终可能通过输入密码完成下载。
*   **YouTube视频**：通过视频是否“不可用”来简单判断。如果视频存活且描述中包含下载链接，则提取该链接作为存活IoC。如果视频存活但下载链接已被移除，则将其归类为“主题IoC”，用于跟踪攻击活动趋势。
*   **其他网站**：我们主要寻找下载按钮等指示器。如果能确认可以触发下载，则视为存活。

![](img/0b093f196e20bcc841959b6f130d9cc4_83.png)

追踪攻击主题非常重要，它允许我们监控特定诱饵（如“Office破解”）的活动规模，并向公众发出预警，从而改变潜在受害者的行为，降低感染风险。

![](img/0b093f196e20bcc841959b6f130d9cc4_84.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_86.png)

## 系统演示与输出

![](img/0b093f196e20bcc841959b6f130d9cc4_88.png)

我们的系统能够自动处理截图。在演示中，系统分析了一张显示ZIP文件（名为“Office 2019 Crack”）的截图。第一层LLM正确识别了内容并提取了URL。第二层LLM判定感染途径为“Microsoft Office破解软件”。系统会持续循环处理截图。

最终输出为结构化的JSON文件，包含恶意软件家族、提取的URL、爬取的关联链接等信息。这构成了我们自动化分析的基础。

![](img/0b093f196e20bcc841959b6f130d9cc4_90.png)

## 信息窃取器“攻击手册”分析

![](img/0b093f196e20bcc841959b6f130d9cc4_92.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_94.png)

让管道运行数周并分析数万张截图后，我们得以洞察攻击者最常用的感染策略，即他们的“攻击手册”。

![](img/0b093f196e20bcc841959b6f130d9cc4_96.png)

我们主要发现了两大类诱饵主题：

![](img/0b093f196e20bcc841959b6f130d9cc4_98.png)

1.  **破解软件**：针对主流或创意软件，如Adobe套件、Vegas Pro、Midjourney、Figma等。这些软件价格昂贵，用户有强烈的“免费获取”动机。攻击者利用用户想绕过正版许可费用的心理，用破解版作为诱饵。选择主流软件能确保最大的潜在受害者池。
2.  **游戏作弊与模组**：针对《堡垒之夜》、《无畏契约》（Valorant）、《我的世界》等主流游戏。这些游戏受众广泛，尤其是年轻玩家。游戏内的皮肤、武器等虚拟物品通常需要付费，而年轻玩家可能缺乏支付意愿或能力。攻击者利用他们“免费获取”稀有物品的渴望进行钓鱼。

![](img/0b093f196e20bcc841959b6f130d9cc4_100.png)

在分发策略上，攻击者主要利用两大平台：

![](img/0b093f196e20bcc841959b6f130d9cc4_102.png)

1.  **YouTube作为分发系统**：攻击者上传教程式视频，标题常包含“100%有效”、“安全”、“免费”等字眼，并在描述中提供下载链接和密码。视频内容会指导用户“禁用杀毒软件”。YouTube的广泛覆盖和教程式内容使其成为完美的恶意软件分发启动台。
2.  **谷歌广告赞助恶意网站**：攻击者创建知名软件官网的高仿钓鱼网站，并通过购买谷歌广告，让这些网站在用户搜索相关软件时出现在结果顶部。用户出于对谷歌排名和品牌官网的信任，极易点击这些恶意链接。

## 实战案例分析

![](img/0b093f196e20bcc841959b6f130d9cc4_104.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_105.png)

通过分析IoC和主题的重复出现频率，我们追踪到了一些非常成功的攻击活动。这里介绍两个典型案例，它们占我们分析感染的5%以上。

![](img/0b093f196e20bcc841959b6f130d9cc4_107.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_108.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_109.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_110.png)

**案例一：Midjourney钓鱼活动**
1.  用户搜索“Midjourney”。
2.  搜索结果顶部出现**赞助广告**（恶意仿冒站），下方才是真正的官网。
3.  用户点击广告，进入一个制作精良的仿冒网站。网站已预先植入心理暗示：“计算机安全系统可能会错误触发警报”，为后续要求用户禁用杀软做铺垫。
4.  用户下载并运行恶意可执行文件。当安装失败时，用户回想起网站的“警告”，认为是杀软阻止，从而主动禁用安全软件，最终导致感染。

![](img/0b093f196e20bcc841959b6f130d9cc4_112.png)

**案例二：Blitz Java活动**
1.  攻击者针对Java软件创建了多个不同语言版本的高仿钓鱼网站。
2.  通过**谷歌广告**将其推至搜索结果顶部。
3.  用户下载得到一个存档文件，内含恶意安装程序。该安装程序图标与正版略有不同，但普通用户难以察觉。
4.  安装失败后，用户上网搜索解决方案，进一步陷入困境。
5.  该活动的高明之处在于，其广告集中投放于某个**周末的19小时内**。周末人们有更多休闲上网时间，而企业安全团队响应速度较慢，从而最大化感染窗口。

![](img/0b093f196e20bcc841959b6f130d9cc4_113.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_114.png)

这两个案例都运用了简单的策略：瞄准主流软件/官网、制作高仿副本、利用谷歌广告或YouTube视频进行分发。关键在于，攻击者依然严重依赖简单的**心理战术**，因为这对操纵用户非常有效。

![](img/0b093f196e20bcc841959b6f130d9cc4_116.png)

![](img/0b093f196e20bcc841959b6f130d9cc4_117.png)

## 方法的优势与局限

![](img/0b093f196e20bcc841959b6f130d9cc4_119.png)

我们构建的系统有其独特的优势和不可避免的局限性。

**优势：**
*   **对抗代码变更的鲁棒性**：传统恶意代码分析依赖特征码，容易被加壳、混淆等技术绕过。而我们的方法分析的是感染后的**截图**，无论恶意软件代码如何变化，只要它还在截图，我们就能追踪其感染活动。这适用于不同家族的窃取器。
*   **成本可控**：处理一张截图大约需要5-10秒，综合成本约为**0.3美分/张**。随着云服务和模型进步，成本和效率有望进一步优化。

**局限：**
*   **依赖截图存在**：如果攻击者意识到截图功能暴露了其攻击途径并移除此功能，我们的方法将失效。
*   **依赖截图质量**：如果截图内容模糊、无关紧要（如只显示桌面），我们将无法提取有效信息。分析质量受原始截图质量限制。

## 结论与未来展望 🚀

![](img/0b093f196e20bcc841959b6f130d9cc4_121.png)

信息窃取器仍然是当前非常活跃的威胁。只要攻击者继续在日志中包含截图，我们就能利用所述方法大规模追踪攻击活动和主题。

**关键收获：**
1.  **安全意识至关重要**：组织应教育用户（包括IT人员）认识到使用破解软件的极高风险，以及“禁用杀毒软件”这一行为本身就是强烈的危险信号。
2.  **LLM应用于网络安全**：我们将LLM应用于一种特定的网络安全数据（截图）。安全从业者可以将这种思路应用于自己关心的其他安全数据源，关键在于**将分析师的直觉编码成具体、明确的指令**。

**未来工作：**
我们目前专注于截图分析。下一步，我们计划将LLM应用于窃取器日志中的**所有其他数据**，如已安装软件列表、进程信息、浏览历史、系统信息等。我们对每种数据应用不同的分析思路，然后综合所有结果，让LLM回答“受害者是如何被入侵的？”这一问题。我们将这个项目称为 **“SherLog”** （或Sherlock），旨在构建一个更全面的自动化感染事件重建系统。

最后，本课程中展示的所有研究成果已发表在学术论文中，可供深入查阅。

---
**本节课总结**：我们一起学习了如何利用两层LLM管道自动化分析信息窃取器的感染截图，从而识别感染途径、提取并分类攻击指标（IoC），并深入了解了攻击者常用的诱饵主题（破解软件、游戏作弊）和分发策略（YouTube、谷歌广告）。我们还探讨了该方法的优势、局限以及未来将LLM更广泛应用于安全日志分析的前景。