# 课程 1：通过 HTTP/2 服务器推送和签名 HTTP 交换进行的跨源 Web 攻击 [IeHGk34HG3k] 🔐

在本节课中，我们将要学习一项关于 Web 安全的新研究。我们将探讨现代 HTTP 协议（HTTP/2 和 HTTP/3）中“同源”定义的演变，以及这种变化如何引入新的安全威胁。具体来说，我们将介绍两种新型攻击向量：跨推送攻击和跨 SXG 攻击。课程内容将涵盖攻击原理、实际利用方式、现实世界中的可行性以及相应的缓解措施。

## 同源策略及其演变

上一节我们介绍了课程概述，本节中我们来看看 Web 安全的基石——同源策略。同源策略旨在保护用户数据免受跨源攻击。

我们通常知道，同源策略中的“源”是基于 **URL** 的。这意味着只有当两个资源的**协议（scheme）、主机（host）和端口（port）** 完全相同时，它们才被视为同源。

然而，我们发现这并不是“源”的唯一定义。在深入研究 HTTP 协议规范时，我们发现 HTTP/2 和 HTTP/3 协议引入了一个新的、更宽松的“源”定义，它是基于 **证书（Certificate）** 的。

具体来说，在 HTTP/2 和 HTTP/3 中，任何列在证书的**主题备用名称（Subject Alternative Name, SAN）** 列表中的主机都被视为同源。例如，Google.com 的证书可能同时包含 `android.com`、`youtube.com` 等域名。在 HTTP/2/3 的视角下，所有这些域名都属于同一个“源”。

这种多域名共享证书的做法非常普遍。已有研究表明，**96%** 的证书在其 SAN 列表中包含多个域名，其中 **3.2%** 的证书包含了属于不同组织的域名。这意味着基于证书的“源”可能包含多个不同的实体，它比基于 URL 的“源”定义更为宽松。

## 新的威胁：跨推送与跨 SXG 攻击

基于上一节介绍的更宽松的“源”定义，一个很自然的问题是：这会为 Web 带来哪些新的安全威胁？这正是我们研究的核心：跨推送攻击和跨 SXG 攻击。

顾名思义，这两种跨源 Web 攻击基于两个旨在提升 Web 性能的服务器交付机制：**HTTP/2 服务器推送** 和 **签名 HTTP 交换**。

对于本次课程，你需要记住这两个机制的两个关键特性：
1.  在它们的规范中，两者都遵循**基于证书的“源”定义**。
2.  服务器推送和 SXG 可以**指示（或证明）** 共享证书中列出的其他“源”。

结合这两个特性，攻击者可以向列在证书 SAN 列表中的其他“源”推送或提供资源访问权限，即使这些“源”属于其他组织。

基于这些发现，我们提出了两种新的攻击向量：跨推送攻击和跨 SXG 攻击。

以下是攻击流程的概述：
1.  首先，假设攻击者获取了一个同时包含受害者网站和攻击者网站域名的共享证书。**共享证书是我们所有攻击的基础**。
2.  攻击开始时，攻击者诱使受害者点击一个恶意链接。
3.  当受害者访问攻击者网站时，攻击者会利用服务器推送或 SXG 来传递一个恶意脚本，并将其“源”设置为受害者网站。
4.  由于之前介绍的基于证书的宽松“源”定义，浏览器会将这个恶意的跨源资源视为同源资源，并在加载受害者网站时执行它。

值得注意的是，我们的攻击引入了新的安全影响。在以往的研究中，获得证书的攻击者通常只能发起中间人攻击。相比之下，我们的攻击使得**离线攻击者**能够利用共享证书发起实际的 Web 攻击，从而导致跨站脚本、Cookie 操纵等利用。

## 攻击利用细节

上一节我们概述了攻击原理，本节中我们来看看具体的利用方式。由于服务器推送和 SXG 本质上都类似于一个 HTTP 响应，包含 HTTP 头部和 HTTP 正文，因此我们可以从这两方面入手。

以下是几种主要的利用方式：

**利用 HTTP 正文发起跨站脚本攻击**
我们可以通过将恶意脚本插入 HTTP 正文来发起跨站脚本攻击。令人惊讶的是，由于我们控制了整个 HTTP 响应，这种跨站脚本攻击是**通用**的。这意味着无论目标网站本身是否存在漏洞、是否离线甚至是否已不存在，我们的攻击都有效。同时，内容安全策略等安全措施也无法阻止此类攻击，因为攻击者不会在恶意响应中设置 CSP 头部。

**利用 HTTP 头部发起攻击**
我们也可以利用 HTTP 头部发起攻击。
*   **操纵 Cookie**：使用 `Set-Cookie` 头部可以在目标网站上将受害者的 Cookie 设置为任意值（例如攻击者自己的 Cookie），从而导致会话固定攻击。
*   **绕过 HSTS**：使用 `Strict-Transport-Security` 头部，将 `max-age` 设置为 0，可以有效地移除网站的 HSTS 保护。

**组合利用头部和正文发起恶意文件下载**
我们可以组合利用 HTTP 头部和正文来发起恶意文件下载。通过使用 `Content-Disposition` 头部控制 HTTP 正文被视为附件，然后将恶意二进制内容放入正文中，可以诱使用户下载并执行恶意文件。

## 攻击的现实可行性

到目前为止，我们的攻击看起来威力很大。但有人可能会问：这些攻击在现实世界中是否可行？在下一部分，我们将讨论使攻击变得实用的技术。

我们将回答以下三个关键问题：
1.  如何获取作为攻击前提的共享证书？
2.  如何延长攻击持续时间？
3.  如何绕过潜在的对策（例如受害者撤销共享证书）？

**获取共享证书**
获取共享证书是执行攻击的主要前提。虽然 HTTP、DNS 和电子邮件中的某些偶然漏洞可能帮助攻击者获取非法证书，但我们的重点是证书生态系统中的固有漏洞。

我们发现，目前没有机制能确保证书所有者与域名所有者始终保持一致。因此，我们提出了两种创造攻击条件的方法：域名转售和域名劫持。
*   **域名转售**：攻击者可以购买大量域名，为它们签发一个多域名证书，然后将部分包含的域名转售给受害者，同时保留共享证书。这样，攻击者就轻易创造了攻击条件。
*   **域名劫持**：当域名指向废弃的虚拟主机 IP、已注册但未使用的 CNAME 记录或刚刚过期的域名时，就可能发生域名劫持。由于这些目标是公开可用的，攻击者可以注册这些被废弃的服务，将其 DNS 记录指向攻击者控制的基础设施，并通过 HTTP 挑战等方式签发证书，从而获得包含被劫持域名的共享证书。

**延长攻击持续时间**
影响攻击可行性的另一个关键因素是攻击持续时间。传统的域名劫持攻击在受害者移除错误的 DNS 记录后会失效。相比之下，我们的攻击在 DNS 记录被移除后仍然有效，直到**证书过期**（通常为 398 天）。

然而，我们的研究发现，一个名为**域名验证重用**的用户友好机制，有可能将攻击持续时间延长至 796 天。该机制允许先前已通过域名所有权验证的证书申请者，在特定时间窗口内申请新证书时跳过重新验证。这个时间窗口最长可达 398 天。因此，攻击者可以在证书到期前的最后一天重新申请新证书，从而将攻击持续时间从 398 天最大延长至 796 天。这意味着即使 DNS 记录被移除，我们的攻击在两年多的时间里仍然有效。

**绕过证书撤销对策**
有人可能会想到，证书在我们的攻击中至关重要，因此一个潜在的对策是通过证书透明度日志检测并撤销未经授权的证书。那么攻击者是否有方法绕过这个对策呢？答案是肯定的。

我们引入了一种使未经授权证书**不可撤销**的策略。根据 Let‘s Encrypt 的文档，要撤销一个证书，必须满足以下两个条件之一：
1.  签发者必须通过证书中包含的所有域名的所有权验证。
2.  或者，拥有证书的私钥。

考虑一下，如果攻击者签发了一个同时包含攻击者域名和受害者域名的共享证书，会发生什么？不幸的是，受害者不满足任何撤销条件。这种共享的证书对受害者来说是不可撤销的。我们也在实际平台上进行了实验，报告了一个与我们域名共享的非法证书，但未收到回复。

## 现实世界影响评估

为了评估我们攻击在现实世界中的影响，我们进行了一次大规模测量。在客户端，我们测量了哪些浏览器接受服务器推送和 SXG；在服务器端，我们测量了哪些网站可能允许攻击者获取共享证书。如果两个条件都满足，就可能使攻击者发起我们的攻击。

**客户端测量结果**
我们的客户端测试目标包括 StatCounter 上的主流浏览器、主流移动设备上的不同浏览器以及苹果应用商店中的流行应用程序。考虑到日常生活中使用的浏览器种类繁多，我们无法手动收集所有数据。因此，我们开发了一个名为 PS Checker 的自动测量系统。

该系统机制很简单：我们使用一个受控的高流量网站将流量引导至一个功能测量服务器的 iframe。该服务器然后使用服务器推送和 SXG 进行跨源脚本推送。最后，通过检查脚本是否被执行，我们可以判断浏览器是否支持服务器推送和 SXG。

运行 PS Checker 一个月后，测量结果显示漏洞浏览器广泛存在。**11 款**最常用浏览器的最新版本以及 **5 款**默认移动浏览器中，至少有一款容易受到我们其中一种攻击。同时，我们惊讶地发现，一些流行应用程序使用了基于移动操作系统 WebView 组件的内置浏览器，这些浏览器继承了与 WebView 相同的漏洞。这显著地将攻击面从浏览器扩展到了第三方应用程序。

**服务器端测量结果**
为了衡量对服务器端网站的影响，我们首先测量了“转售域名”（这是我们之前讨论的攻击者获取共享证书的潜在方法之一）。我们利用 WHOIS 历史数据来识别那些曾被转售给不同所有者的域名。

对于另一种方法“悬空域名”，我们利用了一个发表在安全顶会上的最先进工具 Hosting Checker 来检测此类易受攻击的域名。

我们还考虑了“第三方共享域名”。虽然这些域名本身不允许攻击者直接获取共享证书，但它们揭示了一种安全依赖关系。也就是说，如果这些域名中的任何一个被攻破，那么与它们共享证书的高排名域名也可能变得易受我们的攻击。

我们的测量方法如下：首先，我们从 Top 1000 网站中抓取其证书 SAN 列表中列出的所有域名，以识别它们的关联域名。然后，我们从 HTTP 响应、错误日志和被动 DNS 数据中提取这些关联域名的子域名。最后，我们检查这些关联域名是否与 Top 1000 网站共享证书。

评估结果显示，大量网站受到影响。一些案例甚至影响了知名网站。例如，排名 3895 的 `ftstatic.com` 曾从一家澳大利亚食品公司转售给一家美国广告公司，可能被原域名所有者利用。微软的一个与 Windows 更新相关的子域名 `subtleway.of.windowsupdate.com` 曾是悬空域名，可以被任何攻击者注册。此外，许多高排名域名与低排名域名共享证书，这些低排名域名甚至来自不同的组织，有可能对 Top 1000 网站发起我们的攻击。这种情况在 `baidu.com` 上得到了证实。

## 真实世界案例：微软域名漏洞

当然，我们知道空谈无益。因此，在下一部分，我将展示我们在微软发现的一个真实世界案例。

根据测量，我们发现微软一个与 Windows 更新相关的域名的 CNAME 记录指向了一个未注册的域名。攻击者只需购买并注册这个 `qtlcdn.net.com`，然后配置 DNS A 记录指向攻击者服务的 IP 地址。结果，域名所有权得到验证，攻击者可以签发共享证书并发起我们的攻击。这是我们之前获得的与微软域名共享的证书。当然，该漏洞已被报告，证书已被我们撤销，微软也已修复了此问题。

我们记录了在过去对微软域名发起跨站脚本攻击的视频。在通过域名劫持获得共享证书后，我们设置了一个 HTTP/2 攻击服务器。然后，我们模拟受害者点击恶意链接。我们受控的攻击服务器向微软网站推送了一个 `alert(document.domain)` 脚本并触发了重定向。与之前的跨站脚本演示类似，我们成功在微软域名上执行了 `alert` 脚本。

## 缓解措施与总结

最后，让我们讨论如何缓解我们的攻击。我们为不同方提出了以下对策：

**对于浏览器厂商**
他们应在浏览器中执行一致的权限检查以缓解跨推送攻击，并强制使用单域名证书以防止跨 SXG 攻击。

**对于证书颁发机构**
我们建议他们提供一种机制，允许域名所有者将其域名从已签发的共享证书中移除。

**对于用户**
我们建议他们检查域名注册中的证书状态，以检测未经授权的共享证书。

正如你所见，我们的攻击涉及多方：浏览器、证书颁发机构、域名系统。因此，解决此安全问题需要所有利益相关者的共同努力。我们也已负责任地向受影响的厂商披露了我们的发现。7 家厂商确认了漏洞，其中 5 家（包括华为、百度、微软等）已修复此问题。我们还在 IETF 网络安全工作组发起了一场讨论，探讨 PKI 中的弱点。如果你对这些问题感兴趣，欢迎加入我们的讨论。

**总结**
在本节课中，我们一起学习了以下内容：
我们观察到 HTTP/2 和 HTTP/3 中基于证书的“源”定义比浏览器基于 URL 的“源”定义更为宽松。基于这一发现，我们提出了两种新的跨源 Web 攻击：跨推送攻击和跨 SXG 攻击。这些攻击使得离线攻击者能够利用共享证书发起实际的 Web 攻击。

我们还演示了如何利用 PKI 中的弱点来促成我们的攻击。我们展示了如何利用域名所有者与证书所有者之间的错位来创造攻击条件（例如通过域名转售）。我们介绍了域名验证重用如何延长证书寿命，从而延长攻击持续时间。同时，我们揭示了一个事实：尽管你控制着域名，你可能无法轻易撤销一个包含你域名的证书，这使得攻击者能够绕过撤销未经授权证书等对策。

我的演示到此结束。感谢聆听。