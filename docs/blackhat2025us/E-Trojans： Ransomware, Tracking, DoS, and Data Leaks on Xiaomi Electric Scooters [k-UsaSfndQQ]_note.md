# 课程 01：E-Trojans：小米电动滑板车上的勒索软件、追踪、DoS与数据泄露 🛴🔓

在本课程中，我们将学习一项关于小米电动滑板车安全性的研究。我们将了解攻击者如何利用滑板车内部的漏洞，通过无线方式发动多种攻击，包括物理破坏、勒索软件、用户追踪和数据泄露。课程内容基于对小米M365和米家电动滑板车3（ES3）等型号的深入分析。

## 1. 引言与背景

大家好，我是Marco，目前在瑞典KTH大学从事博士后研究。这项研究是我在法国Eurecom攻读博士学位期间，在共同演讲者Ben Antonioli教授的指导下完成的。我的研究领域是安全与隐私，主要分析蓝牙、Wi-Fi等专有和标准传输协议，以及移动安全。

接下来由Daniela Antonioli发言。感谢大家来听我们的演讲。我是Daniela Antonioli，是位于法国南部的大学和研究中心Eurecom的助理教授。我们的研究涵盖安全和隐私领域，包括蓝牙、电动滑板车、FIDO认证和网络追踪等主题。在我们的研究网站上可以找到更多信息。

在开始演讲前，我想感谢E-Trojans研究项目的三位合著者：Ricardo Castao、Ionor Luzuk和Marco Conti，他们都是意大利帕多瓦大学的研究人员。

以下是本次演讲的大纲。我将首先介绍电动滑板车，并概述E-Trojans的漏洞和攻击。然后Marco将接手，详细介绍其中两种攻击：一种是过压电池破坏攻击，另一种是欠压电池勒索软件攻击。我们的项目中还有另外三种攻击，鼓励大家阅读关于E-Trojans的研究论文以了解更多细节。接着，Marco将介绍我们用于发现这些攻击和漏洞的逆向工程技术、我们开发并部分开源的工具包（包含测试攻击的方法），以及我们在小米滑板车上进行的实验。最后，Marco将总结演讲，介绍我们向小米建议的防护措施，以及过去两年中我们与小米进行的负责任披露过程。

## 2. 电动滑板车简介

首先进行简要介绍，以设定背景。我们讨论的是电动滑板车。你在左边看到的实际上是一个相当复杂的嵌入式系统，它就像一个带轮子的智能手机，拥有无线电接口，可以与智能手机通信。智能手机通常运行一个配套应用程序来控制滑板车。

这两个设备使用专有协议进行通信，这些协议可以通过多种无线技术传输。大多数时候，这种技术是蓝牙低功耗，因为它成本低且普及。但需要记住的重要一点是，在BLE上运行的协议是自定义的、特定于供应商的，可能包含一些安全措施等。

然后，移动应用程序与滑板车的后端（一种云服务）通信。这个通信链路使用标准的互联网协议，如TLS和TCP/IP。

在本次演讲中，我们将重点关注这个红色方框：即滑板车本身、滑板车与移动应用之间的无线链路，以及移动应用本身。这是我们的攻击面。

对于E-Trojans，我们决定重点关注小米滑板车，因为小米是市场领导者。你可能知道M365和米家电动滑板车3，这是两款非常流行的电动滑板车，既用于个人用途，也用于像Bird这样的租赁服务。这款滑板车的配套应用叫做“米家”应用，适用于安卓和iOS，提供多种功能。你可以使用小米后端创建账户，将应用与滑板车配对，然后可以通过应用设置密码来锁定或解锁滑板车，可以从滑板车获取一些传感器读数（如电池电量、电压等），还可以发送固件更新。请记住固件更新这个功能，因为我们将要利用它：恶意固件更新。

研究电动滑板车非常重要，因为如今它们可以通过多种方式被攻击，甚至可以通过无线方式在近距离内远程攻击。攻击滑板车不仅会带来典型的安全和隐私影响（例如，破坏加密协议或泄露敏感数据），而且如果攻击者控制了滑板车，还可能引发安全问题，例如物理损坏，甚至可能导致滑板车起火。因此，保护这些滑板车免受远程和近距离攻击者的侵害至关重要。

## 3. 现有研究与E-Trojans的定位

当我们在2023年开始这项研究时，我们查看了现有技术，发现了Zimperium在2019年的这项工作。在那项工作中，Zimperium演示了一种攻击：他们在攻击者的笔记本电脑上运行一个自定义应用程序，该应用程序能够利用他们逆向工程得到的小米专有协议来制作无线BLE数据包。通过这个应用程序，研究人员能够演示对图中所示滑板车的远程锁定命令。

从这项初步工作出发，我们对小米滑板车进行了广泛的安全评估，并在2023年的ACM WiSec（无线安全和隐私领域的顶级会议）上发表了名为《E-Spoofer》的论文。在这项研究中，我们研究了在冒充受信任的小米“米家”应用时，所有可能危害滑板车的方法。我们演示了基于近距离的攻击：我们使用一个设备，能够恶意地与滑板车配对，然后不仅可以发送锁定命令，还可以发送任何授权命令，就像我们拥有真正的“米家”应用一样。此外，我们将攻击者模型扩展到了所谓的“远程攻击者”，这与之前Zimperium演示的不同。这次，我们在受害者的手机上安装一个恶意应用程序，这个恶意应用程序与“米家”应用共存。然后，只要检测到滑板车在范围内，它就可以发送恶意载荷。这是一种远程攻击面，因为我们可以通过应用程序远程攻击滑板车，并且可以轻松传播恶意应用程序，例如改装应用。当你拥有电动滑板车时，你可以从第三方市场安装这些改装应用来改变滑板车的最大速度。因此，攻击者很容易重新打包这些非常流行且用户不会仔细检查的改装应用，从而危害滑板车。

这就是《E-Spoofer》。随后的论文是《E-Trojans》，这也是本次演讲的重点。在这项研究中，我们从《E-Spoofer》的发现出发，评估了作为远程或近距离攻击者，通过发送这些恶意的专有命令来影响滑板车内部的可能性。因此，重点是滑板车的内部结构。这篇论文的预印本已在arXiv上发布，目前正在提交给学术会议进行评审。

## 4. 滑板车内部架构

让我们快速了解一下滑板车的内部结构。滑板车内部有几个共存的片上系统。一个是驱动电机系统，在图中用黄色标出。这是一个管理电机的芯片。这个芯片连接到BTS和BMS子系统。BTS是蓝牙子系统，这是无线电系统，非常重要，它是通往其他子系统的网关，通过无线信号提供访问。例如，当你发送固件更新时，你想更新DRV的固件，那么固件会通过BLE从“米家”应用发送到BTS，然后BTS使用嵌入式总线（如UART）在内部分发固件。

![](img/4fdfc1acfcc55d787377fccc9e279822_1.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_2.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_3.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_4.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_5.png)

第三个重要的子系统是电池管理系统。这是管理电池、管理滑板车充电的系统。如果你深入了解，它通常包括两个模块：一个是电池控制器，另一个是电池监视器，在图中分别标为BCTL和BMon。

![](img/4fdfc1acfcc55d787377fccc9e279822_6.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_7.png)

需要理解的重要一点是，电池控制器固件可以与DRV固件和BTS固件一起通过无线方式更新。而电池监视器就像一个模拟前端，可以通过电池控制器进行部分编程。它们之间通过嵌入式总线（I2C总线）连接，你可以发送信号来写入和读取寄存器，以编程电池监视器。我们稍后会看到，这可以作为一个攻击向量来危害电池管理系统。此外，还有一个电池充电器，你可以将其插入滑板车进行充电。

这只是一张内部结构的图片。如果你打开一个电动滑板车，你会看到DRV、BMS、电池单元、ST-Link调试器、黑色电缆以及BTS片上系统。BTS片上系统通常位于前灯附近，而其他芯片则位于滑板车底座上，电池也在这里。

这是一张电池管理系统的图片，是双面的：一面是电池控制器，另一面是电池监视器。所以，这是同一个子系统上的两个片上系统。

在我们的E-Trojans评估中，我们重点关注两款非常流行的滑板车。请记住，我们在2023年开始这项分析，当时最著名、最流行的滑板车是米家电动滑板车3，所以我们将其作为目标。这是2021年推出的第二代滑板车。同时，我们也决定瞄准最流行的第一代小米滑板车，即M365。通过瞄准这两款滑板车，我们也间接瞄准了介于它们之间的型号，如Pro、Pro 2、1S和Essential。这些是2018年至2020年推出的滑板车，因此也在研究范围内。

![](img/4fdfc1acfcc55d787377fccc9e279822_9.png)

这只是我们目标芯片的列表。这些滑板车共享这些芯片，芯片可能运行不同的固件版本，但问题仍然存在。BTS运行Nordic nRF51，这是一个非常流行的无线电通信芯片。DRV运行STM32芯片。蓝牙控制器是STM微控制器，采用STM8架构。电池监视器（模拟前端）是德州仪器的芯片，可以部分编程。

![](img/4fdfc1acfcc55d787377fccc9e279822_11.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_12.png)

## 5. E-Trojans漏洞与攻击概述

![](img/4fdfc1acfcc55d787377fccc9e279822_13.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_14.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_15.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_16.png)

现在，让我们看看E-Trojans的漏洞和攻击。我们从以下威胁模型开始：我们有一个拥有电动滑板车的受害者，他通过恶意应用程序与滑板车配对。攻击者可以近距离使用BLE信号攻击滑板车（例如使用带有特殊BLE板的笔记本电脑），或者攻击者可以在受害者的智能手机上安装恶意应用程序，然后从受害者的智能手机攻击滑板车。这就是我们的威胁模型。

![](img/4fdfc1acfcc55d787377fccc9e279822_18.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_19.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_20.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_21.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_23.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_25.png)

我们对这些滑板车进行了广泛的逆向工程，使用了静态和动态技术。Marco稍后会简要介绍这些技术。长话短说，我们发现了影响这些滑板车的四个关键漏洞。

![](img/4fdfc1acfcc55d787377fccc9e279822_26.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_28.png)

第一个漏洞是蓝牙控制器固件未加密。因此，我们能够从“米家”应用以及蓝牙控制器的内存中提取固件，并进行逆向工程。

![](img/4fdfc1acfcc55d787377fccc9e279822_29.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_30.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_31.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_32.png)

![](img/4fdfc1acfcc55d787377fccc9e279822_34.png)

第二个问题是蓝牙控制器固件未签名。这非常糟糕，意味着你可以通过无线信号在电动滑板车上安装恶意固件。这正是我们所做的。所以我们的攻击技术是恶意固件更新，固件就像是一个载荷。利用这种攻击技术，我们可以发起不同的攻击。

第三个漏洞是连接内部片上系统的UART通信缺乏完整性、加密和身份验证。这也很糟糕，因为我们可以将恶意固件更新与以下事实结合起来：我们可以编程蓝牙控制器，使其表现得像DRV或BTS，因为我们可以欺骗内部系统。然后，我们可以发送多种内部消息，从BTS获取数据，阻止BTS知道出了问题，停止充电，或者做任何我们想做的事情。因此，V2和V3的结合非常强大。

第四个问题是拒绝服务，因为内部的UART通信没有针对拒绝服务进行保护。我们能够利用这个漏洞，通过固件更新对滑板车内部发起拒绝服务攻击。

以上就是将在攻击中被利用的四个漏洞。

## 6. E-Trojans攻击技术

这是利用这些漏洞的E-Trojans攻击技术。攻击者与无线电系统通信，无线电系统是进入滑板车内部的网关。攻击者的第一条消息利用了E-Spoofer。如果你还记得，通过E-Spoofer，我们能够利用一些技巧和发现的漏洞绕过身份验证。一旦我们绕过身份验证，我们就可以表现得像真正的“米家”应用一样。

然后，我们通过蓝牙低功耗发送蓝牙控制器固件更新消息。请记住，所有这些消息都不是标准的BLE消息，而是专有消息。因此，你必须先对协议进行逆向工程，才能发送这些消息。

一旦我们发送了这个固件更新消息，无线电系统就会接收固件（固件包含在我们发送的一组消息中），然后将其分发给蓝牙控制器模块。蓝牙控制器模块安装我们的恶意固件，然后回复一条消息，表示一切正常。接着，无线电系统回复攻击者，表示一切正常。这就是E-Trojans攻击技术：一个利用蓝牙控制器缺乏完整性保护的恶意固件（蓝牙控制器不检查签名），同时我们也利用了可以欺骗内部系统的事实，因为内部通信同样没有受到保护。

然后，我们使用这种攻击技术展示了五种新的攻击。

第一种是欠压电池勒索软件。Marco将详细讨论它。据我们所知，这是第一个针对电动滑板车的勒索软件，也是第一个使用欠压作为攻击技术的攻击。

我们展示了过压电池破坏攻击。这是第一个使用过压来攻击任何电动滑板车的攻击。

Marco将详细介绍这两种攻击。接下来，我将重点介绍最后三种攻击。如果你想了解更多细节，可以阅读论文。但基本上，通过第三种攻击，我们可以追踪用户和内部系统。我们展示了通过读取每个滑板车独有的值（如电池序列号、电机序列号）来创建滑板车指纹的可能性。这些都是非常强的指纹。我们创建指纹，然后使用BLE模块广播这个指纹。通过部署嗅探器网络，我们可以基于这个指纹追踪用户。这是首次在电动滑板车上演示这种追踪攻击。然后，我们还进行了拒绝服务攻击，利用我们的恶意固件破坏内部的UART通信。

有趣的是，我们还能够通过滑板车泄露密码，即“米家”应用的密码。这也很重要。当你拥有电动滑板车时，你可以设置密码来锁定和解锁它。但密码不仅存储在手机上，也以哈希形式存储在滑板车上。我们能够恢复这个哈希值，并以与泄露指纹相同的方式泄露它，然后我们可以暴力破解哈希值，从而恢复用户的密码或PIN码。

## 7. 过压电池破坏攻击详解

现在，Marco将接手，继续详细介绍攻击的技术细节。

谢谢Daniela让我来解释攻击中很酷的部分。我们将讨论两种攻击，从过压电池破坏开始。

首先，什么是过压？这是一张电池单元的图片，你的电池内部有多个这样的单元。现在我们讨论的是小米锂电池单元，其工作电压范围为4.2V（100%充电）到3.6V（滑板车停止行驶，电量为0%）。这是正常的操作范围。

电池过压发生在电压溢出时，即电池单元的电压超过4.2V，充电超过100%。如果充电器出现故障或损坏，就可能发生这种情况。这就是我们威胁模型中的假设。

过压是一种非常危险的物理状态，会带来严重后果。例如，导致永久性电池损坏、电池单元变得不平衡（即电压不同）、由于能量增加而过热，并可能导致火灾或爆炸等安全隐患。

电池监视器有一个过压阈值寄存器。如果电池单元的电压超过阈值，电池监视器会在系统状态寄存器中将过压故障位设置为1，并向电池控制器发送警报。电池控制器可以写入电池监视器的寄存器，这意味着我们可以通过电池控制器影响电池监视器，而我们可以通过恶意固件更新访问电池控制器。

例如，我们可以做几件事。我们向过压阈值寄存器写入`0xFF`，将阈值从4.2V设置为4.7V。这是电池监视器支持的最大值，因此我们称之为临界过压，我们超过了电池控制器可设置的最大限制。或者，例如，我们可以将系统状态寄存器中的过压故障位取消设置为0，这样从电池监视器的角度来看，就好像没有发生过压一样。

因此，过压电池破坏攻击始于恶意固件刷入。然后，电池控制器执行以下操作：我们将过压阈值设置为最大值4.7V，这允许我们执行危险的过压操作。然后，我们忽略来自电池监视器的所有过压警报。这意味着无论小米在电池控制器中设置了什么安全措施，我们都不执行并忽略它，因为我们控制了电池控制器。接着，我们取消设置电池监视器中的过压故障位。同时，我们将快速充电位设置为1。正常情况下，如果发生过压，快速充电功能可以阻止充电。如果电池控制器将其设置为1，它就会再次开始充电。现在，由于我们忽略了故障位并使其充电，我们可以超过临界过压阈值。我们也不希望负载均衡，因为负载均衡意味着我们平衡电池单元的电压。如果一个单元过压，我们会将电压分配到其他电压较低的单元，使它们相等。我们希望它们不平衡，我们希望过压。因此，我们更改电池均衡寄存器中的均衡位。最后，我们只是向蓝牙系统和最终用户报告没有发生过压。因此，攻击是隐蔽的。

## 8. 欠压电池勒索软件详解

现在，我们来看一个更复杂的攻击：欠压电池勒索软件。

什么是欠压？现在我们使用相同的电池单元和相同的操作范围。在这种情况下，电池欠压发生在电压下溢时，即电池单元的电压低于3.6V（标称最低值），充电低于0%。是的，这是可能的。

欠压也是一种安全风险，其后果包括永久性电池损坏、电池因损坏而无法再充电，甚至可能发生极性反转。当电池深度放电，电压非常低接近0V，并且有电流通过时，就可能发生这种现象，逆转电池的极性。这非常危险，可能导致火灾、短路和爆炸。

与之前类似，电池监视器中有一个欠压阈值。如果我们低于这个值，就会设置欠压故障位，并向电池控制器发出欠压警报。电池控制器也可以写入欠压寄存器。如果我们写入`0x00`，在这种情况下，我们将欠压阈值设置为可能的最低值1.58V，我们称之为临界欠压，甚至低于最大可设置值。我们也可以取消设置欠压故障位，就像之前一样。

当我们部署欠压电池勒索软件时，我们执行以下操作：我们在电池控制器中刷入我们的固件，然后将欠压阈值设置为最小值1.58V，这样我们就可以执行危险的欠压操作。我们忽略欠压警报，也不执行电池控制器为防止欠压而通常会做的任何事情。我们还取消设置欠压故障位。现在，我们设置快速放电位。放电是同一寄存器中不同的一种设置。这允许滑板车最小化能耗，因为当我们欠压时，意味着我们在消耗电力。如果我们关闭蓝牙系统和电机系统，就会减少消耗，电压可能会得到缓解。我们不希望这样，因此我们将快速放电位设置为1，以便继续放电电池，并达到临界欠压状态。出于与过压相同的原因，我们也不希望均衡。我们希望电压差异大。攻击同样是隐蔽的，因此我们不向蓝牙系统和用户报告任何欠压情况。

UBR是第一个电动滑板车勒索软件。它物理上针对电池，通过欠压物理损坏电池。这与典型的针对数据加密的勒索软件不同。我们在勒索软件中设置了一个触发条件，例如，当我们达到临界欠压时，它会向受害者揭示感染情况。我们通过更改BLE广播来实现这一点：我们向蓝牙系统发送一个小米命令，将设备的BLE广播更改为一个短链接，以下载我们的应用程序。该应用程序向用户解释他的不幸情况，并要求他支付赎金。否则，滑板车将继续消耗电力，电池将永久损坏，并且这种损坏会随着时间的推移而增加。因此，这是一个恢复或停止欠压的倒计时。我们还提供恢复服务。在我们的勒索软件中，我们非常“仁慈”。你可以刷入这个电池控制器恢复固件。这种恢复并不意味着你可以逆转物理损坏，损坏是物理性的，你无法做任何事情。你的电池健康度已经下降，但你可以通过提高电压来解决欠压问题。因为在正常的小米固件中，如果滑板车欠压，你可以为其充电。我们出于安全原因移除了这个功能，但我们为你提供了这个恢复固件，这样你至少可以在剩余的任何条件下使用滑板车。

这种攻击，UBR，也可以在不要求赎金的情况下使用。这只是对你电池的静默破坏，你只需使其欠压，最终电池就会报废。

## 9. 逆向工程、工具包与评估

现在，我将讨论工程细节、今天在GitHub上发布的工具包以及评估结果。

为了理解滑板车的内部架构和固件，我们进行了数月的逆向工程。我们使用了一套动态和静态