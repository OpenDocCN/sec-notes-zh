# 课程 V9znA01MqUc：滥用网络会议进行隐蔽命令与控制 👻

在本节课中，我们将要学习一种名为“幽灵呼叫”的技术，它通过滥用网络会议基础设施来建立隐蔽的命令与控制通道。我们将探讨其原理、优势、实现方法以及防御考量。

---

## 概述

我是 Adam Crossser，Praetorian 的安全工程师。本次课程旨在解决一个实际问题：在红队行动中，我们缺乏一个理想的**短期命令与控制**通道。本节将定义不同类型的C2通道，并解释为何网络会议服务成为了一个极具吸引力的目标。

---

## C2通道类型定义

在深入探讨之前，我们需要明确几种在红队行动中可能用到的命令与控制通道类型。

以下是四种主要类型：

1.  **短期通道**：用于执行需要低延迟和高带宽的任务，例如SOCKS代理、隐藏VNC、远程端口转发或通过主机上的植入程序隧道传输不同工具。
2.  **长期通道**：这是系统重启后仍会持续运行的通道，通常部署在你持续操作的系统上。许多人使用同一个通道处理短期和长期任务，但本课程将解释这有时并非最佳选择。
3.  **备用C2通道**：旨在应对清除行动，提供多种额外的回连方式。攻击者可以发挥创意，例如利用未加入域、未安装EDR的叉车平板电脑等隐蔽位置。
4.  **点对点通信通道**：用于桥接内部网络中的系统。例如，一个系统可以访问内部PCI环境但没有互联网，另一个系统有互联网但不能访问PCI环境，此时可以使用ICMP或命名管道等技术将它们连接起来。

我们当时面临的问题是，缺乏一个令人满意的**短期命令与控制**通道解决方案。

---

## 理想短期C2通道的属性

上一节我们定义了问题，本节中我们来看看一个理想的短期C2通道应具备哪些关键属性。

我们通过头脑风暴，确定了以下四个核心属性：

*   **延迟**：指从发送消息到植入程序接收消息所需的时间。对于交互式操作至关重要。
*   **吞吐量**：指在特定时间段内可以发送的数据量。对于传输大量数据（如文件）非常重要。
*   **可达性**：该通道在企业网络中的普遍程度。如果使用ICMP或Tor等不常见的协议，其可达性就较差。
*   **信任度**：指所使用的基础设施是否被目标环境允许列表排除，或免于某些类型的检查（如TLS解密）。使用受信任的基础设施能降低被发现的风险。

理想的短期C2通道应具备**低延迟、高吞吐量、高可达性和高信任度**。

---

![](img/b455575d60321005c90ad0f3d22f3e03_1.png)

## 评估潜在通道

![](img/b455575d60321005c90ad0f3d22f3e03_3.png)

基于上述框架，我们评估了几种潜在的通道方案。

以下是我们的评估结果：

*   **DNS-over-HTTPS**：延迟较低，但吞吐量存在问题。大量数据通过Google的DoH服务器会显得异常。在企业环境中，内部通常使用自定义DNS，因此可达性一般。信任度尚可。
*   **云文件存储**：吞吐量不错，但延迟通常较高，不适合需要实时交互的任务。可达性取决于具体服务是否被企业屏蔽，信任度中等。
*   **攻击者自有基础设施**：例如购买一个已存在多年的域名。延迟和吞吐量可能很好，但该域名本身就是攻击者资产，缺乏信任度，容易被标记。
*   **电子邮件和即时通讯应用**：延迟因服务而异（电子邮件较高），吞吐量一般。可达性和信任度通常能满足要求。

最终，我们将目光投向了**网络会议基础设施**。

---

## 为何选择网络会议基础设施？

上一节我们排除了其他选项，本节我们来重点分析网络会议服务为何能完美匹配我们的需求。

将理想属性框架套用在网络会议上，会发现它们高度契合：

*   **低延迟**：网络会议设计用于真人实时互动，对延迟容忍度极低。
*   **高吞吐量**：需要传输多个视频流，因此必须具备良好的数据吞吐能力。
*   **高可达性**：疫情后，Zoom、Microsoft Teams等解决方案被广泛使用，大多数公司用户至少会使用其中一种主流产品。
*   **高信任度**：这是关键。许多供应商（如Microsoft和Zoom）在其官方文档中建议，为了确保性能和功能正常，应将流向其服务的流量**排除在全局VPN隧道和TLS解密之外**。这使得这些流量在企业网络中享有特殊“通行权”。

需要声明的是，供应商提出这些建议并非出于恶意或疏忽，而是其低延迟、高吞吐量系统设计的性能要求使然。

---

## 网络会议服务的工作原理

现在我们确定了目标，本节我们来看看这些服务是如何工作的，以及我们可能利用哪些路径来路由流量。

大多数网络会议服务架构相似，我们可以用一个通用模型来描述：

1.  用户设备通过SaaS应用加入会议。
2.  系统为该会议分配或查找一个**媒体服务器**。
3.  通信模式通常有两种：**点对点** 或 **客户端-中央媒体服务器**。
4.  为了协助通信（尤其是在NAT或防火墙后），服务还部署了**STUN/TURN基础设施**。TURN服务器在无法建立直接P2P连接时，充当通信中继。

对于本课程，理解 **WebRTC握手过程** 至关重要。简单来说，两个客户端（如Alice和Bob）需要通过交换 **SDP Offer** 和 **SDP Answer** 来建立连接，协商密钥等信息。

我们研究了Zoom和Google Meet的流量，发现：
*   Zoom使用自定义协议，但本质上是RTP协议的封装。
*   Google Meet使用标准的WebRTC，采用DTLS进行密钥交换，SRTP进行音视频通信。

---

## 网络会议服务的适应性

一个有趣的发现是，这些服务在出站连接方面**极具适应性**。我们可以在严格限制的实验室环境中测试它们的行为。

假设一个极端环境：只允许通过强制执行TLS解密的Web代理出站，阻止所有其他直接连接。

以下是Zoom客户端（桌面版和网页版）的适应过程：

1.  首先尝试通过443/TCP TLS使用自定义协议连接 -> **被阻止**。
2.  切换到通过443/TCP WebSocket连接“区域控制器”来查找媒体服务器 -> **成功**。
3.  尝试直接连接媒体服务器（443/TCP 和 8801/UDP）-> **被阻止**。
4.  切换到通过WebSocket连接发送本应走上述两条通道的数据 -> **成功**。

Zoom网页版略有不同，它使用WebRTC数据通道来传输其自定义协议。当UDP连接被阻时，它会尝试回退到使用 **TURN over TLS (TURNS)** 协议，这通常在严格环境中也能工作。如果还不行，最终会回退到通过WebSocket发送音视频数据。

**核心要点**：这些解决方案能灵活适应不同的网络环境和出口控制，尽管性能会随着回退而下降（例如，使用WebSocket传输音视频会比直接UDP慢）。

---

## 目标选择与凭证获取

我们选择Zoom和Microsoft Teams作为主要目标，因为它们是市场份额最大的两家供应商。即使某个公司内部不使用它们，其员工也极有可能为了与外部客户沟通而使用这些服务，因此相关流量在企业网络中普遍存在。

我们进行了逆向工程：

*   **Zoom**：重点研究了网页客户端，发现了其用于TURN基础设施的凭证。这些凭证关联于 `zoom.us` 子域名，该域名正在供应商建议的允许列表和TLS解密排除列表之内。
*   **Microsoft Teams**：发现了一个无需加入会议即可访问的未认证端点，可以从中获取TURN凭证。

这些凭证的有效期通常为数天，且**不绑定于任何特定会议**。受害者无需安装或使用这些应用，我们只需获取凭证即可利用。

---

## 工具构想与用例

![](img/b455575d60321005c90ad0f3d22f3e03_5.png)

![](img/b455575d60321005c90ad0f3d22f3e03_6.png)

![](img/b455575d60321005c90ad0f3d22f3e03_8.png)

有了理论和技术基础，本节我们来构思需要构建的工具及其应用场景。

我们想构建一个工具，用于创建短期C2植入程序，与现有的长期C2并行使用。它应**与植入程序平台无关**（如Cobalt Strike、Nighthawk或自定义C2），只要能在目标上执行代码即可。

![](img/b455575d60321005c90ad0f3d22f3e03_10.png)

![](img/b455575d60321005c90ad0f3d22f3e03_11.png)

![](img/b455575d60321005c90ad0f3d22f3e03_12.png)

![](img/b455575d60321005c90ad0f3d22f3e03_13.png)

![](img/b455575d60321005c90ad0f3d22f3e03_15.png)

在网络层面，使用此工具的几个小时流量看起来就像在进行视频通话，但实际上我们正在利用供应商的基础设施进行：
*   SOCKS代理
*   内部网络扫描
*   远程端口转发
*   浏览内部Web应用等高带宽操作

**为何需要与长期C2并行？**
1.  **性能**：长期C2通道可能较慢，不适合高带宽任务。
2.  **隐蔽性**：长期C2通道本身可能很隐蔽，但一旦开始传输大量数据（如10GB），异常流量模式就容易引起怀疑。而通过会议通道传输大量数据，观察者会自然地认为是视频流量。

我们构建的工具名为 **TurnTunneler**。它支持以下关键用例：

以下是TurnTunneler的主要用例：

![](img/b455575d60321005c90ad0f3d22f3e03_17.png)

1.  **SOCKS代理**：通过TURN基础设施进行代理上网。
2.  **去中心化C2**：无需中央C2服务器，可直接在操作员机和受害机之间建立点对点连接，适用于“假定突破”场景。
3.  **本地与远程端口转发**：
    *   **远程端口转发**：在受害机上绑定一个端口，所有连接到该端口的流量通过Tunnel（如Microsoft Teams）转发到操作员机上的服务。例如，暴露一个在操作员机上运行的 `ntlmrelayx` 工具到内网。
    *   **本地端口转发**：在操作员机上绑定一个端口，通过该端口的流量会通过Tunnel**从受害机**发起连接。例如，访问一个仅限内网访问、无需MFA的Citrix服务。

![](img/b455575d60321005c90ad0f3d22f3e03_18.png)

![](img/b455575d60321005c90ad0f3d22f3e03_20.png)

![](img/b455575d60321005c90ad0f3d22f3e03_22.png)

---

![](img/b455575d60321005c90ad0f3d22f3e03_24.png)

![](img/b455575d60321005c90ad0f3d22f3e03_25.png)

## 演示：Zoom 与 Microsoft Teams

本节我们将通过两个简单的演示来展示攻击流程。

![](img/b455575d60321005c90ad0f3d22f3e03_27.png)

**演示1：Zoom**
1.  **获取凭证**：在操作员机上，使用配置了Burp Suite的浏览器加入一个Zoom会议。会议加载后，在Burp的历史记录中搜索约1200字节的响应，其中包含TURN凭证。
2.  **建立隧道**：将凭证填入配置文件。在操作员机上运行控制器组件，生成一个 **SDP Offer**。通过现有C2通道（演示中用SSH代替）在受害机上运行中继组件，并输入该Offer。WebRTC连接通过Zoom的TURN基础设施建立。
3.  **数据传输**：通过建立的隧道下载文件，速度可达约8-10 MB/s。
4.  **网络流量**：在Wireshark中可见到往 `zoom.us` 子域名的TLS连接。

![](img/b455575d60321005c90ad0f3d22f3e03_29.png)

> **注**：Zoom在近期已对此进行了缓解，修改了其TURN服务器策略，限制了连接目标。但该技术对Microsoft Teams仍然有效。

![](img/b455575d60321005c90ad0f3d22f3e03_31.png)

**演示2：Microsoft Teams**
1.  **获取凭证**：使用我们编写的凭证获取工具自动从Microsoft Teams端点获取TURN凭证。
2.  **建立隧道与端口转发**：流程与Zoom类似。建立连接后，演示下载一个100MB的文件。然后，演示**远程端口转发**：在操作员机上运行一个简单的Python HTTP服务器，通过工具在受害机的8080端口上创建远程转发。此时，从外部访问受害机8080端口的流量，会被通过Microsoft的TURN基础设施转发到操作员机上的HTTP服务器。
3.  **网络流量**：在Wireshark中可见到往 `teams.microsoft.com` 子域名的TLS连接。

---

## 防御考量与未来工作

课程最后，我们来探讨防御思路和该技术的未来发展方向。

**防御建议：**
*   **检测重点转移**：在网络层面检测此类隧道非常困难。建议将重点放在**杀伤链的其他环节**。
    *   不要试图检测隧道本身，而是检测**通过该隧道运行的攻击工具**（如 `secretsdump.py`, `ntlmrelayx` 等）。
    *   关注异常行为，例如从未安装会议客户端的进程发起对会议域名的连接，但请注意这可能有误报。
*   **利用诱饵**：考虑在内网关键应用（Confluence, Slack等）或云服务上部署**诱饵令牌**，攻击者一旦通过隧道访问就会触发告警。
*   **供应商缓解**：供应商可以限制TURN凭证的用途。例如，Zoom的缓解措施表明，如果TURN仅用于连接中央媒体服务器（而非通用P2P），则可以进行限制。

**未来工作：**
*   **扩展研究**：研究除Zoom和Teams外的其他网络会议提供商（如Webex, Google Meet）或提供托管TURN服务的厂商（如Cloudflare），寻找可用的凭证。
*   **优化工具**：当前中继组件用Go编写，体积较大。探索用C/C++重写以减小体积。
*   **调查安全设备默认配置**：了解常见安全设备是否默认遵循了供应商关于排除TLS解密的建议。

---

## 总结与资源

本节课中，我们一起学习了“幽灵呼叫”技术。我们分析了短期C2通道的理想属性，发现网络会议基础设施因其低延迟、高吞吐量、高可达性和高信任度而成为理想载体。我们探讨了其工作原理、适应性，并演示了如何通过获取TURN凭证来滥用Zoom和Microsoft Teams的服务建立隐蔽隧道，实现SOCKS代理和端口转发。最后，我们讨论了以检测工具而非隧道为核心的防御思路，以及该领域的未来研究方向。

**相关资源：**
*   **深度技术博客**：包含更详细的技术细节。
*   **工具GitHub仓库**：可下载TurnTunneler工具，并提供与Nighthawk等C2平台集成的文档。
*   **联系作者**：可通过LinkedIn联系Adam Crossser进行交流。

---