# 课程 01: “检测到坏点” - 苹果图形子系统安全评估 🖥️🔍

在本课程中，我们将学习苹果图形子系统的安全状况。我们将探讨其架构、其中发现的安全漏洞，并分析这些漏洞的成因与影响。课程内容基于对多个内核模块和固件组件的深入研究。

## 图形子系统架构概览

首先，我们快速浏览一下苹果图形子系统的架构。

我知道它看起来很复杂。现在请不要细读，稍后可以仔细查看。我们想在这里说明的观点是：图形子系统过于复杂，难以做到完美。

让我们首先关注内核模块，特别是中间部分。这部分包含了负责与不同供应商（包括英特尔、AMD和苹果自研芯片的GPU）的GPU进行通信的内核模块。

以下是我们在过去从这些模块中发现的三个漏洞，我将逐一介绍它们。它们分别对应AMD GPU平台、基于英特尔的内核插件扩展以及苹果英特尔和E帧缓冲内核扩展。

## 内核模块中的漏洞分析

上一节我们介绍了图形子系统的整体架构，本节中我们来看看其中一些具体的内核模块漏洞。

### 漏洞一：AMD支持内核扩展中的任意内存写入

第一个要讨论的漏洞可导致任意内存写入。这是调试器中崩溃的字符串截图。我们可以看到，偏移量被用来计算一个内核内存地址。

崩溃发生处的指令显示，寄存器RCX是一个用于计算内核内存地址的偏移量。如果你查看该寄存器中存储的值，它是一个“魔法值”，这意味着它完全可由用户控制。

从回溯中我们还可以看到，这个漏洞源于AMD支持内核扩展。漏洞的根本原因是该函数没有对用户输入进行充分的清理。

### 漏洞二：显示矩阵模块中的越界读写

类似地，由于缺乏检查，这个显示矩阵模块也存在一个越界读写漏洞。如果你注意一下符号，会发现这个模块中所有相关函数都没有符号名。这不是我们不愿意分享细节，而是因为苹果没有为这个模块提供内核调试符号。正如你所料，逆向工程这个模块耗费了我们大量的精力。

### 漏洞三：AppleIntelMEClientController模块中的类型混淆

这是AppleIntelMEClientController模块中的另一个类型混淆漏洞。在正常情况下，这些函数会在堆上分配一个大小为40字节的对象。然而，存在一个易受攻击的分支，它错误地将这些对象视为一个更大的结构体，从而导致越界内存访问。屏幕上显示的是发生越界访问和调用栈的位置。

我刚才讨论的这三个漏洞都相对较旧。现在，让我分享一个我们最近在AppleIntel图形模块中发现的新漏洞。

## 近期发现的漏洞

我们已经讨论了相对较旧的漏洞，现在让我们关注一个近期在AppleIntel图形模块中发现的新问题。

其根本原因是，`In content key`这个特定函数没有对用户提供的参数进行任何检查，而这些参数将被用于索引要写入的内存地址。正如我们所见，索引存储在寄存器RCX中，它被设置为一个魔法数字，这也意味着它可由用户控制。

另一个有趣的漏洞是我们在去年十月发现并提交的，但直到今年秋天才会修复，因此我们无法分享更多细节。我们怀疑该模块正在进行重大的代码重构以消除整个攻击面，这就是为什么修复需要将近一年的时间。

## 苹果自研GPU模块的漏洞

现在我们已经讨论了苹果用于英特尔和AMD GPU的内核模块，我们也不应遗漏苹果自己的GPU，对吧？

首先，这里有一些其他安全研究人员发现的先前漏洞的优秀资料，如果你想了解更多关于这些模块的信息，我们强烈建议阅读。

其中，第一篇和第三篇博客都是苹果图形加速器模块的经典漏洞。虽然第二篇博客是针对基于英特尔架构的案例研究，但文章中提到的攻击面与我即将讨论的一个新漏洞直接相关。

### 漏洞四：GPU通知队列机制

关于我们在苹果自家GPU模块中发现的漏洞，我想分享的第一个与GPU的通知队列机制有关。

在逆向工程接口时，我们发现了这个特定的函数`create_notification_queue`，它接受来自用户的两个关键参数，但清理不足：条目数量和条目大小，这将导致越界访问。

为了验证这是一个真正的漏洞，我们还制作了一个简单的概念验证来触发它。这是调试器中该崩溃的截图。

该漏洞的补丁也很直接。我们只需要确保输入经过清理并且是有效的。

一个有趣的故事是，我们确切知道这个漏洞会导致可被进一步利用的越界写入。然而，苹果安全更新的描述仅仅说这是一个拒绝服务漏洞。这是因为我们提交给苹果的概念验证只是由于访问了某些随机无效地址而导致内核崩溃。然而，如果我们精心构造概念验证，它就会变成一个更强大的越界写入原语。

![](img/302f76300944753de947e20632e04cdc_1.png)

![](img/302f76300944753de947e20632e04cdc_2.png)

你可能会问，为什么我们如此在意这一句可能没人会注意的话？我们确实在意。拒绝服务不如越界写入严重。安全社区已经达成明确共识，本地拒绝服务不应有资格获得CVE分配。所以我们对此很认真。这不仅仅是我个人的看法，这样的描述会导致混淆。我们还发现其他一些研究人员也被苹果更新的描述搞糊涂了，他们甚至写文章解释为什么例如空指针解引用无法被利用，以及为什么苹果甚至为这些低风险漏洞分配CVE。事实是，他们只是没有仔细考虑实际的根本原因和安全影响。我们已经与苹果沟通，他们承诺会更新描述以使其更清晰。

### 漏洞五：GPU资源分配函数

今天我想分享的另一个漏洞与GPU的资源分配函数有关。

这次的描述很清晰。这是一个影响iOS和macOS的内核内存写入漏洞。

正如我之前提到的，为了让描述尽可能准确，你必须证明这个漏洞是可被利用的。这是我们初始概念验证的崩溃截图。我们没有提交这个，因为我们确切知道苹果只会将其视为本地拒绝服务。因此，我们做了大量工作来改进概念验证，以证明这实际上是可被利用的。在这里我们可以看到，用于计算内核内存地址的寄存器是X8和X9，我们成功地操纵了这两个寄存器，使其指向一个有效的内核地址，从而导致可被利用的越界写入。

关于这个漏洞的另一件有趣的事情是，最初的补丁只处理了我们在概念验证中报告的代码路径。因此，他们没有进行充分的检查。我们发现了另一种不同的输入，可以绕过他们最初的补丁。

所以这是我们制作的新概念验证的另一次崩溃，在我们提交另一个概念验证给他们之后，他们不得不再次修补同一个漏洞。

## IOMobileFramebuffer 模块的漏洞

接下来，我将讨论我们在另一个内核组件中发现的漏洞，特别是这个IOMobileFramebuffer。

如果你了解的话，这实际上是iOS安全社区中一个备受关注的攻击面。这是因为可以直接从网页内容访问此组件，这意味着该组件可以帮助攻击者突破浏览器沙箱等防御。

根据公开记录，过去20年中已报告了16个来自该模块的内核漏洞，其中4个被APT组织积极利用，两个被用于iOS越狱工具，还有一个在安全竞赛中亮相。

从2011年到2020年的时间线可以看出，这个特定模块IOMobileFramebuffer中的漏洞数量并不多，只报告了几个漏洞。

然而，在2020年左右出现了一个转折点。一次重大的代码重构引入了大量的内核漏洞。这就是为什么我们在接下来的两年里目睹了该模块安全问题的急剧激增。

在这里，我们想强调两点。首先，你可以看到大约有六个月的窗口期，这反映了安全社区对新模块中漏洞的典型响应时间，大约是半年。其次，我们认为这种鲁莽的重构有时会给系统带来灾难性的后果。

自那以后，该模块没有报告新的漏洞。这是否意味着它已经足够安全了？

这里需要注意的一点是，实际上2024年报告了一些其他漏洞。它们实际上被错误地归类为IOMobileFramebuffer漏洞。事实上，它们是来自显示协处理器固件的问题，我稍后会谈到。

对于想了解更多关于这个模块的人，请参考这些资源。这些都是非常好的资料。它们从一些简单且非常容易上手的目标开始。

## 架构转变与新攻击面

从2021年下半年开始，出现了一个新趋势。许多关键功能的实现已从IOMobileFramebuffer模块下移到更下一层，即显示协处理器固件。这种架构转变意味着用户模式不能再直接访问这个攻击面，有效地形成了一定程度的纵深防御。

在这种情况下，我们还能在这个模块中找到新的漏洞吗？答案当然是肯定的。否则，我就不会谈论它了。

以下是反编译的代码片段，我会展示几秒钟，看看观众中是否有人能发现问题。这只是带有单个参数的几行代码。

我还高亮了你应该注意的地方。从截图中我们可以看到，输入参数是一个有符号整数，但实际上在第15行被用作无符号整数。中间还有一个条件检查，以确保索引不会太大。然而，正如你所想象的，如果索引是负值，这很容易被绕过。

我相信，大多数编译器应该能够轻松检测到此类问题，但我们惊讶地了解到，这个漏洞直到最近仍然存在。这是该漏洞崩溃的截图。

这是该漏洞的调用栈。值得注意的是，这个漏洞可以直接由用户触发，无需申请任何权限或授权。

另一件有趣的事情是，我们实际上发现macOS的两个主要版本对此漏洞有两种不同的修复实现。第一种方法是保持输入参数索引为有符号整数，并在此函数中添加了另一个负值检测检查。第二种方法则完全不同。它将此索引转换为无符号值，这样他们就不需要在那里添加任何新的检查了。

我们很好奇为什么存在两种不同的补丁，这似乎意味着他们有不同的小组在为不同版本的macOS处理同一个模块。我不知道观众中是否有人对此有见解。如果能知道原因，那会非常有趣。

我们还发现了一些其他问题，但它们都很相似，因此不再赘述。

## 深入固件层

现在，让我们再深入一层，到固件层。

首先，我想参考这个Asahi Linux和M1N1项目作为背景。该团队在DCP架构的逆向工程方面做了非常扎实的工作。

我们还列出了该领域几个众所周知的漏洞，包括一些被称为Intro和Invite的CVE。强烈推荐阅读关于这些漏洞的分析报告。

为了理解DCP及其潜在的攻击面，我们基于此分析，对DCP架构及其与应用处理器的通信接口进行了逆向工程。基于此分析，我们开发了一个定制的模糊测试工具。

通过模糊测试，我们成功触发了大量的崩溃。例如，像这个，你可以从内存中看到一些关于崩溃的信息。例如，在这个红色方框中，你可以看到像“AT固件报告异常”这样的字符串。

这是另一个表明DCP固件存在问题的崩溃日志截图。我们还提供了崩溃的调用栈。你可以看到崩溃数据是通过这个RTBuddy机制在DCP和AP之间传递的。所以DCP和AP是不同的处理器。它们彼此通信的方式就是通过这个RTBuddy机制。这也是我们如何从固件收集详细错误报告的方式。我们直接从调试器读取内存数据来收集所有这些信息，这确实帮助我们更好地理解漏洞的根本原因。

我们的模糊测试还发现了几个有趣的新接口，包括一个在以往安全研究中很少受到关注的视频接口。使用这些接口，用户模式应用程序可以直接与DCP固件通信，无需任何权限或授权。

所有这些崩溃标志着我们研究的突破。通过进一步分析这些接口，我们发现了额外的漏洞，包括这一个。你可以看到这是最近才确认的，苹果确认这个漏洞实际上影响了iOS和macOS的最新版本。

这是模糊测试期间该漏洞的崩溃日志。我们可以看到DCP通过这个RTBuddy机制传输了大量信息。然而，由于攻击面仍然存在问题，我们目前无法披露其细节。我们现在可以分享的是，DCP显示协处理器固件中的许多寄存器，如R2、R8甚至这个LR链接寄存器，都可以由用户直接控制。这些漏洞和攻击面构成了重大风险。

## 总结与启示

最后，我们总结几点启示。

让我们回顾一下这张幻灯片。我们的研究在几乎每一个图形子系统组件中都发现了漏洞，涵盖了传统的AMD、英特尔GPU架构、AGX GPU设计、苹果的内核模块（如流行的IOMobileFramebuffer），甚至包括像DCP这样的固件。虽然已经取得了重大的安全进展，但我们相信仍有改进的空间。

我们将从三个角度总结本次演讲：安全工程、漏洞挖掘以及攻防态势。

首先，从安全工程的角度来看：
*   新功能总是意味着新的攻击面。
*   鲁莽的代码重构有时会对系统造成重大的安全影响。
*   即使在人工智能和自动编码的时代，也无法保证它们总能产生正确的代码。这就是为什么我们应该制定策略或强制人们使用静态或动态分析工具，以使我们的代码更安全。
*   定期审查编译警告是必要的。例如，有符号和无符号整数之间的比较，应该很容易被常规的静态分析器检测到，但它仍然被遗漏了。因此，我们建议人们定期审查所有警告，而不是忽略它们。

其次，从漏洞挖掘的角度来看：
*   某些复杂的内核功能被安全社区反复发现包含严重漏洞。我们在苹果的蓝牙、Wi-Fi和图形子系统中发现了大量案例。
*   就图形子系统中的漏洞数量而言，虽然我们只找到了比过去分析的其他模块更少的漏洞，但我们并不认为这是因为这个特定的图形子系统模块更安全。相反，我们觉得这只是因为苹果没有为相关模块提供足够的调试信息，而且他们确实有一些纵深防御措施，就像我前面提到的。他们将一些主要组件从一层移到另一层，这样攻击面就不会直接暴露给用户，但代码仍然在那里。他们只是把它们从上层隐藏了起来。但是，如果你知道它们如何在各层之间通信，你仍然可以找到触发那些有问题的代码的方法。
*   正如我所说，多个领域之间存在显著的知识差距。系统本身已经足够复杂，更糟糕的是，苹果没有提供足够的信息。所有这些因素都使得安全研究更加困难。我们认为，弥合这些差距将真正有助于安全。我们拥有来自安全社区的优秀专家，他们不断致力于此，这将使整个系统更加安全。

最后，我们想强调这个特定的模块：IOMobileFramebuffer。正如我之前提到的，这个模块可以直接从浏览器和网页内容访问。这就是为什么该领域的攻防竞争一度达到了白热化的程度。

从时间线分析来看，在2020年至2022年期间，漏洞研究相对于代码重构发生的时间存在滞后，这反映了我们发现漏洞的时间大约有半年的滞后。

因此，将易受攻击模块（如IOMobileFramebuffer）的功能转移到显示协处理器固件的做法，在某种程度上是有效的，因为它使人们更难分析和理解代码。但这种缓解措施只是稍微提高了门槛。然而，如果你没有修复根本原因，人们最终仍然会在那里发现漏洞。

本节课中我们一起学习了苹果图形子系统的安全状况，分析了从传统GPU支持模块到现代自研GPU架构，再到关键内核组件和底层固件中存在的多种类型漏洞。我们看到了代码复杂性、重构引入的风险以及安全工程实践的重要性。希望这些内容能帮助你理解该领域的安全挑战与研究思路。