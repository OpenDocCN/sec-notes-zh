# 课程 1: ECS-cape – 在 Amazon ECS 中劫持 IAM 权限 [UV-hS-DTeik] 🚨

![](img/d3f1f886cd1d66057c8940fb33cef9e6_1.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_3.png)

在本节课中，我们将学习一个名为 **ECS-cape** 的漏洞。这个漏洞允许在同一个 EC2 实例上运行的一个容器，通过内部 AWS 协议，劫持另一个权限更高的容器的凭证。在某些情况下，这足以接管整个云环境。我们将深入探讨其技术背景、发现过程、工作原理、影响以及缓解措施。

---

![](img/d3f1f886cd1d66057c8940fb33cef9e6_5.png)

## 技术背景 📚

![](img/d3f1f886cd1d66057c8940fb33cef9e6_7.png)

在深入探讨漏洞细节之前，我们需要了解一些核心概念。上一节我们介绍了课程概述，本节中我们来看看理解 ECS-cape 所需的关键技术背景。

### 什么是 IAM？

IAM 代表 **身份和访问管理**。它是 AWS 中定义“谁可以访问什么”以及“他们可以做什么”的系统。它有两个主要组成部分：**策略** 和 **角色**。

*   **策略** 是一个 JSON 文档，列出了允许和拒绝的操作。例如：
    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": "s3:*",
                "Resource": "*"
            }
        ]
    }
    ```
*   **角色** 是一个附加了一个或多个策略的身份。角色可以被“担任”，这意味着你可以获得与该角色权限关联的临时凭证，并以该角色的身份行动。

### 什么是 Amazon ECS？

Amazon ECS 是 AWS 原生的容器编排服务。它本质上是 Kubernetes 的一个更简单的托管替代方案，在你的云环境中运行 Docker 容器，并与 IAM、日志记录和网络等 AWS 核心功能深度集成。

以下是贯穿本课程的三个核心概念：

![](img/d3f1f886cd1d66057c8940fb33cef9e6_9.png)

*   **集群**：一组由 Amazon ECS 管理的 EC2 实例。容器将在这些实例上运行。
*   **服务**：确保指定数量的任务持续运行。它处理重启、扩缩容和部署等事务。
*   **任务**：由任务定义指定的单个运行单元。它包含一个或多个容器（如你的应用、边车或日志收集器）。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_10.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_12.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_14.png)

在 ECS 中，每个任务被分配两个 IAM 角色：
1.  **任务角色**：定义任务内容器可以在云环境中执行的操作。
2.  **任务执行角色**：供 ECS 自身使用，任务本身无法访问。它授予 ECS 为任务拉取容器镜像和获取密钥的权限。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_16.png)

### ECS 在 EC2 启动类型下的工作原理

![](img/d3f1f886cd1d66057c8940fb33cef9e6_18.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_20.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_22.png)

本课程重点讨论 **EC2 启动类型**，因为这是漏洞实际生效的环境。

每个 EC2 实例都被分配一个唯一的 **实例角色**，该角色具有特定的 ECS 权限。在该实例上，运行着 Docker 守护进程（实际运行你的容器）和一个名为 **ECS 代理** 的组件。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_24.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_25.png)

ECS 代理充当 AWS 控制平面和实例本身之间的桥梁。它使用实例角色向 AWS 控制平面进行身份验证，并接收诸如“启动此任务”、“停止那个任务”等指令。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_27.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_29.png)

这个整体单元（EC2 实例 + ECS 代理）就是 AWS 所称的 **容器实例**。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_31.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_32.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_34.png)

---

![](img/d3f1f886cd1d66057c8940fb33cef9e6_36.png)

## 漏洞的发现过程 🔍

![](img/d3f1f886cd1d66057c8940fb33cef9e6_38.png)

上一节我们介绍了 ECS 的基本工作原理，本节中我们来看看这个漏洞是如何被发现的。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_40.png)

故事始于一个需求：监控 ECS 任务。通过检查运行的容器，我发现 Docker 标签包含了大部分所需信息，但缺少 **服务名称**。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_42.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_44.png)

在线搜索后，我发现了 ECS 代理向每个任务公开的一个特殊端点：`http://169.254.170.2/v2/metadata`。它返回了大量关于任务本身的信息，最重要的是，它包含了服务名称。

但问题来了：ECS 代理是如何获取这些信息的？我检查了实例角色的权限，发现它并没有列出运行中服务的权限。这引发了我的好奇心。

通过设置代理服务器检查 ECS 代理的通信，我注意到它使用 WebSocket 连接到 ECS 服务，并传递了一个特定的查询参数：`sendCredentials=true`。这让我怀疑：**我能否冒充 ECS 代理？**

---

![](img/d3f1f886cd1d66057c8940fb33cef9e6_46.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_48.png)

## 漏洞技术原理深挖 ⚙️

上一节我们了解了漏洞的发现线索，本节中我们深入探讨其技术原理。

### ECS 代理的正常工作流程

![](img/d3f1f886cd1d66057c8940fb33cef9e6_50.png)

首先，ECS 代理是完全开源的，这对研究很有帮助。其实例角色拥有几个关键的 ECS 权限，在我们的漏洞中扮演重要角色：

![](img/d3f1f886cd1d66057c8940fb33cef9e6_52.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_54.png)

1.  **注册容器实例**：代理使用 `RegisterContainerInstance` API 将自己注册为控制平面中的一个新容器实例。
2.  **发现轮询端点**：代理使用 `DiscoverPollEndpoint` API 获取一个特定的 URL（轮询端点）。
3.  **建立 ACS 连接**：代理使用轮询端点 URL 和一系列标识符构建一个 WebSocket 请求，并通过 `sentCredentials=true` 参数进行身份验证。一旦连接建立，AWS 控制平面就开始通过这个 WebSocket 发送**同一实例上所有任务的任务角色和任务执行角色的凭证**。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_56.png)

这个 WebSocket 使用一种名为 **ACS** 的内部 AWS 协议进行通信，该协议承载任务元数据、代理级别指令以及最重要的——IAM 凭证。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_58.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_60.png)

### 攻击者如何冒充 ECS 代理？

![](img/d3f1f886cd1d66057c8940fb33cef9e6_62.png)

核心问题是：**一个任务能否冒充 ECS 代理？**

![](img/d3f1f886cd1d66057c8940fb33cef9e6_64.png)

攻击流程如下：

1.  **获取实例凭证**：每个 EC2 实例都有一个特殊的 HTTP 端点，称为 **实例元数据服务**。在 ECS 中，IMDS 默认启用，且对实例上运行的每个任务可访问。这意味着任何任务都可以获取**实例角色**的凭证，而 ECS 代理使用的正是这个角色。
    *   代码示例（在容器内执行）：
        ```bash
        curl http://169.254.169.254/latest/meta-data/iam/security-credentials/<instance-role-name>
        ```

![](img/d3f1f886cd1d66057c8940fb33cef9e6_66.png)

2.  **发现轮询端点**：使用获取到的实例凭证，调用 `DiscoverPollEndpoint` API，获得轮询端点 URL。

3.  **构建 ACS 请求**：要构建有效的 ACS WebSocket 请求，需要一系列标识符（如集群 ARN、容器实例 ARN）。这些信息可以通过以下方式获取：
    *   **IMDS**：提供实例级信息。
    *   **任务元数据端点** (`http://169.254.170.2/v2/metadata`)：提供任务级信息。
    *   **容器自检 API**：这是 ECS 代理向每个任务公开的另一个端点 (`http://172.17.0.1:51678/v1/tasks`)，它提供了**容器实例 ARN** 等关键信息，补全了拼图的最后一块。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_68.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_70.png)

4.  **连接并劫持凭证**：使用所有收集到的标识符和实例凭证，构建一个有效的 ACS WebSocket 请求并连接到 AWS 控制平面。控制平面验证调用者是否拥有 `Poll` 权限（实例角色拥有此权限），因此连接通过身份验证。随后，控制平面开始通过这个 WebSocket 发送同一实例上**所有其他任务**的凭证，误以为正在与真正的 ECS 代理通信。

**关键点**：攻击者获得的是 AWS 已代为担任角色的、立即可用的凭证。在 CloudTrail 日志中，这些操作看起来像是来自合法的 ECS 服务本身，而不是攻击者容器。

---

![](img/d3f1f886cd1d66057c8940fb33cef9e6_72.png)

## 漏洞影响 💥

![](img/d3f1f886cd1d66057c8940fb33cef9e6_74.png)

上一节我们弄清了攻击原理，本节中我们评估其实际影响。

### 1. 任务 IAM 角色劫持
假设一个 EC2 实例上运行着两个任务：一个低权限任务和一个高权限任务。如果低权限容器被攻击者攻陷，利用 ECS-cape，攻击者可以横向移动，劫持高权限任务的凭证，从而访问原本无法触及的资源（如 S3 存储桶）。

### 2. 滥用任务执行角色
任务执行角色本应仅供 ECS 自身使用。但通过 ECS-cape，攻击者可以劫持该角色的凭证，直接与 AWS Secrets Manager 等服务通信，获取本应注入给其他任务的敏感信息（如数据库密码）。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_76.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_78.png)

### 3. 多租户环境下的租户逃逸
在常见的多租户设置中，不同租户的任务可能运行在同一 ECS 集群的同一实例上。访问控制依赖于 IAM 和任务隔离。ECS-cape 允许租户 A 的攻击者劫持租户 B 的任务凭证，从而访问其数据和服-务，实现**租户逃逸**。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_80.png)

### 4. 访问 ECS 内部信息
通过模拟 ACS 协议，攻击者还能获取大量关于集群本身、其他任务和实例的元数据，这些信息在漏洞利用前是无法直接获取的。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_82.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_84.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_86.png)

**重要提示**：此漏洞**无需任何错误配置**即可利用。IMDS 在默认 ECS 设置中启用，实例角色也默认拥有必要权限。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_88.png)

---

![](img/d3f1f886cd1d66057c8940fb33cef9e6_90.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_92.png)

## 演示 🎬

![](img/d3f1f886cd1d66057c8940fb33cef9e6_94.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_96.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_98.png)

上一节我们讨论了理论影响，本节中我们通过一个演示来直观感受。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_100.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_101.png)

我创建了一个包含三个任务的集群：
1.  **ECS-cape 任务**：任务角色权限为 `Deny: *`（无任何权限）。
2.  **S3 控制任务**：任务角色拥有 `AmazonS3FullAccess` 策略。
3.  **数据库任务**：无任务角色，但有一个可访问 Secrets Manager 的任务执行角色。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_103.png)

**演示 1：劫持 S3 权限**
*   从 ECS-cape 任务 shell 中，尝试删除一个 S3 存储桶，操作被拒绝。
*   运行 ECS-cape 利用工具，工具成功劫持了 S3 控制任务的凭证。
*   再次尝试删除 S3 存储桶，操作成功。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_105.png)

**演示 2：劫持任务执行角色以获取密钥**
*   从 ECS-cape 任务 shell 中，尝试读取数据库任务使用的 Secrets Manager 密钥，操作被拒绝。
*   运行 ECS-cape 利用工具，工具成功劫持了数据库任务执行角色的凭证。
*   直接使用该凭证从 Secrets Manager 读取密钥，成功获取明文密码。

在 CloudTrail 日志中，这些操作看起来完全来自合法的 S3 控制任务和数据库任务，没有攻击者容器的踪迹。

---

## 缓解措施与最佳实践 🛡️

![](img/d3f1f886cd1d66057c8940fb33cef9e6_107.png)

上一节我们看到了漏洞的强大威力，本节中我们学习如何防御。

### 1. 禁用对任务的 IMDS 访问
这是最重要的措施。如果任务无法访问 IMDS，就无法获取实例角色凭证，从而无法冒充 ECS 代理。
*   **注意**：切勿在实例级别禁用 IMDS，因为 ECS 代理依赖它。应仅针对特定任务容器禁用。
*   **方法**：可以通过配置 `iptables` 规则在容器网络命名空间内阻止对 IMDS 端点 (`169.254.169.254`) 的访问。这通常需要在任务定义或启动脚本中实现。

### 2. 严格管理任务角色权限
*   **切勿**为任务角色授予 `ecs:Poll` 和 `ecs:DiscoverPollEndpoint` 权限。
*   **避免**使用包含通配符 (`*`) 的 ECS 权限策略，因为它们可能隐含上述危险权限。
*   **遵循最小权限原则**：只授予任务执行其功能所必需的最精确权限。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_109.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_111.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_113.png)

### 3. 谨慎配置任务执行角色
*   不要过度授权任务执行角色。尽管它旨在供 ECS 使用，但其凭证可能通过此漏洞暴露。
*   避免所有任务共享一个高权限的任务执行角色。根据任务需求进行分离和最小化授权。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_115.png)

![](img/d3f1f886cd1d66057c8940fb33cef9e6_117.png)

### 4. 工作负载隔离
*   **分离高低权限工作负载**：不要将低权限和高权限任务部署在同一 EC2 实例上。可以通过配置容量提供者或使用独立集群来实现。
*   **隔离多租户环境**：为不同租户使用不同的集群，或至少在 EC2 实例级别进行隔离。

![](img/d3f1f886cd1d66057c8940fb33cef9e6_119.png)

---

## 总结与回应 📝

![](img/d3f1f886cd1d66057c8940fb33cef9e6_121.png)

在本节课中，我们一起学习了 ECS-cape 漏洞。我们了解到：

1.  在 EC2 启动类型下，ECS 任务与 ECS 代理共享同一个安全边界。
2.  一个任务可以利用 `Poll` 和 `DiscoverPollEndpoint` 权限（通过 IMDS 获得的实例角色拥有）来冒充 ECS 代理。
3.  成功冒充后，攻击者可以劫持同一实例上所有其他任务的 IAM 角色凭证和任务执行角色凭证。
4.  缓解措施的核心在于**任务级别的强化**：禁用非必要的 IMDS 访问，并严格遵循最小权限原则配置任务角色和任务执行角色。

我将此漏洞报告给 AWS。AWS 的回应是，这不被视为 AWS 的一个安全问题，因为代理运行在客户的安全边界内，容器本身不是安全边界。他们更新了文档以反映这种潜在风险，并考虑长期的防御性改进。

**最重要的收获**：在云安全中，绝不能盲目信任默认配置或服务边界的承诺。主动实施最小权限和深度防御策略至关重要。